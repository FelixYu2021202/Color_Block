System.register([],(function(e){"use strict";return{execute:function(){function t(e){return(t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function n(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function r(e,t,i){return t&&n(e.prototype,t),i&&n(e,i),e}function a(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function s(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&l(e,t)}function o(e){return(o=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function l(e,t){return(l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function u(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function c(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?u(e):t}function h(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=o(e)););return e}function f(e,t,i){return(f="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,i){var n=h(e,t);if(n){var r=Object.getOwnPropertyDescriptor(n,t);return r.get?r.get.call(i):r.value}})(e,t,i||e)}function _(e,t,i,n){return(_="undefined"!=typeof Reflect&&Reflect.set?Reflect.set:function(e,t,i,n){var r,s=h(e,t);if(s){if((r=Object.getOwnPropertyDescriptor(s,t)).set)return r.set.call(n,i),!0;if(!r.writable)return!1}if(r=Object.getOwnPropertyDescriptor(n,t)){if(!r.writable)return!1;r.value=i,Object.defineProperty(n,t,r)}else a(n,t,i);return!0})(e,t,i,n)}function d(e,t,i,n,r){if(!_(e,t,i,n||e)&&r)throw new Error("failed to set property");return i}function p(e){return function(e){if(Array.isArray(e)){for(var t=0,i=new Array(e.length);t<e.length;t++)i[t]=e[t];return i}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function m(e,t,i,n){i&&Object.defineProperty(e,t,{enumerable:i.enumerable,configurable:i.configurable,writable:i.writable,value:i.initializer?i.initializer.call(n):void 0})}function v(e,t,i,n,r){var a={};return Object.keys(n).forEach((function(e){a[e]=n[e]})),a.enumerable=!!a.enumerable,a.configurable=!!a.configurable,("value"in a||a.initializer)&&(a.writable=!0),a=i.slice().reverse().reduce((function(i,n){return n(e,t,i)||i}),a),r&&void 0!==a.initializer&&(a.value=a.initializer?a.initializer.call(r):void 0,a.initializer=void 0),void 0===a.initializer&&(Object.defineProperty(e,t,a),a=null),a}e({BitMask:_t,Enum:dt,EventType:void 0,GFXAPI:void 0,GFXAddress:void 0,GFXAttributeName:void 0,GFXBindingType:void 0,GFXBlendFactor:void 0,GFXBlendOp:void 0,GFXBufferAccessBit:void 0,GFXBufferFlagBit:void 0,GFXBufferUsageBit:void 0,GFXClearFlag:void 0,GFXColorMask:void 0,GFXCommandBufferType:void 0,GFXComparisonFunc:void 0,GFXCullMode:void 0,GFXDynamicState:void 0,GFXFeature:void 0,GFXFilter:void 0,GFXFormat:void 0,GFXFormatSize:Vo,GFXFormatSurfaceSize:Ho,GFXFormatType:void 0,GFXGetTypeSize:jo,GFXLoadOp:void 0,GFXMemoryUsageBit:void 0,GFXObjectType:void 0,GFXPipelineBindPoint:void 0,GFXPolygonMode:void 0,GFXPrimitiveMode:void 0,GFXQueueType:void 0,GFXSampleCount:void 0,GFXShadeModel:void 0,GFXShaderType:void 0,GFXStatus:void 0,GFXStencilFace:void 0,GFXStencilOp:void 0,GFXStoreOp:void 0,GFXTextureFlagBit:void 0,GFXTextureLayout:void 0,GFXTextureType:void 0,GFXTextureUsageBit:void 0,GFXTextureViewType:void 0,GFXType:void 0,HorizontalTextAlignment:void 0,InstanceMaterialType:void 0,Overflow:void 0,RenderPassStage:void 0,SystemEventType:void 0,VerticalTextAlignment:void 0,WorldNode3DToLocalNodeUI:Ip,WorldNode3DToWorldNodeUI:Mp,absMax:ki,absMaxComponent:Ri,approx:fi,assert:I,assertID:H,bezier:AM,bezierByTime:PM,clamp:_i,clamp01:di,color:ar,computeRatioByType:zM,equals:hi,error:O,errorID:U,find:Jb,fragmentText:os,getPathFromRoot:function(e,t){var i=e,n="";for(;null!==i&&i!==t;)n="".concat(i.name,"/").concat(n),i=i.parent;return n.slice(0,-1)},getWorldTransformUntilRoot:WL,inverseLerp:Ci,isCustomTargetModifier:AP,isDisplayStats:j,isElementModifier:xP,isPropertyModifier:SP,isUnicodeCJK:rs,isUnicodeSpace:as,isValid:_l,lerp:pi,log:R,logID:D,markAsWarning:void 0,mat4:Nn,murmurhash2_32_gc:Jo,nextPow2:xi,pingPong:wi,pseudoRandom:Ei,pseudoRandomRange:Ti,pseudoRandomRangeInt:Si,quat:gn,randomRange:yi,randomRangeInt:bi,rect:$n,removeProperty:void 0,repeat:Ai,replaceProperty:void 0,safeMeasureText:ss,sampleAnimationCurve:NM,setDefaultLogTimes:function(e){e>0&&(hr=e)},setDisplayStats:X,size:qn,toDegree:vi,toRadian:mi,v2:Bi,v3:Vi,v4:Yi,warn:k,warnID:N});var g="undefined"==typeof window?global:window,y=g.cc=g.cc||{};function b(e,t){void 0===g[e]&&(g[e]=t)}y.internal=y.internal||{},y._global=g,b("CC_BUILD",!1),g.CC_BUILD=!0,g.CC_TEST=!1,g.CC_EDITOR=!1,g.CC_PREVIEW=!1,g.CC_DEV=!1,g.CC_DEBUG=!1,g.CC_JSB=!1,g.CC_WECHAT=!1,g.CC_ALIPAY=!1,g.CC_XIAOMI=!1,g.CC_BAIDU=!1,g.CC_COCOSPLAY=!1,g.CC_MINIGAME=!1,g.CC_RUNTIME_BASED=!1,g.CC_SUPPORT_JIT=!0,g.CC_PHYSICS_BUILTIN=!1,g.CC_PHYSICS_CANNON=!1,g.CC_PHYSICS_AMMO=!1;g.CocosEngine=y.ENGINE_VERSION="1.0.4",Object.defineProperty(g,"CC_PHYSICS_BUILT_IN",{get:function(){return console.warn("CC_PHYSICS_BUILT_IN is deprecated, please using CC_PHYSICS_BUILTIN instead."),g.CC_PHYSICS_BUILTIN}});var E="https://github.com/cocos-creator/engine/blob/3d/EngineErrorMap.md",T=null,S=console.log,x=console.log,A=console.log,w=function(e,t){if(!e){for(var i=arguments.length,n=new Array(i>2?i-2:0),r=2;r<i;r++)n[r-2]=arguments[r];console.log("ASSERT: "+C.apply(void 0,[t].concat(n)))}};function C(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return cc.js.formatStr.apply(null,[e].concat(i))}function R(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return S.apply(void 0,[e].concat(i))}function k(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return x.apply(void 0,[e].concat(i))}function O(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return A.apply(void 0,[e].concat(i))}function I(e,t){for(var i=arguments.length,n=new Array(i>2?i-2:0),r=2;r<i;r++)n[r-2]=arguments[r];return w.apply(void 0,[e,t].concat(n))}function M(e){if(S=x=A=w=function(){},e!==G.NONE){if(e>G.ERROR){var t=function(e){if(cc.game.canvas){if(!T){var t=document.createElement("Div");t.setAttribute("id","logInfoDiv"),t.setAttribute("width","200"),t.setAttribute("height",cc.game.canvas.height);var i=t.style;i.zIndex="99999",i.position="absolute",i.top=i.left="0",(T=document.createElement("textarea")).setAttribute("rows","20"),T.setAttribute("cols","30"),T.setAttribute("disabled","true");var n=T.style;n.backgroundColor="transparent",n.borderBottom="1px solid #cccccc",n.borderTopWidth=n.borderLeftWidth=n.borderRightWidth="0px",n.borderTopStyle=n.borderLeftStyle=n.borderRightStyle="none",n.padding="0px",n.margin="0px",t.appendChild(T),cc.game.canvas.parentNode.appendChild(t)}T.value=T.value+e+"\r\n",T.scrollTop=T.scrollHeight}};A=function(e){for(var i=arguments.length,n=new Array(i>1?i-1:0),r=1;r<i;r++)n[r-1]=arguments[r];t("ERROR :  "+C.apply(void 0,[e].concat(n)))},w=function(e,i){if(!e){for(var n=arguments.length,r=new Array(n>2?n-2:0),a=2;a<n;a++)r[a-2]=arguments[a];t("ASSERT: "+C.apply(void 0,[i].concat(r)))}},e!==G.ERROR_FOR_WEB_PAGE&&(x=function(e){for(var i=arguments.length,n=new Array(i>1?i-1:0),r=1;r<i;r++)n[r-1]=arguments[r];t("WARN :  "+C.apply(void 0,[e].concat(n)))}),e===G.INFO_FOR_WEB_PAGE&&(S=function(e){for(var i=arguments.length,n=new Array(i>1?i-1:0),r=1;r<i;r++)n[r-1]=arguments[r];t(C.apply(void 0,[e].concat(n)))})}else console&&console.log.apply&&(console.error||(console.error=console.log),console.warn||(console.warn=console.log),A=console.error.bind?console.error.bind(console):function(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return console.error.apply(console,[e].concat(i))},w=function(e,t){if(!e){for(var i=arguments.length,n=new Array(i>2?i-2:0),r=2;r<i;r++)n[r-2]=arguments[r];var a=C.apply(void 0,[t].concat(n));throw new Error(a)}});e!==G.ERROR&&(x=console.warn.bind?console.warn.bind(console):function(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return console.warn.apply(console,[e].concat(i))}),e===G.INFO&&(S=console.log.bind?console.log.bind(console):function(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return console.log.apply(console,[e].concat(i))})}}function L(e){var t=e.stack;O(t||e)}function P(e){return function(t){for(var i="".concat(e," ").concat(t,", please go to ").concat(E,"#").concat(t," to see details."),n=arguments.length,r=new Array(n>1?n-1:0),a=1;a<n;a++)r[a-1]=arguments[a];return 0===r.length?i:i+" Arguments: "+r.join(", ")}}var B=P("Log");function D(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];R(B.apply(void 0,[e].concat(i)))}var F=P("Warning");function N(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];k(F.apply(void 0,[e].concat(i)))}var z=P("Error");function U(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];O(z.apply(void 0,[e].concat(i)))}var G,V=P("Assert");function H(e,t){if(!e){for(var i=arguments.length,n=new Array(i>2?i-2:0),r=2;r<i;r++)n[r-2]=arguments[r];I(!1,V.apply(void 0,[t].concat(n)))}}function W(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return z.apply(void 0,[e].concat(i))}function j(){return!!cc.profiler&&cc.profiler.isShowingStats()}function X(e){cc.profiler&&(e?cc.profiler.showStats():cc.profiler.hideStats(),cc.game.config.showFPS=!!e)}!function(e){e[e.NONE=0]="NONE",e[e.INFO=1]="INFO",e[e.WARN=2]="WARN",e[e.ERROR=3]="ERROR",e[e.INFO_FOR_WEB_PAGE=4]="INFO_FOR_WEB_PAGE",e[e.WARN_FOR_WEB_PAGE=5]="WARN_FOR_WEB_PAGE",e[e.ERROR_FOR_WEB_PAGE=6]="ERROR_FOR_WEB_PAGE"}(G||(G={}));var q=Object.freeze({__proto__:null,log:R,warn:k,error:O,assert:I,_resetDebugSetting:M,_throw:L,logID:D,warnID:N,errorID:U,assertID:H,get DebugMode(){return G},getError:W,isDisplayStats:j,setDisplayStats:X}),Y=/(\.[^\.\/\?\\]*)(\?.*)?$/,K=/((.*)(\/|\\|\\\\))?(.*?\..*$)?/,Z=/[^\.\/]+\/\.\.\//;function Q(){for(var e="",t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];for(var r=0,a=i;r<a.length;r++){var s=a[r];e=(e+(""===e?"":"/")+s).replace(/(\/|\\\\)$/,"")}return e}function J(e){var t=Y.exec(e);return t?t[1]:""}function $(e){if(e){var t=e.lastIndexOf(".");if(-1!==t)return e.substring(0,t)}return e}function ee(e,t){var i=e.indexOf("?");i>0&&(e=e.substring(0,i));var n=/(\/|\\)([^\/\\]+)$/g.exec(e.replace(/(\/|\\)$/,""));if(!n)return"";var r=n[2];return t&&e.substring(e.length-t.length).toLowerCase()===t.toLowerCase()?r.substring(0,r.length-t.length):r}function te(e){var t=K.exec(e);return t?t[2]:""}function ie(e,t){t=t||"";var i=e.indexOf("?"),n="";return i>0&&(n=e.substring(i),e=e.substring(0,i)),(i=e.lastIndexOf("."))<0?e+t+n:e.substring(0,i)+t+n}function ne(e,t,i){if(0===t.indexOf("."))return ie(e,t);var n=e.indexOf("?"),r="",a=i?J(e):"";return n>0&&(r=e.substring(n),e=e.substring(0,n)),n=(n=e.lastIndexOf("/"))<=0?0:n+1,e.substring(0,n)+t+a+r}function re(e){var t=e=String(e);do{t=e,e=e.replace(Z,"")}while(t.length!==e.length);return e}function ae(e){return e.replace(/[\/\\]$/,"")}function se(){return cc.sys.os===cc.sys.OS_WINDOWS?"\\":"/"}e("path",Object.freeze({__proto__:null,join:Q,extname:J,mainFileName:$,basename:ee,dirname:te,changeExtname:ie,changeBasename:ne,_normalize:re,stripSep:ae,getSeperator:se})),cc.log=R,cc.warn=k,cc.error=O,cc.assert=I,cc._throw=L,cc.logID=D,cc.warnID=N,cc.errorID=U,cc.assertID=H,cc.debug=q,cc.path={join:Q,extname:J,mainFileName:$,basename:ee,dirname:te,changeExtname:ie,changeBasename:ne,_normalize:re,stripSep:ae,get sep(){return se()}};var oe={SHAPE_RAY:1,SHAPE_LINE:2,SHAPE_SPHERE:4,SHAPE_AABB:8,SHAPE_OBB:16,SHAPE_PLANE:32,SHAPE_TRIANGLE:64,SHAPE_FRUSTUM:128,SHAPE_FRUSTUM_ACCURATE:256,SHAPE_CAPSULE:512};function le(e){return(e>0)-(e<0)}function ue(e){var t=32;return(e&=-e)&&t--,65535&e&&(t-=16),16711935&e&&(t-=8),252645135&e&&(t-=4),858993459&e&&(t-=2),1431655765&e&&(t-=1),t}var ce=new Array(256);!function(e){for(var t=0;t<256;++t){var i=t,n=t,r=7;for(i>>>=1;i;i>>>=1)n<<=1,n|=1&i,--r;e[t]=n<<r&255}}(ce);var he=Object.freeze({__proto__:null,INT_BITS:32,INT_MAX:2147483647,INT_MIN:-1<<31,sign:le,abs:function(e){var t=e>>31;return(e^t)-t},min:function(e,t){return t^(e^t)&-(e<t)},max:function(e,t){return e^(e^t)&-(e<t)},isPow2:function(e){return!(e&e-1||!e)},log2:function(e){var t,i;return t=(e>65535)<<4,t|=i=((e>>>=t)>255)<<3,t|=i=((e>>>=i)>15)<<2,(t|=i=((e>>>=i)>3)<<1)|(e>>>=i)>>1},log10:function(e){return e>=1e9?9:e>=1e8?8:e>=1e7?7:e>=1e6?6:e>=1e5?5:e>=1e4?4:e>=1e3?3:e>=100?2:e>=10?1:0},popCount:function(e){return 16843009*((e=(858993459&(e-=e>>>1&1431655765))+(e>>>2&858993459))+(e>>>4)&252645135)>>>24},countTrailingZeros:ue,nextPow2:function(e){return e+=0===e,--e,e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,(e|=e>>>16)+1},prevPow2:function(e){return e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,(e|=e>>>16)-(e>>>1)},parity:function(e){return e^=e>>>16,e^=e>>>8,e^=e>>>4,27030>>>(e&=15)&1},reverse:function(e){return ce[255&e]<<24|ce[e>>>8&255]<<16|ce[e>>>16&255]<<8|ce[e>>>24&255]},interleave2:function(e,t){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e&=65535)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t&=65535)|t<<8))|t<<4))|t<<2))|t<<1))<<1},deinterleave2:function(e,t){return(e=65535&((e=16711935&((e=252645135&((e=858993459&((e=e>>>t&1431655765)|e>>>1))|e>>>2))|e>>>4))|e>>>16))<<16>>16},interleave3:function(e,t,i){return e=1227133513&((e=3272356035&((e=251719695&((e=4278190335&((e&=1023)|e<<16))|e<<8))|e<<4))|e<<2),(e|=(t=1227133513&((t=3272356035&((t=251719695&((t=4278190335&((t&=1023)|t<<16))|t<<8))|t<<4))|t<<2))<<1)|(i=1227133513&((i=3272356035&((i=251719695&((i=4278190335&((i&=1023)|i<<16))|i<<8))|i<<4))|i<<2))<<2},deinterleave3:function(e,t){return(e=1023&((e=4278190335&((e=251719695&((e=3272356035&((e=e>>>t&1227133513)|e>>>2))|e>>>4))|e>>>8))|e>>>16))<<22>>22},nextCombination:function(e){var t=e|e-1;return t+1|(~t&-~t)-1>>>ue(e)+1}});e("bits",he);var fe=function(){function e(t){i(this,e),this.i=0,this.array=t}return r(e,[{key:"remove",value:function(e){var t=this.array.indexOf(e);t>=0&&this.removeAt(t)}},{key:"removeAt",value:function(e){this.array.splice(e,1),e<=this.i&&--this.i}},{key:"fastRemove",value:function(e){var t=this.array.indexOf(e);t>=0&&this.fastRemoveAt(t)}},{key:"fastRemoveAt",value:function(e){var t=this.array;t[e]=t[t.length-1],--t.length,e<=this.i&&--this.i}},{key:"push",value:function(e){this.array.push(e)}},{key:"length",get:function(){return this.array.length},set:function(e){this.array.length=e,this.i>=e&&(this.i=e-1)}}]),e}();function _e(e,t){e.splice(t,1)}function de(e,t){var i=e.indexOf(t);return i>=0&&(_e(e,i),!0)}function pe(e,t){return e.indexOf(t)>=0}var me=Object.freeze({__proto__:null,removeAt:_e,fastRemoveAt:function(e,t){var i=e.length;t<0||t>=i||(e[t]=e[i-1],e.length=i-1)},remove:de,fastRemove:function(e,t){var i=e.indexOf(t);i>=0&&(e[i]=e[e.length-1],--e.length)},removeIf:function(e,t){var i=e.findIndex(t);if(i>=0){var n=e[i];return _e(e,i),n}},verifyType:function(e,t){if(e&&e.length>0){var i=e,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}if(!(a instanceof t))return cc.logID(1300),!1}}return!0},removeArray:function(e,t){for(var i=0,n=t.length;i<n;i++)de(e,t[i])},appendObjectsAt:function(e,t,i){return e.splice.apply(e,[i,0].concat(p(t))),e},indexOf:function(e,t,i){return Array.prototype.indexOf.call(e,[t,i])},contains:pe,copy:function(e){for(var t=e.length,i=new Array(t),n=0;n<t;n+=1)i[n]=e[n];return i},MutableForwardIterator:fe}),ve=function(){function e(t){i(this,e),this.id=0|998*Math.random(),this.prefix=t?t+".":""}return r(e,[{key:"getNewId",value:function(){return this.prefix+ ++this.id}}]),e}();ve.global=new ve("global");var ge=new ve("TmpCId.");function ye(e){return"number"==typeof e||e instanceof Number}function be(e){return"string"==typeof e||e instanceof String}var Ee,Te=(Ee={value:void 0,enumerable:!1,writable:!1,configurable:!0},function(e,t,i,n,r){Ee.value=i,Ee.writable=n,Ee.enumerable=r,Object.defineProperty(e,t,Ee),Ee.value=void 0}),Se=function(){var e={get:void 0,set:void 0,enumerable:!1};return function(t,i,n,r){var a=arguments.length>4&&void 0!==arguments[4]&&arguments[4],s=arguments.length>5&&void 0!==arguments[5]&&arguments[5];"boolean"==typeof r&&(a=r,r=void 0),e.get=n,e.set=r,e.enumerable=a,e.configurable=s,Object.defineProperty(t,i,e),e.get=void 0,e.set=void 0}}(),xe=function(){var e={get:void 0,enumerable:!1,configurable:!1};return function(t,i,n,r,a){e.get=n,e.enumerable=r,e.configurable=a,Object.defineProperty(t,i,e),e.get=void 0}}(),Ae=function(){var e={set:void 0,enumerable:!1,configurable:!1};return function(t,i,n,r,a){e.set=n,e.enumerable=r,e.configurable=a,Object.defineProperty(t,i,e),e.set=void 0}}();function we(e){var t=Object.create(null);if(e){t["."]=!0,t["/"]=!0,delete t["."],delete t["/"]}return t}function Ce(e){if("function"==typeof e){var t=e.prototype;if(t&&t.hasOwnProperty("__classname__")&&t.__classname__)return t.__classname__;var i="";if(e.name&&(i=e.name),e.toString){var n,r=e.toString();(n="["===r.charAt(0)?r.match(/\[\w+\s*(\w+)\]/):r.match(/function\s*(\w+)/))&&2===n.length&&(i=n[1])}return"Object"!==i?i:""}return e&&e.constructor?Ce(e.constructor):""}function Re(e,t,i,n){var r=/([^.]+)$/,a=r.exec(t)[0],s=r.exec(i)[0];function o(){return this[s]}n?Se(e,a,o,(function(e){this[s]=e})):xe(e,a,o)}function ke(e,t,i,n){for(var r in i){Re(e,t+"."+r,i[r],n)}}var Oe=/(%d)|(%s)/,Ie=/%s/;function Me(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];if(0===arguments.length)return"";if(0===i.length)return""+e;var r="string"==typeof e&&Oe.test(e);if(r){var a=i,s=Array.isArray(a),o=0;for(a=s?a:a[Symbol.iterator]();;){var l;if(s){if(o>=a.length)break;l=a[o++]}else{if((o=a.next()).done)break;l=o.value}var u=l,c="number"==typeof u?Oe:Ie;c.test(e)?e=e.replace(c,u):e+=" "+u}}else{var h=i,f=Array.isArray(h),_=0;for(h=f?h:h[Symbol.iterator]();;){var d;if(f){if(_>=h.length)break;d=h[_++]}else{if((_=h.next()).done)break;d=_.value}e+=" "+d}}return e}function Le(){for(var e=arguments.length-1,t=new Array(e),i=0;i<e;++i)t[i]=arguments[i+1];return t}function Pe(e,t){for(;e;){var i=Object.getOwnPropertyDescriptor(e,t);if(i)return i;e=Object.getPrototypeOf(e)}return null}function Be(e,t,i){var n=Pe(t,e);n&&Object.defineProperty(i,e,n)}function De(e){e=e||{};for(var i=arguments.length,n=new Array(i>1?i-1:0),r=1;r<i;r++)n[r-1]=arguments[r];for(var a=0,s=n;a<s.length;a++){var o=s[a];if(o){if("object"!==t(o)){cc.errorID(5402,o);continue}for(var l in o)l in e||Be(l,o,e)}}return e}function Fe(e){e=e||{};for(var i=arguments.length,n=new Array(i>1?i-1:0),r=1;r<i;r++)n[r-1]=arguments[r];for(var a=0,s=n;a<s.length;a++){var o=s[a];if(o){if("object"!==t(o)){cc.errorID(5403,o);continue}for(var l in o)Be(l,o,e)}}return e}function Ne(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);return e.prototype=Object.create(t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),e}function ze(e){var t=e.prototype,i=t&&Object.getPrototypeOf(t);return i&&i.constructor}function Ue(e,t){if(e&&t){if("function"!=typeof e)return!1;if("function"!=typeof t)return!1;if(e===t)return!0;for(;;){if(!(e=ze(e)))return!1;if(e===t)return!0}}return!1}function Ge(e){for(var t=0,i=Object.keys(e);t<i.length;t++){delete e[i[t]]}}var Ve={},He={};function We(e,t){var i="__cid__",n=Ve;if(t.prototype.hasOwnProperty(i)&&delete n[t.prototype[i]],Te(t.prototype,i,e),e){var r=n[e];if(r&&r!==t){var a='A Class already exists with the same __cid__ : "'+e+'".';0,cc.error(a)}else n[e]=t}}function je(e,t){if(function(e,t){var i="__classname__",n=He;if(t.prototype.hasOwnProperty(i)&&delete n[t.prototype[i]],Te(t.prototype,i,e),e){var r=n[e];if(r&&r!==t){var a="A Class already exists with the same "+i+' : "'+e+'".';0,cc.error(a)}else n[e]=t}}(e,t),!t.prototype.hasOwnProperty("__cid__")){var i=e||ge.getNewId();i&&We(i,t)}}function Xe(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];for(var n=0,r=t;n<r.length;n++){var a=r[n],s=a.prototype,o=s.__cid__;o&&delete Ve[o];var l=s.__classname__;l&&delete He[l]}}function qe(e){return Ve[e]}function Ye(e){return He[e]}function Ke(e,t){if(t=void 0===t||t,"function"==typeof e&&e.prototype.hasOwnProperty("__cid__"))return e.prototype.__cid__;if(e&&e.constructor){var i=e.constructor.prototype;if(i&&i.hasOwnProperty("__cid__"))return e.__cid__}return""}var Ze=function(){function e(t,n){i(this,e);var r=void 0===n?t:n,a=void 0===n?null:t;this.count=0,this._pool=new Array(r),this._cleanup=a}return r(e,[{key:"get",value:function(){return this._get()}}]),r(e,[{key:"_get",value:function(){if(this.count>0){--this.count;var e=this._pool[this.count];return this._pool[this.count]=null,e}return null}},{key:"put",value:function(e){var t=this._pool;if(this.count<t.length){if(this._cleanup&&!1===this._cleanup(e))return;t[this.count]=e,++this.count}}},{key:"resize",value:function(e){e>=0&&(this._pool.length=e,this.count>e&&(this.count=e))}}]),e}(),Qe=me,Je={IDGenerator:ve,Pool:Ze,array:me,isNumber:ye,isString:be,getPropertyDescriptor:Pe,addon:De,mixin:Fe,extend:Ne,getSuper:ze,isChildClassOf:Ue,clear:Ge,value:Te,getset:Se,get:xe,set:Ae,unregisterClass:Xe,getClassName:Ce,setClassName:je,getClassByName:Ye,_getClassId:Ke,_setClassId:We,_getClassById:qe,obsolete:Re,obsoletes:ke,formatStr:Me,shiftArguments:Le,createMap:we};cc.js=Je,e("js",Object.freeze({__proto__:null,array:Qe,js:Je,IDGenerator:ve,Pool:Ze,isNumber:ye,isString:be,value:Te,getset:Se,get:xe,set:Ae,createMap:we,getClassName:Ce,obsolete:Re,obsoletes:ke,formatStr:Me,shiftArguments:Le,getPropertyDescriptor:Pe,addon:De,mixin:Fe,extend:Ne,getSuper:ze,isChildClassOf:Ue,clear:Ge,_idToClass:Ve,_nameToClass:He,_setClassId:We,setClassName:je,unregisterClass:Xe,_getClassById:qe,getClassByName:Ye,_getClassId:Ke}));for(var $e=/^(?:cc|dragonBones|sp|ccsg)\..+/,et=new Array(123),tt=0;tt<123;++tt)et[tt]=64;for(var it=0;it<64;++it)et["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charCodeAt(it)]=it;var nt=et;function rt(e,t,i){function n(e,t,i,n){var r=Object.getOwnPropertyDescriptor(e,t);if(r)r.get&&(e[i]=r.get),r.set&&n&&(e[n]=r.set);else{var a=e[i];Se(e,t,a,e[n])}}for(var r,a=e.prototype,s=0;s<t.length;s++){var o=(r=t[s])[0].toUpperCase()+r.slice(1);n(a,r,"get"+o,"set"+o)}for(r in i){var l=i[r];n(a,r,l[0],l[1])}}function at(e){return e-=1,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,(e|=e>>16)+1}function st(e,t,i,n){var r=e[t];r?Array.isArray(r)?n?(r.push(r[0]),r[0]=i):r.push(i):e[t]=n?[i,r]:[r,i]:e[t]=i}function ot(e,t){if("function"==typeof e.contains)return e.contains(t);if("function"==typeof e.compareDocumentPosition)return!!(16&e.compareDocumentPosition(t));var i=t.parentNode;if(i)do{if(i===e)return!0;i=i.parentNode}while(null!==i);return!1}function lt(e){return"object"===("undefined"==typeof window?"undefined":t(window))&&"function"==typeof Node?e instanceof Node:e&&"object"===t(e)&&"number"==typeof e.nodeType&&"string"==typeof e.nodeName}function ut(e,t,i){e&&setTimeout((function(){e(t,i)}),0)}function ct(e,t,i,n){return Function("arg","return "+function(e){try{target._FUNC_(_U_ARGS_)}catch(e){cc._throw(e)}_AFTER_CALL_}.toString().replace(/_FUNC_/g,e).replace("_R_ARGS_","target"+(t?", "+t:"")).replace("_U_ARGS_",t||"").replace("_AFTER_CALL_",i||""))(n)}function ht(e){if(!e||e.constructor!==Object)return!1;for(var t in e)return!1;return!0}function ft(e){return e&&"function"==typeof e.clone&&(e.constructor&&e.constructor.prototype.hasOwnProperty("clone")||e.hasOwnProperty("clone"))}function _t(e){if("__bitmask__"in e)return e;Te(e,"__bitmask__",null,!0);for(var t=-1,i=Object.keys(e),n=0;n<i.length;n++){var r=i[n],a=e[r];if(-1===a)a=++t,e[r]=a;else if("number"==typeof a)t=a;else if("string"==typeof a&&Number.isInteger(parseFloat(r)))continue;var s=""+a;r!==s&&Te(e,s,r)}return e}function dt(e){if("__enums__"in e)return e;Te(e,"__enums__",null,!0);for(var t=-1,i=Object.keys(e),n=0;n<i.length;n++){var r=i[n],a=e[r];if(-1===a)a=++t,e[r]=a;else if("number"==typeof a)t=a;else if("string"==typeof a&&Number.isInteger(parseFloat(r)))continue;var s=""+a;r!==s&&Te(e,s,r)}return e}function pt(e){"__enums__"in e||Te(e,"__enums__",null,!0)}cc.misc={BUILTIN_CLASSID_RE:$e,BASE64_VALUES:nt,propertyDefine:rt,nextPOT:at,pushToMap:st,contains:ot,isDomNode:lt,callInNextTick:ut,tryCatchFunctor_EDITOR:ct,isPlainEmptyObj_DEV:ht,cloneable_DEV:ft},e("misc",Object.freeze({__proto__:null,BUILTIN_CLASSID_RE:$e,BASE64_VALUES:nt,propertyDefine:rt,nextPOT:at,pushToMap:st,contains:ot,isDomNode:lt,callInNextTick:ut,tryCatchFunctor_EDITOR:ct,isPlainEmptyObj_DEV:ht,cloneable_DEV:ft})),_t.isBitMask=function(e){return e&&e.hasOwnProperty("__bitmask__")},_t.getList=function(e){if(e.__bitmask__)return e.__bitmask__;var t=e.__bitmask__=[];for(var i in e){var n=e[i];Number.isInteger(n)&&t.push({name:i,value:n})}return t.sort((function(e,t){return e.value-t.value})),t},cc.BitMask=_t,dt.isEnum=function(e){return e&&e.hasOwnProperty("__enums__")},dt.getList=function(e){if(e.__enums__)return e.__enums__;var t=e.__enums__=[];for(var i in e){var n=e[i];Number.isInteger(n)&&t.push({name:i,value:n})}return t.sort((function(e,t){return e.value-t.value})),t},cc.Enum=dt;var mt=e("ValueType",function(){function e(){i(this,e)}return r(e,[{key:"clone",value:function(){return U(100,Ce(this)+".clone"),this}},{key:"equals",value:function(e){return!1}},{key:"set",value:function(e){U(100,Ce(this)+".set")}},{key:"toString",value:function(){return""+{}}}]),e}());je("cc.ValueType",mt),cc.ValueType=mt;function vt(e,t,i){var n;n=function(){},i&&Ne(n,i.constructor);var r=new n;return Te(e,"__attrs__",r),r}function gt(e){for(var t,i=cc.Class.getInheritanceChain(e),n=i.length-1;n>=0;n--){var r=i[n];r.hasOwnProperty("__attrs__")&&r.__attrs__||vt(r,0,(t=i[n+1])&&t.__attrs__)}return vt(e,0,(t=i[0])&&t.__attrs__),e.__attrs__}function yt(e,i,n){var r,a;if("function"==typeof e)a=(r=bt(e)).constructor.prototype;else{var s=e;if(!(r=s.__attrs__))r=vt(s,0,bt(e=s.constructor));a=r}if(void 0===n){var o=i+"$_$",l={};for(var u in r)u.startsWith(o)&&(l[u.slice(o.length)]=r[u]);return l}if("object"===t(n))for(var c in n)95!==c.charCodeAt(0)&&(a[i+"$_$"+c]=n[c]);else 0}function bt(e){return e.hasOwnProperty("__attrs__")&&e.__attrs__||gt(e)}function Et(e){return bt(e).constructor.prototype}function Tt(e,t,i,n){Et(e)[t+"$_$"+i]=n}var St=function(){function e(t,n){i(this,e),this.name=t,this.default=n}return r(e,[{key:"toString",value:function(){return this.name}}]),e}(),xt=e("CCInteger",new St("Integer",0));cc.Integer=xt,cc.CCInteger=xt;var At=e("CCFloat",new St("Float",0));cc.Float=At,cc.CCFloat=At;var wt=e("CCBoolean",new St("Boolean",!1));cc.Boolean=wt,cc.CCBoolean=wt;var Ct=e("CCString",new St("String",""));function Rt(e,i){return function(n,r){var a='"'+Ce(n)+"."+r+'"',s=yt(n,r);if(!s.saveUrlAsAsset){var o=s.type;if(o===xt||o===At?o="Number":o!==Ct&&o!==wt||(o=o.toString()),o!==e)return void N(3604,a)}if(s.hasOwnProperty("default")){var l=s.default;if(void 0!==l)if(!(Array.isArray(l)||ht(l))){var u=t(l),c=e.toLowerCase();if(u===c){if(!s.saveUrlAsAsset)if("object"===c){if(!l||l instanceof s.ctor)return;N(3605,a,Ce(s.ctor))}else"Number"!==e&&N(3606,i,a,e)}else{if("function"===u)return;e===Ct.default&&null==l?Ue(s.ctor,cc.RawAsset)||N(3607,a):N(3611,i,a,u)}delete s.type}}}}function kt(e){return function(t,i){Rt("Object","type")(t,i);var n=bt(t)[i+"$_$default"],r=cc.Class.getDefault(n);if(!Array.isArray(r)&&Ue(e,cc.ValueType)){var a=Ce(e),s=Me('No need to specify the "type" of "%s.%s" because %s is a child class of ValueType.',Ce(t),i,a);n?R(s):N(3612,s,a,Ce(t),i,a)}}}cc.String=Ct,cc.CCString=Ct;var Ot=Object.freeze({__proto__:null,DELIMETER:"$_$",createAttrsSingle:vt,createAttrs:gt,attr:yt,getClassAttrs:bt,getClassAttrsProto:Et,setClassAttr:Tt,PrimitiveType:St,CCInteger:xt,CCFloat:At,CCBoolean:wt,CCString:Ct,getTypeChecker:Rt,getObjTypeChecker:kt}),It={url:{canUsedInGet:!0},default:{},serializable:{},editorOnly:{},formerlySerializedAs:{}};function Mt(e,t,i,n){if(!e.get&&!e.set)if(e.hasOwnProperty("default")){var r="_N$"+t;e.get=function(){return this[r]},e.set=function(e){var t=this[r];this[r]=e,i.call(this,t)};var a={};for(var s in n[r]=a,It){var o=It[s];e.hasOwnProperty(s)&&(a[s]=e[s],o.canUsedInGet||delete e[s])}}else 0}function Lt(e,t,i,n){Array.isArray(n)&&n.length>0&&(n=n[0]),e.type=n}function Pt(e,t,i,n){if(Array.isArray(t)){if(!(t.length>0))return U(5508,i,n);if(cc.RawAsset.isRawAssetType(t[0]))return e.url=t[0],void delete e.type;e.type=t=t[0]}}function Bt(e,t,i){if(!(e&&e.constructor===Object)){if(Array.isArray(e)&&e.length>0){e[0];return{default:[],type:e,_short:!0}}if("function"==typeof e){var n=e;return cc.RawAsset.isRawAssetType(n)?{default:"",url:n,_short:!0}:{default:Ue(n,cc.ValueType)?new n:null,type:n,_short:!0}}return e instanceof St?{default:e.default,_short:!0}:{default:e,_short:!0}}return null}function Dt(e,t,i,n,r){return"function"==typeof e||null===e}var Ft=[];function Nt(){return Ft[Ft.length-1]}cc._RF={push:function(e,t,i,n){void 0===i&&(i=t,t=""),Ft.push({uuid:t,script:i,module:e,exports:e.exports,beh:null,importMeta:n})},pop:function(){var e=Ft.pop(),t=e.module,i=t.exports;if(i===e.exports){for(var n in i)return;t.exports=i=e.cls}},peek:Nt};var zt=["name","extends","mixins","ctor","__ctor__","properties","statics","editor","__ES6__"];function Ut(e,t){e.indexOf(t)<0&&e.push(t)}var Gt={datas:null,push:function(e){if(this.datas)this.datas.push(e);else{this.datas=[e];var t=this;setTimeout((function(){t.init()}),0)}},init:function(){var e=this.datas;if(e){for(var t=0;t<e.length;++t){var i=e[t],n=i.cls,r=i.props;"function"==typeof r&&(r=r());var a=Ce(n);r?ni(n,a,r,n.$super,i.mixins):U(3633,a)}this.datas=null}}};function Vt(e,t){Ut(e.__props__,t)}var Ht=[];function Wt(e,t,i,n,r){var a=n.default;Tt(e,i,"default",a),Vt(e,i);var s=oi(e,n,t,i,!1);if(s){for(var o=Ht,l=0;l<s.length;l++){var u=s[l];yt(e,i,u),!1===u.serializable&&Ut(e.__values__,i),u._onAfterProp&&o.push(u._onAfterProp)}for(var c=0;c<o.length;c++)o[c](e,i);Ht.length=0,s.length=0}}function jt(e,t,i,n,r){var a=n.get,s=n.set,o=e.prototype,l=Object.getOwnPropertyDescriptor(o,i),u=!l;if(a){0;for(var c=oi(e,n,t,i,!0),h=0;h<c.length;h++)yt(e,i,c[h]);c.length=0,Tt(e,i,"serializable",!1),r||xe(o,i,a,u,u)}s&&(r||Ae(o,i,s,u,u))}function Xt(e){return"function"==typeof e?e():e}function qt(e,t,i){for(var n in t)e.hasOwnProperty(n)||i&&!i(n)||Object.defineProperty(e,n,Pe(t,n))}function Yt(e,t,i,n){var r,a,s=n.__ctor__,o=n.ctor,l=n.__ES6__;l?(r=[o],a=o):(r=s?[s]:function(e,t,i){for(var n=[],r=[e].concat(t),a=0;a<r.length;a++){var s=r[a];if(s)for(var o=(u=s,ri._isCCClass(u)?u.__ctors__||[]:[u]),l=0;l<o.length;l++)Ut(n,o[l])}var u;var c=i.ctor;c&&n.push(c);return n}(t,i,n),a=$t(r,t,e,n),Te(a,"extend",(function(e){return e.extends=this,ri(e)}),!0)),Te(a,"__ctors__",r.length>0?r:null,!0);var u=a.prototype;if(t&&(l||(Ne(a,t),u=a.prototype),a.$super=t),i){for(var c=function(e){var t=i[e];qt(u,t.prototype),qt(a,t,(function(e){return t.hasOwnProperty(e)&&!0})),ri._isCCClass(t)&&qt(bt(a).constructor.prototype,bt(t).constructor.prototype)},h=i.length-1;h>=0;h--)c(h);u.constructor=a}return l||(u.__initProps__=Jt),je(e,a),a}function Kt(e){for(var t=Ce(e),i=e.constructor,n="new "+t+"(",r=0;r<i.__props__.length;r++){var a=e[i.__props__[r]];0,n+=a,r<i.__props__.length-1&&(n+=",")}return n+")"}function Zt(e){return JSON.stringify(e).replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029")}var Qt=/^[A-Za-z_$][0-9A-Za-z_$]*$/;function Jt(e){var i=bt(e),n=e.__props__;null===n&&(Gt.init(),n=e.__props__);var r=function(e,i){for(var n=[],r="",a=0;a<i.length;a++){var s=i[a],o=s+"$_$default";if(o in e){var l=void 0;l=Qt.test(s)?"this."+s+"=":"this["+Zt(s)+"]=";var u=void 0,c=e[o];if("object"===t(c)&&c)u=c instanceof cc.ValueType?Kt(c):Array.isArray(c)?"[]":"{}";else if("function"==typeof c){var h=n.length;n.push(c),u="F["+h+"]()"}else u="string"==typeof c?Zt(c):c;r+=l=l+u+";\n"}}return 0===n.length?Function(r):Function("F","return (function(){\n"+r+"})")(n)}(i,n);e.prototype.__initProps__=r,r.call(this)}var $t=function(e,t,i,n){var r="return function CCClass(){\n";t&&ii(t,n,i)&&(r+="this._super=null;\n"),r+="this.__initProps__(CCClass);\n";var a=e.length;if(a>0){0;var s="].apply(this,arguments);\n";if(1===a)r+="CCClass.__ctors__[0"+s;else{r+="var cs=CCClass.__ctors__;\n";for(var o=0;o<a;o++)r+="cs["+o+s}0}return r+="}",Function(r)()};var ei=/xyz/.test(function(){}.toString()),ti=ei?/\b\._super\b/:/.*/;function ii(e,t,i){var n=!1;for(var r in t)if(!(zt.indexOf(r)>=0)){var a=t[r];if("function"==typeof a){var s=Pe(e.prototype,r);if(s){var o=s.value;if("function"==typeof o){ti.test(a)&&(n=!0,t[r]=function(e,t){return function(){var i=this._super;this._super=e;var n=t.apply(this,arguments);return this._super=i,n}}(o,a));continue}}0}}return n}function ni(e,t,i,n,r,a){if(e.__props__=[],n&&n.__props__&&(e.__props__=n.__props__.slice()),r)for(var s=0;s<r.length;++s){var o=r[s];o.__props__&&(e.__props__=e.__props__.concat(o.__props__.filter((function(t){return e.__props__.indexOf(t)<0}))))}if(i)for(var l in function(e,t,i,n){for(var r in e){var a=e[r],s=Bt(a);if(s&&(a=e[r]=s),a){var o=a.notify;o&&Mt(a,r,o,e),"type"in a&&Pt(a,a.type,t,r),"url"in a&&Lt(a,0,0,a.url),"type"in a&&a.type}}}(i,t),i){var u=i[l];"default"in u?Wt(e,t,l,u):jt(e,t,l,u,a)}var c=bt(e);e.__values__=e.__props__.filter((function(e){return!1!==c[e+"$_$serializable"]}))}function ri(e){var t=(e=e||{}).name,i=e.extends,n=e.mixins,r=function(e,t,i,n){var r=cc.Component,a=Nt();if(a&&Ue(t,r)){if(Ue(a.cls,r))return U(3615),null;0,e=e||a.script}var s=Yt(e,t,i,n),o=Ue(t,cc.RenderPipeline),l=Ue(t,cc.RenderFlow),u=Ue(t,cc.RenderStage);if(o||l||u||!1){var c="";o?c="render_pipeline":l?c="render_flow":u&&(c="render_stage"),c&&We(e,s)}if(a)if(Ue(t,r)){var h=a.uuid;h&&We(h,s),a.cls=s}else Ue(a.cls,r)||(a.cls=s);return s}(t,i,n,e);t||(t=cc.js.getClassName(r)),r._sealed=!0,i&&(i._sealed=!1);var a=e.properties;"function"==typeof a||i&&null===i.__props__||n&&n.some((function(e){return null===e.__props__}))?(Gt.push({cls:r,props:a,mixins:n}),r.__props__=r.__values__=null):ni(r,t,a,i,e.mixins,e.__ES6__);var s,o=e.statics;if(o)for(s in o)r[s]=o[s];for(var l in e)if(!(zt.indexOf(l)>=0)){var u=e[l];Dt(u)&&Te(r.prototype,l,u,!0,!0)}var c=e.editor;return c&&Ue(i,cc.Component)&&cc.Component._registerEditorProps(r,c),r}ri._isCCClass=function(e){return e&&e.hasOwnProperty&&e.hasOwnProperty("__ctors__")},ri.fastDefine=function(e,t,i){je(e,t);for(var n=t.__props__=t.__values__=Object.keys(i),r=Et(t),a=0;a<n.length;a++){var s=n[a];r[s+"$_$visible"]=!1,r[s+"$_$default"]=i[s]}},ri.Attr=Ot,ri.attr=yt,ri.getInheritanceChain=function(e){for(var t=[];e=ze(e);)e!==Object&&t.push(e);return t};var ai={Integer:"Number",Float:"Number",Boolean:"Boolean",String:"String"},si=[];function oi(e,i,n,r,a){var s=null,o="";function l(){return o=r+"$_$",s=Et(e)}si.length=0;var u=si;"type"in i&&void 0===i.type&&N(3660,r,n);var c=i.type;if(c){var h=ai[c];if(h)u.push({type:c,_onAfterProp:void 0});else if("Object"===c)0;else if("object"===t(c))dt.isEnum(c)?u.push({type:"Enum",enumList:dt.getList(c)}):_t.isBitMask(c)&&u.push({type:"BitMask",bitmaskList:_t.getList(c)});else if("function"==typeof c){var f;0,u.push({type:"Object",ctor:c,_onAfterProp:f})}else 0}var _=function(e,n){if(e in i){var r=i[e];t(r)===n&&((s||l())[o+e]=r)}};i.editorOnly&&((s||l())[o+"editorOnly"]=!0),i.url&&((s||l())[o+"saveUrlAsAsset"]=!0),!1===i.serializable&&((s||l())[o+"serializable"]=!1),_("formerlySerializedAs","string");var d=i.range;return d&&Array.isArray(d)&&d.length>=2&&((s||l())[o+"min"]=d[0],(s||l())[o+"max"]=d[1],d.length>2&&((s||l())[o+"step"]=d[2])),_("min","number"),_("max","number"),_("step","number"),u}ri.isArray=function(e){return e=Xt(e),Array.isArray(e)},ri.getDefault=Xt,ri.escapeForJS=Zt,ri.IDENTIFIER_RE=Qt,ri.getNewValueTypeCode=Kt,e("CCClass",ri),cc.Class=ri;var li=Math.PI/180,ui=180/Math.PI,ci=e("EPSILON",1e-6);function hi(e,t){return Math.abs(e-t)<=ci*Math.max(1,Math.abs(e),Math.abs(t))}function fi(e,t,i){return i=i||ci,Math.abs(e-t)<=i}function _i(e,t,i){if(t>i){var n=t;t=i,i=n}return e<t?t:e>i?i:e}function di(e){return e<0?0:e>1?1:e}function pi(e,t,i){return e+(t-e)*i}function mi(e){return e*li}function vi(e){return e*ui}var gi=e("random",Math.random);function yi(e,t){return Math.random()*(t-e)+e}function bi(e,t){return Math.floor(yi(e,t))}function Ei(e){return(e=(9301*e+49297)%233280)/233280}function Ti(e,t,i){return Ei(e)*(i-t)+t}function Si(e,t,i){return Math.floor(Ti(e,t,i))}function xi(e){return--e,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e}function Ai(e,t){return e-Math.floor(e/t)*t}function wi(e,t){return e=Ai(e,2*t),e=t-Math.abs(e-t)}function Ci(e,t,i){return(i-e)/(t-e)}function Ri(e){return Math.abs(e.x)>Math.abs(e.y)?Math.abs(e.x)>Math.abs(e.z)?e.x:e.z:Math.abs(e.y)>Math.abs(e.z)?e.y:e.z}function ki(e,t){return Math.abs(e)>Math.abs(t)?e:t}var Oi=0,Ii=0,Mi=e("Vec2",function(e){function n(e,r){var a;return i(this,n),a=c(this,o(n).call(this)),e&&"object"===t(e)?(a.x=e.x,a.y=e.y):(a.x=e||0,a.y=r||0),a}return s(n,e),r(n,null,[{key:"clone",value:function(e){return new n(e.x,e.y)}},{key:"copy",value:function(e,t){return e.x=t.x,e.y=t.y,e}},{key:"set",value:function(e,t,i){return e.x=t,e.y=i,e}},{key:"add",value:function(e,t,i){return e.x=t.x+i.x,e.y=t.y+i.y,e}},{key:"subtract",value:function(e,t,i){return e.x=t.x-i.x,e.y=t.y-i.y,e}},{key:"multiply",value:function(e,t,i){return e.x=t.x*i.x,e.y=t.y*i.y,e}},{key:"divide",value:function(e,t,i){return e.x=t.x/i.x,e.y=t.y/i.y,e}},{key:"ceil",value:function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e}},{key:"floor",value:function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e}},{key:"min",value:function(e,t,i){return e.x=Math.min(t.x,i.x),e.y=Math.min(t.y,i.y),e}},{key:"max",value:function(e,t,i){return e.x=Math.max(t.x,i.x),e.y=Math.max(t.y,i.y),e}},{key:"round",value:function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e}},{key:"multiplyScalar",value:function(e,t,i){return e.x=t.x*i,e.y=t.y*i,e}},{key:"scaleAndAdd",value:function(e,t,i,n){return e.x=t.x+i.x*n,e.y=t.y+i.y*n,e}},{key:"distance",value:function(e,t){return Oi=t.x-e.x,Ii=t.y-e.y,Math.sqrt(Oi*Oi+Ii*Ii)}},{key:"squaredDistance",value:function(e,t){return Oi=t.x-e.x,Ii=t.y-e.y,Oi*Oi+Ii*Ii}},{key:"len",value:function(e){return Oi=e.x,Ii=e.y,Math.sqrt(Oi*Oi+Ii*Ii)}},{key:"lengthSqr",value:function(e){return Oi=e.x,Ii=e.y,Oi*Oi+Ii*Ii}},{key:"negate",value:function(e,t){return e.x=-t.x,e.y=-t.y,e}},{key:"inverse",value:function(e,t){return e.x=1/t.x,e.y=1/t.y,e}},{key:"inverseSafe",value:function(e,t){return Oi=t.x,Ii=t.y,Math.abs(Oi)<ci?e.x=0:e.x=1/Oi,Math.abs(Ii)<ci?e.y=0:e.y=1/Ii,e}},{key:"normalize",value:function(e,t){Oi=t.x,Ii=t.y;var i=Oi*Oi+Ii*Ii;return i>0&&(i=1/Math.sqrt(i),e.x=Oi*i,e.y=Ii*i),e}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y}},{key:"cross",value:function(e,t,i){return e.x=e.y=0,e.z=t.x*i.y-t.y*i.x,e}},{key:"lerp",value:function(e,t,i,n){return Oi=t.x,Ii=t.y,e.x=Oi+n*(i.x-Oi),e.y=Ii+n*(i.y-Ii),e}},{key:"random",value:function(e,t){t=t||1;var i=2*gi()*Math.PI;return e.x=Math.cos(i)*t,e.y=Math.sin(i)*t,e}},{key:"transformMat3",value:function(e,t,i){return Oi=t.x,Ii=t.y,e.x=i.m00*Oi+i.m03*Ii+i.m06,e.y=i.m01*Oi+i.m04*Ii+i.m07,e}},{key:"transformMat4",value:function(e,t,i){return Oi=t.x,Ii=t.y,e.x=i.m00*Oi+i.m04*Ii+i.m12,e.y=i.m01*Oi+i.m05*Ii+i.m13,e}},{key:"str",value:function(e){return"Vec2(".concat(e.x,", ").concat(e.y,")")}},{key:"toArray",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e[i+0]=t.x,e[i+1]=t.y,e}},{key:"fromArray",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e.x=t[i+0],e.y=t[i+1],e}},{key:"strictEquals",value:function(e,t){return e.x===t.x&&e.y===t.y}},{key:"equals",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:ci;return Math.abs(e.x-t.x)<=i*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=i*Math.max(1,Math.abs(e.y),Math.abs(t.y))}},{key:"angle",value:function(e,t){n.normalize(Li,e),n.normalize(Pi,t);var i=n.dot(Li,Pi);return i>1?0:i<-1?Math.PI:Math.acos(i)}}]),r(n,[{key:"clone",value:function(){return new n(this.x,this.y)}},{key:"set",value:function(e,i){return e&&"object"===t(e)?(this.x=e.x,this.y=e.y):(this.x=e||0,this.y=i||0),this}},{key:"equals",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:ci;return Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))}},{key:"equals2f",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:ci;return Math.abs(this.x-e)<=i*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=i*Math.max(1,Math.abs(this.y),Math.abs(t))}},{key:"strictEquals",value:function(e){return e&&this.x===e.x&&this.y===e.y}},{key:"strictEquals2f",value:function(e,t){return this.x===e&&this.y===t}},{key:"toString",value:function(){return"(".concat(this.x.toFixed(2),", ").concat(this.y.toFixed(2),")")}},{key:"lerp",value:function(e,t){return Oi=this.x,Ii=this.y,this.x=Oi+t*(e.x-Oi),this.y=Ii+t*(e.y-Ii),this}},{key:"clampf",value:function(e,t){return this.x=_i(this.x,e.x,t.x),this.y=_i(this.y,e.y,t.y),this}},{key:"add",value:function(e){return this.x=this.x+e.x,this.y=this.y+e.y,this}},{key:"add2f",value:function(e,t){return this.x=this.x+e,this.y=this.y+t,this}},{key:"subtract",value:function(e){return this.x=this.x-e.x,this.y=this.y-e.y,this}},{key:"subtract2f",value:function(e,t){return this.x=this.x-e,this.y=this.y-t,this}},{key:"multiplyScalar",value:function(e){return"object"===t(e)&&console.warn("should use Vec2.multiply for vector * vector operation"),this.x=this.x*e,this.y=this.y*e,this}},{key:"multiply",value:function(e){return"object"!==t(e)&&console.warn("should use Vec2.scale for vector * scalar operation"),this.x=this.x*e.x,this.y=this.y*e.y,this}},{key:"multiply2f",value:function(e,t){return this.x=this.x*e,this.y=this.y*t,this}},{key:"divide",value:function(e){return this.x=this.x/e.x,this.y=this.y/e.y,this}},{key:"divide2f",value:function(e,t){return this.x=this.x/e,this.y=this.y/t,this}},{key:"negative",value:function(){return this.x=-this.x,this.y=-this.y,this}},{key:"dot",value:function(e){return this.x*e.x+this.y*e.y}},{key:"cross",value:function(e){return this.x*e.y-this.y*e.x}},{key:"length",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y)}},{key:"lengthSqr",value:function(){return this.x*this.x+this.y*this.y}},{key:"normalize",value:function(){Oi=this.x,Ii=this.y;var e=Oi*Oi+Ii*Ii;return e>0&&(e=1/Math.sqrt(e),this.x=this.x*e,this.y=this.y*e),this}},{key:"angle",value:function(e){var t=this.lengthSqr(),i=e.lengthSqr();if(0===t||0===i)return console.warn("Can't get angle between zero vector"),0;var n=this.dot(e)/Math.sqrt(t*i);return n=_i(n,-1,1),Math.acos(n)}},{key:"signAngle",value:function(e){var t=this.angle(e);return this.cross(e)<0?-t:t}},{key:"rotate",value:function(e){Oi=this.x,Ii=this.y;var t=Math.sin(e),i=Math.cos(e);return this.x=i*Oi-t*Ii,this.y=t*Oi+i*Ii,this}},{key:"project",value:function(e){var t=this.dot(e)/e.dot(e);return this.x=e.x*t,this.y=e.y*t,this}},{key:"transformMat4",value:function(e){return Oi=this.x,Ii=this.y,this.x=e.m00*Oi+e.m04*Ii+e.m12,this.y=e.m01*Oi+e.m05*Ii+e.m13,this}}]),n}(mt));Mi.ZERO=Object.freeze(new Mi(0,0)),Mi.ONE=Object.freeze(new Mi(1,1)),Mi.NEG_ONE=Object.freeze(new Mi(-1,-1)),Mi.UNIT_X=Object.freeze(new Mi(1,0)),Mi.UNIT_Y=Object.freeze(new Mi(0,1));var Li=new Mi,Pi=new Mi;function Bi(e,t){return new Mi(e,t)}ri.fastDefine("cc.Vec2",Mi,{x:0,y:0}),cc.Vec2=Mi,cc.v2=Bi;var Di=0,Fi=0,Ni=0,zi=e("Vec3",function(e){function n(e,r,a){var s;return i(this,n),s=c(this,o(n).call(this)),e&&"object"===t(e)?(s.x=e.x,s.y=e.y,s.z=e.z):(s.x=e||0,s.y=r||0,s.z=a||0),s}return s(n,e),r(n,null,[{key:"zero",value:function(e){return e.x=0,e.y=0,e.z=0,e}},{key:"clone",value:function(e){return new n(e.x,e.y,e.z)}},{key:"copy",value:function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e}},{key:"set",value:function(e,t,i,n){return e.x=t,e.y=i,e.z=n,e}},{key:"add",value:function(e,t,i){return e.x=t.x+i.x,e.y=t.y+i.y,e.z=t.z+i.z,e}},{key:"subtract",value:function(e,t,i){return e.x=t.x-i.x,e.y=t.y-i.y,e.z=t.z-i.z,e}},{key:"multiply",value:function(e,t,i){return e.x=t.x*i.x,e.y=t.y*i.y,e.z=t.z*i.z,e}},{key:"divide",value:function(e,t,i){return e.x=t.x/i.x,e.y=t.y/i.y,e.z=t.z/i.z,e}},{key:"ceil",value:function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e.z=Math.ceil(t.z),e}},{key:"floor",value:function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e.z=Math.floor(t.z),e}},{key:"min",value:function(e,t,i){return e.x=Math.min(t.x,i.x),e.y=Math.min(t.y,i.y),e.z=Math.min(t.z,i.z),e}},{key:"max",value:function(e,t,i){return e.x=Math.max(t.x,i.x),e.y=Math.max(t.y,i.y),e.z=Math.max(t.z,i.z),e}},{key:"round",value:function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e.z=Math.round(t.z),e}},{key:"multiplyScalar",value:function(e,t,i){return e.x=t.x*i,e.y=t.y*i,e.z=t.z*i,e}},{key:"scaleAndAdd",value:function(e,t,i,n){return e.x=t.x+i.x*n,e.y=t.y+i.y*n,e.z=t.z+i.z*n,e}},{key:"distance",value:function(e,t){return Di=t.x-e.x,Fi=t.y-e.y,Ni=t.z-e.z,Math.sqrt(Di*Di+Fi*Fi+Ni*Ni)}},{key:"squaredDistance",value:function(e,t){return Di=t.x-e.x,Fi=t.y-e.y,Ni=t.z-e.z,Di*Di+Fi*Fi+Ni*Ni}},{key:"len",value:function(e){return Di=e.x,Fi=e.y,Ni=e.z,Math.sqrt(Di*Di+Fi*Fi+Ni*Ni)}},{key:"lengthSqr",value:function(e){return Di=e.x,Fi=e.y,Ni=e.z,Di*Di+Fi*Fi+Ni*Ni}},{key:"negate",value:function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e}},{key:"invert",value:function(e,t){return e.x=1/t.x,e.y=1/t.y,e.z=1/t.z,e}},{key:"invertSafe",value:function(e,t){return Di=t.x,Fi=t.y,Ni=t.z,Math.abs(Di)<ci?e.x=0:e.x=1/Di,Math.abs(Fi)<ci?e.y=0:e.y=1/Fi,Math.abs(Ni)<ci?e.z=0:e.z=1/Ni,e}},{key:"normalize",value:function(e,t){Di=t.x,Fi=t.y,Ni=t.z;var i=Di*Di+Fi*Fi+Ni*Ni;return i>0&&(i=1/Math.sqrt(i),e.x=Di*i,e.y=Fi*i,e.z=Ni*i),e}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z}},{key:"cross",value:function(e,t,i){var n=t.x,r=t.y,a=t.z,s=i.x,o=i.y,l=i.z;return e.x=r*l-a*o,e.y=a*s-n*l,e.z=n*o-r*s,e}},{key:"lerp",value:function(e,t,i,n){return e.x=t.x+n*(i.x-t.x),e.y=t.y+n*(i.y-t.y),e.z=t.z+n*(i.z-t.z),e}},{key:"random",value:function(e,t){t=t||1;var i=2*gi()*Math.PI,n=2*gi()-1,r=Math.sqrt(1-n*n);return e.x=r*Math.cos(i)*t,e.y=r*Math.sin(i)*t,e.z=n*t,e}},{key:"transformMat4",value:function(e,t,i){Di=t.x,Fi=t.y,Ni=t.z;var n=i.m03*Di+i.m07*Fi+i.m11*Ni+i.m15;return n=n?1/n:1,e.x=(i.m00*Di+i.m04*Fi+i.m08*Ni+i.m12)*n,e.y=(i.m01*Di+i.m05*Fi+i.m09*Ni+i.m13)*n,e.z=(i.m02*Di+i.m06*Fi+i.m10*Ni+i.m14)*n,e}},{key:"transformMat4Normal",value:function(e,t,i){Di=t.x,Fi=t.y,Ni=t.z;var n=i.m03*Di+i.m07*Fi+i.m11*Ni;return n=n?1/n:1,e.x=(i.m00*Di+i.m04*Fi+i.m08*Ni)*n,e.y=(i.m01*Di+i.m05*Fi+i.m09*Ni)*n,e.z=(i.m02*Di+i.m06*Fi+i.m10*Ni)*n,e}},{key:"transformMat3",value:function(e,t,i){return Di=t.x,Fi=t.y,Ni=t.z,e.x=Di*i.m00+Fi*i.m03+Ni*i.m06,e.y=Di*i.m01+Fi*i.m04+Ni*i.m07,e.z=Di*i.m02+Fi*i.m05+Ni*i.m08,e}},{key:"transformAffine",value:function(e,t,i){return Di=t.x,Fi=t.y,Ni=t.z,e.x=i.m00*Di+i.m01*Fi+i.m02*Ni+i.m03,e.y=i.m04*Di+i.m05*Fi+i.m06*Ni+i.m07,e.x=i.m08*Di+i.m09*Fi+i.m10*Ni+i.m11,e}},{key:"transformQuat",value:function(e,t,i){var n=i.w*t.x+i.y*t.z-i.z*t.y,r=i.w*t.y+i.z*t.x-i.x*t.z,a=i.w*t.z+i.x*t.y-i.y*t.x,s=-i.x*t.x-i.y*t.y-i.z*t.z;return e.x=n*i.w+s*-i.x+r*-i.z-a*-i.y,e.y=r*i.w+s*-i.y+a*-i.x-n*-i.z,e.z=a*i.w+s*-i.z+n*-i.y-r*-i.x,e}},{key:"transformRTS",value:function(e,t,i,n,r){var a=t.x*r.x,s=t.y*r.y,o=t.z*r.z,l=i.w*a+i.y*o-i.z*s,u=i.w*s+i.z*a-i.x*o,c=i.w*o+i.x*s-i.y*a,h=-i.x*a-i.y*s-i.z*o;return e.x=l*i.w+h*-i.x+u*-i.z-c*-i.y+n.x,e.y=u*i.w+h*-i.y+c*-i.x-l*-i.z+n.y,e.z=c*i.w+h*-i.z+l*-i.y-u*-i.x+n.z,e}},{key:"transformInverseRTS",value:function(e,t,i,n,r){var a=t.x-n.x,s=t.y-n.y,o=t.z-n.z,l=i.w*a-i.y*o+i.z*s,u=i.w*s-i.z*a+i.x*o,c=i.w*o-i.x*s+i.y*a,h=i.x*a+i.y*s+i.z*o;return e.x=(l*i.w+h*i.x+u*i.z-c*i.y)/r.x,e.y=(u*i.w+h*i.y+c*i.x-l*i.z)/r.y,e.z=(c*i.w+h*i.z+l*i.y-u*i.x)/r.z,e}},{key:"rotateX",value:function(e,t,i,n){Di=t.x-i.x,Fi=t.y-i.y,Ni=t.z-i.z;var r=Math.cos(n),a=Math.sin(n),s=Di,o=Fi*r-Ni*a,l=Fi*a+Ni*r;return e.x=s+i.x,e.y=o+i.y,e.z=l+i.z,e}},{key:"rotateY",value:function(e,t,i,n){Di=t.x-i.x,Fi=t.y-i.y,Ni=t.z-i.z;var r=Math.cos(n),a=Math.sin(n),s=Ni*a+Di*r,o=Fi,l=Ni*r-Di*a;return e.x=s+i.x,e.y=o+i.y,e.z=l+i.z,e}},{key:"rotateZ",value:function(e,t,i,n){Di=t.x-i.x,Fi=t.y-i.y,Ni=t.z-i.z;var r=Math.cos(n),a=Math.sin(n),s=Di*r-Fi*a,o=Di*a+Fi*r,l=Ni;return e.x=s+i.x,e.y=o+i.y,e.z=l+i.z,e}},{key:"toArray",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e[i+0]=t.x,e[i+1]=t.y,e[i+2]=t.z,e}},{key:"fromArray",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e.x=t[i+0],e.y=t[i+1],e.z=t[i+2],e}},{key:"strictEquals",value:function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z}},{key:"equals",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:ci,n=e.x,r=e.y,a=e.z,s=t.x,o=t.y,l=t.z;return Math.abs(n-s)<=i*Math.max(1,Math.abs(n),Math.abs(s))&&Math.abs(r-o)<=i*Math.max(1,Math.abs(r),Math.abs(o))&&Math.abs(a-l)<=i*Math.max(1,Math.abs(a),Math.abs(l))}},{key:"angle",value:function(e,t){n.normalize(Ui,e),n.normalize(Gi,t);var i=n.dot(Ui,Gi);return i>1?0:i<-1?Math.PI:Math.acos(i)}},{key:"projectOnPlane",value:function(e,t,i){return n.subtract(e,t,n.project(e,t,i))}},{key:"project",value:function(e,t,i){var r=n.lengthSqr(i);return r<1e-6?n.set(e,0,0,0):n.multiplyScalar(e,i,n.dot(t,i)/r)}}]),r(n,[{key:"clone",value:function(){return new n(this.x,this.y,this.z)}},{key:"set",value:function(e,i,n){return e&&"object"===t(e)?(this.x=e.x,this.y=e.y,this.z=e.z):(this.x=e||0,this.y=i||0,this.z=n||0),this}},{key:"equals",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:ci;return Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=t*Math.max(1,Math.abs(this.z),Math.abs(e.z))}},{key:"equals3f",value:function(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:ci;return Math.abs(this.x-e)<=n*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=n*Math.max(1,Math.abs(this.y),Math.abs(t))&&Math.abs(this.z-i)<=n*Math.max(1,Math.abs(this.z),Math.abs(i))}},{key:"strictEquals",value:function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z}},{key:"strictEquals3f",value:function(e,t,i){return this.x===e&&this.y===t&&this.z===i}},{key:"toString",value:function(){return"(".concat(this.x.toFixed(2),", ").concat(this.y.toFixed(2),", ").concat(this.z.toFixed(2),")")}},{key:"lerp",value:function(e,t){return this.x=this.x+t*(e.x-this.x),this.y=this.y+t*(e.y-this.y),this.z=this.z+t*(e.z-this.z),this}},{key:"add",value:function(e){return this.x=this.x+e.x,this.y=this.y+e.y,this.z=this.z+e.z,this}},{key:"add3f",value:function(e,t,i){return this.x=this.x+e,this.y=this.y+t,this.z=this.z+i,this}},{key:"subtract",value:function(e){return this.x=this.x-e.x,this.y=this.y-e.y,this.z=this.z-e.z,this}},{key:"subtract3f",value:function(e,t,i){return this.x=this.x-e,this.y=this.y-t,this.z=this.z-i,this}},{key:"multiplyScalar",value:function(e){return"object"===t(e)&&console.warn("should use Vec3.multiply for vector * vector operation"),this.x=this.x*e,this.y=this.y*e,this.z=this.z*e,this}},{key:"multiply",value:function(e){return"object"!==t(e)&&console.warn("should use Vec3.scale for vector * scalar operation"),this.x=this.x*e.x,this.y=this.y*e.y,this.z=this.z*e.z,this}},{key:"multiply3f",value:function(e,t,i){return this.x=this.x*e,this.y=this.y*t,this.z=this.z*i,this}},{key:"divide",value:function(e){return this.x=this.x/e.x,this.y=this.y/e.y,this.z=this.z/e.z,this}},{key:"divide3f",value:function(e,t,i){return this.x=this.x/e,this.y=this.y/t,this.z=this.z/i,this}},{key:"negative",value:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}},{key:"clampf",value:function(e,t){return this.x=_i(this.x,e.x,t.x),this.y=_i(this.y,e.y,t.y),this.z=_i(this.z,e.z,t.z),this}},{key:"dot",value:function(e){return this.x*e.x+this.y*e.y+this.z*e.z}},{key:"cross",value:function(e){var t=this.x,i=this.y,n=this.z,r=e.x,a=e.y,s=e.z;return this.x=i*s-n*a,this.y=n*r-t*s,this.z=t*a-i*r,this}},{key:"length",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}},{key:"lengthSqr",value:function(){return this.x*this.x+this.y*this.y+this.z*this.z}},{key:"normalize",value:function(){Di=this.x,Fi=this.y,Ni=this.z;var e=Di*Di+Fi*Fi+Ni*Ni;return e>0&&(e=1/Math.sqrt(e),this.x=Di*e,this.y=Fi*e,this.z=Ni*e),this}},{key:"transformMat4",value:function(e){Di=this.x,Fi=this.y,Ni=this.z;var t=e.m03*Di+e.m07*Fi+e.m11*Ni+e.m15;return t=t?1/t:1,this.x=(e.m00*Di+e.m04*Fi+e.m08*Ni+e.m12)*t,this.y=(e.m01*Di+e.m05*Fi+e.m09*Ni+e.m13)*t,this.z=(e.m02*Di+e.m06*Fi+e.m10*Ni+e.m14)*t,this}}]),n}(mt));zi.UNIT_X=Object.freeze(new zi(1,0,0)),zi.UNIT_Y=Object.freeze(new zi(0,1,0)),zi.UNIT_Z=Object.freeze(new zi(0,0,1)),zi.RIGHT=Object.freeze(new zi(1,0,0)),zi.UP=Object.freeze(new zi(0,1,0)),zi.FORWARD=Object.freeze(new zi(0,0,-1)),zi.ZERO=Object.freeze(new zi(0,0,0)),zi.ONE=Object.freeze(new zi(1,1,1)),zi.NEG_ONE=Object.freeze(new zi(-1,-1,-1));var Ui=new zi,Gi=new zi;function Vi(e,t,i){return new zi(e,t,i)}ri.fastDefine("cc.Vec3",zi,{x:0,y:0,z:0}),cc.Vec3=zi,cc.v3=Vi;var Hi=0,Wi=0,ji=0,Xi=0,qi=e("Vec4",function(e){function n(e,r,a,s){var l;return i(this,n),l=c(this,o(n).call(this)),e&&"object"===t(e)?(l.x=e.x,l.y=e.y,l.z=e.z,l.w=e.w):(l.x=e||0,l.y=r||0,l.z=a||0,l.w=s||0),l}return s(n,e),r(n,null,[{key:"clone",value:function(e){return new n(e.x,e.y,e.z,e.w)}},{key:"copy",value:function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=t.w,e}},{key:"set",value:function(e,t,i,n,r){return e.x=t,e.y=i,e.z=n,e.w=r,e}},{key:"add",value:function(e,t,i){return e.x=t.x+i.x,e.y=t.y+i.y,e.z=t.z+i.z,e.w=t.w+i.w,e}},{key:"subtract",value:function(e,t,i){return e.x=t.x-i.x,e.y=t.y-i.y,e.z=t.z-i.z,e.w=t.w-i.w,e}},{key:"multiply",value:function(e,t,i){return e.x=t.x*i.x,e.y=t.y*i.y,e.z=t.z*i.z,e.w=t.w*i.w,e}},{key:"divide",value:function(e,t,i){return e.x=t.x/i.x,e.y=t.y/i.y,e.z=t.z/i.z,e.w=t.w/i.w,e}},{key:"ceil",value:function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e.z=Math.ceil(t.z),e.w=Math.ceil(t.w),e}},{key:"floor",value:function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e.z=Math.floor(t.z),e.w=Math.floor(t.w),e}},{key:"min",value:function(e,t,i){return e.x=Math.min(t.x,i.x),e.y=Math.min(t.y,i.y),e.z=Math.min(t.z,i.z),e.w=Math.min(t.w,i.w),e}},{key:"max",value:function(e,t,i){return e.x=Math.max(t.x,i.x),e.y=Math.max(t.y,i.y),e.z=Math.max(t.z,i.z),e.w=Math.max(t.w,i.w),e}},{key:"round",value:function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e.z=Math.round(t.z),e.w=Math.round(t.w),e}},{key:"multiplyScalar",value:function(e,t,i){return e.x=t.x*i,e.y=t.y*i,e.z=t.z*i,e.w=t.w*i,e}},{key:"scaleAndAdd",value:function(e,t,i,n){return e.x=t.x+i.x*n,e.y=t.y+i.y*n,e.z=t.z+i.z*n,e.w=t.w+i.w*n,e}},{key:"distance",value:function(e,t){var i=t.x-e.x,n=t.y-e.y,r=t.z-e.z,a=t.w-e.w;return Math.sqrt(i*i+n*n+r*r+a*a)}},{key:"squaredDistance",value:function(e,t){var i=t.x-e.x,n=t.y-e.y,r=t.z-e.z,a=t.w-e.w;return i*i+n*n+r*r+a*a}},{key:"len",value:function(e){return Hi=e.x,Wi=e.y,ji=e.z,Xi=e.w,Math.sqrt(Hi*Hi+Wi*Wi+ji*ji+Xi*Xi)}},{key:"lengthSqr",value:function(e){return Hi=e.x,Wi=e.y,ji=e.z,Xi=e.w,Hi*Hi+Wi*Wi+ji*ji+Xi*Xi}},{key:"negate",value:function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e.w=-t.w,e}},{key:"inverse",value:function(e,t){return e.x=1/t.x,e.y=1/t.y,e.z=1/t.z,e.w=1/t.w,e}},{key:"inverseSafe",value:function(e,t){return Hi=t.x,Wi=t.y,ji=t.z,Xi=t.w,Math.abs(Hi)<ci?e.x=0:e.x=1/Hi,Math.abs(Wi)<ci?e.y=0:e.y=1/Wi,Math.abs(ji)<ci?e.z=0:e.z=1/ji,Math.abs(Xi)<ci?e.w=0:e.w=1/Xi,e}},{key:"normalize",value:function(e,t){Hi=t.x,Wi=t.y,ji=t.z,Xi=t.w;var i=Hi*Hi+Wi*Wi+ji*ji+Xi*Xi;return i>0&&(i=1/Math.sqrt(i),e.x=Hi*i,e.y=Wi*i,e.z=ji*i,e.w=Xi*i),e}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w}},{key:"lerp",value:function(e,t,i,n){return e.x=t.x+n*(i.x-t.x),e.y=t.y+n*(i.y-t.y),e.z=t.z+n*(i.z-t.z),e.w=t.w+n*(i.w-t.w),e}},{key:"random",value:function(e,t){t=t||1;var i=2*gi()*Math.PI,n=2*gi()-1,r=Math.sqrt(1-n*n);return e.x=r*Math.cos(i)*t,e.y=r*Math.sin(i)*t,e.z=n*t,e.w=0,e}},{key:"transformMat4",value:function(e,t,i){return Hi=t.x,Wi=t.y,ji=t.z,Xi=t.w,e.x=i.m00*Hi+i.m04*Wi+i.m08*ji+i.m12*Xi,e.y=i.m01*Hi+i.m05*Wi+i.m09*ji+i.m13*Xi,e.z=i.m02*Hi+i.m06*Wi+i.m10*ji+i.m14*Xi,e.w=i.m03*Hi+i.m07*Wi+i.m11*ji+i.m15*Xi,e}},{key:"transformAffine",value:function(e,t,i){return Hi=t.x,Wi=t.y,ji=t.z,Xi=t.w,e.x=i.m00*Hi+i.m01*Wi+i.m02*ji+i.m03*Xi,e.y=i.m04*Hi+i.m05*Wi+i.m06*ji+i.m07*Xi,e.x=i.m08*Hi+i.m09*Wi+i.m10*ji+i.m11*Xi,e.w=t.w,e}},{key:"transformQuat",value:function(e,t,i){var n=t.x,r=t.y,a=t.z;Hi=i.x,Wi=i.y,ji=i.z;var s=(Xi=i.w)*n+Wi*a-ji*r,o=Xi*r+ji*n-Hi*a,l=Xi*a+Hi*r-Wi*n,u=-Hi*n-Wi*r-ji*a;return e.x=s*Xi+u*-Hi+o*-ji-l*-Wi,e.y=o*Xi+u*-Wi+l*-Hi-s*-ji,e.z=l*Xi+u*-ji+s*-Wi-o*-Hi,e.w=t.w,e}},{key:"toArray",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e[i+0]=t.x,e[i+1]=t.y,e[i+2]=t.z,e[i+3]=t.w,e}},{key:"fromArray",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e.x=t[i+0],e.y=t[i+1],e.z=t[i+2],e.w=t[i+3],e}},{key:"strictEquals",value:function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z&&e.w===t.w}},{key:"equals",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:ci;return Math.abs(e.x-t.x)<=i*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=i*Math.max(1,Math.abs(e.y),Math.abs(t.y))&&Math.abs(e.z-t.z)<=i*Math.max(1,Math.abs(e.z),Math.abs(t.z))&&Math.abs(e.w-t.w)<=i*Math.max(1,Math.abs(e.w),Math.abs(t.w))}}]),r(n,[{key:"clone",value:function(){return new n(this.x,this.y,this.z,this.w)}},{key:"set",value:function(e,i,n,r){return e&&"object"===t(e)?(this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w):(this.x=e||0,this.y=i||0,this.z=n||0,this.w=r||0),this}},{key:"equals",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:ci;return Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=t*Math.max(1,Math.abs(this.z),Math.abs(e.z))&&Math.abs(this.w-e.w)<=t*Math.max(1,Math.abs(this.w),Math.abs(e.w))}},{key:"equals4f",value:function(e,t,i,n){var r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:ci;return Math.abs(this.x-e)<=r*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=r*Math.max(1,Math.abs(this.y),Math.abs(t))&&Math.abs(this.z-i)<=r*Math.max(1,Math.abs(this.z),Math.abs(i))&&Math.abs(this.w-n)<=r*Math.max(1,Math.abs(this.w),Math.abs(n))}},{key:"strictEquals",value:function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w}},{key:"strictEquals4f",value:function(e,t,i,n){return this.x===e&&this.y===t&&this.z===i&&this.w===n}},{key:"lerp",value:function(e,t){return Hi=this.x,Wi=this.y,ji=this.z,Xi=this.w,this.x=Hi+t*(e.x-Hi),this.y=Wi+t*(e.y-Wi),this.z=ji+t*(e.z-ji),this.w=Xi+t*(e.w-Xi),this}},{key:"toString",value:function(){return"(".concat(this.x.toFixed(2),", ").concat(this.y.toFixed(2),", ").concat(this.z.toFixed(2),", ").concat(this.w.toFixed(2),")")}},{key:"clampf",value:function(e,t){return this.x=_i(this.x,e.x,t.x),this.y=_i(this.y,e.y,t.y),this.z=_i(this.z,e.z,t.z),this.w=_i(this.w,e.w,t.w),this}},{key:"add",value:function(e){return this.x=this.x+e.x,this.y=this.y+e.y,this.z=this.z+e.z,this.w=this.w+e.w,this}},{key:"add4f",value:function(e,t,i,n){return this.x=this.x+e,this.y=this.y+t,this.z=this.z+i,this.w=this.w+n,this}},{key:"subtract",value:function(e){return this.x=this.x-e.x,this.y=this.y-e.y,this.z=this.z-e.z,this.w=this.w-e.w,this}},{key:"subtract4f",value:function(e,t,i,n){return this.x=this.x-e,this.y=this.y-t,this.z=this.z-i,this.w=this.w-n,this}},{key:"multiplyScalar",value:function(e){return"object"===t(e)&&console.warn("should use Vec4.multiply for vector * vector operation"),this.x=this.x*e,this.y=this.y*e,this.z=this.z*e,this.w=this.w*e,this}},{key:"multiply",value:function(e){return"object"!==t(e)&&console.warn("should use Vec4.scale for vector * scalar operation"),this.x=this.x*e.x,this.y=this.y*e.y,this.z=this.z*e.z,this.w=this.w*e.w,this}},{key:"multiply4f",value:function(e,t,i,n){return this.x=this.x*e,this.y=this.y*t,this.z=this.z*i,this.w=this.w*n,this}},{key:"divide",value:function(e){return this.x=this.x/e.x,this.y=this.y/e.y,this.z=this.z/e.z,this.w=this.w/e.w,this}},{key:"divide4f",value:function(e,t,i,n){return this.x=this.x/e,this.y=this.y/t,this.z=this.z/i,this.w=this.w/n,this}},{key:"negative",value:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}},{key:"dot",value:function(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}},{key:"cross",value:function(e){var t=this.x,i=this.y,n=this.z,r=e.x,a=e.y,s=e.z;return this.x=i*s-n*a,this.y=n*r-t*s,this.z=t*a-i*r,this}},{key:"length",value:function(){return Hi=this.x,Wi=this.y,ji=this.z,Xi=this.w,Math.sqrt(Hi*Hi+Wi*Wi+ji*ji+Xi*Xi)}},{key:"lengthSqr",value:function(){return Hi=this.x,Wi=this.y,ji=this.z,Xi=this.w,Hi*Hi+Wi*Wi+ji*ji+Xi*Xi}},{key:"normalize",value:function(){Hi=this.x,Wi=this.y,ji=this.z,Xi=this.w;var e=Hi*Hi+Wi*Wi+ji*ji+Xi*Xi;return e>0&&(e=1/Math.sqrt(e),this.x=Hi*e,this.y=Wi*e,this.z=ji*e,this.w=Xi*e),this}},{key:"transformMat4",value:function(e){return Hi=this.x,Wi=this.y,ji=this.z,Xi=this.w,this.x=e.m00*Hi+e.m04*Wi+e.m08*ji+e.m12*Xi,this.y=e.m01*Hi+e.m05*Wi+e.m09*ji+e.m13*Xi,this.z=e.m02*Hi+e.m06*Wi+e.m10*ji+e.m14*Xi,this.w=e.m03*Hi+e.m07*Wi+e.m11*ji+e.m15*Xi,this}}]),n}(mt));function Yi(e,t,i,n){return new qi(e,t,i,n)}qi.ZERO=Object.freeze(new qi(0,0,0,0)),qi.ONE=Object.freeze(new qi(1,1,1,1)),qi.NEG_ONE=Object.freeze(new qi(-1,-1,-1,-1)),ri.fastDefine("cc.Vec4",qi,{x:0,y:0,z:0,w:0}),cc.Vec4=qi,cc.v4=Yi;var Ki=0,Zi=0,Qi=0,Ji=0,$i=0,en=0,tn=0,nn=0,rn=0,an=e("Mat3",function(e){function n(){var e,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,l=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,u=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,h=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,f=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,_=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,d=arguments.length>8&&void 0!==arguments[8]?arguments[8]:1;return i(this,n),e=c(this,o(n).call(this)),"object"===t(r)?(e.m00=r.m00,e.m01=r.m01,e.m02=r.m02,e.m03=r.m03,e.m04=r.m04,e.m05=r.m05,e.m06=r.m06,e.m07=r.m07,e.m08=r.m08):(e.m00=r,e.m01=a,e.m02=s,e.m03=l,e.m04=u,e.m05=h,e.m06=f,e.m07=_,e.m08=d),e}return s(n,e),r(n,null,[{key:"clone",value:function(e){return new n(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08)}},{key:"copy",value:function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e}},{key:"set",value:function(e,t,i,n,r,a,s,o,l,u){return e.m00=t,e.m01=i,e.m02=n,e.m03=r,e.m04=a,e.m05=s,e.m06=o,e.m07=l,e.m08=u,e}},{key:"identity",value:function(e){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=1,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e}},{key:"transpose",value:function(e,t){return e===t?(Zi=t.m01,Qi=t.m02,en=t.m05,e.m01=t.m03,e.m02=t.m06,e.m03=Zi,e.m05=t.m07,e.m06=Qi,e.m07=en):(e.m00=t.m00,e.m01=t.m03,e.m02=t.m06,e.m03=t.m01,e.m04=t.m04,e.m05=t.m07,e.m06=t.m02,e.m07=t.m05,e.m08=t.m08),e}},{key:"invert",value:function(e,t){Ki=t.m00,Zi=t.m01,Qi=t.m02,Ji=t.m03,$i=t.m04,en=t.m05,tn=t.m06,nn=t.m07;var i=(rn=t.m08)*$i-en*nn,n=-rn*Ji+en*tn,r=nn*Ji-$i*tn,a=Ki*i+Zi*n+Qi*r;return a?(a=1/a,e.m00=i*a,e.m01=(-rn*Zi+Qi*nn)*a,e.m02=(en*Zi-Qi*$i)*a,e.m03=n*a,e.m04=(rn*Ki-Qi*tn)*a,e.m05=(-en*Ki+Qi*Ji)*a,e.m06=r*a,e.m07=(-nn*Ki+Zi*tn)*a,e.m08=($i*Ki-Zi*Ji)*a,e):e}},{key:"determinant",value:function(e){return Ki=e.m00,Zi=e.m01,Qi=e.m02,Ji=e.m03,$i=e.m04,en=e.m05,tn=e.m06,nn=e.m07,rn=e.m08,Ki*(rn*$i-en*nn)+Zi*(-rn*Ji+en*tn)+Qi*(nn*Ji-$i*tn)}},{key:"multiply",value:function(e,t,i){Ki=t.m00,Zi=t.m01,Qi=t.m02,Ji=t.m03,$i=t.m04,en=t.m05,tn=t.m06,nn=t.m07,rn=t.m08;var n=i.m00,r=i.m01,a=i.m02,s=i.m03,o=i.m04,l=i.m05,u=i.m06,c=i.m07,h=i.m08;return e.m00=n*Ki+r*Ji+a*tn,e.m01=n*Zi+r*$i+a*nn,e.m02=n*Qi+r*en+a*rn,e.m03=s*Ki+o*Ji+l*tn,e.m04=s*Zi+o*$i+l*nn,e.m05=s*Qi+o*en+l*rn,e.m06=u*Ki+c*Ji+h*tn,e.m07=u*Zi+c*$i+h*nn,e.m08=u*Qi+c*en+h*rn,e}},{key:"multiplyMat4",value:function(e,t,i){Ki=t.m00,Zi=t.m01,Qi=t.m02,Ji=t.m03,$i=t.m04,en=t.m05,tn=t.m06,nn=t.m07,rn=t.m08;var n=i.m00,r=i.m01,a=i.m02,s=i.m04,o=i.m05,l=i.m06,u=i.m08,c=i.m09,h=i.m10;return e.m00=n*Ki+r*Ji+a*tn,e.m01=n*Zi+r*$i+a*nn,e.m02=n*Qi+r*en+a*rn,e.m03=s*Ki+o*Ji+l*tn,e.m04=s*Zi+o*$i+l*nn,e.m05=s*Qi+o*en+l*rn,e.m06=u*Ki+c*Ji+h*tn,e.m07=u*Zi+c*$i+h*nn,e.m08=u*Qi+c*en+h*rn,e}},{key:"transfrom",value:function(e,t,i){n.transform(e,t,i)}},{key:"transform",value:function(e,t,i){Ki=t.m00,Zi=t.m01,Qi=t.m02,Ji=t.m03,$i=t.m04,en=t.m05,tn=t.m06,nn=t.m07,rn=t.m08;var n=i.x,r=i.y;return e.m00=Ki,e.m01=Zi,e.m02=Qi,e.m03=Ji,e.m04=$i,e.m05=en,e.m06=n*Ki+r*Ji+tn,e.m07=n*Zi+r*$i+nn,e.m08=n*Qi+r*en+rn,e}},{key:"scale",value:function(e,t,i){var n=i.x,r=i.y;return e.m00=n*t.m00,e.m01=n*t.m01,e.m02=n*t.m02,e.m03=r*t.m03,e.m04=r*t.m04,e.m05=r*t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e}},{key:"rotate",value:function(e,t,i){Ki=t.m00,Zi=t.m01,Qi=t.m02,Ji=t.m03,$i=t.m04,en=t.m05,tn=t.m06,nn=t.m07,rn=t.m08;var n=Math.sin(i),r=Math.cos(i);return e.m00=r*Ki+n*Ji,e.m01=r*Zi+n*$i,e.m02=r*Qi+n*en,e.m03=r*Ji-n*Ki,e.m04=r*$i-n*Zi,e.m05=r*en-n*Qi,e.m06=tn,e.m07=nn,e.m08=rn,e}},{key:"fromMat4",value:function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m04,e.m04=t.m05,e.m05=t.m06,e.m06=t.m08,e.m07=t.m09,e.m08=t.m10,e}},{key:"fromViewUp",value:function(e,t,i){return zi.lengthSqr(t)<ci*ci?(n.identity(e),e):(i=i||zi.UNIT_Y,zi.normalize(sn,zi.cross(sn,i,t)),zi.lengthSqr(sn)<ci*ci?(n.identity(e),e):(zi.cross(on,t,sn),n.set(e,sn.x,sn.y,sn.z,on.x,on.y,on.z,t.x,t.y,t.z),e))}},{key:"fromTranslation",value:function(e,t){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=1,e.m05=0,e.m06=t.x,e.m07=t.y,e.m08=1,e}},{key:"fromScaling",value:function(e,t){return e.m00=t.x,e.m01=0,e.m02=0,e.m03=0,e.m04=t.y,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e}},{key:"fromRotation",value:function(e,t){var i=Math.sin(t),n=Math.cos(t);return e.m00=n,e.m01=i,e.m02=0,e.m03=-i,e.m04=n,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e}},{key:"fromQuat",value:function(e,t){var i=t.x,n=t.y,r=t.z,a=t.w,s=i+i,o=n+n,l=r+r,u=i*s,c=n*s,h=n*o,f=r*s,_=r*o,d=r*l,p=a*s,m=a*o,v=a*l;return e.m00=1-h-d,e.m03=c-v,e.m06=f+m,e.m01=c+v,e.m04=1-u-d,e.m07=_-p,e.m02=f-m,e.m05=_+p,e.m08=1-u-h,e}},{key:"inverseTransposeMat4",value:function(e,t){var i=t.m00,n=t.m01,r=t.m02,a=t.m03,s=t.m04,o=t.m05,l=t.m06,u=t.m07,c=t.m08,h=t.m09,f=t.m10,_=t.m11,d=t.m12,p=t.m13,m=t.m14,v=t.m15,g=i*o-n*s,y=i*l-r*s,b=i*u-a*s,E=n*l-r*o,T=n*u-a*o,S=r*u-a*l,x=c*p-h*d,A=c*m-f*d,w=c*v-_*d,C=h*m-f*p,R=h*v-_*p,k=f*v-_*m,O=g*k-y*R+b*C+E*w-T*A+S*x;return O?(O=1/O,e.m00=(o*k-l*R+u*C)*O,e.m01=(l*w-s*k-u*A)*O,e.m02=(s*R-o*w+u*x)*O,e.m03=(r*R-n*k-a*C)*O,e.m04=(i*k-r*w+a*A)*O,e.m05=(n*w-i*R-a*x)*O,e.m06=(p*S-m*T+v*E)*O,e.m07=(m*b-d*S-v*y)*O,e.m08=(d*T-p*b+v*g)*O,e):null}},{key:"toArray",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e[i+0]=t.m00,e[i+1]=t.m01,e[i+2]=t.m02,e[i+3]=t.m03,e[i+4]=t.m04,e[i+5]=t.m05,e[i+6]=t.m06,e[i+7]=t.m07,e[i+8]=t.m08,e}},{key:"fromArray",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e.m00=t[i+0],e.m01=t[i+1],e.m02=t[i+2],e.m03=t[i+3],e.m04=t[i+4],e.m05=t[i+5],e.m06=t[i+6],e.m07=t[i+7],e.m08=t[i+8],e}},{key:"add",value:function(e,t,i){return e.m00=t.m00+i.m00,e.m01=t.m01+i.m01,e.m02=t.m02+i.m02,e.m03=t.m03+i.m03,e.m04=t.m04+i.m04,e.m05=t.m05+i.m05,e.m06=t.m06+i.m06,e.m07=t.m07+i.m07,e.m08=t.m08+i.m08,e}},{key:"subtract",value:function(e,t,i){return e.m00=t.m00-i.m00,e.m01=t.m01-i.m01,e.m02=t.m02-i.m02,e.m03=t.m03-i.m03,e.m04=t.m04-i.m04,e.m05=t.m05-i.m05,e.m06=t.m06-i.m06,e.m07=t.m07-i.m07,e.m08=t.m08-i.m08,e}},{key:"multiplyScalar",value:function(e,t,i){return e.m00=t.m00*i,e.m01=t.m01*i,e.m02=t.m02*i,e.m03=t.m03*i,e.m04=t.m04*i,e.m05=t.m05*i,e.m06=t.m06*i,e.m07=t.m07*i,e.m08=t.m08*i,e}},{key:"multiplyScalarAndAdd",value:function(e,t,i,n){return e.m00=i.m00*n+t.m00,e.m01=i.m01*n+t.m01,e.m02=i.m02*n+t.m02,e.m03=i.m03*n+t.m03,e.m04=i.m04*n+t.m04,e.m05=i.m05*n+t.m05,e.m06=i.m06*n+t.m06,e.m07=i.m07*n+t.m07,e.m08=i.m08*n+t.m08,e}},{key:"strictEquals",value:function(e,t){return e.m00===t.m00&&e.m01===t.m01&&e.m02===t.m02&&e.m03===t.m03&&e.m04===t.m04&&e.m05===t.m05&&e.m06===t.m06&&e.m07===t.m07&&e.m08===t.m08}},{key:"equals",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:ci;return Math.abs(e.m00-t.m00)<=i*Math.max(1,Math.abs(e.m00),Math.abs(t.m00))&&Math.abs(e.m01-t.m01)<=i*Math.max(1,Math.abs(e.m01),Math.abs(t.m01))&&Math.abs(e.m02-t.m02)<=i*Math.max(1,Math.abs(e.m02),Math.abs(t.m02))&&Math.abs(e.m03-t.m03)<=i*Math.max(1,Math.abs(e.m03),Math.abs(t.m03))&&Math.abs(e.m04-t.m04)<=i*Math.max(1,Math.abs(e.m04),Math.abs(t.m04))&&Math.abs(e.m05-t.m05)<=i*Math.max(1,Math.abs(e.m05),Math.abs(t.m05))&&Math.abs(e.m06-t.m06)<=i*Math.max(1,Math.abs(e.m06),Math.abs(t.m06))&&Math.abs(e.m07-t.m07)<=i*Math.max(1,Math.abs(e.m07),Math.abs(t.m07))&&Math.abs(e.m08-t.m08)<=i*Math.max(1,Math.abs(e.m08),Math.abs(t.m08))}}]),r(n,[{key:"clone",value:function(){var e=this;return new n(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08)}},{key:"set",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,l=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,u=arguments.length>8&&void 0!==arguments[8]?arguments[8]:1;return"object"===t(e)?(this.m00=e.m00,this.m01=e.m01,this.m02=e.m02,this.m03=e.m03,this.m04=e.m04,this.m05=e.m05,this.m06=e.m06,this.m07=e.m07,this.m08=e.m08):(this.m00=e,this.m01=i,this.m02=n,this.m03=r,this.m04=a,this.m05=s,this.m06=o,this.m07=l,this.m08=u),this}},{key:"equals",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:ci;return Math.abs(this.m00-e.m00)<=t*Math.max(1,Math.abs(this.m00),Math.abs(e.m00))&&Math.abs(this.m01-e.m01)<=t*Math.max(1,Math.abs(this.m01),Math.abs(e.m01))&&Math.abs(this.m02-e.m02)<=t*Math.max(1,Math.abs(this.m02),Math.abs(e.m02))&&Math.abs(this.m03-e.m03)<=t*Math.max(1,Math.abs(this.m03),Math.abs(e.m03))&&Math.abs(this.m04-e.m04)<=t*Math.max(1,Math.abs(this.m04),Math.abs(e.m04))&&Math.abs(this.m05-e.m05)<=t*Math.max(1,Math.abs(this.m05),Math.abs(e.m05))&&Math.abs(this.m06-e.m06)<=t*Math.max(1,Math.abs(this.m06),Math.abs(e.m06))&&Math.abs(this.m07-e.m07)<=t*Math.max(1,Math.abs(this.m07),Math.abs(e.m07))&&Math.abs(this.m08-e.m08)<=t*Math.max(1,Math.abs(this.m08),Math.abs(e.m08))}},{key:"strictEquals",value:function(e){return this.m00===e.m00&&this.m01===e.m01&&this.m02===e.m02&&this.m03===e.m03&&this.m04===e.m04&&this.m05===e.m05&&this.m06===e.m06&&this.m07===e.m07&&this.m08===e.m08}},{key:"toString",value:function(){var e=this;return"[\n"+e.m00+", "+e.m01+", "+e.m02+",\n"+e.m03+",\n"+e.m04+", "+e.m05+",\n"+e.m06+", "+e.m07+",\n"+e.m08+"\n]"}},{key:"identity",value:function(){return this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m04=1,this.m05=0,this.m06=0,this.m07=0,this.m08=1,this}},{key:"transpose",value:function(){var e=this.m01,t=this.m02,i=this.m05;return this.m01=this.m03,this.m02=this.m06,this.m03=e,this.m05=this.m07,this.m06=t,this.m07=i,this}},{key:"invert",value:function(){Ki=this.m00,Zi=this.m01,Qi=this.m02,Ji=this.m03,$i=this.m04,en=this.m05,tn=this.m06,nn=this.m07;var e=(rn=this.m08)*$i-en*nn,t=-rn*Ji+en*tn,i=nn*Ji-$i*tn,n=Ki*e+Zi*t+Qi*i;return n?(n=1/n,this.m00=e*n,this.m01=(-rn*Zi+Qi*nn)*n,this.m02=(en*Zi-Qi*$i)*n,this.m03=t*n,this.m04=(rn*Ki-Qi*tn)*n,this.m05=(-en*Ki+Qi*Ji)*n,this.m06=i*n,this.m07=(-nn*Ki+Zi*tn)*n,this.m08=($i*Ki-Zi*Ji)*n,this):null}},{key:"determinant",value:function(){return Ki=this.m00,Zi=this.m01,Qi=this.m02,Ji=this.m03,$i=this.m04,en=this.m05,tn=this.m06,nn=this.m07,rn=this.m08,Ki*(rn*$i-en*nn)+Zi*(-rn*Ji+en*tn)+Qi*(nn*Ji-$i*tn)}},{key:"add",value:function(e){return this.m00=this.m00+e.m00,this.m01=this.m01+e.m01,this.m02=this.m02+e.m02,this.m03=this.m03+e.m03,this.m04=this.m04+e.m04,this.m05=this.m05+e.m05,this.m06=this.m06+e.m06,this.m07=this.m07+e.m07,this.m08=this.m08+e.m08,this}},{key:"subtract",value:function(e){return this.m00=this.m00-e.m00,this.m01=this.m01-e.m01,this.m02=this.m02-e.m02,this.m03=this.m03-e.m03,this.m04=this.m04-e.m04,this.m05=this.m05-e.m05,this.m06=this.m06-e.m06,this.m07=this.m07-e.m07,this.m08=this.m08-e.m08,this}},{key:"multiply",value:function(e){var t=this.m00,i=this.m01,n=this.m02,r=this.m03,a=this.m04,s=this.m05,o=this.m06,l=this.m07,u=this.m08,c=e.m00,h=e.m01,f=e.m02,_=e.m03,d=e.m04,p=e.m05,m=e.m06,v=e.m07,g=e.m08;return this.m00=c*t+h*r+f*o,this.m01=c*i+h*a+f*l,this.m02=c*n+h*s+f*u,this.m03=_*t+d*r+p*o,this.m04=_*i+d*a+p*l,this.m05=_*n+d*s+p*u,this.m06=m*t+v*r+g*o,this.m07=m*i+v*a+g*l,this.m08=m*n+v*s+g*u,this}},{key:"multiplyScalar",value:function(e){return this.m00=this.m00*e,this.m01=this.m01*e,this.m02=this.m02*e,this.m03=this.m03*e,this.m04=this.m04*e,this.m05=this.m05*e,this.m06=this.m06*e,this.m07=this.m07*e,this.m08=this.m08*e,this}},{key:"scale",value:function(e){var t=e.x,i=e.y;return this.m00=t*this.m00,this.m01=t*this.m01,this.m02=t*this.m02,this.m03=i*this.m03,this.m04=i*this.m04,this.m05=i*this.m05,this.m06=this.m06,this.m07=this.m07,this.m08=this.m08,this}},{key:"rotate",value:function(e){Ki=this.m00,Zi=this.m01,Qi=this.m02,Ji=this.m03,$i=this.m04,en=this.m05,tn=this.m06,nn=this.m07,rn=this.m08;var t=Math.sin(e),i=Math.cos(e);return this.m00=i*Ki+t*Ji,this.m01=i*Zi+t*$i,this.m02=i*Qi+t*en,this.m03=i*Ji-t*Ki,this.m04=i*$i-t*Zi,this.m05=i*en-t*Qi,this.m06=tn,this.m07=nn,this.m08=rn,this}},{key:"fromQuat",value:function(e){var t=e.x,i=e.y,n=e.z,r=e.w,a=t+t,s=i+i,o=n+n,l=t*a,u=i*a,c=i*s,h=n*a,f=n*s,_=n*o,d=r*a,p=r*s,m=r*o;return this.m00=1-c-_,this.m03=u-m,this.m06=h+p,this.m01=u+m,this.m04=1-l-_,this.m07=f-d,this.m02=h-p,this.m05=f+d,this.m08=1-l-c,this}}]),n}(mt));an.IDENTITY=Object.freeze(new an);var sn=new zi,on=new zi;ri.fastDefine("cc.Mat3",an,{m00:1,m01:0,m02:0,m03:0,m04:1,m05:0,m06:0,m07:0,m08:1}),cc.Mat3=an;var ln=0,un=0,cn=0,hn=0,fn=e("Quat",function(e){function n(e,r,a,s){var l;return i(this,n),l=c(this,o(n).call(this)),e&&"object"===t(e)?(l.x=e.x,l.y=e.y,l.z=e.z,l.w=e.w):(l.x=e||0,l.y=r||0,l.z=a||0,l.w=null!=s?s:1),l}return s(n,e),r(n,null,[{key:"clone",value:function(e){return new n(e.x,e.y,e.z,e.w)}},{key:"copy",value:function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=t.w,e}},{key:"set",value:function(e,t,i,n,r){return e.x=t,e.y=i,e.z=n,e.w=r,e}},{key:"identity",value:function(e){return e.x=0,e.y=0,e.z=0,e.w=1,e}},{key:"rotationTo",value:function(e,t,i){var r=zi.dot(t,i);return r<-.999999?(zi.cross(pn,zi.UNIT_X,t),pn.length()<1e-6&&zi.cross(pn,zi.UNIT_Y,t),zi.normalize(pn,pn),n.fromAxisAngle(e,pn,Math.PI),e):r>.999999?(e.x=0,e.y=0,e.z=0,e.w=1,e):(zi.cross(pn,t,i),e.x=pn.x,e.y=pn.y,e.z=pn.z,e.w=1+r,n.normalize(e,e))}},{key:"getAxisAngle",value:function(e,t){var i=2*Math.acos(t.w),n=Math.sin(i/2);return 0!==n?(e.x=t.x/n,e.y=t.y/n,e.z=t.z/n):(e.x=1,e.y=0,e.z=0),i}},{key:"multiply",value:function(e,t,i){return ln=t.x*i.w+t.w*i.x+t.y*i.z-t.z*i.y,un=t.y*i.w+t.w*i.y+t.z*i.x-t.x*i.z,cn=t.z*i.w+t.w*i.z+t.x*i.y-t.y*i.x,hn=t.w*i.w-t.x*i.x-t.y*i.y-t.z*i.z,e.x=ln,e.y=un,e.z=cn,e.w=hn,e}},{key:"multiplyScalar",value:function(e,t,i){return e.x=t.x*i,e.y=t.y*i,e.z=t.z*i,e.w=t.w*i,e}},{key:"scaleAndAdd",value:function(e,t,i,n){return e.x=t.x+i.x*n,e.y=t.y+i.y*n,e.z=t.z+i.z*n,e.w=t.w+i.w*n,e}},{key:"rotateX",value:function(e,t,i){i*=.5;var n=Math.sin(i),r=Math.cos(i);return e.x=t.x*r+t.w*n,e.y=t.y*r+t.z*n,e.z=t.z*r-t.y*n,e.w=t.w*r-t.x*n,e}},{key:"rotateY",value:function(e,t,i){i*=.5;var n=Math.sin(i),r=Math.cos(i);return e.x=t.x*r-t.z*n,e.y=t.y*r+t.w*n,e.z=t.z*r+t.x*n,e.w=t.w*r-t.y*n,e}},{key:"rotateZ",value:function(e,t,i){i*=.5;var n=Math.sin(i),r=Math.cos(i);return e.x=t.x*r+t.y*n,e.y=t.y*r-t.x*n,e.z=t.z*r+t.w*n,e.w=t.w*r-t.z*n,e}},{key:"rotateAround",value:function(e,t,i,r){return n.invert(_n,t),zi.transformQuat(pn,i,_n),n.fromAxisAngle(_n,pn,r),n.multiply(e,t,_n),e}},{key:"rotateAroundLocal",value:function(e,t,i,r){return n.fromAxisAngle(_n,i,r),n.multiply(e,t,_n),e}},{key:"calculateW",value:function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=Math.sqrt(Math.abs(1-t.x*t.x-t.y*t.y-t.z*t.z)),e}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w}},{key:"lerp",value:function(e,t,i,n){return e.x=t.x+n*(i.x-t.x),e.y=t.y+n*(i.y-t.y),e.z=t.z+n*(i.z-t.z),e.w=t.w+n*(i.w-t.w),e}},{key:"slerp",value:function(e,t,i,n){var r=0,a=0,s=t.x*i.x+t.y*i.y+t.z*i.z+t.w*i.w;if(s<0&&(s=-s,i.x=-i.x,i.y=-i.y,i.z=-i.z,i.w=-i.w),1-s>1e-6){var o=Math.acos(s),l=Math.sin(o);r=Math.sin((1-n)*o)/l,a=Math.sin(n*o)/l}else r=1-n,a=n;return e.x=r*t.x+a*i.x,e.y=r*t.y+a*i.y,e.z=r*t.z+a*i.z,e.w=r*t.w+a*i.w,e}},{key:"sqlerp",value:function(e,t,i,r,a,s){return n.slerp(_n,t,a,s),n.slerp(dn,i,r,s),n.slerp(e,_n,dn,2*s*(1-s)),e}},{key:"invert",value:function(e,t){var i=t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w,n=i?1/i:0;return e.x=-t.x*n,e.y=-t.y*n,e.z=-t.z*n,e.w=t.w*n,e}},{key:"conjugate",value:function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e.w=t.w,e}},{key:"len",value:function(e){return Math.sqrt(e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w)}},{key:"lengthSqr",value:function(e){return e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w}},{key:"normalize",value:function(e,t){var i=t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w;return i>0&&(i=1/Math.sqrt(i),e.x=t.x*i,e.y=t.y*i,e.z=t.z*i,e.w=t.w*i),e}},{key:"fromAxes",value:function(e,t,i,r){return an.set(mn,t.x,t.y,t.z,i.x,i.y,i.z,r.x,r.y,r.z),n.normalize(e,n.fromMat3(e,mn))}},{key:"fromViewUp",value:function(e,t,i){return an.fromViewUp(mn,t,i),n.normalize(e,n.fromMat3(e,mn))}},{key:"fromAxisAngle",value:function(e,t,i){i*=.5;var n=Math.sin(i);return e.x=n*t.x,e.y=n*t.y,e.z=n*t.z,e.w=Math.cos(i),e}},{key:"fromMat3",value:function(e,t){var i=t.m00,n=t.m03,r=t.m06,a=t.m01,s=t.m04,o=t.m07,l=t.m02,u=t.m05,c=t.m08,h=i+s+c;if(h>0){var f=.5/Math.sqrt(h+1);e.w=.25/f,e.x=(u-o)*f,e.y=(r-l)*f,e.z=(a-n)*f}else if(i>s&&i>c){var _=2*Math.sqrt(1+i-s-c);e.w=(u-o)/_,e.x=.25*_,e.y=(n+a)/_,e.z=(r+l)/_}else if(s>c){var d=2*Math.sqrt(1+s-i-c);e.w=(r-l)/d,e.x=(n+a)/d,e.y=.25*d,e.z=(o+u)/d}else{var p=2*Math.sqrt(1+c-i-s);e.w=(a-n)/p,e.x=(r+l)/p,e.y=(o+u)/p,e.z=.25*p}return e}},{key:"fromEuler",value:function(e,t,i,n){t*=vn,i*=vn,n*=vn;var r=Math.sin(t),a=Math.cos(t),s=Math.sin(i),o=Math.cos(i),l=Math.sin(n),u=Math.cos(n);return e.x=r*o*u+a*s*l,e.y=a*s*u+r*o*l,e.z=a*o*l-r*s*u,e.w=a*o*u-r*s*l,e}},{key:"toAxisX",value:function(e,t){var i=2*t.y,n=2*t.z;return e.x=1-i*t.y-n*t.z,e.y=i*t.x+n*t.w,e.z=n*t.x+i*t.w,e}},{key:"toAxisY",value:function(e,t){var i=2*t.x,n=2*t.y,r=2*t.z;return e.x=n*t.x-r*t.w,e.y=1-i*t.x-r*t.z,e.z=r*t.y+i*t.w,e}},{key:"toAxisZ",value:function(e,t){var i=2*t.x,n=2*t.y,r=2*t.z;return e.x=r*t.x-n*t.w,e.y=r*t.y-i*t.w,e.z=1-i*t.x-n*t.y,e}},{key:"toEuler",value:function(e,t,i){var n=t.x,r=t.y,a=t.z,s=t.w,o=0,l=0,u=0,c=n*r+a*s;if(c>.499999)o=0,l=vi(2*Math.atan2(n,s)),u=90;else if(c<-.499999)o=0,l=-vi(2*Math.atan2(n,s)),u=-90;else{var h=n*n,f=r*r,_=a*a;o=vi(Math.atan2(2*n*s-2*r*a,1-2*h-2*_)),l=vi(Math.atan2(2*r*s-2*n*a,1-2*f-2*_)),u=vi(Math.asin(2*c)),i&&(o=-180*Math.sign(o+1e-6)+o,l=-180*Math.sign(l+1e-6)+l,u=180*Math.sign(u+1e-6)-u)}return e.x=o,e.y=l,e.z=u,e}},{key:"toArray",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e[i+0]=t.x,e[i+1]=t.y,e[i+2]=t.z,e[i+3]=t.w,e}},{key:"fromArray",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e.x=t[i+0],e.y=t[i+1],e.z=t[i+2],e.w=t[i+3],e}},{key:"strictEquals",value:function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z&&e.w===t.w}},{key:"equals",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:ci;return Math.abs(e.x-t.x)<=i*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=i*Math.max(1,Math.abs(e.y),Math.abs(t.y))&&Math.abs(e.z-t.z)<=i*Math.max(1,Math.abs(e.z),Math.abs(t.z))&&Math.abs(e.w-t.w)<=i*Math.max(1,Math.abs(e.w),Math.abs(t.w))}}]),r(n,[{key:"clone",value:function(){return new n(this.x,this.y,this.z,this.w)}},{key:"set",value:function(e,i,n,r){return e&&"object"===t(e)?(this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w):(this.x=e||0,this.y=i||0,this.z=n||0,this.w=r||1),this}},{key:"equals",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:ci;return Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=t*Math.max(1,Math.abs(this.z),Math.abs(e.z))&&Math.abs(this.w-e.w)<=t*Math.max(1,Math.abs(this.w),Math.abs(e.w))}},{key:"strictEquals",value:function(e){return e&&this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w}},{key:"getEulerAngles",value:function(e){return n.toEuler(e,this)}},{key:"lerp",value:function(e,t){var i=0,n=0,r=this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w;if(r<0&&(r=-r,e.x=-e.x,e.y=-e.y,e.z=-e.z,e.w=-e.w),1-r>1e-6){var a=Math.acos(r),s=Math.sin(a);i=Math.sin((1-t)*a)/s,n=Math.sin(t*a)/s}else i=1-t,n=t;return this.x=i*this.x+n*e.x,this.y=i*this.y+n*e.y,this.z=i*this.z+n*e.z,this.w=i*this.w+n*e.w,this}},{key:"length",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}},{key:"lengthSqr",value:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}}]),n}(mt));fn.IDENTITY=Object.freeze(new fn);var _n=new fn,dn=new fn,pn=new zi,mn=new an,vn=.5*Math.PI/180;function gn(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;return new fn(e,t,i,n)}ri.fastDefine("cc.Quat",fn,{x:0,y:0,z:0,w:1}),cc.Quat=fn,cc.quat=gn;var yn=0,bn=0,En=0,Tn=0,Sn=0,xn=0,An=0,wn=0,Cn=0,Rn=0,kn=0,On=0,In=0,Mn=0,Ln=0,Pn=0,Bn=e("Mat4",function(e){function n(){var e,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,l=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,u=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,h=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1,f=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,_=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,d=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,p=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0,m=arguments.length>10&&void 0!==arguments[10]?arguments[10]:1,v=arguments.length>11&&void 0!==arguments[11]?arguments[11]:0,g=arguments.length>12&&void 0!==arguments[12]?arguments[12]:0,y=arguments.length>13&&void 0!==arguments[13]?arguments[13]:0,b=arguments.length>14&&void 0!==arguments[14]?arguments[14]:0,E=arguments.length>15&&void 0!==arguments[15]?arguments[15]:1;return i(this,n),e=c(this,o(n).call(this)),"object"===t(r)?(e.m01=r.m01,e.m02=r.m02,e.m03=r.m03,e.m04=r.m04,e.m05=r.m05,e.m06=r.m06,e.m07=r.m07,e.m08=r.m08,e.m09=r.m09,e.m10=r.m10,e.m11=r.m11,e.m12=r.m12,e.m13=r.m13,e.m14=r.m14,e.m15=r.m15,e.m00=r.m00):(e.m01=a,e.m02=s,e.m03=l,e.m04=u,e.m05=h,e.m06=f,e.m07=_,e.m08=d,e.m09=p,e.m10=m,e.m11=v,e.m12=g,e.m13=y,e.m14=b,e.m15=E,e.m00=r),e}return s(n,e),r(n,null,[{key:"clone",value:function(e){return new n(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08,e.m09,e.m10,e.m11,e.m12,e.m13,e.m14,e.m15)}},{key:"copy",value:function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15,e}},{key:"set",value:function(e,t,i,n,r,a,s,o,l,u,c,h,f,_,d,p,m){return e.m00=t,e.m01=i,e.m02=n,e.m03=r,e.m04=a,e.m05=s,e.m06=o,e.m07=l,e.m08=u,e.m09=c,e.m10=h,e.m11=f,e.m12=_,e.m13=d,e.m14=p,e.m15=m,e}},{key:"identity",value:function(e){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"transpose",value:function(e,t){if(e===t){var i=t.m01,n=t.m02,r=t.m03,a=t.m06,s=t.m07,o=t.m11;e.m01=t.m04,e.m02=t.m08,e.m03=t.m12,e.m04=i,e.m06=t.m09,e.m07=t.m13,e.m08=n,e.m09=a,e.m11=t.m14,e.m12=r,e.m13=s,e.m14=o}else e.m00=t.m00,e.m01=t.m04,e.m02=t.m08,e.m03=t.m12,e.m04=t.m01,e.m05=t.m05,e.m06=t.m09,e.m07=t.m13,e.m08=t.m02,e.m09=t.m06,e.m10=t.m10,e.m11=t.m14,e.m12=t.m03,e.m13=t.m07,e.m14=t.m11,e.m15=t.m15;return e}},{key:"invert",value:function(e,t){yn=t.m00,bn=t.m01,En=t.m02,Tn=t.m03,Sn=t.m04,xn=t.m05,An=t.m06,wn=t.m07,Cn=t.m08,Rn=t.m09,kn=t.m10,On=t.m11,In=t.m12,Mn=t.m13,Ln=t.m14,Pn=t.m15;var i=yn*xn-bn*Sn,n=yn*An-En*Sn,r=yn*wn-Tn*Sn,a=bn*An-En*xn,s=bn*wn-Tn*xn,o=En*wn-Tn*An,l=Cn*Mn-Rn*In,u=Cn*Ln-kn*In,c=Cn*Pn-On*In,h=Rn*Ln-kn*Mn,f=Rn*Pn-On*Mn,_=kn*Pn-On*Ln,d=i*_-n*f+r*h+a*c-s*u+o*l;return 0===d?e:(d=1/d,e.m00=(xn*_-An*f+wn*h)*d,e.m01=(En*f-bn*_-Tn*h)*d,e.m02=(Mn*o-Ln*s+Pn*a)*d,e.m03=(kn*s-Rn*o-On*a)*d,e.m04=(An*c-Sn*_-wn*u)*d,e.m05=(yn*_-En*c+Tn*u)*d,e.m06=(Ln*r-In*o-Pn*n)*d,e.m07=(Cn*o-kn*r+On*n)*d,e.m08=(Sn*f-xn*c+wn*l)*d,e.m09=(bn*c-yn*f-Tn*l)*d,e.m10=(In*s-Mn*r+Pn*i)*d,e.m11=(Rn*r-Cn*s-On*i)*d,e.m12=(xn*u-Sn*h-An*l)*d,e.m13=(yn*h-bn*u+En*l)*d,e.m14=(Mn*n-In*a-Ln*i)*d,e.m15=(Cn*a-Rn*n+kn*i)*d,e)}},{key:"determinant",value:function(e){return yn=e.m00,bn=e.m01,En=e.m02,Tn=e.m03,Sn=e.m04,xn=e.m05,An=e.m06,wn=e.m07,Cn=e.m08,Rn=e.m09,kn=e.m10,On=e.m11,In=e.m12,Mn=e.m13,Ln=e.m14,Pn=e.m15,(yn*xn-bn*Sn)*(kn*Pn-On*Ln)-(yn*An-En*Sn)*(Rn*Pn-On*Mn)+(yn*wn-Tn*Sn)*(Rn*Ln-kn*Mn)+(bn*An-En*xn)*(Cn*Pn-On*In)-(bn*wn-Tn*xn)*(Cn*Ln-kn*In)+(En*wn-Tn*An)*(Cn*Mn-Rn*In)}},{key:"multiply",value:function(e,t,i){yn=t.m00,bn=t.m01,En=t.m02,Tn=t.m03,Sn=t.m04,xn=t.m05,An=t.m06,wn=t.m07,Cn=t.m08,Rn=t.m09,kn=t.m10,On=t.m11,In=t.m12,Mn=t.m13,Ln=t.m14,Pn=t.m15;var n=i.m00,r=i.m01,a=i.m02,s=i.m03;return e.m00=n*yn+r*Sn+a*Cn+s*In,e.m01=n*bn+r*xn+a*Rn+s*Mn,e.m02=n*En+r*An+a*kn+s*Ln,e.m03=n*Tn+r*wn+a*On+s*Pn,n=i.m04,r=i.m05,a=i.m06,s=i.m07,e.m04=n*yn+r*Sn+a*Cn+s*In,e.m05=n*bn+r*xn+a*Rn+s*Mn,e.m06=n*En+r*An+a*kn+s*Ln,e.m07=n*Tn+r*wn+a*On+s*Pn,n=i.m08,r=i.m09,a=i.m10,s=i.m11,e.m08=n*yn+r*Sn+a*Cn+s*In,e.m09=n*bn+r*xn+a*Rn+s*Mn,e.m10=n*En+r*An+a*kn+s*Ln,e.m11=n*Tn+r*wn+a*On+s*Pn,n=i.m12,r=i.m13,a=i.m14,s=i.m15,e.m12=n*yn+r*Sn+a*Cn+s*In,e.m13=n*bn+r*xn+a*Rn+s*Mn,e.m14=n*En+r*An+a*kn+s*Ln,e.m15=n*Tn+r*wn+a*On+s*Pn,e}},{key:"transform",value:function(e,t,i){var n=i.x,r=i.y,a=i.z;return t===e?(e.m12=t.m00*n+t.m04*r+t.m08*a+t.m12,e.m13=t.m01*n+t.m05*r+t.m09*a+t.m13,e.m14=t.m02*n+t.m06*r+t.m10*a+t.m14,e.m15=t.m03*n+t.m07*r+t.m11*a+t.m15):(yn=t.m00,bn=t.m01,En=t.m02,Tn=t.m03,Sn=t.m04,xn=t.m05,An=t.m06,wn=t.m07,Cn=t.m08,Rn=t.m09,kn=t.m10,On=t.m11,In=t.m12,Mn=t.m13,Ln=t.m14,Pn=t.m15,e.m00=yn,e.m01=bn,e.m02=En,e.m03=Tn,e.m04=Sn,e.m05=xn,e.m06=An,e.m07=wn,e.m08=Cn,e.m09=Rn,e.m10=kn,e.m11=On,e.m12=yn*n+Sn*r+Cn*a+t.m12,e.m13=bn*n+xn*r+Rn*a+t.m13,e.m14=En*n+An*r+kn*a+t.m14,e.m15=Tn*n+wn*r+On*a+t.m15),e}},{key:"translate",value:function(e,t,i){return console.warn("function changed"),t===e?(e.m12+=i.x,e.m13+=i.y,e.m14+=i.y):(e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12+=i.x,e.m13+=i.y,e.m14+=i.z,e.m15=t.m15),e}},{key:"scale",value:function(e,t,i){var n=i.x,r=i.y,a=i.z;return e.m00=t.m00*n,e.m01=t.m01*n,e.m02=t.m02*n,e.m03=t.m03*n,e.m04=t.m04*r,e.m05=t.m05*r,e.m06=t.m06*r,e.m07=t.m07*r,e.m08=t.m08*a,e.m09=t.m09*a,e.m10=t.m10*a,e.m11=t.m11*a,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15,e}},{key:"rotate",value:function(e,t,i,n){var r=n.x,a=n.y,s=n.z,o=Math.sqrt(r*r+a*a+s*s);if(Math.abs(o)<ci)return null;r*=o=1/o,a*=o,s*=o;var l=Math.sin(i),u=Math.cos(i),c=1-u;yn=t.m00,bn=t.m01,En=t.m02,Tn=t.m03,Sn=t.m04,xn=t.m05,An=t.m06,wn=t.m07,Cn=t.m08,Rn=t.m09,kn=t.m10,On=t.m11;var h=r*r*c+u,f=a*r*c+s*l,_=s*r*c-a*l,d=r*a*c-s*l,p=a*a*c+u,m=s*a*c+r*l,v=r*s*c+a*l,g=a*s*c-r*l,y=s*s*c+u;return e.m00=yn*h+Sn*f+Cn*_,e.m01=bn*h+xn*f+Rn*_,e.m02=En*h+An*f+kn*_,e.m03=Tn*h+wn*f+On*_,e.m04=yn*d+Sn*p+Cn*m,e.m05=bn*d+xn*p+Rn*m,e.m06=En*d+An*p+kn*m,e.m07=Tn*d+wn*p+On*m,e.m08=yn*v+Sn*g+Cn*y,e.m09=bn*v+xn*g+Rn*y,e.m10=En*v+An*g+kn*y,e.m11=Tn*v+wn*g+On*y,t!==e&&(e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e}},{key:"rotateX",value:function(e,t,i){var n=Math.sin(i),r=Math.cos(i),a=t.m04,s=t.m05,o=t.m06,l=t.m07,u=t.m08,c=t.m09,h=t.m10,f=t.m11;return t!==e&&(e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m04=a*r+u*n,e.m05=s*r+c*n,e.m06=o*r+h*n,e.m07=l*r+f*n,e.m08=u*r-a*n,e.m09=c*r-s*n,e.m10=h*r-o*n,e.m11=f*r-l*n,e}},{key:"rotateY",value:function(e,t,i){var n=Math.sin(i),r=Math.cos(i),a=t.m00,s=t.m01,o=t.m02,l=t.m03,u=t.m08,c=t.m09,h=t.m10,f=t.m11;return t!==e&&(e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m00=a*r-u*n,e.m01=s*r-c*n,e.m02=o*r-h*n,e.m03=l*r-f*n,e.m08=a*n+u*r,e.m09=s*n+c*r,e.m10=o*n+h*r,e.m11=l*n+f*r,e}},{key:"rotateZ",value:function(e,t,i){var n=Math.sin(i),r=Math.cos(i),a=t.m00,s=t.m01,o=t.m02,l=t.m03,u=t.m04,c=t.m05,h=t.m06,f=t.m07;return t!==e&&(e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m00=a*r+u*n,e.m01=s*r+c*n,e.m02=o*r+h*n,e.m03=l*r+f*n,e.m04=u*r-a*n,e.m05=c*r-s*n,e.m06=h*r-o*n,e.m07=f*r-l*n,e}},{key:"fromTranslation",value:function(e,t){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=t.x,e.m13=t.y,e.m14=t.z,e.m15=1,e}},{key:"fromScaling",value:function(e,t){return e.m00=t.x,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=t.y,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=t.z,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"fromRotation",value:function(e,t,i){var n=i.x,r=i.y,a=i.z,s=Math.sqrt(n*n+r*r+a*a);if(Math.abs(s)<ci)return null;n*=s=1/s,r*=s,a*=s;var o=Math.sin(t),l=Math.cos(t),u=1-l;return e.m00=n*n*u+l,e.m01=r*n*u+a*o,e.m02=a*n*u-r*o,e.m03=0,e.m04=n*r*u-a*o,e.m05=r*r*u+l,e.m06=a*r*u+n*o,e.m07=0,e.m08=n*a*u+r*o,e.m09=r*a*u-n*o,e.m10=a*a*u+l,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"fromXRotation",value:function(e,t){var i=Math.sin(t),n=Math.cos(t);return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=n,e.m06=i,e.m07=0,e.m08=0,e.m09=-i,e.m10=n,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"fromYRotation",value:function(e,t){var i=Math.sin(t),n=Math.cos(t);return e.m00=n,e.m01=0,e.m02=-i,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=i,e.m09=0,e.m10=n,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"fromZRotation",value:function(e,t){var i=Math.sin(t),n=Math.cos(t);return e.m00=n,e.m01=i,e.m02=0,e.m03=0,e.m04=-i,e.m05=n,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"fromRT",value:function(e,t,i){var n=t.x,r=t.y,a=t.z,s=t.w,o=n+n,l=r+r,u=a+a,c=n*o,h=n*l,f=n*u,_=r*l,d=r*u,p=a*u,m=s*o,v=s*l,g=s*u;return e.m00=1-(_+p),e.m01=h+g,e.m02=f-v,e.m03=0,e.m04=h-g,e.m05=1-(c+p),e.m06=d+m,e.m07=0,e.m08=f+v,e.m09=d-m,e.m10=1-(c+_),e.m11=0,e.m12=i.x,e.m13=i.y,e.m14=i.z,e.m15=1,e}},{key:"getTranslation",value:function(e,t){return e.x=t.m12,e.y=t.m13,e.z=t.m14,e}},{key:"getScaling",value:function(e,t){var i=Fn.m00=t.m00,n=Fn.m01=t.m01,r=Fn.m02=t.m02,a=Fn.m03=t.m04,s=Fn.m04=t.m05,o=Fn.m05=t.m06,l=Fn.m06=t.m08,u=Fn.m07=t.m09,c=Fn.m08=t.m10;return e.x=Math.sqrt(i*i+n*n+r*r),e.y=Math.sqrt(a*a+s*s+o*o),e.z=Math.sqrt(l*l+u*u+c*c),an.determinant(Fn)<0&&(e.x*=-1),e}},{key:"getRotation",value:function(e,t){var i=t.m00+t.m05+t.m10,n=0;return i>0?(n=2*Math.sqrt(i+1),e.w=.25*n,e.x=(t.m06-t.m09)/n,e.y=(t.m08-t.m02)/n,e.z=(t.m01-t.m04)/n):t.m00>t.m05&&t.m00>t.m10?(n=2*Math.sqrt(1+t.m00-t.m05-t.m10),e.w=(t.m06-t.m09)/n,e.x=.25*n,e.y=(t.m01+t.m04)/n,e.z=(t.m08+t.m02)/n):t.m05>t.m10?(n=2*Math.sqrt(1+t.m05-t.m00-t.m10),e.w=(t.m08-t.m02)/n,e.x=(t.m01+t.m04)/n,e.y=.25*n,e.z=(t.m06+t.m09)/n):(n=2*Math.sqrt(1+t.m10-t.m00-t.m05),e.w=(t.m01-t.m04)/n,e.x=(t.m08+t.m02)/n,e.y=(t.m06+t.m09)/n,e.z=.25*n),e}},{key:"toRTS",value:function(e,t,i,n){n.x=zi.set(Dn,e.m00,e.m01,e.m02).length(),Fn.m00=e.m00/n.x,Fn.m01=e.m01/n.x,Fn.m02=e.m02/n.x,n.y=zi.set(Dn,e.m04,e.m05,e.m06).length(),Fn.m03=e.m04/n.y,Fn.m04=e.m05/n.y,Fn.m05=e.m06/n.y,n.z=zi.set(Dn,e.m08,e.m09,e.m10).length(),Fn.m06=e.m08/n.z,Fn.m07=e.m09/n.z,Fn.m08=e.m10/n.z,an.determinant(Fn)<0&&(n.x*=-1,Fn.m00*=-1,Fn.m01*=-1,Fn.m02*=-1),fn.fromMat3(t,Fn),zi.set(i,e.m12,e.m13,e.m14)}},{key:"fromRTS",value:function(e,t,i,n){var r=t.x,a=t.y,s=t.z,o=t.w,l=r+r,u=a+a,c=s+s,h=r*l,f=r*u,_=r*c,d=a*u,p=a*c,m=s*c,v=o*l,g=o*u,y=o*c,b=n.x,E=n.y,T=n.z;return e.m00=(1-(d+m))*b,e.m01=(f+y)*b,e.m02=(_-g)*b,e.m03=0,e.m04=(f-y)*E,e.m05=(1-(h+m))*E,e.m06=(p+v)*E,e.m07=0,e.m08=(_+g)*T,e.m09=(p-v)*T,e.m10=(1-(h+d))*T,e.m11=0,e.m12=i.x,e.m13=i.y,e.m14=i.z,e.m15=1,e}},{key:"fromRTSOrigin",value:function(e,t,i,n,r){var a=t.x,s=t.y,o=t.z,l=t.w,u=a+a,c=s+s,h=o+o,f=a*u,_=a*c,d=a*h,p=s*c,m=s*h,v=o*h,g=l*u,y=l*c,b=l*h,E=n.x,T=n.y,S=n.z,x=r.x,A=r.y,w=r.z;return e.m00=(1-(p+v))*E,e.m01=(_+b)*E,e.m02=(d-y)*E,e.m03=0,e.m04=(_-b)*T,e.m05=(1-(f+v))*T,e.m06=(m+g)*T,e.m07=0,e.m08=(d+y)*S,e.m09=(m-g)*S,e.m10=(1-(f+p))*S,e.m11=0,e.m12=i.x+x-(e.m00*x+e.m04*A+e.m08*w),e.m13=i.y+A-(e.m01*x+e.m05*A+e.m09*w),e.m14=i.z+w-(e.m02*x+e.m06*A+e.m10*w),e.m15=1,e}},{key:"fromQuat",value:function(e,t){var i=t.x,n=t.y,r=t.z,a=t.w,s=i+i,o=n+n,l=r+r,u=i*s,c=n*s,h=n*o,f=r*s,_=r*o,d=r*l,p=a*s,m=a*o,v=a*l;return e.m00=1-h-d,e.m01=c+v,e.m02=f-m,e.m03=0,e.m04=c-v,e.m05=1-u-d,e.m06=_+p,e.m07=0,e.m08=f+m,e.m09=_-p,e.m10=1-u-h,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"frustum",value:function(e,t,i,n,r,a,s){var o=1/(i-t),l=1/(r-n),u=1/(a-s);return e.m00=2*a*o,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=2*a*l,e.m06=0,e.m07=0,e.m08=(i+t)*o,e.m09=(r+n)*l,e.m10=(s+a)*u,e.m11=-1,e.m12=0,e.m13=0,e.m14=s*a*2*u,e.m15=0,e}},{key:"perspective",value:function(e,t,i,n,r){var a=1/Math.tan(t/2),s=1/(n-r);return e.m00=a/i,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=a,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=(r+n)*s,e.m11=-1,e.m12=0,e.m13=0,e.m14=2*r*n*s,e.m15=0,e}},{key:"ortho",value:function(e,t,i,n,r,a,s){var o=1/(t-i),l=1/(n-r),u=1/(a-s);return e.m00=-2*o,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=-2*l,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=2*u,e.m11=0,e.m12=(t+i)*o,e.m13=(r+n)*l,e.m14=(s+a)*u,e.m15=1,e}},{key:"lookAt",value:function(e,t,i,n){var r=t.x,a=t.y,s=t.z,o=n.x,l=n.y,u=n.z,c=r-i.x,h=a-i.y,f=s-i.z,_=1/Math.sqrt(c*c+h*h+f*f),d=l*(f*=_)-u*(h*=_),p=u*(c*=_)-o*f,m=o*h-l*c,v=h*(m*=_=1/Math.sqrt(d*d+p*p+m*m))-f*(p*=_),g=f*(d*=_)-c*m,y=c*p-h*d;return e.m00=d,e.m01=v,e.m02=c,e.m03=0,e.m04=p,e.m05=g,e.m06=h,e.m07=0,e.m08=m,e.m09=y,e.m10=f,e.m11=0,e.m12=-(d*r+p*a+m*s),e.m13=-(v*r+g*a+y*s),e.m14=-(c*r+h*a+f*s),e.m15=1,e}},{key:"inverseTranspose",value:function(e,t){yn=t.m00,bn=t.m01,En=t.m02,Tn=t.m03,Sn=t.m04,xn=t.m05,An=t.m06,wn=t.m07,Cn=t.m08,Rn=t.m09,kn=t.m10,On=t.m11,In=t.m12,Mn=t.m13,Ln=t.m14,Pn=t.m15;var i=yn*xn-bn*Sn,n=yn*An-En*Sn,r=yn*wn-Tn*Sn,a=bn*An-En*xn,s=bn*wn-Tn*xn,o=En*wn-Tn*An,l=Cn*Mn-Rn*In,u=Cn*Ln-kn*In,c=Cn*Pn-On*In,h=Rn*Ln-kn*Mn,f=Rn*Pn-On*Mn,_=kn*Pn-On*Ln,d=i*_-n*f+r*h+a*c-s*u+o*l;return d?(d=1/d,e.m00=(xn*_-An*f+wn*h)*d,e.m01=(An*c-Sn*_-wn*u)*d,e.m02=(Sn*f-xn*c+wn*l)*d,e.m03=0,e.m04=(En*f-bn*_-Tn*h)*d,e.m05=(yn*_-En*c+Tn*u)*d,e.m06=(bn*c-yn*f-Tn*l)*d,e.m07=0,e.m08=(Mn*o-Ln*s+Pn*a)*d,e.m09=(Ln*r-In*o-Pn*n)*d,e.m10=(In*s-Mn*r+Pn*i)*d,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e):null}},{key:"toArray",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e[i+0]=t.m00,e[i+1]=t.m01,e[i+2]=t.m02,e[i+3]=t.m03,e[i+4]=t.m04,e[i+5]=t.m05,e[i+6]=t.m06,e[i+7]=t.m07,e[i+8]=t.m08,e[i+9]=t.m09,e[i+10]=t.m10,e[i+11]=t.m11,e[i+12]=t.m12,e[i+13]=t.m13,e[i+14]=t.m14,e[i+15]=t.m15,e}},{key:"fromArray",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e.m00=t[i+0],e.m01=t[i+1],e.m02=t[i+2],e.m03=t[i+3],e.m04=t[i+4],e.m05=t[i+5],e.m06=t[i+6],e.m07=t[i+7],e.m08=t[i+8],e.m09=t[i+9],e.m10=t[i+10],e.m11=t[i+11],e.m12=t[i+12],e.m13=t[i+13],e.m14=t[i+14],e.m15=t[i+15],e}},{key:"add",value:function(e,t,i){return e.m00=t.m00+i.m00,e.m01=t.m01+i.m01,e.m02=t.m02+i.m02,e.m03=t.m03+i.m03,e.m04=t.m04+i.m04,e.m05=t.m05+i.m05,e.m06=t.m06+i.m06,e.m07=t.m07+i.m07,e.m08=t.m08+i.m08,e.m09=t.m09+i.m09,e.m10=t.m10+i.m10,e.m11=t.m11+i.m11,e.m12=t.m12+i.m12,e.m13=t.m13+i.m13,e.m14=t.m14+i.m14,e.m15=t.m15+i.m15,e}},{key:"subtract",value:function(e,t,i){return e.m00=t.m00-i.m00,e.m01=t.m01-i.m01,e.m02=t.m02-i.m02,e.m03=t.m03-i.m03,e.m04=t.m04-i.m04,e.m05=t.m05-i.m05,e.m06=t.m06-i.m06,e.m07=t.m07-i.m07,e.m08=t.m08-i.m08,e.m09=t.m09-i.m09,e.m10=t.m10-i.m10,e.m11=t.m11-i.m11,e.m12=t.m12-i.m12,e.m13=t.m13-i.m13,e.m14=t.m14-i.m14,e.m15=t.m15-i.m15,e}},{key:"multiplyScalar",value:function(e,t,i){return e.m00=t.m00*i,e.m01=t.m01*i,e.m02=t.m02*i,e.m03=t.m03*i,e.m04=t.m04*i,e.m05=t.m05*i,e.m06=t.m06*i,e.m07=t.m07*i,e.m08=t.m08*i,e.m09=t.m09*i,e.m10=t.m10*i,e.m11=t.m11*i,e.m12=t.m12*i,e.m13=t.m13*i,e.m14=t.m14*i,e.m15=t.m15*i,e}},{key:"multiplyScalarAndAdd",value:function(e,t,i,n){return e.m00=t.m00+i.m00*n,e.m01=t.m01+i.m01*n,e.m02=t.m02+i.m02*n,e.m03=t.m03+i.m03*n,e.m04=t.m04+i.m04*n,e.m05=t.m05+i.m05*n,e.m06=t.m06+i.m06*n,e.m07=t.m07+i.m07*n,e.m08=t.m08+i.m08*n,e.m09=t.m09+i.m09*n,e.m10=t.m10+i.m10*n,e.m11=t.m11+i.m11*n,e.m12=t.m12+i.m12*n,e.m13=t.m13+i.m13*n,e.m14=t.m14+i.m14*n,e.m15=t.m15+i.m15*n,e}},{key:"strictEquals",value:function(e,t){return e.m00===t.m00&&e.m01===t.m01&&e.m02===t.m02&&e.m03===t.m03&&e.m04===t.m04&&e.m05===t.m05&&e.m06===t.m06&&e.m07===t.m07&&e.m08===t.m08&&e.m09===t.m09&&e.m10===t.m10&&e.m11===t.m11&&e.m12===t.m12&&e.m13===t.m13&&e.m14===t.m14&&e.m15===t.m15}},{key:"equals",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:ci;return Math.abs(e.m00-t.m00)<=i*Math.max(1,Math.abs(e.m00),Math.abs(t.m00))&&Math.abs(e.m01-t.m01)<=i*Math.max(1,Math.abs(e.m01),Math.abs(t.m01))&&Math.abs(e.m02-t.m02)<=i*Math.max(1,Math.abs(e.m02),Math.abs(t.m02))&&Math.abs(e.m03-t.m03)<=i*Math.max(1,Math.abs(e.m03),Math.abs(t.m03))&&Math.abs(e.m04-t.m04)<=i*Math.max(1,Math.abs(e.m04),Math.abs(t.m04))&&Math.abs(e.m05-t.m05)<=i*Math.max(1,Math.abs(e.m05),Math.abs(t.m05))&&Math.abs(e.m06-t.m06)<=i*Math.max(1,Math.abs(e.m06),Math.abs(t.m06))&&Math.abs(e.m07-t.m07)<=i*Math.max(1,Math.abs(e.m07),Math.abs(t.m07))&&Math.abs(e.m08-t.m08)<=i*Math.max(1,Math.abs(e.m08),Math.abs(t.m08))&&Math.abs(e.m09-t.m09)<=i*Math.max(1,Math.abs(e.m09),Math.abs(t.m09))&&Math.abs(e.m10-t.m10)<=i*Math.max(1,Math.abs(e.m10),Math.abs(t.m10))&&Math.abs(e.m11-t.m11)<=i*Math.max(1,Math.abs(e.m11),Math.abs(t.m11))&&Math.abs(e.m12-t.m12)<=i*Math.max(1,Math.abs(e.m12),Math.abs(t.m12))&&Math.abs(e.m13-t.m13)<=i*Math.max(1,Math.abs(e.m13),Math.abs(t.m13))&&Math.abs(e.m14-t.m14)<=i*Math.max(1,Math.abs(e.m14),Math.abs(t.m14))&&Math.abs(e.m15-t.m15)<=i*Math.max(1,Math.abs(e.m15),Math.abs(t.m15))}}]),r(n,[{key:"clone",value:function(){var e=this;return new n(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08,e.m09,e.m10,e.m11,e.m12,e.m13,e.m14,e.m15)}},{key:"set",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1,o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,l=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,u=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,c=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0,h=arguments.length>10&&void 0!==arguments[10]?arguments[10]:1,f=arguments.length>11&&void 0!==arguments[11]?arguments[11]:0,_=arguments.length>12&&void 0!==arguments[12]?arguments[12]:0,d=arguments.length>13&&void 0!==arguments[13]?arguments[13]:0,p=arguments.length>14&&void 0!==arguments[14]?arguments[14]:0,m=arguments.length>15&&void 0!==arguments[15]?arguments[15]:1;return"object"===t(e)?(this.m01=e.m01,this.m02=e.m02,this.m03=e.m03,this.m04=e.m04,this.m05=e.m05,this.m06=e.m06,this.m07=e.m07,this.m08=e.m08,this.m09=e.m09,this.m10=e.m10,this.m11=e.m11,this.m12=e.m12,this.m13=e.m13,this.m14=e.m14,this.m15=e.m15,this.m00=e.m00):(this.m01=i,this.m02=n,this.m03=r,this.m04=a,this.m05=s,this.m06=o,this.m07=l,this.m08=u,this.m09=c,this.m10=h,this.m11=f,this.m12=_,this.m13=d,this.m14=p,this.m15=m,this.m00=e),this}},{key:"equals",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:ci;return Math.abs(this.m00-e.m00)<=t*Math.max(1,Math.abs(this.m00),Math.abs(e.m00))&&Math.abs(this.m01-e.m01)<=t*Math.max(1,Math.abs(this.m01),Math.abs(e.m01))&&Math.abs(this.m02-e.m02)<=t*Math.max(1,Math.abs(this.m02),Math.abs(e.m02))&&Math.abs(this.m03-e.m03)<=t*Math.max(1,Math.abs(this.m03),Math.abs(e.m03))&&Math.abs(this.m04-e.m04)<=t*Math.max(1,Math.abs(this.m04),Math.abs(e.m04))&&Math.abs(this.m05-e.m05)<=t*Math.max(1,Math.abs(this.m05),Math.abs(e.m05))&&Math.abs(this.m06-e.m06)<=t*Math.max(1,Math.abs(this.m06),Math.abs(e.m06))&&Math.abs(this.m07-e.m07)<=t*Math.max(1,Math.abs(this.m07),Math.abs(e.m07))&&Math.abs(this.m08-e.m08)<=t*Math.max(1,Math.abs(this.m08),Math.abs(e.m08))&&Math.abs(this.m09-e.m09)<=t*Math.max(1,Math.abs(this.m09),Math.abs(e.m09))&&Math.abs(this.m10-e.m10)<=t*Math.max(1,Math.abs(this.m10),Math.abs(e.m10))&&Math.abs(this.m11-e.m11)<=t*Math.max(1,Math.abs(this.m11),Math.abs(e.m11))&&Math.abs(this.m12-e.m12)<=t*Math.max(1,Math.abs(this.m12),Math.abs(e.m12))&&Math.abs(this.m13-e.m13)<=t*Math.max(1,Math.abs(this.m13),Math.abs(e.m13))&&Math.abs(this.m14-e.m14)<=t*Math.max(1,Math.abs(this.m14),Math.abs(e.m14))&&Math.abs(this.m15-e.m15)<=t*Math.max(1,Math.abs(this.m15),Math.abs(e.m15))}},{key:"strictEquals",value:function(e){return this.m00===e.m00&&this.m01===e.m01&&this.m02===e.m02&&this.m03===e.m03&&this.m04===e.m04&&this.m05===e.m05&&this.m06===e.m06&&this.m07===e.m07&&this.m08===e.m08&&this.m09===e.m09&&this.m10===e.m10&&this.m11===e.m11&&this.m12===e.m12&&this.m13===e.m13&&this.m14===e.m14&&this.m15===e.m15}},{key:"toString",value:function(){return"[\n"+this.m00+", "+this.m01+", "+this.m02+", "+this.m03+",\n"+this.m04+", "+this.m05+", "+this.m06+", "+this.m07+",\n"+this.m08+", "+this.m09+", "+this.m10+", "+this.m11+",\n"+this.m12+", "+this.m13+", "+this.m14+", "+this.m15+"\n]"}},{key:"identity",value:function(){return this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m04=0,this.m05=1,this.m06=0,this.m07=0,this.m08=0,this.m09=0,this.m10=1,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=1,this}},{key:"transpose",value:function(){var e=this.m01,t=this.m02,i=this.m03,n=this.m06,r=this.m07,a=this.m11;return this.m01=this.m04,this.m02=this.m08,this.m03=this.m12,this.m04=e,this.m06=this.m09,this.m07=this.m13,this.m08=t,this.m09=n,this.m11=this.m14,this.m12=i,this.m13=r,this.m14=a,this}},{key:"invert",value:function(){yn=this.m00,bn=this.m01,En=this.m02,Tn=this.m03,Sn=this.m04,xn=this.m05,An=this.m06,wn=this.m07,Cn=this.m08,Rn=this.m09,kn=this.m10,On=this.m11,In=this.m12,Mn=this.m13,Ln=this.m14,Pn=this.m15;var e=yn*xn-bn*Sn,t=yn*An-En*Sn,i=yn*wn-Tn*Sn,n=bn*An-En*xn,r=bn*wn-Tn*xn,a=En*wn-Tn*An,s=Cn*Mn-Rn*In,o=Cn*Ln-kn*In,l=Cn*Pn-On*In,u=Rn*Ln-kn*Mn,c=Rn*Pn-On*Mn,h=kn*Pn-On*Ln,f=e*h-t*c+i*u+n*l-r*o+a*s;return 0===f?null:(f=1/f,this.m00=(xn*h-An*c+wn*u)*f,this.m01=(En*c-bn*h-Tn*u)*f,this.m02=(Mn*a-Ln*r+Pn*n)*f,this.m03=(kn*r-Rn*a-On*n)*f,this.m04=(An*l-Sn*h-wn*o)*f,this.m05=(yn*h-En*l+Tn*o)*f,this.m06=(Ln*i-In*a-Pn*t)*f,this.m07=(Cn*a-kn*i+On*t)*f,this.m08=(Sn*c-xn*l+wn*s)*f,this.m09=(bn*l-yn*c-Tn*s)*f,this.m10=(In*r-Mn*i+Pn*e)*f,this.m11=(Rn*i-Cn*r-On*e)*f,this.m12=(xn*o-Sn*u-An*s)*f,this.m13=(yn*u-bn*o+En*s)*f,this.m14=(Mn*t-In*n-Ln*e)*f,this.m15=(Cn*n-Rn*t+kn*e)*f,this)}},{key:"determinant",value:function(){return yn=this.m00,bn=this.m01,En=this.m02,Tn=this.m03,Sn=this.m04,xn=this.m05,An=this.m06,wn=this.m07,Cn=this.m08,Rn=this.m09,kn=this.m10,On=this.m11,In=this.m12,Mn=this.m13,Ln=this.m14,Pn=this.m15,(yn*xn-bn*Sn)*(kn*Pn-On*Ln)-(yn*An-En*Sn)*(Rn*Pn-On*Mn)+(yn*wn-Tn*Sn)*(Rn*Ln-kn*Mn)+(bn*An-En*xn)*(Cn*Pn-On*In)-(bn*wn-Tn*xn)*(Cn*Ln-kn*In)+(En*wn-Tn*An)*(Cn*Mn-Rn*In)}},{key:"add",value:function(e){return this.m00=this.m00+e.m00,this.m01=this.m01+e.m01,this.m02=this.m02+e.m02,this.m03=this.m03+e.m03,this.m04=this.m04+e.m04,this.m05=this.m05+e.m05,this.m06=this.m06+e.m06,this.m07=this.m07+e.m07,this.m08=this.m08+e.m08,this.m09=this.m09+e.m09,this.m10=this.m10+e.m10,this.m11=this.m11+e.m11,this.m12=this.m12+e.m12,this.m13=this.m13+e.m13,this.m14=this.m14+e.m14,this.m15=this.m15+e.m15,this}},{key:"subtract",value:function(e){return this.m00=this.m00-e.m00,this.m01=this.m01-e.m01,this.m02=this.m02-e.m02,this.m03=this.m03-e.m03,this.m04=this.m04-e.m04,this.m05=this.m05-e.m05,this.m06=this.m06-e.m06,this.m07=this.m07-e.m07,this.m08=this.m08-e.m08,this.m09=this.m09-e.m09,this.m10=this.m10-e.m10,this.m11=this.m11-e.m11,this.m12=this.m12-e.m12,this.m13=this.m13-e.m13,this.m14=this.m14-e.m14,this.m15=this.m15-e.m15,this}},{key:"multiply",value:function(e){yn=this.m00,bn=this.m01,En=this.m02,Tn=this.m03,Sn=this.m04,xn=this.m05,An=this.m06,wn=this.m07,Cn=this.m08,Rn=this.m09,kn=this.m10,On=this.m11,In=this.m12,Mn=this.m13,Ln=this.m14,Pn=this.m15;var t=e.m00,i=e.m01,n=e.m02,r=e.m03;return this.m00=t*yn+i*Sn+n*Cn+r*In,this.m01=t*bn+i*xn+n*Rn+r*Mn,this.m02=t*En+i*An+n*kn+r*Ln,this.m03=t*Tn+i*wn+n*On+r*Pn,t=e.m04,i=e.m05,n=e.m06,r=e.m07,this.m04=t*yn+i*Sn+n*Cn+r*In,this.m05=t*bn+i*xn+n*Rn+r*Mn,this.m06=t*En+i*An+n*kn+r*Ln,this.m07=t*Tn+i*wn+n*On+r*Pn,t=e.m08,i=e.m09,n=e.m10,r=e.m11,this.m08=t*yn+i*Sn+n*Cn+r*In,this.m09=t*bn+i*xn+n*Rn+r*Mn,this.m10=t*En+i*An+n*kn+r*Ln,this.m11=t*Tn+i*wn+n*On+r*Pn,t=e.m12,i=e.m13,n=e.m14,r=e.m15,this.m12=t*yn+i*Sn+n*Cn+r*In,this.m13=t*bn+i*xn+n*Rn+r*Mn,this.m14=t*En+i*An+n*kn+r*Ln,this.m15=t*Tn+i*wn+n*On+r*Pn,this}},{key:"multiplyScalar",value:function(e){return this.m00=this.m00*e,this.m01=this.m01*e,this.m02=this.m02*e,this.m03=this.m03*e,this.m04=this.m04*e,this.m05=this.m05*e,this.m06=this.m06*e,this.m07=this.m07*e,this.m08=this.m08*e,this.m09=this.m09*e,this.m10=this.m10*e,this.m11=this.m11*e,this.m12=this.m12*e,this.m13=this.m13*e,this.m14=this.m14*e,this.m15=this.m15*e,this}},{key:"translate",value:function(e){return console.warn("function changed"),this.m12+=e.x,this.m13+=e.y,this.m14+=e.y,this}},{key:"scale",value:function(e){var t=e.x,i=e.y,n=e.z;return this.m00=this.m00*t,this.m01=this.m01*t,this.m02=this.m02*t,this.m03=this.m03*t,this.m04=this.m04*i,this.m05=this.m05*i,this.m06=this.m06*i,this.m07=this.m07*i,this.m08=this.m08*n,this.m09=this.m09*n,this.m10=this.m10*n,this.m11=this.m11*n,this.m12=this.m12,this.m13=this.m13,this.m14=this.m14,this.m15=this.m15,this}},{key:"rotate",value:function(e,t){var i=t.x,n=t.y,r=t.z,a=Math.sqrt(i*i+n*n+r*r);if(Math.abs(a)<ci)return null;i*=a=1/a,n*=a,r*=a;var s=Math.sin(e),o=Math.cos(e),l=1-o;yn=this.m00,bn=this.m01,En=this.m02,Tn=this.m03,Sn=this.m04,xn=this.m05,An=this.m06,wn=this.m07,Cn=this.m08,Rn=this.m09,kn=this.m10,On=this.m11;var u=i*i*l+o,c=n*i*l+r*s,h=r*i*l-n*s,f=i*n*l-r*s,_=n*n*l+o,d=r*n*l+i*s,p=i*r*l+n*s,m=n*r*l-i*s,v=r*r*l+o;return this.m00=yn*u+Sn*c+Cn*h,this.m01=bn*u+xn*c+Rn*h,this.m02=En*u+An*c+kn*h,this.m03=Tn*u+wn*c+On*h,this.m04=yn*f+Sn*_+Cn*d,this.m05=bn*f+xn*_+Rn*d,this.m06=En*f+An*_+kn*d,this.m07=Tn*f+wn*_+On*d,this.m08=yn*p+Sn*m+Cn*v,this.m09=bn*p+xn*m+Rn*v,this.m10=En*p+An*m+kn*v,this.m11=Tn*p+wn*m+On*v,this}},{key:"getTranslation",value:function(e){return e.x=this.m12,e.y=this.m13,e.z=this.m14,e}},{key:"getScale",value:function(e){var t=Fn.m00=this.m00,i=Fn.m01=this.m01,n=Fn.m02=this.m02,r=Fn.m03=this.m04,a=Fn.m04=this.m05,s=Fn.m05=this.m06,o=Fn.m06=this.m08,l=Fn.m07=this.m09,u=Fn.m08=this.m10;return e.x=Math.sqrt(t*t+i*i+n*n),e.y=Math.sqrt(r*r+a*a+s*s),e.z=Math.sqrt(o*o+l*l+u*u),an.determinant(Fn)<0&&(e.x*=-1),e}},{key:"getRotation",value:function(e){var t=this.m00+this.m05+this.m10,i=0;return t>0?(i=2*Math.sqrt(t+1),e.w=.25*i,e.x=(this.m06-this.m09)/i,e.y=(this.m08-this.m02)/i,e.z=(this.m01-this.m04)/i):this.m00>this.m05&&this.m00>this.m10?(i=2*Math.sqrt(1+this.m00-this.m05-this.m10),e.w=(this.m06-this.m09)/i,e.x=.25*i,e.y=(this.m01+this.m04)/i,e.z=(this.m08+this.m02)/i):this.m05>this.m10?(i=2*Math.sqrt(1+this.m05-this.m00-this.m10),e.w=(this.m08-this.m02)/i,e.x=(this.m01+this.m04)/i,e.y=.25*i,e.z=(this.m06+this.m09)/i):(i=2*Math.sqrt(1+this.m10-this.m00-this.m05),e.w=(this.m01-this.m04)/i,e.x=(this.m08+this.m02)/i,e.y=(this.m06+this.m09)/i,e.z=.25*i),e}},{key:"fromRTS",value:function(e,t,i){var n=e.x,r=e.y,a=e.z,s=e.w,o=n+n,l=r+r,u=a+a,c=n*o,h=n*l,f=n*u,_=r*l,d=r*u,p=a*u,m=s*o,v=s*l,g=s*u,y=i.x,b=i.y,E=i.z;return this.m00=(1-(_+p))*y,this.m01=(h+g)*y,this.m02=(f-v)*y,this.m03=0,this.m04=(h-g)*b,this.m05=(1-(c+p))*b,this.m06=(d+m)*b,this.m07=0,this.m08=(f+v)*E,this.m09=(d-m)*E,this.m10=(1-(c+_))*E,this.m11=0,this.m12=t.x,this.m13=t.y,this.m14=t.z,this.m15=1,this}},{key:"fromQuat",value:function(e){var t=e.x,i=e.y,n=e.z,r=e.w,a=t+t,s=i+i,o=n+n,l=t*a,u=i*a,c=i*s,h=n*a,f=n*s,_=n*o,d=r*a,p=r*s,m=r*o;return this.m00=1-c-_,this.m01=u+m,this.m02=h-p,this.m03=0,this.m04=u-m,this.m05=1-l-_,this.m06=f+d,this.m07=0,this.m08=h+p,this.m09=f-d,this.m10=1-l-c,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=1,this}}]),n}(mt));Bn.IDENTITY=Object.freeze(new Bn);var Dn=new zi,Fn=new an;function Nn(e,t,i,n,r,a,s,o,l,u,c,h,f,_,d,p){return new Bn(e,t,i,n,r,a,s,o,l,u,c,h,f,_,d,p)}ri.fastDefine("cc.Mat4",Bn,{m00:1,m01:0,m02:0,m03:0,m04:0,m05:1,m06:0,m07:0,m08:0,m09:0,m10:1,m11:0,m12:0,m13:0,m14:0,m15:1}),cc.Mat4=Bn,cc.mat4=Nn;var zn=0,Un=0,Gn=0,Vn=0,Hn=0,Wn=0,jn=e("AffineTransform",function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0;i(this,e),this.a=t,this.b=n,this.c=r,this.d=a,this.tx=s,this.ty=o}return r(e,null,[{key:"identity",value:function(){return new e}},{key:"clone",value:function(t){return new e(t.a,t.b,t.c,t.d,t.tx,t.ty)}},{key:"concat",value:function(e,t,i){zn=t.a,Un=t.b,Gn=t.c,Vn=t.d,Hn=t.tx,Wn=t.ty,e.a=zn*i.a+Un*i.c,e.b=zn*i.b+Un*i.d,e.c=Gn*i.a+Vn*i.c,e.d=Gn*i.b+Vn*i.d,e.tx=Hn*i.a+Wn*i.c+i.tx,e.ty=Hn*i.b+Wn*i.d+i.ty}},{key:"invert",value:function(e,t){var i=1/(t.a*t.d-t.b*t.c);e.a=i*t.d,e.b=-i*t.b,e.c=-i*t.c,e.d=i*t.a,e.tx=i*(t.c*t.ty-t.d*t.tx),e.ty=i*(t.b*t.tx-t.a*t.ty)}},{key:"fromMat4",value:function(e,t){e.a=t.m00,e.b=t.m01,e.c=t.m04,e.d=t.m05,e.tx=t.m12,e.ty=t.m13}},{key:"transformVec2",value:function(e,t,i,n){var r,a;void 0===n?(n=i,r=t.x,a=t.y):(r=t,a=i),e.x=n.a*r+n.c*a+n.tx,e.y=n.b*r+n.d*a+n.ty}},{key:"transformSize",value:function(e,t,i){e.width=i.a*t.width+i.c*t.height,e.height=i.b*t.width+i.d*t.height}},{key:"transformRect",value:function(e,t,i){var n=t.x+t.width,r=t.y+t.height,a=i.a*t.x+i.c*t.y+i.tx,s=i.b*t.x+i.d*t.y+i.ty,o=i.a*n+i.c*t.y+i.tx,l=i.b*n+i.d*t.y+i.ty,u=i.a*t.x+i.c*r+i.tx,c=i.b*t.x+i.d*r+i.ty,h=i.a*n+i.c*r+i.tx,f=i.b*n+i.d*r+i.ty,_=Math.min(a,o,u,h),d=Math.max(a,o,u,h),p=Math.min(s,l,c,f),m=Math.max(s,l,c,f);e.x=_,e.y=p,e.width=d-_,e.height=m-p}},{key:"transformObb",value:function(e,t,i,n,r,a){var s=a.a*r.x+a.c*r.y+a.tx,o=a.b*r.x+a.d*r.y+a.ty,l=a.a*r.width,u=a.b*r.width,c=a.c*r.height,h=a.d*r.height;t.x=s,t.y=o,i.x=l+s,i.y=u+o,e.x=c+s,e.y=h+o,n.x=l+c+s,n.y=u+h+o}}]),e}());cc.AffineTransform=jn;var Xn=e("Size",function(e){function n(e,r){var a;return i(this,n),a=c(this,o(n).call(this)),e&&"object"===t(e)?(a.height=e.height,a.width=e.width):(a.width=e||0,a.height=r||0),a}return s(n,e),r(n,[{key:"x",set:function(e){this.width=e},get:function(){return this.width}},{key:"y",set:function(e){this.height=e},get:function(){return this.height}}],[{key:"lerp",value:function(e,t,i,n){return e.width=t.width+(i.width-t.width)*n,e.height=t.height+(i.height-t.height)*n,e}},{key:"ZERO",get:function(){return new n(0,0)}}]),r(n,[{key:"clone",value:function(){return new n(this.width,this.height)}},{key:"set",value:function(e,i){return e&&"object"===t(e)?(this.height=e.height,this.width=e.width):(this.width=e||0,this.height=i||0),this}},{key:"equals",value:function(e){return this.width===e.width&&this.height===e.height}},{key:"lerp",value:function(e,t){return this.width=this.width+(e.width-this.width)*t,this.height=this.height+(e.height-this.height)*t,this}},{key:"toString",value:function(){return"(".concat(this.width.toFixed(2),", ").concat(this.height.toFixed(2),")")}}]),n}(mt));function qn(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return new Xn(e,t)}ri.fastDefine("cc.Size",Xn,{width:0,height:0}),cc.size=qn,cc.Size=Xn;var Yn=0,Kn=0,Zn=0,Qn=0,Jn=e("Rect",function(e){function n(e,r,a,s){var l;return i(this,n),l=c(this,o(n).call(this)),e&&"object"===t(e)?(l.y=e.y,l.width=e.width,l.height=e.height,l.x=e.x):(l.x=e||0,l.y=r||0,l.width=a||0,l.height=s||0),l}return s(n,e),r(n,[{key:"xMin",get:function(){return this.x},set:function(e){this.width+=this.x-e,this.x=e}},{key:"yMin",get:function(){return this.y},set:function(e){this.height+=this.y-e,this.y=e}},{key:"xMax",get:function(){return this.x+this.width},set:function(e){this.width=e-this.x}},{key:"yMax",get:function(){return this.y+this.height},set:function(e){this.height=e-this.y}},{key:"center",get:function(){return new Mi(this.x+.5*this.width,this.y+.5*this.height)},set:function(e){this.x=e.x-.5*this.width,this.y=e.y-.5*this.height}},{key:"origin",get:function(){return new cc.Vec2(this.x,this.y)},set:function(e){this.x=e.x,this.y=e.y}},{key:"size",get:function(){return new Xn(this.width,this.height)},set:function(e){this.width=e.width,this.height=e.height}},{key:"z",set:function(e){this.width=e},get:function(){return this.width}},{key:"w",set:function(e){this.height=e},get:function(){return this.height}}],[{key:"fromMinMax",value:function(e,t,i){var n=Math.min(t.x,i.x),r=Math.min(t.y,i.y),a=Math.max(t.x,i.x),s=Math.max(t.y,i.y);return e.x=n,e.y=r,e.width=a-n,e.height=s-r,e}},{key:"lerp",value:function(e,t,i,n){return Yn=t.x,Kn=t.y,Zn=t.width,Qn=t.height,e.x=Yn+(i.x-Yn)*n,e.y=Kn+(i.y-Kn)*n,e.width=Zn+(i.width-Zn)*n,e.height=Qn+(i.height-Qn)*n,e}},{key:"intersection",value:function(e,t,i){var n=t.x,r=t.y,a=t.x+t.width,s=t.y+t.height,o=i.x,l=i.y,u=i.x+i.width,c=i.y+i.height;return e.x=Math.max(n,o),e.y=Math.max(r,l),e.width=Math.min(a,u)-e.x,e.height=Math.min(s,c)-e.y,e}},{key:"union",value:function(e,t,i){Yn=t.x,Kn=t.y,Zn=t.width,Qn=t.height;var n=i.x,r=i.y,a=i.width,s=i.height;return e.x=Math.min(Yn,n),e.y=Math.min(Kn,r),e.width=Math.max(Yn+Zn,n+a)-e.x,e.height=Math.max(Kn+Qn,r+s)-e.y,e}}]),r(n,[{key:"clone",value:function(){return new n(this.x,this.y,this.width,this.height)}},{key:"set",value:function(e,i,n,r){return e&&"object"===t(e)?(this.y=e.y,this.width=e.width,this.height=e.height,this.x=e.x):(this.x=e||0,this.y=i||0,this.width=n||0,this.height=r||0),this}},{key:"equals",value:function(e){return this.x===e.x&&this.y===e.y&&this.width===e.width&&this.height===e.height}},{key:"lerp",value:function(e,t){return Yn=this.x,Kn=this.y,Zn=this.width,Qn=this.height,this.x=Yn+(e.x-Yn)*t,this.y=Kn+(e.y-Kn)*t,this.width=Zn+(e.width-Zn)*t,this.height=Qn+(e.height-Qn)*t,this}},{key:"toString",value:function(){return"(".concat(this.x.toFixed(2),", ").concat(this.y.toFixed(2),", ").concat(this.width.toFixed(2),", ").concat(this.height.toFixed(2),")")}},{key:"intersects",value:function(e){var t=this.x+this.width,i=this.y+this.height,n=e.x+e.width,r=e.y+e.height;return!(t<e.x||n<this.x||i<e.y||r<this.y)}},{key:"contains",value:function(e){return this.x<=e.x&&this.x+this.width>=e.x&&this.y<=e.y&&this.y+this.height>=e.y}},{key:"containsRect",value:function(e){return this.x<=e.x&&this.x+this.width>=e.x+e.width&&this.y<=e.y&&this.y+this.height>=e.y+e.height}},{key:"transformMat4",value:function(e){var t=this.x,i=this.y,n=t+this.width,r=i+this.height,a=e.m00*t+e.m04*i+e.m12,s=e.m01*t+e.m05*i+e.m13,o=e.m00*n+e.m04*i+e.m12,l=e.m01*n+e.m05*i+e.m13,u=e.m00*t+e.m04*r+e.m12,c=e.m01*t+e.m05*r+e.m13,h=e.m00*n+e.m04*r+e.m12,f=e.m01*n+e.m05*r+e.m13,_=Math.min(a,o,u,h),d=Math.max(a,o,u,h),p=Math.min(s,l,c,f),m=Math.max(s,l,c,f);return this.x=_,this.y=p,this.width=d-_,this.height=m-p,this}}]),n}(mt));function $n(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;return new Jn(e,t,i,n)}ri.fastDefine("cc.Rect",Jn,{x:0,y:0,width:0,height:0}),cc.Rect=Jn,cc.rect=$n;var er=0,tr=0,ir=0,nr=0,rr=e("Color",function(e){function n(e,r,a,s){var l;return i(this,n),(l=c(this,o(n).call(this)))._val=0,"string"==typeof e?l.fromHEX(e):("object"===t(e)&&(r=e.g,a=e.b,s=e.a,e=e.r),e=e||0,r=r||0,a=a||0,s="number"==typeof s?s:255,l._val=(s<<24>>>0)+(a<<16)+(r<<8)+e),l}return s(n,e),r(n,[{key:"r",get:function(){return 255&this._val},set:function(e){e=~~_i(e,0,255),this._val=(4294967040&this._val|e)>>>0}},{key:"g",get:function(){return(65280&this._val)>>8},set:function(e){e=~~_i(e,0,255),this._val=(4294902015&this._val|e<<8)>>>0}},{key:"b",get:function(){return(16711680&this._val)>>16},set:function(e){e=~~_i(e,0,255),this._val=(4278255615&this._val|e<<16)>>>0}},{key:"a",get:function(){return(4278190080&this._val)>>>24},set:function(e){e=~~_i(e,0,255),this._val=(16777215&this._val|e<<24>>>0)>>>0}},{key:"x",get:function(){return this.r*(1/255)},set:function(e){this.r=255*e}},{key:"y",get:function(){return this.g*(1/255)},set:function(e){this.g=255*e}},{key:"z",get:function(){return this.b*(1/255)},set:function(e){this.b=255*e}},{key:"w",get:function(){return this.a*(1/255)},set:function(e){this.a=255*e}}],[{key:"clone",value:function(e){var t=new n;return e._val?t._val=e._val:t._val=(e.a<<24>>>0)+(e.b<<16)+(e.g<<8)+e.r,t}},{key:"copy",value:function(e,t){return e.r=t.r,e.g=t.g,e.b=t.b,e.a=t.a,e}},{key:"set",value:function(e,t,i,n,r){return e.r=t,e.g=i,e.b=n,e.a=r,e}},{key:"fromHEX",value:function(e,t){return t=0===t.indexOf("#")?t.substring(1):t,e.r=parseInt(t.substr(0,2),16)||0,e.g=parseInt(t.substr(2,2),16)||0,e.b=parseInt(t.substr(4,2),16)||0,e.a=parseInt(t.substr(6,2),16)||255,e._val=(e.a<<24>>>0)+(e.b<<16)+(e.g<<8)+e.r,e}},{key:"add",value:function(e,t,i){return e.r=t.r+i.r,e.g=t.g+i.g,e.b=t.b+i.b,e.a=t.a+i.a,e}},{key:"subtract",value:function(e,t,i){return e.r=t.r-i.r,e.g=t.g-i.g,e.b=t.b-i.b,e.a=t.a-i.a,e}},{key:"multiply",value:function(e,t,i){return e.r=t.r*i.r,e.g=t.g*i.g,e.b=t.b*i.b,e.a=t.a*i.a,e}},{key:"divide",value:function(e,t,i){return e.r=t.r/i.r,e.g=t.g/i.g,e.b=t.b/i.b,e.a=t.a/i.a,e}},{key:"scale",value:function(e,t,i){return e.r=t.r*i,e.g=t.g*i,e.b=t.b*i,e.a=t.a*i,e}},{key:"lerp",value:function(e,t,i,n){return er=t.r,tr=t.g,ir=t.b,nr=t.a,er+=(i.r-er)*n,tr+=(i.g-tr)*n,ir+=(i.b-ir)*n,nr+=(i.a-nr)*n,e._val=Math.floor((nr<<24>>>0)+(ir<<16)+(tr<<8)+er),e}},{key:"toArray",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=t instanceof n||t.a>1?1/255:1;return e[i+0]=t.r*r,e[i+1]=t.g*r,e[i+2]=t.b*r,e[i+3]=t.a*r,e}},{key:"fromArray",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return t.r=255*e[i+0],t.g=255*e[i+1],t.b=255*e[i+2],t.a=255*e[i+3],t}},{key:"strictEquals",value:function(e,t){return e.r===t.r&&e.g===t.g&&e.b===t.b&&e.a===t.a}},{key:"equals",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:ci;return Math.abs(e.r-t.r)<=i*Math.max(1,Math.abs(e.r),Math.abs(t.r))&&Math.abs(e.g-t.g)<=i*Math.max(1,Math.abs(e.g),Math.abs(t.g))&&Math.abs(e.b-t.b)<=i*Math.max(1,Math.abs(e.b),Math.abs(t.b))&&Math.abs(e.a-t.a)<=i*Math.max(1,Math.abs(e.a),Math.abs(t.a))}},{key:"hex",value:function(e){return(255*e.r<<24|255*e.g<<16|255*e.b<<8|255*e.a)>>>0}}]),r(n,[{key:"clone",value:function(){var e=new n;return e._val=this._val,e}},{key:"equals",value:function(e){return e&&this._val===e._val}},{key:"lerp",value:function(e,t){return er=this.r,tr=this.g,ir=this.b,nr=this.a,er+=(e.r-er)*t,tr+=(e.g-tr)*t,ir+=(e.b-ir)*t,nr+=(e.a-nr)*t,this._val=Math.floor((nr<<24>>>0)+(ir<<16)+(tr<<8)+er),this}},{key:"toString",value:function(){return"rgba("+this.r.toFixed()+", "+this.g.toFixed()+", "+this.b.toFixed()+", "+this.a.toFixed()+")"}},{key:"toCSS",value:function(e){return"rgba"===e?"rgba("+(0|this.r)+","+(0|this.g)+","+(0|this.b)+","+(this.a*(1/255)).toFixed(2)+")":"rgb"===e?"rgb("+(0|this.r)+","+(0|this.g)+","+(0|this.b)+")":"#"+this.toHEX(e)}},{key:"fromHEX",value:function(e){return e=0===e.indexOf("#")?e.substring(1):e,er=parseInt(e.substr(0,2),16)||0,tr=parseInt(e.substr(2,2),16)||0,ir=parseInt(e.substr(4,2),16)||0,nr=parseInt(e.substr(6,2),16)||255,this._val=(nr<<24>>>0)+(ir<<16)+(tr<<8)+er,this}},{key:"toHEX",value:function(e){var t=[(0|this.r).toString(16),(0|this.g).toString(16),(0|this.b).toString(16)],i=-1;if("#rrggbb"===e)for(i=0;i<t.length;++i)1===t[i].length&&(t[i]="0"+t[i]);else if("#rrggbbaa"===e)for(t.push((0|this.a).toString(16)),i=0;i<t.length;++i)1===t[i].length&&(t[i]="0"+t[i]);return t.join("")}},{key:"toRGBValue",value:function(){return 16777215&this._val}},{key:"fromHSV",value:function(e,t,i){if(er=0,tr=0,ir=0,0===t)er=tr=ir=i;else if(0===i)er=tr=ir=0;else{1===e&&(e=0),e*=6,t=t,i=i;var n=Math.floor(e),r=e-n,a=i*(1-t),s=i*(1-t*r),o=i*(1-t*(1-r));switch(n){case 0:er=i,tr=o,ir=a;break;case 1:er=s,tr=i,ir=a;break;case 2:er=a,tr=i,ir=o;break;case 3:er=a,tr=s,ir=i;break;case 4:er=o,tr=a,ir=i;break;case 5:er=i,tr=a,ir=s}}return er*=255,tr*=255,ir*=255,this._val=(this.a<<24>>>0)+(ir<<16)+(tr<<8)+er,this}},{key:"toHSV",value:function(){er=this.r*(1/255),tr=this.g*(1/255),ir=this.b*(1/255);var e={h:0,s:0,v:0},t=Math.max(er,tr,ir),i=Math.min(er,tr,ir),n=0;return e.v=t,e.s=t?(t-i)/t:0,e.s?(n=t-i,e.h=er===t?(tr-ir)/n:tr===t?2+(ir-er)/n:4+(er-tr)/n,e.h/=6,e.h<0&&(e.h+=1)):e.h=0,e}},{key:"set",value:function(e,i,n,r){return"object"===t(e)&&(i=e.g,n=e.b,r=e.a,e=e.r),e=e||0,i=i||0,n=n||0,r="number"==typeof r?r:255,this._val=(r<<24>>>0)+(n<<16)+(i<<8)+e,this}},{key:"multiply",value:function(e){return er=(255&this._val)*e.r>>8,tr=(65280&this._val)*e.g>>8,ir=(16711680&this._val)*e.b>>8,nr=((4278190080&this._val)>>>8)*e.a,this._val=4278190080&nr|16711680&ir|65280&tr|255&er,this}},{key:"_set_r_unsafe",value:function(e){return this._val=(4294967040&this._val|e)>>>0,this}},{key:"_set_g_unsafe",value:function(e){return this._val=(4294902015&this._val|e<<8)>>>0,this}},{key:"_set_b_unsafe",value:function(e){return this._val=(4278255615&this._val|e<<16)>>>0,this}},{key:"_set_a_unsafe",value:function(e){return this._val=(16777215&this._val|e<<24>>>0)>>>0,this}}]),n}(mt));function ar(e,t,i,n){return new rr(e,t,i,n)}rr.WHITE=Object.freeze(new rr(255,255,255,255)),rr.GRAY=Object.freeze(new rr(127,127,127,255)),rr.BLACK=Object.freeze(new rr(0,0,0,255)),rr.TRANSPARENT=Object.freeze(new rr(0,0,0,0)),rr.RED=Object.freeze(new rr(255,0,0,255)),rr.GREEN=Object.freeze(new rr(0,255,0,255)),rr.BLUE=Object.freeze(new rr(0,0,255,255)),rr.CYAN=Object.freeze(new rr(0,255,255,255)),rr.MAGENTA=Object.freeze(new rr(255,0,255,255)),rr.YELLOW=Object.freeze(new rr(255,255,0,255)),ri.fastDefine("cc.Color",rr,{r:0,g:0,b:0,a:255}),cc.Color=rr,cc.color=ar;var sr,or,lr,ur,cr,hr=10;var fr=0,_r=new Map;lr=function(e,t,i,n,r,a){var s=_r.get(a);s&&s.logTimes>s.count&&(r("'%s' is deprecated, please use '%s' instead.","".concat(e,".").concat(t),"".concat(i,".").concat(n)),s.count++)},sr=e("replaceProperty",(function(e,t,i){null!=e&&i.forEach((function(i){var n=fr++;_r.set(n,{id:n,count:0,logTimes:void 0!==i.logTimes?i.logTimes:hr});var r=null!=i.target?i.target:e,a=null!=i.newName?i.newName:i.name,s=null!=i.targetName?i.targetName:t;if(null!=i.customFunction)e[i.name]=function(){return lr(t,i.name,s,a,k,n),i.customFunction.call(this,arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1],arguments.length<=2?void 0:arguments[2],arguments.length<=3?void 0:arguments[3],arguments.length<=4?void 0:arguments[4],arguments.length<=5?void 0:arguments[5],arguments.length<=6?void 0:arguments[6],arguments.length<=7?void 0:arguments[7],arguments.length<=8?void 0:arguments[8],arguments.length<=9?void 0:arguments[9],arguments.length<=10?void 0:arguments[10],arguments.length<=11?void 0:arguments[11])};else if(null!=i.customSetter||null!=i.customGetter){var o=null!=i.customSetter,l=null!=i.customGetter;o&&l?Object.defineProperty(e,i.name,{get:function(){return lr(t,i.name,s,a,k,n),i.customGetter.call(this)},set:function(e){lr(t,i.name,s,a,k,n),i.customSetter.call(this,e)}}):o?Object.defineProperty(e,i.name,{set:function(e){lr(t,i.name,s,a,k,n),i.customSetter.call(this,e)}}):l&&Object.defineProperty(e,i.name,{get:function(){return lr(t,i.name,s,a,k,n),i.customGetter.call(this)}})}else Object.defineProperty(e,i.name,{get:function(){return lr(t,i.name,s,a,k,n),r[a]},set:function(e){lr(t,i.name,s,a,k,n),r[a]=e}})}))})),cr=function(e,t,i,n){var r=_r.get(n);r&&r.logTimes>r.count&&(i("'%s' has been removed.","".concat(e,".").concat(t)),r.count++)},or=e("removeProperty",(function(e,t,i){null!=e&&i.forEach((function(i){var n=fr++;_r.set(n,{id:n,count:0,logTimes:void 0!==i.logTimes?i.logTimes:hr}),Object.defineProperty(e,i.name,{get:function(){return cr(t,i.name,O,n)},set:function(){cr(t,i.name,O,n)}})}))})),ur=function(e,t,i,n){var r=_r.get(n);r&&r.logTimes>r.count&&(i("'%s' is deprecated.","".concat(e,".").concat(t)),r.count++)},e("markAsWarning",(function(e,t,i){if(null!=e){var n=function(e,t,i,n,r,a,s){if(i.get){var o=i.get();i.get=function(){return ur(n,r,a,s),o.call(this)}}if(i.set){var l=Object.create(i.set);i.set=function(e){ur(n,r,a,s),l.call(this,e)}}};i.forEach((function(i){var r=i.name,a=Object.getOwnPropertyDescriptor(e,r);if(a){var s=fr++;if(_r.set(s,{id:s,count:0,logTimes:void 0!==i.logTimes?i.logTimes:hr}),null!=a.value)if("function"==typeof a.value){var o=a.value;e[r]=function(){return ur(t,r,k,s),o.call(this)}}else n(0,0,a,t,r,k,s);else n(0,0,a,t,r,k,s)}}))}})),sr(Mi,"Vec2",[{name:"sub",newName:"subtract",target:Mi,targetName:"Vec2"},{name:"mul",newName:"multiply",target:Mi,targetName:"Vec2"},{name:"div",newName:"divide",target:Mi,targetName:"Vec2"},{name:"dist",newName:"distance",target:Mi,targetName:"Vec2"},{name:"sqrDist",newName:"squaredDistance",target:Mi,targetName:"Vec2"},{name:"mag",newName:"len",target:Mi,targetName:"Vec2"},{name:"sqrMag",newName:"lengthSqr",target:Mi,targetName:"Vec2"},{name:"scale",newName:"multiplyScalar",target:Mi,targetName:"Vec2"},{name:"exactEquals",newName:"strictEquals",target:Mi,targetName:"Vec2"}]),sr(Mi.prototype,"Vec2",[{name:"mag",newName:"length",target:Mi.prototype,targetName:"Vec2"},{name:"magSqr",newName:"lengthSqr",target:Mi.prototype,targetName:"Vec2"},{name:"scale",newName:"multiplyScalar",target:Mi.prototype,targetName:"Vec2"},{name:"exactEquals",newName:"strictEquals",target:Mi.prototype,targetName:"Vec2"}]),or(Mi.prototype,"vmath",[{name:"divide"}]),sr(zi,"Vec3",[{name:"sub",newName:"subtract",target:zi,targetName:"Vec3"},{name:"mul",newName:"multiply",target:zi,targetName:"Vec3"},{name:"div",newName:"divide",target:zi,targetName:"Vec3"},{name:"dist",newName:"distance",target:zi,targetName:"Vec3"},{name:"sqrDist",newName:"squaredDistance",target:zi,targetName:"Vec3"},{name:"mag",newName:"len",target:zi,targetName:"Vec3"},{name:"sqrMag",newName:"lengthSqr",target:zi,targetName:"Vec3"},{name:"scale",newName:"multiplyScalar",target:zi,targetName:"Vec3"},{name:"exactEquals",newName:"strictEquals",target:zi,targetName:"Vec3"}]),sr(zi.prototype,"Vec3",[{name:"mag",newName:"length",target:zi.prototype,targetName:"Vec3"},{name:"magSqr",newName:"lengthSqr",target:zi.prototype,targetName:"Vec3"},{name:"scale",newName:"multiplyScalar",target:zi.prototype,targetName:"Vec3"},{name:"exactEquals",newName:"strictEquals",target:zi.prototype,targetName:"Vec3"}]),or(zi.prototype,"vmath",[{name:"divide"}]),sr(qi,"Vec4",[{name:"sub",newName:"subtract",target:qi,targetName:"Vec4"},{name:"mul",newName:"multiply",target:qi,targetName:"Vec4"},{name:"div",newName:"divide",target:qi,targetName:"Vec4"},{name:"dist",newName:"distance",target:qi,targetName:"Vec4"},{name:"sqrDist",newName:"squaredDistance",target:qi,targetName:"Vec4"},{name:"mag",newName:"len",target:qi,targetName:"Vec4"},{name:"sqrMag",newName:"lengthSqr",target:qi,targetName:"Vec4"},{name:"scale",newName:"multiplyScalar",target:qi,targetName:"Vec4"},{name:"exactEquals",newName:"strictEquals",target:qi,targetName:"Vec4"}]),sr(qi.prototype,"Vec4",[{name:"mag",newName:"length",target:qi.prototype,targetName:"Vec4"},{name:"magSqr",newName:"lengthSqr",target:qi.prototype,targetName:"Vec4"},{name:"scale",newName:"multiplyScalar",target:qi.prototype,targetName:"Vec4"},{name:"exactEquals",newName:"strictEquals",target:qi.prototype,targetName:"Vec4"}]),or(qi.prototype,"vmath",[{name:"divide"}]),sr(fn,"Quat",[{name:"mag",newName:"len",target:fn,targetName:"Quat"},{name:"mul",newName:"multiply",target:fn,targetName:"Quat"},{name:"sqrMag",newName:"lengthSqr",target:fn,targetName:"Quat"},{name:"scale",newName:"multiplyScalar",target:fn,targetName:"Quat"},{name:"exactEquals",newName:"strictEquals",target:fn,targetName:"Quat"}]),sr(fn.prototype,"Quat",[{name:"scale",newName:"multiplyScalar",target:fn.prototype,targetName:"Quat"},{name:"exactEquals",newName:"strictEquals",target:fn.prototype,targetName:"Quat"}]),sr(rr,"Color",[{name:"sub",newName:"subtract",target:rr,targetName:"Color"},{name:"mul",newName:"multiply",target:rr,targetName:"Color"},{name:"div",newName:"divide",target:rr,targetName:"Color"},{name:"exactEquals",newName:"strictEquals",target:rr,targetName:"Color"},{name:"fromHex",newName:"fromHEX",customFunction:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];var n=t[1].toString(16);return cc.Color.fromHEX(t[0],n)}}]),sr(an,"Mat3",[{name:"sub",newName:"subtract",target:an,targetName:"Mat3"},{name:"mul",newName:"multiply",target:an,targetName:"Mat3"},{name:"exactEquals",newName:"strictEquals",target:an,targetName:"Mat3"}]),sr(an.prototype,"Mat3",[{name:"sub",newName:"subtract",target:an.prototype,targetName:"Mat3"},{name:"mul",newName:"multiply",target:an.prototype,targetName:"Mat3"},{name:"mulScalar",newName:"multiplyScalar",target:an.prototype,targetName:"Mat3"},{name:"exactEquals",newName:"strictEquals",target:an.prototype,targetName:"Mat3"}]),sr(Bn,"Mat4",[{name:"sub",newName:"subtract",target:Bn,targetName:"Mat4"},{name:"mul",newName:"multiply",target:Bn,targetName:"Mat4"},{name:"exactEquals",newName:"strictEquals",target:Bn,targetName:"Mat4"}]),sr(Bn.prototype,"Mat4",[{name:"sub",newName:"subtract",target:Bn.prototype,targetName:"Mat4"},{name:"mul",newName:"multiply",target:Bn.prototype,targetName:"Mat4"},{name:"mulScalar",newName:"multiplyScalar",target:Bn.prototype,targetName:"Mat4"},{name:"exactEquals",newName:"strictEquals",target:Bn.prototype,targetName:"Mat4"}]);var dr=Object.freeze({__proto__:null,bits:he,Vec2:Mi,v2:Bi,Vec3:zi,v3:Vi,Vec4:qi,v4:Yi,Quat:fn,quat:gn,Mat3:an,Mat4:Bn,mat4:Nn,AffineTransform:jn,Size:Xn,size:qn,Rect:Jn,rect:$n,Color:rr,color:ar,EPSILON:ci,equals:hi,approx:fi,clamp:_i,clamp01:di,lerp:pi,toRadian:mi,toDegree:vi,random:gi,randomRange:yi,randomRangeInt:bi,pseudoRandom:Ei,pseudoRandomRange:Ti,pseudoRandomRangeInt:Si,nextPow2:xi,repeat:Ai,pingPong:wi,inverseLerp:Ci,absMaxComponent:Ri,absMax:ki});e("math",dr);var pr=new zi,mr=new zi,vr=new zi,gr=new zi,yr=new zi,br=new zi,Er=new Array(3),Tr=new Array(3);function Sr(e,t){return zi.dot(t.n,e)-t.d}function xr(e,t,i){return zi.copy(e,t),zi.subtract(yr,i.center,i.halfExtents),zi.add(br,i.center,i.halfExtents),e.x=e.x<yr.x?yr.x:e.x,e.y=e.y<yr.x?yr.y:e.y,e.z=e.z<yr.x?yr.z:e.z,e.x=e.x>br.x?br.x:e.x,e.y=e.y>br.x?br.y:e.y,e.z=e.z>br.x?br.z:e.z,e}function Ar(e,t,i){zi.set(pr,i.orientation.m00,i.orientation.m01,i.orientation.m02),zi.set(mr,i.orientation.m03,i.orientation.m04,i.orientation.m05),zi.set(vr,i.orientation.m06,i.orientation.m07,i.orientation.m08),Er[0]=pr,Er[1]=mr,Er[2]=vr,Tr[0]=i.halfExtents.x,Tr[1]=i.halfExtents.y,Tr[2]=i.halfExtents.z,zi.subtract(gr,t,i.center),zi.set(e,i.center.x,i.center.y,i.center.z);for(var n=0;n<3;n++){var r=zi.dot(gr,Er[n]);r>Tr[n]&&(r=Tr[n]),r<-Tr[n]&&(r=-Tr[n]),e.x+=r*Er[n].x,e.y+=r*Er[n].y,e.z+=r*Er[n].z}return e}var wr=Object.freeze({__proto__:null,point_plane:Sr,pt_point_plane:function(e,t,i){var n=Sr(t,i);return zi.subtract(e,t,zi.multiplyScalar(e,i.n,n))},pt_point_aabb:xr,pt_point_obb:Ar,pt_point_line:function(e,t,i,n){zi.subtract(pr,i,n);var r=pr,a=zi.lengthSqr(r);if(0==a)zi.copy(e,i);else{zi.subtract(pr,t,i);var s=zi.dot(pr,r)/a;s<0?zi.copy(e,i):s>1?zi.copy(e,n):zi.scaleAndAdd(e,i,r,s)}}}),Cr=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:-1;i(this,e),this._type=oe.SHAPE_RAY,this.o=new zi(t,n,r),this.d=new zi(a,s,o)}return r(e,null,[{key:"create",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1;return new e(t,i,n,r,a,s)}},{key:"clone",value:function(t){return new e(t.o.x,t.o.y,t.o.z,t.d.x,t.d.y,t.d.z)}},{key:"copy",value:function(e,t){return zi.copy(e.o,t.o),zi.copy(e.d,t.d),e}},{key:"fromPoints",value:function(e,t,i){return zi.copy(e.o,t),zi.normalize(e.d,zi.subtract(e.d,i,t)),e}},{key:"set",value:function(e,t,i,n,r,a,s){return e.o.x=t,e.o.y=i,e.o.z=n,e.d.x=r,e.d.y=a,e.d.z=s,e}}]),r(e,[{key:"computeHit",value:function(e,t){zi.normalize(e,this.d),zi.scaleAndAdd(e,this.o,e,t)}}]),e}(),Rr=new zi;function kr(e){return Math.max(Math.max(e.x,e.y),e.z)}var Or,Ir,Mr,Lr,Pr,Br,Dr=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;i(this,e),this._type=oe.SHAPE_SPHERE,this.center=new zi(t,n,r),this.radius=a}return r(e,null,[{key:"create",value:function(t,i,n,r){return new e(t,i,n,r)}},{key:"clone",value:function(t){return new e(t.center.x,t.center.y,t.center.z,t.radius)}},{key:"copy",value:function(e,t){return zi.copy(e.center,t.center),e.radius=t.radius,e}},{key:"fromPoints",value:function(e,t,i){return zi.multiplyScalar(e.center,zi.add(Rr,t,i),.5),e.radius=.5*zi.subtract(Rr,i,t).length(),e}},{key:"set",value:function(e,t,i,n,r){return e.center.x=t,e.center.y=i,e.center.z=n,e.radius=r,e}}]),r(e,[{key:"clone",value:function(){return e.clone(this)}},{key:"copy",value:function(t){return e.copy(this,t)}},{key:"getBoundary",value:function(e,t){zi.set(e,this.center.x-this.radius,this.center.y-this.radius,this.center.z-this.radius),zi.set(t,this.center.x+this.radius,this.center.y+this.radius,this.center.z+this.radius)}},{key:"transform",value:function(e,t,i,n,r){zi.transformMat4(r.center,this.center,e),r.radius=this.radius*kr(n)}},{key:"translateAndRotate",value:function(e,t,i){zi.transformMat4(i.center,this.center,e)}},{key:"setScale",value:function(e,t){t.radius=this.radius*kr(e)}}]),e}(),Fr=(Or=new zi(0,0,0),function(e,t){var i=zi.dot(e.d,t.n);if(Math.abs(i)<Number.EPSILON)return 0;zi.multiplyScalar(Or,t.n,t.d);var n=zi.dot(zi.subtract(Or,Or,e.o),t.n)/i;return n<0?0:n}),Nr=(Ir=new zi(0,0,0),Mr=new zi(0,0,0),Lr=new zi(0,0,0),Pr=new zi(0,0,0),Br=new zi(0,0,0),function(e,t,i){zi.subtract(Ir,t.b,t.a),zi.subtract(Mr,t.c,t.a),zi.cross(Lr,e.d,Mr);var n=zi.dot(Ir,Lr);if(n<Number.EPSILON&&(!i||n>-Number.EPSILON))return 0;var r=1/n;zi.subtract(Pr,e.o,t.a);var a=zi.dot(Pr,Lr)*r;if(a<0||a>1)return 0;zi.cross(Br,Pr,Ir);var s=zi.dot(e.d,Br)*r;if(s<0||a+s>1)return 0;var o=zi.dot(Mr,Br)*r;return o<0?0:o}),zr=function(){var e=new zi(0,0,0);return function(t,i){var n=i.radius,r=i.center,a=t.o,s=t.d,o=n*n;zi.subtract(e,r,a);var l=e.lengthSqr(),u=zi.dot(e,s),c=o-(l-u*u);if(c<0)return 0;var h=Math.sqrt(c),f=l<o?u+h:u-h;return f<0?0:f}}(),Ur=function(){var e=new zi,t=new zi;return function(i,n){var r=i.o,a=i.d,s=1/a.x,o=1/a.y,l=1/a.z;zi.subtract(e,n.center,n.halfExtents),zi.add(t,n.center,n.halfExtents);var u=(e.x-r.x)*s,c=(t.x-r.x)*s,h=(e.y-r.y)*o,f=(t.y-r.y)*o,_=(e.z-r.z)*l,d=(t.z-r.z)*l,p=Math.max(Math.max(Math.min(u,c),Math.min(h,f)),Math.min(_,d)),m=Math.min(Math.min(Math.max(u,c),Math.max(h,f)),Math.max(_,d));return m<0||p>m?0:p>0?p:m}}(),Gr=function(){var e=new zi,t=new zi,i=new zi,n=new zi,r=new zi,a=new zi,s=new zi,o=new Array(3),l=new Array(3),u=new Array(3),c=new Array(6);return function(h,f){o[0]=f.halfExtents.x,o[1]=f.halfExtents.y,o[2]=f.halfExtents.z,e=f.center,t=h.o,i=h.d,zi.set(n,f.orientation.m00,f.orientation.m01,f.orientation.m02),zi.set(r,f.orientation.m03,f.orientation.m04,f.orientation.m05),zi.set(a,f.orientation.m06,f.orientation.m07,f.orientation.m08),zi.subtract(s,e,t),l[0]=zi.dot(n,i),l[1]=zi.dot(r,i),l[2]=zi.dot(a,i),u[0]=zi.dot(n,s),u[1]=zi.dot(r,s),u[2]=zi.dot(a,s);for(var _=0;_<3;++_){if(0===l[_]){if(-u[_]-o[_]>0||-u[_]+o[_]<0)return 0;l[_]=1e-7}c[2*_+0]=(u[_]+o[_])/l[_],c[2*_+1]=(u[_]-o[_])/l[_]}var d=Math.max(Math.max(Math.min(c[0],c[1]),Math.min(c[2],c[3])),Math.min(c[4],c[5])),p=Math.min(Math.min(Math.max(c[0],c[1]),Math.max(c[2],c[3])),Math.max(c[4],c[5]));return p<0||d>p?0:d>0?d:p}}(),Vr=function(){var e=new zi,t=new zi,i=new zi,n=new zi,r=new zi,a=new zi,s=new zi,o=new Dr;return function(l,u){var c=u.radius*u.radius,h=zi.normalize(e,l.d),f=u.ellipseCenter0,_=u.ellipseCenter1,d=zi.subtract(t,_,f);if(d.equals(zi.ZERO))return o.radius=u.radius,o.center.set(u.ellipseCenter0),Sa.ray_sphere(l,o);var p=l.o,m=zi.subtract(i,p,f),v=zi.cross(n,h,d),g=v.lengthSqr();if(0===g){o.radius=u.radius;var y=zi.subtract(r,_,p);return m.lengthSqr()<y.lengthSqr()?o.center.set(u.ellipseCenter0):o.center.set(u.ellipseCenter1),Sa.ray_sphere(l,o)}var b=zi.cross(r,m,d),E=d.lengthSqr(),T=2*zi.dot(v,b),S=T*T-4*g*(b.lengthSqr()-c*E);if(S<0)return 0;var x=(-T-Math.sqrt(S))/(2*g);if(x<0){o.radius=u.radius;var A=zi.subtract(a,_,p);return m.lengthSqr()<A.lengthSqr()?o.center.set(u.ellipseCenter0):o.center.set(u.ellipseCenter1),Sa.ray_sphere(l,o)}var w=zi.scaleAndAdd(a,l.o,h,x),C=zi.subtract(s,w,f),R=zi.dot(C,d)/E;return R>=0&&R<=1?x:R<0?(o.radius=u.radius,o.center.set(u.ellipseCenter0),Sa.ray_sphere(l,o)):R>1?(o.radius=u.radius,o.center.set(u.ellipseCenter1),Sa.ray_sphere(l,o)):0}}(),Hr=function(){var e=new zi(0,0,0);return function(t,i){zi.subtract(e,t.e,t.s);var n=(i.d-zi.dot(t.s,i.n))/zi.dot(e,i.n);return n<0||n>1?0:n}}(),Wr=function(){var e=new zi(0,0,0),t=new zi(0,0,0),i=new zi(0,0,0),n=new zi(0,0,0),r=new zi(0,0,0),a=new zi(0,0,0);return function(s,o,l){zi.subtract(e,o.b,o.a),zi.subtract(t,o.c,o.a),zi.subtract(i,s.s,s.e),zi.cross(r,e,t);var u=zi.dot(i,r);if(u<=0)return 0;zi.subtract(n,s.s,o.a);var c=zi.dot(n,r);if(c<0||c>u)return 0;zi.cross(a,i,n);var h=zi.dot(t,a);if(h<0||h>u)return 0;var f=-zi.dot(e,a);if(f<0||h+f>u)return 0;if(l){var _=1/u,d=1-(h*=_)-(f*=_);zi.set(l,o.a.x*d+o.b.x*h+o.c.x*f,o.a.y*d+o.b.y*h+o.c.y*f,o.a.z*d+o.b.z*h+o.c.z*f)}return 1}}(),jr=new Cr;function Xr(e,t){jr.o.set(e.s),zi.subtract(jr.d,e.e,e.s),jr.d.normalize();var i=Ur(jr,t);return i<=e.length()?i:0}function qr(e,t){jr.o.set(e.s),zi.subtract(jr.d,e.e,e.s),jr.d.normalize();var i=Gr(jr,t);return i<=e.length()?i:0}function Yr(e,t){jr.o.set(e.s),zi.subtract(jr.d,e.e,e.s),jr.d.normalize();var i=zr(jr,t);return i<=e.length()?i:0}var Kr,Zr,Qr,Jr,$r=(Kr=new zi,Zr=new zi,Qr=new zi,Jr=new zi,function(e,t){return zi.subtract(Kr,e.center,e.halfExtents),zi.add(Zr,e.center,e.halfExtents),zi.subtract(Qr,t.center,t.halfExtents),zi.add(Jr,t.center,t.halfExtents),Kr.x<=Jr.x&&Zr.x>=Qr.x&&Kr.y<=Jr.y&&Zr.y>=Qr.y&&Kr.z<=Jr.z&&Zr.z>=Qr.z});function ea(e,t,i,n,r,a){zi.set(a[0],e.x+i.x*t.x+n.x*t.y+r.x*t.z,e.y+i.y*t.x+n.y*t.y+r.y*t.z,e.z+i.z*t.x+n.z*t.y+r.z*t.z),zi.set(a[1],e.x-i.x*t.x+n.x*t.y+r.x*t.z,e.y-i.y*t.x+n.y*t.y+r.y*t.z,e.z-i.z*t.x+n.z*t.y+r.z*t.z),zi.set(a[2],e.x+i.x*t.x-n.x*t.y+r.x*t.z,e.y+i.y*t.x-n.y*t.y+r.y*t.z,e.z+i.z*t.x-n.z*t.y+r.z*t.z),zi.set(a[3],e.x+i.x*t.x+n.x*t.y-r.x*t.z,e.y+i.y*t.x+n.y*t.y-r.y*t.z,e.z+i.z*t.x+n.z*t.y-r.z*t.z),zi.set(a[4],e.x-i.x*t.x-n.x*t.y-r.x*t.z,e.y-i.y*t.x-n.y*t.y-r.y*t.z,e.z-i.z*t.x-n.z*t.y-r.z*t.z),zi.set(a[5],e.x+i.x*t.x-n.x*t.y-r.x*t.z,e.y+i.y*t.x-n.y*t.y-r.y*t.z,e.z+i.z*t.x-n.z*t.y-r.z*t.z),zi.set(a[6],e.x-i.x*t.x+n.x*t.y-r.x*t.z,e.y-i.y*t.x+n.y*t.y-r.y*t.z,e.z-i.z*t.x+n.z*t.y-r.z*t.z),zi.set(a[7],e.x-i.x*t.x-n.x*t.y+r.x*t.z,e.y-i.y*t.x-n.y*t.y+r.y*t.z,e.z-i.z*t.x-n.z*t.y+r.z*t.z)}function ta(e,t){for(var i=zi.dot(t,e[0]),n=i,r=1;r<8;++r){var a=zi.dot(t,e[r]);i=a<i?a:i,n=a>n?a:n}return[i,n]}var ia,na,ra,aa=function(){for(var e=new Array(15),t=0;t<15;t++)e[t]=new zi(0,0,0);for(var i=new Array(8),n=new Array(8),r=0;r<8;r++)i[r]=new zi(0,0,0),n[r]=new zi(0,0,0);var a=new zi,s=new zi;return function(t,r){zi.set(e[0],1,0,0),zi.set(e[1],0,1,0),zi.set(e[2],0,0,1),zi.set(e[3],r.orientation.m00,r.orientation.m01,r.orientation.m02),zi.set(e[4],r.orientation.m03,r.orientation.m04,r.orientation.m05),zi.set(e[5],r.orientation.m06,r.orientation.m07,r.orientation.m08);for(var o=0;o<3;++o)zi.cross(e[6+3*o+0],e[o],e[0]),zi.cross(e[6+3*o+1],e[o],e[1]),zi.cross(e[6+3*o+1],e[o],e[2]);zi.subtract(a,t.center,t.halfExtents),zi.add(s,t.center,t.halfExtents),function(e,t,i){zi.set(i[0],e.x,t.y,t.z),zi.set(i[1],e.x,t.y,e.z),zi.set(i[2],e.x,e.y,t.z),zi.set(i[3],e.x,e.y,e.z),zi.set(i[4],t.x,t.y,t.z),zi.set(i[5],t.x,t.y,e.z),zi.set(i[6],t.x,e.y,t.z),zi.set(i[7],t.x,e.y,e.z)}(a,s,i),ea(r.center,r.halfExtents,e[3],e[4],e[5],n);for(var l=0;l<15;++l){var u=ta(i,e[l]),c=ta(n,e[l]);if(c[0]>u[1]||u[0]>c[1])return 0}return 1}}(),sa=function(e,t){var i=e.halfExtents.x*Math.abs(t.n.x)+e.halfExtents.y*Math.abs(t.n.y)+e.halfExtents.z*Math.abs(t.n.z),n=zi.dot(t.n,e.center);return n+i<t.d?-1:n-i>t.d?0:1},oa=function(e,t){for(var i=0;i<t.planes.length;i++)if(-1===sa(e,t.planes[i]))return 0;return 1},la=function(){for(var e=new Array(8),t=0,i=0,n=0;n<e.length;n++)e[n]=new zi(0,0,0);return function(n,r){for(var a=0,s=!1,o=0;o<r.planes.length;o++){if(-1===(a=sa(n,r.planes[o])))return 0;1===a&&(s=!0)}if(!s)return 1;for(var l=0;l<r.vertices.length;l++)zi.subtract(e[l],r.vertices[l],n.center);t=0,i=0;for(var u=0;u<r.vertices.length;u++)e[u].x>n.halfExtents.x?t++:e[u].x<-n.halfExtents.x&&i++;if(t===r.vertices.length||i===r.vertices.length)return 0;t=0,i=0;for(var c=0;c<r.vertices.length;c++)e[c].y>n.halfExtents.y?t++:e[c].y<-n.halfExtents.y&&i++;if(t===r.vertices.length||i===r.vertices.length)return 0;t=0,i=0;for(var h=0;h<r.vertices.length;h++)e[h].z>n.halfExtents.z?t++:e[h].z<-n.halfExtents.z&&i++;return t===r.vertices.length||i===r.vertices.length?0:1}}(),ua=(ia=new zi(0,0,0),na=new an,function(e,t){return zi.subtract(ia,t,e.center),zi.transformMat3(ia,ia,an.transpose(na,e.orientation)),i=ia,n=e.halfExtents,Math.abs(i.x)<n.x&&Math.abs(i.y)<n.y&&Math.abs(i.z)<n.z;var i,n}),ca=(ra=function(e,t,i,n){return Math.abs(e.x*t+e.y*i+e.z*n)},function(e,t){var i=e.halfExtents.x*ra(t.n,e.orientation.m00,e.orientation.m01,e.orientation.m02)+e.halfExtents.y*ra(t.n,e.orientation.m03,e.orientation.m04,e.orientation.m05)+e.halfExtents.z*ra(t.n,e.orientation.m06,e.orientation.m07,e.orientation.m08),n=zi.dot(t.n,e.center);return n+i<t.d?-1:n-i>t.d?0:1}),ha=function(e,t){for(var i=0;i<t.planes.length;i++)if(-1===ca(e,t.planes[i]))return 0;return 1},fa=function(){for(var e=new Array(8),t=0,i=0,n=0,r=0;r<e.length;r++)e[r]=new zi(0,0,0);var a=function(e,t,i,n){return e.x*t+e.y*i+e.z*n};return function(r,s){for(var o=0,l=!1,u=0;u<s.planes.length;u++){if(-1===(o=ca(r,s.planes[u])))return 0;1===o&&(l=!0)}if(!l)return 1;for(var c=0;c<s.vertices.length;c++)zi.subtract(e[c],s.vertices[c],r.center);i=0,n=0;for(var h=0;h<s.vertices.length;h++)(t=a(e[h],r.orientation.m00,r.orientation.m01,r.orientation.m02))>r.halfExtents.x?i++:t<-r.halfExtents.x&&n++;if(i===s.vertices.length||n===s.vertices.length)return 0;i=0,n=0;for(var f=0;f<s.vertices.length;f++)(t=a(e[f],r.orientation.m03,r.orientation.m04,r.orientation.m05))>r.halfExtents.y?i++:t<-r.halfExtents.y&&n++;if(i===s.vertices.length||n===s.vertices.length)return 0;i=0,n=0;for(var _=0;_<s.vertices.length;_++)(t=a(e[_],r.orientation.m06,r.orientation.m07,r.orientation.m08))>r.halfExtents.z?i++:t<-r.halfExtents.z&&n++;return i===s.vertices.length||n===s.vertices.length?0:1}}(),_a=function(){for(var e=new Array(15),t=0;t<15;t++)e[t]=new zi(0,0,0);for(var i=new Array(8),n=new Array(8),r=0;r<8;r++)i[r]=new zi(0,0,0),n[r]=new zi(0,0,0);return function(t,r){zi.set(e[0],t.orientation.m00,t.orientation.m01,t.orientation.m02),zi.set(e[1],t.orientation.m03,t.orientation.m04,t.orientation.m05),zi.set(e[2],t.orientation.m06,t.orientation.m07,t.orientation.m08),zi.set(e[3],r.orientation.m00,r.orientation.m01,r.orientation.m02),zi.set(e[4],r.orientation.m03,r.orientation.m04,r.orientation.m05),zi.set(e[5],r.orientation.m06,r.orientation.m07,r.orientation.m08);for(var a=0;a<3;++a)zi.cross(e[6+3*a+0],e[a],e[0]),zi.cross(e[6+3*a+1],e[a],e[1]),zi.cross(e[6+3*a+1],e[a],e[2]);ea(t.center,t.halfExtents,e[0],e[1],e[2],i),ea(r.center,r.halfExtents,e[3],e[4],e[5],n);for(var s=0;s<15;++s){var o=ta(i,e[s]),l=ta(n,e[s]);if(l[0]>o[1]||o[0]>l[1])return 0}return 1}}(),da=function(){for(var e=new Dr,t=new zi,i=new zi,n=new zi,r=new Array(8),a=0;a<8;a++)r[a]=new zi;for(var s=new Array(8),o=0;o<8;o++)s[o]=new zi;return function(a,o){if(0===zi.squaredDistance(o.ellipseCenter0,o.ellipseCenter1))return e.radius=o.radius,e.center.set(o.ellipseCenter0),Sa.sphere_obb(e,a);t.x=a.orientation.m00,t.y=a.orientation.m01,t.z=a.orientation.m02,i.x=a.orientation.m03,i.y=a.orientation.m04,i.z=a.orientation.m05,n.x=a.orientation.m06,n.y=a.orientation.m07,n.z=a.orientation.m08,ea(a.center,a.halfExtents,t,i,n,r);var l=s,u=zi.copy(l[0],t),c=zi.copy(l[1],i),h=zi.copy(l[2],n);zi.subtract(l[3],o.center,a.center).normalize();var f=zi.subtract(l[4],o.ellipseCenter0,o.ellipseCenter1);f.normalize(),zi.cross(l[5],u,f),zi.cross(l[6],c,f),zi.cross(l[7],h,f);for(var _=0;_<8;++_){var d=ta(r,l[_]),p=zi.dot(l[_],o.ellipseCenter0),m=zi.dot(l[_],o.ellipseCenter1),v=Math.max(p,m),g=Math.min(p,m)-o.radius,y=v+o.radius;if(g>d[1]||d[0]>y)return 0}return 1}}(),pa=function(e,t){var i=zi.dot(t.n,e.center),n=e.radius*t.n.length();return i+n<t.d?-1:i-n>t.d?0:1},ma=function(e,t){for(var i=0;i<t.planes.length;i++)if(-1===pa(e,t.planes[i]))return 0;return 1},va=function(){var e=new zi(0,0,0),t=[1,-1,1,-1,1,-1];return function(i,n){for(var r=0;r<6;r++){var a=n.planes[r],s=i.radius,o=i.center,l=a.n,u=a.d,c=zi.dot(l,o);if(c+s<u)return 0;if(!(c-s>u)){zi.add(e,o,zi.multiplyScalar(e,l,s));for(var h=0;h<6;h++)if(h!==r&&h!==r+t[r]){var f=n.planes[h];if(zi.dot(f.n,e)<f.d)return 0}}}return 1}}(),ga=function(e,t){var i=e.radius+t.radius;return zi.squaredDistance(e.center,t.center)<i*i},ya=function(){var e=new zi;return function(t,i){return xr(e,t.center,i),zi.squaredDistance(t.center,e)<t.radius*t.radius}}(),ba=function(){var e=new zi;return function(t,i){return Ar(e,t.center,i),zi.squaredDistance(t.center,e)<t.radius*t.radius}}(),Ea=function(){var e=new zi,t=new zi;return function(i,n){var r=i.radius+n.radius,a=r*r,s=zi.squaredDistance(n.ellipseCenter0,n.ellipseCenter1);if(0===s)return zi.squaredDistance(i.center,n.center)<a;zi.subtract(e,i.center,n.ellipseCenter0),zi.subtract(t,n.ellipseCenter1,n.ellipseCenter0);var o=zi.dot(e,t)/s;return o<0?zi.squaredDistance(i.center,n.ellipseCenter0)<a:o>1?zi.squaredDistance(i.center,n.ellipseCenter1)<a:(zi.scaleAndAdd(e,n.ellipseCenter0,t,o),zi.squaredDistance(i.center,e)<a)}}(),Ta=function(){var e=new zi,t=new zi,i=new zi,n=new zi,r=new zi,a=new zi;return function(s,o){var l,u,c,h,f=zi.subtract(e,s.ellipseCenter1,s.ellipseCenter0),_=zi.subtract(t,o.ellipseCenter1,o.ellipseCenter0),d=zi.subtract(i,s.ellipseCenter0,o.ellipseCenter0),p=zi.dot(f,f),m=zi.dot(f,_),v=zi.dot(_,_),g=zi.dot(f,d),y=zi.dot(_,d),b=p*v-m*m,E=b,T=b;b<ci?(u=0,E=1,h=y,T=v):(h=p*y-m*g,(u=m*y-v*g)<0?(u=0,h=y,T=v):u>E&&(u=E,h=y+m,T=v)),h<0?(h=0,-g<0?u=0:-g>p?u=E:(u=-g,E=p)):h>T&&(h=T,-g+m<0?u=0:-g+m>p?u=E:(u=-g+m,E=p)),l=Math.abs(u)<ci?0:u/E,c=Math.abs(h)<ci?0:h/T;var S=n;S.set(d),S.add(zi.multiplyScalar(r,f,l)),S.subtract(zi.multiplyScalar(a,_,c));var x=s.radius+o.radius;return S.lengthSqr()<x*x}}(),Sa={ray_sphere:zr,ray_aabb:Ur,ray_obb:Gr,ray_plane:Fr,ray_triangle:Nr,ray_capsule:Vr,line_sphere:Yr,line_aabb:Xr,line_obb:qr,line_plane:Hr,line_triangle:Wr,sphere_sphere:ga,sphere_aabb:ya,sphere_obb:ba,sphere_plane:pa,sphere_frustum:ma,sphere_frustum_accurate:va,sphere_capsule:Ea,aabb_aabb:$r,aabb_obb:aa,aabb_plane:sa,aabb_frustum:oa,aabb_frustum_accurate:la,obb_obb:_a,obb_plane:ca,obb_frustum:ha,obb_frustum_accurate:fa,obb_point:ua,obb_capsule:da,capsule_capsule:Ta,resolve:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=e._type,r=t._type,a=this[n|r];return n<r?a(e,t,i):a(t,e,i)}};Sa[oe.SHAPE_RAY|oe.SHAPE_SPHERE]=zr,Sa[oe.SHAPE_RAY|oe.SHAPE_AABB]=Ur,Sa[oe.SHAPE_RAY|oe.SHAPE_OBB]=Gr,Sa[oe.SHAPE_RAY|oe.SHAPE_PLANE]=Fr,Sa[oe.SHAPE_RAY|oe.SHAPE_TRIANGLE]=Nr,Sa[oe.SHAPE_RAY|oe.SHAPE_CAPSULE]=Vr,Sa[oe.SHAPE_LINE|oe.SHAPE_SPHERE]=Yr,Sa[oe.SHAPE_LINE|oe.SHAPE_AABB]=Xr,Sa[oe.SHAPE_LINE|oe.SHAPE_OBB]=qr,Sa[oe.SHAPE_LINE|oe.SHAPE_PLANE]=Hr,Sa[oe.SHAPE_LINE|oe.SHAPE_TRIANGLE]=Wr,Sa[oe.SHAPE_SPHERE]=ga,Sa[oe.SHAPE_SPHERE|oe.SHAPE_AABB]=ya,Sa[oe.SHAPE_SPHERE|oe.SHAPE_OBB]=ba,Sa[oe.SHAPE_SPHERE|oe.SHAPE_PLANE]=pa,Sa[oe.SHAPE_SPHERE|oe.SHAPE_FRUSTUM]=ma,Sa[oe.SHAPE_SPHERE|oe.SHAPE_FRUSTUM_ACCURATE]=va,Sa[oe.SHAPE_SPHERE|oe.SHAPE_CAPSULE]=Ea,Sa[oe.SHAPE_AABB]=$r,Sa[oe.SHAPE_AABB|oe.SHAPE_OBB]=aa,Sa[oe.SHAPE_AABB|oe.SHAPE_PLANE]=sa,Sa[oe.SHAPE_AABB|oe.SHAPE_FRUSTUM]=oa,Sa[oe.SHAPE_AABB|oe.SHAPE_FRUSTUM_ACCURATE]=la,Sa[oe.SHAPE_OBB]=_a,Sa[oe.SHAPE_OBB|oe.SHAPE_PLANE]=ca,Sa[oe.SHAPE_OBB|oe.SHAPE_FRUSTUM]=ha,Sa[oe.SHAPE_OBB|oe.SHAPE_FRUSTUM_ACCURATE]=fa,Sa[oe.SHAPE_OBB|oe.SHAPE_CAPSULE]=da,Sa[oe.SHAPE_CAPSULE]=Ta;var xa=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:-1;i(this,e),this._type=oe.SHAPE_LINE,this.s=new zi(t,n,r),this.e=new zi(a,s,o)}return r(e,null,[{key:"create",value:function(t,i,n,r,a,s){return new e(t,i,n,r,a,s)}},{key:"clone",value:function(t){return new e(t.s.x,t.s.y,t.s.z,t.e.x,t.e.y,t.e.z)}},{key:"copy",value:function(e,t){return zi.copy(e.s,t.s),zi.copy(e.e,t.e),e}},{key:"fromPoints",value:function(e,t,i){return zi.copy(e.s,t),zi.copy(e.e,i),e}},{key:"set",value:function(e,t,i,n,r,a,s){return e.s.x=t,e.s.y=i,e.s.z=n,e.e.x=r,e.e.y=a,e.e.z=s,e}},{key:"len",value:function(e){return zi.distance(e.s,e.e)}}]),r(e,[{key:"length",value:function(){return zi.distance(this.s,this.e)}}]),e}(),Aa=new zi(0,0,0),wa=new zi(0,0,0),Ca=cc.mat4(),Ra=cc.v4(),ka=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;i(this,e),this._type=oe.SHAPE_PLANE,this.n=new zi(t,n,r),this.d=a}return r(e,null,[{key:"create",value:function(t,i,n,r){return new e(t,i,n,r)}},{key:"clone",value:function(t){return new e(t.n.x,t.n.y,t.n.z,t.d)}},{key:"copy",value:function(e,t){return zi.copy(e.n,t.n),e.d=t.d,e}},{key:"fromPoints",value:function(e,t,i,n){return zi.subtract(Aa,i,t),zi.subtract(wa,n,t),zi.normalize(e.n,zi.cross(e.n,Aa,wa)),e.d=zi.dot(e.n,t),e}},{key:"set",value:function(e,t,i,n,r){return e.n.x=t,e.n.y=i,e.n.z=n,e.d=r,e}},{key:"fromNormalAndPoint",value:function(e,t,i){return zi.copy(e.n,t),e.d=zi.dot(t,i),e}},{key:"normalize",value:function(e,t){var i=t.n.length();return zi.normalize(e.n,t.n),i>0&&(e.d=t.d/i),e}}]),r(e,[{key:"transform",value:function(e){Bn.invert(Ca,e),Bn.transpose(Ca,Ca),qi.set(Ra,this.n.x,this.n.y,this.n.z,this.d),qi.transformMat4(Ra,Ra,Ca),zi.set(this.n,Ra.x,Ra.y,Ra.z),this.d=Ra.w}}]),e}(),Oa=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,l=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,u=arguments.length>7&&void 0!==arguments[7]?arguments[7]:1,c=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0;i(this,e),this._type=oe.SHAPE_TRIANGLE,this.a=new zi(t,n,r),this.b=new zi(a,s,o),this.c=new zi(l,u,c)}return r(e,null,[{key:"create",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,l=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,u=arguments.length>8&&void 0!==arguments[8]?arguments[8]:1;return new e(t,i,n,r,a,s,o,l,u)}},{key:"clone",value:function(t){return new e(t.a.x,t.a.y,t.a.z,t.b.x,t.b.y,t.b.z,t.c.x,t.c.y,t.c.z)}},{key:"copy",value:function(e,t){return zi.copy(e.a,t.a),zi.copy(e.b,t.b),zi.copy(e.c,t.c),e}},{key:"fromPoints",value:function(e,t,i,n){return zi.copy(e.a,t),zi.copy(e.b,i),zi.copy(e.c,n),e}},{key:"set",value:function(e,t,i,n,r,a,s,o,l,u){return e.a.x=t,e.a.y=i,e.a.z=n,e.b.x=r,e.b.y=a,e.b.z=s,e.c.x=o,e.c.y=l,e.c.z=u,e}}]),e}(),Ia=new zi,Ma=new zi,La=new zi,Pa=new zi,Ba=new an,Da=function(e,t,i){Ba.m00=Math.abs(i.m00),Ba.m01=Math.abs(i.m01),Ba.m02=Math.abs(i.m02),Ba.m03=Math.abs(i.m04),Ba.m04=Math.abs(i.m05),Ba.m05=Math.abs(i.m06),Ba.m06=Math.abs(i.m08),Ba.m07=Math.abs(i.m09),Ba.m08=Math.abs(i.m10),zi.transformMat3(e,t,Ba)},Fa=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1;i(this,e),this._type=oe.SHAPE_AABB,this.center=new zi(t,n,r),this.halfExtents=new zi(a,s,o)}return r(e,[{key:"type",get:function(){return this._type}}],[{key:"create",value:function(t,i,n,r,a,s){return new e(t,i,n,r,a,s)}},{key:"clone",value:function(t){return new e(t.center.x,t.center.y,t.center.z,t.halfExtents.x,t.halfExtents.y,t.halfExtents.z)}},{key:"copy",value:function(e,t){return zi.copy(e.center,t.center),zi.copy(e.halfExtents,t.halfExtents),e}},{key:"fromPoints",value:function(e,t,i){return zi.add(Ia,i,t),zi.subtract(Ma,i,t),zi.multiplyScalar(e.center,Ia,.5),zi.multiplyScalar(e.halfExtents,Ma,.5),e}},{key:"set",value:function(e,t,i,n,r,a,s){return zi.set(e.center,t,i,n),zi.set(e.halfExtents,r,a,s),e}},{key:"merge",value:function(t,i,n){return zi.subtract(Ia,i.center,i.halfExtents),zi.subtract(Ma,n.center,n.halfExtents),zi.add(La,i.center,i.halfExtents),zi.add(Pa,n.center,n.halfExtents),zi.max(Pa,La,Pa),zi.min(La,Ia,Ma),e.fromPoints(t,La,Pa)}},{key:"transform",value:function(e,t,i){return zi.transformMat4(e.center,t.center,i),Da(e.halfExtents,t.halfExtents,i),e}}]),r(e,[{key:"getBoundary",value:function(e,t){zi.subtract(e,this.center,this.halfExtents),zi.add(t,this.center,this.halfExtents)}},{key:"transform",value:function(e,t,i,n,r){zi.transformMat4(r.center,this.center,e),Da(r.halfExtents,this.halfExtents,e)}},{key:"clone",value:function(){return e.clone(this)}},{key:"copy",value:function(t){return e.copy(this,t)}}]),e}(),Na=new zi,za=new zi,Ua=new an,Ga=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1,l=arguments.length>6&&void 0!==arguments[6]?arguments[6]:1,u=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,c=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,h=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0,f=arguments.length>10&&void 0!==arguments[10]?arguments[10]:1,_=arguments.length>11&&void 0!==arguments[11]?arguments[11]:0,d=arguments.length>12&&void 0!==arguments[12]?arguments[12]:0,p=arguments.length>13&&void 0!==arguments[13]?arguments[13]:0,m=arguments.length>14&&void 0!==arguments[14]?arguments[14]:1;i(this,e),this._type=oe.SHAPE_OBB,this.center=new zi(t,n,r),this.halfExtents=new zi(a,s,o),this.orientation=new an(l,u,c,h,f,_,d,p,m)}return r(e,[{key:"type",get:function(){return this._type}}],[{key:"create",value:function(t,i,n,r,a,s,o,l,u,c,h,f,_,d,p){return new e(t,i,n,r,a,s,o,l,u,c,h,f,_,d,p)}},{key:"clone",value:function(t){return new e(t.center.x,t.center.y,t.center.z,t.halfExtents.x,t.halfExtents.y,t.halfExtents.z,t.orientation.m00,t.orientation.m01,t.orientation.m02,t.orientation.m03,t.orientation.m04,t.orientation.m05,t.orientation.m06,t.orientation.m07,t.orientation.m08)}},{key:"copy",value:function(e,t){return zi.copy(e.center,t.center),zi.copy(e.halfExtents,t.halfExtents),an.copy(e.orientation,t.orientation),e}},{key:"fromPoints",value:function(e,t,i){return zi.multiplyScalar(e.center,zi.add(Na,t,i),.5),zi.multiplyScalar(e.halfExtents,zi.subtract(za,i,t),.5),an.identity(e.orientation),e}},{key:"set",value:function(e,t,i,n,r,a,s,o,l,u,c,h,f,_,d,p){return zi.set(e.center,t,i,n),zi.set(e.halfExtents,r,a,s),an.set(e.orientation,o,l,u,c,h,f,_,d,p),e}}]),r(e,[{key:"getBoundary",value:function(e,t){!function(e,t,i){Ua.m00=Math.abs(i.m00),Ua.m01=Math.abs(i.m01),Ua.m02=Math.abs(i.m02),Ua.m03=Math.abs(i.m03),Ua.m04=Math.abs(i.m04),Ua.m05=Math.abs(i.m05),Ua.m06=Math.abs(i.m06),Ua.m07=Math.abs(i.m07),Ua.m08=Math.abs(i.m08),zi.transformMat3(e,t,Ua)}(Na,this.halfExtents,this.orientation),zi.subtract(e,this.center,Na),zi.add(t,this.center,Na)}},{key:"transform",value:function(e,t,i,n,r){zi.transformMat4(r.center,this.center,e),an.fromQuat(r.orientation,i),zi.multiply(r.halfExtents,this.halfExtents,n)}},{key:"translateAndRotate",value:function(e,t,i){zi.transformMat4(i.center,this.center,e),an.fromQuat(i.orientation,t)}},{key:"setScale",value:function(e,t){zi.multiply(t.halfExtents,this.halfExtents,e)}}]),e}(),Va=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.5,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;i(this,e),this._type=oe.SHAPE_CAPSULE,this.radius=t,this.halfHeight=n,this.axis=r,this.center=new zi,this.rotation=new fn,this.ellipseCenter0=new zi(0,n,0),this.ellipseCenter1=new zi(0,-n,0),this.updateCache()}return r(e,[{key:"transform",value:function(e,t,i,n,r){var a=n,s=Ri(a);r.radius=this.radius*Math.abs(s);var o=(this.halfHeight+this.radius)*Math.abs(a.y)-r.radius;o<0&&(o=0),r.halfHeight=o,zi.transformMat4(r.center,this.center,e),fn.multiply(r.rotation,this.rotation,i),r.updateCache()}},{key:"updateCache",value:function(){this.updateLocalCenter(),zi.transformQuat(this.ellipseCenter0,this.ellipseCenter0,this.rotation),zi.transformQuat(this.ellipseCenter1,this.ellipseCenter1,this.rotation),this.ellipseCenter0.add(this.center),this.ellipseCenter1.add(this.center)}},{key:"updateLocalCenter",value:function(){var e=this.halfHeight;switch(this.axis){case 0:this.ellipseCenter0.set(e,0,0),this.ellipseCenter1.set(-e,0,0);break;case 1:this.ellipseCenter0.set(0,e,0),this.ellipseCenter1.set(0,-e,0);break;case 2:this.ellipseCenter0.set(0,0,e),this.ellipseCenter1.set(0,0,-e)}}}]),e}(),Ha=new Array(8);Ha[0]=new zi(1,1,1),Ha[1]=new zi(-1,1,1),Ha[2]=new zi(-1,-1,1),Ha[3]=new zi(1,-1,1),Ha[4]=new zi(1,1,-1),Ha[5]=new zi(-1,1,-1),Ha[6]=new zi(-1,-1,-1),Ha[7]=new zi(1,-1,-1);var Wa=function(){function e(){i(this,e),this._type=oe.SHAPE_FRUSTUM,this.planes=new Array(6);for(var t=0;t<6;++t)this.planes[t]=ka.create(0,0,0,0);this.vertices=new Array(8);for(var n=0;n<8;++n)this.vertices[n]=new zi}return r(e,[{key:"accurate",set:function(e){this._type=e?oe.SHAPE_FRUSTUM_ACCURATE:oe.SHAPE_FRUSTUM}}],[{key:"create",value:function(){return new e}},{key:"clone",value:function(t){return e.copy(new e,t)}},{key:"copy",value:function(e,t){e._type=t._type;for(var i=0;i<6;++i)ka.copy(e.planes[i],t.planes[i]);for(var n=0;n<8;++n)zi.copy(e.vertices[n],t.vertices[n]);return e}}]),r(e,[{key:"update",value:function(e,t){if(zi.set(this.planes[0].n,e.m03+e.m00,e.m07+e.m04,e.m11+e.m08),this.planes[0].d=-(e.m15+e.m12),zi.set(this.planes[1].n,e.m03-e.m00,e.m07-e.m04,e.m11-e.m08),this.planes[1].d=-(e.m15-e.m12),zi.set(this.planes[2].n,e.m03+e.m01,e.m07+e.m05,e.m11+e.m09),this.planes[2].d=-(e.m15+e.m13),zi.set(this.planes[3].n,e.m03-e.m01,e.m07-e.m05,e.m11-e.m09),this.planes[3].d=-(e.m15-e.m13),zi.set(this.planes[4].n,e.m03+e.m02,e.m07+e.m06,e.m11+e.m10),this.planes[4].d=-(e.m15+e.m14),zi.set(this.planes[5].n,e.m03-e.m02,e.m07-e.m06,e.m11-e.m10),this.planes[5].d=-(e.m15-e.m14),this._type===oe.SHAPE_FRUSTUM_ACCURATE){for(var i=0;i<6;i++){var n=this.planes[i],r=1/n.n.length();zi.multiplyScalar(n.n,n.n,r),n.d*=r}for(var a=0;a<8;a++)zi.transformMat4(this.vertices[a],Ha[a],t)}}},{key:"transform",value:function(e){if(this._type===oe.SHAPE_FRUSTUM_ACCURATE){for(var t=0;t<8;t++)zi.transformMat4(this.vertices[t],this.vertices[t],e);ka.fromPoints(this.planes[0],this.vertices[1],this.vertices[5],this.vertices[6]),ka.fromPoints(this.planes[1],this.vertices[3],this.vertices[7],this.vertices[4]),ka.fromPoints(this.planes[2],this.vertices[6],this.vertices[7],this.vertices[3]),ka.fromPoints(this.planes[3],this.vertices[0],this.vertices[4],this.vertices[5]),ka.fromPoints(this.planes[4],this.vertices[2],this.vertices[3],this.vertices[0]),ka.fromPoints(this.planes[0],this.vertices[7],this.vertices[6],this.vertices[5])}}}]),e}();Wa.createOrtho=function(){var e=new zi;return function(t,i,n,r,a,s){var o=i/2,l=n/2;zi.set(e,o,l,r),zi.transformMat4(t.vertices[0],e,s),zi.set(e,-o,l,r),zi.transformMat4(t.vertices[1],e,s),zi.set(e,-o,-l,r),zi.transformMat4(t.vertices[2],e,s),zi.set(e,o,-l,r),zi.transformMat4(t.vertices[3],e,s),zi.set(e,o,l,a),zi.transformMat4(t.vertices[4],e,s),zi.set(e,-o,l,a),zi.transformMat4(t.vertices[5],e,s),zi.set(e,-o,-l,a),zi.transformMat4(t.vertices[6],e,s),zi.set(e,o,-l,a),zi.transformMat4(t.vertices[7],e,s),ka.fromPoints(t.planes[0],t.vertices[1],t.vertices[6],t.vertices[5]),ka.fromPoints(t.planes[1],t.vertices[3],t.vertices[4],t.vertices[7]),ka.fromPoints(t.planes[2],t.vertices[6],t.vertices[3],t.vertices[7]),ka.fromPoints(t.planes[3],t.vertices[0],t.vertices[5],t.vertices[4]),ka.fromPoints(t.planes[4],t.vertices[2],t.vertices[0],t.vertices[3]),ka.fromPoints(t.planes[0],t.vertices[7],t.vertices[5],t.vertices[6])}}();var ja=dt({Default:0,Once:1,Loop:2,PingPong:3,ClampForever:4}),Xa=function e(){i(this,e),this.time=0,this.value=0,this.inTangent=0,this.outTangent=0};ri.fastDefine("cc.Keyframe",Xa,{time:0,value:0,inTangent:0,outTangent:0});var qa=function(){function e(){i(this,e),this.index=-1,this.time=0,this.endTime=0,this.coefficient=new Float32Array(4)}return r(e,[{key:"evaluate",value:function(e){return function(e,t){return e*(e*(e*t[0]+t[1])+t[2])+t[3]}(e-this.time,this.coefficient)}}]),e}();var Ya=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;i(this,e),this.preWrapMode=ja.Loop,this.postWrapMode=ja.Loop,this.keyFrames=t||[].concat(e.defaultKF),this.cachedKey=new qa}return r(e,[{key:"addKey",value:function(e){null==this.keyFrames&&(this.keyFrames=[]),this.keyFrames.push(e)}},{key:"evaluate_slow",value:function(e){var t=e,i=e<0?this.preWrapMode:this.postWrapMode,n=this.keyFrames[0].time,r=this.keyFrames[this.keyFrames.length-1].time;switch(i){case ja.Loop:t=Ai(e-n,r-n)+n;break;case ja.PingPong:t=wi(e-n,r-n)+n;break;case ja.ClampForever:t=_i(e,n,r)}var a=0;if(t>this.keyFrames[0].time)if(t>=this.keyFrames[this.keyFrames.length-1].time)a=this.keyFrames.length-2;else for(var s=0;s<this.keyFrames.length-1;s++)if(t>=this.keyFrames[0].time&&t<=this.keyFrames[s+1].time){a=s;break}var o=this.keyFrames[a],l=this.keyFrames[a+1],u=Ci(o.time,l.time,t),c=l.time-o.time,h=o.outTangent*c,f=l.inTangent*c,_=u*u,d=_*u,p=d-2*_+u,m=d-_,v=-2*d+3*_;return(2*d-3*_+1)*o.value+p*h+m*f+v*l.value}},{key:"evaluate",value:function(e){var t=e,i=e<0?this.preWrapMode:this.postWrapMode,n=this.keyFrames[0].time,r=this.keyFrames[this.keyFrames.length-1].time;switch(i){case ja.Loop:t=Ai(e-n,r-n)+n;break;case ja.PingPong:t=wi(e-n,r-n)+n;break;case ja.ClampForever:t=_i(e,n,r)}if(t>=this.cachedKey.time&&t<this.cachedKey.endTime)return this.cachedKey.evaluate(t);var a=this.findIndex(this.cachedKey,t),s=a+1;return s===this.keyFrames.length&&(s-=1),this.calcOptimizedKey(this.cachedKey,a,s),this.cachedKey.evaluate(t)}},{key:"calcOptimizedKey",value:function(e,t,i){var n=this.keyFrames[t],r=this.keyFrames[i];e.index=t,e.time=n.time,e.endTime=r.time;var a=r.time-n.time,s=r.value-n.value,o=1/(a*a),l=n.outTangent*a,u=r.inTangent*a;e.coefficient[0]=(l+u-s-s)*o/a,e.coefficient[1]=(s+s+s-l-l-u)*o,e.coefficient[2]=n.outTangent,e.coefficient[3]=n.value}},{key:"findIndex",value:function(e,t){var i=e.index;if(-1!==i)if(t>this.keyFrames[i].time)for(var n=0;n<3;n++){var r=i+n;if(r+1<this.keyFrames.length&&this.keyFrames[r+1].time>t)return r}else for(var a=0;a<3;a++){var s=i-a;if(s>=0&&this.keyFrames[s-1].time<=t)return s-1}for(var o=0,l=this.keyFrames.length,u=Math.floor((o+l)/2);l-o>1;)this.keyFrames[u].time>=t?l=u:o=u+1,u=Math.floor((o+l)/2);return o}}]),e}();Ya.defaultKF=[{time:0,value:1,inTangent:0,outTangent:0},{time:1,value:1,inTangent:0,outTangent:0}],ri.fastDefine("cc.AnimationCurve",Ya,{preWrapMode:ja.Default,postWrapMode:ja.Default,keyFrames:[]}),sr(xa.prototype,"line",[{name:"mag",newName:"len"},{name:"magnitude",newName:"len"}]),or(Sa,"intersect",[{name:"line_quad"}]);var Ka=Object.freeze({__proto__:null,distance:wr,enums:oe,intersect:Sa,line:xa,plane:ka,ray:Cr,triangle:Oa,sphere:Dr,aabb:Fa,obb:Ga,capsule:Va,frustum:Wa,Keyframe:Xa,AnimationCurve:Ya});e("geometry",Ka);var Za=e("Pool",function(){function e(t,n){i(this,e),this._fn=t,this._idx=n-1,this._frees=new Array(n);for(var r=0;r<n;++r)this._frees[r]=t()}return r(e,[{key:"alloc",value:function(){this._idx<0&&this._expand(Math.round(1.2*this._frees.length)+1);var e=this._frees[this._idx];return this._frees.splice(this._idx),--this._idx,e}},{key:"free",value:function(e){++this._idx,this._frees[this._idx]=e}},{key:"clear",value:function(e){for(var t=0;t<=this._idx;t++)e&&e(this._frees[t]);this._frees.splice(0),this._idx=-1}},{key:"_expand",value:function(e){var t=this._frees;this._frees=new Array(e);for(var i=e-t.length,n=0;n<i;++n)this._frees[n]=this._fn();for(var r=i,a=0;r<e;++r,++a)this._frees[r]=t[a];this._idx+=i}}]),e}()),Qa=e("RecyclePool",function(){function e(t,n){i(this,e),this._count=0,this._fn=t,this._data=new Array(n);for(var r=0;r<n;++r)this._data[r]=t()}return r(e,[{key:"reset",value:function(){this._count=0}},{key:"resize",value:function(e){if(e>this._data.length)for(var t=this._data.length;t<e;++t)this._data[t]=this._fn()}},{key:"add",value:function(){return this._count>=this._data.length&&this.resize(2*this._data.length),this._data[this._count++]}},{key:"removeAt",value:function(e){if(!(e>=this._count)){var t=this._count-1,i=this._data[e];this._data[e]=this._data[t],this._data[t]=i,this._count-=1}}},{key:"length",get:function(){return this._count}},{key:"data",get:function(){return this._data}}]),e}()),Ja=e("CachedArray",function(){function e(t,n){i(this,e),this.length=0,this.array=new Array(t),this.length=0,this._compareFn=void 0!==n?n:function(e,t){return e-t}}return r(e,[{key:"push",value:function(e){this.array[this.length++]=e}},{key:"pop",value:function(){return this.array[--this.length]}},{key:"get",value:function(e){return this.array[e]}},{key:"clear",value:function(){this.length=0}},{key:"sort",value:function(){this.array.length=this.length,this.array.sort(this._compareFn)}},{key:"concat",value:function(e){for(var t=0;t<e.length;++t)this.array[this.length++]=e[t]}},{key:"fastRemove",value:function(e){if(!(e>=this.length||e<0)){var t=--this.length;this.array[e]=this.array[t]}}},{key:"indexOf",value:function(e){return this.array.indexOf(e)}}]),e}());e("memop",Object.freeze({__proto__:null,Pool:Za,RecyclePool:Qa,CachedArray:Ja}));var $a=/([a-zA-Z0-9--]+|\S)/,es=/^[!,.:;'}\]%\?>]/,ts=/([a-zA-Z0-9--]+|\S)$/,is=/[a-zA-Z0-9--]+$/,ns=/^[a-zA-Z0-9--]/;function rs(e){return/^[\u4E00-\u9FFF\u3400-\u4DFF]+$/.test(e)||/[\u3000-\u303F]|[\u3040-\u309F]|[\u30A0-\u30FF]|[\uFF00-\uFFEF]|[\u4E00-\u9FAF]|[\u2605-\u2606]|[\u2190-\u2195]|\u203B/g.test(e)||/^[\u1100-\u11FF]|[\u3130-\u318F]|[\uA960-\uA97F]|[\uAC00-\uD7AF]|[\uD7B0-\uD7FF]+$/.test(e)}function as(e){var t=e.charCodeAt(0);return t>=9&&t<=13||32===t||133===t||160===t||5760===t||t>=8192&&t<=8202||8232===t||8233===t||8239===t||8287===t||12288===t}function ss(e,t){var i=e.measureText(t);return i&&i.width||0}function os(e,t,i,n){var r=[];if(0===e.length||i<0)return r.push(""),r;for(var a=e;t>i&&a.length>1;){for(var s=a.length*(i/t)|0,o=a.substr(s),l=t-n(o),u=o,c=0,h=0;l>i&&h++<10;)s*=i/l,s|=0,l=t-n(o=a.substr(s));for(h=0;l<=i&&h++<10;){if(o){var f=$a.exec(o);c=f?f[0].length:1,u=o}s+=c,l=t-n(o=a.substr(s))}0===(s-=c)&&(s=1,u=u.substr(1));var _=a.substr(0,s),d=void 0;es.test(u||o)&&(0===(s-=(d=ts.exec(_))?d[0].length:0)&&(s=1),u=a.substr(s),_=a.substr(0,s)),ns.test(u)&&(d=is.exec(_))&&_!==d[0]&&(s-=d[0].length,u=a.substr(s),_=a.substr(0,s)),0===r.length?r.push(_):(_=_.trim()).length>0&&r.push(_),t=n(a=u||o)}return 0===r.length?r.push(a):(a=a.trim()).length>0&&r.push(a),r}var ls=/^(click)(\s)*=|(param)(\s)*=/,us=/(\s)*src(\s)*=|(\s)*height(\s)*=|(\s)*width(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/,cs=e("HtmlTextParser",function(){function e(){i(this,e),this._specialSymbolArray=[],this._stack=[],this._resultObjectArray=[],this._specialSymbolArray.push([/&lt;/g,"<"]),this._specialSymbolArray.push([/&gt;/g,">"]),this._specialSymbolArray.push([/&amp;/g,"&"]),this._specialSymbolArray.push([/&quot;/g,'"']),this._specialSymbolArray.push([/&apos;/g,"'"])}return r(e,[{key:"parse",value:function(e){this._resultObjectArray.length=0,this._stack.length=0;for(var t=0,i=e.length;t<i;){var n=e.indexOf("<",t);if(n<0)this._stack.pop(),this._processResult(e.substring(t)),t=i;else{this._processResult(e.substring(t,n));var r=e.indexOf(">",t);-1===r?r=n:"/"===e.charAt(n+1)?this._stack.pop():this._addToStack(e.substring(n+1,r)),t=r+1}}return this._resultObjectArray}},{key:"_attributeToObject",value:function(e){var t={},i=(e=e.trim()).match(/^(color|size)(\s)*=/),n="",r=0,a="";if(i){if(n=i[0],""===(e=e.substring(n.length).trim()))return t;switch(r=e.indexOf(" "),n[0]){case"c":t.color=r>-1?e.substring(0,r).trim():e;break;case"s":t.size=parseInt(e)}return r>-1&&(a=e.substring(r+1).trim(),t.event=this._processEventHandler(a)),t}if((i=e.match(/^(br(\s)*\/)/))&&i[0].length>0&&(n=i[0].trim()).startsWith("br")&&"/"===n[n.length-1])return t.isNewLine=!0,this._resultObjectArray.push({text:"",style:{newline:!0}}),t;var s="";if((i=e.match(/^(img(\s)*src(\s)*=[^>]+\/)/))&&i[0].length>0&&(n=i[0].trim()).startsWith("img")&&"/"===n[n.length-1]){var o;i=e.match(us);for(var l=!1;i;)n=(e=e.substring(e.indexOf(i[0]))).substr(0,i[0].length),o=(r=(s=e.substring(n.length).trim()).indexOf(" "))>-1?s.substr(0,r):s,n=(n=n.replace(/[^a-zA-Z]/g,"").trim()).toLocaleLowerCase(),e=s.substring(r).trim(),"src"===n?(t.isImage=!0,o.endsWith("/")&&(o=o.substring(0,o.length-1)),0===o.indexOf("'")?(l=!0,o=o.substring(1,o.length-1)):0===o.indexOf('"')&&(l=!0,o=o.substring(1,o.length-1)),t.src=o):"height"===n?t.imageHeight=parseInt(o):"width"===n?t.imageWidth=parseInt(o):"click"===n&&(t.event=this._processEventHandler(n+"="+o)),t.event&&"param"===n&&(t.event[n]=o.replace(/^\"|\"$/g,"")),i=e.match(us);return l&&t.isImage&&this._resultObjectArray.push({text:"",style:t}),{}}if(i=e.match(/^(outline(\s)*[^>]*)/)){var u={color:"#ffffff",width:1};if(e=i[0].substring("outline".length).trim()){var c,h=/(\s)*color(\s)*=|(\s)*width(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/;for(i=e.match(h);i;)n=(e=e.substring(e.indexOf(i[0]))).substr(0,i[0].length),c=(r=(s=e.substring(n.length).trim()).indexOf(" "))>-1?s.substr(0,r):s,n=(n=n.replace(/[^a-zA-Z]/g,"").trim()).toLocaleLowerCase(),e=s.substring(r).trim(),"click"===n?t.event=this._processEventHandler(n+"="+c):"color"===n?u.color=c:"width"===n&&(u.width=parseInt(c)),t.event&&"param"===n&&(t.event[n]=c.replace(/^\"|\"$/g,"")),i=e.match(h)}t.outline=u}if((i=e.match(/^(on|u|b|i)(\s)*/))&&i[0].length>0){switch(n=i[0],e=e.substring(n.length).trim(),n[0]){case"u":t.underline=!0;break;case"i":t.italic=!0;break;case"b":t.bold=!0}if(""===e)return t;t.event=this._processEventHandler(e)}return t}},{key:"_processEventHandler",value:function(e){for(var t=0,i=new Map,n=e.match(ls),r=!1;n;){var a=n[0],s="";if(r=!1,'"'===(e=e.substring(a.length).trim()).charAt(0))(t=e.indexOf('"',1))>-1&&(s=e.substring(1,t).trim(),r=!0),t++;else if("'"===e.charAt(0))(t=e.indexOf("'",1))>-1&&(s=e.substring(1,t).trim(),r=!0),t++;else{var o=e.match(/(\S)+/);t=(s=o?o[0]:"").length}r&&(i[a=a.substring(0,a.length-1).trim()]=s),n=(e=e.substring(t).trim()).match(ls)}return i}},{key:"_addToStack",value:function(e){var t=this._attributeToObject(e);if(0===this._stack.length)this._stack.push(t);else{if(t.isNewLine||t.isImage)return;var i=this._stack[this._stack.length-1];for(var n in i)t[n]||(t[n]=i[n]);this._stack.push(t)}}},{key:"_processResult",value:function(e){0!==e.length&&(e=this._escapeSpecialSymbol(e),this._stack.length>0?this._resultObjectArray.push({text:e,style:this._stack[this._stack.length-1]}):this._resultObjectArray.push({text:e}))}},{key:"_escapeSpecialSymbol",value:function(e){var t=this._specialSymbolArray,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r,s=a[0],o=a[1];e=e.replace(s,o)}return e}}]),e}());function hs(e){return e}function fs(e,t){return e[t]||(e[t]={})}function _s(e){return function(t){return"function"==typeof t?e(t):function(i){return e(i,t)}}}function ds(e,t,i){return function(e){return function(i){return t(i,e)}}}var ps=ds.bind(null,!1);function ms(e){return ds.bind(null,!1)}var vs=ms(),gs=ms();function ys(e,t){return fs(e,"__ccclassCache__")}function bs(e,i,n,r,a,s){var o;r&&(o=(o=Bt(r))||r);var l=Fe(i[n]||{},o||{});if(a&&(a.get||a.set)){a.get&&(l.get=a.get),a.set&&(l.set=a.set)}else{var u;0;if(a)a.initializer&&(u=function(e){var i;try{i=e()}catch(t){return e}return"object"!==t(i)||null===i?i:e}(a.initializer),!0);else{var c=s.default||(s.default=function(e){var t;try{t=new e}catch(e){return{}}return t}(e));c.hasOwnProperty(n)&&(u=c[n],!0)}0,l.default=u}i[n]=l}var Es=_s((function(e,t){var i=ze(e);i===Object&&(i=null);var n={name:t,extends:i,ctor:e,__ES6__:!0},r=e.__ccclassCache__;if(r){var a=r.proto;a&&Fe(n,a),e.__ccclassCache__=void 0}return cc.Class(n)}));function Ts(e,t,i){var n=null;function r(e,t,i){var r=ys(e.constructor);if(r){var a=fs(r,"proto"),s=fs(a,"properties");bs(e.constructor,s,t,n,i,r)}}return void 0===e?Ts({type:void 0}):void 0===t?(n=e,r):void r(e,t,i)}function Ss(e,t,i){return e((function(e,n){var r=ys(e);if(r){var a=void 0!==i?i:n,s=fs(r,"proto");fs(s,"editor")[t]=a}}),t)}function xs(e){return e(hs)}var As=xs(_s),ws=Ss(ps,"requireComponent"),Cs=xs(vs),Rs=Ss(gs,"executionOrder"),ks=xs(_s),Os=xs(_s),Is=xs(vs),Ms=xs(vs),Ls=xs(vs);var Ps=Ns(xt),Bs=Ns(At),Ds=Ns(wt),Fs=Ns(Ct);function Ns(e){return Ts({type:e})}var zs,Us,Gs,Vs,Hs,Ws,js,Xs=Object.freeze({__proto__:null,ccclass:Es,property:Ts,executeInEditMode:As,requireComponent:ws,menu:Cs,executionOrder:Rs,disallowMultiple:ks,playOnFocus:Os,inspector:Is,icon:Ms,help:Ls,mixins:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=t<0||arguments.length<=t?void 0:arguments[t];return function(t){var i=ys(t);i&&(fs(i,"proto").mixins=e)}},integer:Ps,float:Bs,boolean:Ds,string:Fs,type:Ns});e("_decorator",Xs);var qs=e("PrefabInfo",Es("cc.PrefabInfo")((Gs=v((Us=function e(){i(this,e),m(this,"root",Gs,this),m(this,"asset",Vs,this),m(this,"fileId",Hs,this),m(this,"sync",Ws,this),m(this,"_synced",js,this)}).prototype,"root",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Vs=v(Us.prototype,"asset",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Hs=v(Us.prototype,"fileId",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Ws=v(Us.prototype,"sync",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),js=v(Us.prototype,"_synced",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{default:!1,serializable:!1}}}),zs=Us))||zs);cc._PrefabInfo=qs;var Ys,Ks,Zs=function(){function e(){i(this,e),this._arrayBufferOrPaddings=[],this._length=0}return r(e,[{key:"setNextAlignment",value:function(e){if(0!==e){var t=this._length%e;if(0!==t){var i=e-t;this._arrayBufferOrPaddings.push(i),this._length+=i}}}},{key:"addBuffer",value:function(e){var t=this._length;return this._arrayBufferOrPaddings.push(e),this._length+=e.byteLength,t}},{key:"getLength",value:function(){return this._length}},{key:"getCombined",value:function(){var e=new Uint8Array(this._length),t=0;return this._arrayBufferOrPaddings.forEach((function(i){"number"==typeof i?t+=i:(e.set(new Uint8Array(i),t),t+=i.byteLength)})),e.buffer}}]),e}(),Qs=e("GFX_MAX_VERTEX_ATTRIBUTES",16),Js=e("GFX_MAX_TEXTURE_UNITS",16),$s=e("GFX_MAX_ATTACHMENTS",4),eo=e("GFX_MAX_BUFFER_BINDINGS",24);!function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.BUFFER=1]="BUFFER",e[e.TEXTURE=2]="TEXTURE",e[e.TEXTURE_VIEW=3]="TEXTURE_VIEW",e[e.RENDER_PASS=4]="RENDER_PASS",e[e.FRAMEBUFFER=5]="FRAMEBUFFER",e[e.SAMPLER=6]="SAMPLER",e[e.SHADER=7]="SHADER",e[e.PIPELINE_LAYOUT=8]="PIPELINE_LAYOUT",e[e.PIPELINE_STATE=9]="PIPELINE_STATE",e[e.BINDING_LAYOUT=10]="BINDING_LAYOUT",e[e.INPUT_ASSEMBLER=11]="INPUT_ASSEMBLER",e[e.COMMAND_ALLOCATOR=12]="COMMAND_ALLOCATOR",e[e.COMMAND_BUFFER=13]="COMMAND_BUFFER",e[e.QUEUE=14]="QUEUE",e[e.WINDOW=15]="WINDOW"}(Ys||(Ys=e("GFXObjectType",{}))),function(e){e[e.UNREADY=0]="UNREADY",e[e.FAILED=1]="FAILED",e[e.SUCCESS=2]="SUCCESS"}(Ks||(Ks=e("GFXStatus",{})));var to,io,no,ro,ao,so,oo,lo,uo,co,ho,fo,_o,po,mo,vo,go,yo,bo,Eo,To,So,xo,Ao,wo,Co,Ro,ko,Oo,Io,Mo,Lo,Po,Bo,Do=e("GFXObject",function(){function e(t){i(this,e),this._gfxType=Ys.UNKNOWN,this._status=Ks.UNREADY,this._gfxType=t}return r(e,[{key:"gfxType",get:function(){return this._gfxType}},{key:"status",get:function(){return this._status}}]),e}());!function(e){e.ATTR_POSITION="a_position",e.ATTR_NORMAL="a_normal",e.ATTR_TANGENT="a_tangent",e.ATTR_BITANGENT="a_bitangent",e.ATTR_WEIGHTS="a_weights",e.ATTR_JOINTS="a_joints",e.ATTR_COLOR="a_color",e.ATTR_COLOR1="a_color1",e.ATTR_COLOR2="a_color2",e.ATTR_TEX_COORD="a_texCoord",e.ATTR_TEX_COORD1="a_texCoord1",e.ATTR_TEX_COORD2="a_texCoord2",e.ATTR_TEX_COORD3="a_texCoord3",e.ATTR_TEX_COORD4="a_texCoord4",e.ATTR_TEX_COORD5="a_texCoord5",e.ATTR_TEX_COORD6="a_texCoord6",e.ATTR_TEX_COORD7="a_texCoord7",e.ATTR_TEX_COORD8="a_texCoord8",e.ATTR_BATCH_ID="a_batch_id",e.ATTR_BATCH_UV="a_batch_uv"}(to||(to=e("GFXAttributeName",{}))),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.BOOL=1]="BOOL",e[e.BOOL2=2]="BOOL2",e[e.BOOL3=3]="BOOL3",e[e.BOOL4=4]="BOOL4",e[e.INT=5]="INT",e[e.INT2=6]="INT2",e[e.INT3=7]="INT3",e[e.INT4=8]="INT4",e[e.UINT=9]="UINT",e[e.UINT2=10]="UINT2",e[e.UINT3=11]="UINT3",e[e.UINT4=12]="UINT4",e[e.FLOAT=13]="FLOAT",e[e.FLOAT2=14]="FLOAT2",e[e.FLOAT3=15]="FLOAT3",e[e.FLOAT4=16]="FLOAT4",e[e.MAT2=17]="MAT2",e[e.MAT2X3=18]="MAT2X3",e[e.MAT2X4=19]="MAT2X4",e[e.MAT3X2=20]="MAT3X2",e[e.MAT3=21]="MAT3",e[e.MAT3X4=22]="MAT3X4",e[e.MAT4X2=23]="MAT4X2",e[e.MAT4X3=24]="MAT4X3",e[e.MAT4=25]="MAT4",e[e.SAMPLER1D=26]="SAMPLER1D",e[e.SAMPLER1D_ARRAY=27]="SAMPLER1D_ARRAY",e[e.SAMPLER2D=28]="SAMPLER2D",e[e.SAMPLER2D_ARRAY=29]="SAMPLER2D_ARRAY",e[e.SAMPLER3D=30]="SAMPLER3D",e[e.SAMPLER_CUBE=31]="SAMPLER_CUBE",e[e.COUNT=32]="COUNT"}(io||(io=e("GFXType",{}))),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.A8=1]="A8",e[e.L8=2]="L8",e[e.LA8=3]="LA8",e[e.R8=4]="R8",e[e.R8SN=5]="R8SN",e[e.R8UI=6]="R8UI",e[e.R8I=7]="R8I",e[e.R16F=8]="R16F",e[e.R16UI=9]="R16UI",e[e.R16I=10]="R16I",e[e.R32F=11]="R32F",e[e.R32UI=12]="R32UI",e[e.R32I=13]="R32I",e[e.RG8=14]="RG8",e[e.RG8SN=15]="RG8SN",e[e.RG8UI=16]="RG8UI",e[e.RG8I=17]="RG8I",e[e.RG16F=18]="RG16F",e[e.RG16UI=19]="RG16UI",e[e.RG16I=20]="RG16I",e[e.RG32F=21]="RG32F",e[e.RG32UI=22]="RG32UI",e[e.RG32I=23]="RG32I",e[e.RGB8=24]="RGB8",e[e.SRGB8=25]="SRGB8",e[e.RGB8SN=26]="RGB8SN",e[e.RGB8UI=27]="RGB8UI",e[e.RGB8I=28]="RGB8I",e[e.RGB16F=29]="RGB16F",e[e.RGB16UI=30]="RGB16UI",e[e.RGB16I=31]="RGB16I",e[e.RGB32F=32]="RGB32F",e[e.RGB32UI=33]="RGB32UI",e[e.RGB32I=34]="RGB32I",e[e.RGBA8=35]="RGBA8",e[e.SRGB8_A8=36]="SRGB8_A8",e[e.RGBA8SN=37]="RGBA8SN",e[e.RGBA8UI=38]="RGBA8UI",e[e.RGBA8I=39]="RGBA8I",e[e.RGBA16F=40]="RGBA16F",e[e.RGBA16UI=41]="RGBA16UI",e[e.RGBA16I=42]="RGBA16I",e[e.RGBA32F=43]="RGBA32F",e[e.RGBA32UI=44]="RGBA32UI",e[e.RGBA32I=45]="RGBA32I",e[e.R5G6B5=46]="R5G6B5",e[e.R11G11B10F=47]="R11G11B10F",e[e.RGB5A1=48]="RGB5A1",e[e.RGBA4=49]="RGBA4",e[e.RGB10A2=50]="RGB10A2",e[e.RGB10A2UI=51]="RGB10A2UI",e[e.RGB9E5=52]="RGB9E5",e[e.D16=53]="D16",e[e.D16S8=54]="D16S8",e[e.D24=55]="D24",e[e.D24S8=56]="D24S8",e[e.D32F=57]="D32F",e[e.D32F_S8=58]="D32F_S8",e[e.BC1=59]="BC1",e[e.BC1_ALPHA=60]="BC1_ALPHA",e[e.BC1_SRGB=61]="BC1_SRGB",e[e.BC1_SRGB_ALPHA=62]="BC1_SRGB_ALPHA",e[e.BC2=63]="BC2",e[e.BC2_SRGB=64]="BC2_SRGB",e[e.BC3=65]="BC3",e[e.BC3_SRGB=66]="BC3_SRGB",e[e.BC4=67]="BC4",e[e.BC4_SNORM=68]="BC4_SNORM",e[e.BC5=69]="BC5",e[e.BC5_SNORM=70]="BC5_SNORM",e[e.BC6H_UF16=71]="BC6H_UF16",e[e.BC6H_SF16=72]="BC6H_SF16",e[e.BC7=73]="BC7",e[e.BC7_SRGB=74]="BC7_SRGB",e[e.ETC_RGB8=75]="ETC_RGB8",e[e.ETC2_RGB8=76]="ETC2_RGB8",e[e.ETC2_SRGB8=77]="ETC2_SRGB8",e[e.ETC2_RGB8_A1=78]="ETC2_RGB8_A1",e[e.ETC2_SRGB8_A1=79]="ETC2_SRGB8_A1",e[e.ETC2_RGBA8=80]="ETC2_RGBA8",e[e.ETC2_SRGB8_A8=81]="ETC2_SRGB8_A8",e[e.EAC_R11=82]="EAC_R11",e[e.EAC_R11SN=83]="EAC_R11SN",e[e.EAC_RG11=84]="EAC_RG11",e[e.EAC_RG11SN=85]="EAC_RG11SN",e[e.PVRTC_RGB2=86]="PVRTC_RGB2",e[e.PVRTC_RGBA2=87]="PVRTC_RGBA2",e[e.PVRTC_RGB4=88]="PVRTC_RGB4",e[e.PVRTC_RGBA4=89]="PVRTC_RGBA4",e[e.PVRTC2_2BPP=90]="PVRTC2_2BPP",e[e.PVRTC2_4BPP=91]="PVRTC2_4BPP"}(no||(no=e("GFXFormat",{}))),function(e){e[e.NONE=0]="NONE",e[e.TRANSFER_SRC=1]="TRANSFER_SRC",e[e.TRANSFER_DST=2]="TRANSFER_DST",e[e.INDEX=4]="INDEX",e[e.VERTEX=8]="VERTEX",e[e.UNIFORM=16]="UNIFORM",e[e.STORAGE=32]="STORAGE",e[e.INDIRECT=64]="INDIRECT"}(ro||(ro=e("GFXBufferUsageBit",{}))),function(e){e[e.NONE=0]="NONE",e[e.DEVICE=1]="DEVICE",e[e.HOST=2]="HOST"}(ao||(ao=e("GFXMemoryUsageBit",{}))),function(e){e[e.NONE=0]="NONE",e[e.BAKUP_BUFFER=4]="BAKUP_BUFFER"}(so||(so=e("GFXBufferFlagBit",{}))),function(e){e[e.NONE=0]="NONE",e[e.READ=1]="READ",e[e.WRITE=2]="WRITE"}(oo||(oo=e("GFXBufferAccessBit",{}))),function(e){e[e.POINT_LIST=0]="POINT_LIST",e[e.LINE_LIST=1]="LINE_LIST",e[e.LINE_STRIP=2]="LINE_STRIP",e[e.LINE_LOOP=3]="LINE_LOOP",e[e.LINE_LIST_ADJACENCY=4]="LINE_LIST_ADJACENCY",e[e.LINE_STRIP_ADJACENCY=5]="LINE_STRIP_ADJACENCY",e[e.ISO_LINE_LIST=6]="ISO_LINE_LIST",e[e.TRIANGLE_LIST=7]="TRIANGLE_LIST",e[e.TRIANGLE_STRIP=8]="TRIANGLE_STRIP",e[e.TRIANGLE_FAN=9]="TRIANGLE_FAN",e[e.TRIANGLE_LIST_ADJACENCY=10]="TRIANGLE_LIST_ADJACENCY",e[e.TRIANGLE_STRIP_ADJACENCY=11]="TRIANGLE_STRIP_ADJACENCY",e[e.TRIANGLE_PATCH_ADJACENCY=12]="TRIANGLE_PATCH_ADJACENCY",e[e.QUAD_PATCH_LIST=13]="QUAD_PATCH_LIST"}(lo||(lo=e("GFXPrimitiveMode",{}))),function(e){e[e.FILL=0]="FILL",e[e.POINT=1]="POINT",e[e.LINE=2]="LINE"}(uo||(uo=e("GFXPolygonMode",{}))),function(e){e[e.GOURAND=0]="GOURAND",e[e.FLAT=1]="FLAT"}(co||(co=e("GFXShadeModel",{}))),function(e){e[e.NONE=0]="NONE",e[e.FRONT=1]="FRONT",e[e.BACK=2]="BACK"}(ho||(ho=e("GFXCullMode",{}))),function(e){e[e.NEVER=0]="NEVER",e[e.LESS=1]="LESS",e[e.EQUAL=2]="EQUAL",e[e.LESS_EQUAL=3]="LESS_EQUAL",e[e.GREATER=4]="GREATER",e[e.NOT_EQUAL=5]="NOT_EQUAL",e[e.GREATER_EQUAL=6]="GREATER_EQUAL",e[e.ALWAYS=7]="ALWAYS"}(fo||(fo=e("GFXComparisonFunc",{}))),function(e){e[e.ZERO=0]="ZERO",e[e.KEEP=1]="KEEP",e[e.REPLACE=2]="REPLACE",e[e.INCR=3]="INCR",e[e.DECR=4]="DECR",e[e.INVERT=5]="INVERT",e[e.INCR_WRAP=6]="INCR_WRAP",e[e.DECR_WRAP=7]="DECR_WRAP"}(_o||(_o=e("GFXStencilOp",{}))),function(e){e[e.ADD=0]="ADD",e[e.SUB=1]="SUB",e[e.REV_SUB=2]="REV_SUB",e[e.MIN=3]="MIN",e[e.MAX=4]="MAX"}(po||(po=e("GFXBlendOp",{}))),function(e){e[e.ZERO=0]="ZERO",e[e.ONE=1]="ONE",e[e.SRC_ALPHA=2]="SRC_ALPHA",e[e.DST_ALPHA=3]="DST_ALPHA",e[e.ONE_MINUS_SRC_ALPHA=4]="ONE_MINUS_SRC_ALPHA",e[e.ONE_MINUS_DST_ALPHA=5]="ONE_MINUS_DST_ALPHA",e[e.SRC_COLOR=6]="SRC_COLOR",e[e.DST_COLOR=7]="DST_COLOR",e[e.ONE_MINUS_SRC_COLOR=8]="ONE_MINUS_SRC_COLOR",e[e.ONE_MINUS_DST_COLOR=9]="ONE_MINUS_DST_COLOR",e[e.SRC_ALPHA_SATURATE=10]="SRC_ALPHA_SATURATE",e[e.CONSTANT_COLOR=11]="CONSTANT_COLOR",e[e.ONE_MINUS_CONSTANT_COLOR=12]="ONE_MINUS_CONSTANT_COLOR",e[e.CONSTANT_ALPHA=13]="CONSTANT_ALPHA",e[e.ONE_MINUS_CONSTANT_ALPHA=14]="ONE_MINUS_CONSTANT_ALPHA"}(mo||(mo=e("GFXBlendFactor",{}))),function(e){e[e.NONE=0]="NONE",e[e.R=1]="R",e[e.G=2]="G",e[e.B=4]="B",e[e.A=8]="A",e[e.ALL=15]="ALL"}(vo||(vo=e("GFXColorMask",{}))),function(e){e[e.NONE=0]="NONE",e[e.POINT=1]="POINT",e[e.LINEAR=2]="LINEAR",e[e.ANISOTROPIC=3]="ANISOTROPIC"}(go||(go=e("GFXFilter",{}))),function(e){e[e.WRAP=0]="WRAP",e[e.MIRROR=1]="MIRROR",e[e.CLAMP=2]="CLAMP",e[e.BORDER=3]="BORDER"}(yo||(yo=e("GFXAddress",{}))),function(e){e[e.TEX1D=0]="TEX1D",e[e.TEX2D=1]="TEX2D",e[e.TEX3D=2]="TEX3D"}(bo||(bo=e("GFXTextureType",{}))),function(e){e[e.NONE=0]="NONE",e[e.TRANSFER_SRC=1]="TRANSFER_SRC",e[e.TRANSFER_DST=2]="TRANSFER_DST",e[e.SAMPLED=4]="SAMPLED",e[e.STORAGE=8]="STORAGE",e[e.COLOR_ATTACHMENT=16]="COLOR_ATTACHMENT",e[e.DEPTH_STENCIL_ATTACHMENT=32]="DEPTH_STENCIL_ATTACHMENT",e[e.TRANSIENT_ATTACHMENT=64]="TRANSIENT_ATTACHMENT",e[e.INPUT_ATTACHMENT=128]="INPUT_ATTACHMENT"}(Eo||(Eo=e("GFXTextureUsageBit",{}))),function(e){e[e.X1=0]="X1",e[e.X2=1]="X2",e[e.X4=2]="X4",e[e.X8=3]="X8",e[e.X16=4]="X16",e[e.X32=5]="X32",e[e.X64=6]="X64"}(To||(To=e("GFXSampleCount",{}))),function(e){e[e.NONE=0]="NONE",e[e.GEN_MIPMAP=1]="GEN_MIPMAP",e[e.CUBEMAP=2]="CUBEMAP",e[e.BAKUP_BUFFER=4]="BAKUP_BUFFER"}(So||(So=e("GFXTextureFlagBit",{}))),function(e){e[e.TV1D=0]="TV1D",e[e.TV2D=1]="TV2D",e[e.TV3D=2]="TV3D",e[e.CUBE=3]="CUBE",e[e.TV1D_ARRAY=4]="TV1D_ARRAY",e[e.TV2D_ARRAY=5]="TV2D_ARRAY"}(xo||(xo=e("GFXTextureViewType",{}))),function(e){e[e.VERTEX=0]="VERTEX",e[e.HULL=1]="HULL",e[e.DOMAIN=2]="DOMAIN",e[e.GEOMETRY=3]="GEOMETRY",e[e.FRAGMENT=4]="FRAGMENT",e[e.COMPUTE=5]="COMPUTE",e[e.COUNT=6]="COUNT"}(Ao||(Ao=e("GFXShaderType",{}))),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.UNIFORM_BUFFER=1]="UNIFORM_BUFFER",e[e.SAMPLER=2]="SAMPLER",e[e.STORAGE_BUFFER=3]="STORAGE_BUFFER"}(wo||(wo=e("GFXBindingType",{}))),function(e){e[e.PRIMARY=0]="PRIMARY",e[e.SECONDARY=1]="SECONDARY"}(Co||(Co=e("GFXCommandBufferType",{}))),function(e){e[e.LOAD=0]="LOAD",e[e.CLEAR=1]="CLEAR",e[e.DISCARD=2]="DISCARD"}(Ro||(Ro=e("GFXLoadOp",{}))),function(e){e[e.STORE=0]="STORE",e[e.DISCARD=1]="DISCARD"}(ko||(ko=e("GFXStoreOp",{}))),function(e){e[e.UNDEFINED=0]="UNDEFINED",e[e.GENERAL=1]="GENERAL",e[e.COLOR_ATTACHMENT_OPTIMAL=2]="COLOR_ATTACHMENT_OPTIMAL",e[e.DEPTH_STENCIL_ATTACHMENT_OPTIMAL=3]="DEPTH_STENCIL_ATTACHMENT_OPTIMAL",e[e.DEPTH_STENCIL_READONLY_OPTIMAL=4]="DEPTH_STENCIL_READONLY_OPTIMAL",e[e.SHADER_READONLY_OPTIMAL=5]="SHADER_READONLY_OPTIMAL",e[e.TRANSFER_SRC_OPTIMAL=6]="TRANSFER_SRC_OPTIMAL",e[e.TRANSFER_DST_OPTIMAL=7]="TRANSFER_DST_OPTIMAL",e[e.PREINITIALIZED=8]="PREINITIALIZED",e[e.PRESENT_SRC=9]="PRESENT_SRC"}(Oo||(Oo=e("GFXTextureLayout",{}))),function(e){e[e.GRAPHICS=0]="GRAPHICS",e[e.COMPUTE=1]="COMPUTE",e[e.RAY_TRACING=2]="RAY_TRACING"}(Io||(Io=e("GFXPipelineBindPoint",{}))),function(e){e[e.VIEWPORT=0]="VIEWPORT",e[e.SCISSOR=1]="SCISSOR",e[e.LINE_WIDTH=2]="LINE_WIDTH",e[e.DEPTH_BIAS=3]="DEPTH_BIAS",e[e.BLEND_CONSTANTS=4]="BLEND_CONSTANTS",e[e.DEPTH_BOUNDS=5]="DEPTH_BOUNDS",e[e.STENCIL_WRITE_MASK=6]="STENCIL_WRITE_MASK",e[e.STENCIL_COMPARE_MASK=7]="STENCIL_COMPARE_MASK"}(Mo||(Mo=e("GFXDynamicState",{}))),function(e){e[e.FRONT=0]="FRONT",e[e.BACK=1]="BACK",e[e.ALL=2]="ALL"}(Lo||(Lo=e("GFXStencilFace",{}))),function(e){e[e.GRAPHICS=0]="GRAPHICS",e[e.COMPUTE=1]="COMPUTE",e[e.TRANSFER=2]="TRANSFER"}(Po||(Po=e("GFXQueueType",{}))),function(e){e[e.NONE=0]="NONE",e[e.COLOR=1]="COLOR",e[e.DEPTH=2]="DEPTH",e[e.STENCIL=4]="STENCIL",e[e.DEPTH_STENCIL=6]="DEPTH_STENCIL",e[e.ALL=7]="ALL"}(Bo||(Bo=e("GFXClearFlag",{})));var Fo,No=e("GFXTextureSubres",(function e(){i(this,e),this.baseMipLevel=0,this.levelCount=1,this.baseArrayLayer=0,this.layerCount=1})),zo=e("GFXTextureCopy",(function e(){i(this,e),this.srcSubres=new No,this.srcOffset={x:0,y:0,z:0},this.dstSubres=new No,this.dstOffset={x:0,y:0,z:0},this.extent={width:0,height:0,depth:0}})),Uo=e("GFXBufferTextureCopy",(function e(){i(this,e),this.buffOffset=0,this.buffStride=0,this.buffTexHeight=0,this.texOffset={x:0,y:0,z:0},this.texExtent={width:0,height:0,depth:0},this.texSubres=new No}));!function(e){e[e.NONE=0]="NONE",e[e.UNORM=1]="UNORM",e[e.SNORM=2]="SNORM",e[e.UINT=3]="UINT",e[e.INT=4]="INT",e[e.UFLOAT=5]="UFLOAT",e[e.FLOAT=6]="FLOAT"}(Fo||(Fo=e("GFXFormatType",{})));var Go=e("GFXFormatInfos",[{name:"UNKNOWN",size:0,count:0,type:Fo.NONE,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"A8",size:1,count:1,type:Fo.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"L8",size:1,count:1,type:Fo.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"LA8",size:1,count:2,type:Fo.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R8",size:1,count:1,type:Fo.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R8SN",size:1,count:1,type:Fo.SNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R8UI",size:1,count:1,type:Fo.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R8I",size:1,count:1,type:Fo.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R16F",size:2,count:1,type:Fo.FLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R16UI",size:2,count:1,type:Fo.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R16I",size:2,count:1,type:Fo.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R32F",size:4,count:1,type:Fo.FLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R32UI",size:4,count:1,type:Fo.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R32I",size:4,count:1,type:Fo.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG8",size:2,count:2,type:Fo.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG8SN",size:2,count:2,type:Fo.SNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG8UI",size:2,count:2,type:Fo.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG8I",size:2,count:2,type:Fo.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG16F",size:4,count:2,type:Fo.FLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG16UI",size:4,count:2,type:Fo.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG16I",size:4,count:2,type:Fo.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG32F",size:8,count:2,type:Fo.FLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG32UI",size:8,count:2,type:Fo.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG32I",size:8,count:2,type:Fo.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB8",size:3,count:3,type:Fo.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"SRGB8",size:3,count:3,type:Fo.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB8SN",size:3,count:3,type:Fo.SNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB8UI",size:3,count:3,type:Fo.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB8I",size:3,count:3,type:Fo.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB16F",size:6,count:3,type:Fo.FLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB16UI",size:6,count:3,type:Fo.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB16I",size:6,count:3,type:Fo.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB32F",size:12,count:3,type:Fo.FLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB32UI",size:12,count:3,type:Fo.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB32I",size:12,count:3,type:Fo.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA8",size:4,count:4,type:Fo.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"SRGB8_A8",size:4,count:4,type:Fo.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA8SN",size:4,count:4,type:Fo.SNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA8UI",size:4,count:4,type:Fo.UINT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA8I",size:4,count:4,type:Fo.INT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA16F",size:8,count:4,type:Fo.FLOAT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA16UI",size:8,count:4,type:Fo.UINT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA16I",size:8,count:4,type:Fo.INT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA32F",size:16,count:4,type:Fo.FLOAT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA32UI",size:16,count:4,type:Fo.UINT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA32I",size:16,count:4,type:Fo.INT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R5G6B5",size:2,count:3,type:Fo.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R11G11B10F",size:4,count:3,type:Fo.FLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB5A1",size:2,count:4,type:Fo.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA4",size:2,count:4,type:Fo.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB10A2",size:2,count:4,type:Fo.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB10A2UI",size:2,count:4,type:Fo.UINT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB9E5",size:2,count:4,type:Fo.FLOAT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"D16",size:2,count:1,type:Fo.UINT,hasAlpha:!1,hasDepth:!0,hasStencil:!1,isCompressed:!1},{name:"D16S8",size:3,count:2,type:Fo.UINT,hasAlpha:!1,hasDepth:!0,hasStencil:!0,isCompressed:!1},{name:"D24",size:3,count:1,type:Fo.UINT,hasAlpha:!1,hasDepth:!0,hasStencil:!1,isCompressed:!1},{name:"D24S8",size:4,count:2,type:Fo.UINT,hasAlpha:!1,hasDepth:!0,hasStencil:!0,isCompressed:!1},{name:"D32F",size:4,count:1,type:Fo.FLOAT,hasAlpha:!1,hasDepth:!0,hasStencil:!1,isCompressed:!1},{name:"D32FS8",size:5,count:2,type:Fo.FLOAT,hasAlpha:!1,hasDepth:!0,hasStencil:!0,isCompressed:!1},{name:"BC1",size:1,count:3,type:Fo.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC1_ALPHA",size:1,count:4,type:Fo.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC1_SRGB",size:1,count:3,type:Fo.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC1_SRGB_ALPHA",size:1,count:4,type:Fo.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC2",size:1,count:4,type:Fo.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC2_SRGB",size:1,count:4,type:Fo.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC3",size:1,count:4,type:Fo.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC3_SRGB",size:1,count:4,type:Fo.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC4",size:1,count:1,type:Fo.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC4_SNORM",size:1,count:1,type:Fo.SNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC5",size:1,count:2,type:Fo.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC5_SNORM",size:1,count:2,type:Fo.SNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC6H_UF16",size:1,count:3,type:Fo.UFLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC6H_SF16",size:1,count:3,type:Fo.FLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC7",size:1,count:4,type:Fo.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC7_SRGB",size:1,count:4,type:Fo.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"ETC_RGB8",size:1,count:3,type:Fo.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"ETC2_RGB8",size:1,count:3,type:Fo.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"ETC2_SRGB8",size:1,count:3,type:Fo.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"ETC2_RGB8_A1",size:1,count:4,type:Fo.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"ETC2_SRGB8_A1",size:1,count:4,type:Fo.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"ETC2_RGBA8",size:2,count:4,type:Fo.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"ETC2_SRGB8_A8",size:2,count:4,type:Fo.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"EAC_R11",size:1,count:1,type:Fo.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"EAC_R11SN",size:1,count:1,type:Fo.SNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"EAC_RG11",size:2,count:2,type:Fo.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"EAC_RG11SN",size:2,count:2,type:Fo.SNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"PVRTC_RGB2",size:2,count:3,type:Fo.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"PVRTC_RGBA2",size:2,count:4,type:Fo.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"PVRTC_RGB4",size:2,count:3,type:Fo.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"PVRTC_RGBA4",size:2,count:4,type:Fo.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"PVRTC2_2BPP",size:2,count:4,type:Fo.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"PVRTC2_4BPP",size:2,count:4,type:Fo.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0}]);function Vo(e,t,i,n){if(!Go[e].isCompressed)return t*i*n*Go[e].size;switch(e){case no.BC1:case no.BC1_ALPHA:case no.BC1_SRGB:case no.BC1_SRGB_ALPHA:return Math.ceil(t/4)*Math.ceil(i/4)*8*n;case no.BC2:case no.BC2_SRGB:case no.BC3:case no.BC3_SRGB:case no.BC4:case no.BC4_SNORM:case no.BC6H_SF16:case no.BC6H_UF16:case no.BC7:case no.BC7_SRGB:return Math.ceil(t/4)*Math.ceil(i/4)*16*n;case no.BC5:case no.BC5_SNORM:return Math.ceil(t/4)*Math.ceil(i/4)*32*n;case no.ETC_RGB8:case no.ETC2_RGB8:case no.ETC2_SRGB8:case no.ETC2_RGB8_A1:case no.ETC2_SRGB8_A1:case no.EAC_R11:case no.EAC_R11SN:return Math.ceil(t/4)*Math.ceil(i/4)*8*n;case no.EAC_RG11:case no.EAC_RG11SN:return Math.ceil(t/4)*Math.ceil(i/4)*16*n;case no.PVRTC_RGB2:case no.PVRTC_RGBA2:case no.PVRTC2_2BPP:return Math.ceil(Math.max(t,16)*Math.max(i,8)/4)*n;case no.PVRTC_RGB4:case no.PVRTC_RGBA4:case no.PVRTC2_4BPP:return Math.ceil(Math.max(t,16)*Math.max(i,8)/2)*n;default:return 0}}function Ho(e,t,i,n,r){for(var a=0,s=0;s<r;++s)a+=Vo(e,t,i,n),t=Math.max(t>>1,1),i=Math.max(i>>1,1),n=Math.max(n>>1,1);return a}var Wo=[0,4,8,12,16,4,8,12,16,4,8,12,16,4,8,12,16,16,24,32,24,36,48,32,48,64,4,4,4,4,4,4];function jo(e){return Wo[e]||0}var Xo,qo,Yo=Object.freeze({__proto__:null,GFX_MAX_VERTEX_ATTRIBUTES:Qs,GFX_MAX_TEXTURE_UNITS:Js,GFX_MAX_ATTACHMENTS:$s,GFX_MAX_BUFFER_BINDINGS:eo,get GFXObjectType(){return Ys},get GFXStatus(){return Ks},GFXObject:Do,get GFXAttributeName(){return to},get GFXType(){return io},get GFXFormat(){return no},get GFXBufferUsageBit(){return ro},get GFXMemoryUsageBit(){return ao},get GFXBufferFlagBit(){return so},get GFXBufferAccessBit(){return oo},get GFXPrimitiveMode(){return lo},get GFXPolygonMode(){return uo},get GFXShadeModel(){return co},get GFXCullMode(){return ho},get GFXComparisonFunc(){return fo},get GFXStencilOp(){return _o},get GFXBlendOp(){return po},get GFXBlendFactor(){return mo},get GFXColorMask(){return vo},get GFXFilter(){return go},get GFXAddress(){return yo},get GFXTextureType(){return bo},get GFXTextureUsageBit(){return Eo},get GFXSampleCount(){return To},get GFXTextureFlagBit(){return So},get GFXTextureViewType(){return xo},get GFXShaderType(){return Ao},get GFXBindingType(){return wo},get GFXCommandBufferType(){return Co},get GFXLoadOp(){return Ro},get GFXStoreOp(){return ko},get GFXTextureLayout(){return Oo},get GFXPipelineBindPoint(){return Io},get GFXDynamicState(){return Mo},get GFXStencilFace(){return Lo},get GFXQueueType(){return Po},get GFXClearFlag(){return Bo},GFXTextureSubres:No,GFXTextureCopy:zo,GFXBufferTextureCopy:Uo,get GFXFormatType(){return Fo},GFXFormatInfos:Go,GFXFormatSize:Vo,GFXFormatSurfaceSize:Ho,GFXGetTypeSize:jo});pt(no),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.WEBGL=1]="WEBGL",e[e.WEBGL2=2]="WEBGL2"}(Xo||(Xo=e("GFXAPI",{}))),function(e){e[e.COLOR_FLOAT=0]="COLOR_FLOAT",e[e.COLOR_HALF_FLOAT=1]="COLOR_HALF_FLOAT",e[e.TEXTURE_FLOAT=2]="TEXTURE_FLOAT",e[e.TEXTURE_HALF_FLOAT=3]="TEXTURE_HALF_FLOAT",e[e.TEXTURE_FLOAT_LINEAR=4]="TEXTURE_FLOAT_LINEAR",e[e.TEXTURE_HALF_FLOAT_LINEAR=5]="TEXTURE_HALF_FLOAT_LINEAR",e[e.FORMAT_R11G11B10F=6]="FORMAT_R11G11B10F",e[e.FORMAT_D24S8=7]="FORMAT_D24S8",e[e.FORMAT_ETC1=8]="FORMAT_ETC1",e[e.FORMAT_ETC2=9]="FORMAT_ETC2",e[e.FORMAT_DXT=10]="FORMAT_DXT",e[e.FORMAT_PVRTC=11]="FORMAT_PVRTC",e[e.FORMAT_ASTC=12]="FORMAT_ASTC",e[e.MSAA=13]="MSAA",e[e.COUNT=14]="COUNT",e[e.ELEMENT_INDEX_UINT=15]="ELEMENT_INDEX_UINT"}(qo||(qo=e("GFXFeature",{})));var Ko=e("GFXDevice",function(){function e(){i(this,e),this._canvas=null,this._canvas2D=null,this._gfxAPI=Xo.UNKNOWN,this._deviceName="",this._renderer="",this._vendor="",this._version="",this._features=new Array(qo.COUNT),this._queue=null,this._devicePixelRatio=1,this._width=0,this._height=0,this._nativeWidth=0,this._nativeHeight=0,this._mainWindow=null,this._cmdAllocator=null,this._maxVertexAttributes=0,this._maxVertexUniformVectors=0,this._maxFragmentUniformVectors=0,this._maxTextureUnits=0,this._maxVertexTextureUnits=0,this._maxUniformBufferBindings=eo,this._maxUniformBlockSize=0,this._maxTextureSize=0,this._maxCubeMapTextureSize=0,this._depthBits=0,this._stencilBits=0,this._colorFmt=no.UNKNOWN,this._depthStencilFmt=no.UNKNOWN,this._reverseCW=!1,this._shaderIdGen=0,this._macros=new Map,this._numDrawCalls=0,this._numTris=0,this._memoryStatus={bufferSize:0,textureSize:0}}return r(e,[{key:"hasFeature",value:function(e){return this._features[e]}},{key:"genShaderId",value:function(){return this._shaderIdGen++}},{key:"defineMacro",value:function(e,t){var i=void 0!==t?t:"";this._macros.set(e,i)}},{key:"canvas",get:function(){return this._canvas}},{key:"canvas2D",get:function(){return this._canvas2D}},{key:"gfxAPI",get:function(){return this._gfxAPI}},{key:"queue",get:function(){return this._queue}},{key:"devicePixelRatio",get:function(){return this._devicePixelRatio}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"nativeWidth",get:function(){return this._nativeWidth}},{key:"nativeHeight",get:function(){return this._nativeHeight}},{key:"mainWindow",get:function(){return this._mainWindow}},{key:"commandAllocator",get:function(){return this._cmdAllocator}},{key:"renderer",get:function(){return this._renderer}},{key:"vendor",get:function(){return this._vendor}},{key:"maxVertexAttributes",get:function(){return this._maxVertexAttributes}},{key:"maxVertexUniformVectors",get:function(){return this._maxVertexUniformVectors}},{key:"maxFragmentUniformVectors",get:function(){return this._maxFragmentUniformVectors}},{key:"maxTextureUnits",get:function(){return this._maxTextureUnits}},{key:"maxVertexTextureUnits",get:function(){return this._maxVertexTextureUnits}},{key:"maxUniformBufferBindings",get:function(){return this._maxUniformBufferBindings}},{key:"maxUniformBlockSize",get:function(){return this._maxUniformBlockSize}},{key:"maxTextureSize",get:function(){return this._maxTextureSize}},{key:"maxCubeMapTextureSize",get:function(){return this._maxCubeMapTextureSize}},{key:"depthBits",get:function(){return this._depthBits}},{key:"stencilBits",get:function(){return this._stencilBits}},{key:"colorFormat",get:function(){return this._colorFmt}},{key:"depthStencilFormat",get:function(){return this._depthStencilFmt}},{key:"macros",get:function(){return this._macros}},{key:"numDrawCalls",get:function(){return this._numDrawCalls}},{key:"numTris",get:function(){return this._numTris}},{key:"memoryStatus",get:function(){return this._memoryStatus}},{key:"reverseCW",get:function(){return this._reverseCW},set:function(e){this._reverseCW=e}}]),e}()),Zo=String.prototype.charCodeAt;function Qo(e){return this[e]}function Jo(e,t){for(var i=e.length,n=t^i,r=0,a="string"==typeof e?Zo:Qo;i>=4;){var s=255&a.call(e,r)|(255&a.call(e,++r))<<8|(255&a.call(e,++r))<<16|(255&a.call(e,++r))<<24;s=1540483477*(65535&s)+((1540483477*(s>>>16)&65535)<<16),n=1540483477*(65535&n)+((1540483477*(n>>>16)&65535)<<16)^(s=1540483477*(65535&(s^=s>>>24))+((1540483477*(s>>>16)&65535)<<16)),i-=4,++r}switch(i){case 3:n^=(255&a.call(e,r+2))<<16;case 2:n^=(255&a.call(e,r+1))<<8;case 1:n=1540483477*(65535&(n^=255&a.call(e,r)))+((1540483477*(n>>>16)&65535)<<16)}return n=1540483477*(65535&(n^=n>>>13))+((1540483477*(n>>>16)&65535)<<16),(n^=n>>>15)>>>0}var $o=Qe.fastRemoveAt;function el(){}var tl=function(){function e(){i(this,e),this.callback=el,this.target=void 0,this.once=!1}return r(e,[{key:"set",value:function(e,t,i){this.callback=e,this.target=t,this.once=!!i}}]),e}(),il=new Za((function(){return new tl}),32),nl=function(){function e(){i(this,e),this.callbackInfos=[],this.isInvoking=!1,this.containCanceled=!1}return r(e,[{key:"removeByCallback",value:function(e){for(var t=0;t<this.callbackInfos.length;++t){var i=this.callbackInfos[t];i&&i.callback===e&&(il.free(i),$o(this.callbackInfos,t),--t)}}},{key:"removeByTarget",value:function(e){for(var t=0;t<this.callbackInfos.length;++t){var i=this.callbackInfos[t];i&&i.target===e&&(il.free(i),$o(this.callbackInfos,t),--t)}}},{key:"cancel",value:function(e){var t=this.callbackInfos[e];t&&(il.free(t),this.callbackInfos[e]=null),this.containCanceled=!0}},{key:"cancelAll",value:function(){for(var e=0;e<this.callbackInfos.length;e++){var t=this.callbackInfos[e];t&&(il.free(t),this.callbackInfos[e]=null)}this.containCanceled=!0}},{key:"purgeCanceled",value:function(){for(var e=this.callbackInfos.length-1;e>=0;--e){this.callbackInfos[e]||$o(this.callbackInfos,e)}this.containCanceled=!1}},{key:"clear",value:function(){this.cancelAll(),this.callbackInfos.length=0,this.isInvoking=!1,this.containCanceled=!1}}]),e}(),rl=new Za((function(){return new nl}),16),al=function(){function e(){i(this,e),this._callbackTable=we(!0)}return r(e,[{key:"on",value:function(e,t,i,n){var r=this._callbackTable[e];r||(r=this._callbackTable[e]=rl.alloc());var a=il.alloc();a.set(t,i,n),r.callbackInfos.push(a)}},{key:"hasEventListener",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=this._callbackTable[e];if(!n)return!1;var r=n.callbackInfos;if(!t){if(n.isInvoking){var a=r,s=Array.isArray(a),o=0;for(a=s?a:a[Symbol.iterator]();;){var l;if(s){if(o>=a.length)break;l=a[o++]}else{if((o=a.next()).done)break;l=o.value}if(l)return!0}return!1}return r.length>0}var u=r,c=Array.isArray(u),h=0;for(u=c?u:u[Symbol.iterator]();;){var f;if(c){if(h>=u.length)break;f=u[h++]}else{if((h=u.next()).done)break;f=h.value}var _=f;if(_&&_.callback===t&&_.target===i)return!0}return!1}},{key:"removeAll",value:function(e){if("string"==typeof e){var t=this._callbackTable[e];t&&(t.isInvoking?t.cancelAll():(t.clear(),rl.free(t),delete this._callbackTable[e]))}else if(e)for(var i in this._callbackTable){var n=this._callbackTable[i];if(n.isInvoking)for(var r=n.callbackInfos,a=0;a<r.length;++a){var s=r[a];s&&s.target===e&&n.cancel(a)}else n.removeByTarget(e)}}},{key:"off",value:function(e,t,i){var n=this._callbackTable[e];if(n){var r=n.callbackInfos;if(t)for(var a=0;a<r.length;++a){var s=r[a];if(s&&s.callback===t&&s.target===i){n.isInvoking?n.cancel(a):($o(r,a),il.free(s));break}}else this.removeAll(e)}}},{key:"emit",value:function(e){var t=this._callbackTable[e];if(t){var i=!t.isInvoking;t.isInvoking=!0;for(var n=t.callbackInfos,r=arguments.length,a=new Array(r>1?r-1:0),s=1;s<r;s++)a[s-1]=arguments[s];for(var o=0,l=n.length;o<l;++o){var u=n[o];if(u){var c=u.callback,h=u.target;u.once&&this.off(e,c,h),h?c.call.apply(c,[h].concat(a)):c.apply(void 0,a)}}i&&(t.isInvoking=!1,t.containCanceled&&t.purgeCanceled())}}}]),e}();var sl=Qe.fastRemove,ol=e("EventTarget",function(e){function t(){return i(this,t),c(this,o(t).apply(this,arguments))}return s(t,e),r(t,[{key:"on",value:function(e,i,n){if(i){if(!this.hasEventListener(e,i,n)){f(o(t.prototype),"on",this).call(this,e,i,n);var r=n;n&&(r.__eventTargets?r.__eventTargets.push(this):r.node&&r.node.__eventTargets&&r.node.__eventTargets.push(this))}return i}cc.errorID(6800)}},{key:"off",value:function(e,i,n){if(i){f(o(t.prototype),"off",this).call(this,e,i,n);var r=n;n&&(r.__eventTargets?sl(r.__eventTargets,this):r.node&&r.node.__eventTargets&&sl(r.node.__eventTargets,this))}else this.removeAll(e)}},{key:"targetOff",value:function(e){this.removeAll(e)}},{key:"once",value:function(e,i,n){if(i){if(!this.hasEventListener(e,i,n)){f(o(t.prototype),"on",this).call(this,e,i,n,!0);var r=n;n&&(r.__eventTargets?r.__eventTargets.push(this):r.node&&r.node.__eventTargets&&r.node.__eventTargets.push(this))}return i}cc.errorID(6800)}}]),t}(al));function ll(e,t){t.forEach((function(t){Object.getOwnPropertyNames(t.prototype).forEach((function(i){"constructor"!==i&&Object.defineProperty(e.prototype,i,Object.getOwnPropertyDescriptor(t.prototype,i))}))}))}cc.EventTarget=ol;var ul=[];var cl,hl=e("CCObject",function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";i(this,e),this._name=t,this._objFlags=0}return r(e,null,[{key:"_deferredDestroy",value:function(){for(var e=ul.length,t=0;t<e;++t){var i=ul[t];1&i._objFlags||i._destroyImmediate()}e===ul.length?ul.length=0:ul.splice(0,e)}}]),r(e,[{key:"destroy",value:function(){return 1&this._objFlags?(N(5e3),!1):!(4&this._objFlags)&&(this._objFlags|=4,ul.push(this),!0)}},{key:"_destruct",value:function(){var e=this.constructor,i=e.__destruct__;i||(i=function(e,i){var n,r=e instanceof cc._BaseNode||e instanceof cc.Component,a=r?"_id":null,s={};for(n in e)if(e.hasOwnProperty(n)){if(n===a)continue;switch(t(e[n])){case"string":s[n]="";break;case"object":case"function":s[n]=null}}if(ri._isCCClass(i))for(var o=cc.Class.Attr.getClassAttrs(i),l=i.__props__,u=0;u<l.length;u++){var c=(n=l[u])+cc.Class.Attr.DELIMETER+"default";if(c in o){if(r&&"_id"===n)continue;switch(t(o[c])){case"string":s[n]="";break;case"object":case"function":s[n]=null;break;case"undefined":s[n]=void 0}}}var h="";for(n in s){var f=void 0;f=ri.IDENTIFIER_RE.test(n)?"o."+n+"=":"o["+ri.escapeForJS(n)+"]=";var _=s[n];""===_&&(_='""'),h+=f+_+";\n"}return Function("o",h)}(this,e),Te(e,"__destruct__",i,!0)),i(this)}},{key:"_destroyImmediate",value:function(){1&this._objFlags?U(5e3):(this._onPreDestroy&&this._onPreDestroy(),this._destruct(),this._objFlags|=1)}},{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"isValid",get:function(){return!(1&this._objFlags)}}]),e}()),fl=hl.prototype;function _l(e,i){return"object"===t(e)?!(!e||e._objFlags&(i?5:1)):void 0!==e}fl._deserialize=null,fl._onPreDestroy=null,ri.fastDefine("cc.Object",hl,{_name:"",_objFlags:0}),Te(hl,"Flags",{Destroyed:1,DontSave:8,EditorOnly:16,Dirty:32,DontDestroy:64,PersistentMask:-4192741,Destroying:128,Deactivating:256,LockedInEditor:512,HideInHierarchy:1024,IsPreloadStarted:8192,IsOnLoadStarted:32768,IsOnLoadCalled:16384,IsOnEnableCalled:2048,IsStartCalled:65536,IsEditorOnEnableCalled:4096,IsPositionLocked:1<<21,IsRotationLocked:1<<17,IsScaleLocked:1<<18,IsAnchorLocked:1<<19,IsSizeLocked:1<<20}),cc.isValid=_l,cc.Object=hl;var dl,pl,ml,vl,gl,yl,bl,El=e("RawAsset",Es("cc.RawAsset")(cl=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),s=0;s<r;s++)a[s]=arguments[s];return n=c(this,(e=o(t)).call.apply(e,[this].concat(a))),Object.defineProperty(u(n),"_uuid",{value:"",writable:!0}),n}return s(t,e),r(t,null,[{key:"isRawAssetType",value:function(e){return Ue(e,cc.RawAsset)&&!Ue(e,cc.Asset)}}]),t}(hl))||cl);cc.RawAsset=El;var Tl=e("Asset",(dl=Es("cc.Asset"),pl=Ts({visible:!1}),dl((bl=yl=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),s=0;s<r;s++)a[s]=arguments[s];return(n=c(this,(e=o(t)).call.apply(e,[this].concat(a)))).loaded=!0,m(n,"_native",gl,u(n)),n._file=null,n._callbackTable=we(!0),n}return s(t,e),r(t,null,[{key:"deserialize",value:function(e){return cc.deserialize(e)}}]),r(t,[{key:"on",value:function(e,t,i){}},{key:"off",value:function(e,t,i){}},{key:"targetOff",value:function(e){}},{key:"once",value:function(e,t,i){}},{key:"dispatchEvent",value:function(e){}},{key:"hasEventListener",value:function(e,t,i){return!1}},{key:"removeAll",value:function(e){}},{key:"emit",value:function(e){}},{key:"toString",value:function(){return this.nativeUrl}},{key:"_setRawAsset",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this._native=!1!==t?e||"":"/"+e}},{key:"nativeUrl",get:function(){if(this._native){var e=this._native;if(47===e.charCodeAt(0))return e.slice(1);if(cc.AssetLibrary){var t=cc.AssetLibrary.getLibUrlNoExt(this._uuid,!0);return 46===e.charCodeAt(0)?t+e:t+"/"+e}cc.errorID(6400)}return""}},{key:"_nativeAsset",get:function(){return this._file},set:function(e){this._file=e}}]),t}(El),yl.preventDeferredLoadDependents=!1,yl.preventPreloadNativeObject=!1,gl=v((vl=bl).prototype,"_native",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),v(vl.prototype,"nativeUrl",[pl],Object.getOwnPropertyDescriptor(vl.prototype,"nativeUrl"),vl.prototype),v(vl.prototype,"_nativeAsset",[Ts],Object.getOwnPropertyDescriptor(vl.prototype,"_nativeAsset"),vl.prototype),ml=vl))||ml));ll(Tl,[al,ol]),Tl.prototype.createNode=null,cc.Asset=Tl;var Sl,xl,Al,wl,Cl,Rl,kl,Ol,Il={},Ml="undefined"==typeof window?global:window;if(Il.LANGUAGE_ENGLISH="en",Il.LANGUAGE_CHINESE="zh",Il.LANGUAGE_FRENCH="fr",Il.LANGUAGE_ITALIAN="it",Il.LANGUAGE_GERMAN="de",Il.LANGUAGE_SPANISH="es",Il.LANGUAGE_DUTCH="du",Il.LANGUAGE_RUSSIAN="ru",Il.LANGUAGE_KOREAN="ko",Il.LANGUAGE_JAPANESE="ja",Il.LANGUAGE_HUNGARIAN="hu",Il.LANGUAGE_PORTUGUESE="pt",Il.LANGUAGE_ARABIC="ar",Il.LANGUAGE_NORWEGIAN="no",Il.LANGUAGE_POLISH="pl",Il.LANGUAGE_TURKISH="tr",Il.LANGUAGE_UKRAINIAN="uk",Il.LANGUAGE_ROMANIAN="ro",Il.LANGUAGE_BULGARIAN="bg",Il.LANGUAGE_UNKNOWN="unknown",Il.OS_IOS="iOS",Il.OS_ANDROID="Android",Il.OS_WINDOWS="Windows",Il.OS_MARMALADE="Marmalade",Il.OS_LINUX="Linux",Il.OS_BADA="Bada",Il.OS_BLACKBERRY="Blackberry",Il.OS_OSX="OS X",Il.OS_WP8="WP8",Il.OS_WINRT="WINRT",Il.OS_UNKNOWN="Unknown",Il.UNKNOWN=-1,Il.WIN32=0,Il.LINUX=1,Il.MACOS=2,Il.ANDROID=3,Il.IPHONE=4,Il.IPAD=5,Il.BLACKBERRY=6,Il.NACL=7,Il.EMSCRIPTEN=8,Il.TIZEN=9,Il.WINRT=10,Il.WP8=11,Il.MOBILE_BROWSER=100,Il.DESKTOP_BROWSER=101,Il.EDITOR_PAGE=102,Il.EDITOR_CORE=103,Il.WECHAT_GAME=104,Il.QQ_PLAY=105,Il.BROWSER_TYPE_WECHAT="wechat",Il.BROWSER_TYPE_WECHAT_GAME="wechatgame",Il.BROWSER_TYPE_ALIPAY_GAME="alipaygame",Il.BROWSER_TYPE_XIAOMI_GAME="xiaomiquickgame",Il.BROWSER_TYPE_BAIDU_GAME="baidugame",Il.BROWSER_TYPE_COCOSPLAY="cocosplay",Il.BROWSER_TYPE_ANDROID="androidbrowser",Il.BROWSER_TYPE_IE="ie",Il.BROWSER_TYPE_QQ="qqbrowser",Il.BROWSER_TYPE_MOBILE_QQ="mqqbrowser",Il.BROWSER_TYPE_UC="ucbrowser",Il.BROWSER_TYPE_UCBS="ucbs",Il.BROWSER_TYPE_360="360browser",Il.BROWSER_TYPE_BAIDU_APP="baiduboxapp",Il.BROWSER_TYPE_BAIDU="baidubrowser",Il.BROWSER_TYPE_MAXTHON="maxthon",Il.BROWSER_TYPE_OPERA="opera",Il.BROWSER_TYPE_OUPENG="oupeng",Il.BROWSER_TYPE_MIUI="miuibrowser",Il.BROWSER_TYPE_FIREFOX="firefox",Il.BROWSER_TYPE_SAFARI="safari",Il.BROWSER_TYPE_CHROME="chrome",Il.BROWSER_TYPE_LIEBAO="liebao",Il.BROWSER_TYPE_QZONE="qzone",Il.BROWSER_TYPE_SOUGOU="sogou",Il.BROWSER_TYPE_UNKNOWN="unknown",Il.isNative=!1,Il.isBrowser="object"===("undefined"==typeof window?"undefined":t(window))&&"object"===("undefined"==typeof document?"undefined":t(document))&&!0,Il.isLittleEndian=(Sl=new ArrayBuffer(2),new DataView(Sl).setInt16(0,256,!0),256===new Int16Array(Sl)[0]),Ml.__globalAdapter&&Ml.__globalAdapter.adaptSys)Ml.__globalAdapter.adaptSys(Il);else{var Ll=window,Pl=Ll.navigator,Bl=document,Dl=Bl.documentElement,Fl=Pl.userAgent.toLowerCase();Il.isMobile=/mobile|android|iphone|ipad/.test(Fl),Il.platform=Il.isMobile?Il.MOBILE_BROWSER:Il.DESKTOP_BROWSER;var Nl=Pl.language;Nl=(Nl=Nl||Pl.browserLanguage)?Nl.split("-")[0]:Il.LANGUAGE_ENGLISH,Il.language=Nl;var zl=!1,Ul=!1,Gl="",Vl=0,Hl=/android (\d+(?:\.\d+)+)/i.exec(Fl)||/android (\d+(?:\.\d+)+)/i.exec(Pl.platform);Hl&&(zl=!0,Gl=Hl[1]||"",Vl=parseInt(Gl)||0),(Hl=/(iPad|iPhone|iPod).*OS ((\d+_?){2,3})/i.exec(Fl))?(Ul=!0,Gl=Hl[2]||"",Vl=parseInt(Gl)||0):(/(iPhone|iPad|iPod)/.exec(Pl.platform)||"MacIntel"===Pl.platform&&Pl.maxTouchPoints&&Pl.maxTouchPoints>1)&&(Ul=!0,Gl="",Vl=0);var Wl=Il.OS_UNKNOWN;-1!==Pl.appVersion.indexOf("Win")?Wl=Il.OS_WINDOWS:Ul?Wl=Il.OS_IOS:-1!==Pl.appVersion.indexOf("Mac")?Wl=Il.OS_OSX:-1!==Pl.appVersion.indexOf("X11")&&-1===Pl.appVersion.indexOf("Linux")?Wl=Il.OS_UNIX:zl?Wl=Il.OS_ANDROID:-1===Pl.appVersion.indexOf("Linux")&&-1===Fl.indexOf("ubuntu")||(Wl=Il.OS_LINUX),Il.os=Wl,Il.osVersion=Gl,Il.osMainVersion=Vl,Il.browserType=Il.BROWSER_TYPE_UNKNOWN,function(){var e=/mqqbrowser|micromessenger|qq|sogou|qzone|liebao|maxthon|ucbs|360 aphone|360browser|baiduboxapp|baidubrowser|maxthon|mxbrowser|miuibrowser/i.exec(Fl);e||(e=/qqbrowser|ucbrowser/i.exec(Fl)),e||(e=/chrome|safari|firefox|trident|opera|opr\/|oupeng/i.exec(Fl));var t=e?e[0].toLowerCase():Il.BROWSER_TYPE_UNKNOWN;"micromessenger"===t?t=Il.BROWSER_TYPE_WECHAT:"safari"===t&&zl?t=Il.BROWSER_TYPE_ANDROID:"qq"===t&&Fl.match(/android.*applewebkit/i)?t=Il.BROWSER_TYPE_ANDROID:"trident"===t?t=Il.BROWSER_TYPE_IE:"360 aphone"===t?t=Il.BROWSER_TYPE_360:"mxbrowser"===t?t=Il.BROWSER_TYPE_MAXTHON:"opr/"===t&&(t=Il.BROWSER_TYPE_OPERA),Il.browserType=t}(),Il.browserVersion="",function(){var e=Fl.match(/(mqqbrowser|micromessenger|qq|sogou|qzone|liebao|maxthon|uc|ucbs|360 aphone|360|baiduboxapp|baidu|maxthon|mxbrowser|miui)(mobile)?(browser)?\/?([\d.]+)/i);e||(e=Fl.match(/(qqbrowser|chrome|safari|firefox|trident|opera|opr\/|oupeng)(mobile)?(browser)?\/?([\d.]+)/i)),Il.browserVersion=e?e[4]:""}();var jl=window.innerWidth||document.documentElement.clientWidth,Xl=window.innerHeight||document.documentElement.clientHeight,ql=window.devicePixelRatio||1;Il.windowPixelResolution={width:ql*jl,height:ql*Xl},Il._checkWebGLRenderMode=function(){if(cc.game.renderType!==cc.game.RENDER_TYPE_WEBGL)throw new Error("This feature supports WebGL render mode only.")};var Yl=document.createElement("canvas");try{var Kl=Il.localStorage=Ll.localStorage;Kl.setItem("storage",""),Kl.removeItem("storage"),Kl=null}catch(Tr){var Zl=function(){cc.warnID(5200)};Il.localStorage={getItem:Zl,setItem:Zl,removeItem:Zl,clear:Zl}}var Ql=Yl.toDataURL("image/webp").startsWith("data:image/webp"),Jl=!!Yl.getContext("2d"),$l=!1;if(Il.browserType===Il.BROWSER_TYPE_WECHAT_GAME)$l=!0;else if(Ll.WebGLRenderingContext&&(function e(t,i,n){if(!n)return e(t,i,"webgl")||e(t,i,"experimental-webgl")||e(t,i,"webkit-3d")||e(t,i,"moz-webgl")||null;try{return t.getContext(n,i)}catch(e){return null}}(document.createElement("CANVAS"))&&($l=!0),$l&&Il.os===Il.OS_ANDROID)){var eu=parseFloat(Il.browserVersion);switch(Il.browserType){case Il.BROWSER_TYPE_MOBILE_QQ:case Il.BROWSER_TYPE_BAIDU:case Il.BROWSER_TYPE_BAIDU_APP:$l=eu>=6.2;break;case Il.BROWSER_TYPE_ANDROID:Il.osMainVersion&&Il.osMainVersion>=5&&($l=!0);break;case Il.BROWSER_TYPE_CHROME:$l=eu>=30;break;case Il.BROWSER_TYPE_UC:$l=eu>11;break;case Il.BROWSER_TYPE_360:$l=!1}}var tu,iu=Il.capabilities={canvas:Jl,opengl:$l,webp:Ql};(void 0!==Dl.ontouchstart||void 0!==Bl.ontouchstart||Pl.msPointerEnabled)&&(iu.touches=!0),void 0!==Dl.onmouseup&&(iu.mouse=!0),void 0!==Dl.onkeyup&&(iu.keyboard=!0),(Ll.DeviceMotionEvent||Ll.DeviceOrientationEvent)&&(iu.accelerometer=!0),Al=Il.browserType!==Il.BROWSER_TYPE_WECHAT_GAME&&!!(window.AudioContext||window.webkitAudioContext||window.mozAudioContext),tu={ONLY_ONE:!1,WEB_AUDIO:Al,DELAY_CREATE_CTX:!1},Il.os===Il.OS_IOS&&(tu.USE_LOADER_EVENT="loadedmetadata"),Il.browserType===Il.BROWSER_TYPE_FIREFOX&&(tu.DELAY_CREATE_CTX=!0,tu.USE_LOADER_EVENT="canplay"),Il.os===Il.OS_ANDROID&&Il.browserType===Il.BROWSER_TYPE_UC&&(tu.ONE_SOURCE=!0);try{tu.WEB_AUDIO&&(tu._context=null,Object.defineProperty(tu,"context",{get:function(){return this._context?this._context:this._context=new(window.AudioContext||window.webkitAudioContext||window.mozAudioContext)}}))}catch(O){tu.WEB_AUDIO=!1,cc.logID(5201)}var nu=[];(xl=document.createElement("audio")).canPlayType&&(xl.canPlayType('audio/ogg; codecs="vorbis"')&&nu.push(".ogg"),xl.canPlayType("audio/mpeg")&&nu.push(".mp3"),xl.canPlayType('audio/wav; codecs="1"')&&nu.push(".wav"),xl.canPlayType("audio/mp4")&&nu.push(".mp4"),xl.canPlayType("audio/x-m4a")&&nu.push(".m4a")),tu.format=nu,Il.__audioSupport=tu}function ru(e){switch(e){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array}return Uint8Array}Il.NetworkType={NONE:0,LAN:1,WWAN:2},Il.getNetworkType=function(){return Il.NetworkType.LAN},Il.getBatteryLevel=function(){return 1},Il.garbageCollect=function(){},Il.dumpRoot=function(){},Il.restartVM=function(){},Il.cleanScript=function(e){},Il.isObjectValid=function(e){return!!e},Il.dump=function(){var e="";e+="isMobile : "+this.isMobile+"\r\n",e+="language : "+this.language+"\r\n",e+="browserType : "+this.browserType+"\r\n",e+="browserVersion : "+this.browserVersion+"\r\n",e+="capabilities : "+JSON.stringify(this.capabilities)+"\r\n",e+="os : "+this.os+"\r\n",e+="osVersion : "+this.osVersion+"\r\n",e+="platform : "+this.platform+"\r\n",e+="Using "+(cc.game.renderType===cc.game.RENDER_TYPE_WEBGL?"WEBGL":"CANVAS")+" renderer.\r\n",cc.log(e)},Il.openURL=function(e){window.open(e)},Il.now=function(){return Date.now?Date.now():+new Date},cc.sys=Il;var au=function(){function e(t){i(this,e),this._subMeshes=t}return r(e,[{key:"getSubmesh",value:function(e){return this._subMeshes[e]}},{key:"destroySubMeshes",value:function(){for(var e=0;e<this._subMeshes.length;++e){for(var t=this._subMeshes[e],i=0;i<t.vertexBuffers.length;++i)t.vertexBuffers[i].destroy();t.indexBuffer&&t.indexBuffer.destroy()}this._subMeshes.splice(0)}},{key:"destroy",value:function(){this.destroySubMeshes(),this._subMeshes.length=0}},{key:"subMeshes",get:function(){return this._subMeshes}},{key:"subMeshCount",get:function(){return this._subMeshes.length}}]),e}(),su=e("Mesh",Es("cc.Mesh")((Rl=v((Cl=function(e){function t(){var e;return i(this,t),m(e=c(this,o(t).call(this)),"_struct",Rl,u(e)),m(e,"_dataLength",kl,u(e)),m(e,"_hash",Ol,u(e)),e._data=null,e._initialized=!1,e._hasFlatBuffers=!1,e._renderingMesh=null,e.loaded=!1,e}return s(t,e),r(t,[{key:"_nativeAsset",get:function(){return this._data.buffer},set:function(e){this._data&&this._data.byteLength===e.byteLength?(this._data.set(new Uint8Array(e)),cc.loader._cache[this.nativeUrl]&&(cc.loader._cache[this.nativeUrl].content=this._data.buffer)):this._data=new Uint8Array(e),this.loaded=!0,this.emit("load")}},{key:"subMeshCount",get:function(){var e=this.renderingMesh;return e?e.subMeshCount:0}},{key:"minPosition",get:function(){return this.struct.minPosition}},{key:"maxPosition",get:function(){return this.struct.maxPosition}},{key:"struct",get:function(){return this._struct}},{key:"data",get:function(){return this._data}},{key:"hash",get:function(){return!this._hash&&this._data&&(this._hash=Jo(this._data,666)),this._hash}},{key:"hasFlatBuffers",get:function(){return this._hasFlatBuffers}}]),r(t,[{key:"initialize",value:function(){var e=this;if(!this._initialized){var t,i;this._initialized=!0,this._data||(this._data=new Uint8Array(this._dataLength),(t=this).loaded?i&&i():t.nativeUrl?cc.loader.load({url:t.nativeUrl},(function(e,n){n&&(t.loaded||(t._nativeAsset=n)),i&&i(e)})):i&&i());var n=this._data.buffer,r=cc.director.root.device,a=this._createVertexBuffers(r,n),s=[],o=function(){if(u){if(c>=l.length)return"break";h=l[c++]}else{if((c=l.next()).done)return"break";h=c.value}var t=h;if(0===t.vertexBundelIndices.length)return"continue";var i=null,o=null;if(t.indexView){var f=t.indexView,_=f.stride,d=f.length;if(4===_&&!r.hasFeature(qo.ELEMENT_INDEX_UINT)){var p=e._struct.vertexBundles[t.vertexBundelIndices[0]].view.count;if(p>=65536)return N(10001,p,65536),"continue";_>>=1,d>>=1}i=r.createBuffer({usage:ro.INDEX|ro.TRANSFER_DST,memUsage:ao.HOST|ao.DEVICE,size:d,stride:_}),o=new(ru(f.stride))(n,f.offset,f.count),f.stride!==_&&(o=ru(_).from(o)),e.loaded?i.update(o):e.once("load",(function(){i.update(o)}))}var m=t.vertexBundelIndices.map((function(e){return a[e]})),v=[];if(t.vertexBundelIndices.length>0){var g=t.vertexBundelIndices[0];v=e._struct.vertexBundles[g].attributes}var y={primitiveMode:t.primitiveMode,vertexBuffers:m,flatBuffers:[],indexBuffer:i,attributes:v};if(t.geometricInfo){var b=t.geometricInfo,E=new Float32Array(n,b.view.offset,b.view.length/4);y.geometricInfo={indices:o,positions:E}}s.push(y)};var l=this._struct.primitives,u=Array.isArray(l),c=0;e:for(l=u?l:l[Symbol.iterator]();;){var h;switch(o()){case"break":break e;case"continue":continue}}this._renderingMesh=new au(s)}}},{key:"destroy",value:function(){return this.destroyRenderingMesh(),cc.director.root.dataPoolManager.releaseMesh(this),f(o(t.prototype),"destroy",this).call(this)}},{key:"destroyRenderingMesh",value:function(){this._renderingMesh&&(this._renderingMesh.destroy(),this._renderingMesh=null,this._data=null,this._initialized=!1)}},{key:"assign",value:function(e,t){this.reset({struct:e,data:t})}},{key:"reset",value:function(e){this.destroyRenderingMesh(),this._struct=e.struct,this._data=e.data,this._hash=0,this.loaded=!0,this.emit("load")}},{key:"getSubMesh",value:function(e){return this.renderingMesh.getSubmesh(e)}},{key:"merge",value:function(e,t,i){if(void 0!==i&&i&&(!this.loaded||!e.loaded||!this.validateMergingMesh(e)))return!1;var n=new zi,r=t&&new fn,a=t&&new Fa;if(r&&t.getRotation(r),!this._initialized&&e._data){var s=JSON.parse(JSON.stringify(e._struct)),o=e._data.slice();if(t){s.maxPosition&&s.minPosition&&(zi.add(a.center,s.maxPosition,s.minPosition),zi.multiplyScalar(a.center,a.center,.5),zi.subtract(a.halfExtents,s.maxPosition,s.minPosition),zi.multiplyScalar(a.halfExtents,a.halfExtents,.5),Fa.transform(a,a,t),zi.add(s.maxPosition,a.center,a.halfExtents),zi.subtract(s.minPosition,a.center,a.halfExtents));for(var l=0;l<s.vertexBundles.length;l++)for(var u=s.vertexBundles[l],c=0;c<u.attributes.length;c++)if(u.attributes[c].name===to.ATTR_POSITION||u.attributes[c].name===to.ATTR_NORMAL){var h=u.attributes[c].format,f=new DataView(o.buffer,u.view.offset+ou(u.attributes,c)),_=hu(f,h),d=fu(f,h);if(!_||!d)continue;for(var p=u.view.count,m=u.view.stride,v=cu(h),g=0;g<p;g++){var y=g*m,b=y+v,E=b+v;switch(n.set(_(y),_(b),_(E)),u.attributes[c].name){case to.ATTR_POSITION:n.transformMat4(t);break;case to.ATTR_NORMAL:zi.transformQuat(n,n,r)}d(y,n.x),d(b,n.y),d(E,n.z)}}}return this.reset({struct:s,data:o}),this.initialize(),!0}for(var T,S,x,A,w,C=new Zs,R=0,k=0,O=0,I=0,M=0,L=0,P=0,B=0,D=!1,F=new Array(this._struct.vertexBundles.length),N=0;N<this._struct.vertexBundles.length;++N){var z=this._struct.vertexBundles[N],U=e._struct.vertexBundles[N];O=z.view.offset,I=U.view.offset,k=z.view.stride,R=z.view.count+U.view.count,T=new ArrayBuffer(R*k),S=new Uint8Array(T),O+=(x=this._data.subarray(O,O+z.view.length)).length,I+=(A=e._data.subarray(I,I+U.view.length)).length,S.set(x),M=0;var G=z.attributes,V=Array.isArray(G),H=0;for(G=V?G:G[Symbol.iterator]();;){var W;if(V){if(H>=G.length)break;W=G[H++]}else{if((H=G.next()).done)break;W=H.value}var j=W;P=0,D=!1;var X=U.attributes,q=Array.isArray(X),Y=0;for(X=q?X:X[Symbol.iterator]();;){var K;if(q){if(Y>=X.length)break;K=X[Y++]}else{if((Y=X.next()).done)break;K=Y.value}var Z=K;if(j.name===Z.name&&j.format===Z.format){D=!0;break}P+=Go[Z.format].size}if(D){B=Go[j.format].size,L=z.view.length+M;for(var Q=0;Q<U.view.count;++Q){if(w=A.subarray(P,P+B),S.set(w,L),(j.name===to.ATTR_POSITION||j.name===to.ATTR_NORMAL)&&t){var J=new Float32Array(S.buffer,L,3);switch(n.set(J[0],J[1],J[2]),j.name){case to.ATTR_POSITION:n.transformMat4(t);break;case to.ATTR_NORMAL:zi.transformQuat(n,n,r)}J[0]=n.x,J[1]=n.y,J[2]=n.z}L+=z.view.stride,P+=U.view.stride}}M+=Go[j.format].size}F[N]={attributes:z.attributes,view:{offset:C.getLength(),length:T.byteLength,count:R,stride:k}},C.addBuffer(T)}for(var $,ee,te,ie=0,ne=2,re=0,ae=new Array(this._struct.primitives.length),se=0;se<this._struct.primitives.length;++se){var oe=this._struct.primitives[se],le=e._struct.primitives[se];ae[se]={primitiveMode:oe.primitiveMode,vertexBundelIndices:oe.vertexBundelIndices};var ue=oe.vertexBundelIndices,ce=Array.isArray(ue),he=0;for(ue=ce?ue:ue[Symbol.iterator]();;){var fe;if(ce){if(he>=ue.length)break;fe=ue[he++]}else{if((he=ue.next()).done)break;fe=he.value}var _e=fe;re=Math.max(re,this._struct.vertexBundles[_e].view.count)}if(oe.indexView&&le.indexView){ie=oe.indexView.count,ie+=le.indexView.count,O=oe.indexView.offset,I=le.indexView.offset,ne=ie<256?1:ie<65536?2:4;var de=new ArrayBuffer(ie*ne);if($=2===ne?new Uint16Array(de):1===ne?new Uint8Array(de):new Uint32Array(de),ee=2===oe.indexView.stride?new Uint16Array(this._data.buffer,O,oe.indexView.count):1===oe.indexView.stride?new Uint8Array(this._data.buffer,O,oe.indexView.count):new Uint32Array(this._data.buffer,O,oe.indexView.count),ne===oe.indexView.stride)$.set(ee);else for(var pe=0;pe<oe.indexView.count;++pe)$[pe]=ee[pe];O+=oe.indexView.length,te=2===le.indexView.stride?new Uint16Array(e._data.buffer,I,le.indexView.count):1===le.indexView.stride?new Uint8Array(e._data.buffer,I,le.indexView.count):new Uint32Array(e._data.buffer,I,le.indexView.count);for(var me=0;me<le.indexView.count;++me)$[oe.indexView.count+me]=re+te[me];I+=le.indexView.length,ae[se].indexView={offset:C.getLength(),length:de.byteLength,count:ie,stride:ne},C.setNextAlignment(ne),C.addBuffer(de)}if(oe.geometricInfo&&le.geometricInfo){var ve=oe.geometricInfo.view.length+le.geometricInfo.view.length,ge=new ArrayBuffer(ve),ye=new Uint8Array(ge),be=new Uint8Array(this._data.buffer,oe.geometricInfo.view.offset,oe.geometricInfo.view.length),Ee=new Uint8Array(e._data.buffer,le.geometricInfo.view.offset,le.geometricInfo.view.length);ye.set(be),ye.set(Ee,be.length),C.setNextAlignment(4),ae[se].geometricInfo={doubleSided:oe.geometricInfo.doubleSided,view:{offset:C.getLength(),length:ye.length,count:oe.geometricInfo.view.count+le.geometricInfo.view.count,stride:oe.geometricInfo.view.stride}},C.addBuffer(ge)}}var Te={vertexBundles:F,primitives:ae,minPosition:this._struct.minPosition,maxPosition:this._struct.maxPosition};return Te.minPosition&&e._struct.minPosition&&Te.maxPosition&&e._struct.maxPosition&&(t?(zi.add(a.center,e._struct.maxPosition,e._struct.minPosition),zi.multiplyScalar(a.center,a.center,.5),zi.subtract(a.halfExtents,e._struct.maxPosition,e._struct.minPosition),zi.multiplyScalar(a.halfExtents,a.halfExtents,.5),Fa.transform(a,a,t),zi.add(n,a.center,a.halfExtents),zi.max(Te.maxPosition,Te.maxPosition,n),zi.subtract(n,a.center,a.halfExtents),zi.min(Te.minPosition,Te.minPosition,n)):(zi.min(Te.minPosition,Te.minPosition,e._struct.minPosition),zi.max(Te.maxPosition,Te.maxPosition,e._struct.maxPosition))),this.reset({struct:Te,data:new Uint8Array(C.getCombined())}),this.initialize(),!0}},{key:"validateMergingMesh",value:function(e){if(!this._data&&e._data)return!0;if(this._struct.vertexBundles.length!==e._struct.vertexBundles.length)return!1;for(var t=0;t<this._struct.vertexBundles.length;++t){var i=this._struct.vertexBundles[t],n=e._struct.vertexBundles[t];if(i.attributes.length!==n.attributes.length)return!1;for(var r=0;r<i.attributes.length;++r)if(i.attributes[r].format!==n.attributes[r].format)return!1}if(this._struct.primitives.length!==e._struct.primitives.length)return!1;for(var a=0;a<this._struct.primitives.length;++a){var s=this._struct.primitives[a],o=e._struct.primitives[a];if(s.vertexBundelIndices.length!==o.vertexBundelIndices.length)return!1;for(var l=0;l<s.vertexBundelIndices.length;++l)if(s.vertexBundelIndices[l]!==o.vertexBundelIndices[l])return!1;if(s.primitiveMode!==o.primitiveMode)return!1;if(s.indexView){if(void 0===o.indexView)return!1}else if(o.indexView)return!1}return!0}},{key:"readAttribute",value:function(e,t){var i=this,n=null;return this._accessAttribute(e,t,(function(e,t){var r=e.attributes[t].format,a=new DataView(i._data.buffer,e.view.offset+ou(e.attributes,t)),s=Go[r],o=lu(r),l=hu(a,r);if(o&&l){for(var u=e.view.count,c=s.count,h=new o(u*c),f=e.view.stride,_=0;_<u;++_)for(var d=0;d<c;++d)h[c*_+d]=l(f*_+h.BYTES_PER_ELEMENT*d);n=h}})),n}},{key:"copyAttribute",value:function(e,t,i,n,r){var a=this,s=!1;return this._accessAttribute(e,t,(function(e,t){var o=e.attributes[t].format,l=new DataView(a._data.buffer,e.view.offset+ou(e.attributes,t)),u=new DataView(i,r),c=Go[o],h=hu(l,o),f=fu(u,o);if(h&&f){for(var _=e.view.count,d=c.count,p=e.view.stride,m=cu(o),v=n,g=m,y=0;y<_;++y)for(var b=0;b<d;++b){f(v*y+g*b,h(p*y+m*b))}s=!0}})),s}},{key:"readIndices",value:function(e){if(!this._data||e>=this._struct.primitives.length)return null;var t=this._struct.primitives[e];if(!t.indexView)return null;for(var i=t.indexView.count,n=i<256?no.R8UI:i<65536?no.R16UI:no.R32UI,r=new(lu(n))(i),a=hu(new DataView(this._data.buffer),n),s=0;s<i;++s)r[s]=a(t.indexView.offset+r.BYTES_PER_ELEMENT*s);return r}},{key:"copyIndices",value:function(e,t){if(!this._data||e>=this._struct.primitives.length)return!1;var i=this._struct.primitives[e];if(!i.indexView)return!1;for(var n=i.indexView.count,r=1===i.indexView.stride?no.R8UI:2===i.indexView.stride?no.R16UI:no.R32UI,a=hu(new DataView(this._data.buffer),r),s=0;s<n;++s)t[s]=a(i.indexView.offset+Go[r].size*s);return!0}},{key:"createFlatBuffers",value:function(){if(this._hasFlatBuffers)return!1;cc.director.root.device;for(var e,t=0,i=0;i<this._struct.primitives.length;++i){var n=this._struct.primitives[i],r=this.renderingMesh.subMeshes[i];n.indexView&&(t=n.indexView.count);var a=n.vertexBundelIndices,s=Array.isArray(a),o=0;for(a=s?a:a[Symbol.iterator]();;){var l;if(s){if(o>=a.length)break;l=a[o++]}else{if((o=a.next()).done)break;l=o.value}var u=l,c=this._struct.vertexBundles[u],h=n.indexView?n.indexView.count:c.view.count,f=c.view.stride,_=f*h,d=new Uint8Array(this._data.buffer,c.view.offset,c.view.length);if(n.indexView){var p=new Uint8Array(_);e=2===(t<65536?2:4)?new Uint16Array(this._data.buffer,n.indexView.offset,n.indexView.count):new Uint32Array(this._data.buffer,n.indexView.offset,n.indexView.count);for(var m=0;m<t;++m)for(var v=m*f,g=e[m]*f,y=0;y<f;++y)p[v+y]=d[g+y];r.flatBuffers.push({stride:f,count:h,buffer:p})}else r.flatBuffers.push({stride:f,count:h,buffer:d})}}return this._hasFlatBuffers=!0,!0}},{key:"destroyFlatBuffers",value:function(){if(this._hasFlatBuffers){if(this._renderingMesh)for(var e=this._renderingMesh.subMeshes,t=0;t<e.length;++t)e[t].flatBuffers.splice(0);this._hasFlatBuffers=!1}}},{key:"_accessAttribute",value:function(e,t,i){if(this._data&&!(e>=this._struct.primitives.length)){var n=this._struct.primitives[e].vertexBundelIndices,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s,l=this._struct.vertexBundles[o],u=l.attributes.findIndex((function(e){return e.name===t}));if(!(u<0)){i(l,u);break}}}}},{key:"_createVertexBuffers",value:function(e,t){var i=this;return this._struct.vertexBundles.map((function(n){var r=e.createBuffer({usage:ro.VERTEX|ro.TRANSFER_DST,memUsage:ao.HOST|ao.DEVICE,size:n.view.length,stride:n.view.stride}),a=new Uint8Array(t,n.view.offset,n.view.length);return i.loaded?r.update(a):i.once("load",(function(){r.update(a)})),r}))}},{key:"renderingMesh",get:function(){return this.initialize(),this._renderingMesh}}]),t}(Tl)).prototype,"_struct",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{vertexBundles:[],primitives:[]}}}),kl=v(Cl.prototype,"_dataLength",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Ol=v(Cl.prototype,"_hash",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),wl=Cl))||wl);function ou(e,t){for(var i=0,n=0;n<t;++n){var r=e[n];i+=Go[r.format].size}return i}function lu(e){var t=Go[e],i=t.size/t.count;switch(t.type){case Fo.UNORM:case Fo.UINT:switch(i){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array}break;case Fo.SNORM:case Fo.INT:switch(i){case 1:return Int8Array;case 2:return Int16Array;case 4:return Int32Array}break;case Fo.FLOAT:return Float32Array}return null}cc.Mesh=su;var uu=Il.isLittleEndian;function cu(e){var t=Go[e];return t.size/t.count}function hu(e,t){var i=Go[t],n=i.size/i.count;switch(i.type){case Fo.UNORM:switch(n){case 1:return function(t){return e.getUint8(t)};case 2:return function(t){return e.getUint16(t,uu)};case 4:return function(t){return e.getUint32(t,uu)}}break;case Fo.SNORM:case Fo.INT:switch(n){case 1:return function(t){return e.getInt8(t)};case 2:return function(t){return e.getInt16(t,uu)};case 4:return function(t){return e.getInt32(t,uu)}}break;case Fo.UINT:switch(n){case 1:return function(t){return e.getUint8(t)};case 2:return function(t){return e.getUint16(t,uu)};case 4:return function(t){return e.getUint32(t,uu)}}break;case Fo.FLOAT:return function(t){return e.getFloat32(t,uu)}}return null}function fu(e,t){var i=Go[t],n=i.size/i.count;switch(i.type){case Fo.UNORM:switch(n){case 1:return function(t,i){return e.setUint8(t,i)};case 2:return function(t,i){return e.setUint16(t,i,uu)};case 4:return function(t,i){return e.setUint32(t,i,uu)}}break;case Fo.SNORM:case Fo.INT:switch(n){case 1:return function(t,i){return e.setInt8(t,i)};case 2:return function(t,i){return e.setInt16(t,i,uu)};case 4:return function(t,i){return e.setInt32(t,i,uu)}}break;case Fo.UINT:switch(n){case 1:return function(t,i){return e.setUint8(t,i)};case 2:return function(t,i){return e.setUint16(t,i,uu)};case 4:return function(t,i){return e.setUint32(t,i,uu)}}break;case Fo.FLOAT:return function(t,i){return e.setFloat32(t,i,uu)}}return null}var _u={NONE:0,IGNORE_RAYCAST:1<<20,GIZMOS:1<<21,EDITOR:1<<22,UI_3D:1<<23,SCENE_GIZMO:1<<24,UI_2D:1<<25,PROFILER:1<<28,DEFAULT:1<<30,ALL:4294967295},du=e("Layers",function(){function e(){i(this,e)}return r(e,null,[{key:"makeMaskInclude",value:function(e){var t=0,i=e,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}t|=a}return t}},{key:"makeMaskExclude",value:function(t){return~e.makeMaskInclude(t)}},{key:"addLayer",value:function(t,i){void 0!==i?i>19||i<0?console.warn("maximum layers reached."):(e.Enum[t]=1<<i,e.Enum[i]=t,e.BitMask[t]=1<<i,e.BitMask[i]=t):console.warn("bitNum can't be undefined")}},{key:"deleteLayer",value:function(t){t>19||t<0?console.warn("do not change buildin layers."):(delete e.Enum[e.Enum[t]],delete e.Enum[t],delete e.BitMask[e.BitMask[t]],delete e.BitMask[t])}}]),e}());du.Enum=dt(_u),du.BitMask=_t(Object.assign({},_u)),cc.Layers=du;var pu,mu;!function(e){e[e.DEFAULT=100]="DEFAULT"}(pu||(pu=e("RenderPassStage",{}))),function(e){e[e.MIN=0]="MIN",e[e.MAX=255]="MAX",e[e.DEFAULT=128]="DEFAULT"}(mu||(mu={}));var vu;!function(e){e[e.UBO_GLOBAL=23]="UBO_GLOBAL",e[e.UBO_SHADOW=22]="UBO_SHADOW",e[e.UBO_LOCAL=21]="UBO_LOCAL",e[e.UBO_FORWARD_LIGHTS=20]="UBO_FORWARD_LIGHTS",e[e.UBO_SKINNING_ANIMATION=19]="UBO_SKINNING_ANIMATION",e[e.UBO_SKINNING_TEXTURE=18]="UBO_SKINNING_TEXTURE",e[e.SAMPLER_JOINTS=25]="SAMPLER_JOINTS",e[e.SAMPLER_ENVIRONMENT=26]="SAMPLER_ENVIRONMENT",e[e.CUSTUM_UBO_BINDING_END_POINT=18]="CUSTUM_UBO_BINDING_END_POINT",e[e.CUSTOM_SAMPLER_BINDING_START_POINT=30]="CUSTOM_SAMPLER_BINDING_START_POINT"}(vu||(vu={}));var gu=function(e){return e>=vu.CUSTUM_UBO_BINDING_END_POINT&&e<vu.CUSTOM_SAMPLER_BINDING_START_POINT},yu=function e(){i(this,e),this.view=new Float32Array(e.COUNT)};yu.SIZE=4*(yu.COUNT=(yu.AMBIENT_GROUND_OFFSET=(yu.AMBIENT_SKY_OFFSET=(yu.MAIN_LIT_COLOR_OFFSET=(yu.MAIN_LIT_DIR_OFFSET=(yu.EXPOSURE_OFFSET=(yu.CAMERA_POS_OFFSET=(yu.MAT_VIEW_PROJ_INV_OFFSET=(yu.MAT_VIEW_PROJ_OFFSET=(yu.MAT_PROJ_INV_OFFSET=(yu.MAT_PROJ_OFFSET=(yu.MAT_VIEW_INV_OFFSET=(yu.MAT_VIEW_OFFSET=(yu.NATIVE_SIZE_OFFSET=(yu.SCREEN_SCALE_OFFSET=(yu.SCREEN_SIZE_OFFSET=(yu.TIME_OFFSET=0)+4)+4)+4)+4)+16)+16)+16)+16)+16)+16)+4)+4)+4)+4)+4)+4),yu.BLOCK={binding:vu.UBO_GLOBAL,name:"CCGlobal",members:[{name:"cc_time",type:io.FLOAT4,count:1},{name:"cc_screenSize",type:io.FLOAT4,count:1},{name:"cc_screenScale",type:io.FLOAT4,count:1},{name:"cc_nativeSize",type:io.FLOAT4,count:1},{name:"cc_matView",type:io.MAT4,count:1},{name:"cc_matViewInv",type:io.MAT4,count:1},{name:"cc_matProj",type:io.MAT4,count:1},{name:"cc_matProjInv",type:io.MAT4,count:1},{name:"cc_matViewProj",type:io.MAT4,count:1},{name:"cc_matViewProjInv",type:io.MAT4,count:1},{name:"cc_cameraPos",type:io.FLOAT4,count:1},{name:"cc_exposure",type:io.FLOAT4,count:1},{name:"cc_mainLitDir",type:io.FLOAT4,count:1},{name:"cc_mainLitColor",type:io.FLOAT4,count:1},{name:"cc_ambientSky",type:io.FLOAT4,count:1},{name:"cc_ambientGround",type:io.FLOAT4,count:1}]};var bu=function e(){i(this,e),this.view=new Float32Array(e.COUNT)};bu.SIZE=4*(bu.COUNT=(bu.SHADOW_COLOR_OFFSET=(bu.MAT_LIGHT_PLANE_PROJ_OFFSET=0)+16)+4),bu.BLOCK={binding:vu.UBO_SHADOW,name:"CCShadow",members:[{name:"cc_matLightPlaneProj",type:io.MAT4,count:1},{name:"cc_shadowColor",type:io.FLOAT4,count:1}]};var Eu={binding:vu.SAMPLER_ENVIRONMENT,name:"cc_environment",type:io.SAMPLER_CUBE,count:1},Tu=new Map,Su=function e(){i(this,e),this.view=new Float32Array(e.COUNT)};Su.SIZE=4*(Su.COUNT=(Su.MAT_WORLD_IT_OFFSET=(Su.MAT_WORLD_OFFSET=0)+16)+16),Su.BLOCK={binding:vu.UBO_LOCAL,name:"CCLocal",members:[{name:"cc_matWorld",type:io.MAT4,count:1},{name:"cc_matWorldIT",type:io.MAT4,count:1}]},Tu.set(Su.BLOCK.name,{type:wo.UNIFORM_BUFFER,blockInfo:Su.BLOCK});var xu=function e(){i(this,e),this.view=new Float32Array(e.COUNT)};xu.BATCHING_COUNT=10,xu.MAT_WORLDS_OFFSET=0,xu.SIZE=4*(xu.COUNT=16*xu.BATCHING_COUNT),xu.BLOCK={binding:vu.UBO_LOCAL,name:"CCLocalBatched",members:[{name:"cc_matWorlds",type:io.MAT4,count:xu.BATCHING_COUNT}]},Tu.set(xu.BLOCK.name,{type:wo.UNIFORM_BUFFER,blockInfo:xu.BLOCK});var Au=function e(){i(this,e),this.view=new Float32Array(e.COUNT)};Au.MAX_SPHERE_LIGHTS=2,Au.MAX_SPOT_LIGHTS=2,Au.SIZE=4*(Au.COUNT=(Au.SPOT_LIGHT_COLOR_OFFSET=(Au.SPOT_LIGHT_DIR_OFFSET=(Au.SPOT_LIGHT_SIZE_RANGE_ANGLE_OFFSET=(Au.SPOT_LIGHT_POS_OFFSET=(Au.SPHERE_LIGHT_COLOR_OFFSET=(Au.SPHERE_LIGHT_SIZE_RANGE_OFFSET=(Au.SPHERE_LIGHT_POS_OFFSET=0)+4*Au.MAX_SPHERE_LIGHTS)+4*Au.MAX_SPHERE_LIGHTS)+4*Au.MAX_SPOT_LIGHTS)+4*Au.MAX_SPOT_LIGHTS)+4*Au.MAX_SPOT_LIGHTS)+4*Au.MAX_SPOT_LIGHTS)+4*Au.MAX_SPOT_LIGHTS),Au.BLOCK={binding:vu.UBO_FORWARD_LIGHTS,name:"CCForwardLight",members:[{name:"cc_sphereLitPos",type:io.FLOAT4,count:Au.MAX_SPHERE_LIGHTS},{name:"cc_sphereLitSizeRange",type:io.FLOAT4,count:Au.MAX_SPHERE_LIGHTS},{name:"cc_sphereLitColor",type:io.FLOAT4,count:Au.MAX_SPHERE_LIGHTS},{name:"cc_spotLitPos",type:io.FLOAT4,count:Au.MAX_SPOT_LIGHTS},{name:"cc_spotLitSizeRangeAngle",type:io.FLOAT4,count:Au.MAX_SPOT_LIGHTS},{name:"cc_spotLitDir",type:io.FLOAT4,count:Au.MAX_SPOT_LIGHTS},{name:"cc_spotLitColor",type:io.FLOAT4,count:Au.MAX_SPOT_LIGHTS}]},Tu.set(Au.BLOCK.name,{type:wo.UNIFORM_BUFFER,blockInfo:Au.BLOCK});var wu=function e(){i(this,e)};wu.SIZE=4*(wu.COUNT=(wu.JOINTS_TEXTURE_INFO_OFFSET=0)+4),wu.BLOCK={binding:vu.UBO_SKINNING_TEXTURE,name:"CCSkinningTexture",members:[{name:"cc_jointsTextureInfo",type:io.FLOAT4,count:1}]},Tu.set(wu.BLOCK.name,{type:wo.UNIFORM_BUFFER,blockInfo:wu.BLOCK});var Cu=function e(){i(this,e)};Cu.SIZE=4*(Cu.COUNT=(Cu.JOINTS_ANIM_INFO_OFFSET=0)+4),Cu.BLOCK={binding:vu.UBO_SKINNING_ANIMATION,name:"CCSkinningAnimation",members:[{name:"cc_jointsAnimInfo",type:io.FLOAT4,count:1}]},Tu.set(Cu.BLOCK.name,{type:wo.UNIFORM_BUFFER,blockInfo:Cu.BLOCK});var Ru={binding:vu.SAMPLER_JOINTS,name:"cc_jointsTexture",type:io.SAMPLER2D,count:1};Tu.set(Ru.name,{type:wo.SAMPLER,samplerInfo:Ru});var ku=du.makeMaskExclude([du.BitMask.UI_2D,du.BitMask.GIZMOS,du.BitMask.EDITOR,du.BitMask.SCENE_GIZMO,du.BitMask.PROFILER]),Ou=du.makeMaskExclude([du.BitMask.UI_2D,du.BitMask.PROFILER]),Iu=(du.Enum.ALL,function(){function e(t){i(this,e),this._models={},this._onAttach=t.onAttach,this._onDetach=t.onDetach}return r(e,[{key:"attach",value:function(e){var t=this._models,i=e.id;t[i]?t[i]++:(this._onAttach&&this._onAttach(e),t[i]=1)}},{key:"detach",value:function(e){var t=this._models,i=e.id;!t[i]||--t[i]>0||this._onDetach&&this._onDetach(e)}}]),e}()),Mu=new(function(){function e(){i(this,e),this._customs={}}return r(e,[{key:"register",value:function(e,t){this._customs[e]=new Iu(t)}},{key:"attach",value:function(e,t){var i=this._customs[e];i?i.attach(t):console.warn("no customization named '".concat(e,"'"))}},{key:"detach",value:function(e,t){var i=this._customs[e];i?i.detach(t):console.warn("no customization named '".concat(e,"'"))}}]),e}());cc.customizationManager=Mu;var Lu=function(){function e(){i(this,e),this._subMeshObject=null,this._material=null,this._cmdBuffers=new Array,this._psos=null,this._inputAssembler=null,this._priority=mu.DEFAULT}return r(e,[{key:"initialize",value:function(e,t,i){this._psos=i,this.subMeshData=e,this.material=t}},{key:"destroy",value:function(){this._inputAssembler&&this._inputAssembler.destroy();for(var e=0;e<this.passes.length;e++)this.passes[e].destroyPipelineState(this._psos[e]);var t=this._cmdBuffers,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.destroy()}this._cmdBuffers.splice(0),this._material=null}},{key:"updateCommandBuffer",value:function(){if(this._material){for(var e=0;e<this._material.passes.length;e++)this._subMeshObject&&this._material.passes[e].primitive!==this._subMeshObject.primitiveMode&&console.warn("mesh primitive type doesn't match with pass settings"),this.recordCommandBuffer(e);for(var t=this._cmdBuffers.length-1;t>=this._material.passes.length;t--){var i=this._cmdBuffers.pop();i&&i.destroy()}}}},{key:"recordCommandBuffer",value:function(e){var t=cc.director.root.device,i=this._psos[e];if(null==this._cmdBuffers[e]){var n={allocator:t.commandAllocator,type:Co.SECONDARY};this._cmdBuffers[e]=t.createCommandBuffer(n)}else this._cmdBuffers[e].status===Ks.UNREADY&&this._cmdBuffers[e].initialize({allocator:t.commandAllocator,type:Co.SECONDARY});var r=this._inputAssembler,a=this._cmdBuffers[e];a.begin(),a.bindPipelineState(i),a.bindBindingLayout(i.pipelineLayout.layouts[0]),a.bindInputAssembler(r),a.draw(r),a.end()}},{key:"priority",set:function(e){this._priority=e},get:function(){return this._priority}},{key:"subMeshData",set:function(e){this._inputAssembler&&this._inputAssembler.destroy(),this._subMeshObject=e;var t={};t.attributes=this._subMeshObject.attributes,t.vertexBuffers=this._subMeshObject.vertexBuffers,this._subMeshObject.indexBuffer&&(t.indexBuffer=this._subMeshObject.indexBuffer),this._subMeshObject.indirectBuffer&&(t.indirectBuffer=this._subMeshObject.indirectBuffer),this._inputAssembler?this._inputAssembler.initialize(t):this._inputAssembler=cc.director.root.device.createInputAssembler(t)},get:function(){return this._subMeshObject}},{key:"psos",get:function(){return this._psos},set:function(e){this._psos=e}},{key:"material",set:function(e){this._material=e,null!=e&&this.updateCommandBuffer()},get:function(){return this._material}},{key:"inputAssembler",get:function(){return this._inputAssembler}},{key:"passes",get:function(){return this._material.passes}},{key:"commandBuffers",get:function(){return this._cmdBuffers}}]),e}(),Pu=new Bn,Bu=new Za((function(){return new Lu}),32);function Du(e){var t=0,i=e.members,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;t+=jo(s.type)*s.count}return t}var Fu,Nu,zu,Uu,Gu,Vu,Hu,Wu,ju,Xu,qu,Yu,Ku=0,Zu=function(){function e(){i(this,e),this._type="default",this._scene=null,this._node=null,this._transform=null,this._id=Ku++,this._enabled=!0,this._visFlags=du.Enum.NONE,this._cameraID=-1,this._userKey=-1,this._worldBounds=null,this._modelBounds=null,this._subModels=[],this._implantPSOs=[],this._matPSORecord=new Map,this._matRefCount=new Map,this._uboLocal=new Su,this._localUBO=null,this._localBindings=new Map,this._inited=!1,this._uboUpdated=!1,this._castShadow=!1,this._isDynamicBatching=!1,this._transformUpdated=!0,this._device=cc.director.root.device}return r(e,[{key:"scene",set:function(e){this._scene=e},get:function(){return this._scene}},{key:"id",get:function(){return this._id}},{key:"subModels",get:function(){return this._subModels}},{key:"subModelNum",get:function(){return this._subModels.length}},{key:"inited",get:function(){return this._inited}},{key:"enabled",set:function(e){this._enabled=e},get:function(){return this._enabled}},{key:"node",get:function(){return this._node},set:function(e){this._node=e}},{key:"transform",get:function(){return this._transform},set:function(e){this._transform=e}},{key:"worldBounds",get:function(){return this._worldBounds}},{key:"modelBounds",get:function(){return this._modelBounds}},{key:"visFlags",get:function(){return this._visFlags},set:function(e){this._visFlags=e}},{key:"userKey",set:function(e){this._userKey=e}},{key:"uboLocal",get:function(){return this._uboLocal}},{key:"localUBO",get:function(){return this._localUBO}},{key:"localBindings",get:function(){return this._localBindings}},{key:"castShadow",get:function(){return this._castShadow},set:function(e){this._castShadow=e}},{key:"isDynamicBatching",get:function(){return this._isDynamicBatching},set:function(e){this._isDynamicBatching=e}},{key:"UBOUpdated",get:function(){return this._uboUpdated}}]),r(e,[{key:"initialize",value:function(e){this._transform=this._node=e}},{key:"destroy",value:function(){var e=this._subModels,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n;r.destroy(),Bu.free(r)}for(var a=this._localBindings.values(),s=a.next();!s.done;){var o=s.value;o.buffer&&(o.buffer.destroy(),o.buffer=void 0),s=a.next()}this._localBindings.has(Au.BLOCK.name)&&this._localBindings.delete(Au.BLOCK.name),this._worldBounds=null,this._modelBounds=null,this._subModels.splice(0),this._matPSORecord.clear(),this._matRefCount.clear(),this._inited=!1,this._transformUpdated=!0,this._isDynamicBatching=!1}},{key:"attachToScene",value:function(e){this._scene=e}},{key:"detachFromScene",value:function(){this._scene=null}},{key:"getSubModel",value:function(e){return this._subModels[e]}},{key:"updateTransform",value:function(){var e=this._transform;(e.hasChangedFlags||e._dirtyFlags)&&(e.updateWorldTransform(),this._transformUpdated=!0,this._modelBounds&&this._worldBounds&&this._modelBounds.transform(e._mat,e._pos,e._rot,e._scale,this._worldBounds))}},{key:"_resetUBOUpdateFlag",value:function(){this._uboUpdated=!1}},{key:"updateUBOs",value:function(){if(this._uboUpdated)return!1;if(this._uboUpdated=!0,this._transformUpdated&&!this._isDynamicBatching){var e=this._transform._mat;Bn.toArray(this._uboLocal.view,e,Su.MAT_WORLD_OFFSET),Bn.inverseTranspose(Pu,e),Bn.toArray(this._uboLocal.view,Pu,Su.MAT_WORLD_IT_OFFSET);var t=this._localBindings.get(Su.BLOCK.name);t&&t.buffer&&t.buffer.update(this._uboLocal.view),this._transformUpdated=!1}return this._matPSORecord.forEach(this._updatePass,this),!0}},{key:"createBoundingShape",value:function(e,t){e&&t&&(this._modelBounds=Fa.fromPoints(Fa.create(),e,t),this._worldBounds=Fa.clone(this._modelBounds),this._transform.updateWorldTransform(),this._modelBounds.transform(this._transform._mat,this._transform._pos,this._transform._rot,this._transform._scale,this._worldBounds))}},{key:"initSubModel",value:function(e,t,i){if(this.initLocalBindings(i),null==this._subModels[e])this._subModels[e]=Bu.alloc();else{var n=this._subModels[e].material;this._subModels[e].destroy(),this.releasePSO(n)}this.allocatePSO(i),this._subModels[e].initialize(t,i,this._matPSORecord.get(i)),this._inited=!0}},{key:"setSubModelMesh",value:function(e,t){null==this._subModels[e]&&(this._subModels[e]=Bu.alloc()),this._subModels[e].subMeshData=t}},{key:"setSubModelMaterial",value:function(e,t){null!=this._subModels[e]&&(this.initLocalBindings(t),this._subModels[e].material===t?t&&(this.destroyPipelineStates(t,this._matPSORecord.get(t)),this._matPSORecord.set(t,this.createPipelineStates(t))):(this._subModels[e].material&&this.releasePSO(this._subModels[e].material),t&&this.allocatePSO(t)),this._subModels[e].psos=t&&this._matPSORecord.get(t)||null,this._subModels[e].material=t)}},{key:"onGlobalPipelineStateChanged",value:function(){var e=this._subModels,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}for(var r=n,a=r.material,s=this._matPSORecord.get(a),o=0;o<a.passes.length;o++){var l=a.passes[o];l.beginChangeStatesSilently(),l.tryCompile(),l.endChangeStatesSilently(),l.destroyPipelineState(s[o]),s[o]=this.createPipelineState(l),s[o].pipelineLayout.layouts[0].update()}r.updateCommandBuffer()}}},{key:"insertImplantPSO",value:function(e){this._implantPSOs.push(e)}},{key:"removeImplantPSO",value:function(e){var t=this._implantPSOs.indexOf(e);t>=0&&this._implantPSOs.splice(t,1)}},{key:"createPipelineStates",value:function(e){for(var t=new Array(e.passes.length),i=0;i<t.length;i++){var n=e.passes[i],r=n.customizations,a=Array.isArray(r),s=0;for(r=a?r:r[Symbol.iterator]();;){var o;if(a){if(s>=r.length)break;o=r[s++]}else{if((s=r.next()).done)break;o=s.value}var l=o;Mu.attach(l,this)}t[i]=this.createPipelineState(n)}return t}},{key:"destroyPipelineStates",value:function(e,t){for(var i=0;i<e.passes.length;i++){var n=e.passes[i];n.destroyPipelineState(t[i]);var r=n.customizations,a=Array.isArray(r),s=0;for(r=a?r:r[Symbol.iterator]();;){var o;if(a){if(s>=r.length)break;o=r[s++]}else{if((s=r.next()).done)break;o=s.value}var l=o;Mu.detach(l,this)}}}},{key:"createPipelineState",value:function(e){var t=e.createPipelineState();return t.pipelineLayout.layouts[0].bindBuffer(Su.BLOCK.binding,this._localBindings.get(Su.BLOCK.name).buffer),this._localBindings.has(Au.BLOCK.name)&&t.pipelineLayout.layouts[0].bindBuffer(Au.BLOCK.binding,this._localBindings.get(Au.BLOCK.name).buffer),t}},{key:"onSetLocalBindings",value:function(e){this._localBindings.has(Su.BLOCK.name)||this._localBindings.set(Su.BLOCK.name,{type:wo.UNIFORM_BUFFER,blockInfo:Su.BLOCK});var t=!1,i=e.passes,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}if(a.bindings.find((function(e){return e.name===Au.BLOCK.name}))){t=!0;break}}t&&"ForwardPipeline"===cc.director.root.pipeline.name&&(this._localBindings.has(Au.BLOCK.name)||this._localBindings.set(Au.BLOCK.name,{type:wo.UNIFORM_BUFFER,blockInfo:Au.BLOCK}))}},{key:"initLocalBindings",value:function(e){if(e){this.onSetLocalBindings(e);for(var t=this._localBindings.values(),i=t.next();!i.done;){var n=i.value;n.buffer||(n.buffer=this._device.createBuffer({usage:ro.UNIFORM|ro.TRANSFER_DST,memUsage:ao.HOST|ao.DEVICE,size:Du(n.blockInfo)})),i=t.next()}}}},{key:"_updatePass",value:function(e,t){for(var i=0;i<t.passes.length;i++)t.passes[i].update();for(var n=0;n<e.length;n++)e[n].pipelineLayout.layouts[0].update()}},{key:"allocatePSO",value:function(e){null==this._matRefCount.get(e)?(this._matRefCount.set(e,1),this._matPSORecord.set(e,this.createPipelineStates(e))):this._matRefCount.set(e,this._matRefCount.get(e)+1)}},{key:"releasePSO",value:function(e){this._matRefCount.set(e,this._matRefCount.get(e)-1),0===this._matRefCount.get(e)&&(this.destroyPipelineStates(e,this._matPSORecord.get(e)),this._matPSORecord.delete(e),this._matRefCount.delete(e))}}]),e}();!function(e){e[e.LOCAL=0]="LOCAL",e[e.WORLD=1]="WORLD"}(Fu||(Fu={})),function(e){e[e.NONE=0]="NONE",e[e.POSITION=1]="POSITION",e[e.ROTATION=2]="ROTATION",e[e.SCALE=4]="SCALE",e[e.RS=e.ROTATION|e.SCALE]="RS",e[e.TRS=e.POSITION|e.ROTATION|e.SCALE]="TRS",e[e.TRS_MASK=~e.TRS]="TRS_MASK"}(Nu||(Nu={})),function(e){e[e.RGB565=no.R5G6B5]="RGB565",e[e.RGB5A1=no.RGB5A1]="RGB5A1",e[e.RGBA4444=no.RGBA4]="RGBA4444",e[e.RGB888=no.RGB8]="RGB888",e[e.RGBA8888=no.RGBA8]="RGBA8888",e[e.RGBA32F=no.RGBA32F]="RGBA32F",e[e.A8=no.A8]="A8",e[e.I8=no.L8]="I8",e[e.AI8=no.LA8]="AI8",e[e.RGB_PVRTC_2BPPV1=no.PVRTC_RGB2]="RGB_PVRTC_2BPPV1",e[e.RGBA_PVRTC_2BPPV1=no.PVRTC_RGBA2]="RGBA_PVRTC_2BPPV1",e[e.RGB_PVRTC_4BPPV1=no.PVRTC_RGB4]="RGB_PVRTC_4BPPV1",e[e.RGBA_PVRTC_4BPPV1=no.PVRTC_RGBA4]="RGBA_PVRTC_4BPPV1",e[e.RGB_ETC1=no.ETC_RGB8]="RGB_ETC1",e[e.RGB_ETC2=no.ETC2_RGB8]="RGB_ETC2",e[e.RGBA_ETC2=no.ETC2_RGBA8]="RGBA_ETC2"}(zu||(zu={})),function(e){e[e.REPEAT=yo.WRAP]="REPEAT",e[e.CLAMP_TO_EDGE=yo.CLAMP]="CLAMP_TO_EDGE",e[e.MIRRORED_REPEAT=yo.MIRROR]="MIRRORED_REPEAT",e[e.CLAMP_TO_BORDER=yo.BORDER]="CLAMP_TO_BORDER"}(Uu||(Uu={})),function(e){e[e.NONE=go.NONE]="NONE",e[e.LINEAR=go.LINEAR]="LINEAR",e[e.NEAREST=go.POINT]="NEAREST"}(Gu||(Gu={})),function(e){e[e.NONE=no.UNKNOWN]="NONE",e[e.DEPTH_16=no.D16]="DEPTH_16",e[e.DEPTH_24=no.D24]="DEPTH_24",e[e.DEPTH_32=no.D32F]="DEPTH_32",e[e.DEPTH_16_STENCIL_8=no.D16S8]="DEPTH_16_STENCIL_8",e[e.DEPTH_24_STENCIL_8=no.D24S8]="DEPTH_24_STENCIL_8",e[e.DEPTH_32_STENCIL_8=no.D32F_S8]="DEPTH_32_STENCIL_8"}(Vu||(Vu={}));var Qu,Ju=e("ImageAsset",(Hu=Es("cc.ImageAsset"),Wu=Ts({override:!0}),Hu((Yu=qu=function(e){function t(e){var n;return i(this,t),(n=c(this,o(t).call(this)))._exportedExts=void 0,n._format=zu.RGBA8888,n._width=0,n._height=0,n._url="",n.loaded=!1,n._nativeData={_data:null,width:0,height:0,format:0,_compressed:!1},void 0!==e&&n.reset(e),n}return s(t,e),r(t,[{key:"_nativeAsset",get:function(){return this._nativeData},set:function(e){this.reset(e)}},{key:"data",get:function(){var e=this._nativeData._data;return ArrayBuffer.isView(e)?e:this._nativeData}},{key:"width",get:function(){return this._nativeData.width||this._width}},{key:"height",get:function(){return this._nativeData.height||this._height}},{key:"format",get:function(){return this._format}},{key:"isCompressed",get:function(){return this._format>=zu.RGB_ETC1&&this._format<=zu.RGBA_PVRTC_4BPPV1}},{key:"url",get:function(){return this._url}},{key:"_texture",set:function(e){this._tex=e},get:function(){if(!this._tex){var e=new cc.Texture2D;e.name=this._url,e.image=this,this._tex=e}return this._tex}}]),r(t,[{key:"reset",value:function(e){var t=this;e instanceof HTMLElement?(this._nativeData=e,e.complete||e instanceof HTMLCanvasElement?this._onDataComplete():(this.loaded=!1,e.addEventListener("load",(function(){t._onDataComplete()})),e.addEventListener("error",(function(e){cc.warnID(3119,e.message)})))):(this._nativeData=e,this._format=e.format,this._onDataComplete())}},{key:"_serialize",value:function(){var e=this._exportedExts;if(!e&&this._native&&(e=[this._native]),!e)return"";var i=[],n=e,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s,l=o.split("@"),u=t.extnames.indexOf(l[0]),c=u<0?o:"".concat(u);l[1]&&(c+="@"+l[1]),i.push(c)}return{fmt:i.join("_"),w:this.width,h:this.height}}},{key:"_deserialize",value:function(e,i){var n="";"string"==typeof e?n=e:(this._width=e.w,this._height=e.h,n=e.fmt);var r=cc.director.root?cc.director.root.device:null,a=n.split("_"),s=Number.MAX_VALUE,o=this._format,l="",u=cc.macro.SUPPORT_TEXTURE_FORMATS,c=a,h=Array.isArray(c),f=0;for(c=h?c:c[Symbol.iterator]();;){var _;if(h){if(f>=c.length)break;_=c[f++]}else{if((f=c.next()).done)break;_=f.value}var d=_.split("@"),p=parseInt(d[0],void 0),m=t.extnames[p]||d.join(),v=u.indexOf(m);if(-1!==v&&v<s){var g=d[1]?parseInt(d[1]):this._format;if(!(".pvr"!==m||r&&r.hasFeature(qo.FORMAT_PVRTC)))continue;if(!(g!==zu.RGB_ETC1||r&&r.hasFeature(qo.FORMAT_ETC1)))continue;if(!(g!==zu.RGB_ETC2&&g!==zu.RGBA_ETC2||r&&r.hasFeature(qo.FORMAT_ETC2)))continue;if(".webp"===m&&!cc.sys.capabilities.webp)continue;s=v,l=m,o=g}}l&&(this._setRawAsset(l),this._format=o);var y=i.customEnv,b=y&&y.uuid;b&&(this._uuid=b,this._url=this.nativeUrl)}},{key:"_onDataComplete",value:function(){this.loaded=!0,this.emit("load")}}]),t}(Tl),qu.extnames=[".png",".jpg",".jpeg",".bmp",".webp",".pvr",".pkm"],v((Xu=Yu).prototype,"_nativeAsset",[Wu],Object.getOwnPropertyDescriptor(Xu.prototype,"_nativeAsset"),Xu.prototype),ju=Xu))||ju));cc.ImageAsset=Ju,function(e){e[e.minFilter=0]="minFilter",e[e.magFilter=1]="magFilter",e[e.mipFilter=2]="mipFilter",e[e.addressU=3]="addressU",e[e.addressV=4]="addressV",e[e.addressW=5]="addressW",e[e.maxAnisotropy=6]="maxAnisotropy",e[e.cmpFunc=7]="cmpFunc",e[e.minLOD=8]="minLOD",e[e.maxLOD=9]="maxLOD",e[e.mipLODBias=10]="mipLODBias",e[e.total=11]="total"}(Qu||(Qu={}));var $u=[go.LINEAR,go.LINEAR,go.NONE,yo.WRAP,yo.WRAP,yo.WRAP,8,fo.NEVER,0,0,0],ec=nc($u),tc={r:0,g:0,b:0,a:0},ic={};function nc(e){for(var t=0,i=0,n=0;n<$u.length;n++)switch(t=e[n]||$u[n],n){case Qu.minFilter:i|=t;break;case Qu.magFilter:i|=t<<2;break;case Qu.mipFilter:i|=t<<4;break;case Qu.addressU:i|=t<<6;break;case Qu.addressV:i|=t<<8;break;case Qu.addressW:i|=t<<10;break;case Qu.maxAnisotropy:i|=t<<12;break;case Qu.cmpFunc:i|=t<<16;break;case Qu.minLOD:i|=t<<20;break;case Qu.maxLOD:i|=t<<24;break;case Qu.mipLODBias:i|=t<<28}return i}var rc,ac,sc,oc,lc,uc,hc,fc,_c,dc,pc,mc,vc,gc,yc=new(function(){function e(){i(this,e),this._cache={}}return r(e,[{key:"getSampler",value:function(e,t){0===t&&(t=ec);var i=this._cache[t];return i||(ic.minFilter=3&t,ic.magFilter=t>>2&3,ic.mipFilter=t>>4&3,ic.addressU=t>>6&3,ic.addressV=t>>8&3,ic.addressW=t>>10&3,ic.maxAnisotropy=t>>12&15,ic.cmpFunc=t>>16&15,ic.minLOD=t>>20&15,ic.maxLOD=t>>24&15,ic.mipLODBias=t>>28&15,ic.borderColor=tc,this._cache[t]=e.createSampler(ic))}}]),e}());cc.samplerLib=yc;var bc,Ec,Tc,Sc,xc,Ac,wc,Cc=new ve("Tex"),Rc=Es("cc.TextureBase")((gc=vc=function(e){function t(){var e,n=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return i(this,t),m(e=c(this,o(t).call(this)),"_format",sc,u(e)),m(e,"_premultiplyAlpha",oc,u(e)),m(e,"_flipY",lc,u(e)),m(e,"_minFilter",uc,u(e)),m(e,"_magFilter",hc,u(e)),m(e,"_mipFilter",fc,u(e)),m(e,"_wrapS",_c,u(e)),m(e,"_wrapT",dc,u(e)),m(e,"_wrapR",pc,u(e)),m(e,"_anisotropy",mc,u(e)),e._width=0,e._height=0,e._samplerInfo=[],e._samplerHash=0,e._flipY=n,e._id=Cc.getNewId(),e.loaded=!1,e}return s(t,e),r(t,[{key:"isCompressed",get:function(){return this._format>=zu.RGB_ETC1&&this._format<=zu.RGBA_PVRTC_4BPPV1}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}}]),r(t,[{key:"getId",value:function(){return this._id}},{key:"getPixelFormat",value:function(){return this._format}},{key:"hasPremultipliedAlpha",value:function(){return this._premultiplyAlpha||!1}},{key:"getAnisotropy",value:function(){return this._anisotropy}},{key:"setWrapMode",value:function(e,t,i){this._wrapS=e,this._samplerInfo[Qu.addressU]=e,this._wrapT=t,this._samplerInfo[Qu.addressV]=t,void 0!==i&&(this._wrapR=i,this._samplerInfo[Qu.addressW]=i),this._samplerHash=nc(this._samplerInfo)}},{key:"setFilters",value:function(e,t){this._minFilter=e,this._samplerInfo[Qu.minFilter]=e,this._magFilter=t,this._samplerInfo[Qu.magFilter]=t,this._samplerHash=nc(this._samplerInfo)}},{key:"setMipFilter",value:function(e){this._mipFilter=e,this._samplerInfo[Qu.mipFilter]=e,this._samplerInfo[Qu.maxLOD]=e===Gu.NONE?0:15,this._samplerHash=nc(this._samplerInfo)}},{key:"setFlipY",value:function(e){this._flipY=e}},{key:"setPremultiplyAlpha",value:function(e){this._premultiplyAlpha=e}},{key:"setAnisotropy",value:function(e){this._anisotropy=e,this._samplerInfo[Qu.maxAnisotropy]=e,this._samplerHash=nc(this._samplerInfo)}},{key:"destroy",value:function(){return f(o(t.prototype),"destroy",this).call(this)}},{key:"getGFXTextureView",value:function(){return null}},{key:"getSamplerHash",value:function(){return this._samplerHash}},{key:"_serialize",value:function(e){return this._minFilter+","+this._magFilter+","+this._wrapS+","+this._wrapT+","+(this._premultiplyAlpha?1:0)+","+this._mipFilter+","+this._anisotropy+","+(this._flipY?1:0)}},{key:"_deserialize",value:function(e,t){var i=e.split(",");i.unshift(""),i.length>=6&&(this.setFilters(parseInt(i[1]),parseInt(i[2])),this.setWrapMode(parseInt(i[3]),parseInt(i[4])),this._premultiplyAlpha=49===i[5].charCodeAt(0)),i.length>=8&&(this.setMipFilter(parseInt(i[6])),this.setAnisotropy(parseInt(i[7]))),i.length>=9&&(this._flipY=49===i[8].charCodeAt(0))}},{key:"_getGFXDevice",value:function(){return cc.director.root&&cc.director.root.device}},{key:"_getGFXFormat",value:function(){return this._format}},{key:"_setGFXFormat",value:function(e){this._format=void 0===e?zu.RGBA8888:e}}]),t}(Tl),vc.PixelFormat=zu,vc.WrapMode=Uu,vc.Filter=Gu,sc=v((ac=gc).prototype,"_format",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return zu.RGBA8888}}),oc=v(ac.prototype,"_premultiplyAlpha",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),lc=v(ac.prototype,"_flipY",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),uc=v(ac.prototype,"_minFilter",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Gu.LINEAR}}),hc=v(ac.prototype,"_magFilter",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Gu.LINEAR}}),fc=v(ac.prototype,"_mipFilter",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Gu.NONE}}),_c=v(ac.prototype,"_wrapS",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Uu.REPEAT}}),dc=v(ac.prototype,"_wrapT",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Uu.REPEAT}}),pc=v(ac.prototype,"_wrapR",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Uu.REPEAT}}),mc=v(ac.prototype,"_anisotropy",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 8}}),rc=ac))||rc;cc.TextureBase=Rc,pt(Vu);var kc,Oc=e("RenderTexture",(bc=Es("cc.RenderTexture"),Ec=Ts({type:Vu}),bc((wc=Ac=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),s=0;s<r;s++)a[s]=arguments[s];return(n=c(this,(e=o(t)).call.apply(e,[this].concat(a))))._window=null,m(n,"_depthStencilFormat",xc,u(n)),n}return s(t,e),r(t,[{key:"getGFXWindow",value:function(){return this._window}},{key:"getGFXTextureView",value:function(){return this._window?this._window.colorTexView:null}},{key:"getGFXStencilTexture",value:function(){return this._window?this._window.depthStencilTexView:null}},{key:"reset",value:function(e){e&&(this._width=e.width,this._height=e.height,e.colorFormat&&(this._format=e.colorFormat),e.depthStencilFormat&&(this._depthStencilFormat=e.depthStencilFormat),this._tryResetWindow(),this.emit("resize",this))}},{key:"destroy",value:function(){return this._window&&(cc.director.root.destroyWindow(this._window),this._window=null),f(o(t.prototype),"destroy",this).call(this)}},{key:"onLoaded",value:function(){this._tryResetWindow(),this.loaded=!0,this.emit("load")}},{key:"_serialize",value:function(e){return{base:f(o(t.prototype),"_serialize",this).call(this),name:this._name,width:this._width,height:this._height,colorFormat:this._format,depthStencilFormat:this._depthStencilFormat}}},{key:"_deserialize",value:function(e,i){f(o(t.prototype),"_deserialize",this).call(this,e.base,i);var n=e;this.name=n.name||"",this._width=n.width,this._height=n.height,this._format=n.colorFormat,this._depthStencilFormat=n.depthStencilFormat}},{key:"_tryResetWindow",value:function(){var e=this._getGFXDevice();e&&(this._window&&this._window.destroy(),this._createWindow(e))}},{key:"_createWindow",value:function(e){var t={title:this.name,isOffscreen:!0,width:this._width,height:this._height,colorFmt:this._format,depthStencilFmt:this._depthStencilFormat};if(this._window)return this._window.initialize(t),this._window;this._window=cc.director.root.createWindow(t)}},{key:"width",get:function(){return this._width},set:function(e){this._width=e,this.reset()}},{key:"height",get:function(){return this._height},set:function(e){this._height=e,this.reset()}},{key:"depthStencilFormat",get:function(){return this._depthStencilFormat},set:function(e){this._depthStencilFormat=e,this.reset()}}]),t}(Rc),Ac.DepthStencilFormat=Vu,xc=v((Sc=wc).prototype,"_depthStencilFormat",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Vu.NONE}}),v(Sc.prototype,"width",[Ts],Object.getOwnPropertyDescriptor(Sc.prototype,"width"),Sc.prototype),v(Sc.prototype,"height",[Ts],Object.getOwnPropertyDescriptor(Sc.prototype,"height"),Sc.prototype),v(Sc.prototype,"depthStencilFormat",[Ec],Object.getOwnPropertyDescriptor(Sc.prototype,"depthStencilFormat"),Sc.prototype),Tc=Sc))||Tc));cc.RenderTexture=Oc;var Ic=[{buffOffset:0,buffStride:0,buffTexHeight:0,texOffset:{x:0,y:0,z:0},texExtent:{width:1,height:1,depth:1},texSubres:{baseMipLevel:1,levelCount:1,baseArrayLayer:0,layerCount:1}}];function Mc(e){return e&&0==(e&e-1)}var Lc,Pc,Bc,Dc,Fc,Nc=Es("cc.SimpleTexture")(kc=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),s=0;s<r;s++)a[s]=arguments[s];return(n=c(this,(e=o(t)).call.apply(e,[this].concat(a))))._gfxTexture=null,n._gfxTextureView=null,n._mipmapLevel=1,n}return s(t,e),r(t,[{key:"getGFXTexture",value:function(){return this._gfxTexture}},{key:"getGFXTextureView",value:function(){return this._gfxTextureView}},{key:"destroy",value:function(){return this._tryDestroyTexture(),f(o(t.prototype),"destroy",this).call(this)}},{key:"updateImage",value:function(){this.updateMipmaps(0)}},{key:"updateMipmaps",value:function(){}},{key:"uploadData",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;if(this._gfxTexture&&!(this._gfxTexture.mipLevel<=t)){var n=this._getGFXDevice();if(n){var r=Ic[0];r.texExtent.width=this._gfxTexture.width>>t,r.texExtent.height=this._gfxTexture.height>>t,r.texSubres.baseMipLevel=t,r.texSubres.baseArrayLayer=i,ArrayBuffer.isView(e)?n.copyBuffersToTexture([e],this._gfxTexture,Ic):n.copyTexImagesToTexture([e],this._gfxTexture,Ic)}}}},{key:"_assignImage",value:function(e,t,i){var n=this,r=function(){var r=e.data;r&&(n.uploadData(r,t,i),n._checkTextureLoaded())};if(e.loaded)r();else{if(e.once("load",(function(){r()})),!this.isCompressed){var a=cc.builtinResMgr.get("black-texture").image;this.uploadData(a.data,t,i)}cc.textureUtil.postLoadImage(e)}}},{key:"_checkTextureLoaded",value:function(){this._textureReady()}},{key:"_textureReady",value:function(){this.loaded=!0,this.emit("load")}},{key:"_setMipmapLevel",value:function(e){this._mipmapLevel=e<1?1:e}},{key:"_getGfxTextureCreateInfo",value:function(e){return null}},{key:"_getGfxTextureViewCreateInfo",value:function(e){return null}},{key:"_tryReset",value:function(){this._tryDestroyTexture();var e=this._getGFXDevice();e&&this._createTexture(e)}},{key:"_createTexture",value:function(e){var t=So.NONE;this._mipFilter!==Gu.NONE&&function(e,t,i){return!(e.gfxAPI===Xo.WEBGL)||Mc(t)&&Mc(i)}(e,this._width,this._height)&&(this._mipmapLevel=function(e,t){for(var i=Math.max(e,t),n=0;i;)i>>=1,n++;return n}(this._width,this._height),t=So.GEN_MIPMAP);var i=this._getGfxTextureCreateInfo({usage:Eo.SAMPLED|Eo.TRANSFER_DST,format:this._getGFXFormat(),mipLevel:this._mipmapLevel,flags:t});if(i){var n=e.createTexture(i),r=this._getGfxTextureViewCreateInfo({texture:n,format:this._getGFXFormat()});if(r){var a=e.createTextureView(r);a?(this._gfxTexture=n,this._gfxTextureView=a):n.destroy()}else n.destroy()}}},{key:"_tryDestroyTexture",value:function(){this._gfxTexture&&(this._gfxTexture.destroy(),this._gfxTexture=null),this._gfxTextureView&&(this._gfxTextureView.destroy(),this._gfxTextureView=null)}},{key:"mipmapLevel",get:function(){return this._mipmapLevel}}]),t}(Rc))||kc;cc.SimpleTexture=Nc;var zc,Uc=e("Texture2D",(Lc=Es("cc.Texture2D"),Pc=Ts([Ju]),Lc((Fc=v((Dc=function(e){function t(){var e;return i(this,t),m(e=c(this,o(t).call(this,!0)),"_mipmaps",Fc,u(e)),e}return s(t,e),r(t,[{key:"mipmaps",get:function(){return this._mipmaps},set:function(e){var t=this;if(this._mipmaps=e,this._setMipmapLevel(this._mipmaps.length),this._mipmaps.length>0){var i=this._mipmaps[0];this.reset({width:i.width,height:i.height,format:i.format,mipmapLevel:this._mipmaps.length}),this._mipmaps.forEach((function(e,i){t._assignImage(e,i)}))}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length})}},{key:"image",get:function(){return 0===this._mipmaps.length?null:this._mipmaps[0]},set:function(e){this.mipmaps=e?[e]:[]}}]),r(t,[{key:"onLoaded",value:function(){this.initialize()}},{key:"reset",value:function(e){this._width=e.width,this._height=e.height,this._setGFXFormat(e.format),this._setMipmapLevel(e.mipmapLevel||1),this._tryReset()}},{key:"create",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:zu.RGBA8888,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;this.reset({width:e,height:t,format:i,mipmapLevel:n})}},{key:"toString",value:function(){return 0!==this._mipmaps.length?this._mipmaps[0].url:""}},{key:"updateMipmaps",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1?arguments[1]:void 0;if(!(e>=this._mipmaps.length))for(var i=Math.min(void 0===t?this._mipmaps.length:t,this._mipmaps.length-e),n=0;n<i;++n){var r=e+n;this._assignImage(this._mipmaps[r],r)}}},{key:"getHtmlElementObj",value:function(){return this._mipmaps[0]&&this._mipmaps[0].data instanceof HTMLElement?this._mipmaps[0].data:null}},{key:"destroy",value:function(){return this._mipmaps=[],f(o(t.prototype),"destroy",this).call(this)}},{key:"description",value:function(){var e=this._mipmaps[0]?this._mipmaps[0].url:"";return"<cc.Texture2D | Name = ".concat(e," | Dimension = ").concat(this.width," x ").concat(this.height,">")}},{key:"releaseTexture",value:function(){this.destroy()}},{key:"_serialize",value:function(e){return{base:f(o(t.prototype),"_serialize",this).call(this,e),mipmaps:this._mipmaps.map((function(t){return t&&t._uuid?e?Editor.Utils.UuidUtils.compressUuid(t._uuid,!0):t._uuid:null}))}}},{key:"_deserialize",value:function(e,i){var n=e;f(o(t.prototype),"_deserialize",this).call(this,n.base,i),this._mipmaps=new Array(n.mipmaps.length);for(var r=0;r<n.mipmaps.length;++r)if(this._mipmaps[r]=new Ju,n.mipmaps[r]){var a=n.mipmaps[r];i.result.push(this._mipmaps,"".concat(r),a),this._mipmaps[r]._texture=this}}},{key:"initialize",value:function(){this.mipmaps=this._mipmaps}},{key:"_getGfxTextureCreateInfo",value:function(e){return Object.assign({type:bo.TEX2D,width:this._width,height:this._height},e)}},{key:"_getGfxTextureViewCreateInfo",value:function(e){return Object.assign({type:xo.TV2D},e)}},{key:"_checkTextureLoaded",value:function(){for(var e=!0,i=0;i<this._mipmaps.length;++i){if(!this._mipmaps[i].loaded){e=!1;break}}e&&f(o(t.prototype),"_textureReady",this).call(this)}}]),t}(Nc)).prototype,"_mipmaps",[Pc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Bc=Dc))||Bc));cc.Texture2D=Uc;var Gc,Vc,Hc,Wc,jc,Xc,qc=[{u:0,v:0},{u:0,v:0},{u:0,v:0},{u:0,v:0}],Yc=e("SpriteFrame",Es("cc.SpriteFrame")(zc=function(e){function t(){var e;return i(this,t),(e=c(this,o(t).call(this))).vertices=null,e.uv=[],e.uvHash=0,e._image=null,e.uvSliced=[],e._rect=new Jn,e._offset=new Mi,e._originalSize=new Xn,e._rotated=!1,e._capInsets=[0,0,0,0],e._atlasUuid="",e._flipUv=!1,e}return s(t,e),r(t,[{key:"insetTop",get:function(){return this._capInsets[1]},set:function(e){this._capInsets[1]!==e&&(this._capInsets[1]=e,this._texture&&this._calculateSlicedUV())}},{key:"insetBottom",get:function(){return this._capInsets[3]},set:function(e){this._capInsets[3]!==e&&(this._capInsets[3]=e,this._texture&&this._calculateSlicedUV())}},{key:"insetLeft",get:function(){return this._capInsets[0]},set:function(e){this._capInsets[0]!==e&&(this._capInsets[0]=e,this._texture&&this._calculateSlicedUV())}},{key:"insetRight",get:function(){return this._capInsets[2]},set:function(e){this._capInsets[2]!==e&&(this._capInsets[2]=e,this._texture&&this._calculateSlicedUV())}},{key:"rect",get:function(){return this._rect},set:function(e){this._rect.equals(e)||(this._rect.set(e),this._texture&&this._calculateUV())}},{key:"originalSize",get:function(){return this._originalSize},set:function(e){this._originalSize.equals(e)||(this._originalSize.set(e),this._texture&&this._calculateUV())}},{key:"offset",get:function(){return this._offset},set:function(e){this._offset.set(e)}},{key:"rotated",get:function(){return this._rotated},set:function(e){this._rotated!==e&&(this._rotated=e,this._texture&&this._calculateUV())}},{key:"texture",get:function(){return this._texture||(this._texture=!this._image||window.Editor&&Editor.isBuilder?new Uc:this._image._texture,this._texture.on("load",this._textureLoaded,this)),this._texture},set:function(e){e?(this.reset({texture:e},!0),this._texture instanceof Oc&&this.onLoaded()):console.warn("Error Texture in ".concat(this.name))}},{key:"atlasUuid",get:function(){return this._atlasUuid},set:function(e){this._atlasUuid=e}},{key:"width",get:function(){return this._texture.width}},{key:"height",get:function(){return this._texture.height}},{key:"_imageSource",set:function(e){this._image=e,window.Editor&&Editor.isBuilder||(this._texture=e._texture,this._texture.on("load",this._textureLoaded,this),this._calculateUV())}}]),r(t,[{key:"textureLoaded",value:function(){return this.loaded}},{key:"isRotated",value:function(){return this._rotated}},{key:"setRotated",value:function(e){this.rotated=e}},{key:"getRect",value:function(e){return e?(e.set(this._rect),e):this._rect.clone()}},{key:"setRect",value:function(e){this.rect=e}},{key:"getOriginalSize",value:function(e){return e?(e.set(this._originalSize),e):this._originalSize.clone()}},{key:"setOriginalSize",value:function(e){this.originalSize=e}},{key:"getOffset",value:function(e){return e?(e.set(this._offset),e):this._offset.clone()}},{key:"setOffset",value:function(e){this.offset=e}},{key:"getGFXTextureView",value:function(){return this._texture.getGFXTextureView()}},{key:"reset",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=!1;t&&(this._originalSize.set(0,0),this._rect.set(0,0,0,0),this._offset.set(0,0),this._capInsets=[0,0,0,0],this._rotated=!1,i=!0),e&&(e.texture&&(this._rect.x=this._rect.y=0,this._rect.width=e.texture.width,this._rect.height=e.texture.height,this._texture&&this._texture.off("load"),this._texture=e.texture,this.checkRect(this._texture),this._texture.on("load",this._textureLoaded,this)),e.originalSize&&this._originalSize.set(e.originalSize),e.rect&&this._rect.set(e.rect),e.offset&&this._offset.set(e.offset),void 0!==e.borderTop&&(this._capInsets[1]=e.borderTop),void 0!==e.borderBottom&&(this._capInsets[3]=e.borderBottom),void 0!==e.borderLeft&&(this._capInsets[0]=e.borderLeft),void 0!==e.borderRight&&(this._capInsets[2]=e.borderRight),void 0!==e.isRotate&&(this._rotated=!!e.isRotate),void 0!==e.isFlipUv&&(this._flipUv=!!e.isFlipUv),this._texture instanceof Oc&&(this._flipUv=!0),i=!0),i&&this._calculateUV()}},{key:"checkRect",value:function(e){var t=this._rect,i=t.x,n=t.y;return this._rotated?(i+=t.height,n+=t.width):(i+=t.width,n+=t.height),i>e.width?(cc.errorID(3300,this.name+"/"+e.name,i,e.width),!1):!(n>e.height)||(cc.errorID(3301,this.name+"/"+e.name,n,e.height),!1)}},{key:"onLoaded",value:function(){this.loaded=!0,this.emit("load")}},{key:"destroy",value:function(){return this._texture&&this._texture.off("load"),f(o(t.prototype),"destroy",this).call(this)}},{key:"_calculateSlicedUV",value:function(){var e=this._rect,t=this.texture,i=t.width,n=t.height,r=this._capInsets[0],a=this._capInsets[2],s=e.width-r-a,o=this._capInsets[1],l=this._capInsets[3],u=e.height-o-l,c=this.uvSliced;if(c.length=0,this._rotated){qc[0].u=(e.x+e.height)/i,qc[1].u=(e.x+o+u)/i,qc[2].u=(e.x+o)/i,qc[3].u=e.x/i,qc[3].v=e.y/n,qc[2].v=(e.y+a)/n,qc[1].v=(e.y+a+s)/n,qc[0].v=(e.y+e.width)/n;for(var h=0;h<4;++h)for(var f=qc[h],_=0;_<4;++_){var d=qc[_];c.push({u:f.u,v:d.v})}}else{qc[0].u=e.x/i,qc[1].u=(e.x+r)/i,qc[2].u=(e.x+r+s)/i,qc[3].u=(e.x+e.width)/i,qc[3].v=e.y/n,qc[2].v=(e.y+o)/n,qc[1].v=(e.y+o+u)/n,qc[0].v=(e.y+e.height)/n;for(var p=0;p<4;++p)for(var m=qc[p],v=0;v<4;++v){var g=qc[v];c.push({u:g.u,v:m.v})}}}},{key:"_calculateUV",value:function(){var e=this._rect,t=this.uv,i=this.texture,n=i.width,r=i.height;if(this._rotated){var a=0===n?0:e.x/n,s=0===n?0:(e.x+e.height)/n,o=0===r?0:e.y/r,l=0===r?0:(e.y+e.width)/r;this._flipUv?(t[0]=a,t[1]=o,t[2]=a,t[3]=l,t[4]=s,t[5]=o,t[6]=s,t[7]=l):(t[0]=s,t[1]=l,t[2]=s,t[3]=o,t[4]=a,t[5]=l,t[6]=a,t[7]=o)}else{var u=0===n?0:e.x/n,c=0===n?0:(e.x+e.width)/n,h=0===r?0:(e.y+e.height)/r,f=0===r?0:e.y/r;this._flipUv?(t[0]=u,t[1]=f,t[2]=c,t[3]=f,t[4]=u,t[5]=h,t[6]=c,t[7]=h):(t[0]=u,t[1]=h,t[2]=c,t[3]=h,t[4]=u,t[5]=f,t[6]=c,t[7]=f)}for(var _="",d=0;d<t.length;d++)_+=t[d];this.uvHash=Jo(_,666);var p=this.vertices;if(p){p.nu.length=0,p.nv.length=0;for(var m=0;m<p.u.length;m++)p.nu[m]=p.u[m]/n,p.nv[m]=p.v[m]/r}this._calculateSlicedUV()}},{key:"_serialize",value:function(e){var t,i=this._rect,n=this._offset,r=this._originalSize,a=this._uuid;return a&&e&&(a=Editor.Utils.UuidUtils.compressUuid(a,!0)),this.vertices&&(t={triangles:this.vertices.triangles,x:this.vertices.x,y:this.vertices.y,u:this.vertices.u,v:this.vertices.v}),{image:this._image?e?Editor.Utils.UuidUtils.compressUuid(this._image._uuid,!0):this._image._uuid:void 0,name:this._name,atlas:e?void 0:this._atlasUuid,rect:i,offset:n,originalSize:r,rotated:this._rotated,capInsets:this._capInsets,vertices:t}}},{key:"_deserialize",value:function(e,t){var i=e,n=i.rect;n&&(this._rect=new Jn(n.x,n.y,n.width,n.height));var r=i.offset;i.offset&&(this._offset=new Mi(r.x,r.y));var a=i.originalSize;i.originalSize&&(this._originalSize=new Xn(a.width,a.height)),this._rotated=!!i.rotated,this._name=i.name;var s=i.capInsets;s&&(this._capInsets[0]=s[0],this._capInsets[1]=s[1],this._capInsets[2]=s[2],this._capInsets[3]=s[3]),t.result.push(this,"_imageSource",i.image),this.vertices=i.vertices,this.vertices&&(this.vertices.nu=[],this.vertices.nv=[])}},{key:"_textureLoaded",value:function(){var e=this._texture,t={},i=!1;0!==this._rect.width&&0!==this._rect.height&&this.checkRect(e)||(t.rect=new Jn(0,0,e.width,e.height),i=!0),(0===this._originalSize.width||0===this._originalSize.height||i)&&(t.originalSize=new Xn(e.width,e.height),i=!0),i&&(this.reset(t),this.onLoaded())}}]),t}(Tl))||zc);cc.SpriteFrame=Yc,function(e){e[e.right=0]="right",e[e.left=1]="left",e[e.top=2]="top",e[e.bottom=3]="bottom",e[e.front=4]="front",e[e.back=5]="back"}(Xc||(Xc={}));var Kc,Zc=e("TextureCube",Es("cc.TextureCube")((jc=Wc=function(e){function t(){var e;return i(this,t),m(e=c(this,o(t).call(this)),"_mipmaps",Hc,u(e)),e}return s(t,e),r(t,[{key:"mipmaps",get:function(){return this._mipmaps},set:function(e){var t=this;if(this._mipmaps=e,this._setMipmapLevel(this._mipmaps.length),this._mipmaps.length>0){var i=this._mipmaps[0].front;this.reset({width:i.width,height:i.height,format:i.format,mipmapLevel:this._mipmaps.length}),this._mipmaps.forEach((function(e,i){Qc(e,(function(e,n){t._assignImage(e,i,n)}))}))}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length})}},{key:"image",get:function(){return 0===this._mipmaps.length?null:this._mipmaps[0]},set:function(e){this.mipmaps=e?[e]:[]}}],[{key:"fromTexture2DArray",value:function(e,i){for(var n=[],r=e.length/6,a=0;a<r;a++){var s=6*a;n.push({front:e[s+Xc.front].image,back:e[s+Xc.back].image,left:e[s+Xc.left].image,right:e[s+Xc.right].image,top:e[s+Xc.top].image,bottom:e[s+Xc.bottom].image})}return(i=i||new t).mipmaps=n,i}}]),r(t,[{key:"onLoaded",value:function(){this.mipmaps=this._mipmaps,this.loaded=!0,this.emit("load")}},{key:"reset",value:function(e){this._width=e.width,this._height=e.height,this._setGFXFormat(e.format),this._setMipmapLevel(e.mipmapLevel||1),this._tryReset()}},{key:"updateMipmaps",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1?arguments[1]:void 0;if(!(t>=this._mipmaps.length))for(var n=Math.min(void 0===i?this._mipmaps.length:i,this._mipmaps.length-t),r=function(i){var n=t+i;Qc(e._mipmaps[n],(function(t,i){e._assignImage(t,n,i)}))},a=0;a<n;++a)r(a)}},{key:"destroy",value:function(){return this._mipmaps=[],f(o(t.prototype),"destroy",this).call(this)}},{key:"releaseTexture",value:function(){this.mipmaps=[]}},{key:"_serialize",value:function(e){return{base:f(o(t.prototype),"_serialize",this).call(this),mipmaps:this._mipmaps.map((function(t){return e?{front:Editor.Utils.UuidUtils.compressUuid(t.front._uuid,!0),back:Editor.Utils.UuidUtils.compressUuid(t.back._uuid,!0),left:Editor.Utils.UuidUtils.compressUuid(t.left._uuid,!0),right:Editor.Utils.UuidUtils.compressUuid(t.right._uuid,!0),top:Editor.Utils.UuidUtils.compressUuid(t.top._uuid,!0),bottom:Editor.Utils.UuidUtils.compressUuid(t.bottom._uuid,!0)}:{front:t.front._uuid,back:t.back._uuid,left:t.left._uuid,right:t.right._uuid,top:t.top._uuid,bottom:t.bottom._uuid}}))}}},{key:"_deserialize",value:function(e,i){var n=e;f(o(t.prototype),"_deserialize",this).call(this,n.base,i),this._mipmaps=new Array(n.mipmaps.length);for(var r=0;r<n.mipmaps.length;++r){this._mipmaps[r]={front:new Ju,back:new Ju,left:new Ju,right:new Ju,top:new Ju,bottom:new Ju};var a=n.mipmaps[r];i.result.push(this._mipmaps[r],"front",a.front),i.result.push(this._mipmaps[r],"back",a.back),i.result.push(this._mipmaps[r],"left",a.left),i.result.push(this._mipmaps[r],"right",a.right),i.result.push(this._mipmaps[r],"top",a.top),i.result.push(this._mipmaps[r],"bottom",a.bottom)}}},{key:"_getGfxTextureCreateInfo",value:function(e){var t=Object.assign({type:bo.TEX2D,width:this._width,height:this._height,arrayLayer:6},e);return t.flags=(t.flags||0)|So.CUBEMAP,t}},{key:"_getGfxTextureViewCreateInfo",value:function(e){return Object.assign({type:xo.CUBE,layerCount:6},e)}}]),t}(Nc),Wc.FaceIndex=Xc,Hc=v((Vc=jc).prototype,"_mipmaps",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Gc=Vc))||Gc);function Qc(e,t){t(e.front,Xc.front),t(e.back,Xc.back),t(e.left,Xc.left),t(e.right,Xc.right),t(e.top,Xc.top),t(e.bottom,Xc.bottom)}cc.TextureCube=Zc,function(e){e.TOUCH_START="touch-start",e.TOUCH_MOVE="touch-move",e.TOUCH_END="touch-end",e.TOUCH_CANCEL="touch-cancel",e.MOUSE_DOWN="mouse-down",e.MOUSE_MOVE="mouse-move",e.MOUSE_UP="mouse-up",e.MOUSE_WHEEL="mouse-wheel",e.MOUSE_ENTER="mouse-enter",e.MOUSE_LEAVE="mouse-leave",e.KEY_DOWN="keydown",e.KEY_UP="keyup",e.DEVICEMOTION="devicemotion",e.TRANSFORM_CHANGED="transform-changed",e.SCENE_CHANGED_FOR_PERSISTS="scene-changed-for-persists",e.SIZE_CHANGED="size-changed",e.ANCHOR_CHANGED="anchor-changed",e.CHILD_ADDED="child-added",e.CHILD_REMOVED="child-removed",e.PARENT_CHANGED="parent-changed",e.NODE_DESTROYED="node-destroyed"}(Kc||(Kc=e("SystemEventType",{}))),pt(Kc),cc.SystemEventType=Kc;var Jc=e("Event",function(){function e(t,n){i(this,e),this.target=null,this.currentTarget=null,this.eventPhase=0,this.propagationStopped=!1,this.propagationImmediateStopped=!1,this.type=t,this.bubbles=!!n}return r(e,[{key:"unuse",value:function(){this.type=e.NO_TYPE,this.target=null,this.currentTarget=null,this.eventPhase=e.NONE,this.propagationStopped=!1,this.propagationImmediateStopped=!1}},{key:"reuse",value:function(e,t){this.type=e,this.bubbles=t||!1}},{key:"isStopped",value:function(){return this.propagationStopped||this.propagationImmediateStopped}},{key:"getCurrentTarget",value:function(){return this.currentTarget}},{key:"getType",value:function(){return this.type}}]),e}());Jc.NO_TYPE="no_type",Jc.TOUCH="touch",Jc.MOUSE="mouse",Jc.KEYBOARD="keyboard",Jc.ACCELERATION="acceleration",Jc.NONE=0,Jc.CAPTURING_PHASE=1,Jc.AT_TARGET=2,Jc.BUBBLING_PHASE=3,cc.Event=Jc;var $c=e("EventMouse",function(e){function t(e,n){var r;return i(this,t),(r=c(this,o(t).call(this,Jc.MOUSE,n))).movementX=0,r.movementY=0,r._button=0,r._x=0,r._y=0,r._prevX=0,r._prevY=0,r._scrollX=0,r._scrollY=0,r._eventType=e,r}return s(t,e),r(t,[{key:"setScrollData",value:function(e,t){this._scrollX=e,this._scrollY=t}},{key:"getScrollX",value:function(){return this._scrollX}},{key:"getScrollY",value:function(){return this._scrollY}},{key:"setLocation",value:function(e,t){this._x=e,this._y=t}},{key:"getLocation",value:function(e){return e||(e=new Mi),Mi.set(e,this._x,this._y),e}},{key:"getLocationInView",value:function(e){return e||(e=new Mi),Mi.set(e,this._x,cc.view._designResolutionSize.height-this._y),e}},{key:"getUILocation",value:function(e){return e||(e=new Mi),Mi.set(e,this._x,this._y),cc.view._convertPointWithScale(e),e}},{key:"_setPrevCursor",value:function(e,t){this._prevX=e,this._prevY=t}},{key:"getPreviousLocation",value:function(e){return e||(e=new Mi),Mi.set(e,this._prevX,this._prevY),e}},{key:"getUIPreviousLocation",value:function(e){return e||(e=new Mi),Mi.set(e,this._prevX,this._prevY),cc.view._convertPointWithScale(e),e}},{key:"getDelta",value:function(e){return e||(e=new Mi),Mi.set(e,this._x-this._prevX,this._y-this._prevY),e}},{key:"getDeltaX",value:function(){return this._x-this._prevX}},{key:"getDeltaY",value:function(){return this._y-this._prevY}},{key:"getUIDelta",value:function(e){return e||(e=new Mi),Mi.set(e,(this._x-this._prevX)/cc.view.getScaleX(),(this._y-this._prevY)/cc.view.getScaleY()),e}},{key:"getUIDeltaX",value:function(){return(this._x-this._prevX)/cc.view.getScaleX()}},{key:"getUIDeltaY",value:function(){return(this._y-this._prevY)/cc.view.getScaleY()}},{key:"setButton",value:function(e){this._button=e}},{key:"getButton",value:function(){return this._button}},{key:"getLocationX",value:function(){return this._x}},{key:"getLocationY",value:function(){return this._y}},{key:"getUILocationX",value:function(){var e=cc.view.getViewportRect();return(this._x-e.x)/cc.view.getScaleX()}},{key:"getUILocationY",value:function(){var e=cc.view.getViewportRect();return(this._y-e.y)/cc.view.getScaleY()}}]),t}(Jc));$c.NONE=0,$c.DOWN=1,$c.UP=2,$c.MOVE=3,$c.SCROLL=4,$c.BUTTON_LEFT=0,$c.BUTTON_RIGHT=2,$c.BUTTON_MIDDLE=1,$c.BUTTON_4=3,$c.BUTTON_5=4,$c.BUTTON_6=5,$c.BUTTON_7=6,$c.BUTTON_8=7;var eh=e("EventTouch",function(e){function t(e,n){var r;return i(this,t),(r=c(this,o(t).call(this,Jc.TOUCH,n))).touch=null,r._eventCode=0,r.simulate=!1,r._eventCode=0,r._touches=e||[],r}return s(t,e),r(t,[{key:"getEventCode",value:function(){return this._eventCode}},{key:"getTouches",value:function(){return this._touches}},{key:"_setEventCode",value:function(e){this._eventCode=e}},{key:"_setTouches",value:function(e){this._touches=e}},{key:"setLocation",value:function(e,t){this.touch&&this.touch.setTouchInfo(this.touch.getID(),e,t)}},{key:"getLocation",value:function(e){return this.touch?this.touch.getLocation(e):new Mi}},{key:"getUILocation",value:function(e){return this.touch?this.touch.getUILocation(e):new Mi}},{key:"getLocationInView",value:function(e){return this.touch?this.touch.getLocationInView(e):new Mi}},{key:"getUILocationInView",value:function(e){return this.touch?this.touch.getLocationInView(e):new Mi}},{key:"getPreviousLocation",value:function(e){return this.touch?this.touch.getPreviousLocation(e):new Mi}},{key:"getStartLocation",value:function(e){return this.touch?this.touch.getStartLocation(e):new Mi}},{key:"getUIStartLocation",value:function(e){return this.touch?this.touch.getUIStartLocation(e):new Mi}},{key:"getID",value:function(){return this.touch?this.touch.getID():null}},{key:"getDelta",value:function(e){return this.touch?this.touch.getDelta(e):new Mi}},{key:"getUIDelta",value:function(e){return this.touch?this.touch.getUIDelta(e):new Mi}},{key:"getDeltaX",value:function(e){return this.touch?this.touch.getDelta(e).x:0}},{key:"getDeltaY",value:function(e){return this.touch?this.touch.getDelta(e).y:0}},{key:"getLocationX",value:function(){return this.touch?this.touch.getLocationX():0}},{key:"getLocationY",value:function(){return this.touch?this.touch.getLocationY():0}}]),t}(Jc));eh.MAX_TOUCHES=5,eh.BEGAN=0,eh.MOVED=1,eh.ENDED=2,eh.CANCELLED=3;var th=e("EventAcceleration",function(e){function t(e,n){var r;return i(this,t),(r=c(this,o(t).call(this,Jc.ACCELERATION,n))).acc=e,r}return s(t,e),t}(Jc)),ih=e("EventKeyboard",function(e){function t(e,n,r){var a;return i(this,t),a=c(this,o(t).call(this,Jc.KEYBOARD,r)),"number"==typeof e?a.keyCode=e:(a.keyCode=e.keyCode,a.rawEvent=e),a.isPressed=n,a}return s(t,e),t}(Jc));Jc.EventMouse=$c,Jc.EventTouch=eh,Jc.EventAcceleration=th,Jc.EventKeyboard=ih;var nh=function(){function e(t,n,r){i(this,e),this.owner=null,this.mask=null,this._previousIn=!1,this._target=null,this._registered=!1,this._fixedPriority=0,this._node=null,this._paused=!0,this._isEnabled=!0,this._onEvent=r,this._type=t||0,this._listenerID=n||""}return r(e,[{key:"onEvent",get:function(){return this._onEvent}}],[{key:"create",value:function(e){cc.assertID(e&&e.event,1900);var t=e.event;delete e.event;var i=null;if(t===cc.EventListener.TOUCH_ONE_BY_ONE?i=new sh:t===cc.EventListener.TOUCH_ALL_AT_ONCE?i=new oh:t===cc.EventListener.MOUSE?i=new ah:t===cc.EventListener.KEYBOARD?i=new uh:t===cc.EventListener.ACCELERATION&&(i=new lh(e.callback),delete e.callback),i)for(var n=0,r=Object.keys(e);n<r.length;n++){var a=r[n];i[a]=e[a]}return i}}]),r(e,[{key:"_setPaused",value:function(e){this._paused=e}},{key:"_isPaused",value:function(){return this._paused}},{key:"_setRegistered",value:function(e){this._registered=e}},{key:"_isRegistered",value:function(){return this._registered}},{key:"_getType",value:function(){return this._type}},{key:"_getListenerID",value:function(){return this._listenerID}},{key:"_setFixedPriority",value:function(e){this._fixedPriority=e}},{key:"_getFixedPriority",value:function(){return this._fixedPriority}},{key:"_setSceneGraphPriority",value:function(e){this._target=e,this._node=e}},{key:"_getSceneGraphPriority",value:function(){return this._node}},{key:"checkAvailable",value:function(){return null!==this._onEvent}},{key:"clone",value:function(){return null}},{key:"setEnabled",value:function(e){this._isEnabled=e}},{key:"isEnabled",value:function(){return this._isEnabled}}]),e}();nh.UNKNOWN=0,nh.TOUCH_ONE_BY_ONE=1,nh.TOUCH_ALL_AT_ONCE=2,nh.KEYBOARD=3,nh.MOUSE=4,nh.ACCELERATION=6,nh.CUSTOM=8,nh.ListenerID={MOUSE:"__cc_mouse",TOUCH_ONE_BY_ONE:"__cc_touch_one_by_one",TOUCH_ALL_AT_ONCE:"__cc_touch_all_at_once",KEYBOARD:"__cc_keyboard",ACCELERATION:"__cc_acceleration"};var rh=nh.ListenerID,ah=function(e){function t(){var e;return i(this,t),(e=c(this,o(t).call(this,nh.MOUSE,rh.MOUSE,null))).onMouseDown=null,e.onMouseUp=null,e.onMouseMove=null,e.onMouseScroll=null,e._onEvent=function(t){return e._callback(t)},e}return s(t,e),r(t,[{key:"_callback",value:function(e){var t=cc.Event.EventMouse;switch(e._eventType){case t.DOWN:this.onMouseDown&&this.onMouseDown(e);break;case t.UP:this.onMouseUp&&this.onMouseUp(e);break;case t.MOVE:this.onMouseMove&&this.onMouseMove(e);break;case t.SCROLL:this.onMouseScroll&&this.onMouseScroll(e)}}},{key:"clone",value:function(){var e=new t;return e.onMouseDown=this.onMouseDown,e.onMouseUp=this.onMouseUp,e.onMouseMove=this.onMouseMove,e.onMouseScroll=this.onMouseScroll,e}},{key:"checkAvailable",value:function(){return!0}}]),t}(nh),sh=function(e){function t(){var e;return i(this,t),(e=c(this,o(t).call(this,nh.TOUCH_ONE_BY_ONE,rh.TOUCH_ONE_BY_ONE,null))).swallowTouches=!1,e.onTouchBegan=null,e.onTouchMoved=null,e.onTouchEnded=null,e.onTouchCancelled=null,e._claimedTouches=[],e}return s(t,e),r(t,[{key:"setSwallowTouches",value:function(e){this.swallowTouches=e}},{key:"isSwallowTouches",value:function(){return this.swallowTouches}},{key:"clone",value:function(){var e=new t;return e.onTouchBegan=this.onTouchBegan,e.onTouchMoved=this.onTouchMoved,e.onTouchEnded=this.onTouchEnded,e.onTouchCancelled=this.onTouchCancelled,e.swallowTouches=this.swallowTouches,e}},{key:"checkAvailable",value:function(){return!!this.onTouchBegan||(cc.logID(1801),!1)}}]),t}(nh),oh=function(e){function t(){var e;return i(this,t),(e=c(this,o(t).call(this,nh.TOUCH_ALL_AT_ONCE,rh.TOUCH_ALL_AT_ONCE,null))).onTouchesBegan=null,e.onTouchesMoved=null,e.onTouchesEnded=null,e.onTouchesCancelled=null,e}return s(t,e),r(t,[{key:"clone",value:function(){var e=new t;return e.onTouchesBegan=this.onTouchesBegan,e.onTouchesMoved=this.onTouchesMoved,e.onTouchesEnded=this.onTouchesEnded,e.onTouchesCancelled=this.onTouchesCancelled,e}},{key:"checkAvailable",value:function(){return null!==this.onTouchesBegan||null!==this.onTouchesMoved||null!==this.onTouchesEnded||null!==this.onTouchesCancelled||(cc.logID(1802),!1)}}]),t}(nh),lh=function(e){function t(e){var n;return i(this,t),(n=c(this,o(t).call(this,nh.ACCELERATION,rh.ACCELERATION,null)))._onAccelerationEvent=null,n._onEvent=function(e){return n._callback(e)},n._onAccelerationEvent=e,n}return s(t,e),r(t,[{key:"_callback",value:function(e){this._onAccelerationEvent&&this._onAccelerationEvent(e.acc,e)}},{key:"checkAvailable",value:function(){return cc.assertID(this._onAccelerationEvent,1803),!0}},{key:"clone",value:function(){return new t(this._onAccelerationEvent)}}]),t}(nh),uh=function(e){function t(){var e;return i(this,t),(e=c(this,o(t).call(this,nh.KEYBOARD,rh.KEYBOARD,null))).onKeyPressed=null,e.onKeyReleased=null,e._onEvent=function(t){return e._callback(t)},e}return s(t,e),r(t,[{key:"_callback",value:function(e){e.isPressed?this.onKeyPressed&&this.onKeyPressed(e.keyCode,e):this.onKeyReleased&&this.onKeyReleased(e.keyCode,e)}},{key:"clone",value:function(){var e=new t;return e.onKeyPressed=this.onKeyPressed,e.onKeyReleased=this.onKeyReleased,e}},{key:"checkAvailable",value:function(){return null!==this.onKeyPressed||null!==this.onKeyReleased||(cc.logID(1800),!1)}}]),t}(nh);cc.EventListener=nh;var ch=nh.ListenerID;var hh=function(){function e(){i(this,e),this.gt0Index=0,this._fixedListeners=[],this._sceneGraphListeners=[]}return r(e,[{key:"size",value:function(){return this._fixedListeners.length+this._sceneGraphListeners.length}},{key:"empty",value:function(){return 0===this._fixedListeners.length&&0===this._sceneGraphListeners.length}},{key:"push",value:function(e){0===e._getFixedPriority()?this._sceneGraphListeners.push(e):this._fixedListeners.push(e)}},{key:"clearSceneGraphListeners",value:function(){this._sceneGraphListeners.length=0}},{key:"clearFixedListeners",value:function(){this._fixedListeners.length=0}},{key:"clear",value:function(){this._sceneGraphListeners.length=0,this._fixedListeners.length=0}},{key:"getFixedPriorityListeners",value:function(){return this._fixedListeners}},{key:"getSceneGraphPriorityListeners",value:function(){return this._sceneGraphListeners}}]),e}();var fh,_h,dh,ph=e("eventManager",new(function(){function e(){i(this,e),this._listenersMap={},this._priorityDirtyFlagMap={},this._nodeListenersMap={},this._toAddedListeners=[],this._toRemovedListeners=[],this._dirtyListeners=[],this._inDispatch=0,this._isEnabled=!1,this._internalCustomListenerIDs=[],this._currentTouch=null}return r(e,[{key:"pauseTarget",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(e instanceof cc._BaseNode){var i=this._nodeListenersMap[e.uuid];if(i)for(var n=0;n<i.length;++n){var r=i[n];r._setPaused(!0)}if(!0===t){var a=e.children;if(a)for(var s=0;s<a.length;++s){var o=a[s];this.pauseTarget(o,!0)}}}else cc.warnID(3506)}},{key:"resumeTarget",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(e instanceof cc._BaseNode){var i=this._nodeListenersMap[e.uuid];if(i)for(var n=0;n<i.length;++n){var r=i[n];r._setPaused(!1)}if(this._setDirtyForNode(e),!0===t&&e.children.length>0){var a=e.children;if(a)for(var s=0;s<a.length;++s){var o=a[s];this.resumeTarget(o,!0)}}}else cc.warnID(3506)}},{key:"frameUpdateListeners",value:function(){var e=this._listenersMap,t=this._priorityDirtyFlagMap;for(var i in e)e[i].empty()&&(delete t[i],delete e[i]);var n=this._toAddedListeners;if(0!==n.length){for(var r=0,a=n.length;r<a;r++)this._forceAddEventListener(n[r]);n.length=0}0!==this._toRemovedListeners.length&&this._cleanToRemovedListeners()}},{key:"hasEventListener",value:function(e){return!!this._getListeners(e)}},{key:"addListener",value:function(e,t){if(cc.assertID(e&&t,3503),cc.js.isNumber(t)||t instanceof cc._BaseNode){if(e instanceof cc.EventListener){if(e._isRegistered())return void cc.logID(3505)}else cc.assertID(!cc.js.isNumber(t),3504),e=cc.EventListener.create(e);if(e.checkAvailable()){if(cc.js.isNumber(t)){if(0===t)return void cc.logID(3500);e._setSceneGraphPriority(null),e._setFixedPriority(t),e._setRegistered(!0),e._setPaused(!1),this._addListener(e)}else{if(!function(e){for(;e;){if(e.getComponent("cc.CanvasComponent"))return!0;e=e.parent}return!1}(t))return void cc.logID(3512);e._setSceneGraphPriority(t),e._setFixedPriority(0),e._setRegistered(!0),this._addListener(e)}return e}}else cc.warnID(3506)}},{key:"addCustomListener",value:function(e,t){var i=nh.create({event:cc.EventListener.CUSTOM,eventName:e,callback:t});return this.addListener(i,1),i}},{key:"removeListener",value:function(e){if(null!=e){var t=!1,i=this._listenersMap;for(var n in i){var r=i[n],a=r.getFixedPriorityListeners(),s=r.getSceneGraphPriorityListeners();if((t=this._removeListenerInVector(s,e))?this._setDirty(e._getListenerID(),2):(t=this._removeListenerInVector(a,e))&&this._setDirty(e._getListenerID(),1),r.empty()&&(delete this._priorityDirtyFlagMap[e._getListenerID()],delete i[n]),t)break}if(!t)for(var o=this._toAddedListeners,l=o.length-1;l>=0;l--){var u=o[l];if(u===e){cc.js.array.removeAt(o,l),u._setRegistered(!1);break}}}}},{key:"removeListeners",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(cc.js.isNumber(e)||e instanceof cc._BaseNode)if(void 0!==e._id){var i=this._nodeListenersMap[e._id];if(i){for(var n=cc.js.array.copy(i),r=0;r<n.length;++r){var a=n[r];this.removeListener(a)}delete this._nodeListenersMap[e._id]}for(var s=this._toAddedListeners,o=0;o<s.length;){var l=s[o];l._getSceneGraphPriority()===e?(l._setSceneGraphPriority(null),l._setRegistered(!1),s.splice(o,1)):++o}if(!0===t)for(var u=e.getChildren(),c=0;c<u.length;++c){var h=u[c];this.removeListeners(h,!0)}}else e===cc.EventListener.TOUCH_ONE_BY_ONE?this._removeListenersForListenerID(ch.TOUCH_ONE_BY_ONE):e===cc.EventListener.TOUCH_ALL_AT_ONCE?this._removeListenersForListenerID(ch.TOUCH_ALL_AT_ONCE):e===cc.EventListener.MOUSE?this._removeListenersForListenerID(ch.MOUSE):e===cc.EventListener.ACCELERATION?this._removeListenersForListenerID(ch.ACCELERATION):e===cc.EventListener.KEYBOARD?this._removeListenersForListenerID(ch.KEYBOARD):cc.logID(3501);else cc.warnID(3506)}},{key:"removeCustomListeners",value:function(e){this._removeListenersForListenerID(e)}},{key:"removeAllListeners",value:function(){var e=this._listenersMap,t=this._internalCustomListenerIDs;for(var i in e)-1===t.indexOf(i)&&this._removeListenersForListenerID(i)}},{key:"setPriority",value:function(e,t){if(null!=e){var i=this._listenersMap;for(var n in i){var r=i[n].getFixedPriorityListeners();if(r)if(-1!==r.indexOf(e))return null!=e._getSceneGraphPriority()&&cc.logID(3502),void(e._getFixedPriority()!==t&&(e._setFixedPriority(t),this._setDirty(e._getListenerID(),1)))}}}},{key:"setEnabled",value:function(e){this._isEnabled=e}},{key:"isEnabled",value:function(){return this._isEnabled}},{key:"dispatchEvent",value:function(e){if(this._isEnabled)if(this._updateDirtyFlagForSceneGraph(),this._inDispatch++,e&&e.getType){if(e.getType().startsWith(cc.Event.TOUCH))return this._dispatchTouchEvent(e),void this._inDispatch--;var t=function(e){var t=Jc,i=e.type;return i===t.ACCELERATION?ch.ACCELERATION:i===t.KEYBOARD?ch.KEYBOARD:i.startsWith(t.MOUSE)?ch.MOUSE:(i.startsWith(t.TOUCH)&&cc.logID(2e3),"")}(e);this._sortEventListeners(t);var i=this._listenersMap[t];null!=i&&(this._dispatchEventToListeners(i,this._onListenerCallback,e),this._onUpdateListeners(i)),this._inDispatch--}else cc.errorID(3511)}},{key:"_onListenerCallback",value:function(e,t){t.currentTarget=e._target;var i=e.onEvent;return i&&i(t),t.isStopped()}},{key:"dispatchCustomEvent",value:function(e,t){var i=new cc.Event.EventCustom(e);i.setUserData(t),this.dispatchEvent(i)}},{key:"_setDirtyForNode",value:function(e){var t=this._nodeListenersMap[e._id];if(void 0!==t)for(var i=0,n=t.length;i<n;i++){var r=t[i]._getListenerID();null==this._dirtyListeners[r]&&(this._dirtyListeners[r]=!0)}if(e.children.length>0)for(var a=e.children,s=0,o=a?a.length:0;s<o;s++)this._setDirtyForNode(a[s])}},{key:"_addListener",value:function(e){0===this._inDispatch?this._forceAddEventListener(e):this._toAddedListeners.push(e)}},{key:"_forceAddEventListener",value:function(e){var t=e._getListenerID(),i=this._listenersMap[t];if(i||(i=new hh,this._listenersMap[t]=i),i.push(e),0===e._getFixedPriority()){this._setDirty(t,2);var n=e._getSceneGraphPriority();null===n&&cc.logID(3507),this._associateNodeAndEventListener(n,e),n.activeInHierarchy&&this.resumeTarget(n)}else this._setDirty(t,1)}},{key:"_getListeners",value:function(e){return this._listenersMap[e]}},{key:"_updateDirtyFlagForSceneGraph",value:function(){var e=this._dirtyListeners;for(var t in e)this._setDirty(t,2);this._dirtyListeners.length=0}},{key:"_removeAllListenersInVector",value:function(e){if(e)for(var t,i=e.length-1;i>=0;i--)(t=e[i])._setRegistered(!1),null!=t._getSceneGraphPriority()&&(this._dissociateNodeAndEventListener(t._getSceneGraphPriority(),t),t._setSceneGraphPriority(null)),0===this._inDispatch&&cc.js.array.removeAt(e,i)}},{key:"_removeListenersForListenerID",value:function(e){var t=this._listenersMap[e];if(t){var i=t.getFixedPriorityListeners(),n=t.getSceneGraphPriorityListeners();this._removeAllListenersInVector(n),this._removeAllListenersInVector(i),delete this._priorityDirtyFlagMap[e],this._inDispatch||(t.clear(),delete this._listenersMap[e])}for(var r=this._toAddedListeners,a=r.length-1;a>=0;a--){var s=r[a];s&&s._getListenerID()===e&&cc.js.array.removeAt(r,a)}}},{key:"_sortEventListeners",value:function(e){var t=0,i=this._priorityDirtyFlagMap;(i[e]&&(t=i[e]),0!==t)&&(i[e]=0,1&t&&this._sortListenersOfFixedPriority(e),2&t&&cc.director.getScene()&&this._sortListenersOfSceneGraphPriority(e))}},{key:"_sortListenersOfSceneGraphPriority",value:function(e){var t=this._getListeners(e);if(t){var i=t.getSceneGraphPriorityListeners();i&&0!==i.length&&t.getSceneGraphPriorityListeners().sort(this._sortEventListenersOfSceneGraphPriorityDes)}}},{key:"_sortEventListenersOfSceneGraphPriorityDes",value:function(e,t){var i=e._getSceneGraphPriority(),n=t._getSceneGraphPriority();if(!(t&&n&&n._activeInHierarchy&&n._uiProps.uiTransformComp))return-1;if(!(e&&i&&i._activeInHierarchy&&i._uiProps.uiTransformComp))return 1;var r=i,a=n,s=i._uiProps.uiTransformComp,o=n._uiProps.uiTransformComp,l=!1;if(s.visibility!==o.visibility)return o.visibility-s.visibility;for(;r.parent._id!==a.parent._id;)r=null===r.parent.parent?(l=!0)&&n:r.parent,a=null===a.parent.parent?(l=!0)&&i:a.parent;if(r._id===a._id){if(r._id===n._id)return-1;if(r._id===i._id)return 1}var u=r.getSiblingIndex(),c=a.getSiblingIndex();return l?u-c:c-u}},{key:"_sortListenersOfFixedPriority",value:function(e){var t=this._listenersMap[e];if(t){var i=t.getFixedPriorityListeners();if(i&&0!==i.length){i.sort(this._sortListenersOfFixedPriorityAsc);for(var n=0,r=i.length;n<r&&!(i[n]._getFixedPriority()>=0);)++n;t.gt0Index=n}}}},{key:"_sortListenersOfFixedPriorityAsc",value:function(e,t){return e._getFixedPriority()-t._getFixedPriority()}},{key:"_onUpdateListeners",value:function(e){var t=e.getFixedPriorityListeners(),i=e.getSceneGraphPriorityListeners(),n=this._toRemovedListeners;if(i)for(var r=i.length-1;r>=0;r--){var a=i[r];if(!a._isRegistered()){cc.js.array.removeAt(i,r);var s=n.indexOf(a);-1!==s&&n.splice(s,1)}}if(t)for(var o=t.length-1;o>=0;o--){var l=t[o];if(!l._isRegistered()){cc.js.array.removeAt(t,o);var u=n.indexOf(l);-1!==u&&n.splice(u,1)}}i&&0===i.length&&e.clearSceneGraphListeners(),t&&0===t.length&&e.clearFixedListeners()}},{key:"_updateTouchListeners",value:function(e){var t=this._inDispatch;if(cc.assertID(t>0,3508),!(t>1)){var i;(i=this._listenersMap[ch.TOUCH_ONE_BY_ONE])&&this._onUpdateListeners(i),(i=this._listenersMap[ch.TOUCH_ALL_AT_ONCE])&&this._onUpdateListeners(i),cc.assertID(1===t,3509);var n=this._toAddedListeners;if(0!==n.length){for(var r=0,a=n.length;r<a;r++)this._forceAddEventListener(n[r]);this._toAddedListeners.length=0}0!==this._toRemovedListeners.length&&this._cleanToRemovedListeners()}}},{key:"_cleanToRemovedListeners",value:function(){for(var e=this._toRemovedListeners,t=0;t<e.length;++t){var i=e[t],n=this._listenersMap[i._getListenerID()];if(n){var r=n.getFixedPriorityListeners(),a=n.getSceneGraphPriorityListeners();if(a){var s=a.indexOf(i);-1!==s&&a.splice(s,1)}if(r){var o=r.indexOf(i);-1!==o&&r.splice(o,1)}}}e.length=0}},{key:"_onTouchEventCallback",value:function(e,t){if(!e._isRegistered())return!1;var i=t.event,n=i.touch;i.currentTarget=e._getSceneGraphPriority();var r=!1,a=-1,s=i.getEventCode();if(s===eh.BEGAN){if(!cc.macro.ENABLE_MULTI_TOUCH&&ph._currentTouch)return!1;e.onTouchBegan&&(r=e.onTouchBegan(n,i))&&e._isRegistered()&&(e._claimedTouches.push(n),ph._currentTouch=n)}else if(e._claimedTouches.length>0&&-1!==(a=e._claimedTouches.indexOf(n))){if(r=!0,!cc.macro.ENABLE_MULTI_TOUCH&&ph._currentTouch&&ph._currentTouch!==n)return!1;s===eh.MOVED&&e.onTouchMoved?e.onTouchMoved(n,i):s===eh.ENDED?(e.onTouchEnded&&e.onTouchEnded(n,i),e._isRegistered()&&e._claimedTouches.splice(a,1),ph._currentTouch=null):s===eh.CANCELLED&&(e.onTouchCancelled&&e.onTouchCancelled(n,i),e._isRegistered()&&e._claimedTouches.splice(a,1),ph._currentTouch=null)}return i.isStopped()?(ph._updateTouchListeners(i),!0):!!(r&&e._isRegistered()&&e.swallowTouches)&&(t.needsMutableSet&&t.touches.splice(n,1),!0)}},{key:"_dispatchTouchEvent",value:function(e){this._sortEventListeners(ch.TOUCH_ONE_BY_ONE),this._sortEventListeners(ch.TOUCH_ALL_AT_ONCE);var t=this._getListeners(ch.TOUCH_ONE_BY_ONE),i=this._getListeners(ch.TOUCH_ALL_AT_ONCE);if(null!==t||null!==i){var n=e.getTouches(),r=cc.js.array.copy(n),a={event:e,needsMutableSet:t&&i,touches:r,selTouch:null};if(t)for(var s=0;s<n.length;++s){var o=n[s];e.touch=o,e.propagationStopped=e.propagationImmediateStopped=!1,this._dispatchEventToListeners(t,this._onTouchEventCallback,a)}i&&r.length>0&&(this._dispatchEventToListeners(i,this._onTouchesEventCallback,{event:e,touches:r}),e.isStopped())||this._updateTouchListeners(e)}}},{key:"_onTouchesEventCallback",value:function(e,t){if(!e._isRegistered())return!1;var i=t.event,n=t.touches,r=i.getEventCode();return i.currentTarget=e._getSceneGraphPriority(),r===eh.BEGAN&&e.onTouchesBegan?e.onTouchesBegan(n,i):r===eh.MOVED&&e.onTouchesMoved?e.onTouchesMoved(n,i):r===eh.ENDED&&e.onTouchesEnded?e.onTouchesEnded(n,i):r===eh.CANCELLED&&e.onTouchesCancelled&&e.onTouchesCancelled(n,i),!!i.isStopped()&&(ph._updateTouchListeners(i),!0)}},{key:"_associateNodeAndEventListener",value:function(e,t){var i=this._nodeListenersMap[e.uuid];i||(i=[],this._nodeListenersMap[e.uuid]=i),i.push(t)}},{key:"_dissociateNodeAndEventListener",value:function(e,t){var i=this._nodeListenersMap[e.uuid];i&&(cc.js.array.remove(i,t),0===i.length&&delete this._nodeListenersMap[e.uuid])}},{key:"_dispatchEventToListeners",value:function(e,t,i){var n=!1,r=e.getFixedPriorityListeners(),a=e.getSceneGraphPriorityListeners(),s=0;if(r&&0!==r.length)for(;s<e.gt0Index;++s){var o=r[s];if(o.isEnabled()&&!o._isPaused()&&o._isRegistered()&&t(o,i)){n=!0;break}}if(a&&!n)for(var l=0;l<a.length;++l){var u=a[l];if(u.isEnabled()&&!u._isPaused()&&u._isRegistered()&&t(u,i)){n=!0;break}}if(r&&!n)for(;s<r.length;++s){var c=r[s];if(c.isEnabled()&&!c._isPaused()&&c._isRegistered()&&t(c,i)){n=!0;break}}}},{key:"_setDirty",value:function(e,t){var i=this._priorityDirtyFlagMap;null==i[e]?i[e]=t:i[e]=t|i[e]}},{key:"_sortNumberAsc",value:function(e,t){return e-t}},{key:"_removeListenerInCallback",value:function(e,t){if(null==e)return!1;for(var i=e.length-1;i>=0;i--){var n=e[i];if(n._onCustomEvent===t||n.onEvent===t)return n._setRegistered(!1),null!=n._getSceneGraphPriority()&&(this._dissociateNodeAndEventListener(n._getSceneGraphPriority(),n),n._setSceneGraphPriority(null)),0===this._inDispatch?cc.js.array.removeAt(e,i):this._toRemovedListeners.push(n),!0}return!1}},{key:"_removeListenerInVector",value:function(e,t){if(null==e)return!1;for(var i=e.length-1;i>=0;i--){var n=e[i];if(n===t)return n._setRegistered(!1),null!=n._getSceneGraphPriority()&&(this._dissociateNodeAndEventListener(n._getSceneGraphPriority(),n),n._setSceneGraphPriority(null)),0===this._inDispatch?cc.js.array.removeAt(e,i):this._toRemovedListeners.push(n),!0}return!1}}]),e}()));cc.eventManager=ph;var mh=e("Script",Es("cc.Script")(fh=function(e){function t(){return i(this,t),c(this,o(t).apply(this,arguments))}return s(t,e),t}(Tl))||fh);cc._Script=mh;var vh=e("JavaScript",Es("cc.JavaScript")(_h=function(e){function t(){return i(this,t),c(this,o(t).apply(this,arguments))}return s(t,e),t}(mh))||_h);cc._JavaScript=vh;var gh,yh,bh,Eh,Th,Sh,xh,Ah,wh,Ch,Rh,kh,Oh,Ih=e("TypeScript",Es("cc.TypeScript")(dh=function(e){function t(){return i(this,t),c(this,o(t).apply(this,arguments))}return s(t,e),t}(mh))||dh);cc._TypeScript=Ih;var Mh=new ve("Comp"),Lh=(hl.Flags.IsOnEnableCalled,hl.Flags.IsOnLoadCalled),Ph=e("Component",(gh=Es("cc.Component"),yh=Ts({visible:!1}),bh=Ts({visible:!1}),Eh=Ts({displayName:"Script",type:mh,tooltip:void 0}),Th=Ts({visible:!1}),Sh=Ts({visible:!1}),xh=Ts({visible:!1}),gh((Oh=kh=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),s=0;s<r;s++)a[s]=arguments[s];return m(n=c(this,(e=o(t)).call.apply(e,[this].concat(a))),"node",Ch,u(n)),m(n,"_enabled",Rh,u(n)),n._sceneGetter=null,n._id=Mh.getNewId(),n._eventTargets=[],n}return s(t,e),r(t,[{key:"_getRenderScene",value:function(){return this._sceneGetter?this._sceneGetter():this.node.scene._renderScene}},{key:"addComponent",value:function(e){return this.node.addComponent(e)}},{key:"getComponent",value:function(e){return this.node.getComponent(e)}},{key:"getComponents",value:function(e){return this.node.getComponents(e)}},{key:"getComponentInChildren",value:function(e){return this.node.getComponentInChildren(e)}},{key:"getComponentsInChildren",value:function(e){return this.node.getComponentsInChildren(e)}},{key:"destroy",value:function(){f(o(t.prototype),"destroy",this).call(this)&&this._enabled&&this.node.activeInHierarchy&&cc.director._compScheduler.disableComp(this)}},{key:"_onPreDestroy",value:function(){this.unscheduleAllCallbacks();for(var e=this._eventTargets,t=0,i=e.length;t<i;++t){var n=e[t];n&&n.targetOff(this)}e.length=0,cc.director._nodeActivator.destroyComp(this),this.node._removeComponent(this)}},{key:"_instantiate",value:function(e){return e||(e=cc.instantiate._clone(this,this)),e.node=null,e}},{key:"schedule",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:cc.macro.REPEAT_FOREVER,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;cc.assertID(e,1619),cc.assertID(t>=0,1620),t=t||0,i=isNaN(i)?cc.macro.REPEAT_FOREVER:i,n=n||0;var r=cc.director.getScheduler(),a=r.isTargetPaused(this);r.schedule(e,this,t,i,n,a)}},{key:"scheduleOnce",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.schedule(e,0,0,t)}},{key:"unschedule",value:function(e){e&&cc.director.getScheduler().unschedule(e,this)}},{key:"unscheduleAllCallbacks",value:function(){cc.director.getScheduler().unscheduleAllForTarget(this)}},{key:"name",get:function(){if(this._name)return this._name;var e=Ce(this),t=e.lastIndexOf(".");return t>=0&&(e=e.slice(t+1)),this.node.name+"<"+e+">"},set:function(e){this._name=e}},{key:"uuid",get:function(){return this._id}},{key:"__scriptAsset",get:function(){return null}},{key:"enabled",get:function(){return this._enabled},set:function(e){if(this._enabled!==e&&(this._enabled=e,this.node.activeInHierarchy)){var t=cc.director._compScheduler;e?t.enableComp(this):t.disableComp(this)}}},{key:"enabledInHierarchy",get:function(){return this._enabled&&this.node&&this.node.activeInHierarchy}},{key:"_isOnLoadCalled",get:function(){return this._objFlags&Lh}}]),t}(hl),kh.system=null,v((wh=Oh).prototype,"name",[yh],Object.getOwnPropertyDescriptor(wh.prototype,"name"),wh.prototype),v(wh.prototype,"uuid",[bh],Object.getOwnPropertyDescriptor(wh.prototype,"uuid"),wh.prototype),v(wh.prototype,"__scriptAsset",[Eh],Object.getOwnPropertyDescriptor(wh.prototype,"__scriptAsset"),wh.prototype),v(wh.prototype,"enabled",[Th],Object.getOwnPropertyDescriptor(wh.prototype,"enabled"),wh.prototype),v(wh.prototype,"enabledInHierarchy",[Sh],Object.getOwnPropertyDescriptor(wh.prototype,"enabledInHierarchy"),wh.prototype),Ch=v(wh.prototype,"node",[xh],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Rh=v(wh.prototype,"_enabled",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Ah=wh))||Ah)),Bh=Ph.prototype;Bh.update=null,Bh.lateUpdate=null,Bh.__preload=null,Bh.onLoad=null,Bh.start=null,Bh.onEnable=null,Bh.onDisable=null,Bh.onDestroy=null,Bh.onFocusInEditor=null,Bh.onLostFocusInEditor=null,Bh.resetInEditor=null,Bh._getLocalBounds=null,Bh.onRestore=null,Ph._requireComponent=null,Ph._executionOrder=0,Te(Ph,"_registerEditorProps",(function(e,t){var i=t.requireComponent;i&&(e._requireComponent=i);var n=t.executionOrder;n&&"number"==typeof n&&(e._executionOrder=n)})),cc.Component=Ph;hl.Flags.Destroying;var Dh=new Array(16),Fh=null,Nh=new Mi,zh=[Kc.TOUCH_START.toString(),Kc.TOUCH_MOVE.toString(),Kc.TOUCH_END.toString(),Kc.TOUCH_CANCEL.toString()],Uh=[Kc.MOUSE_DOWN.toString(),Kc.MOUSE_ENTER.toString(),Kc.MOUSE_MOVE.toString(),Kc.MOUSE_LEAVE.toString(),Kc.MOUSE_UP.toString(),Kc.MOUSE_WHEEL.toString()];function Gh(e,t){var i=this.owner;return!(!i||!i._uiProps.uiTransformComp)&&(e.getUILocation(Nh),!!i._uiProps.uiTransformComp.isHit(Nh,this)&&(t.type=Kc.TOUCH_START.toString(),t.touch=e,t.bubbles=!0,i.dispatchEvent(t),!0))}function Vh(e,t){var i=this.owner;if(!i||!i._uiProps.uiTransformComp)return!1;t.type=Kc.TOUCH_MOVE.toString(),t.touch=e,t.bubbles=!0,i.dispatchEvent(t)}function Hh(e,t){var i=this.owner;i&&i._uiProps.uiTransformComp&&(e.getUILocation(Nh),i._uiProps.uiTransformComp.isHit(Nh,this)?t.type=Kc.TOUCH_END.toString():t.type=Kc.TOUCH_CANCEL.toString(),t.touch=e,t.bubbles=!0,i.dispatchEvent(t))}function Wh(e,t){var i=this.owner;i&&i._uiProps.uiTransformComp&&(t.type=Kc.TOUCH_CANCEL.toString(),t.touch=e,t.bubbles=!0,i.dispatchEvent(t))}function jh(e){var t=this.owner;t&&t._uiProps.uiTransformComp&&(Nh=e.getUILocation(),t._uiProps.uiTransformComp.isHit(Nh,this)&&(e.type=Kc.MOUSE_DOWN.toString(),e.bubbles=!0,t.dispatchEvent(e)))}function Xh(e){var t=this.owner;if(t&&t._uiProps.uiTransformComp){if(Nh=e.getUILocation(),t._uiProps.uiTransformComp.isHit(Nh,this))this._previousIn||(Fh&&Fh.eventProcessor.mouseListener&&(e.type=Kc.MOUSE_LEAVE,Fh.dispatchEvent(e),Fh.eventProcessor.mouseListener&&(Fh.eventProcessor.mouseListener._previousIn=!1)),Fh=t,e.type=Kc.MOUSE_ENTER.toString(),t.dispatchEvent(e),this._previousIn=!0),e.type=Kc.MOUSE_MOVE.toString(),e.bubbles=!0,t.dispatchEvent(e);else{if(!this._previousIn)return;e.type=Kc.MOUSE_LEAVE.toString(),t.dispatchEvent(e),this._previousIn=!1,Fh=null}e.propagationStopped=!0}}function qh(e){var t=this.owner;t&&t._uiProps.uiTransformComp&&(Nh=e.getUILocation(),t._uiProps.uiTransformComp.isHit(Nh,this)&&(e.type=Kc.MOUSE_UP.toString(),e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0))}function Yh(e){var t=this.owner;t&&t._uiProps.uiTransformComp&&(Nh=e.getUILocation(),t._uiProps.uiTransformComp.isHit(Nh,this)&&(e.type=Kc.MOUSE_WHEEL.toString(),e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0))}function Kh(e){var t=cc.MaskComponent;if(t)for(var i=0,n=e;n&&cc.Node.isNode(n);n=n.parent,++i)if(n.getComponent(t))return{index:i,node:n};return null}function Zh(e,t){if(!e._persistNode){var i=0;if(e.eventProcessor.bubblingTargets)for(;i<t.length;++i)if(e.eventProcessor.bubblingTargets.hasEventListener(t[i]))return!0;if(e.eventProcessor.capturingTargets)for(;i<t.length;++i)if(e.eventProcessor.capturingTargets.hasEventListener(t[i]))return!0;return!1}return!0}var Qh,Jh,$h,ef,tf,nf,rf,af,sf,of=function(){function e(t){i(this,e),this.bubblingTargets=null,this.capturingTargets=null,this.touchListener=null,this.mouseListener=null,this._node=t}return r(e,[{key:"node",get:function(){return this._node}}]),r(e,[{key:"reattach",value:function(){if(this.touchListener){var e=this.touchListener.mask=Kh(this._node);this.mouseListener&&(this.mouseListener.mask=e)}else this.mouseListener&&(this.mouseListener.mask=Kh(this._node))}},{key:"destroy",value:function(){Fh===this._node&&(Fh=null),(this.touchListener||this.mouseListener)&&(ph.removeListeners(this._node),this.touchListener&&(this.touchListener.owner=null,this.touchListener.mask=null,this.touchListener=null),this.mouseListener&&(this.mouseListener.owner=null,this.mouseListener.mask=null,this.mouseListener=null))}},{key:"on",value:function(e,t,i,n){return this._checknSetupSysEvent(e)?this._onDispatch(e,t,i,n):(this.bubblingTargets||(this.bubblingTargets=new ol),this.bubblingTargets.on(e,t,i))}},{key:"once",value:function(e,t,i,n){(this._checknSetupSysEvent(e)&&n?this.capturingTargets=this.capturingTargets||new ol:this.bubblingTargets=this.bubblingTargets||new ol).once(e,t,i)}},{key:"off",value:function(e,t,i,n){var r=-1!==zh.indexOf(e),a=!r&&-1!==Uh.indexOf(e);r||a?(this._offDispatch(e,t,i,n),r?this.touchListener&&!Zh(this._node,zh)&&(ph.removeListener(this.touchListener),this.touchListener=null):a&&this.mouseListener&&!Zh(this._node,Uh)&&(ph.removeListener(this.mouseListener),this.mouseListener=null)):this.bubblingTargets&&this.bubblingTargets.off(e,t,i)}},{key:"emit",value:function(e){if(this.bubblingTargets){for(var t,i=arguments.length,n=new Array(i>1?i-1:0),r=1;r<i;r++)n[r-1]=arguments[r];(t=this.bubblingTargets).emit.apply(t,[e].concat(n))}}},{key:"dispatchEvent",value:function(e){!function(e,t){var i,n=0;for(t.target=e,Dh.length=0,e.eventProcessor.getCapturingTargets(t.type,Dh),t.eventPhase=1,n=Dh.length-1;n>=0;--n)if((i=Dh[n]).eventProcessor.capturingTargets&&(t.currentTarget=i,i.eventProcessor.capturingTargets.emit(t.type,t,Dh),t.propagationStopped))return void(Dh.length=0);if(Dh.length=0,t.eventPhase=2,t.currentTarget=e,e.eventProcessor.capturingTargets&&e.eventProcessor.capturingTargets.emit(t.type,t),!t.propagationImmediateStopped&&e.eventProcessor.bubblingTargets&&e.eventProcessor.bubblingTargets.emit(t.type,t),!t.propagationStopped&&t.bubbles)for(e.eventProcessor.getBubblingTargets(t.type,Dh),t.eventPhase=3,n=0;n<Dh.length;++n)if((i=Dh[n]).eventProcessor.bubblingTargets&&(t.currentTarget=i,i.eventProcessor.bubblingTargets.emit(t.type,t),t.propagationStopped))return void(Dh.length=0);Dh.length=0}(this._node,e),Dh.length=0}},{key:"hasEventListener",value:function(e){var t=!1;return this.bubblingTargets&&(t=this.bubblingTargets.hasEventListener(e)),!t&&this.capturingTargets&&(t=this.capturingTargets.hasEventListener(e)),t}},{key:"targetOff",value:function(e){this.capturingTargets&&this.capturingTargets.targetOff(e),this.bubblingTargets&&this.bubblingTargets.targetOff(e),this.touchListener&&!Zh(this.node,zh)&&(ph.removeListener(this.touchListener),this.touchListener=null),this.mouseListener&&!Zh(this.node,Uh)&&(ph.removeListener(this.mouseListener),this.mouseListener=null)}},{key:"getCapturingTargets",value:function(e,t){for(var i=this._node.parent;i;)i.eventProcessor.capturingTargets&&i.eventProcessor.capturingTargets.hasEventListener(e)&&t.push(i),i=i.parent}},{key:"getBubblingTargets",value:function(e,t){for(var i=this._node.parent;i;)i.eventProcessor.bubblingTargets&&i.eventProcessor.bubblingTargets.hasEventListener(e)&&t.push(i),i=i.parent}},{key:"_checknSetupSysEvent",value:function(e){var t=this,i=!1,n=!1;return-1!==zh.indexOf(e)?(this.touchListener||(this.touchListener=cc.EventListener.create({event:cc.EventListener.TOUCH_ONE_BY_ONE,swallowTouches:!0,owner:this._node,mask:Kh(this._node),onTouchBegan:Gh,onTouchMoved:Vh,onTouchEnded:Hh,onTouchCancelled:Wh}),ph.addListener(this.touchListener,this._node),i=!0),n=!0):-1!==Uh.indexOf(e)&&(this.mouseListener||(this.mouseListener=cc.EventListener.create({event:cc.EventListener.MOUSE,_previousIn:!1,owner:this._node,mask:Kh(this._node),onMouseDown:jh,onMouseMove:Xh,onMouseUp:qh,onMouseScroll:Yh}),ph.addListener(this.mouseListener,this._node),i=!0),n=!0),i&&!this._node.activeInHierarchy&&cc.director.getScheduler().schedule((function(){t._node.activeInHierarchy||ph.pauseTarget(t._node)}),this._node,0,0,0,!1),n}},{key:"_onDispatch",value:function(e,t,i,n){if("boolean"==typeof i?(n=i,i=void 0):n=!!n,t){var r=null;return(r=n?this.capturingTargets=this.capturingTargets||new ol:this.bubblingTargets=this.bubblingTargets||new ol).hasEventListener(e,t,i)||r.on(e,t,i),t}cc.errorID(6800)}},{key:"_offDispatch",value:function(e,t,i,n){if("boolean"==typeof i?(n=i,i=void 0):n=!!n,t){var r=n?this.capturingTargets:this.bubblingTargets;r&&r.off(e,t,i)}else this.capturingTargets&&this.capturingTargets.removeAll(e),this.bubblingTargets&&this.bubblingTargets.removeAll(e)}}]),e}();cc.NodeEventProcessor=of;var lf=hl.Flags.Destroying,uf=hl.Flags.DontDestroy,cf=hl.Flags.Deactivating,hf=(hl.Flags.Activating,new ve("Node"));function ff(e){return e?"string"==typeof e?Ye(e):e:(U(3804),null)}var _f,df,pf,mf,vf,gf,yf,bf,Ef,Tf,Sf,xf,Af,wf=e("BaseNode",Es("cc._BaseNode")((sf=af=function(e){function n(e){var t;return i(this,n),m(t=c(this,o(n).call(this,e)),"_parent",$h,u(t)),m(t,"_children",ef,u(t)),m(t,"_active",tf,u(t)),m(t,"_components",nf,u(t)),m(t,"_prefab",rf,u(t)),t._scene=null,t._activeInHierarchy=!1,t._id=hf.getNewId(),t._eventProcessor=new of(u(t)),t._eventMask=0,t.__eventTargets=[],t._siblingIndex=0,t._registerIfAttached=void 0,t._name=void 0!==e?e:"New Node",t}return s(n,e),r(n,[{key:"components",get:function(){return this._components}},{key:"_persistNode",get:function(){return(this._objFlags&uf)>0},set:function(e){e?this._objFlags|=uf:this._objFlags&=~uf}},{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"uuid",get:function(){return this._id}},{key:"children",get:function(){return this._children}},{key:"active",get:function(){return this._active},set:function(e){if(this._active!==e){this._active=e;var t=this._parent;if(t)t._activeInHierarchy&&cc.director._nodeActivator.activateNode(this,e)}}},{key:"activeInHierarchy",get:function(){return this._activeInHierarchy}},{key:"parent",get:function(){return this._parent},set:function(e){this.setParent(e)}},{key:"scene",get:function(){return this._scene}},{key:"eventProcessor",get:function(){return this._eventProcessor}}],[{key:"_setScene",value:function(e){e instanceof cc.Scene?e._scene=e:null==e._parent?cc.error("Node %s(%s) has not attached to a scene.",e.name,e.uuid):e._scene=e._parent._scene}},{key:"_findComponent",value:function(e,t){var i=t,n=e._components;if(i._sealed)for(var r=0;r<n.length;++r){var a=n[r];if(a.constructor===t)return a}else for(var s=0;s<n.length;++s){var o=n[s];if(o instanceof t)return o}return null}},{key:"_findComponents",value:function(e,t,i){var n=t,r=e._components;if(n._sealed)for(var a=0;a<r.length;++a){var s=r[a];s.constructor===t&&i.push(s)}else for(var o=0;o<r.length;++o){var l=r[o];l instanceof t&&i.push(l)}}},{key:"_findChildComponent",value:function(e,t){for(var i=0;i<e.length;++i){var r=e[i],a=n._findComponent(r,t);if(a)return a;if(r._children.length>0&&(a=n._findChildComponent(r._children,t)))return a}return null}},{key:"_findChildComponents",value:function(e,t,i){for(var r=0;r<e.length;++r){var a=e[r];n._findComponents(a,t,i),a._children.length>0&&n._findChildComponents(a._children,t,i)}}}]),r(n,[{key:"attr",value:function(e){Fe(this,e)}},{key:"getParent",value:function(){return this._parent}},{key:"setParent",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this._parent!==e){var i=this._parent;if(this._parent=e,this._siblingIndex=0,this._onSetParent(i,t),this.emit&&this.emit(Kc.PARENT_CHANGED,i),e&&(e._children.push(this),this._siblingIndex=e._children.length-1,e.emit&&e.emit(Kc.CHILD_ADDED,this)),i&&!(i._objFlags&lf)){var n=i._children.indexOf(this);0,i._children.splice(n,1),i._updateSiblingIndex(),i.emit&&i.emit(Kc.CHILD_REMOVED,this)}this._onHierarchyChanged(i)}}},{key:"getChildByUuid",value:function(e){if(!e)return cc.log("Invalid uuid"),null;for(var t=this._children,i=0,n=t.length;i<n;i++)if(t[i]._id===e)return t[i];return null}},{key:"getChildByName",value:function(e){if(!e)return cc.log("Invalid name"),null;for(var t=this._children,i=0,n=t.length;i<n;i++)if(t[i]._name===e)return t[i];return null}},{key:"getChildByPath",value:function(e){for(var i=e.split("/"),n=this,r=function(e){var t=i[e];if(0===t.length)return"continue";var r=n.children.find((function(e){return e.name===t}));if(!r)return{v:null};n=r},a=0;a<i.length;++a){var s=r(a);switch(s){case"continue":continue;default:if("object"===t(s))return s.v}}return n}},{key:"addChild",value:function(e){cc.assertID(e,1606),cc.assertID(null===e._parent,1605),e.setParent(this)}},{key:"insertChild",value:function(e,t){e.parent=this,e.setSiblingIndex(t)}},{key:"getSiblingIndex",value:function(){return this._siblingIndex}},{key:"setSiblingIndex",value:function(e){if(this._parent)if(this._parent._objFlags&cf)U(3821);else{var t=this._parent._children;e=-1!==e?e:t.length-1;var i=t.indexOf(this);e!==i&&(t.splice(i,1),e<t.length?t.splice(e,0,this):t.push(this),this._parent._updateSiblingIndex(),this._onSiblingIndexChanged&&this._onSiblingIndexChanged(e))}}},{key:"walk",value:function(e,t){var i=1,r=null,a=null,s=0,o=n._stacks[n._stackId];o||(o=[],n._stacks.push(o)),n._stackId++,o.length=0,o[0]=this;for(var l=null,u=!1;i;)if(a=o[--i])if(!u&&e?e(a):u&&t&&t(a),o[i]=null,u){if(u=!1,r)if(r[++s])o[i]=r[s],i++;else if(l&&(o[i]=l,i++,u=!0,l._parent?(s=(r=l._parent._children).indexOf(l),l=l._parent):(l=null,r=null),s<0))break}else a._children.length>0?(l=a,r=a._children,s=0,o[i]=r[s],i++):(o[i]=a,i++,u=!0);o.length=0,n._stackId--}},{key:"removeFromParent",value:function(){this._parent&&this._parent.removeChild(this)}},{key:"removeChild",value:function(e){this._children.indexOf(e)>-1&&(e.parent=null)}},{key:"removeAllChildren",value:function(){for(var e=this._children,t=e.length-1;t>=0;t--){var i=e[t];i&&(i.parent=null)}this._children.length=0}},{key:"isChildOf",value:function(e){var t=this;do{if(t===e)return!0;t=t._parent}while(t);return!1}},{key:"getComponent",value:function(e){var t=ff(e);return t?n._findComponent(this,t):null}},{key:"getComponents",value:function(e){var t=ff(e),i=[];return t&&n._findComponents(this,t,i),i}},{key:"getComponentInChildren",value:function(e){var t=ff(e);return t?n._findChildComponent(this._children,t):null}},{key:"getComponentsInChildren",value:function(e){var t=ff(e),i=[];return t&&(n._findComponents(this,t,i),n._findChildComponents(this._children,t,i)),i}},{key:"addComponent",value:function(e){var t;if("string"==typeof e){if(!(t=Ye(e)))return U(3807,e),cc._RF.peek()&&U(3808,e),null}else{if(!e)return U(3804),null;t=e}if("function"!=typeof t)return U(3809),null;if(!Ue(t,cc.Component))return U(3810),null;var i=t._requireComponent;if(i&&!this.getComponent(i)&&!this.addComponent(i))return null;var n=new t;return n.node=this,this._components.push(n),this._activeInHierarchy&&cc.director._nodeActivator.activateComp(n),n}},{key:"removeComponent",value:function(e){if(e){var t=null;(t=e instanceof Ph?e:this.getComponent(e))&&t.destroy()}else U(3813)}},{key:"on",value:function(e,t,i,n){switch(e){case Kc.TRANSFORM_CHANGED:this._eventMask|=1}this._eventProcessor.on(e,t,i,n)}},{key:"off",value:function(e,t,i,n){if(this._eventProcessor.off(e,t,i,n),!this._eventProcessor.hasEventListener(e))switch(e){case Kc.TRANSFORM_CHANGED:this._eventMask&=-2}}},{key:"once",value:function(e,t,i,n){this._eventProcessor.once(e,t,i,n)}},{key:"emit",value:function(e){for(var t,i=arguments.length,n=new Array(i>1?i-1:0),r=1;r<i;r++)n[r-1]=arguments[r];(t=this._eventProcessor).emit.apply(t,[e].concat(n))}},{key:"dispatchEvent",value:function(e){this._eventProcessor.dispatchEvent(e)}},{key:"hasEventListener",value:function(e){return this._eventProcessor.hasEventListener(e)}},{key:"targetOff",value:function(e){this._eventProcessor.targetOff(e),1&this._eventMask&&!this._eventProcessor.hasEventListener(Kc.TRANSFORM_CHANGED)&&(this._eventMask&=-2)}},{key:"destroy",value:function(){return!!f(o(n.prototype),"destroy",this).call(this)&&(this._activeInHierarchy&&this._disableChildComps(),!0)}},{key:"destroyAllChildren",value:function(){for(var e=this._children,t=0;t<e.length;++t)e[t].destroy()}},{key:"_removeComponent",value:function(e){if(e){if(!(this._objFlags&lf)){var t=this._components.indexOf(e);-1!==t?this._components.splice(t,1):e.node!==this&&U(3815)}}else U(3814)}},{key:"_updateSiblingIndex",value:function(){for(var e=0;e<this._children.length;++e)this._children[e]._siblingIndex=e}},{key:"_onSetParent",value:function(e){this._parent&&(null!=e&&e._scene===this._parent._scene||null==this._parent._scene||this.walk((function(e){n._setScene(e)})))}},{key:"_onPostActivated",value:function(e){}},{key:"_onBatchRestored",value:function(){}},{key:"_onBatchCreated",value:function(){this._parent&&(this._siblingIndex=this._parent.children.indexOf(this))}},{key:"_onPreDestroy",value:function(){this._onPreDestroyBase()}},{key:"_onHierarchyChanged",value:function(e){return this._onHierarchyChangedBase(e)}},{key:"_instantiate",value:function(e){e||(e=cc.instantiate._clone(this,this));var t=this._prefab;t&&this===t.root&&t.sync;return e._parent=null,e._onBatchRestored(),e}},{key:"_onHierarchyChangedBase",value:function(e){var t=this._parent;!this._persistNode||t instanceof cc.Scene||cc.game.removePersistRootNode(this);var i=this._active&&!(!t||!t._activeInHierarchy);this._activeInHierarchy!==i&&cc.director._nodeActivator.activateNode(this,i)}},{key:"_onPreDestroyBase",value:function(){this._objFlags|=lf;var e=this._parent,t=!!e&&0!=(e._objFlags&lf);for(var i=this._children,n=0;n<i.length;++n)i[n]._destroyImmediate();for(var r=this._components,a=0;a<r.length;++a)r[a]._destroyImmediate();for(var s=this.__eventTargets,o=0;o<s.length;++o){var l=s[o];l&&l.targetOff(this)}if(s.length=0,this._persistNode&&cc.game.removePersistRootNode(this),!t&&e){this.emit(Kc.PARENT_CHANGED,this);var u=e._children.indexOf(this);e._children.splice(u,1),this._siblingIndex=0,e.emit&&e.emit(Kc.CHILD_REMOVED,this)}return this.emit(Kc.NODE_DESTROYED,this),t}},{key:"_disableChildComps",value:function(){for(var e=this._components,t=0;t<e.length;++t){var i=e[t];i._enabled&&cc.director._compScheduler.disableComp(i)}for(var n=this._children,r=0;r<n.length;++r){var a=n[r];a._active&&a._disableChildComps()}}}]),n}(hl),af.idGenerator=hf,af._stacks=[[]],af._stackId=0,v((Jh=sf).prototype,"_persistNode",[Ts],Object.getOwnPropertyDescriptor(Jh.prototype,"_persistNode"),Jh.prototype),v(Jh.prototype,"name",[Ts],Object.getOwnPropertyDescriptor(Jh.prototype,"name"),Jh.prototype),v(Jh.prototype,"uuid",[Ts],Object.getOwnPropertyDescriptor(Jh.prototype,"uuid"),Jh.prototype),v(Jh.prototype,"children",[Ts],Object.getOwnPropertyDescriptor(Jh.prototype,"children"),Jh.prototype),v(Jh.prototype,"active",[Ts],Object.getOwnPropertyDescriptor(Jh.prototype,"active"),Jh.prototype),v(Jh.prototype,"activeInHierarchy",[Ts],Object.getOwnPropertyDescriptor(Jh.prototype,"activeInHierarchy"),Jh.prototype),v(Jh.prototype,"parent",[Ts],Object.getOwnPropertyDescriptor(Jh.prototype,"parent"),Jh.prototype),$h=v(Jh.prototype,"_parent",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ef=v(Jh.prototype,"_children",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),tf=v(Jh.prototype,"_active",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),nf=v(Jh.prototype,"_components",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),rf=v(Jh.prototype,"_prefab",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Qh=Jh))||Qh);cc._BaseNode=wf;var Cf=new Mi,Rf=new Mi,kf=new Bn,Of=new Bn,If=new Bn,Mf=new Jn,Lf=e("UITransformComponent",(_f=Es("cc.UITransformComponent"),df=Rs(110),pf=Cs("UI/UITransform"),mf=Ts({displayOrder:0,tooltip:""}),vf=Ts({displayOrder:1,tooltip:""}),gf=Ts({tooltip:""}),_f(yf=df(yf=pf(yf=As((Af=xf=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),s=0;s<r;s++)a[s]=arguments[s];return m(n=c(this,(e=o(t)).call.apply(e,[this].concat(a))),"_priority",Ef,u(n)),n._canvas=null,m(n,"_contentSize",Tf,u(n)),m(n,"_anchorPoint",Sf,u(n)),n}return s(t,e),r(t,[{key:"__preload",value:function(){this.node._uiProps.uiTransformComp=this}},{key:"onEnable",value:function(){this._updateVisibility(),this.node.on(Kc.PARENT_CHANGED,this._parentChanged,this),this._sortSiblings()}},{key:"onDisable",value:function(){this.node.off(Kc.PARENT_CHANGED,this._parentChanged,this),this._canvas=null}},{key:"onDestroy",value:function(){this.node._uiProps.uiTransformComp=null}},{key:"setContentSize",value:function(e,t){var i=this._contentSize;if(void 0===t){if((e=e).width===i.width&&e.height===i.height)return;0,i.width=e.width,i.height=e.height}else{if(e===i.width&&t===i.height)return;0,i.width=e,i.height=t}this.node.emit(Kc.SIZE_CHANGED)}},{key:"setAnchorPoint",value:function(e,t){var i=this._anchorPoint;if(void 0===t){if((e=e).x===i.x&&e.y===i.y)return;i.x=e.x,i.y=e.y}else{if(e===i.x&&t===i.y)return;i.x=e,i.y=t}this.node.emit(Kc.ANCHOR_CHANGED,this._anchorPoint)}},{key:"isHit",value:function(e,t){var i=this._contentSize.width,n=this._contentSize.height,r=Cf,a=Rf,s=this._canvas;if(s){s.node.getWorldRT(kf);var o=kf.m12,l=kf.m13,u=cc.visibleRect.center;if(kf.m12=u.x-(kf.m00*o+kf.m04*l),kf.m13=u.y-(kf.m01*o+kf.m05*l),Bn.invert(kf,kf),Mi.transformMat4(r,e,kf),this.node.getWorldMatrix(If),Bn.invert(kf,If),Mi.transformMat4(a,r,kf),a.x+=this._anchorPoint.x*i,a.y+=this._anchorPoint.y*n,a.x>=0&&a.y>=0&&a.x<=i&&a.y<=n){if(t&&t.mask){for(var c=t.mask,h=this.node,f=0;h&&f<c.index;++f,h=h.parent);if(h===c.node){var _=h.getComponent(cc.MaskComponent);return!_||!_.enabledInHierarchy||_.isHit(r)}return t.mask=null,!0}return!0}return!1}}},{key:"convertToNodeSpaceAR",value:function(e,t){return this.node.getWorldMatrix(If),Bn.invert(kf,If),t||(t=new zi),zi.transformMat4(t,e,kf)}},{key:"convertToWorldSpaceAR",value:function(e,t){return this.node.getWorldMatrix(If),t||(t=new zi),zi.transformMat4(t,e,If)}},{key:"getBoundingBox",value:function(){Bn.fromRTS(Of,this.node.getRotation(),this.node.getPosition(),this.node.getScale());var e=this._contentSize.width,t=this._contentSize.height,i=new Jn(-this._anchorPoint.x*e,-this._anchorPoint.y*t,e,t);return i.transformMat4(Of),i}},{key:"getBoundingBoxToWorld",value:function(){return this.node.parent?(this.node.parent.getWorldMatrix(If),this.getBoundingBoxTo(If)):this.getBoundingBox()}},{key:"getBoundingBoxTo",value:function(e){Bn.fromRTS(Of,this.node.getRotation(),this.node.getPosition(),this.node.getScale());var i=this._contentSize.width,n=this._contentSize.height,r=new Jn(-this._anchorPoint.x*i,-this._anchorPoint.y*n,i,n);if(Bn.multiply(If,e,Of),r.transformMat4(If),!this.node.children)return r;var a=this.node.children,s=Array.isArray(a),o=0;for(a=s?a:a[Symbol.iterator]();;){var l;if(s){if(o>=a.length)break;l=a[o++]}else{if((o=a.next()).done)break;l=o.value}var u=l;if(u&&u.active){var c=u.getComponent(t);if(c){var h=c.getBoundingBoxTo(e);h&&Jn.union(r,r,h)}}}return r}},{key:"getComputeAABB",value:function(e){var t=this._contentSize.width,i=this._contentSize.height;Mf.set(-this._anchorPoint.x*t,-this._anchorPoint.y*i,t,i),Mf.transformMat4(this.node.worldMatrix);var n=Mf.x+.5*Mf.width,r=Mf.y+.5*Mf.height,a=this.node.worldPosition.z,s=Mf.width/2,o=Mf.height/2;if(null==e)return new Fa(n,r,a,s,o,.001);Fa.set(e,n,r,a,s,o,.001)}},{key:"_updateVisibility",value:function(){for(var e=this.node;e;){if(e){var t=e.getComponent("cc.CanvasComponent");if(t){this._canvas=t;break}}e=e.parent}}},{key:"_parentChanged",value:function(e){this._canvas&&this._canvas.node===this.node||this._sortSiblings()}},{key:"_sortSiblings",value:function(){var e=this.node.parent&&this.node.parent.children;e&&(e.sort((function(e,t){var i=e._uiProps.uiTransformComp,n=t._uiProps.uiTransformComp,r=(i?i.priority:0)-(n?n.priority:0);return 0===r?e.getSiblingIndex()-t.getSiblingIndex():r})),this.node.parent._updateSiblingIndex())}},{key:"contentSize",get:function(){return this._contentSize},set:function(e){this._contentSize.equals(e)||(this._contentSize.set(e),this.node.emit(Kc.SIZE_CHANGED))}},{key:"width",get:function(){return this._contentSize.width},set:function(e){this._contentSize.width!==e&&(this._contentSize.width=e,this.node.emit(Kc.SIZE_CHANGED))}},{key:"height",get:function(){return this._contentSize.height},set:function(e){this.contentSize.height!==e&&(this._contentSize.height=e,this.node.emit(Kc.SIZE_CHANGED))}},{key:"anchorPoint",get:function(){return this._anchorPoint},set:function(e){this._anchorPoint.equals(e)||(this._anchorPoint.set(e),this.node.emit(Kc.ANCHOR_CHANGED,this._anchorPoint))}},{key:"anchorX",get:function(){return this._anchorPoint.x},set:function(e){this._anchorPoint.x!==e&&(this._anchorPoint.x=e,this.node.emit(Kc.ANCHOR_CHANGED,this._anchorPoint))}},{key:"anchorY",get:function(){return this._anchorPoint.y},set:function(e){this._anchorPoint.y!==e&&(this._anchorPoint.y=e,this.node.emit(Kc.ANCHOR_CHANGED,this._anchorPoint))}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority!==e&&(this._canvas&&this._canvas.node===this.node?cc.warn(9200):(this._priority=e,this._sortSiblings()))}},{key:"visibility",get:function(){return this._canvas?this._canvas.visibility:-1}}]),t}(Ph),xf.EventType=Kc,v((bf=Af).prototype,"contentSize",[mf],Object.getOwnPropertyDescriptor(bf.prototype,"contentSize"),bf.prototype),v(bf.prototype,"anchorPoint",[vf],Object.getOwnPropertyDescriptor(bf.prototype,"anchorPoint"),bf.prototype),v(bf.prototype,"priority",[gf],Object.getOwnPropertyDescriptor(bf.prototype,"priority"),bf.prototype),Ef=v(bf.prototype,"_priority",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Tf=v(bf.prototype,"_contentSize",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Xn(100,100)}}),Sf=v(bf.prototype,"_anchorPoint",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Mi(.5,.5)}}),yf=bf))||yf)||yf)||yf)||yf));cc.UITransformComponent=Lf;var Pf,Bf,Df,Ff,Nf,zf,Uf,Gf,Vf,Hf,Wf,jf,Xf,qf,Yf,Kf,Zf,Qf=function(){function e(t){i(this,e),this.uiComp=null,this.opacity=1,this._uiTransformComp=null,this._node=t}return r(e,[{key:"uiTransformComp",get:function(){return this._uiTransformComp||(this._uiTransformComp=this._node.getComponent(Lf)),this._uiTransformComp},set:function(e){this._uiTransformComp=e}}]),e}(),Jf=new zi,$f=new fn,e_=new fn,t_=new Array(10),i_=new fn,n_=new an,r_=new an,a_=new Bn,s_=new Map,o_=e("Node",(Pf=Es("cc.Node"),Bf=Ts({type:zi}),Pf((Wf=Hf=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),s=0;s<r;s++)a[s]=arguments[s];return(n=c(this,(e=o(t)).call.apply(e,[this].concat(a))))._uiProps=new Qf(u(n)),n._static=!1,n._pos=new zi,n._rot=new fn,n._scale=new zi(1,1,1),n._mat=new Bn,m(n,"_lpos",Nf,u(n)),m(n,"_lrot",zf,u(n)),m(n,"_lscale",Uf,u(n)),m(n,"_layer",Gf,u(n)),m(n,"_euler",Vf,u(n)),n._dirtyFlags=Nu.NONE,n._eulerDirty=!1,n}return s(t,e),r(t,[{key:"setParent",value:function(e){var i=arguments.length>1&&void 0!==arguments[1]&&arguments[1];i&&this.updateWorldTransform(),f(o(t.prototype),"setParent",this).call(this,e,i)}},{key:"_onSetParent",value:function(e,i){if(f(o(t.prototype),"_onSetParent",this).call(this,e,i),i){var n=this._parent;n?(n.updateWorldTransform(),Bn.multiply(a_,Bn.invert(a_,n._mat),this._mat),Bn.toRTS(a_,this._lrot,this._lpos,this._lscale)):(zi.copy(this._lpos,this._pos),fn.copy(this._lrot,this._rot),zi.copy(this._lscale,this._scale)),this._eulerDirty=!0}this.invalidateChildren(Nu.TRS)}},{key:"_onBatchCreated",value:function(){f(o(t.prototype),"_onBatchCreated",this).call(this),s_.set(this._id,Nu.TRS),this._dirtyFlags=Nu.TRS;for(var e=this._children.length,i=0;i<e;++i)this._children[i]._onBatchCreated()}},{key:"_onBatchRestored",value:function(){this._onBatchCreated()}},{key:"_onBeforeSerialize",value:function(){this.eulerAngles}},{key:"translate",value:function(e,t){var i=t||Fu.LOCAL;if(i===Fu.LOCAL)zi.transformQuat(Jf,e,this._lrot),this._lpos.x+=Jf.x,this._lpos.y+=Jf.y,this._lpos.z+=Jf.z;else if(i===Fu.WORLD)if(this._parent){fn.invert($f,this._parent.worldRotation),zi.transformQuat(Jf,e,$f);var n=this.worldScale;this._lpos.x+=Jf.x/n.x,this._lpos.y+=Jf.y/n.y,this._lpos.z+=Jf.z/n.z}else this._lpos.x+=e.x,this._lpos.y+=e.y,this._lpos.z+=e.z;this.invalidateChildren(Nu.POSITION),1&this._eventMask&&this.emit(Kc.TRANSFORM_CHANGED,Nu.POSITION)}},{key:"rotate",value:function(e,t){var i=t||Fu.LOCAL;if(fn.normalize($f,e),i===Fu.LOCAL)fn.multiply(this._lrot,this._lrot,$f);else if(i===Fu.WORLD){var n=this.worldRotation;fn.multiply(e_,$f,n),fn.invert($f,n),fn.multiply(e_,$f,e_),fn.multiply(this._lrot,this._lrot,e_)}this._eulerDirty=!0,this.invalidateChildren(Nu.ROTATION),1&this._eventMask&&this.emit(Kc.TRANSFORM_CHANGED,Nu.ROTATION)}},{key:"lookAt",value:function(e,t){this.getWorldPosition(Jf),zi.subtract(Jf,Jf,e),zi.normalize(Jf,Jf),fn.fromViewUp($f,Jf,t),this.setWorldRotation($f)}},{key:"invalidateChildren",value:function(e){if((this._dirtyFlags&this.hasChangedFlags&e)!==e){this._dirtyFlags|=e,s_.set(this._id,this.hasChangedFlags|e),e|=Nu.POSITION;for(var t=this._children.length,i=0;i<t;++i)this._children[i].invalidateChildren(e)}}},{key:"updateWorldTransform",value:function(){if(this._dirtyFlags){for(var e,t=this,i=0;t&&t._dirtyFlags;)t_[i++]=t,t=t._parent;for(var n=0;i;)n|=(e=t_[--i])._dirtyFlags,t?(n&Nu.POSITION&&(zi.transformMat4(e._pos,e._lpos,t._mat),e._mat.m12=e._pos.x,e._mat.m13=e._pos.y,e._mat.m14=e._pos.z),n&Nu.RS&&(Bn.fromRTS(e._mat,e._lrot,e._lpos,e._lscale),Bn.multiply(e._mat,t._mat,e._mat),n&Nu.ROTATION&&fn.multiply(e._rot,t._rot,e._lrot),an.fromQuat(n_,fn.conjugate(i_,e._rot)),an.multiplyMat4(n_,n_,e._mat),e._scale.x=n_.m00,e._scale.y=n_.m04,e._scale.z=n_.m08)):(n&Nu.POSITION&&(zi.copy(e._pos,e._lpos),e._mat.m12=e._pos.x,e._mat.m13=e._pos.y,e._mat.m14=e._pos.z),n&Nu.RS&&(n&Nu.ROTATION?fn.copy(e._rot,e._lrot):zi.copy(e._scale,e._lscale),Bn.fromRTS(e._mat,e._rot,e._pos,e._scale))),e._dirtyFlags=Nu.NONE,t=e}}},{key:"setPosition",value:function(e,t,i){void 0===t||void 0===i?zi.copy(this._lpos,e):zi.set(this._lpos,e,t,i),this.invalidateChildren(Nu.POSITION),1&this._eventMask&&this.emit(Kc.TRANSFORM_CHANGED,Nu.POSITION)}},{key:"getPosition",value:function(e){return e?zi.set(e,this._lpos.x,this._lpos.y,this._lpos.z):zi.copy(new zi,this._lpos)}},{key:"setRotation",value:function(e,t,i,n){void 0===t||void 0===i||void 0===n?fn.copy(this._lrot,e):fn.set(this._lrot,e,t,i,n),this._eulerDirty=!0,this.invalidateChildren(Nu.ROTATION),1&this._eventMask&&this.emit(Kc.TRANSFORM_CHANGED,Nu.ROTATION)}},{key:"setRotationFromEuler",value:function(e,t,i){zi.set(this._euler,e,t,i),fn.fromEuler(this._lrot,e,t,i),this._eulerDirty=!1,this.invalidateChildren(Nu.ROTATION),1&this._eventMask&&this.emit(Kc.TRANSFORM_CHANGED,Nu.ROTATION)}},{key:"getRotation",value:function(e){return e?fn.set(e,this._lrot.x,this._lrot.y,this._lrot.z,this._lrot.w):fn.copy(new fn,this._lrot)}},{key:"setScale",value:function(e,t,i){void 0===t||void 0===i?zi.copy(this._lscale,e):zi.set(this._lscale,e,t,i),this.invalidateChildren(Nu.SCALE),1&this._eventMask&&this.emit(Kc.TRANSFORM_CHANGED,Nu.SCALE)}},{key:"getScale",value:function(e){return e?zi.set(e,this._lscale.x,this._lscale.y,this._lscale.z):zi.copy(new zi,this._lscale)}},{key:"inverseTransformPoint",value:function(e,t){zi.copy(e,t);for(var i=this,n=0;i._parent;)t_[n++]=i,i=i._parent;for(;n>=0;)zi.transformInverseRTS(e,e,i._lrot,i._lpos,i._lscale),i=t_[--n];return e}},{key:"setWorldPosition",value:function(e,t,i){void 0===t||void 0===i?zi.copy(this._pos,e):zi.set(this._pos,e,t,i);var n=this._parent,r=this._lpos;n?(n.updateWorldTransform(),zi.transformMat4(r,this._pos,Bn.invert(a_,n._mat))):zi.copy(r,this._pos),this.invalidateChildren(Nu.POSITION),1&this._eventMask&&this.emit(Kc.TRANSFORM_CHANGED,Nu.POSITION)}},{key:"getWorldPosition",value:function(e){return this.updateWorldTransform(),e?zi.copy(e,this._pos):zi.copy(new zi,this._pos)}},{key:"setWorldRotation",value:function(e,t,i,n){void 0===t||void 0===i||void 0===n?fn.copy(this._rot,e):fn.set(this._rot,e,t,i,n),this._parent?(this._parent.updateWorldTransform(),fn.multiply(this._lrot,fn.conjugate(this._lrot,this._parent._rot),this._rot)):fn.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(Nu.ROTATION),1&this._eventMask&&this.emit(Kc.TRANSFORM_CHANGED,Nu.ROTATION)}},{key:"setWorldRotationFromEuler",value:function(e,t,i){fn.fromEuler(this._rot,e,t,i),this._parent?(this._parent.updateWorldTransform(),fn.multiply(this._lrot,fn.conjugate(this._lrot,this._parent._rot),this._rot)):fn.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(Nu.ROTATION),1&this._eventMask&&this.emit(Kc.TRANSFORM_CHANGED,Nu.ROTATION)}},{key:"getWorldRotation",value:function(e){return this.updateWorldTransform(),e?fn.copy(e,this._rot):fn.copy(new fn,this._rot)}},{key:"setWorldScale",value:function(e,t,i){void 0===t||void 0===i?zi.copy(this._scale,e):zi.set(this._scale,e,t,i);var n=this._parent;n?(n.updateWorldTransform(),an.fromQuat(n_,fn.conjugate(i_,n._rot)),an.multiplyMat4(n_,n_,n._mat),r_.m00=this._scale.x,r_.m04=this._scale.y,r_.m08=this._scale.z,an.multiply(n_,r_,an.invert(n_,n_)),this._lscale.x=n_.m00,this._lscale.y=n_.m04,this._lscale.z=n_.m08):zi.copy(this._lscale,this._scale),this.invalidateChildren(Nu.SCALE),1&this._eventMask&&this.emit(Kc.TRANSFORM_CHANGED,Nu.SCALE)}},{key:"getWorldScale",value:function(e){return this.updateWorldTransform(),e?zi.copy(e,this._scale):zi.copy(new zi,this._scale)}},{key:"getWorldMatrix",value:function(e){return this.updateWorldTransform(),e||(e=new Bn),Bn.copy(e,this._mat)}},{key:"getWorldRS",value:function(e){return this.updateWorldTransform(),e||(e=new Bn),Bn.copy(e,this._mat),e.m12=0,e.m13=0,e.m14=0,e}},{key:"getWorldRT",value:function(e){return this.updateWorldTransform(),e||(e=new Bn),Bn.fromRT(e,this._rot,this._pos)}},{key:"getAnchorPoint",value:function(e){return e||(e=new Mi),e.set(this._uiProps.uiTransformComp.anchorPoint),e}},{key:"setAnchorPoint",value:function(e,t){this._uiProps.uiTransformComp.setAnchorPoint(e,t)}},{key:"getContentSize",value:function(e){return e||(e=new Xn),e.set(this._uiProps.uiTransformComp.contentSize),e}},{key:"setContentSize",value:function(e,t){this._uiProps.uiTransformComp.setContentSize(e,t)}},{key:"pauseSystemEvents",value:function(e){ph.pauseTarget(this,e)}},{key:"resumeSystemEvents",value:function(e){ph.resumeTarget(this,e)}},{key:"_onPostActivated",value:function(e){e?(ph.resumeTarget(this),this.eventProcessor.reattach()):ph.pauseTarget(this)}},{key:"_onPreDestroy",value:function(){this._eventProcessor.destroy(),f(o(t.prototype),"_onPreDestroy",this).call(this)}},{key:"position",get:function(){return this._lpos},set:function(e){this.setPosition(e)}},{key:"worldPosition",get:function(){return this.updateWorldTransform(),this._pos},set:function(e){this.setWorldPosition(e)}},{key:"rotation",get:function(){return this._lrot},set:function(e){this.setRotation(e)}},{key:"eulerAngles",set:function(e){this.setRotationFromEuler(e.x,e.y,e.z)},get:function(){return this._eulerDirty&&(fn.toEuler(this._euler,this._lrot),this._eulerDirty=!1),this._euler}},{key:"worldRotation",get:function(){return this.updateWorldTransform(),this._rot},set:function(e){this.setWorldRotation(e)}},{key:"scale",get:function(){return this._lscale},set:function(e){this.setScale(e)}},{key:"worldScale",get:function(){return this.updateWorldTransform(),this._scale},set:function(e){this.setWorldScale(e)}},{key:"matrix",set:function(e){Bn.toRTS(e,this._lrot,this._lpos,this._lscale),this.invalidateChildren(Nu.TRS),this._eulerDirty=!0,1&this._eventMask&&this.emit(Kc.TRANSFORM_CHANGED,Nu.TRS)}},{key:"worldMatrix",get:function(){return this.updateWorldTransform(),this._mat}},{key:"forward",get:function(){return zi.transformQuat(new zi,zi.FORWARD,this.worldRotation)},set:function(e){var t=e.length();zi.multiplyScalar(Jf,e,-1/t),fn.fromViewUp($f,Jf),this.setWorldRotation($f)}},{key:"layer",set:function(e){this._layer=e},get:function(){return this._layer}},{key:"hasChangedFlags",get:function(){return s_.get(this._id)||0},set:function(e){s_.set(this._id,e)}},{key:"width",get:function(){return this._uiProps.uiTransformComp.width},set:function(e){this._uiProps.uiTransformComp.width=e}},{key:"height",get:function(){return this._uiProps.uiTransformComp.height},set:function(e){this._uiProps.uiTransformComp.height=e}},{key:"anchorX",get:function(){return this._uiProps.uiTransformComp.anchorX},set:function(e){this._uiProps.uiTransformComp.anchorX=e}},{key:"anchorY",get:function(){return this._uiProps.uiTransformComp.anchorY},set:function(e){this._uiProps.uiTransformComp.anchorY=e}}],[{key:"isNode",value:function(e){return e instanceof t&&(e.constructor===t||!(e instanceof cc.Scene))}}]),t}(wf),Hf.bookOfChange=s_,Hf.EventType=Kc,Hf.NodeSpace=Fu,Hf.TransformDirtyBit=Nu,Hf.TransformBit=Nu,Nf=v((Ff=Wf).prototype,"_lpos",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new zi}}),zf=v(Ff.prototype,"_lrot",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new fn}}),Uf=v(Ff.prototype,"_lscale",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new zi(1,1,1)}}),Gf=v(Ff.prototype,"_layer",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return du.Enum.DEFAULT}}),Vf=v(Ff.prototype,"_euler",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new zi}}),v(Ff.prototype,"eulerAngles",[Bf],Object.getOwnPropertyDescriptor(Ff.prototype,"eulerAngles"),Ff.prototype),v(Ff.prototype,"layer",[Ts],Object.getOwnPropertyDescriptor(Ff.prototype,"layer"),Ff.prototype),Df=Ff))||Df));function l_(e){return"string"==typeof e||"number"==typeof e}function u_(e,t){return e instanceof t}cc.Node=o_;var c_=Es("cc.animation.HierarchyPath")((qf=v((Xf=function(){function e(t){i(this,e),m(this,"path",qf,this),this.path=t||""}return r(e,[{key:"get",value:function(e){if(!(e instanceof o_))throw new Error("Target of hierachy path shall be Node.");var t=e.getChildByPath(this.path);if(!t)throw new Error('Node "'.concat(e.name,'" has no path "').concat(this.path,'"'));return t}}]),e}()).prototype,"path",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),jf=Xf))||jf,h_=Es("cc.animation.ComponentPath")((Zf=v((Kf=function(){function e(t){i(this,e),m(this,"component",Zf,this),this.component=t||""}return r(e,[{key:"get",value:function(e){if(!(e instanceof o_))throw new Error("Target of component path shall be Node.");var t=e.getComponent(this.component);if(!t)throw new Error('Node "'.concat(e.name,'" has no component "').concat(this.component,'"'));return t}}]),e}()).prototype,"component",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Yf=Kf))||Yf,f_=e("SkelAnimDataHub",function(){function e(){i(this,e)}return r(e,null,[{key:"getOrExtract",value:function(t){var i=e.pool.get(t);return i&&i.info.sample===t.sample||(i&&cc.director.root.dataPoolManager.releaseAnimationClip(t),i=function(e){var t={};e.curves.forEach((function(e){if(!e.valueAdapter&&u_(e.modifiers[0],c_)&&l_(e.modifiers[1])){var i=e.modifiers[0].path,n=t[i];n||(n=t[i]={}),n[e.modifiers[1]]={values:e.data.values,keys:e.data.keys}}}));for(var i=Math.ceil(e.sample*e.duration)+1,n=function(){var n=a[r],s=t[n];if(!s)return"continue";Object.defineProperty(s,"worldMatrix",{get:function(){if(!s._worldMatrix){var r=s.position,a=s.rotation,o=s.scale;__(e,r,i),__(e,a,i),__(e,o,i),function(e,t,i){var n=i.position.values,r=i.rotation.values,a=i.scale.values,s=n.map((function(){return new Bn})),o=t.lastIndexOf("/"),l=null;if(o>0){var u=t.substring(0,o),c=e[u];if(!c)return void console.warn("no data for parent bone?");l=c.worldMatrix.values}for(var h=0;h<n.length;h++){var f=n[h],_=r[h],d=a[h],p=s[h];Bn.fromRTS(p,_,f,d),l&&Bn.multiply(p,l[h],p)}Object.keys(i).forEach((function(e){return delete i[e]})),i._worldMatrix={keys:0,interpolate:!1,values:s}}(t,n,s)}return s._worldMatrix}})},r=0,a=Object.keys(t);r<a.length;r++)n();return{info:{frames:i,sample:e.sample},data:t}}(t),e.pool.set(t,i)),i}},{key:"destroy",value:function(t){e.pool.delete(t)}}]),e}());function __(e,t,i){var n=e.keys[t.keys],r=[];if(n&&1!==n.length)for(var a=0,s=0;a<i;a++){for(var o=a/e.sample;n[s]<=o;)s++;s>n.length-1?o=n[s=n.length-1]:0===s&&(s=1);var l=t.values[s-1].clone();l.lerp(t.values[s],di((o-n[s-1])/(n[s]-n[s-1]))),r[a]=l}else for(var u=0;u<i;u++)r[u]=t.values[0].clone();t.values=r}function d_(e){return--e,e|=e>>16,e|=e>>8,e|=e>>4,e|=e>>2,e|=e>>1,++e}f_.pool=new Map;var p_,m_,v_=function(){function e(t){i(this,e),this._format=no.UNKNOWN,this._formatSize=0,this._chunks=[],this._chunkCount=0,this._handles=[],this._region0=new Uo,this._region1=new Uo,this._region2=new Uo,this._roundUpFn=null,this._bufferViewCtor=Uint8Array,this._channels=4,this._inOrderFree=!1,this._device=t}return r(e,[{key:"initialize",value:function(e){var t=Go[e.format];return this._format=e.format,this._formatSize=t.size,this._channels=t.count,this._bufferViewCtor=t.type===Fo.FLOAT?Float32Array:Uint8Array,this._chunks=new Array(e.maxChunks),this._roundUpFn=e.roundUpFn||null,this._inOrderFree=e.inOrderFree||!1,!0}},{key:"destroy",value:function(){for(var e=0;e<this._chunkCount;++e){var t=this._chunks[e];t.texView.destroy(),t.texture.destroy()}this._chunks.splice(0),this._handles.splice(0)}},{key:"alloc",value:function(e){var i=this;if(0===e)return null;for(var n=function(t){var n=i._chunks[t],r=!1,a=n.start;if(a+e<=n.end)r=!0;else if(i._inOrderFree)a>n.end?a+e<=n.size?r=!0:e<=n.end&&(n.start=a=0,r=!0):a===n.end&&(n.start=a=0,n.end=n.size,e<=n.end&&(r=!0));else{a=0;for(var s=i._handles.filter((function(e){return e.chunkIdx===t})).sort((function(e,t){return e.start-t.start})),o=0;o<s.length;o++){var l=s[o];if(a+e<=l.start){r=!0;break}a=l.end}!r&&a+e<=n.size&&(r=!0)}if(r){n.start+=e;var u={chunkIdx:t,start:a,end:a+e,texture:n.texture,texView:n.texView};return i._handles.push(u),{v:u}}},r=0;r<this._chunkCount;++r){var a=n(r);if("object"===t(a))return a.v}if(this._chunkCount>=this._chunks.length)return console.error("TextureBufferPool: Reach max chunk count."),null;var s=Math.sqrt(e/this._formatSize),o=this._roundUpFn&&this._roundUpFn(s,this._formatSize)||Math.max(1024,d_(s)),l=o*o*this._formatSize;console.info("TextureBufferPool: Allocate chunk "+this._chunkCount+", size: "+l+", format: "+this._format);var u=this._device.createTexture({type:bo.TEX2D,usage:Eo.SAMPLED,format:this._format,width:o,height:o,mipLevel:1}),c=this._device.createTextureView({texture:u,type:xo.TV2D,format:this._format}),h={chunkIdx:this._chunkCount,start:0,end:e,texture:u,texView:c};return this._handles.push(h),this._chunks[this._chunkCount++]={texture:u,texView:c,size:l,start:e,end:l},h}},{key:"free",value:function(e){for(var t=0;t<this._handles.length;++t)if(this._handles[t]===e)return this._chunks[e.chunkIdx].end=e.end,void this._handles.splice(t,1)}},{key:"update",value:function(e,t){var i=[],n=[],r=e.start/this._formatSize,a=t.byteLength/this._formatSize,s=r%e.texture.width,o=Math.floor(r/e.texture.width),l=Math.min(e.texture.width-s,a),u=0;s>0&&(this._region0.texOffset.x=s,this._region0.texOffset.y=o,this._region0.texExtent.width=l,this._region0.texExtent.height=1,i.push(new this._bufferViewCtor(t,u*this._formatSize,l*this._channels)),n.push(this._region0),s=0,o+=1,a-=l,u+=l),a>0&&(this._region1.texOffset.x=s,this._region1.texOffset.y=o,a>e.texture.width?(this._region1.texExtent.width=e.texture.width,this._region1.texExtent.height=Math.floor(a/e.texture.width),l=this._region1.texExtent.width*this._region1.texExtent.height):(l=a,this._region1.texExtent.width=l,this._region1.texExtent.height=1),i.push(new this._bufferViewCtor(t,u*this._formatSize,l*this._channels)),n.push(this._region1),s=0,o+=this._region1.texExtent.height,a-=l,u+=l),a>0&&(this._region2.texOffset.x=s,this._region2.texOffset.y=o,this._region2.texExtent.width=a,this._region2.texExtent.height=1,i.push(new this._bufferViewCtor(t,u*this._formatSize,a*this._channels)),n.push(this._region2)),this._device.copyBuffersToTexture(i,e.texture,n)}}]),e}(),g_=function(e,t,i,n){e[t+0]=E_(i.m00),e[t+1]=E_(i.m01),e[t+2]=E_(i.m02),e[t+3]=E_(i.m12),e[t+4]=E_(i.m04),e[t+5]=E_(i.m05),e[t+6]=E_(i.m06),e[t+7]=E_(i.m13),e[t+8]=E_(i.m08),e[t+9]=E_(i.m09),e[t+10]=E_(i.m10),e[t+11]=E_(i.m14)};function y_(e){return e.hasFeature(qo.TEXTURE_FLOAT)?m_.RGBA32F:m_.RGBA8}!function(e){e[e.NONE=0]="NONE",e[e.RGBA8=1]="RGBA8",e[e.RGBA32F=2]="RGBA32F"}(m_||(m_={}));var b_=new Bn;new fn,new fn,new zi,new fn,new zi;function E_(e){return e||0}function T_(e,t){var i=4/Math.sqrt(t);return 12*Math.ceil(Math.max(480*i,e)/12)}var S_,x_=(a(p_={},m_.RGBA8,no.RGBA8),a(p_,m_.RGBA32F,no.RGBA32F),p_),A_=nc([go.POINT,go.POINT,go.NONE,yo.CLAMP,yo.CLAMP,yo.CLAMP]),w_=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:8;i(this,e),this._textureBuffers=new Map,this._maxIdentityJoints=64,this._formatSize=0,this._device=t,this._pool=new v_(t);var r=x_[y_(this._device)];this._formatSize=Go[r].size;var a=16/this._formatSize;this._pool.initialize({format:r,maxChunks:n*a,roundUpFn:T_}),this._identityBuffer=this._allocIdentityBuffer()}return r(e,[{key:"clear",value:function(){this._pool.destroy(),this._textureBuffers.clear(),this._identityBuffer=null}},{key:"getDefaultJointsTexture",value:function(e){var t=e&&e.joints.length||1;return t>this._maxIdentityJoints&&(this._identityBuffer&&(this._identityBuffer.readyToBeDeleted=!0,this.releaseHandle(this._identityBuffer,!1)),this._maxIdentityJoints=d_(t),this._identityBuffer=this._allocIdentityBuffer()),this._identityBuffer?(this._identityBuffer.refCount++,this._identityBuffer):null}},{key:"getJointsTextureWithAnimation",value:function(e,t){var i=e.hash^t.hash,n=this._textureBuffers.get(i)||null;if(n)return n.refCount++,n;var r=f_.getOrExtract(t),a=r.info.frames,s=12*e.joints.length*a,o=this._pool.alloc(s*Float32Array.BYTES_PER_ELEMENT);if(!o)return null;n={pixelOffset:o.start/this._formatSize,refCount:1,skeletonHash:e.hash,clipHash:t.hash,readyToBeDeleted:!1,handle:o};for(var l=new Float32Array(s),u=0;u<e.joints.length;u++){var c=r.data[e.joints[u]];if(c)for(var h=e.bindposes[u],f=c.worldMatrix.values,_=0;_<a;_++){var d=f[_];Bn.multiply(b_,d,h),g_(l,12*(a*u+_),b_)}}return this._pool.update(o,l.buffer),this._textureBuffers.set(i,n),n}},{key:"releaseHandle",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];t&&e.refCount>0&&e.refCount--,!e.refCount&&e.readyToBeDeleted&&(this._pool.free(e.handle),this._textureBuffers.delete(e.skeletonHash^e.clipHash))}},{key:"releaseSkeleton",value:function(e){for(var t=this._textureBuffers.values(),i=t.next();!i.done;)i.value.skeletonHash===e.hash&&(i.value.readyToBeDeleted=!0,this.releaseHandle(i.value,!1),this._textureBuffers.delete(i.value.skeletonHash^i.value.clipHash)),i=t.next()}},{key:"releaseAnimationClip",value:function(e){for(var t=this._textureBuffers.values(),i=t.next();!i.done;)i.value.clipHash===e.hash&&(i.value.readyToBeDeleted=!0,this.releaseHandle(i.value,!1),this._textureBuffers.delete(i.value.skeletonHash^i.value.clipHash)),i=t.next()}},{key:"_allocIdentityBuffer",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this._maxIdentityJoints,t=this._pool.alloc(12*e*Float32Array.BYTES_PER_ELEMENT);if(!t)return null;for(var i=new Float32Array(12*e),n=0;n<e;n++)g_(i,12*n,Bn.IDENTITY);return this._pool.update(t,i.buffer),{pixelOffset:t.start/this._formatSize,refCount:0,skeletonHash:e,clipHash:0,readyToBeDeleted:!1,handle:t}}}]),e}(),C_=function(){function e(t){i(this,e),this._pool=new Map,this._device=t}return r(e,[{key:"create",value:function(e){var t=this._pool.get(e);if(t)return t;var i=this._device.createBuffer({usage:ro.UNIFORM|ro.TRANSFER_DST,memUsage:ao.HOST|ao.DEVICE,size:Cu.SIZE,stride:Cu.SIZE}),n=new Float32Array([1,0,0,0]);i.update(n);var r={buffer:i,data:n,dirty:!1};return this._pool.set(e,r),r}},{key:"destroy",value:function(e){var t=this._pool.get(e);t&&(t.buffer.destroy(),this._pool.delete(e))}},{key:"get",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"-1";return this._pool.get(e)||this.create("-1")}},{key:"switchClip",value:function(e,t){return e.data[0]=t?f_.getOrExtract(t).info.frames:1,e.data[1]=0,e.buffer.update(e.data),e.dirty=!1,e}},{key:"clear",value:function(){var e=this._pool.values(),t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.buffer.destroy()}this._pool.clear()}}]),e}(),R_=new zi,k_=new zi,O_=new Fa,I_=function(){function e(){i(this,e),this._perJointBoundsPool=new Map,this._fullClipBoundsPool=new Map}return r(e,[{key:"get",value:function(e,t,i){var n=this._getFullClipBounds(e,t,i)||[];if(n.length)return n;var r=this._getPerJointBounds(e,t);r||(r=this.getBoneSpacePerJointBounds(e,t),this._setPerJointBounds(e,t,r));for(var a=f_.getOrExtract(i),s=a.info.frames,o=0;o<s;o++)n.push(new Fa(1/0,1/0,1/0,-1/0,-1/0,-1/0));for(var l=t.joints,u=0;u<l.length;u++){var c=a.data[l[u]],h=r[u];if(h&&c)for(var f=c.worldMatrix.values,_=0;_<s;_++){var d=f[_],p=n[_];Fa.transform(O_,h,d),O_.getBoundary(R_,k_),zi.min(p.center,p.center,R_),zi.max(p.halfExtents,p.halfExtents,k_)}}for(var m=0;m<s;m++){var v=n[m],g=v.center,y=v.halfExtents;Fa.fromPoints(n[m],g,y)}return this._setFullClipBounds(e,t,i,n),n}},{key:"getBoneSpacePerJointBounds",value:function(e,t){for(var i=[],n=[],r=t.bindposes,a=0;a<r.length;a++)i.push(new Fa(1/0,1/0,1/0,-1/0,-1/0,-1/0)),n.push(!1);for(var s=0;s<e.struct.primitives.length;s++){var o=e.readAttribute(s,to.ATTR_JOINTS),l=e.readAttribute(s,to.ATTR_WEIGHTS),u=e.readAttribute(s,to.ATTR_POSITION);if(o&&l&&u)for(var c=Math.min(o.length/4,l.length/4,u.length/3),h=0;h<c;h++){zi.set(R_,u[3*h+0],u[3*h+1],u[3*h+2]);for(var f=0;f<4;++f){var _=4*h+f,d=o[_];if(!(0===l[_]||d>=r.length)){zi.transformMat4(k_,R_,r[d]),n[d]=!0;var p=i[d];zi.min(p.center,p.center,k_),zi.max(p.halfExtents,p.halfExtents,k_)}}}}for(var m=0;m<r.length;m++){var v=i[m];n[m]?Fa.fromPoints(v,v.center,v.halfExtents):i[m]=null}return i}},{key:"clear",value:function(){this._perJointBoundsPool.clear(),this._fullClipBoundsPool.clear()}},{key:"releaseMesh",value:function(e){this._perJointBoundsPool.delete(e.hash),this._fullClipBoundsPool.delete(e.hash)}},{key:"releaseSkeleton",value:function(e){for(var t=this._perJointBoundsPool.values(),i=t.next();!i.done;)i.value.delete(e.hash),i=t.next();for(var n=this._fullClipBoundsPool.values(),r=n.next();!r.done;)r.value.delete(e.hash),r=n.next()}},{key:"releaseAnimationClip",value:function(e){for(var t=this._fullClipBoundsPool.values(),i=t.next();!i.done;){for(var n=i.value.values(),r=n.next();!r.done;)r.value.delete(e.hash),r=n.next();i=t.next()}}},{key:"_getPerJointBounds",value:function(e,t){var i=this._perJointBoundsPool.get(e.hash);return i&&i.get(t.hash)}},{key:"_getFullClipBounds",value:function(e,t,i){var n=this._fullClipBoundsPool.get(e.hash),r=n&&n.get(t.hash);return r&&r.get(i.hash)}},{key:"_setPerJointBounds",value:function(e,t,i){var n=this._perJointBoundsPool.get(e.hash);n||(n=new Map,this._perJointBoundsPool.set(e.hash,n)),n.set(t.hash,i)}},{key:"_setFullClipBounds",value:function(e,t,i,n){var r=this._fullClipBoundsPool.get(e.hash);r||(r=new Map,this._fullClipBoundsPool.set(e.hash,r));var a=r.get(t.hash);a||(a=new Map,r.set(t.hash,a)),a.set(i.hash,n)}}]),e}(),M_=e("effects",[{name:"builtin-billboard",_uuid:"711ebe11-f673-4cd9-9a83-63c60ba54c5b",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"builtin-billboard|vert:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"builtin-billboard|vert:vs_main|tinted-fs:add",hash:916813039,glsl3:{vert:"\nprecision mediump float;\nuniform Constants {\n  vec4 mainTiling_Offset;\n  vec4 frameTile_velLenScale;\n  vec4 scale;\n};\nuniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n};\nuniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n};\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\n  mat3 m = mat3(xAxis,yAxis,zAxis);\n  float trace = m[0][0] + m[1][1] + m[2][2];\n  vec4 quat;\n  if (trace > 0.) {\n    float s = 0.5 / sqrt(trace + 1.0);\n    quat.w = 0.25 / s;\n    quat.x = (m[2][1] - m[1][2]) * s;\n    quat.y = (m[0][2] - m[2][0]) * s;\n    quat.z = (m[1][0] - m[0][1]) * s;\n  } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n    float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n    quat.w = (m[2][1] - m[1][2]) / s;\n    quat.x = 0.25 * s;\n    quat.y = (m[0][1] + m[1][0]) / s;\n    quat.z = (m[0][2] + m[2][0]) / s;\n  } else if (m[1][1] > m[2][2]) {\n    float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n    quat.w = (m[0][2] - m[2][0]) / s;\n    quat.x = (m[0][1] + m[1][0]) / s;\n    quat.y = 0.25 * s;\n    quat.z = (m[1][2] + m[2][1]) / s;\n  } else {\n    float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n    quat.w = (m[1][0] - m[0][1]) / s;\n    quat.x = (m[0][2] + m[2][0]) / s;\n    quat.y = (m[1][2] + m[2][1]) / s;\n    quat.z = 0.25 * s;\n  }\n  float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n  if (len > 0.) {\n    len = 1. / sqrt(len);\n    quat.x = quat.x * len;\n    quat.y = quat.y * len;\n    quat.z = quat.z * len;\n    quat.w = quat.w * len;\n  }\n  return quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\n  float x = angle.x / 2.;\n  float y = angle.y / 2.;\n  float z = angle.z / 2.;\n  float sx = sin(x);\n  float cx = cos(x);\n  float sy = sin(y);\n  float cy = cos(y);\n  float sz = sin(z);\n  float cz = cos(z);\n  vec4 quat = vec4(0);\n  quat.x = sx * cy * cz + cx * sy * sz;\n  quat.y = cx * sy * cz + sx * cy * sz;\n  quat.z = cx * cy * sz - sx * sy * cz;\n  quat.w = cx * cy * cz - sx * sy * sz;\n  return quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\n  vec4 quat;\n  quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n  quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n  quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n  quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n  return quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\n  float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n  float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n  float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n  float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n  v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n  v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n  v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n  vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n  vec4 rotQuat = quatMultiply(viewQuat, q);\n  rotateVecFromQuat(pos, rotQuat);\n  return pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\n  float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n  float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n  corner.x = xOS;\n  corner.y = yOS;\n}\nout vec2 uv;\nout vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n  , mat4 viewInv\n) {\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n  vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n  vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nuniform builtin {\n  vec4 cc_size_rotation;\n};\nvec4 vs_main() {\n  vec4 pos = vec4(a_position, 1);\n  pos = cc_matWorld * pos;\n  vec2 vertOffset = a_texCoord.xy - 0.5;\n  computeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\n  pos = cc_matViewProj * pos;\n  uv = a_texCoord.xy;\n  color = a_color;\n  return pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nuniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nuniform FragConstants {\n  vec4 tintColor;\n};\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n  return CCFragOutput(col);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"},glsl1:{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\n  mat3 m = mat3(xAxis,yAxis,zAxis);\n  float trace = m[0][0] + m[1][1] + m[2][2];\n  vec4 quat;\n  if (trace > 0.) {\n    float s = 0.5 / sqrt(trace + 1.0);\n    quat.w = 0.25 / s;\n    quat.x = (m[2][1] - m[1][2]) * s;\n    quat.y = (m[0][2] - m[2][0]) * s;\n    quat.z = (m[1][0] - m[0][1]) * s;\n  } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n    float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n    quat.w = (m[2][1] - m[1][2]) / s;\n    quat.x = 0.25 * s;\n    quat.y = (m[0][1] + m[1][0]) / s;\n    quat.z = (m[0][2] + m[2][0]) / s;\n  } else if (m[1][1] > m[2][2]) {\n    float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n    quat.w = (m[0][2] - m[2][0]) / s;\n    quat.x = (m[0][1] + m[1][0]) / s;\n    quat.y = 0.25 * s;\n    quat.z = (m[1][2] + m[2][1]) / s;\n  } else {\n    float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n    quat.w = (m[1][0] - m[0][1]) / s;\n    quat.x = (m[0][2] + m[2][0]) / s;\n    quat.y = (m[1][2] + m[2][1]) / s;\n    quat.z = 0.25 * s;\n  }\n  float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n  if (len > 0.) {\n    len = 1. / sqrt(len);\n    quat.x = quat.x * len;\n    quat.y = quat.y * len;\n    quat.z = quat.z * len;\n    quat.w = quat.w * len;\n  }\n  return quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\n  float x = angle.x / 2.;\n  float y = angle.y / 2.;\n  float z = angle.z / 2.;\n  float sx = sin(x);\n  float cx = cos(x);\n  float sy = sin(y);\n  float cy = cos(y);\n  float sz = sin(z);\n  float cz = cos(z);\n  vec4 quat = vec4(0);\n  quat.x = sx * cy * cz + cx * sy * sz;\n  quat.y = cx * sy * cz + sx * cy * sz;\n  quat.z = cx * cy * sz - sx * sy * cz;\n  quat.w = cx * cy * cz - sx * sy * sz;\n  return quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\n  vec4 quat;\n  quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n  quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n  quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n  quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n  return quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\n  float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n  float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n  float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n  float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n  v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n  v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n  v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n  vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n  vec4 rotQuat = quatMultiply(viewQuat, q);\n  rotateVecFromQuat(pos, rotQuat);\n  return pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\n  float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n  float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n  corner.x = xOS;\n  corner.y = yOS;\n}\nvarying vec2 uv;\nvarying vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n  , mat4 viewInv\n) {\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n  vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n  vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nuniform vec4 cc_size_rotation;\nvec4 vs_main() {\n  vec4 pos = vec4(a_position, 1);\n  pos = cc_matWorld * pos;\n  vec2 vertOffset = a_texCoord.xy - 0.5;\n  computeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\n  pos = cc_matViewProj * pos;\n  uv = a_texCoord.xy;\n  color = a_color;\n  return pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n  return CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplers:[]}},defines:[{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"builtin",defines:[],binding:1,members:[{name:"cc_size_rotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:2,members:[{name:"tintColor",type:16,count:1}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:[],binding:30}]}]},{name:"builtin-particle-trail",_uuid:"17debcc3-0a6b-4b8a-b00b-dc58b885581e",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"builtin-particle-trail|particle-trail:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},frameTile_velLenScale:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"builtin-particle-trail|particle-trail:vs_main|tinted-fs:add",hash:516627142,glsl3:{vert:"\nprecision mediump float;\nuniform Constants {\n  vec4 mainTiling_Offset;\n  vec4 frameTile_velLenScale;\n  vec4 scale;\n};\nuniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n};\nuniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n};\nout vec2 uv;\nout vec4 color;\nin vec3 a_position;\nin vec4 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\n  out vec3 vBarycentric;\n#endif\nvec4 vs_main() {\n  highp vec4 pos = vec4(a_position, 1);\n  vec4 velocity = vec4(a_texCoord1.xyz, 0);\n  #if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    velocity = cc_matWorld * velocity;\n  #endif\n  float vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\n  vec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\n  pos.xyz += camUp * vertOffset;\n  pos = cc_matViewProj * pos;\n  uv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\n  color = a_color;\n  #if CC_DRAW_WIRE_FRAME\n    vBarycentric = a_texCoord2;\n  #endif\n  return pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\n  precision mediump float;\nuniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\n  in vec2 uv;\n  in vec4 color;\n  #if CC_DRAW_WIRE_FRAME\n    in vec3 vBarycentric;\n  #endif\n  uniform sampler2D mainTexture;\n  uniform FragConstants {\n    vec4 tintColor;\n  };\n  vec4 add () {\n    vec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\n    if (any(lessThan(vBarycentric, vec3(0.02)))) {\n        col = vec4(0., 1., 1., 1.);\n    }\n#endif\n    return CCFragOutput(col);\n  }\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"},glsl1:{vert:"\nprecision mediump float;\nuniform vec4 mainTiling_Offset;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying vec2 uv;\nvarying vec4 color;\nattribute vec3 a_position;\nattribute vec4 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\n  varying vec3 vBarycentric;\n#endif\nvec4 vs_main() {\n  highp vec4 pos = vec4(a_position, 1);\n  vec4 velocity = vec4(a_texCoord1.xyz, 0);\n  #if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    velocity = cc_matWorld * velocity;\n  #endif\n  float vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\n  vec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\n  pos.xyz += camUp * vertOffset;\n  pos = cc_matViewProj * pos;\n  uv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\n  color = a_color;\n  #if CC_DRAW_WIRE_FRAME\n    vBarycentric = a_texCoord2;\n  #endif\n  return pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\n  precision mediump float;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\n  varying vec2 uv;\n  varying vec4 color;\n  #if CC_DRAW_WIRE_FRAME\n    varying vec3 vBarycentric;\n  #endif\n  uniform sampler2D mainTexture;\n  uniform vec4 tintColor;\n  vec4 add () {\n    vec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\n    if (any(lessThan(vBarycentric, vec3(0.02)))) {\n        col = vec4(0., 1., 1., 1.);\n    }\n#endif\n    return CCFragOutput(col);\n  }\nvoid main() { gl_FragColor = add(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplers:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"CC_DRAW_WIRE_FRAME",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,members:[{name:"tintColor",type:16,count:1}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:[],binding:30}]}]},{name:"builtin-particle",_uuid:"d1346436-ac96-4271-b863-1f4fdead95b0",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"builtin-particle|particle-vs-legacy:lpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"builtin-particle|particle-vs-legacy:lpvs_main|tinted-fs:add",hash:317180679,glsl3:{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\n  mat3 m = mat3(xAxis,yAxis,zAxis);\n  float trace = m[0][0] + m[1][1] + m[2][2];\n  vec4 quat;\n  if (trace > 0.) {\n    float s = 0.5 / sqrt(trace + 1.0);\n    quat.w = 0.25 / s;\n    quat.x = (m[2][1] - m[1][2]) * s;\n    quat.y = (m[0][2] - m[2][0]) * s;\n    quat.z = (m[1][0] - m[0][1]) * s;\n  } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n    float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n    quat.w = (m[2][1] - m[1][2]) / s;\n    quat.x = 0.25 * s;\n    quat.y = (m[0][1] + m[1][0]) / s;\n    quat.z = (m[0][2] + m[2][0]) / s;\n  } else if (m[1][1] > m[2][2]) {\n    float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n    quat.w = (m[0][2] - m[2][0]) / s;\n    quat.x = (m[0][1] + m[1][0]) / s;\n    quat.y = 0.25 * s;\n    quat.z = (m[1][2] + m[2][1]) / s;\n  } else {\n    float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n    quat.w = (m[1][0] - m[0][1]) / s;\n    quat.x = (m[0][2] + m[2][0]) / s;\n    quat.y = (m[1][2] + m[2][1]) / s;\n    quat.z = 0.25 * s;\n  }\n  float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n  if (len > 0.) {\n    len = 1. / sqrt(len);\n    quat.x = quat.x * len;\n    quat.y = quat.y * len;\n    quat.z = quat.z * len;\n    quat.w = quat.w * len;\n  }\n  return quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\n  float x = angle.x / 2.;\n  float y = angle.y / 2.;\n  float z = angle.z / 2.;\n  float sx = sin(x);\n  float cx = cos(x);\n  float sy = sin(y);\n  float cy = cos(y);\n  float sz = sin(z);\n  float cz = cos(z);\n  vec4 quat = vec4(0);\n  quat.x = sx * cy * cz + cx * sy * sz;\n  quat.y = cx * sy * cz + sx * cy * sz;\n  quat.z = cx * cy * sz - sx * sy * cz;\n  quat.w = cx * cy * cz - sx * sy * sz;\n  return quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\n  float x2 = q.x + q.x;\n  float y2 = q.y + q.y;\n  float z2 = q.z + q.z;\n  float xx = q.x * x2;\n  float xy = q.x * y2;\n  float xz = q.x * z2;\n  float yy = q.y * y2;\n  float yz = q.y * z2;\n  float zz = q.z * z2;\n  float wx = q.w * x2;\n  float wy = q.w * y2;\n  float wz = q.w * z2;\n  return mat4(\n    1. - (yy + zz), xy + wz, xz - wy, 0,\n    xy - wz, 1. - (xx + zz), yz + wx, 0,\n    xz + wy, yz - wx, 1. - (xx + yy), 0,\n    p.x, p.y, p.z, 1\n  );\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\n  float x = q.x, y = q.y, z = q.z, w = q.w;\n  float x2 = x + x;\n  float y2 = y + y;\n  float z2 = z + z;\n  float xx = x * x2;\n  float xy = x * y2;\n  float xz = x * z2;\n  float yy = y * y2;\n  float yz = y * z2;\n  float zz = z * z2;\n  float wx = w * x2;\n  float wy = w * y2;\n  float wz = w * z2;\n  float sx = s.x;\n  float sy = s.y;\n  float sz = s.z;\n  return mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n    (xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n    (xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\n    t.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\n  vec4 quat;\n  quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n  quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n  quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n  quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n  return quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\n  float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n  float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n  float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n  float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n  v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n  v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n  v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n  vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n  vec4 rotQuat = quatMultiply(viewQuat, q);\n  rotateVecFromQuat(pos, rotQuat);\n  return pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\n  float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n  float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n  corner.x = xOS;\n  corner.y = yOS;\n}\nuniform Constants {\n  vec4 mainTiling_Offset;\n  vec4 frameTile_velLenScale;\n  vec4 scale;\n};\nuniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n};\nuniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n};\nout vec2 uv;\nout vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n  , mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n  , vec3 eye\n  , vec4 velocity\n  , float velocityScale\n  , float lengthScale\n  , float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n  vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n  vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\n  vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\n  vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\n  pos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = vec3(1, 0, 0);\n  vec3 camY = vec3(0, 0, -1);\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\n  vec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\n  rotateCorner(viewSpaceVert, q.z);\n  vec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\n  vec3 camY = vec3(0, 1, 0);\n  vec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\n  pos.xyz += offset;\n#else\n  pos.x += vertOffset.x;\n  pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\n  vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n  aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\n  vertIndex.y = 1. - vertIndex.y;\n#endif\n  return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nin vec3 a_position;\nin vec3 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_RENDER_MODE == 1\n  in vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\n  in vec3 a_texCoord3;\n  in vec3 a_normal;\n  in vec4 a_color1;\n#endif\nvec4 lpvs_main () {\n  vec3 compScale = scale.xyz * a_texCoord1;\n  vec4 pos = vec4(a_position, 1);\n  #if CC_RENDER_MODE == 1\n    vec4 velocity = vec4(a_color1.xyz, 0);\n  #endif\n  #if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    #if CC_RENDER_MODE == 1\n      velocity = cc_matWorld * velocity;\n    #endif\n  #endif\n  #if CC_RENDER_MODE != 4\n    vec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n    #if CC_RENDER_MODE == 0\n      vec3 rotEuler = a_texCoord2;\n    #elif CC_RENDER_MODE == 1\n      vec3 rotEuler = vec3(0.);\n    #else\n      vec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n    #endif\n    computeVertPos(pos, cornerOffset, quaternionFromEuler(rotEuler), compScale\n    #if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n      , cc_matViewInv\n    #endif\n    #if CC_RENDER_MODE == 1\n      , cc_cameraPos.xyz\n      , velocity\n      , frameTile_velLenScale.z\n      , frameTile_velLenScale.w\n      , a_texCoord.x\n    #endif\n    );\n    color = a_color;\n  #else\n    mat4 xformNoScale = matrixFromRT(quaternionFromEuler(a_texCoord2), pos.xyz);\n    mat4 xform = matFromRTS(quaternionFromEuler(a_texCoord2), pos.xyz, compScale);\n    pos = xform * vec4(a_texCoord3, 1);\n    vec4 normal = xformNoScale * vec4(a_normal, 0);\n    color = a_color * a_color1;\n  #endif\n  uv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\n  pos = cc_matViewProj * pos;\n  return pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nuniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nuniform FragConstants {\n  vec4 tintColor;\n};\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n  return CCFragOutput(col);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"},glsl1:{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\n  mat3 m = mat3(xAxis,yAxis,zAxis);\n  float trace = m[0][0] + m[1][1] + m[2][2];\n  vec4 quat;\n  if (trace > 0.) {\n    float s = 0.5 / sqrt(trace + 1.0);\n    quat.w = 0.25 / s;\n    quat.x = (m[2][1] - m[1][2]) * s;\n    quat.y = (m[0][2] - m[2][0]) * s;\n    quat.z = (m[1][0] - m[0][1]) * s;\n  } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n    float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n    quat.w = (m[2][1] - m[1][2]) / s;\n    quat.x = 0.25 * s;\n    quat.y = (m[0][1] + m[1][0]) / s;\n    quat.z = (m[0][2] + m[2][0]) / s;\n  } else if (m[1][1] > m[2][2]) {\n    float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n    quat.w = (m[0][2] - m[2][0]) / s;\n    quat.x = (m[0][1] + m[1][0]) / s;\n    quat.y = 0.25 * s;\n    quat.z = (m[1][2] + m[2][1]) / s;\n  } else {\n    float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n    quat.w = (m[1][0] - m[0][1]) / s;\n    quat.x = (m[0][2] + m[2][0]) / s;\n    quat.y = (m[1][2] + m[2][1]) / s;\n    quat.z = 0.25 * s;\n  }\n  float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n  if (len > 0.) {\n    len = 1. / sqrt(len);\n    quat.x = quat.x * len;\n    quat.y = quat.y * len;\n    quat.z = quat.z * len;\n    quat.w = quat.w * len;\n  }\n  return quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\n  float x = angle.x / 2.;\n  float y = angle.y / 2.;\n  float z = angle.z / 2.;\n  float sx = sin(x);\n  float cx = cos(x);\n  float sy = sin(y);\n  float cy = cos(y);\n  float sz = sin(z);\n  float cz = cos(z);\n  vec4 quat = vec4(0);\n  quat.x = sx * cy * cz + cx * sy * sz;\n  quat.y = cx * sy * cz + sx * cy * sz;\n  quat.z = cx * cy * sz - sx * sy * cz;\n  quat.w = cx * cy * cz - sx * sy * sz;\n  return quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\n  float x2 = q.x + q.x;\n  float y2 = q.y + q.y;\n  float z2 = q.z + q.z;\n  float xx = q.x * x2;\n  float xy = q.x * y2;\n  float xz = q.x * z2;\n  float yy = q.y * y2;\n  float yz = q.y * z2;\n  float zz = q.z * z2;\n  float wx = q.w * x2;\n  float wy = q.w * y2;\n  float wz = q.w * z2;\n  return mat4(\n    1. - (yy + zz), xy + wz, xz - wy, 0,\n    xy - wz, 1. - (xx + zz), yz + wx, 0,\n    xz + wy, yz - wx, 1. - (xx + yy), 0,\n    p.x, p.y, p.z, 1\n  );\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\n  float x = q.x, y = q.y, z = q.z, w = q.w;\n  float x2 = x + x;\n  float y2 = y + y;\n  float z2 = z + z;\n  float xx = x * x2;\n  float xy = x * y2;\n  float xz = x * z2;\n  float yy = y * y2;\n  float yz = y * z2;\n  float zz = z * z2;\n  float wx = w * x2;\n  float wy = w * y2;\n  float wz = w * z2;\n  float sx = s.x;\n  float sy = s.y;\n  float sz = s.z;\n  return mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n    (xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n    (xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\n    t.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\n  vec4 quat;\n  quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n  quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n  quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n  quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n  return quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\n  float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n  float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n  float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n  float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n  v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n  v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n  v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n  vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n  vec4 rotQuat = quatMultiply(viewQuat, q);\n  rotateVecFromQuat(pos, rotQuat);\n  return pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\n  float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n  float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n  corner.x = xOS;\n  corner.y = yOS;\n}\nuniform vec4 mainTiling_Offset;\nuniform vec4 frameTile_velLenScale;\nuniform vec4 scale;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying vec2 uv;\nvarying vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n  , mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n  , vec3 eye\n  , vec4 velocity\n  , float velocityScale\n  , float lengthScale\n  , float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n  vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n  vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\n  vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\n  vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\n  pos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = vec3(1, 0, 0);\n  vec3 camY = vec3(0, 0, -1);\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\n  vec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\n  rotateCorner(viewSpaceVert, q.z);\n  vec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\n  vec3 camY = vec3(0, 1, 0);\n  vec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\n  pos.xyz += offset;\n#else\n  pos.x += vertOffset.x;\n  pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\n  vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n  aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\n  vertIndex.y = 1. - vertIndex.y;\n#endif\n  return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nattribute vec3 a_position;\nattribute vec3 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_RENDER_MODE == 1\n  attribute vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\n  attribute vec3 a_texCoord3;\n  attribute vec3 a_normal;\n  attribute vec4 a_color1;\n#endif\nvec4 lpvs_main () {\n  vec3 compScale = scale.xyz * a_texCoord1;\n  vec4 pos = vec4(a_position, 1);\n  #if CC_RENDER_MODE == 1\n    vec4 velocity = vec4(a_color1.xyz, 0);\n  #endif\n  #if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    #if CC_RENDER_MODE == 1\n      velocity = cc_matWorld * velocity;\n    #endif\n  #endif\n  #if CC_RENDER_MODE != 4\n    vec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n    #if CC_RENDER_MODE == 0\n      vec3 rotEuler = a_texCoord2;\n    #elif CC_RENDER_MODE == 1\n      vec3 rotEuler = vec3(0.);\n    #else\n      vec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n    #endif\n    computeVertPos(pos, cornerOffset, quaternionFromEuler(rotEuler), compScale\n    #if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n      , cc_matViewInv\n    #endif\n    #if CC_RENDER_MODE == 1\n      , cc_cameraPos.xyz\n      , velocity\n      , frameTile_velLenScale.z\n      , frameTile_velLenScale.w\n      , a_texCoord.x\n    #endif\n    );\n    color = a_color;\n  #else\n    mat4 xformNoScale = matrixFromRT(quaternionFromEuler(a_texCoord2), pos.xyz);\n    mat4 xform = matFromRTS(quaternionFromEuler(a_texCoord2), pos.xyz, compScale);\n    pos = xform * vec4(a_texCoord3, 1);\n    vec4 normal = xformNoScale * vec4(a_normal, 0);\n    color = a_color * a_color1;\n  #endif\n  uv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\n  pos = cc_matViewProj * pos;\n  return pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n  return CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplers:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"CC_USE_WORLD_SPACE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,members:[{name:"tintColor",type:16,count:1}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:[],binding:30}]}]},{name:"builtin-sprite",_uuid:"60f7195c-ec2a-45eb-ba94-8955f60e81d0",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"builtin-sprite|sprite-vs:vert|sprite-fs:frag",priority:244,depthStencilState:{depthTest:!1,depthWrite:!1},properties:{mainTexture:{value:"white",type:28}}}]}],shaders:[{name:"builtin-sprite|sprite-vs:vert|sprite-fs:frag",hash:543960898,glsl3:{vert:"\nprecision mediump float;\nuniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n};\n#if USE_LOCAL\nuniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n};\n#endif\nin vec3 a_position;\nin vec4 a_color;\nout vec4 color;\nin vec2 a_texCoord;\nout vec2 uv0;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  #if USE_LOCAL\n    pos = cc_matViewProj * cc_matWorld * pos;\n  #else\n    pos = cc_matViewProj * pos;\n  #endif\n  uv0 = a_texCoord;\n  color = a_color;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nin vec4 color;\n#if USE_TEXTURE\n  in vec2 uv0;\n  uniform sampler2D mainTexture;\n#endif\nvec4 frag () {\n  vec4 o = vec4(1, 1, 1, 1);\n  #if USE_TEXTURE\n    o *= texture(mainTexture, uv0);\n    #if IS_GRAY\n      float gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\n      o.r = o.g = o.b = gray;\n    #endif\n  #endif\n  o *= color;\n  return o;\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},glsl1:{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matViewProj;\n#if USE_LOCAL\nuniform highp mat4 cc_matWorld;\n#endif\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying vec4 color;\nattribute vec2 a_texCoord;\nvarying vec2 uv0;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  #if USE_LOCAL\n    pos = cc_matViewProj * cc_matWorld * pos;\n  #else\n    pos = cc_matViewProj * pos;\n  #endif\n  uv0 = a_texCoord;\n  color = a_color;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvarying vec4 color;\n#if USE_TEXTURE\n  varying vec2 uv0;\n  uniform sampler2D mainTexture;\n#endif\nvec4 frag () {\n  vec4 o = vec4(1, 1, 1, 1);\n  #if USE_TEXTURE\n    o *= texture2D(mainTexture, uv0);\n    #if IS_GRAY\n      float gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\n      o.r = o.g = o.b = gray;\n    #endif\n  #endif\n  o *= color;\n  return o;\n}\nvoid main() { gl_FragColor = frag(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:["USE_LOCAL"]}],samplers:[]}},defines:[{name:"USE_LOCAL",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"IS_GRAY",type:"boolean"}],blocks:[],samplers:[{name:"mainTexture",type:28,count:1,defines:["USE_TEXTURE"],binding:30}]}]},{name:"builtin-standard",_uuid:"1baf0fc9-befa-459c-8bdd-af1a450a0319",techniques:[{name:"opaque",passes:[{program:"builtin-standard|standard-vs:vert|standard-fs:frag",properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},occlusion:{value:[1],type:13,handleInfo:["pbrParams",0,13]},roughness:{value:[.8],type:13,handleInfo:["pbrParams",1,13]},metallic:{value:[.6],type:13,handleInfo:["pbrParams",2,13]},normalStrenth:{value:[1],type:13,handleInfo:["pbrParams",3,13]},emissive:{value:[0,0,0,1],type:16},emissiveScale:{value:[1,1,1],type:15,handleInfo:["emissiveScaleParam",0,15]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},normalMap:{value:"normal",type:28},pbrMap:{value:"grey",type:28},metallicRoughnessMap:{value:"grey",type:28},occlusionMap:{value:"white",type:28},emissiveMap:{value:"grey",type:28},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},pbrParams:{type:16,value:[1,.8,.6,1]},emissiveScaleParam:{type:16,value:[1,1,1,0]},albedoMap:{type:28,value:"grey"}}}]}],shaders:[{name:"builtin-standard|standard-vs:vert|standard-fs:frag",hash:3845416769,glsl3:{vert:"\nprecision highp float;\nuniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n};\n#if USE_BATCHING\n  in float a_dyn_batch_id;\n  uniform CCLocalBatched {\n    highp mat4 cc_matWorlds[10];\n  };\n#else\nuniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n};\n#endif\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec4 a_tangent;\n#if USE_SKINNING\nin vec4 a_weights;\nin vec4 a_joints;\nuniform CCSkinningTexture {\n  highp vec4 cc_jointsTextureInfo;\n};\nuniform CCSkinningAnimation {\n  highp vec4 cc_jointsAnimInfo;\n};\nuniform sampler2D cc_jointsTexture;\n#if USE_SKINNING == 1\n  highp float decode32 (highp vec4 rgba) {\n    rgba = rgba * 255.0;\n    highp float Sign = 1.0 - step(128.0, rgba[3]) * 2.0;\n    highp float Exponent = 2.0 * mod(rgba[3], 128.0) + step(128.0, rgba[2]) - 127.0;\n    highp float Mantissa = mod(rgba[2], 128.0) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n    return Sign * exp2(Exponent - 23.0) * Mantissa;\n  }\n#endif\n#if USE_SKINNING == 1\n  mat4 getJointMatrix (float i) {\n    highp float j = 12.0 * (cc_jointsAnimInfo.x * i + cc_jointsAnimInfo.y) + cc_jointsTextureInfo.z;\n    highp float invSize = cc_jointsTextureInfo.y;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    vec4 v1 = vec4(\n      decode32(texture(cc_jointsTexture, vec2((x + 0.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 1.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 2.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 3.5) * invSize, y)))\n    );\n    vec4 v2 = vec4(\n      decode32(texture(cc_jointsTexture, vec2((x + 4.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 5.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 6.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 7.5) * invSize, y)))\n    );\n    vec4 v3 = vec4(\n      decode32(texture(cc_jointsTexture, vec2((x + 8.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 9.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 10.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 11.5) * invSize, y)))\n    );\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#elif USE_SKINNING == 2\n  mat4 getJointMatrix (float i) {\n    highp float j = 3.0 * (cc_jointsAnimInfo.x * i + cc_jointsAnimInfo.y) + cc_jointsTextureInfo.z;\n    highp float invSize = cc_jointsTextureInfo.y;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    vec4 v1 = texture(cc_jointsTexture, vec2((x + 0.5) * invSize, y));\n    vec4 v2 = texture(cc_jointsTexture, vec2((x + 1.5) * invSize, y));\n    vec4 v3 = texture(cc_jointsTexture, vec2((x + 2.5) * invSize, y));\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  return getJointMatrix(a_joints.x) * a_weights.x\n    + getJointMatrix(a_joints.y) * a_weights.y;\n    + getJointMatrix(a_joints.z) * a_weights.z;\n    + getJointMatrix(a_joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform Constants {\n  vec4 tilingOffset;\n  vec4 albedo;\n  vec4 albedoScaleAndCutoff;\n  vec4 pbrParams;\n  vec4 emissive;\n  vec4 emissiveScaleParam;\n};\n#if USE_VERTEX_COLOR\n  in vec3 a_color;\n  out vec3 v_color;\n#endif\nout vec3 v_position;\nout vec3 v_normal;\n#if USE_NORMAL_MAP\n  out vec3 v_tangent;\n  out vec3 v_bitangent;\n#endif\nin vec2 a_texCoord;\nout vec2 v_uv;\nin vec2 a_texCoord1;\nout vec2 v_uv1;\nvec4 vert () {\n  StandardVertInput In;\n  In.position = vec4(a_position, 1.0);\n  In.normal = a_normal;\n  In.tangent = a_tangent;\n  #if USE_SKINNING\n    CCSkin(In);\n  #endif\n  mat4 matWorld, matWorldIT;\n  #if USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id + 0.5)];\n    matWorldIT = matWorld;\n  #else\n    matWorld = cc_matWorld;\n    matWorldIT = cc_matWorldIT;\n  #endif\n  vec4 pos = matWorld * In.position;\n  v_position = pos.xyz;\n  v_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n  #if USE_NORMAL_MAP\n    v_tangent = normalize((matWorldIT * vec4(In.tangent.xyz, 0.0)).xyz);\n    v_bitangent = cross(v_normal, v_tangent) * In.tangent.w;\n  #endif\n  v_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n  #if HAS_SECOND_UV\n    v_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  #if USE_VERTEX_COLOR\n    v_color = a_color;\n  #endif\n  return cc_matProj * (cc_matView * matWorld) * In.position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nuniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n};\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\n  return rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n    return textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n    return textureLod(tex, coord, lod);\n}\n#endif\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nuniform CCForwardLight {\n  highp vec4 cc_sphereLitPos[2];\n  vec4 cc_sphereLitSizeRange[2];\n  vec4 cc_sphereLitColor[2];\n  highp vec4 cc_spotLitPos[2];\n  vec4 cc_spotLitSizeRangeAngle[2];\n  vec4 cc_spotLitDir[2];\n  vec4 cc_spotLitColor[2];\n};\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\n  float factor = distSqr * invSqrAttRadius;\n  float smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\n  return smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\n  float attenuation = 1.0 / max(distSqr, 0.01*0.01);\n  attenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\n  return attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\n  float cd = dot(litDir, L);\n  float attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\n  return (attenuation * attenuation);\n}\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\n  vec3 NxH = cross(N, H);\n  float OneMinusNoHSqr = dot(NxH, NxH);\n  float a = roughness * roughness;\n  float n = NoH * a;\n  float p = a / (OneMinusNoHSqr + n * n);\n  return p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\n  return (roughness*0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\n  const vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\n  const vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\n  vec4 r = roughness * c0 + c1;\n  float a004 = min( r.x * r.x, exp2( -9.28 * NoV ) ) * r.x + r.y;\n  vec2 AB = vec2( -1.04, 1.04 ) * a004 + r.zw;\n  AB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\n  return specular * AB.x + AB.y;\n}\nvec3 CalcDynamicLighting (vec3 worldPos, vec3 N, vec3 V, vec3 diffuse, vec3 specular, float roughness) {\n  vec3 lighting = vec3(0.0);\n  vec3 diffuseContrib = diffuse / 3.14159265359;\n  for (int i = 0; i < 2; i++) {\n    vec3 PLU = cc_sphereLitPos[i].xyz - worldPos;\n    vec3 PL = normalize(PLU);\n    vec3 PH = normalize(PL + V);\n    float PNL = max(dot(N, PL), 0.001);\n    float PNH = max(dot(N, PH), 0.0);\n    float distSqr = dot(PLU, PLU);\n    float litRadius = cc_sphereLitSizeRange[i].x;\n    float litRadiusSqr = litRadius * litRadius;\n    float illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\n    float attRadiusSqrInv = 1.0 / max(cc_sphereLitSizeRange[i].y, 0.01);\n    attRadiusSqrInv *= attRadiusSqrInv;\n    float att = GetDistAtt(distSqr, attRadiusSqrInv);\n    vec3 lspec = specular * CalcSpecular(roughness, PNH, PH, N);\n    lighting += PNL * cc_sphereLitColor[i].rgb * cc_sphereLitColor[i].w * illum * att * (diffuseContrib + lspec);\n  }\n  for (int i = 0; i < 2; i++) {\n    vec3 SLU = cc_spotLitPos[i].xyz - worldPos;\n    vec3 SL = normalize(SLU);\n    vec3 SH = normalize(SL + V);\n    float SNL = max(dot(N, SL), 0.001);\n    float SNH = max(dot(N, SH), 0.0);\n    float distSqr = dot(SLU, SLU);\n    float litRadius = cc_spotLitSizeRangeAngle[i].x;\n    float litRadiusSqr = litRadius * litRadius;\n    float illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\n    float attRadiusSqrInv = 1.0 / max(cc_spotLitSizeRangeAngle[i].y, 0.01);\n    attRadiusSqrInv *= attRadiusSqrInv;\n    float cosInner = max(dot(-cc_spotLitDir[i].xyz, SL), 0.01);\n    float cosOuter = cc_spotLitSizeRangeAngle[i].z;\n    float litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\n    float litAngleOffset = -cosOuter * litAngleScale;\n    float att = GetDistAtt(distSqr, attRadiusSqrInv);\n    att *= GetAngleAtt(SL, -cc_spotLitDir[i].xyz, litAngleScale, litAngleOffset);\n    vec3 lspec = specular * CalcSpecular(roughness, SNH, SH, N);\n    lighting += SNL * cc_spotLitColor[i].rgb * cc_spotLitColor[i].w * illum * att * (diffuseContrib + lspec);\n  }\n  return lighting;\n}\nstruct StandardSurface {\n  vec4 albedo;\n  vec3 position;\n  vec3 normal;\n  vec3 emissive;\n  float roughness;\n  float metallic;\n  float occlusion;\n};\nvec4 CCStandardShading (StandardSurface s) {\n  vec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\n  vec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\n  vec3 N = normalize(s.normal);\n  vec3 V = normalize(cc_cameraPos.xyz - s.position);\n  vec3 L = normalize(-cc_mainLitDir.xyz);\n  vec3 H = normalize(L+V);\n  float NV = max(abs(dot(N, V)), 0.001);\n  float NL = max(dot(N, L), 0.001);\n  float NH = max(dot(N, H), 0.0);\n  specular = BRDFApprox(specular, s.roughness, NV);\n  vec3 diffuseContrib = diffuse / 3.14159265359;\n  vec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\n  vec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w * (diffuseContrib + specularContrib);\n  finalColor += CalcDynamicLighting(s.position, N, V, diffuse, specular, s.roughness);\n  float fAmb = 0.5 - N.y * 0.5;\n  vec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\n  finalColor += (ambDiff.rgb * diffuse);\n  #if CC_USE_IBL\n    vec3 R = normalize(reflect(-V, N));\n    vec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n    #if CC_USE_IBL == 2\n      vec3 env = unpackRGBE(envmap);\n    #else\n      vec3 env = SRGBToLinear(envmap.rgb) * cc_ambientSky.w;\n    #endif\n    finalColor += env * specular;\n  #endif\n  finalColor = finalColor * s.occlusion;\n  #if CC_USE_HDR\n    s.emissive *= cc_exposure.w;\n  #endif\n  finalColor += s.emissive;\n  return vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\n  color = min(color, vec3(8.0));\n  const float A = 2.51;\n  const float B = 0.03;\n  const float C = 2.43;\n  const float D = 0.59;\n  const float E = 0.14;\n  return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n  #if !CC_USE_HDR\n    color.rgb = sqrt(ACESToneMap(color.rgb));\n  #endif\n  return color;\n}\nuniform Constants {\n  vec4 tilingOffset;\n  vec4 albedo;\n  vec4 albedoScaleAndCutoff;\n  vec4 pbrParams;\n  vec4 emissive;\n  vec4 emissiveScaleParam;\n};\nin vec3 v_position;\nin vec2 v_uv;\nin vec2 v_uv1;\nin vec3 v_normal;\n#if USE_VERTEX_COLOR\n  in vec3 v_color;\n#endif\n#if USE_ALBEDO_MAP\n  uniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\n  in vec3 v_tangent;\n  in vec3 v_bitangent;\n  uniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\n  uniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\n  uniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\n  uniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\n  uniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\n  vec4 baseColor = albedo;\n  #if USE_VERTEX_COLOR\n    baseColor.rgb *= v_color;\n  #endif\n  #if USE_ALBEDO_MAP\n    vec4 texColor = texture(albedoMap, ALBEDO_UV);\n    texColor.rgb = SRGBToLinear(texColor.rgb);\n    baseColor *= texColor;\n  #endif\n  s.albedo = baseColor;\n  s.albedo.rgb *= albedoScaleAndCutoff.xyz;\n  #if USE_ALPHA_TEST\n    if (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n  #endif\n  s.normal = v_normal;\n  #if USE_NORMAL_MAP\n    vec3 nmmp = texture(normalMap, NORMAL_UV).xyz - vec3(0.5);\n    s.normal =\n      (nmmp.x * pbrParams.w) * normalize(v_tangent) +\n      (nmmp.y * pbrParams.w) * normalize(v_bitangent) +\n      nmmp.z * normalize(s.normal);\n  #endif\n  s.position = v_position;\n  vec4 pbr = pbrParams;\n  #if USE_PBR_MAP\n    vec4 res = texture(pbrMap, PBR_UV);\n    pbr.x *= res.OCCLUSION_CHANNEL;\n    pbr.y *= res.ROUGHNESS_CHANNEL;\n    pbr.z *= res.METALLIC_CHANNEL;\n  #endif\n  #if USE_METALLIC_ROUGHNESS_MAP\n    vec4 metallicRoughness = texture(metallicRoughnessMap, METALLIC_ROUGHNESS_UV);\n    pbr.z *= metallicRoughness.METALLIC_CHANNEL;\n    pbr.y *= metallicRoughness.ROUGHNESS_CHANNEL;\n  #endif\n  #if USE_OCCLUSION_MAP\n    pbr.x *= texture(occlusionMap, OCCLUSION_UV).OCCLUSION_CHANNEL;\n  #endif\n  s.occlusion = clamp(pbr.x, 0.0, 0.96);\n  s.roughness = clamp(pbr.y, 0.04, 1.0);\n  s.metallic = pbr.z;\n  s.emissive = emissive.rgb * emissiveScaleParam.xyz;\n  #if USE_EMISSIVE_MAP\n    s.emissive *= SRGBToLinear(texture(emissiveMap, EMISSIVE_UV).rgb);\n  #endif\n}\nvec4 frag () {\n  StandardSurface s; surf(s);\n  vec4 color = CCStandardShading(s);\n  return CCFragOutput(color);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},glsl1:{vert:"\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\n#if USE_BATCHING\n  attribute float a_dyn_batch_id;\n  uniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matWorldIT;\n#endif\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec4 a_tangent;\n#if USE_SKINNING\nattribute vec4 a_weights;\nattribute vec4 a_joints;\nuniform highp vec4 cc_jointsTextureInfo;\nuniform highp vec4 cc_jointsAnimInfo;\nuniform sampler2D cc_jointsTexture;\n#if USE_SKINNING == 1\n  highp float decode32 (highp vec4 rgba) {\n    rgba = rgba * 255.0;\n    highp float Sign = 1.0 - step(128.0, rgba[3]) * 2.0;\n    highp float Exponent = 2.0 * mod(rgba[3], 128.0) + step(128.0, rgba[2]) - 127.0;\n    highp float Mantissa = mod(rgba[2], 128.0) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n    return Sign * exp2(Exponent - 23.0) * Mantissa;\n  }\n#endif\n#if USE_SKINNING == 1\n  mat4 getJointMatrix (float i) {\n    highp float j = 12.0 * (cc_jointsAnimInfo.x * i + cc_jointsAnimInfo.y) + cc_jointsTextureInfo.z;\n    highp float invSize = cc_jointsTextureInfo.y;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    vec4 v1 = vec4(\n      decode32(texture2D(cc_jointsTexture, vec2((x + 0.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 1.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 2.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 3.5) * invSize, y)))\n    );\n    vec4 v2 = vec4(\n      decode32(texture2D(cc_jointsTexture, vec2((x + 4.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 5.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 6.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 7.5) * invSize, y)))\n    );\n    vec4 v3 = vec4(\n      decode32(texture2D(cc_jointsTexture, vec2((x + 8.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 9.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 10.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 11.5) * invSize, y)))\n    );\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#elif USE_SKINNING == 2\n  mat4 getJointMatrix (float i) {\n    highp float j = 3.0 * (cc_jointsAnimInfo.x * i + cc_jointsAnimInfo.y) + cc_jointsTextureInfo.z;\n    highp float invSize = cc_jointsTextureInfo.y;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    vec4 v1 = texture2D(cc_jointsTexture, vec2((x + 0.5) * invSize, y));\n    vec4 v2 = texture2D(cc_jointsTexture, vec2((x + 1.5) * invSize, y));\n    vec4 v3 = texture2D(cc_jointsTexture, vec2((x + 2.5) * invSize, y));\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  return getJointMatrix(a_joints.x) * a_weights.x\n    + getJointMatrix(a_joints.y) * a_weights.y;\n    + getJointMatrix(a_joints.z) * a_weights.z;\n    + getJointMatrix(a_joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform vec4 tilingOffset;\n#if USE_VERTEX_COLOR\n  attribute vec3 a_color;\n  varying vec3 v_color;\n#endif\nvarying vec3 v_position;\nvarying vec3 v_normal;\n#if USE_NORMAL_MAP\n  varying vec3 v_tangent;\n  varying vec3 v_bitangent;\n#endif\nattribute vec2 a_texCoord;\nvarying vec2 v_uv;\nattribute vec2 a_texCoord1;\nvarying vec2 v_uv1;\nvec4 vert () {\n  StandardVertInput In;\n  In.position = vec4(a_position, 1.0);\n  In.normal = a_normal;\n  In.tangent = a_tangent;\n  #if USE_SKINNING\n    CCSkin(In);\n  #endif\n  mat4 matWorld, matWorldIT;\n  #if USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id + 0.5)];\n    matWorldIT = matWorld;\n  #else\n    matWorld = cc_matWorld;\n    matWorldIT = cc_matWorldIT;\n  #endif\n  vec4 pos = matWorld * In.position;\n  v_position = pos.xyz;\n  v_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n  #if USE_NORMAL_MAP\n    v_tangent = normalize((matWorldIT * vec4(In.tangent.xyz, 0.0)).xyz);\n    v_bitangent = cross(v_normal, v_tangent) * In.tangent.w;\n  #endif\n  v_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n  #if HAS_SECOND_UV\n    v_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  #if USE_VERTEX_COLOR\n    v_color = a_color;\n  #endif\n  return cc_matProj * (cc_matView * matWorld) * In.position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\n  #ifdef GL_EXT_shader_texture_lod\n    #extension GL_EXT_shader_texture_lod : enable\n  #endif\nprecision highp float;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_exposure;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\n  return rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n    #ifdef GL_EXT_shader_texture_lod\n      return texture2DLodEXT(tex, coord, lod);\n    #else\n      return texture2D(tex, coord, lod);\n    #endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n    #ifdef GL_EXT_shader_texture_lod\n      return textureCubeLodEXT(tex, coord, lod);\n    #else\n      return textureCube(tex, coord, lod);\n    #endif\n}\n#endif\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nuniform highp vec4 cc_sphereLitPos[2];\nuniform vec4 cc_sphereLitSizeRange[2];\nuniform vec4 cc_sphereLitColor[2];\nuniform highp vec4 cc_spotLitPos[2];\nuniform vec4 cc_spotLitSizeRangeAngle[2];\nuniform vec4 cc_spotLitDir[2];\nuniform vec4 cc_spotLitColor[2];\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\n  float factor = distSqr * invSqrAttRadius;\n  float smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\n  return smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\n  float attenuation = 1.0 / max(distSqr, 0.01*0.01);\n  attenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\n  return attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\n  float cd = dot(litDir, L);\n  float attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\n  return (attenuation * attenuation);\n}\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\n  vec3 NxH = cross(N, H);\n  float OneMinusNoHSqr = dot(NxH, NxH);\n  float a = roughness * roughness;\n  float n = NoH * a;\n  float p = a / (OneMinusNoHSqr + n * n);\n  return p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\n  return (roughness*0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\n  const vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\n  const vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\n  vec4 r = roughness * c0 + c1;\n  float a004 = min( r.x * r.x, exp2( -9.28 * NoV ) ) * r.x + r.y;\n  vec2 AB = vec2( -1.04, 1.04 ) * a004 + r.zw;\n  AB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\n  return specular * AB.x + AB.y;\n}\nvec3 CalcDynamicLighting (vec3 worldPos, vec3 N, vec3 V, vec3 diffuse, vec3 specular, float roughness) {\n  vec3 lighting = vec3(0.0);\n  vec3 diffuseContrib = diffuse / 3.14159265359;\n  for (int i = 0; i < 2; i++) {\n    vec3 PLU = cc_sphereLitPos[i].xyz - worldPos;\n    vec3 PL = normalize(PLU);\n    vec3 PH = normalize(PL + V);\n    float PNL = max(dot(N, PL), 0.001);\n    float PNH = max(dot(N, PH), 0.0);\n    float distSqr = dot(PLU, PLU);\n    float litRadius = cc_sphereLitSizeRange[i].x;\n    float litRadiusSqr = litRadius * litRadius;\n    float illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\n    float attRadiusSqrInv = 1.0 / max(cc_sphereLitSizeRange[i].y, 0.01);\n    attRadiusSqrInv *= attRadiusSqrInv;\n    float att = GetDistAtt(distSqr, attRadiusSqrInv);\n    vec3 lspec = specular * CalcSpecular(roughness, PNH, PH, N);\n    lighting += PNL * cc_sphereLitColor[i].rgb * cc_sphereLitColor[i].w * illum * att * (diffuseContrib + lspec);\n  }\n  for (int i = 0; i < 2; i++) {\n    vec3 SLU = cc_spotLitPos[i].xyz - worldPos;\n    vec3 SL = normalize(SLU);\n    vec3 SH = normalize(SL + V);\n    float SNL = max(dot(N, SL), 0.001);\n    float SNH = max(dot(N, SH), 0.0);\n    float distSqr = dot(SLU, SLU);\n    float litRadius = cc_spotLitSizeRangeAngle[i].x;\n    float litRadiusSqr = litRadius * litRadius;\n    float illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\n    float attRadiusSqrInv = 1.0 / max(cc_spotLitSizeRangeAngle[i].y, 0.01);\n    attRadiusSqrInv *= attRadiusSqrInv;\n    float cosInner = max(dot(-cc_spotLitDir[i].xyz, SL), 0.01);\n    float cosOuter = cc_spotLitSizeRangeAngle[i].z;\n    float litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\n    float litAngleOffset = -cosOuter * litAngleScale;\n    float att = GetDistAtt(distSqr, attRadiusSqrInv);\n    att *= GetAngleAtt(SL, -cc_spotLitDir[i].xyz, litAngleScale, litAngleOffset);\n    vec3 lspec = specular * CalcSpecular(roughness, SNH, SH, N);\n    lighting += SNL * cc_spotLitColor[i].rgb * cc_spotLitColor[i].w * illum * att * (diffuseContrib + lspec);\n  }\n  return lighting;\n}\nstruct StandardSurface {\n  vec4 albedo;\n  vec3 position;\n  vec3 normal;\n  vec3 emissive;\n  float roughness;\n  float metallic;\n  float occlusion;\n};\nvec4 CCStandardShading (StandardSurface s) {\n  vec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\n  vec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\n  vec3 N = normalize(s.normal);\n  vec3 V = normalize(cc_cameraPos.xyz - s.position);\n  vec3 L = normalize(-cc_mainLitDir.xyz);\n  vec3 H = normalize(L+V);\n  float NV = max(abs(dot(N, V)), 0.001);\n  float NL = max(dot(N, L), 0.001);\n  float NH = max(dot(N, H), 0.0);\n  specular = BRDFApprox(specular, s.roughness, NV);\n  vec3 diffuseContrib = diffuse / 3.14159265359;\n  vec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\n  vec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w * (diffuseContrib + specularContrib);\n  finalColor += CalcDynamicLighting(s.position, N, V, diffuse, specular, s.roughness);\n  float fAmb = 0.5 - N.y * 0.5;\n  vec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\n  finalColor += (ambDiff.rgb * diffuse);\n  #if CC_USE_IBL\n    vec3 R = normalize(reflect(-V, N));\n    vec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n    #if CC_USE_IBL == 2\n      vec3 env = unpackRGBE(envmap);\n    #else\n      vec3 env = SRGBToLinear(envmap.rgb) * cc_ambientSky.w;\n    #endif\n    finalColor += env * specular;\n  #endif\n  finalColor = finalColor * s.occlusion;\n  #if CC_USE_HDR\n    s.emissive *= cc_exposure.w;\n  #endif\n  finalColor += s.emissive;\n  return vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\n  color = min(color, vec3(8.0));\n  const float A = 2.51;\n  const float B = 0.03;\n  const float C = 2.43;\n  const float D = 0.59;\n  const float E = 0.14;\n  return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n  #if !CC_USE_HDR\n    color.rgb = sqrt(ACESToneMap(color.rgb));\n  #endif\n  return color;\n}\nuniform vec4 albedo;\nuniform vec4 albedoScaleAndCutoff;\nuniform vec4 pbrParams;\nuniform vec4 emissive;\nuniform vec4 emissiveScaleParam;\nvarying vec3 v_position;\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec3 v_normal;\n#if USE_VERTEX_COLOR\n  varying vec3 v_color;\n#endif\n#if USE_ALBEDO_MAP\n  uniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\n  varying vec3 v_tangent;\n  varying vec3 v_bitangent;\n  uniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\n  uniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\n  uniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\n  uniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\n  uniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\n  vec4 baseColor = albedo;\n  #if USE_VERTEX_COLOR\n    baseColor.rgb *= v_color;\n  #endif\n  #if USE_ALBEDO_MAP\n    vec4 texColor = texture2D(albedoMap, ALBEDO_UV);\n    texColor.rgb = SRGBToLinear(texColor.rgb);\n    baseColor *= texColor;\n  #endif\n  s.albedo = baseColor;\n  s.albedo.rgb *= albedoScaleAndCutoff.xyz;\n  #if USE_ALPHA_TEST\n    if (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n  #endif\n  s.normal = v_normal;\n  #if USE_NORMAL_MAP\n    vec3 nmmp = texture2D(normalMap, NORMAL_UV).xyz - vec3(0.5);\n    s.normal =\n      (nmmp.x * pbrParams.w) * normalize(v_tangent) +\n      (nmmp.y * pbrParams.w) * normalize(v_bitangent) +\n      nmmp.z * normalize(s.normal);\n  #endif\n  s.position = v_position;\n  vec4 pbr = pbrParams;\n  #if USE_PBR_MAP\n    vec4 res = texture2D(pbrMap, PBR_UV);\n    pbr.x *= res.OCCLUSION_CHANNEL;\n    pbr.y *= res.ROUGHNESS_CHANNEL;\n    pbr.z *= res.METALLIC_CHANNEL;\n  #endif\n  #if USE_METALLIC_ROUGHNESS_MAP\n    vec4 metallicRoughness = texture2D(metallicRoughnessMap, METALLIC_ROUGHNESS_UV);\n    pbr.z *= metallicRoughness.METALLIC_CHANNEL;\n    pbr.y *= metallicRoughness.ROUGHNESS_CHANNEL;\n  #endif\n  #if USE_OCCLUSION_MAP\n    pbr.x *= texture2D(occlusionMap, OCCLUSION_UV).OCCLUSION_CHANNEL;\n  #endif\n  s.occlusion = clamp(pbr.x, 0.0, 0.96);\n  s.roughness = clamp(pbr.y, 0.04, 1.0);\n  s.metallic = pbr.z;\n  s.emissive = emissive.rgb * emissiveScaleParam.xyz;\n  #if USE_EMISSIVE_MAP\n    s.emissive *= SRGBToLinear(texture2D(emissiveMap, EMISSIVE_UV).rgb);\n  #endif\n}\nvec4 frag () {\n  StandardSurface s; surf(s);\n  vec4 color = CCStandardShading(s);\n  return CCFragOutput(color);\n}\nvoid main() { gl_FragColor = frag(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[{name:"cc_environment",defines:["CC_USE_IBL"]}]},locals:{blocks:[{name:"CCLocalBatched",defines:["USE_BATCHING"]},{name:"CCLocal",defines:[]},{name:"CCSkinningTexture",defines:["USE_SKINNING"]},{name:"CCSkinningAnimation",defines:["USE_SKINNING"]},{name:"CCForwardLight",defines:[]}],samplers:[{name:"cc_jointsTexture",defines:["USE_SKINNING"]}]}},defines:[{name:"USE_BATCHING",type:"boolean"},{name:"USE_SKINNING",type:"boolean"},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"USE_NORMAL_MAP",type:"boolean"},{name:"HAS_SECOND_UV",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_ALBEDO_MAP",type:"boolean"},{name:"ALBEDO_UV",type:"string",options:["v_uv","v_uv1"]},{name:"NORMAL_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_PBR_MAP",type:"boolean"},{name:"PBR_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_METALLIC_ROUGHNESS_MAP",type:"boolean"},{name:"METALLIC_ROUGHNESS_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_OCCLUSION_MAP",type:"boolean"},{name:"OCCLUSION_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_EMISSIVE_MAP",type:"boolean"},{name:"EMISSIVE_UV",type:"string",options:["v_uv","v_uv1"]},{name:"OCCLUSION_CHANNEL",type:"string",options:["r","g","b"]},{name:"ROUGHNESS_CHANNEL",type:"string",options:["g","b","r"]},{name:"METALLIC_CHANNEL",type:"string",options:["b","r","g"]},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r"]}],blocks:[{name:"Constants",defines:[],binding:0,members:[{name:"tilingOffset",type:16,count:1},{name:"albedo",type:16,count:1},{name:"albedoScaleAndCutoff",type:16,count:1},{name:"pbrParams",type:16,count:1},{name:"emissive",type:16,count:1},{name:"emissiveScaleParam",type:16,count:1}]}],samplers:[{name:"albedoMap",type:28,count:1,defines:["USE_ALBEDO_MAP"],binding:30},{name:"normalMap",type:28,count:1,defines:["USE_NORMAL_MAP"],binding:31},{name:"pbrMap",type:28,count:1,defines:["USE_PBR_MAP"],binding:32},{name:"metallicRoughnessMap",type:28,count:1,defines:["USE_METALLIC_ROUGHNESS_MAP"],binding:33},{name:"occlusionMap",type:28,count:1,defines:["USE_OCCLUSION_MAP"],binding:34},{name:"emissiveMap",type:28,count:1,defines:["USE_EMISSIVE_MAP"],binding:35}]}]},{name:"builtin-terrain",_uuid:"1d08ef62-a503-4ce2-8b9a-46c90873f7d3",techniques:[{name:"opaque",passes:[{program:"builtin-terrain|terrain-vs:vert|terrain-fs:frag",properties:{UVScale:{value:[1,1,1,1],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28}}}]}],shaders:[{name:"builtin-terrain|terrain-vs:vert|terrain-fs:frag",hash:1414533658,glsl3:{vert:"\nprecision mediump float;\nuniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n};\nuniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nout vec2 uvw;\nout vec2 uv0;\nout vec2 uv1;\nout vec2 uv2;\nout vec2 uv3;\nout vec3 diffuse;\nuniform TexCoords {\n  vec4 UVScale;\n};\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  pos = cc_matWorld * pos;\n  pos = cc_matViewProj * pos;\n  uvw = a_texCoord;\n  uv0 = a_position.xz * UVScale.x;\n  uv1 = a_position.xz * UVScale.y;\n  uv2 = a_position.xz * UVScale.z;\n  uv3 = a_position.xz * UVScale.w;\n  vec3 L = normalize(-cc_mainLitDir.xyz);\n  vec3 N = a_normal;\n  float fAmb = dot(N, vec3(0.0, -1.0, 0.0)) * 0.5 + 0.5;\n  vec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\n  diffuse = ambDiff + vec3(dot(N, L));\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\n  in vec2 uvw;\n  in vec2 uv0;\n  in vec2 uv1;\n  in vec2 uv2;\n  in vec2 uv3;\n  in vec3 diffuse;\n  uniform sampler2D weightMap;\n  uniform sampler2D detailMap0;\n  uniform sampler2D detailMap1;\n  uniform sampler2D detailMap2;\n  uniform sampler2D detailMap3;\nvec4 frag () {\n  vec4 color = vec4(0, 0, 0, 0);\n  #if LAYERS == 1\n    color = texture(detailMap0, uv0);\n  #elif LAYERS == 2\n    vec4 w = texture(weightMap, uvw);\n    color += texture(detailMap0, uv0) * w.r;\n    color += texture(detailMap1, uv1) * w.g;\n  #elif LAYERS == 3\n    vec4 w = texture(weightMap, uvw);\n    color += texture(detailMap0, uv0) * w.r;\n    color += texture(detailMap1, uv1) * w.g;\n    color += texture(detailMap2, uv2) * w.b;\n  #elif LAYERS == 4\n    vec4 w = texture(weightMap, uvw);\n    color += texture(detailMap0, uv0) * w.r;\n    color += texture(detailMap1, uv1) * w.g;\n    color += texture(detailMap2, uv2) * w.b;\n    color += texture(detailMap3, uv3) * w.a;\n  #else\n    color = texture(detailMap0, uv0);\n  #endif\n  color.rgb *= diffuse;\n  return CCFragOutput(color);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},glsl1:{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matViewProj;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform highp mat4 cc_matWorld;\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nvarying vec2 uvw;\nvarying vec2 uv0;\nvarying vec2 uv1;\nvarying vec2 uv2;\nvarying vec2 uv3;\nvarying vec3 diffuse;\nuniform vec4 UVScale;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  pos = cc_matWorld * pos;\n  pos = cc_matViewProj * pos;\n  uvw = a_texCoord;\n  uv0 = a_position.xz * UVScale.x;\n  uv1 = a_position.xz * UVScale.y;\n  uv2 = a_position.xz * UVScale.z;\n  uv3 = a_position.xz * UVScale.w;\n  vec3 L = normalize(-cc_mainLitDir.xyz);\n  vec3 N = a_normal;\n  float fAmb = dot(N, vec3(0.0, -1.0, 0.0)) * 0.5 + 0.5;\n  vec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\n  diffuse = ambDiff + vec3(dot(N, L));\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\n  varying vec2 uvw;\n  varying vec2 uv0;\n  varying vec2 uv1;\n  varying vec2 uv2;\n  varying vec2 uv3;\n  varying vec3 diffuse;\n  uniform sampler2D weightMap;\n  uniform sampler2D detailMap0;\n  uniform sampler2D detailMap1;\n  uniform sampler2D detailMap2;\n  uniform sampler2D detailMap3;\nvec4 frag () {\n  vec4 color = vec4(0, 0, 0, 0);\n  #if LAYERS == 1\n    color = texture2D(detailMap0, uv0);\n  #elif LAYERS == 2\n    vec4 w = texture2D(weightMap, uvw);\n    color += texture2D(detailMap0, uv0) * w.r;\n    color += texture2D(detailMap1, uv1) * w.g;\n  #elif LAYERS == 3\n    vec4 w = texture2D(weightMap, uvw);\n    color += texture2D(detailMap0, uv0) * w.r;\n    color += texture2D(detailMap1, uv1) * w.g;\n    color += texture2D(detailMap2, uv2) * w.b;\n  #elif LAYERS == 4\n    vec4 w = texture2D(weightMap, uvw);\n    color += texture2D(detailMap0, uv0) * w.r;\n    color += texture2D(detailMap1, uv1) * w.g;\n    color += texture2D(detailMap2, uv2) * w.b;\n    color += texture2D(detailMap3, uv3) * w.a;\n  #else\n    color = texture2D(detailMap0, uv0);\n  #endif\n  color.rgb *= diffuse;\n  return CCFragOutput(color);\n}\nvoid main() { gl_FragColor = frag(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplers:[]}},defines:[{name:"CC_USE_HDR",type:"boolean"},{name:"LAYERS",type:"number",range:[0,3]}],blocks:[{name:"TexCoords",defines:[],binding:0,members:[{name:"UVScale",type:16,count:1}]}],samplers:[{name:"weightMap",type:28,count:1,defines:[],binding:30},{name:"detailMap0",type:28,count:1,defines:[],binding:31},{name:"detailMap1",type:28,count:1,defines:[],binding:32},{name:"detailMap2",type:28,count:1,defines:[],binding:33},{name:"detailMap3",type:28,count:1,defines:[],binding:34}]}]},{name:"builtin-unlit",_uuid:"a3cd009f-0ab0-420d-9278-b9fdab939bbc",techniques:[{name:"opaque",passes:[{program:"builtin-unlit|unlit-vs:vert|unlit-fs:frag",properties:{mainTexture:{value:"grey",type:28},tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16},colorScale:{value:[1,1,1],type:15,handleInfo:["colorScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["colorScaleAndCutoff",3,13]},color:{type:16,handleInfo:["mainColor",0,16]},colorScaleAndCutoff:{type:16,value:[1,1,1,.5]}}}]}],shaders:[{name:"builtin-unlit|unlit-vs:vert|unlit-fs:frag",hash:1543680674,glsl3:{vert:"\nprecision highp float;\nuniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n};\n#if USE_BATCHING\n  in float a_dyn_batch_id;\n  uniform CCLocalBatched {\n    highp mat4 cc_matWorlds[10];\n  };\n#else\nuniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n};\n#endif\nin vec3 a_position;\n#if USE_SKINNING\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nin vec4 a_weights;\nin vec4 a_joints;\nuniform CCSkinningTexture {\n  highp vec4 cc_jointsTextureInfo;\n};\nuniform CCSkinningAnimation {\n  highp vec4 cc_jointsAnimInfo;\n};\nuniform sampler2D cc_jointsTexture;\n#if USE_SKINNING == 1\n  highp float decode32 (highp vec4 rgba) {\n    rgba = rgba * 255.0;\n    highp float Sign = 1.0 - step(128.0, rgba[3]) * 2.0;\n    highp float Exponent = 2.0 * mod(rgba[3], 128.0) + step(128.0, rgba[2]) - 127.0;\n    highp float Mantissa = mod(rgba[2], 128.0) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n    return Sign * exp2(Exponent - 23.0) * Mantissa;\n  }\n#endif\n#if USE_SKINNING == 1\n  mat4 getJointMatrix (float i) {\n    highp float j = 12.0 * (cc_jointsAnimInfo.x * i + cc_jointsAnimInfo.y) + cc_jointsTextureInfo.z;\n    highp float invSize = cc_jointsTextureInfo.y;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    vec4 v1 = vec4(\n      decode32(texture(cc_jointsTexture, vec2((x + 0.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 1.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 2.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 3.5) * invSize, y)))\n    );\n    vec4 v2 = vec4(\n      decode32(texture(cc_jointsTexture, vec2((x + 4.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 5.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 6.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 7.5) * invSize, y)))\n    );\n    vec4 v3 = vec4(\n      decode32(texture(cc_jointsTexture, vec2((x + 8.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 9.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 10.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 11.5) * invSize, y)))\n    );\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#elif USE_SKINNING == 2\n  mat4 getJointMatrix (float i) {\n    highp float j = 3.0 * (cc_jointsAnimInfo.x * i + cc_jointsAnimInfo.y) + cc_jointsTextureInfo.z;\n    highp float invSize = cc_jointsTextureInfo.y;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    vec4 v1 = texture(cc_jointsTexture, vec2((x + 0.5) * invSize, y));\n    vec4 v2 = texture(cc_jointsTexture, vec2((x + 1.5) * invSize, y));\n    vec4 v3 = texture(cc_jointsTexture, vec2((x + 2.5) * invSize, y));\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  return getJointMatrix(a_joints.x) * a_weights.x\n    + getJointMatrix(a_joints.y) * a_weights.y;\n    + getJointMatrix(a_joints.z) * a_weights.z;\n    + getJointMatrix(a_joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\n#if USE_VERTEX_COLOR\n  in vec4 a_color;\n  out vec4 v_color;\n#endif\n#if USE_TEXTURE\n  in vec2 a_texCoord;\n  out vec2 v_uv;\n  uniform TexCoords {\n    vec4 tilingOffset;\n  };\n#endif\nvec4 vert () {\n  vec4 position;\n  position = vec4(a_position, 1.0);\n  #if USE_SKINNING\n    CCSkin(position);\n  #endif\n  mat4 matWorld;\n  #if USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id + 0.5)];\n  #else\n    matWorld = cc_matWorld;\n  #endif\n  #if USE_TEXTURE\n    v_uv = a_texCoord;\n    #if FLIP_UV\n      v_uv.y = 1.0 - v_uv.y;\n    #endif\n    v_uv = v_uv * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  #if USE_VERTEX_COLOR\n    v_color = a_color;\n  #endif\n  return cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\n  in vec2 v_uv;\n  uniform sampler2D mainTexture;\n#endif\nuniform Constant {\n  vec4 mainColor;\n  vec4 colorScaleAndCutoff;\n};\n#if USE_VERTEX_COLOR\n  in vec4 v_color;\n#endif\nvec4 frag () {\n  vec4 o = mainColor;\n  o.rgb *= colorScaleAndCutoff.xyz;\n  #if USE_VERTEX_COLOR\n    o *= v_color;\n  #endif\n  #if USE_TEXTURE\n    o *= texture(mainTexture, v_uv);\n  #endif\n  #if USE_ALPHA_TEST\n    if (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n  #endif\n  return CCFragOutput(o);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},glsl1:{vert:"\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\n#if USE_BATCHING\n  attribute float a_dyn_batch_id;\n  uniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\n#endif\nattribute vec3 a_position;\n#if USE_SKINNING\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nattribute vec4 a_weights;\nattribute vec4 a_joints;\nuniform highp vec4 cc_jointsTextureInfo;\nuniform highp vec4 cc_jointsAnimInfo;\nuniform sampler2D cc_jointsTexture;\n#if USE_SKINNING == 1\n  highp float decode32 (highp vec4 rgba) {\n    rgba = rgba * 255.0;\n    highp float Sign = 1.0 - step(128.0, rgba[3]) * 2.0;\n    highp float Exponent = 2.0 * mod(rgba[3], 128.0) + step(128.0, rgba[2]) - 127.0;\n    highp float Mantissa = mod(rgba[2], 128.0) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n    return Sign * exp2(Exponent - 23.0) * Mantissa;\n  }\n#endif\n#if USE_SKINNING == 1\n  mat4 getJointMatrix (float i) {\n    highp float j = 12.0 * (cc_jointsAnimInfo.x * i + cc_jointsAnimInfo.y) + cc_jointsTextureInfo.z;\n    highp float invSize = cc_jointsTextureInfo.y;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    vec4 v1 = vec4(\n      decode32(texture2D(cc_jointsTexture, vec2((x + 0.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 1.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 2.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 3.5) * invSize, y)))\n    );\n    vec4 v2 = vec4(\n      decode32(texture2D(cc_jointsTexture, vec2((x + 4.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 5.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 6.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 7.5) * invSize, y)))\n    );\n    vec4 v3 = vec4(\n      decode32(texture2D(cc_jointsTexture, vec2((x + 8.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 9.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 10.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 11.5) * invSize, y)))\n    );\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#elif USE_SKINNING == 2\n  mat4 getJointMatrix (float i) {\n    highp float j = 3.0 * (cc_jointsAnimInfo.x * i + cc_jointsAnimInfo.y) + cc_jointsTextureInfo.z;\n    highp float invSize = cc_jointsTextureInfo.y;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    vec4 v1 = texture2D(cc_jointsTexture, vec2((x + 0.5) * invSize, y));\n    vec4 v2 = texture2D(cc_jointsTexture, vec2((x + 1.5) * invSize, y));\n    vec4 v3 = texture2D(cc_jointsTexture, vec2((x + 2.5) * invSize, y));\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  return getJointMatrix(a_joints.x) * a_weights.x\n    + getJointMatrix(a_joints.y) * a_weights.y;\n    + getJointMatrix(a_joints.z) * a_weights.z;\n    + getJointMatrix(a_joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\n#if USE_VERTEX_COLOR\n  attribute vec4 a_color;\n  varying vec4 v_color;\n#endif\n#if USE_TEXTURE\n  attribute vec2 a_texCoord;\n  varying vec2 v_uv;\n  uniform vec4 tilingOffset;\n#endif\nvec4 vert () {\n  vec4 position;\n  position = vec4(a_position, 1.0);\n  #if USE_SKINNING\n    CCSkin(position);\n  #endif\n  mat4 matWorld;\n  #if USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id + 0.5)];\n  #else\n    matWorld = cc_matWorld;\n  #endif\n  #if USE_TEXTURE\n    v_uv = a_texCoord;\n    #if FLIP_UV\n      v_uv.y = 1.0 - v_uv.y;\n    #endif\n    v_uv = v_uv * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  #if USE_VERTEX_COLOR\n    v_color = a_color;\n  #endif\n  return cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\n  varying vec2 v_uv;\n  uniform sampler2D mainTexture;\n#endif\nuniform vec4 mainColor;\nuniform vec4 colorScaleAndCutoff;\n#if USE_VERTEX_COLOR\n  varying vec4 v_color;\n#endif\nvec4 frag () {\n  vec4 o = mainColor;\n  o.rgb *= colorScaleAndCutoff.xyz;\n  #if USE_VERTEX_COLOR\n    o *= v_color;\n  #endif\n  #if USE_TEXTURE\n    o *= texture2D(mainTexture, v_uv);\n  #endif\n  #if USE_ALPHA_TEST\n    if (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n  #endif\n  return CCFragOutput(o);\n}\nvoid main() { gl_FragColor = frag(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocalBatched",defines:["USE_BATCHING"]},{name:"CCLocal",defines:[]},{name:"CCSkinningTexture",defines:["USE_SKINNING"]},{name:"CCSkinningAnimation",defines:["USE_SKINNING"]}],samplers:[{name:"cc_jointsTexture",defines:["USE_SKINNING"]}]}},defines:[{name:"USE_BATCHING",type:"boolean"},{name:"USE_SKINNING",type:"boolean"},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"FLIP_UV",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r","g","b"]}],blocks:[{name:"TexCoords",defines:["USE_TEXTURE"],binding:0,members:[{name:"tilingOffset",type:16,count:1}]},{name:"Constant",defines:[],binding:1,members:[{name:"mainColor",type:16,count:1},{name:"colorScaleAndCutoff",type:16,count:1}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:["USE_TEXTURE"],binding:30}]}]},{name:"pipeline/planar-shadow",_uuid:"9361fd90-ba52-4f84-aa93-6e878fd576ca",techniques:[{passes:[{phase:"planarShadow",blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"pipeline/planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",depthStencilState:{depthTest:!0,depthWrite:!1,stencilTestFront:!0,stencilFuncFront:5,stencilPassOpFront:2,stencilRefBack:128,stencilRefFront:128,stencilReadMaskBack:128,stencilReadMaskFront:128,stencilWriteMaskBack:128,stencilWriteMaskFront:128}}]}],shaders:[{name:"pipeline/planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",hash:1086841741,glsl3:{vert:"\nprecision highp float;\nuniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n};\n#if USE_BATCHING\n  in float a_dyn_batch_id;\n  uniform CCLocalBatched {\n    highp mat4 cc_matWorlds[10];\n  };\n#else\nuniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n};\n#endif\nuniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  lowp vec4 cc_shadowColor;\n};\nin vec3 a_position;\n#if USE_SKINNING\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nin vec4 a_weights;\nin vec4 a_joints;\nuniform CCSkinningTexture {\n  highp vec4 cc_jointsTextureInfo;\n};\nuniform CCSkinningAnimation {\n  highp vec4 cc_jointsAnimInfo;\n};\nuniform sampler2D cc_jointsTexture;\n#if USE_SKINNING == 1\n  highp float decode32 (highp vec4 rgba) {\n    rgba = rgba * 255.0;\n    highp float Sign = 1.0 - step(128.0, rgba[3]) * 2.0;\n    highp float Exponent = 2.0 * mod(rgba[3], 128.0) + step(128.0, rgba[2]) - 127.0;\n    highp float Mantissa = mod(rgba[2], 128.0) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n    return Sign * exp2(Exponent - 23.0) * Mantissa;\n  }\n#endif\n#if USE_SKINNING == 1\n  mat4 getJointMatrix (float i) {\n    highp float j = 12.0 * (cc_jointsAnimInfo.x * i + cc_jointsAnimInfo.y) + cc_jointsTextureInfo.z;\n    highp float invSize = cc_jointsTextureInfo.y;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    vec4 v1 = vec4(\n      decode32(texture(cc_jointsTexture, vec2((x + 0.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 1.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 2.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 3.5) * invSize, y)))\n    );\n    vec4 v2 = vec4(\n      decode32(texture(cc_jointsTexture, vec2((x + 4.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 5.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 6.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 7.5) * invSize, y)))\n    );\n    vec4 v3 = vec4(\n      decode32(texture(cc_jointsTexture, vec2((x + 8.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 9.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 10.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 11.5) * invSize, y)))\n    );\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#elif USE_SKINNING == 2\n  mat4 getJointMatrix (float i) {\n    highp float j = 3.0 * (cc_jointsAnimInfo.x * i + cc_jointsAnimInfo.y) + cc_jointsTextureInfo.z;\n    highp float invSize = cc_jointsTextureInfo.y;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    vec4 v1 = texture(cc_jointsTexture, vec2((x + 0.5) * invSize, y));\n    vec4 v2 = texture(cc_jointsTexture, vec2((x + 1.5) * invSize, y));\n    vec4 v3 = texture(cc_jointsTexture, vec2((x + 2.5) * invSize, y));\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  return getJointMatrix(a_joints.x) * a_weights.x\n    + getJointMatrix(a_joints.y) * a_weights.y;\n    + getJointMatrix(a_joints.z) * a_weights.z;\n    + getJointMatrix(a_joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nvec4 vert () {\n  vec4 position;\n  position = vec4(a_position, 1.0);\n  #if USE_SKINNING\n    CCSkin(position);\n  #endif\n  mat4 matWorld;\n  #if USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id + 0.5)];\n  #else\n    matWorld = cc_matWorld;\n  #endif\n  position = cc_matProj * (cc_matView * cc_matLightPlaneProj * matWorld) * position;\n  position.z -= 0.0001;\n  return position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  lowp vec4 cc_shadowColor;\n};\nuniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\nvec4 frag () {\n  return CCFragOutput(cc_shadowColor);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},glsl1:{vert:"\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\n#if USE_BATCHING\n  attribute float a_dyn_batch_id;\n  uniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\n#endif\nuniform highp mat4 cc_matLightPlaneProj;\nattribute vec3 a_position;\n#if USE_SKINNING\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nattribute vec4 a_weights;\nattribute vec4 a_joints;\nuniform highp vec4 cc_jointsTextureInfo;\nuniform highp vec4 cc_jointsAnimInfo;\nuniform sampler2D cc_jointsTexture;\n#if USE_SKINNING == 1\n  highp float decode32 (highp vec4 rgba) {\n    rgba = rgba * 255.0;\n    highp float Sign = 1.0 - step(128.0, rgba[3]) * 2.0;\n    highp float Exponent = 2.0 * mod(rgba[3], 128.0) + step(128.0, rgba[2]) - 127.0;\n    highp float Mantissa = mod(rgba[2], 128.0) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n    return Sign * exp2(Exponent - 23.0) * Mantissa;\n  }\n#endif\n#if USE_SKINNING == 1\n  mat4 getJointMatrix (float i) {\n    highp float j = 12.0 * (cc_jointsAnimInfo.x * i + cc_jointsAnimInfo.y) + cc_jointsTextureInfo.z;\n    highp float invSize = cc_jointsTextureInfo.y;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    vec4 v1 = vec4(\n      decode32(texture2D(cc_jointsTexture, vec2((x + 0.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 1.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 2.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 3.5) * invSize, y)))\n    );\n    vec4 v2 = vec4(\n      decode32(texture2D(cc_jointsTexture, vec2((x + 4.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 5.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 6.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 7.5) * invSize, y)))\n    );\n    vec4 v3 = vec4(\n      decode32(texture2D(cc_jointsTexture, vec2((x + 8.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 9.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 10.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 11.5) * invSize, y)))\n    );\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#elif USE_SKINNING == 2\n  mat4 getJointMatrix (float i) {\n    highp float j = 3.0 * (cc_jointsAnimInfo.x * i + cc_jointsAnimInfo.y) + cc_jointsTextureInfo.z;\n    highp float invSize = cc_jointsTextureInfo.y;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    vec4 v1 = texture2D(cc_jointsTexture, vec2((x + 0.5) * invSize, y));\n    vec4 v2 = texture2D(cc_jointsTexture, vec2((x + 1.5) * invSize, y));\n    vec4 v3 = texture2D(cc_jointsTexture, vec2((x + 2.5) * invSize, y));\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  return getJointMatrix(a_joints.x) * a_weights.x\n    + getJointMatrix(a_joints.y) * a_weights.y;\n    + getJointMatrix(a_joints.z) * a_weights.z;\n    + getJointMatrix(a_joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nvec4 vert () {\n  vec4 position;\n  position = vec4(a_position, 1.0);\n  #if USE_SKINNING\n    CCSkin(position);\n  #endif\n  mat4 matWorld;\n  #if USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id + 0.5)];\n  #else\n    matWorld = cc_matWorld;\n  #endif\n  position = cc_matProj * (cc_matView * cc_matLightPlaneProj * matWorld) * position;\n  position.z -= 0.0001;\n  return position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform lowp vec4 cc_shadowColor;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\nvec4 frag () {\n  return CCFragOutput(cc_shadowColor);\n}\nvoid main() { gl_FragColor = frag(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCShadow",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocalBatched",defines:["USE_BATCHING"]},{name:"CCLocal",defines:[]},{name:"CCSkinningTexture",defines:["USE_SKINNING"]},{name:"CCSkinningAnimation",defines:["USE_SKINNING"]}],samplers:[{name:"cc_jointsTexture",defines:["USE_SKINNING"]}]}},defines:[{name:"USE_BATCHING",type:"boolean"},{name:"USE_SKINNING",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"}],blocks:[],samplers:[]}]},{name:"pipeline/skybox",_uuid:"511d2633-09a7-4bdd-ac42-f778032124b3",techniques:[{passes:[{rasterizerState:{cullMode:0},program:"pipeline/skybox|sky-vs:vert|sky-fs:frag",priority:245,depthStencilState:{depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"pipeline/skybox|sky-vs:vert|sky-fs:frag",hash:407071991,glsl3:{vert:"\nprecision highp float;\nuniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n};\nin vec3 a_position;\nout vec4 viewDir;\nvec4 vert () {\n  viewDir = vec4(a_position, 1.0);\n  mat4 matViewRotOnly = mat4(mat3(cc_matView));\n  vec4 pos = matViewRotOnly * viewDir;\n  vec2 f = cc_matProj[3][3] > 0.0 ? vec2(4.8, 2.4) : vec2(cc_matProj[1][1]);\n  pos.xy *= vec2(cc_screenSize.y * cc_screenSize.z, 1.0) * f;\n  pos.zw = vec2(-0.99999 * pos.z, -pos.z);\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n};\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\n  return rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\n  color = min(color, vec3(8.0));\n  const float A = 2.51;\n  const float B = 0.03;\n  const float C = 2.43;\n  const float D = 0.59;\n  const float E = 0.14;\n  return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n  #if !CC_USE_HDR\n    color.rgb = sqrt(ACESToneMap(color.rgb));\n  #endif\n  return color;\n}\nin vec4 viewDir;\nvec4 frag () {\n  #if USE_RGBE_CUBEMAP\n    vec3 c = unpackRGBE(texture(cc_environment, viewDir.xyz));\n  #else\n    vec3 c = SRGBToLinear(texture(cc_environment, viewDir.xyz).rgb) * cc_ambientSky.w;\n  #endif\n  return CCFragOutput(vec4(c, 1.0));\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},glsl1:{vert:"\nprecision highp float;\nuniform mediump vec4 cc_screenSize;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nattribute vec3 a_position;\nvarying vec4 viewDir;\nvec4 vert () {\n  viewDir = vec4(a_position, 1.0);\n  mat4 matViewRotOnly = mat4(mat3(cc_matView));\n  vec4 pos = matViewRotOnly * viewDir;\n  vec2 f = cc_matProj[3][3] > 0.0 ? vec2(4.8, 2.4) : vec2(cc_matProj[1][1]);\n  pos.xy *= vec2(cc_screenSize.y * cc_screenSize.z, 1.0) * f;\n  pos.zw = vec2(-0.99999 * pos.z, -pos.z);\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_ambientSky;\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\n  return rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\n  color = min(color, vec3(8.0));\n  const float A = 2.51;\n  const float B = 0.03;\n  const float C = 2.43;\n  const float D = 0.59;\n  const float E = 0.14;\n  return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n  #if !CC_USE_HDR\n    color.rgb = sqrt(ACESToneMap(color.rgb));\n  #endif\n  return color;\n}\nvarying vec4 viewDir;\nvec4 frag () {\n  #if USE_RGBE_CUBEMAP\n    vec3 c = unpackRGBE(textureCube(cc_environment, viewDir.xyz));\n  #else\n    vec3 c = SRGBToLinear(textureCube(cc_environment, viewDir.xyz).rgb) * cc_ambientSky.w;\n  #endif\n  return CCFragOutput(vec4(c, 1.0));\n}\nvoid main() { gl_FragColor = frag(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[{name:"cc_environment",defines:[]}]},locals:{blocks:[],samplers:[]}},defines:[{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_RGBE_CUBEMAP",type:"boolean"}],blocks:[],samplers:[]}]},{name:"util/profiler",_uuid:"871c3b6c-7379-419d-bda3-794b239ab90d",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"util/profiler|profiler-vs:vert|profiler-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"util/profiler|profiler-vs:vert|profiler-fs:frag",hash:3428623830,glsl3:{vert:"\nprecision mediump float;\nuniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n};\nin vec3 a_position;\nin vec4 a_color;\nout vec2 v_uv;\nuniform Constants {\n  vec4 offset;\n};\nuniform PerFrameInfo {\n  vec4 digits[8 * 9 / 4];\n};\nfloat getComponent(vec4 v, float i) {\n  if (i < 1.0) { return v.x; }\n  else if (i < 2.0) { return v.y; }\n  else if (i < 3.0) { return v.z; }\n  else { return v.w; }\n}\nvec4 vert () {\n  vec4 position;\n  position = vec4(a_position, 1.0);\n  position.x *= cc_screenSize.y * cc_screenSize.z;\n  position.xy += offset.xy + abs(position.xy);\n  v_uv = a_color.xy;\n  if (a_color.z >= 0.0) {\n    float n = getComponent(digits[int(a_color.z)], a_color.w);\n    v_uv += vec2(offset.z * n, 0.0);\n  }\n  return position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\nin vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\n  return CCFragOutput(texture(mainTexture, v_uv));\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},glsl1:{vert:"\nprecision mediump float;\nuniform mediump vec4 cc_screenSize;\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying vec2 v_uv;\nuniform vec4 offset;\nuniform vec4 digits[18];\nfloat getComponent(vec4 v, float i) {\n  if (i < 1.0) { return v.x; }\n  else if (i < 2.0) { return v.y; }\n  else if (i < 3.0) { return v.z; }\n  else { return v.w; }\n}\nvec4 vert () {\n  vec4 position;\n  position = vec4(a_position, 1.0);\n  position.x *= cc_screenSize.y * cc_screenSize.z;\n  position.xy += offset.xy + abs(position.xy);\n  v_uv = a_color.xy;\n  if (a_color.z >= 0.0) {\n    float n = getComponent(digits[int(a_color.z)], a_color.w);\n    v_uv += vec2(offset.z * n, 0.0);\n  }\n  return position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\n  return CCFragOutput(texture2D(mainTexture, v_uv));\n}\nvoid main() { gl_FragColor = frag(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[],samplers:[]}},defines:[{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,members:[{name:"offset",type:16,count:1}]},{name:"PerFrameInfo",defines:[],binding:1,members:[{name:"digits",type:16,count:18}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:[],binding:30}]}]}]),L_=function(){function e(){i(this,e),this._device=null,this._resources={}}return r(e,[{key:"initBuiltinRes",value:function(e){this._device=e;var t=this._resources,i=document.createElement("canvas"),n=i.getContext("2d"),r=new Ju(i),a=i.width=i.height=2;n.fillStyle="#000",n.fillRect(0,0,a,a);var s=new Uc;s._uuid="black-texture",s.image=r,t[s._uuid]=s;var o=new Zc;o._uuid="black-cube-texture",o.setMipFilter(Zc.Filter.LINEAR),o.image={front:new Ju(i),back:new Ju(i),left:new Ju(i),right:new Ju(i),top:new Ju(i),bottom:new Ju(i)},t[o._uuid]=o,n.fillStyle="#777",n.fillRect(0,0,a,a);var l=new Uc;l._uuid="grey-texture",l.image=r,t[l._uuid]=l,n.fillStyle="#fff",n.fillRect(0,0,a,a);var u=new Uc;u._uuid="white-texture",u.image=r,t[u._uuid]=u;var c=new Zc;c._uuid="white-cube-texture",c.setMipFilter(Zc.Filter.LINEAR),c.image={front:new Ju(i),back:new Ju(i),left:new Ju(i),right:new Ju(i),top:new Ju(i),bottom:new Ju(i)},t[c._uuid]=c,n.fillStyle="#7f7fff",n.fillRect(0,0,a,a);var h=new Uc;h._uuid="normal-texture",h.image=r,t[h._uuid]=h,i.width=i.height=16,n.fillStyle="#ddd",n.fillRect(0,0,16,16),n.fillStyle="#555",n.fillRect(0,0,8,8),n.fillStyle="#555",n.fillRect(8,8,8,8);var f=new Uc;f._uuid="default-texture",f.image=r,t[f._uuid]=f;var _=new Zc;_.setMipFilter(Zc.Filter.LINEAR),_._uuid="default-cube-texture",_.image={front:new Ju(i),back:new Ju(i),left:new Ju(i),right:new Ju(i),top:new Ju(i),bottom:new Ju(i)},t[_._uuid]=_;var d=new Yc,p=r._texture;d.texture=p,d._uuid="default-spriteframe",t[d._uuid]=d,M_.forEach((function(e){Object.assign(new cc.EffectAsset,e).onLoaded()}));var m=new cc.Material;m._uuid="standard-material",m.initialize({effectName:"builtin-standard"}),t[m._uuid]=m;var v=new cc.Material;v._uuid="missing-material",v.initialize({effectName:"builtin-unlit",defines:{USE_COLOR:!0}}),v.setProperty("color",cc.color("#ff00ff")),t[v._uuid]=v;var g=new cc.Material;g._uuid="missing-skinning-material";var y=y_(e);g.initialize({effectName:"builtin-unlit",defines:{USE_COLOR:!0,USE_SKINNING:y}}),g.setProperty("color",cc.color("#ff00ff")),t[g._uuid]=g;var b=new cc.Material;b._uuid="missing-effect-material",b.initialize({effectName:"builtin-unlit",defines:{USE_COLOR:!0}}),b.setProperty("color",cc.color("#ffff00")),t[b._uuid]=b;var E=new cc.Material;E._uuid="ui-base-material",E.initialize({defines:{USE_TEXTURE:!1},effectName:"builtin-sprite"}),t[E._uuid]=E;var T=new cc.Material;T._uuid="ui-sprite-material",T.initialize({defines:{USE_TEXTURE:!0,IS_GRAY:!1},effectName:"builtin-sprite"}),t[T._uuid]=T;var S=new cc.Material;S._uuid="ui-sprite-gray-material",S.initialize({defines:{USE_TEXTURE:!0,IS_GRAY:!0},effectName:"builtin-sprite"}),t[S._uuid]=S;var x=new cc.Material;x._uuid="default-particle-material",x.initialize({effectName:"builtin-particle"}),t[x._uuid]=x;var A=new cc.Material;A._uuid="default-trail-material",A.initialize({effectName:"builtin-particle-trail"}),t[A._uuid]=A;var w=new cc.Material;w._uuid="default-billboard-material",w.initialize({effectName:"builtin-billboard"}),t[w._uuid]=w}},{key:"get",value:function(e){return this._resources[e]}}]),e}(),P_=e("builtinResMgr",cc.builtinResMgr=new L_),B_=e("GFXTextureView",function(e){function t(e){var n;return i(this,t),(n=c(this,o(t).call(this,Ys.TEXTURE_VIEW)))._texture=null,n._type=xo.TV2D,n._format=no.UNKNOWN,n._baseLevel=0,n._levelCount=1,n._baseLayer=0,n._layerCount=1,n._device=e,n}return s(t,e),r(t,[{key:"texture",get:function(){return this._texture}},{key:"type",get:function(){return this._type}},{key:"format",get:function(){return this._format}},{key:"baseLevel",get:function(){return this._baseLevel}},{key:"levelCount",get:function(){return this._levelCount}},{key:"baseLayer",get:function(){return this._baseLayer}},{key:"layerCount",get:function(){return this._layerCount}}]),t}(Do)),D_=e("GFXRasterizerState",function(){function e(){i(this,e),this.isDiscard=!1,this.polygonMode=uo.FILL,this.shadeModel=co.GOURAND,this.cullMode=ho.BACK,this.isFrontFaceCCW=!0,this.depthBias=0,this.depthBiasClamp=0,this.depthBiasSlop=0,this.isDepthClip=!0,this.isMultisample=!1,this.lineWidth=1}return r(e,[{key:"compare",value:function(e){return this.isDiscard===e.isDiscard&&this.polygonMode===e.polygonMode&&this.shadeModel===e.shadeModel&&this.cullMode===e.cullMode&&this.isFrontFaceCCW===e.isFrontFaceCCW&&this.depthBias===e.depthBias&&this.depthBiasClamp===e.depthBiasClamp&&this.depthBiasSlop===e.depthBiasSlop&&this.isDepthClip===e.isDepthClip&&this.lineWidth===e.lineWidth&&this.isMultisample===e.isMultisample}}]),e}()),F_=e("GFXDepthStencilState",function(){function e(){i(this,e),this.depthTest=!0,this.depthWrite=!0,this.depthFunc=fo.LESS,this.stencilTestFront=!1,this.stencilFuncFront=fo.ALWAYS,this.stencilReadMaskFront=65535,this.stencilWriteMaskFront=65535,this.stencilFailOpFront=_o.KEEP,this.stencilZFailOpFront=_o.KEEP,this.stencilPassOpFront=_o.KEEP,this.stencilRefFront=1,this.stencilTestBack=!1,this.stencilFuncBack=fo.ALWAYS,this.stencilReadMaskBack=65535,this.stencilWriteMaskBack=65535,this.stencilFailOpBack=_o.KEEP,this.stencilZFailOpBack=_o.KEEP,this.stencilPassOpBack=_o.KEEP,this.stencilRefBack=1}return r(e,[{key:"compare",value:function(e){return this.depthTest===e.depthTest&&this.depthWrite===e.depthWrite&&this.depthFunc===e.depthFunc&&this.stencilTestFront===e.stencilTestFront&&this.stencilFuncFront===e.stencilFuncFront&&this.stencilReadMaskFront===e.stencilReadMaskFront&&this.stencilWriteMaskFront===e.stencilWriteMaskFront&&this.stencilFailOpFront===e.stencilFailOpFront&&this.stencilZFailOpFront===e.stencilZFailOpFront&&this.stencilPassOpFront===e.stencilPassOpFront&&this.stencilRefFront===e.stencilRefFront&&this.stencilTestBack===e.stencilTestBack&&this.stencilFuncBack===e.stencilFuncBack&&this.stencilReadMaskBack===e.stencilReadMaskBack&&this.stencilWriteMaskBack===e.stencilWriteMaskBack&&this.stencilFailOpBack===e.stencilFailOpBack&&this.stencilZFailOpBack===e.stencilZFailOpBack&&this.stencilPassOpBack===e.stencilPassOpBack&&this.stencilRefBack===e.stencilRefBack}}]),e}()),N_=e("GFXBlendTarget",function(){function e(){i(this,e),this.blend=!1,this.blendSrc=mo.ONE,this.blendDst=mo.ZERO,this.blendEq=po.ADD,this.blendSrcAlpha=mo.ONE,this.blendDstAlpha=mo.ZERO,this.blendAlphaEq=po.ADD,this.blendColorMask=vo.ALL}return r(e,[{key:"compare",value:function(e){return this.blend===e.blend&&this.blendSrc===e.blendSrc&&this.blendDst===e.blendDst&&this.blendEq===e.blendEq&&this.blendSrcAlpha===e.blendSrcAlpha&&this.blendDstAlpha===e.blendDstAlpha&&this.blendAlphaEq===e.blendAlphaEq&&this.blendColorMask===e.blendColorMask}}]),e}()),z_=e("GFXBlendState",(function e(){i(this,e),this.isA2C=!1,this.isIndepend=!1,this.blendColor=[0,0,0,0],this.targets=[new N_]})),U_=e("GFXInputState",(function e(){i(this,e),this.attributes=[]})),G_=e("GFXPipelineState",function(e){function t(e){var n;return i(this,t),(n=c(this,o(t).call(this,Ys.PIPELINE_STATE)))._shader=null,n._primitive=lo.TRIANGLE_LIST,n._is=null,n._rs=null,n._dss=null,n._bs=null,n._dynamicStates=[],n._layout=null,n._renderPass=null,n._hash=0,n._device=e,n}return s(t,e),r(t,[{key:"shader",get:function(){return this._shader}},{key:"primitive",get:function(){return this._primitive}},{key:"rasterizerState",get:function(){return this._rs}},{key:"depthStencilState",get:function(){return this._dss}},{key:"blendState",get:function(){return this._bs}},{key:"inputState",get:function(){return this._is}},{key:"dynamicStates",get:function(){return this._dynamicStates}},{key:"pipelineLayout",get:function(){return this._layout}},{key:"renderPass",get:function(){return this._renderPass}},{key:"hash",get:function(){return this._hash}}]),t}(Do)),V_=e("GFX_DRAW_INFO_SIZE",56),H_=e("GFXBuffer",function(e){function t(e){var n;return i(this,t),(n=c(this,o(t).call(this,Ys.BUFFER)))._usage=ro.NONE,n._memUsage=ao.NONE,n._size=0,n._stride=1,n._count=0,n._flags=so.NONE,n._bufferView=null,n._device=e,n}return s(t,e),r(t,[{key:"usage",get:function(){return this._usage}},{key:"memUsage",get:function(){return this._memUsage}},{key:"size",get:function(){return this._size}},{key:"stride",get:function(){return this._stride}},{key:"count",get:function(){return this._count}},{key:"flags",get:function(){return this._flags}},{key:"bufferView",get:function(){return this._bufferView}}]),t}(Do)),W_=e("GFXCommandBuffer",function(e){function t(e){var n;return i(this,t),(n=c(this,o(t).call(this,Ys.COMMAND_BUFFER)))._allocator=null,n._type=Co.PRIMARY,n._numDrawCalls=0,n._numTris=0,n._device=e,n}return s(t,e),r(t,[{key:"type",get:function(){return this._type}},{key:"numDrawCalls",get:function(){return this._numDrawCalls}},{key:"numTris",get:function(){return this._numTris}}]),t}(Do)),j_=e("GFXFramebuffer",function(e){function t(e){var n;return i(this,t),(n=c(this,o(t).call(this,Ys.FRAMEBUFFER)))._renderPass=null,n._colorViews=[],n._depthStencilView=null,n._isOffscreen=!0,n._device=e,n}return s(t,e),r(t,[{key:"renderPass",get:function(){return this._renderPass}},{key:"colorViews",get:function(){return this._colorViews}},{key:"depthStencilView",get:function(){return this._depthStencilView}},{key:"isOffscreen",get:function(){return this._isOffscreen}}]),t}(Do)),X_=cc.sys.isLittleEndian,q_=(a(S_={},Fo.UNORM,"Uint"),a(S_,Fo.SNORM,"Int"),a(S_,Fo.UINT,"Uint"),a(S_,Fo.INT,"Int"),a(S_,Fo.UFLOAT,"Float"),a(S_,Fo.FLOAT,"Float"),a(S_,"default","Uint"),S_);function Y_(e){return(q_[e.type]||q_.default)+e.size/e.count*8}function K_(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:no.R32F,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,a=Go[i];r||(r=a.size);for(var s="set"+Y_(a),o=a.size/a.count,l=Math.floor(t.length/a.count),u=0;u<l;++u)for(var c=n+r*u,h=0;h<a.count;++h){var f=c+o*h;e[s](f,t[a.count*u+h],X_)}}function Z_(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:no.R32F,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:e.byteLength-i,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:[],s=Go[t];r||(r=s.size);for(var o="get"+Y_(s),l=s.size/s.count,u=Math.floor(n/r),c=0;c<u;++c)for(var h=i+r*c,f=0;f<s.count;++f){var _=h+l*f;a[s.count*c+f]=e[o](_,X_)}return a}function Q_(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:no.R32F,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:e.byteLength-n,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,s=arguments.length>6?arguments[6]:void 0;s||(s=new DataView(new ArrayBuffer(e.byteLength)));var o=Go[i];a||(a=o.size);for(var l="set"+Y_(o),u="get"+Y_(o),c=o.size/o.count,h=Math.floor(r/a),f=0;f<h;++f)for(var _=n+a*f,d=0;d<o.count;++d){var p=_+c*d,m=e[u](p,X_);s[l](p,t(m,d,e),X_)}return s}var J_=e("GFXInputAssembler",function(e){function t(e){var n;return i(this,t),(n=c(this,o(t).call(this,Ys.INPUT_ASSEMBLER)))._attributes=[],n._vertexBuffers=[],n._indexBuffer=null,n._vertexCount=0,n._firstVertex=0,n._indexCount=0,n._firstIndex=0,n._vertexOffset=0,n._instanceCount=0,n._firstInstance=0,n._isIndirect=!1,n._indirectBuffer=null,n._device=e,n}return s(t,e),r(t,[{key:"vertexBuffers",get:function(){return this._vertexBuffers}},{key:"indexBuffer",get:function(){return this._indexBuffer}},{key:"attributes",get:function(){return this._attributes}},{key:"vertexCount",get:function(){return this._vertexCount},set:function(e){this._vertexCount=e}},{key:"firstVertex",get:function(){return this._firstVertex},set:function(e){this._firstVertex=e}},{key:"indexCount",get:function(){return this._indexCount},set:function(e){this._indexCount=e}},{key:"firstIndex",get:function(){return this._firstIndex},set:function(e){this._firstIndex=e}},{key:"vertexOffset",get:function(){return this._vertexOffset},set:function(e){this._vertexOffset=e}},{key:"instanceCount",get:function(){return this._instanceCount},set:function(e){this._instanceCount=e}},{key:"firstInstance",get:function(){return this._firstInstance},set:function(e){this._firstInstance=e}},{key:"isIndirect",get:function(){return this._isIndirect}},{key:"indirectBuffer",get:function(){return this._indirectBuffer}}]),r(t,[{key:"getVertexBuffer",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return e<this._vertexBuffers.length?this._vertexBuffers[e]:null}},{key:"extractDrawInfo",value:function(e){e.vertexCount=this._vertexCount,e.firstVertex=this._firstVertex,e.indexCount=this._indexCount,e.firstIndex=this._firstIndex,e.vertexOffset=this._vertexOffset,e.instanceCount=this._instanceCount,e.firstInstance=this._firstInstance}},{key:"updateVertexAttr",value:function(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,r=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],a=0,s=no.UNKNOWN,o=this._attributes,l=Array.isArray(o),u=0;for(o=l?o:o[Symbol.iterator]();;){var c;if(l){if(u>=o.length)break;c=o[u++]}else{if((u=o.next()).done)break;c=u.value}var h=c;if(h.name===t){s=h.format;break}a+=Go[h.format].size}var f=this._vertexBuffers[n];s&&f&&(K_(new DataView(e),i,s,a,f.stride),r&&f.update(e,0,f.stride*f.count))}},{key:"updateIndexBuffer",value:function(e,t){var i=this._indexCount,n=this._indexBuffer;i&&n&&(K_(new DataView(e),t,no["R".concat(8*n.stride,"UI")]),n.update(e,0,n.stride*n.count),this._indexCount=t.length)}}]),t}(Do)),$_=e("GFXPipelineLayout",function(e){function t(e){var n;return i(this,t),(n=c(this,o(t).call(this,Ys.PIPELINE_LAYOUT)))._pushConstantsRanges=[],n._layouts=[],n._device=e,n}return s(t,e),r(t,[{key:"layouts",get:function(){return this._layouts}}]),t}(Do)),ed=e("GFXQueue",function(e){function t(e){var n;return i(this,t),(n=c(this,o(t).call(this,Ys.QUEUE)))._type=Po.GRAPHICS,n._device=e,n}return s(t,e),r(t,[{key:"type",get:function(){return this._type}}]),t}(Do)),td=(e("GFXColorAttachment",(function e(){i(this,e),this.format=no.UNKNOWN,this.loadOp=Ro.CLEAR,this.storeOp=ko.STORE,this.sampleCount=1,this.beginLayout=Oo.COLOR_ATTACHMENT_OPTIMAL,this.endLayout=Oo.COLOR_ATTACHMENT_OPTIMAL})),e("GFXDepthStencilAttachment",(function e(){i(this,e),this.format=no.UNKNOWN,this.depthLoadOp=Ro.CLEAR,this.depthStoreOp=ko.STORE,this.stencilLoadOp=Ro.CLEAR,this.stencilStoreOp=ko.STORE,this.sampleCount=1,this.beginLayout=Oo.DEPTH_STENCIL_ATTACHMENT_OPTIMAL,this.endLayout=Oo.DEPTH_STENCIL_ATTACHMENT_OPTIMAL})),e("GFXRenderPass",function(e){function t(e){var n;return i(this,t),(n=c(this,o(t).call(this,Ys.RENDER_PASS)))._colorInfos=[],n._depthStencilInfo=null,n._device=e,n}return s(t,e),t}(Do))),id=e("GFXSamplerState",function(){function e(){i(this,e),this.name="",this.minFilter=go.LINEAR,this.magFilter=go.LINEAR,this.mipFilter=go.NONE,this.addressU=yo.WRAP,this.addressV=yo.WRAP,this.addressW=yo.WRAP,this.maxAnisotropy=16,this.cmpFunc=fo.NEVER,this.borderColor={r:0,g:0,b:0,a:0},this.minLOD=0,this.maxLOD=0,this.mipLODBias=0}return r(e,[{key:"compare",value:function(e){return this.minFilter===e.minFilter&&this.magFilter===e.magFilter&&this.mipFilter===e.mipFilter&&this.addressU===e.addressU&&this.addressV===e.addressV&&this.addressW===e.addressW&&this.maxAnisotropy===e.maxAnisotropy&&this.cmpFunc===e.cmpFunc&&this.borderColor.r===e.borderColor.r&&this.borderColor.g===e.borderColor.g&&this.borderColor.b===e.borderColor.b&&this.borderColor.a===e.borderColor.a&&this.minLOD===e.minLOD&&this.maxLOD===e.maxLOD&&this.mipLODBias===e.mipLODBias}}]),e}()),nd=e("GFXSampler",function(e){function t(e){var n;return i(this,t),(n=c(this,o(t).call(this,Ys.SAMPLER)))._state=new id,n._device=e,n}return s(t,e),r(t,[{key:"state",get:function(){return this._state}}]),t}(Do)),rd=(e("GFXUniform",(function e(){i(this,e),this.name="",this.type=io.UNKNOWN,this.count=1})),e("GFXUniformBlock",(function e(){i(this,e),this.binding=-1,this.name="",this.members=[]})),e("GFXUniformSampler",(function e(){i(this,e),this.binding=-1,this.name="",this.type=io.UNKNOWN,this.count=1})),e("GFXShader",function(e){function t(e){var n;return i(this,t),(n=c(this,o(t).call(this,Ys.SHADER)))._name="",n._stages=[],n._blocks=[],n._samplers=[],n._device=e,n._id=e.genShaderId(),n}return s(t,e),r(t,[{key:"id",get:function(){return this._id}},{key:"name",get:function(){return this._name}}]),t}(Do))),ad=e("GFXTexture",function(e){function t(e){var n;return i(this,t),(n=c(this,o(t).call(this,Ys.TEXTURE)))._type=bo.TEX2D,n._usage=Eo.NONE,n._format=no.UNKNOWN,n._width=0,n._height=0,n._depth=1,n._arrayLayer=1,n._mipLevel=1,n._samples=To.X1,n._flags=So.NONE,n._isPowerOf2=!1,n._size=0,n._buffer=null,n._device=e,n}return s(t,e),r(t,[{key:"type",get:function(){return this._type}},{key:"usage",get:function(){return this._usage}},{key:"format",get:function(){return this._format}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"depth",get:function(){return this._depth}},{key:"arrayLayer",get:function(){return this._arrayLayer}},{key:"mipLevel",get:function(){return this._mipLevel}},{key:"samples",get:function(){return this._samples}},{key:"flags",get:function(){return this._flags}},{key:"size",get:function(){return this._size}},{key:"buffer",get:function(){return this._buffer}}]),t}(Do)),sd=(e("GFXBindingUnit",(function e(){i(this,e),this.binding=0,this.type=wo.UNKNOWN,this.name="",this.buffer=null,this.texView=null,this.sampler=null})),e("GFXBindingLayout",function(e){function t(e){var n;return i(this,t),(n=c(this,o(t).call(this,Ys.BINDING_LAYOUT)))._bindingUnits=[],n._isDirty=!1,n._device=e,n}return s(t,e),r(t,[{key:"bindBuffer",value:function(e,t){var i=this._bindingUnits,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;if(s.binding===e)return void(s.type===wo.UNIFORM_BUFFER?s.buffer!==t&&(s.buffer=t,this._isDirty=!0):console.error("Setting binding is not GFXBindingType.UNIFORM_BUFFER."))}}},{key:"bindSampler",value:function(e,t){var i=this._bindingUnits,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;if(s.binding===e)return void(s.type===wo.SAMPLER?s.sampler!==t&&(s.sampler=t,this._isDirty=!0):console.error("Setting binding is not GFXBindingType.SAMPLER."))}}},{key:"bindTextureView",value:function(e,t){var i=this._bindingUnits,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;if(s.binding===e)return void(s.type===wo.SAMPLER?s.texView!==t&&(s.texView=t,this._isDirty=!0):console.error("Setting binding is not GFXBindingType.SAMPLER."))}}},{key:"getBindingUnit",value:function(e){var t=this._bindingUnits,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r;if(a.binding===e)return a}return null}}]),t}(Do))),od=e("GFXCommandAllocator",function(e){function t(e){var n;return i(this,t),(n=c(this,o(t).call(this,Ys.COMMAND_ALLOCATOR)))._device=e,n}return s(t,e),t}(Do)),ld=e("GFXWindow",function(e){function t(e){var n;return i(this,t),(n=c(this,o(t).call(this,Ys.WINDOW)))._title="",n._left=0,n._top=0,n._width=0,n._height=0,n._nativeWidth=0,n._nativeHeight=0,n._colorFmt=no.UNKNOWN,n._depthStencilFmt=no.UNKNOWN,n._isOffscreen=!1,n._renderPass=null,n._colorTex=null,n._colorTexView=null,n._depthStencilTex=null,n._depthStencilTexView=null,n._framebuffer=null,n._device=e,n}return s(t,e),r(t,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"colorFormat",get:function(){return this._colorFmt}},{key:"detphStencilFormat",get:function(){return this._depthStencilFmt}},{key:"isOffscreen",get:function(){return this._isOffscreen}},{key:"renderPass",get:function(){return this._renderPass}},{key:"colorTexView",get:function(){return this._colorTexView}},{key:"depthStencilTexView",get:function(){return this._depthStencilTexView}},{key:"framebuffer",get:function(){return this._framebuffer}}]),t}(Do));cc.GFXDevice=Ko,cc.GFXBuffer=H_,cc.GFXTexture=ad,cc.GFXTextureView=B_,cc.GFXSampler=nd,cc.GFXShader=rd,cc.GFXInputAssembler=J_,cc.GFXRenderPass=td,cc.GFXFramebuffer=j_,cc.GFXPipelineLayout=$_,cc.GFXPipelineState=G_,cc.GFXCommandBuffer=W_,cc.GFXQueue=ed,Object.assign(cc,Yo);var ud,cd,hd,fd,_d,dd=new xu,pd=function(){function e(t){i(this,e),this.batches=[],this.pass=t}return r(e,[{key:"destroy",value:function(){for(var e=0;e<this.batches.length;++e){for(var t=this.batches[e],i=0;i<t.vbs.length;++i)t.vbs[i].destroy();t.vbIdx.destroy(),t.ia.destroy(),t.ubo.destroy()}this.batches.splice(0)}},{key:"merge",value:function(e,t,i){var n=e.subMeshData.flatBuffers;if(0!==n.length){for(var r=0,a=0,s=n[0].count,o=i.pipelineLayout.layouts[0],l=!1,u=0;u<this.batches.length;++u){var c=this.batches[u];if(c.vbs.length===n.length&&c.mergeCount<xu.BATCHING_COUNT){l=!0;for(var h=0;h<c.vbs.length;++h){if(c.vbs[h].stride!==n[h].stride){l=!1;break}}if(l){for(var f=0;f<c.vbs.length;++f){var _=n[f],d=c.vbs[f],p=c.vbDatas[f];(r=(s+c.vbCount)*_.stride)>d.size&&(d.resize(r),p=c.vbDatas[f]=new Uint8Array(d.bufferView.buffer)),p.set(_.buffer,c.vbCount*_.stride)}(a=4*(s+c.vbCount))>c.vbIdx.size&&(c.vbIdx.resize(a),c.vbIdxData=new Float32Array(c.vbIdx.bufferView.buffer));var m=c.vbCount,v=m+s,g=c.vbIdxData,y=c.mergeCount;if(g[m]!==y||g[v-1]!==y)for(var b=m;b<v;b++)g[b]=y;return Bn.toArray(c.uboData.view,t.model.transform.worldMatrix,xu.MAT_WORLDS_OFFSET+16*c.mergeCount),c.mergeCount||c.pso===i||(o.bindBuffer(xu.BLOCK.binding,c.ubo),o.update(),c.pso=i),++c.mergeCount,c.vbCount+=s,void(c.ia.vertexCount+=s)}}}for(var E=this.pass.device,T=[],S=[],x=[],A=0;A<n.length;++A){var w=n[A],C=E.createBuffer({usage:ro.VERTEX|ro.TRANSFER_DST,memUsage:ao.HOST|ao.DEVICE,size:w.count*w.stride,stride:w.stride,flags:so.BAKUP_BUFFER});C.update(w.buffer.buffer),T.push(C),S.push(new Uint8Array(C.bufferView.buffer)),x.push(C)}var R=E.createBuffer({usage:ro.VERTEX|ro.TRANSFER_DST,memUsage:ao.HOST|ao.DEVICE,size:4*s,stride:4,flags:so.BAKUP_BUFFER}),k=new Float32Array(s);k.fill(0),R.update(k),x.push(R);for(var O=new Float32Array(R.bufferView.buffer),I=e.inputAssembler.attributes,M=new Array(I.length+1),L=0;L<I.length;++L)M[L]=I[L];M[I.length]={name:"a_dyn_batch_id",format:no.R32F,stream:n.length};var P=E.createInputAssembler({attributes:M,vertexBuffers:x}),B=this.pass.device.createBuffer({usage:ro.UNIFORM|ro.TRANSFER_DST,memUsage:ao.HOST|ao.DEVICE,size:xu.SIZE});o.bindBuffer(xu.BLOCK.binding,B),o.update();var D=new xu;Bn.toArray(D.view,t.model.transform.worldMatrix,xu.MAT_WORLDS_OFFSET),this.batches.push({mergeCount:1,vbs:T,vbDatas:S,vbIdx:R,vbIdxData:O,vbCount:s,ia:P,ubo:B,uboData:D,pso:i})}}},{key:"clear",value:function(){for(var e=0;e<this.batches.length;++e){var t=this.batches[e];t.vbCount=0,t.mergeCount=0,t.ia.vertexCount=0}}},{key:"clearUBO",value:function(){for(var e=0;e<this.batches.length;++e){this.batches[e].ubo.update(dd.view.buffer)}}}]),e}(),md=(ud=new Map,cd=0,function(e){return"number"==typeof e?e:(ud.has(e)||(ud.set(e,1<<cd),cd++),ud.get(e))}),vd=function(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;return e<<28&4026531840|i<<22&264241152|t<<14&4177920|16383&n},gd=function(e){return(4026531840&e)>>>28},yd=function(e){return(264241152&e)>>>22},bd=function(e){return(4177920&e)>>>14},Ed=function(e){return 16383&e},Td=function(e,t){return-264241153&e|t<<22&264241152},Sd=(a(hd={},io.UNKNOWN,(function(e,t){return console.warn("illegal uniform handle")})),a(hd,io.INT,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e[i]})),a(hd,io.INT2,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return Mi.fromArray(t,e,i)})),a(hd,io.INT3,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return zi.fromArray(t,e,i)})),a(hd,io.INT4,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return qi.fromArray(t,e,i)})),a(hd,io.FLOAT,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e[i]})),a(hd,io.FLOAT2,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return Mi.fromArray(t,e,i)})),a(hd,io.FLOAT3,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return zi.fromArray(t,e,i)})),a(hd,io.FLOAT4,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return qi.fromArray(t,e,i)})),a(hd,io.MAT3,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return an.fromArray(t,e,i)})),a(hd,io.MAT4,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return Bn.fromArray(t,e,i)})),hd),xd=(a(fd={},io.UNKNOWN,(function(e,t){return console.warn("illegal uniform handle")})),a(fd,io.INT,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e[i]=t})),a(fd,io.INT2,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return Mi.toArray(e,t,i)})),a(fd,io.INT3,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return zi.toArray(e,t,i)})),a(fd,io.INT4,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return qi.toArray(e,t,i)})),a(fd,io.FLOAT,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e[i]=t})),a(fd,io.FLOAT2,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return Mi.toArray(e,t,i)})),a(fd,io.FLOAT3,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return zi.toArray(e,t,i)})),a(fd,io.FLOAT4,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return qi.toArray(e,t,i)})),a(fd,io.MAT3,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return an.toArray(e,t,i)})),a(fd,io.MAT4,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return Bn.toArray(e,t,i)})),fd),Ad=(a(_d={},io.INT,[0]),a(_d,io.INT2,[0,0]),a(_d,io.INT3,[0,0,0]),a(_d,io.INT4,[0,0,0,0]),a(_d,io.FLOAT,[0]),a(_d,io.FLOAT2,[0,0]),a(_d,io.FLOAT3,[0,0,0]),a(_d,io.FLOAT4,[0,0,0,0]),a(_d,io.MAT3,[1,0,0,0,1,0,0,0,1]),a(_d,io.MAT4,[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),a(_d,io.SAMPLER2D,"default-texture"),a(_d,io.SAMPLER_CUBE,"default-cube-texture"),_d);function wd(e,t){for(var i=Object.entries(t),n=!1,r=0;r<i.length;r++)e[i[r][0]]!==i[r][1]&&(e[i[r][0]]=i[r][1],n=!0);return n}function Cd(e){return Math.ceil(Math.log2(Math.max(e,2)))}function Rd(e,t){switch(e.type){case"boolean":return("number"==typeof t?t:t?1:0)+"";case"string":return void 0!==t?t:e.options[0];case"number":return(void 0!==t?t:e.range[0])+""}return console.warn("unknown define type '".concat(e.type,"'")),"-1"}function kd(e,t){return e+t.reduce((function(e,t){return t.isDefault?e:"".concat(e,"|").concat(t.name).concat(t.value)}),"")}function Od(e,t,i){var n=e.builtins[i],r=e.blocks,a=n.blocks,s=Array.isArray(a),o=0;for(a=s?a:a[Symbol.iterator]();;){var l;if(s){if(o>=a.length)break;l=a[o++]}else{if((o=a.next()).done)break;l=o.value}var u=l,c=t.get(u.name);if(c&&c.type===wo.UNIFORM_BUFFER){var h=Object.assign({defines:u.defines,size:Id(c.blockInfo),bindingType:wo.UNIFORM_BUFFER},c.blockInfo);r.push(h)}else console.warn("builtin UBO '".concat(u.name,"' not available!"))}var f=e.samplers,_=n.samplers,d=Array.isArray(_),p=0;for(_=d?_:_[Symbol.iterator]();;){var m;if(d){if(p>=_.length)break;m=_[p++]}else{if((p=_.next()).done)break;m=p.value}var v=m,g=t.get(v.name);if(g&&g.type===wo.SAMPLER){var y=Object.assign({defines:v.defines,bindingType:wo.SAMPLER},g.samplerInfo);f.push(y)}else console.warn("builtin sampler '".concat(v.name,"' not available!"))}}function Id(e){return e.members.reduce((function(e,t){return e+jo(t.type)*t.count}),0)}function Md(e,t){for(var i=0;i<e.length;i++)if(!t[e[i]])return!1;return!0}var Ld=new(function(){function e(){i(this,e),this._templates={},this._cache={}}return r(e,[{key:"define",value:function(e){var t=this._templates[e.name];if(!t||t.hash!==e.hash){var i=e,n=0,r=function(){if(s){if(o>=a.length)return"break";l=a[o++]}else{if((o=a.next()).done)return"break";l=o.value}var e=l,t=1;if("number"===e.type){var i=e.range;t=Cd(i[1]-i[0]+1),e._map=function(e){return e-i[0]}}else"string"===e.type?(t=Cd(e.options.length),e._map=function(t){return Math.max(0,e.options.findIndex((function(e){return e===t})))}):"boolean"===e.type&&(e._map=function(e){return e?1:0});e._offset=n,n+=t},a=i.defines,s=Array.isArray(a),o=0;for(a=s?a:a[Symbol.iterator]();;){var l;if("break"===r())break}n>31&&(i.uber=!0),i.blocks.forEach((function(e){return e.size=Id(e),e.bindingType=wo.UNIFORM_BUFFER})),i.samplers.forEach((function(e){return e.bindingType=wo.SAMPLER})),i.handleMap=function(e){for(var t={},i=0;i<e.blocks.length;i++)for(var n=e.blocks[i],r=n.members,a=0,s=0;s<r.length;s++){var o=r[s];t[o.name]=vd(wo.UNIFORM_BUFFER,n.binding,o.type,a),a+=(jo(o.type)>>2)*o.count}for(var l=0;l<e.samplers.length;l++){var u=e.samplers[l];t[u.name]=vd(wo.SAMPLER,u.binding,u.type)}return t}(i),i.localsInited||(Od(i,Tu,"locals"),i.localsInited=!0),this._templates[e.name]=i}}},{key:"getTemplate",value:function(e){return this._templates[e]}},{key:"hasProgram",value:function(e){return void 0!==this._templates[e]}},{key:"getKey",value:function(e,t){var i=this._templates[e],n=i.defines;if(i.uber){for(var r="",a=0;a<n.length;a++){var s=n[a],o=t[s.name];if(void 0!==o&&s._map){var l=s._map(o);r+=s._offset+(l+"|")}}return r+i.hash}for(var u=0,c=0;c<n.length;c++){var h=n[c],f=t[h.name];if(void 0!==f&&h._map)u|=h._map(f)<<h._offset}return"".concat(u.toString(16),"|").concat(i.hash)}},{key:"destroyShaderByDefines",value:function(e){var t=this,i=Object.keys(e);if(i.length){var n=i.map((function(t){var i=e[t];return"boolean"==typeof i&&(i=i?"1":"0"),new RegExp(t+i)})),r=Object.keys(this._cache).filter((function(e){return n.every((function(i){return i.test(t._cache[e].shader.name)}))})),a=Array.isArray(r),s=0;for(r=a?r:r[Symbol.iterator]();;){var o;if(a){if(s>=r.length)break;o=r[s++]}else{if((s=r.next()).done)break;o=s.value}var l=o,u=this._cache[l].shader;console.log("destroyed shader ".concat(u.name)),u.destroy(),delete this._cache[l]}}}},{key:"getGFXShader",value:function(e,t,i,n){Object.assign(i,n.macros),i.USE_SKINNING&&(i.USE_SKINNING=y_(e));var r=this.getKey(t,i),a=this._cache[r];if(a)return a;var s=this._templates[t];s.globalsInited||(Od(s,n.globalBindings,"globals"),s.globalsInited=!0);var o=function(e,t){var i=[],n=t,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s,l=o.name,u=e[l],c=Rd(o,u),h=!u||"0"===u;i.push({name:l,value:c,isDefault:h})}return i}(i,s.defines),l=o.reduce((function(e,t){return"".concat(e,"#define ").concat(t.name," ").concat(t.value,"\n")}),"")+"\n",u=s.glsl3;switch(e.gfxAPI){case Xo.WEBGL2:u=s.glsl3;break;default:u=s.glsl1}var c=[],h=[],f=[];!function(e,t,i,n,r){for(var a=e.blocks,s=e.samplers,o=-1,l=0;l<a.length;l++){var u=a[l];u.binding!==o&&Md(u.defines,t)&&(o=u.binding,i.push(u),r.push(u))}for(var c=0;c<s.length;c++){var h=s[c];h.binding!==o&&Md(h.defines,t)&&(o=h.binding,n.push(h),r.push(h))}}(s,i,c,h,f);var _=e.createShader({name:kd(t,o),blocks:c,samplers:h,stages:[{type:Ao.VERTEX,source:l+u.vert},{type:Ao.FRAGMENT,source:l+u.frag}]});return this._cache[r]={shader:_,bindings:f}}}]),e}());cc.programLib=Ld;var Pd,Bd,Dd,Fd,Nd,zd,Ud,Gd={memUsage:ao.HOST|ao.DEVICE,size:0,usage:ro.UNIFORM|ro.TRANSFER_DST},Vd={bindings:null},Hd={layouts:null},Wd={primitive:0,shader:null,inputState:new U_,rasterizerState:null,depthStencilState:null,blendState:null,dynamicStates:null,layout:null,renderPass:null,hash:0,program:"",defines:null,stage:0},jd=function(){function e(t){i(this,e),this._buffers={},this._samplers={},this._textureViews={},this._resources=[],this._phase=md("default"),this._idxInTech=0,this._programName="",this._priority=mu.DEFAULT,this._primitive=lo.TRIANGLE_LIST,this._stage=pu.DEFAULT,this._bindings=[],this._bs=new z_,this._dss=new F_,this._rs=new D_,this._dynamicStates=[],this._dynamics={},this._customizations=[],this._handleMap={},this._blocks=[],this._shaderInfo=null,this._defines={},this._properties={},this._hash=0,this._renderPass=null,this._shader=null,this._batchedBuffer=null,this._device=t}return r(e,null,[{key:"fillinPipelineInfo",value:function(e,t){void 0!==t.priority&&(e._priority=t.priority),void 0!==t.primitive&&(e._primitive=t.primitive),void 0!==t.stage&&(e._stage=t.stage),void 0!==t.dynamicStates&&(e._dynamicStates=t.dynamicStates),t.customizations&&(e._customizations=t.customizations),t.phase&&(e._phase=md(t.phase));var i=e._bs;if(t.blendState){var n=Object.assign({},t.blendState);n.targets&&n.targets.forEach((function(e,t){return Object.assign(i.targets[t]||(i.targets[t]=new N_),e)})),delete n.targets,Object.assign(i,n)}Object.assign(e._rs,t.rasterizerState),Object.assign(e._dss,t.depthStencilState)}},{key:"getPSOHash",value:function(e){var t,i=Ld.getKey(e.program,e.defines),n="".concat(i,",").concat(e.stage,",").concat(e.primitive);return n+=function(e){var t=",bs,".concat(e.isA2C,",").concat(e.blendColor),i=e.targets,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;t+=",bt,".concat(s.blend,",").concat(s.blendEq,",").concat(s.blendAlphaEq,",").concat(s.blendColorMask),t+=",".concat(s.blendSrc,",").concat(s.blendDst,",").concat(s.blendSrcAlpha,",").concat(s.blendDstAlpha)}return t}(e.blendState),n+=function(e){var t=",dss,".concat(e.depthTest,",").concat(e.depthWrite,",").concat(e.depthFunc);return t+=",".concat(e.stencilTestFront,",").concat(e.stencilFuncFront,",").concat(e.stencilRefFront,",").concat(e.stencilReadMaskFront),t+=",".concat(e.stencilFailOpFront,",").concat(e.stencilZFailOpFront,",").concat(e.stencilPassOpFront,",").concat(e.stencilWriteMaskFront),t+=",".concat(e.stencilTestBack,",").concat(e.stencilFuncBack,",").concat(e.stencilRefBack,",").concat(e.stencilReadMaskBack),t+=",".concat(e.stencilFailOpBack,",").concat(e.stencilZFailOpBack,",").concat(e.stencilPassOpBack,",").concat(e.stencilWriteMaskBack)}(e.depthStencilState),Jo(n+=(t=e.rasterizerState,",rs,".concat(t.cullMode,",").concat(t.depthBias,",").concat(t.isFrontFaceCCW)),666)}}]),r(e,[{key:"initialize",value:function(e){this._doInit(e),this.resetUBOs(),this.resetTextures()}},{key:"getHandle",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:io.UNKNOWN,n=this._handleMap[e];if(n)return i?n=Td(n,i):t&&(n=Td(n,yd(n)-t)),n+t}},{key:"getBinding",value:function(t){var i=this.getHandle(t);if(void 0!==i)return e.getBindingFromHandle(i)}},{key:"setUniform",value:function(t,i){var n=e.getBindingFromHandle(t),r=e.getTypeFromHandle(t),a=e.getOffsetFromHandle(t),s=this._blocks[n];xd[r](s.view,i,a),s.dirty=!0}},{key:"getUniform",value:function(t,i){var n=e.getBindingFromHandle(t),r=e.getTypeFromHandle(t),a=e.getOffsetFromHandle(t),s=this._blocks[n];return Sd[r](s.view,i,a)}},{key:"setUniformArray",value:function(t,i){for(var n=e.getBindingFromHandle(t),r=e.getTypeFromHandle(t),a=jo(r)>>2,s=this._blocks[n],o=e.getOffsetFromHandle(t),l=0;l<i.length;l++,o+=a)null!==i[l]&&xd[r](s.view,i[l],o);s.dirty=!0}},{key:"bindBuffer",value:function(e,t){if(this._buffers[e]!==t){this._buffers[e]=t;for(var i=this._resources.length,n=0;n<i;n++){this._resources[n].bindingLayout.bindBuffer(e,t)}}}},{key:"bindTextureView",value:function(e,t){if(this._textureViews[e]!==t){this._textureViews[e]=t;for(var i=this._resources.length,n=0;n<i;n++){this._resources[n].bindingLayout.bindTextureView(e,t)}}}},{key:"bindSampler",value:function(e,t){if(this._samplers[e]!==t){this._samplers[e]=t;for(var i=this._resources.length,n=0;n<i;n++){this._resources[n].bindingLayout.bindSampler(e,t)}}}},{key:"setDynamicState",value:function(e,t){var i=this._dynamics[e];i&&i.value===t||(i.value=t,i.dirty=!0)}},{key:"overridePipelineStates",value:function(e,t){console.warn("base pass cannot override states, please use pass instance instead.")}},{key:"update",value:function(){for(var e=this._blocks.length,t=0;t<e;t++){var i=this._blocks[t];i.dirty&&(this._buffers[t].update(i.buffer),i.dirty=!1)}for(var n=cc.director.root.pipeline.globalBindings,r=this._shaderInfo.builtins.globals,a=r.samplers.length,s=0;s<a;s++){var o=r.samplers[s],l=n.get(o.name);l.sampler&&this.bindSampler(l.samplerInfo.binding,l.sampler),this.bindTextureView(l.samplerInfo.binding,l.textureView)}}},{key:"destroy",value:function(){var e=this._shaderInfo.blocks,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n;gu(r.binding)||this._buffers[r.binding].destroy()}this._buffers={},this._samplers={},this._textureViews={},this._batchedBuffer&&(this._batchedBuffer.destroy(),this._batchedBuffer=null)}},{key:"resetUBOs",value:function(){var e=this._shaderInfo.blocks,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n;if(!gu(r.binding)){for(var a=this._blocks[r.binding],s=0,o=0;o<r.members.length;o++){for(var l=r.members[o],u=this._properties[l.name],c=u&&u.value,h=c||Ad[l.type],f=jo(l.type)>>2,_=0;_<l.count;_++)a.view.set(h,s+_*f);s+=f*l.count}a.dirty=!0}}}},{key:"resetTextures",value:function(){var e=this._shaderInfo.samplers,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n;if(!gu(r.binding)){var a=this._properties[r.name],s=a&&a.value?a.value+"-texture":Ad[r.type],o=P_.get(s),l=o&&o.getGFXTextureView();if(l){this._textureViews[r.binding]=l;for(var u=a&&void 0!==a.samplerHash?a.samplerHash:o.getSamplerHash(),c=this._samplers[r.binding]=yc.getSampler(this._device,u),h=0;h<this._resources.length;h++){var f=this._resources[h];f.bindingLayout.bindSampler(r.binding,c),f.bindingLayout.bindTextureView(r.binding,l)}}else console.warn("illegal texture default value: "+s)}}}},{key:"tryCompile",value:function(){this._defines.USE_BATCHING&&this.createBatchedBuffer();var e=cc.director.root.pipeline;if(!e)return null;if(this._renderPass=e.getRenderPass(this._stage),!this._renderPass)return console.warn("illegal pass stage."),!1;var t=Ld.getGFXShader(this._device,this._programName,this._defines,e);return t.shader?(this._shader=t.shader,this._bindings=t.bindings,!0):(console.warn("create shader ".concat(this._programName," failed")),!1)}},{key:"createPipelineState",value:function(){if(!(this._renderPass&&this._shader&&this._bindings.length||this.tryCompile()))return console.warn("pass resources not complete, create PSO failed"),null;var e=this._shader;Vd.bindings=this._bindings;var t=this._device.createBindingLayout(Vd);for(var i in this._buffers)t.bindBuffer(parseInt(i),this._buffers[i]);for(var n in this._samplers)t.bindSampler(parseInt(n),this._samplers[n]);for(var r in this._textureViews)t.bindTextureView(parseInt(r),this._textureViews[r]);var a=cc.director.root.pipeline.globalBindings,s=this._shaderInfo.builtins.globals,o=s.blocks,l=Array.isArray(o),u=0;for(o=l?o:o[Symbol.iterator]();;){var c;if(l){if(u>=o.length)break;c=o[u++]}else{if((u=o.next()).done)break;c=u.value}var h=c,f=a.get(h.name);f&&f.type===wo.UNIFORM_BUFFER?t.bindBuffer(f.blockInfo.binding,f.buffer):console.warn("builtin UBO '".concat(h.name,"' not available!"))}var _=s.samplers,d=Array.isArray(_),p=0;for(_=d?_:_[Symbol.iterator]();;){var m;if(d){if(p>=_.length)break;m=_[p++]}else{if((p=_.next()).done)break;m=p.value}var v=m,g=a.get(v.name);g&&g.type===wo.SAMPLER?(g.sampler&&t.bindSampler(g.samplerInfo.binding,g.sampler),t.bindTextureView(g.samplerInfo.binding,g.textureView)):console.warn("builtin texture '".concat(v.name,"' not available!"))}Hd.layouts=[t];var y=this._device.createPipelineLayout(Hd);Wd.primitive=this._primitive,Wd.shader=e,Wd.rasterizerState=this._rs,Wd.depthStencilState=this._dss,Wd.blendState=this._bs,Wd.dynamicStates=this._dynamicStates,Wd.layout=y,Wd.renderPass=this._renderPass,Wd.program=this._programName,Wd.defines=this._defines,Wd.stage=this._stage,Wd.hash=this._hash;var b=this._device.createPipelineState(Wd);return this._resources.push({bindingLayout:t,pipelineLayout:y,pipelineState:b}),b}},{key:"destroyPipelineState",value:function(e){var t=this._resources.findIndex((function(t){return t.pipelineState===e}));if(t>=0){var i=this._resources[t],n=i.bindingLayout,r=i.pipelineLayout,a=i.pipelineState;n.destroy(),r.destroy(),a.destroy(),this._resources.splice(t,1)}}},{key:"createBatchedBuffer",value:function(){this._batchedBuffer||(this._bs.targets[0].blend?console.error("Transparent pass("+this.program+") can't use dynamic batching!"):this._batchedBuffer=new pd(this))}},{key:"beginChangeStatesSilently",value:function(){}},{key:"endChangeStatesSilently",value:function(){}},{key:"_doInit",value:function(t){this._idxInTech=t.idxInTech,this._programName=t.program,this._defines=t.defines,this._shaderInfo=Ld.getTemplate(t.program),this._properties=t.properties||this._properties;var i=this._device;e.fillinPipelineInfo(this,t),t.stateOverrides&&e.fillinPipelineInfo(this,t.stateOverrides),this._hash=e.getPSOHash(this);for(var n=this._shaderInfo.blocks,r=0;r<n.length;r++){var a=n[r],s=a.size,o=a.binding;if(!gu(o)){Gd.size=16*Math.ceil(s/16),this._buffers[o]=i.createBuffer(Gd);var l=new ArrayBuffer(s);this._blocks[o]={buffer:l,dirty:!1,view:new Float32Array(l)}}}var u=this._handleMap=this._shaderInfo.handleMap,c={};for(var h in this._properties){var f=this._properties[h];f.handleInfo&&(c[h]=this.getHandle.apply(this,f.handleInfo))}Object.assign(u,c),this.tryCompile()}},{key:"priority",get:function(){return this._priority}},{key:"primitive",get:function(){return this._primitive}},{key:"stage",get:function(){return this._stage}},{key:"rasterizerState",get:function(){return this._rs}},{key:"depthStencilState",get:function(){return this._dss}},{key:"blendState",get:function(){return this._bs}},{key:"dynamicStates",get:function(){return this._dynamicStates}},{key:"customizations",get:function(){return this._customizations}},{key:"phase",get:function(){return this._phase}},{key:"device",get:function(){return this._device}},{key:"shaderInfo",get:function(){return this._shaderInfo}},{key:"program",get:function(){return this._programName}},{key:"properties",get:function(){return this._properties}},{key:"defines",get:function(){return this._defines}},{key:"idxInTech",get:function(){return this._idxInTech}},{key:"bindings",get:function(){return this._bindings}},{key:"shader",get:function(){return this._shader}},{key:"renderPass",get:function(){return this._renderPass}},{key:"dynamics",get:function(){return this._dynamics}},{key:"batchedBuffer",get:function(){return this._batchedBuffer}},{key:"blocks",get:function(){return this._blocks}},{key:"hash",get:function(){return this._hash}}]),e}();jd.getBindingTypeFromHandle=gd,jd.getTypeFromHandle=yd,jd.getBindingFromHandle=bd,jd.getOffsetFromHandle=Ed;var Xd,qd,Yd,Kd,Zd,Qd,Jd,$d,ep,tp={},ip=e("EffectAsset",Es("cc.EffectAsset")((Ud=zd=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),s=0;s<r;s++)a[s]=arguments[s];return m(n=c(this,(e=o(t)).call.apply(e,[this].concat(a))),"techniques",Dd,u(n)),m(n,"shaders",Fd,u(n)),m(n,"combinations",Nd,u(n)),n}return s(t,e),r(t,[{key:"onLoaded",value:function(){this.shaders.forEach((function(e){return Ld.define(e)})),cc.game.once(cc.Game.EVENT_ENGINE_INITED,this._precompile,this),t.register(this)}},{key:"_precompile",value:function(){for(var e=this,t=cc.director.root,i=function(i){var n=e.shaders[i],r=e.combinations[i];if(!r)return"continue";Object.keys(r).reduce((function(e,t){return e.reduce((function(e,i){var n=r[t],a=[i].concat(p(Array(n.length-1)).map((function(){return Object.assign({},i)})));return a.forEach((function(e,i){return e[t]=n[i]})),e.concat(a)}),[])}),[{}]).forEach((function(e){return Ld.getGFXShader(t.device,n.name,e,t.pipeline)}))},n=0;n<this.shaders.length;n++)i(n)}}],[{key:"register",value:function(e){tp[e.name]=e}},{key:"remove",value:function(e){if(tp[e])delete tp[e];else for(var t in tp)if(tp[t]._uuid===e)return void delete tp[t]}},{key:"get",value:function(e){if(tp[e])return tp[e];for(var t in tp)if(tp[t]._uuid===e)return tp[t];return null}},{key:"getAll",value:function(){return tp}}]),t}(Tl),zd._effects={},Dd=v((Bd=Ud).prototype,"techniques",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Fd=v(Bd.prototype,"shaders",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Nd=v(Bd.prototype,"combinations",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Pd=Bd))||Pd);cc.EffectAsset=ip;var np=e("Material",(Xd=Es("cc.Material"),qd=Ts(ip),Xd((Zd=v((Kd=function(e){function t(){var e;return i(this,t),m(e=c(this,o(t).call(this)),"_effectAsset",Zd,u(e)),m(e,"_techIdx",Qd,u(e)),m(e,"_defines",Jd,u(e)),m(e,"_states",$d,u(e)),m(e,"_props",ep,u(e)),e._passes=[],e._hash=0,e.loaded=!1,e}return s(t,e),r(t,[{key:"effectAsset",get:function(){return this._effectAsset}},{key:"effectName",get:function(){return this._effectAsset?this._effectAsset.name:""}},{key:"technique",get:function(){return this._techIdx}},{key:"passes",get:function(){return this._passes}},{key:"hash",get:function(){return this._hash}},{key:"parent",get:function(){return null}},{key:"owner",get:function(){return null}}],[{key:"getHash",value:function(e){var t="",i=e.passes,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}t+=a.hash}return Jo(t,666)}}]),r(t,[{key:"initialize",value:function(e){this._defines||(this._defines=[]),this._states||(this._states=[]),this._props||(this._props=[]),void 0!==e.technique&&(this._techIdx=e.technique),e.effectAsset?this._effectAsset=e.effectAsset:e.effectName&&(this._effectAsset=ip.get(e.effectName)),e.defines&&this._prepareInfo(e.defines,this._defines),e.states&&this._prepareInfo(e.states,this._states),this._update()}},{key:"reset",value:function(e){this.initialize(e)}},{key:"destroy",value:function(){return this._doDestroy(),f(o(t.prototype),"destroy",this).call(this)}},{key:"recompileShaders",value:function(e,t){console.warn("Shaders in material asset '"+this.name+"' cannot be modified at runtime, please instantiate the material first.")}},{key:"overridePipelineStates",value:function(e,t){console.warn("Pipeline states in material asset '"+this.name+"' cannot be modified at runtime, please instantiate the material first.")}},{key:"onLoaded",value:function(){this._update(),this.loaded=!0,this.emit("load")}},{key:"resetUniforms",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this._props.length=this._passes.length;for(var t=0;t<this._props.length;t++)this._props[t]={};if(e){var i=this._passes,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;s.resetUBOs(),s.resetTextures()}}}},{key:"setProperty",value:function(e,t,i){var n=!1;if(void 0===i)for(var r=this._passes,a=r.length,s=0;s<a;s++){var o=r[s];this._uploadProperty(o,e,t)&&(this._props[s][e]=t,n=!0)}else{if(i>=this._passes.length)return void console.warn("illegal pass index: ".concat(i,"."));var l=this._passes[i];this._uploadProperty(l,e,t)&&(this._props[i][e]=t,n=!0)}n||console.warn("illegal property name: ".concat(e,"."))}},{key:"getProperty",value:function(e,t){if(void 0===t)for(var i=this._props,n=i.length,r=0;r<n;r++){var a=i[r];for(var s in a)if(s===e)return a[s]}else{if(t>=this._props.length)return console.warn("illegal pass index: ".concat(t,".")),null;var o=this._props[t];for(var l in o)if(l===e)return o[l]}return null}},{key:"copy",value:function(e){this._techIdx=e._techIdx,this._props.length=e._props.length;for(var t=0;t<e._props.length;t++)this._props[t]=Object.assign({},e._props[t]);this._defines.length=e._defines.length;for(var i=0;i<e._defines.length;i++)this._defines[i]=Object.assign({},e._defines[i]);this._states.length=e._states.length;for(var n=0;n<e._states.length;n++)this._states[n]=Object.assign({},e._states[n]);this._effectAsset=e._effectAsset,this._update()}},{key:"_prepareInfo",value:function(e,t){if(!Array.isArray(e)){var i=this._effectAsset?this._effectAsset.techniques[this._techIdx].passes.length:1;e=Array(i).fill(e)}for(var n=0;n<e.length;++n)Object.assign(t[n]||(t[n]={}),e[n])}},{key:"_createPasses",value:function(){var e=this._effectAsset.techniques[this._techIdx||0];if(!e)return[];for(var t=e.passes.length,i=[],n=0;n<t;++n){var r=e.passes[n],a=r.defines=this._defines.length>n?this._defines[n]:{};if(!r.switch||a[r.switch]){r.stateOverrides=this._states.length>n?this._states[n]:{},r.idxInTech=n;var s=new jd(cc.director.root.device);s.initialize(r),i.push(s)}}return i}},{key:"_update",value:function(){var e=this,i=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(this._effectAsset){if(this._passes&&this._passes.length){var n=this._passes,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s;o.destroy()}}this._passes=this._createPasses();var l=this._effectAsset.techniques[this._techIdx].passes.length;if(this._props.length=l,i)this._passes.forEach((function(t,i){var n=e._props[t.idxInTech];for(var r in n||(n=e._props[i]={}),n)e._uploadProperty(t,r,n[r])}));else for(var u=0;u<this._props.length;u++)this._props[u]={}}else{var c=P_.get("missing-effect-material");c&&(this._passes=c._passes.slice())}this._hash=t.getHash(this)}},{key:"_uploadProperty",value:function(e,t,i){var n=e.getHandle(t);if(void 0===n)return!1;var r=jd.getBindingTypeFromHandle(n);if(r===wo.UNIFORM_BUFFER)Array.isArray(i)?e.setUniformArray(n,i):e.setUniform(n,i);else if(r===wo.SAMPLER){var a=jd.getBindingFromHandle(n);if(i instanceof B_)e.bindTextureView(a,i);else if(i instanceof Rc||i instanceof Yc){var s=i.getGFXTextureView();if(!s||!s.texture.width||!s.texture.height)return!1;e.bindTextureView(a,s),i instanceof Rc&&e.bindSampler(a,yc.getSampler(cc.director.root.device,i.getSamplerHash()))}}return!0}},{key:"_doDestroy",value:function(){if(this._passes&&this._passes.length){var e=this._passes,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.destroy()}}this._effectAsset=null,this._passes.length=0,this._props.length=0,this._defines.length=0,this._states.length=0}}]),t}(Tl)).prototype,"_effectAsset",[qd],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Qd=v(Kd.prototype,"_techIdx",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Jd=v(Kd.prototype,"_defines",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),$d=v(Kd.prototype,"_states",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ep=v(Kd.prototype,"_props",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Yd=Kd))||Yd));cc.Material=np;var rp,ap,sp,op,lp,up,cp,hp,fp,_p,dp,pp,mp,vp,gp,yp,bp,Ep,Tp,Sp=function(e){function t(e,n){var r;i(this,t),(r=c(this,o(t).call(this,e.device)))._dontNotify=!1,r._parent=e,r._owner=n,r._doInit(r._parent),r._defines=Object.assign({},e.defines);var a=r._shaderInfo.blocks,s=Array.isArray(a),l=0;for(a=s?a:a[Symbol.iterator]();;){var u;if(s){if(l>=a.length)break;u=a[l++]}else{if((l=a.next()).done)break;u=l.value}var h=u;if(!gu(h.binding)){var f=r._blocks[h.binding],_=r._parent.blocks[h.binding];f.view.set(_.view),f.dirty=!0}}var d=r._shaderInfo.samplers,p=Array.isArray(d),m=0;for(d=p?d:d[Symbol.iterator]();;){var v;if(p){if(m>=d.length)break;v=d[m++]}else{if((m=d.next()).done)break;v=m.value}var g=v;gu(g.binding)||(r._textureViews[g.binding]=r._parent._textureViews[g.binding],r._samplers[g.binding]=r._parent._samplers[g.binding])}return r}return s(t,e),r(t,[{key:"parent",get:function(){return this._parent}}]),r(t,[{key:"overridePipelineStates",value:function(e,t){this._bs=new z_,this._dss=new F_,this._rs=new D_,jd.fillinPipelineInfo(this,e),jd.fillinPipelineInfo(this,t),this._onStateChange()}},{key:"tryCompile",value:function(e){if(e&&!wd(this._defines,e))return!1;var i=f(o(t.prototype),"tryCompile",this).call(this);return this._onStateChange(),i}},{key:"createBatchedBuffer",value:function(){console.warn("pass instance have no batched buffer.")}},{key:"beginChangeStatesSilently",value:function(){this._dontNotify=!0}},{key:"endChangeStatesSilently",value:function(){this._dontNotify=!1}},{key:"_onStateChange",value:function(){this._hash=jd.getPSOHash(this),this._owner.onPassStateChange(this._dontNotify)}}]),t}(jd),xp=function(e){function t(e){var n;return i(this,t),(n=c(this,o(t).call(this)))._passes=[],n._subModelIdx=0,n._parent=e.parent,n._owner=e.owner||null,n._subModelIdx=e.subModelIdx||0,n.copy(n._parent),n}return s(t,e),r(t,[{key:"parent",get:function(){return this._parent}},{key:"owner",get:function(){return this._owner}}]),r(t,[{key:"recompileShaders",value:function(e,t){if(this._passes&&this.effectAsset)if(void 0===t){var i=this._passes,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}a.tryCompile(e)}}else this._passes[t].tryCompile(e)}},{key:"overridePipelineStates",value:function(e,t){if(this._passes&&this.effectAsset){var i=this.effectAsset.techniques[this.technique].passes;if(void 0===t)for(var n=0;n<this._passes.length;n++){var r=this._passes[n];this._states[n]=e,r.overridePipelineStates(i[r.idxInTech],e)}else this._states[t]=e,this._passes[t].overridePipelineStates(i[t],e)}}},{key:"destroy",value:function(){return this._doDestroy(),!0}},{key:"onPassStateChange",value:function(e){this._hash=np.getHash(this),!e&&this._owner&&this._owner._onRebuildPSO(this._subModelIdx,this)}},{key:"_createPasses",value:function(){var e=[],t=this._parent.passes;if(!t)return e;for(var i=0;i<t.length;++i)e.push(new Sp(t[i],this));return e}}]),t}(np),Ap={parent:null,owner:null,subModelIdx:0},wp=e("RenderableComponent",(rp=Es("cc.RenderableComponent"),ap=Ts({type:[np],tooltip:""}),sp=Ts({visible:!1}),op=Ts({type:np,displayName:"Materials",tooltip:""}),rp((cp=v((up=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),s=0;s<r;s++)a[s]=arguments[s];return m(n=c(this,(e=o(t)).call.apply(e,[this].concat(a))),"_materials",cp,u(n)),m(n,"_visFlags",hp,u(n)),n._materialInstances=[],n._models=[],n}return s(t,e),r(t,[{key:"getMaterial",value:function(e){return e<0||e>=this._materials.length?null:this._materials[e]}},{key:"setMaterial",value:function(e,t){e&&e instanceof xp&&console.error("Can't set a material instance to a sharedMaterial slot"),this._materials[t]=e,this._materialInstances[t]?this._materialInstances[t].parent!==this._materials[t]&&(this._materialInstances[t].destroy(),this._materialInstances[t]=null,this._onMaterialModified(t,this._materials[t])):this._onMaterialModified(t,this._materials[t])}},{key:"getMaterialInstance",value:function(e){if(!this._materials[e])return null;if(null==this._materialInstances[e]){Ap.parent=this._materials[e],Ap.owner=this,Ap.subModelIdx=e;var t=new xp(Ap);this.setMaterialInstance(e,t)}return this._materialInstances[e]}},{key:"setMaterialInstance",value:function(e,t){t&&t.parent?t!==this._materialInstances[e]&&(this._materialInstances[e]=t,this._onMaterialModified(e,t)):t!==this._materials[e]&&this.setMaterial(t,e)}},{key:"getRenderMaterial",value:function(e){return this._materialInstances[e]||this._materials[e]}},{key:"_collectModels",value:function(){return this._models}},{key:"_attachToScene",value:function(){}},{key:"_detachFromScene",value:function(){}},{key:"_onMaterialModified",value:function(e,t){}},{key:"_onRebuildPSO",value:function(e,t){}},{key:"_clearMaterials",value:function(){}},{key:"_onVisiblityChange",value:function(e){}},{key:"visibility",get:function(){return this._visFlags},set:function(e){this._visFlags=e,this._onVisiblityChange(e)}},{key:"sharedMaterials",get:function(){return this._materials.slice()},set:function(e){for(var t=0;t<e.length;t++)e[t]!==this._materials[t]&&this.setMaterial(e[t],t);if(e.length<this._materials.length){for(var i=e.length;i<this._materials.length;i++)this.setMaterial(null,i);this._materials.splice(e.length)}}},{key:"materials",get:function(){for(var e=0;e<this._materials.length;e++)this._materialInstances[e]=this.getMaterialInstance(e);return this._materialInstances},set:function(e){var t=e.length-this._materials.length;if(t>0)this._materials.length=e.length,this._materialInstances.length=e.length;else if(t<0)for(var i=this._materials.length-t;i<this._materials.length;++i)this.setMaterialInstance(i,null);for(var n=0;n<this._materialInstances.length;n++)this._materialInstances[n]!=e[n]&&this.setMaterialInstance(n,e[n])}},{key:"sharedMaterial",get:function(){return this.getMaterial(0)}},{key:"material",get:function(){return this.getMaterialInstance(0)},set:function(e){1===this._materials.length&&this._materials[0]===e||this.setMaterialInstance(0,e)}}]),t}(Ph)).prototype,"_materials",[ap],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),hp=v(up.prototype,"_visFlags",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return du.Enum.NONE}}),v(up.prototype,"visibility",[sp],Object.getOwnPropertyDescriptor(up.prototype,"visibility"),up.prototype),v(up.prototype,"sharedMaterials",[op],Object.getOwnPropertyDescriptor(up.prototype,"sharedMaterials"),up.prototype),lp=up))||lp)),Cp=dt({OFF:0,ON:1}),Rp=e("ModelComponent",(fp=Es("cc.ModelComponent"),_p=Rs(100),dp=Cs("Components/Model"),pp=Ts({type:Cp,tooltip:""}),mp=Ts({type:su,tooltip:""}),fp(vp=_p(vp=dp(vp=As((Tp=Ep=function(e){function t(){var e;return i(this,t),m(e=c(this,o(t).call(this)),"_mesh",yp,u(e)),m(e,"_shadowCastingMode",bp,u(e)),e._model=null,e._modelType=Zu,e}return s(t,e),r(t,[{key:"shadowCastingMode",get:function(){return this._shadowCastingMode},set:function(e){this._shadowCastingMode=e,this._updateCastShadow()}},{key:"mesh",get:function(){return this._mesh},set:function(e){var t=this._mesh;this._mesh=e,this._onMeshChanged(t),this._updateModels(),this.node.activeInHierarchy&&this._attachToScene()}},{key:"model",get:function(){return this._model}}]),r(t,[{key:"onLoad",value:function(){this._updateModels(),this._updateCastShadow()}},{key:"onEnable",value:function(){this._model||this._updateModels(),this._model&&this._attachToScene()}},{key:"onDisable",value:function(){this._model&&this._detachFromScene()}},{key:"onDestroy",value:function(){this._model&&(cc.director.root.destroyModel(this._model),this._model=null,this._models.length=0)}},{key:"_updateModels",value:function(){this.enabledInHierarchy&&this._mesh&&(this._model?this._model.destroy():this._createModel(),this._updateModelParams(),this._model&&(this._model.createBoundingShape(this._mesh.minPosition,this._mesh.maxPosition),this._model.enabled=!0))}},{key:"_createModel",value:function(){this._model=cc.director.root.createModel(this._modelType),this._model.visFlags=this.visibility,this._model.initialize(this.node),this._models.length=0,this._models.push(this._model)}},{key:"_attachToScene",value:function(){if(this.node.scene&&this._model){var e=this._getRenderScene();null!=this._model.scene&&this._detachFromScene(),e.addModel(this._model)}}},{key:"_detachFromScene",value:function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)}},{key:"_updateModelParams",value:function(){if(this._mesh&&this._model){this.node.hasChangedFlags=this._model.transform.hasChangedFlags=Nu.POSITION,(this._model.isDynamicBatching=this._isBatchingEnabled())&&this._mesh.createFlatBuffers();for(var e=this._mesh?this._mesh.subMeshCount:0,t=0;t<e;++t){var i=this.getRenderMaterial(t),n=this._mesh.renderingMesh;if(n){var r=n.getSubmesh(t);r&&this._model.initSubModel(t,r,i||this._getBuiltinMaterial())}}}}},{key:"_onMaterialModified",value:function(e,t){this._model&&this._model.inited&&this._onRebuildPSO(e,t||this._getBuiltinMaterial())}},{key:"_onRebuildPSO",value:function(e,t){this._model&&this._model.inited&&((this._model.isDynamicBatching=this._isBatchingEnabled())&&this._mesh&&this._mesh.createFlatBuffers(),this._model.setSubModelMaterial(e,t))}},{key:"_onMeshChanged",value:function(e){}},{key:"_clearMaterials",value:function(){if(this._model)for(var e=0;e<this._model.subModelNum;++e)this._onMaterialModified(e,null)}},{key:"_getBuiltinMaterial",value:function(){return P_.get("missing-material")}},{key:"_onVisiblityChange",value:function(e){this._model&&(this._model.visFlags=e)}},{key:"_updateCastShadow",value:function(){this._model&&(this._shadowCastingMode===Cp.OFF?this._model.castShadow=!1:this._shadowCastingMode===Cp.ON?this._model.castShadow=!0:console.warn("ShadowCastingMode ".concat(this._shadowCastingMode," is not supported.")))}},{key:"_isBatchingEnabled",value:function(){if(!this._model||!this._mesh)return!1;for(var e=0;e<this._materials.length;++e){var t=this._materials[e];if(t)for(var i=0;i<t.passes.length;++i){if(t.passes[i].batchedBuffer)return!0}}return!1}}]),t}(wp),Ep.ShadowCastingMode=Cp,yp=v((gp=Tp).prototype,"_mesh",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),bp=v(gp.prototype,"_shadowCastingMode",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Cp.OFF}}),v(gp.prototype,"shadowCastingMode",[pp],Object.getOwnPropertyDescriptor(gp.prototype,"shadowCastingMode"),gp.prototype),v(gp.prototype,"mesh",[mp],Object.getOwnPropertyDescriptor(gp.prototype,"mesh"),gp.prototype),vp=gp))||vp)||vp)||vp)||vp));function kp(e,t){if(e._materials.length!==t._materials.length)return!1;for(var i=e._materials.length,n=0;n<i;n++)if(e.getRenderMaterial(n)!==t.getRenderMaterial(n))return!1;return!0}e("BatchingUtility",function(){function e(){i(this,e)}return r(e,null,[{key:"batchStaticModel",value:function(e,t){var i=e.getComponentsInChildren(Rp);if(i.length<2)return console.error("the number of static models to batch is less than 2,it needn't batch."),!1;for(var n=1;n<i.length;n++){if(!i[0].mesh.validateMergingMesh(i[n].mesh))return console.error("the meshes of "+i[0].node.name+" and "+i[n].node.name+" can't be merged"),!1;if(!kp(i[0],i[n]))return console.error("the materials of "+i[0].node.name+" and "+i[n].node.name+" can't be merged"),!1}var r=new su,a=new Bn,s=new Bn;e.getWorldMatrix(s),Bn.invert(s,s);for(var o=0;o<i.length;o++)i[o].node.getWorldMatrix(a),Bn.multiply(a,s,a),r.merge(i[o].mesh,a);var l=t.addComponent(Rp);return l.mesh=r,l.sharedMaterials=i[0]._materials,!0}}]),e}());var Op=new zi;function Ip(e,t,i,n){n||(n=new zi),e.convertToUINode(t,i,n);var r=i.position;return n.add(r),n}function Mp(e,t,i){return i||(i=new zi),e.worldToScreen(t,i),i.x=i.x/cc.view.getScaleX(),i.y=i.y/cc.view.getScaleY(),i}var Lp,Pp,Bp,Dp,Fp,Np,zp,Up,Gp,Vp,Hp,Wp,jp,Xp=e("convertUtils",{WorldNode3DToLocalNodeUI:Ip,WorldNode3DToWorldNodeUI:Mp});cc.pipelineUtils=Xp,sr(cc.pipelineUtils,"cc.pipelineUtils",[{name:"WorldNode3DToLocalNodeUI",newName:"convertToUINode",targetName:"cc.CameraComponent.prototype",customFunction:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];var n=t[0],r=t[3]||Op;return n.convertToUINode(t[1],t[2],r),r.add(t[2].position),t[3]||r.clone()}}]);var qp=(Lp=Es("cc.MissingClass"),Pp=Ts({visible:!1,editorOnly:!0}),Lp((Fp=v((Dp=function e(){i(this,e),m(this,"_$erialized",Fp,this)}).prototype,"_$erialized",[Pp],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Bp=Dp))||Bp),Yp=e("MissingScript",(Np=Es("cc.MissingScript"),zp=Is("packages://inspector/inspectors/comps/missing-script.js"),Up=Ts({serializable:!1}),Gp=Ts({visible:!1,editorOnly:!0}),Np(Vp=zp((Wp=v((Hp=function(e){function t(){var e;return i(this,t),m(e=c(this,o(t).call(this)),"compiled",Wp,u(e)),m(e,"_$erialized",jp,u(e)),e}return s(t,e),r(t,null,[{key:"safeFindClass",value:function(e,i){var n=qe(e);return n||(e?(cc.deserialize.reportMissingClass(e),t.getMissingWrapper(e,i)):null)}},{key:"getMissingWrapper",value:function(e,i){return i.node&&(/^[0-9a-zA-Z+/]{23}$/.test(e)||$e.test(e))?t:qp}}]),r(t,[{key:"onLoad",value:function(){cc.warnID(4600,this.node.name)}}]),t}(Ph)).prototype,"compiled",[Up],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),jp=v(Hp.prototype,"_$erialized",[Gp],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Vp=Hp))||Vp)||Vp));cc._MissingScript=Yp;var Kp=function(){function e(){i(this,e),this.uuidList=[],this.uuidObjList=[],this.uuidPropList=[],this._stillUseUrl=we(!0)}return r(e,[{key:"reset",value:function(){this.uuidList.length=0,this.uuidObjList.length=0,this.uuidPropList.length=0,Ge(this._stillUseUrl)}},{key:"push",value:function(e,t,i,n){n&&(this._stillUseUrl[this.uuidList.length]=!0),this.uuidList.push(i),this.uuidObjList.push(e),this.uuidPropList.push(t)}}]),e}();function Zp(e,t,i,n,r,a){if(t instanceof cc.ValueType){r||e.push("if(prop){");var s=Ce(t);e.push("s._deserializeTypedObject(o".concat(i,",prop,").concat(s,");")),r||e.push("}else o"+i+"=null;")}else e.push("if(prop){"),e.push("s._deserializeObjField(o,prop,"+n+",null,"+!!a+");"),e.push("}else o"+i+"=null;")}Kp.pool=new Ze((function(e){e.reset()}),10),Kp.pool.get=function(){return this._get()||new Kp};var Qp=function(e,i){for(var n=bt(i),r=i.__values__,a=["var prop;"],s=$e.test(Ke(i)),o=0;o<r.length;o++){var l=r[o];0;var u=void 0,c=void 0;ri.IDENTIFIER_RE.test(l)?(c='"'+l+'"',u="."+l):u="["+(c=ri.escapeForJS(l))+"]";var h=u;if(n[l+"$_$formerlySerializedAs"]){var f=n[l+"$_$formerlySerializedAs"];h=ri.IDENTIFIER_RE.test(f)?"."+f:"["+ri.escapeForJS(f)+"]"}a.push("prop=d"+h+";"),a.push("if(typeof ".concat("prop",'!=="undefined"){'));var _=n[l+"$_$saveUrlAsAsset"],d=ri.getDefault(n[l+"$_$default"]);if(s){var p=void 0,m=n[l+"$_$type"];if(void 0===d&&m)p=m===cc.String||m===cc.Integer||m===cc.Float||m===cc.Boolean;else{var v=t(d);p="string"===v&&!_||"number"===v||"boolean"===v}p?a.push("o".concat(u,"=prop;")):Zp(a,d,u,c,!0,_)}else a.push("if(typeof ".concat("prop",'!=="object"){')+"o"+u+"=prop;}else{"),Zp(a,d,u,c,!1,_),a.push("}");a.push("}")}(cc.js.isChildClassOf(i,cc._BaseNode)||cc.js.isChildClassOf(i,cc.Component))&&a.push("d._id&&(o._id=d._id);");return"_$erialized"===r[r.length-1]&&(a.push("o._$erialized=JSON.parse(JSON.stringify(d));"),a.push("s._deserializePrimitiveObject(o._$erialized,d);")),Function("s","o","d","k","t",a.join(""))};function Jp(e,t,i,n,r){var a;n.hasOwnProperty("__deserialize__")?a=n.__deserialize__:(a=Qp(e,n),Te(n,"__deserialize__",a,!0)),a(e,t,i,n,r),t.__postDeserialize&&t.__postDeserialize()}var $p=function(){function e(t,n,r,a,s){i(this,e),this.result=t,this.customEnv=a,this.deserializedList=[],this.deserializedData=null,this._classFinder=r,this._idList=[],this._idObjList=[],this._idPropList=[]}return r(e,[{key:"deserialize",value:function(e){if(Array.isArray(e)){var t=e,i=t.length;this.deserializedList.length=i;for(var n=0;n<i;n++){if(t[n])this.deserializedList[n]=this._deserializeObject(t[n],!1)}this.deserializedData=i>0?this.deserializedList[0]:[]}else this.deserializedList.length=1,this.deserializedData=e?this._deserializeObject(e,!1):null,this.deserializedList[0]=this.deserializedData;return function(e){var t,i,n,r=e.deserializedList,a=e._idPropList,s=e._idList,o=e._idObjList;for(e._classFinder&&e._classFinder.onDereferenced,t=0;t<s.length;t++)i=a[t],n=s[t],o[t][i]=r[n]}(this),this.deserializedData}},{key:"_deserializeObject",value:function(e,i,n,r,a){var s,o=null,l=null,u=e.__type__;if("TypedArray"===u){var c=e.array;o=new window[e.ctor](c.length);for(var h=0;h<c.length;++h)o[h]=c[h];return o}if(u){var f=function(){(o=new l)._deserialize?o._deserialize(e.content,_):cc.Class._isCCClass(l)?Jp(_,o,e,l,n):_._deserializeTypedObject(o,e,l)};if(!(l=this._classFinder(u,e,r,a)))return this._classFinder===qe&&cc.deserialize.reportMissingClass(u),null;var _=this;f()}else if(Array.isArray(e)){o=new Array(e.length);for(var d=0;d<e.length;d++)"object"===t(s=e[d])&&s?this._deserializeObjField(o,s,""+d,null,i):o[d]=s}else o={},this._deserializePrimitiveObject(o,e);return o}},{key:"_deserializeObjField",value:function(e,t,i,n,r){var a=t.__id__;if(void 0===a){var s=t.__uuid__;s?this.result.push(e,i,s,r):e[i]=this._deserializeObject(t,r)}else{var o=this.deserializedList[a];o?e[i]=o:(this._idList.push(a),this._idObjList.push(e),this._idPropList.push(i))}}},{key:"_deserializePrimitiveObject",value:function(e,i){for(var n in i)if(i.hasOwnProperty(n)){var r=i[n];"object"!==t(r)?"__type__"!==n&&(e[n]=r):r?this._deserializeObjField(e,r,n):e[n]=null}}},{key:"_deserializeTypedObject",value:function(e,i,n){if(n===cc.Vec2)return e.x=i.x||0,void(e.y=i.y||0);if(n===cc.Vec3)return e.x=i.x||0,e.y=i.y||0,void(e.z=i.z||0);if(n!==cc.Color){if(n===cc.Size)return e.width=i.width||0,void(e.height=i.height||0);for(var r=bt(n),a=n.__props__||Object.keys(e),s=0;s<a.length;s++){var o=a[s],l=i[o];void 0!==l&&i.hasOwnProperty(o)||(l=ri.getDefault(r[o+"$_$default"])),"object"!==t(l)?e[o]=l:l?this._deserializeObjField(e,l,o):e[o]=null}}else{e.r=i.r||0,e.g=i.g||0,e.b=i.b||0;var u=i.a;e.a=void 0===u?255:u}}}]),e}();function em(e,t,i){var n=(i=i||{}).classFinder||qe,r=i.createAssetRefs||cc.sys.platform===cc.sys.EDITOR_CORE,a=i.customEnv,s=i.ignoreEditorOnly;"string"==typeof e&&(e=JSON.parse(e));var o=!t;t=t||Kp.pool.get();var l=$p.pool.get(t,!1,n,a,s);cc.game._isCloning=!0;var u=l.deserialize(e);return cc.game._isCloning=!1,$p.pool.put(l),r&&t.assignAssetsBy(Editor.serialize.asAsset),o&&Kp.pool.put(t),u}$p.pool=new Ze((function(e){e.result=null,e.customEnv=null,e.deserializedList.length=0,e.deserializedData=null,e._classFinder=null,e._idList.length=0,e._idObjList.length=0,e._idPropList.length=0}),1),$p.pool.get=function(e,t,i,n,r){var a=this._get();return a?(a.result=e,a.customEnv=n,a._classFinder=i,a):new $p(e,t,i,n,r)},em.Details=Kp,em.reportMissingClass=function(e){N(5302,e)},cc.deserialize=em,e("deserialize",em);var tm,im,nm,rm,am,sm,om,lm,um,cm,hm,fm=hl.Flags.Destroyed,_m=hl.Flags.PersistentMask,dm=[];function pm(e,i){if(!i){if("object"!==t(e)||Array.isArray(e))return null;if(!e)return null;if(!cc.isValid(e))return null;0}var n;if(e instanceof hl){if((e=e)._instantiate)return cc.game._isCloning=!0,n=e._instantiate(),cc.game._isCloning=!1,n;if(e instanceof cc.Asset)return null}return cc.game._isCloning=!0,n=mm(e),cc.game._isCloning=!1,n}function mm(e,t){if(Array.isArray(e))return null;if(lt&&lt(e))return null;var i;if(e._iN$t)i=e._iN$t;else if(e.constructor){i=new(0,e.constructor)}else i=Object.create(null);vm(e,i,t);for(var n=0,r=dm.length;n<r;++n)dm[n]._iN$t=null;return dm.length=0,i}function vm(e,i,n){Te(e,"_iN$t",i,!0),dm.push(e);var r=e.constructor;if(cc.Class._isCCClass(r))!function(e,i,n,r){for(var a=e.__values__,s=0;s<a.length;s++){var o=a[s],l=i[o];if("object"===t(l)&&l){var u=n[o];u instanceof mt&&u.constructor===l.constructor?u.set(l):n[o]=l._iN$t||gm(l,r)}else n[o]=l}}(r,e,i,n);else for(var a in e)if(e.hasOwnProperty(a)&&(95!==a.charCodeAt(0)||95!==a.charCodeAt(1)||"__type__"===a)){var s=e[a];if("object"===t(s)&&s){if(s===i)continue;i[a]=s._iN$t||gm(s,n)}else i[a]=s}e instanceof hl&&(i._objFlags&=_m)}function gm(e,i){if(e instanceof mt)return e.clone();if(e instanceof cc.Asset)return e;var n;if(Array.isArray(e)){var r=e.length;n=new Array(r),e._iN$t=n;for(var a=0;a<r;++a){var s=e[a];"object"===t(s)&&s?n[a]=s._iN$t||gm(s,i):n[a]=s}return dm.push(e),n}if(e._objFlags&fm)return null;var o=e.constructor;if(cc.Class._isCCClass(o)){if(i)if(i instanceof cc.Component){if(e instanceof cc._BaseNode||e instanceof cc.Component)return e}else if(i instanceof cc._BaseNode)if(e instanceof cc._BaseNode){if(!e.isChildOf(i))return e}else if(e instanceof cc.Component&&!e.node.isChildOf(i))return e;n=new o}else if(o===Object)n={};else{if(o)return e;n=Object.create(null)}return vm(e,n,i),n}pm._clone=mm,cc.instantiate=pm,e("instantiate",pm),function(e){e[e.Uint8=0]="Uint8",e[e.Uint16=1]="Uint16",e[e.Uint32=2]="Uint32",e[e.Int8=3]="Int8",e[e.Int16=4]="Int16",e[e.Int32=5]="Int32",e[e.Float32=6]="Float32",e[e.Float64=7]="Float64"}(cm||(cm={})),function(e){e[e.Scalar=0]="Scalar",e[e.Vec2=1]="Vec2",e[e.Vec3=2]="Vec3",e[e.Vec4=3]="Vec4",e[e.Quat=4]="Quat",e[e.Mat4=5]="Mat4"}(hm||(hm={}));function ym(e,t){return(t<<3)+e}var bm=e("CompactValueTypeArray",Es("cc.CompactValueTypeArray")((lm=om=function(){function e(){i(this,e),m(this,"_byteOffset",nm,this),m(this,"_unitCount",rm,this),m(this,"_unitElement",am,this),m(this,"_length",sm,this)}return r(e,[{key:"decompress",value:function(e){for(var t,i={storageUnit:7&(t=this._unitElement),elementType:t>>3},n=i.storageUnit,r=Em(i.elementType),a=new(Tm(n))(e,this._byteOffset,this._unitCount),s=new Array(this._length),o=0;o<this._length;++o)s[o]=r.decompress(a,o);return s}}],[{key:"lengthFor",value:function(e,t,i){return Em(t).requiredUnits*e.length*Tm(i).BYTES_PER_ELEMENT}},{key:"compress",value:function(t,i,n,r,a,s){for(var o=Em(i),l=Tm(n),u=o.requiredUnits*t.length,c=new l(r,a,u),h=0;h<t.length;++h)o.compress(c,h,t[h]);var f=new e;return f._unitElement=ym(n,i),f._byteOffset=s,f._unitCount=u,f._length=t.length,f}}]),e}(),om.StorageUnit=cm,om.ElementType=hm,nm=v((im=lm).prototype,"_byteOffset",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),rm=v(im.prototype,"_unitCount",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),am=v(im.prototype,"_unitElement",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ym(cm.Uint8,hm.Scalar)}}),sm=v(im.prototype,"_length",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),tm=im))||tm);function Em(e){return Sm[e]}function Tm(e){switch(e){case cm.Uint8:return Uint8Array;case cm.Uint16:return Uint16Array;case cm.Uint32:return Uint32Array;case cm.Int8:return Int8Array;case cm.Int16:return Int16Array;case cm.Int32:return Int32Array;case cm.Float32:return Float32Array;case cm.Float64:return Float64Array}}var Sm=(a(um={},hm.Scalar,{requiredUnits:1,compress:function(e,t,i){e[t]=i},decompress:function(e,t){return e[t]}}),a(um,hm.Vec2,{requiredUnits:2,compress:function(e,t,i){e[2*t]=i.x,e[2*t+1]=i.y},decompress:function(e,t){return new zi(e[2*t],e[2*t+1])}}),a(um,hm.Vec3,{requiredUnits:3,compress:function(e,t,i){e[3*t]=i.x,e[3*t+1]=i.y,e[3*t+2]=i.z},decompress:function(e,t){return new zi(e[3*t],e[3*t+1],e[3*t+2])}}),a(um,hm.Vec4,{requiredUnits:4,compress:function(e,t,i){e[4*t]=i.x,e[4*t+1]=i.y,e[4*t+2]=i.z,e[4*t+3]=i.w},decompress:function(e,t){return new qi(e[4*t],e[4*t+1],e[4*t+2],e[4*t+3])}}),a(um,hm.Quat,{requiredUnits:4,compress:function(e,t,i){e[4*t]=i.x,e[4*t+1]=i.y,e[4*t+2]=i.z,e[4*t+3]=i.w},decompress:function(e,t){return new fn(e[4*t],e[4*t+1],e[4*t+2],e[4*t+3])}}),a(um,hm.Mat4,{requiredUnits:16,compress:function(e,t,i){Bn.toArray(e,i,16*t)},decompress:function(e,t){return Bn.fromArray(new Bn,e,16*t)}}),um);function xm(e){var t=[];return function e(t,i){var n=i,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s;Array.isArray(o)?e(t,o):t.push(o)}}(t,e),t.join("")}cc._decorator=Xs;var Am=hl.Flags.Destroyed,wm=hl.Flags.PersistentMask,Cm=ri.IDENTIFIER_RE,Rm={"cc.Node":"cc.Node","cc.Sprite":"cc.Sprite","cc.Label":"cc.Label","cc.Button":"cc.Button","cc.Widget":"cc.Widget","cc.Animation":"cc.Animation","cc.ClickEvent":!1,"cc.PrefabInfo":!1},km=ri.escapeForJS,Om=function(){function e(t,n){i(this,e),this.varName=t,this.expression=n}return r(e,[{key:"toString",value:function(){return"var "+this.varName+"="+this.expression+";"}}]),e}();function Im(e,t){return t instanceof Om?new Om(t.varName,e+t.expression):e+t}function Mm(e,t,i){Array.isArray(i)?(i[0]=Im(t,i[0]),e.push(i)):e.push(Im(t,i)+";")}var Lm=function(){function e(t){i(this,e),this._exps=[],this._targetExp=t}return r(e,[{key:"append",value:function(e,t){this._exps.push([e,t])}},{key:"writeCode",value:function(e){var t;if(this._exps.length>1)e.push("t="+this._targetExp+";"),t="t";else{if(1!==this._exps.length)return;t=this._targetExp}for(var i=0;i<this._exps.length;i++){var n=this._exps[i];Mm(e,t+Pm(n[0])+"=",n[1])}}}]),e}();function Pm(e){return Cm.test(e)?"."+e:"["+km(e)+"]"}Lm.pool=new Ze((function(e){e._exps.length=0,e._targetExp=null}),1),Lm.pool.get=function(e){var t=this._get()||new Lm;return t._targetExp=e,t};var Bm,Dm,Fm,Nm,zm,Um,Gm,Vm=function(){function e(t,n){var r;i(this,e),this.parent=n,this.objsToClear_iN$t=[],this.codeArray=[],this.objs=[],this.funcs=[],this.funcModuleCache=we(),Fe(this.funcModuleCache,Rm),this.globalVariables=[],this.globalVariableId=0,this.localVariableId=0,this.codeArray.push("var o,t;","if(R){","o=R;","}else{","o=R=new "+this.getFuncModule(t.constructor,!0)+"();","}"),t._iN$t={globalVar:"R"},this.objsToClear_iN$t.push(t),this.enumerateObject(this.codeArray,t),this.globalVariables.length>0&&(r="var "+this.globalVariables.join(",")+";");var a=xm(["return (function(R){",r||[],this.codeArray,"return o;","})"]);this.result=Function("O","F",a)(this.objs,this.funcs);for(var s=0,o=this.objsToClear_iN$t.length;s<o;++s)this.objsToClear_iN$t[s]._iN$t=null;this.objsToClear_iN$t.length=0}return r(e,[{key:"getFuncModule",value:function(e,t){var i=Ce(e);if(i){var n=this.funcModuleCache[i];if(n)return n;if(void 0===n){var r=-1!==i.indexOf(".");if(r)try{if(r=e===Function("return "+i)())return this.funcModuleCache[i]=i,i}catch(e){}}}var a=this.funcs.indexOf(e);a<0&&(a=this.funcs.length,this.funcs.push(e));var s="F["+a+"]";return t&&(s="("+s+")"),this.funcModuleCache[i]=s,s}},{key:"getObjRef",value:function(e){var t=this.objs.indexOf(e);return t<0&&(t=this.objs.length,this.objs.push(e)),"O["+t+"]"}},{key:"setValueType",value:function(e,t,i,n){var r=Lm.pool.get(n),a=t.constructor.__props__;a||(a=Object.keys(t));for(var s=0;s<a.length;s++){var o=a[s],l=i[o];if(t[o]!==l){var u=this.enumerateField(i,o,l);r.append(o,u)}}r.writeCode(e),Lm.pool.put(r)}},{key:"enumerateCCClass",value:function(e,i,n){for(var r=n.__values__,a=bt(n),s=0;s<r.length;s++){var o=r[s],l=i[o],u=a[o+"$_$default"];if(!Hm(u,l))if("object"===t(l)&&l instanceof cc.ValueType&&(u=ri.getDefault(u))&&u.constructor===l.constructor){var c="o"+Pm(o);this.setValueType(e,u,l,c)}else this.setObjProp(e,i,o,l)}}},{key:"instantiateArray",value:function(e){if(0===e.length)return"[]";var t="a"+ ++this.localVariableId,i=[new Om(t,"new Array("+e.length+")")];e._iN$t={globalVar:"",source:i},this.objsToClear_iN$t.push(e);for(var n=0;n<e.length;++n){Mm(i,t+"["+n+"]=",this.enumerateField(e,n,e[n]))}return i}},{key:"enumerateField",value:function(e,i,n){if("object"===t(n)&&n){var r=n._iN$t;if(r){var a=r.globalVar;if(!a){a=r.globalVar="v"+ ++this.globalVariableId,this.globalVariables.push(a);var s=r.source[0];r.source[0]=Im(a+"=",s)}return a}return Array.isArray(n)?this.instantiateArray(n):this.instantiateObj(n)}return"function"==typeof n?this.getFuncModule(n):"string"==typeof n?km(n):("_objFlags"===i&&e instanceof hl&&(n&=wm),n)}},{key:"setObjProp",value:function(e,t,i,n){Mm(e,"o"+Pm(i)+"=",this.enumerateField(t,i,n))}},{key:"enumerateObject",value:function(e,i){var n=i.constructor;if(cc.Class._isCCClass(n))this.enumerateCCClass(e,i,n);else for(var r in i)if(i.hasOwnProperty(r)&&(95!==r.charCodeAt(0)||95!==r.charCodeAt(1)||"__type__"===r)){var a=i[r];"object"===t(a)&&a&&a===i._iN$t||this.setObjProp(e,i,r,a)}}},{key:"instantiateObj",value:function(e){if(e instanceof cc.ValueType)return ri.getNewValueTypeCode(e);if(e instanceof cc.Asset)return this.getObjRef(e);if(e._objFlags&Am)return null;var t,i=e.constructor;if(cc.Class._isCCClass(i)){if(this.parent)if(this.parent instanceof cc.Component){if(e instanceof cc._BaseNode||e instanceof cc.Component)return this.getObjRef(e)}else if(this.parent instanceof cc._BaseNode)if(e instanceof cc._BaseNode){if(!e.isChildOf(this.parent))return this.getObjRef(e)}else if(e instanceof cc.Component&&!e.node.isChildOf(this.parent))return this.getObjRef(e);t=new Om("o","new "+this.getFuncModule(i,!0)+"()")}else if(i===Object)t=new Om("o","{}");else{if(i)return this.getObjRef(e);t=new Om("o","Object.create(null)")}var n=[t];return e._iN$t={globalVar:"",source:n},this.objsToClear_iN$t.push(e),this.enumerateObject(n,e),["(function(){",n,"return o;})();"]}}]),e}();function Hm(e,t){if("function"==typeof e)try{e=e()}catch(e){return!1}if(e===t)return!0;if(e&&t){if(e instanceof cc.ValueType&&e.equals(t))return!0;if(Array.isArray(e)&&Array.isArray(t)||e.constructor===Object&&t.constructor===Object)try{return Array.isArray(e)&&Array.isArray(t)&&0===e.length&&0===t.length}catch(e){}}return!1}function Wm(e){var t=e instanceof cc._BaseNode&&e;return new Vm(e,t).result}var jm,Xm,qm,Ym,Km=dt({AUTO:0,SINGLE_INSTANCE:1,MULTI_INSTANCE:2}),Zm=e("Prefab",Es("cc.Prefab")((Gm=Um=function(e){function t(){var e;return i(this,t),m(e=c(this,o(t).call(this)),"data",Fm,u(e)),m(e,"optimizationPolicy",Nm,u(e)),m(e,"asyncLoadAssets",zm,u(e)),e._createFunction=null,e._instantiatedTimes=0,e}return s(t,e),r(t,[{key:"createNode",value:function(e){var t=cc.instantiate(this);t.name=this.name,e(null,t)}},{key:"compileCreateFunction",value:function(){this._createFunction=Wm(this.data)}},{key:"_doInstantiate",value:function(e){return this.data._prefab?this.data._prefab._synced=!0:cc.warnID(3700),this._createFunction||this.compileCreateFunction(),this._createFunction(e)}},{key:"_instantiate",value:function(){var e;return this.optimizationPolicy!==Km.SINGLE_INSTANCE&&(this.optimizationPolicy===Km.MULTI_INSTANCE||this._instantiatedTimes+1>=t.OptimizationPolicyThreshold)?(e=this._doInstantiate(),this.data._instantiate(e)):(this.data._prefab._synced=!0,e=this.data._instantiate()),++this._instantiatedTimes,e}}]),t}(Tl),Um.OptimizationPolicy=Km,Um.OptimizationPolicyThreshold=3,Fm=v((Dm=Gm).prototype,"data",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Nm=v(Dm.prototype,"optimizationPolicy",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Km.AUTO}}),zm=v(Dm.prototype,"asyncLoadAssets",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Bm=Dm))||Bm);cc.Prefab=Zm,Re(cc,"cc._Prefab","Prefab");var Qm,Jm,$m,ev=e("SceneAsset",Es("cc.SceneAsset")((qm=v((Xm=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),s=0;s<r;s++)a[s]=arguments[s];return m(n=c(this,(e=o(t)).call.apply(e,[this].concat(a))),"scene",qm,u(n)),m(n,"asyncLoadAssets",Ym,u(n)),n}return s(t,e),t}(Tl)).prototype,"scene",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ym=v(Xm.prototype,"asyncLoadAssets",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),jm=Xm))||jm);cc.SceneAsset=ev;var tv,iv,nv,rv=e("SpriteAtlas",Es("cc.SpriteAtlas")(($m=v((Jm=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),s=0;s<r;s++)a[s]=arguments[s];return m(n=c(this,(e=o(t)).call.apply(e,[this].concat(a))),"spriteFrames",$m,u(n)),n}return s(t,e),r(t,[{key:"getTexture",value:function(){var e=Object.keys(this.spriteFrames);if(e.length>0){var t=this.spriteFrames[e[0]];return t&&t._image}return null}},{key:"getSpriteFrame",value:function(e){var t=this.spriteFrames[e];return t?(t.name||(t.name=e),t):null}},{key:"getSpriteFrames",value:function(){for(var e=[],t=this.spriteFrames,i=0,n=Object.keys(t);i<n.length;i++){var r=n[i];e.push(t[r])}return e}},{key:"_serialize",value:function(e){for(var t=[],i=0,n=Object.keys(this.spriteFrames);i<n.length;i++){var r=n[i],a=this.spriteFrames[r],s=a?a._uuid:"";s&&e&&(s=Editor.Utils.UuidUtils.compressUuid(s,!0)),t.push(r),t.push(s)}return{name:this._name,spriteFrames:t}}},{key:"_deserialize",value:function(e,t){var i=e;this._name=i.name;var n=i.spriteFrames;this.spriteFrames=we();for(var r=0;r<n.length;r+=2)t.result.push(this.spriteFrames,n[r],n[r+1])}}]),t}(Tl)).prototype,"spriteFrames",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return we()}}),Qm=Jm))||Qm);cc.SpriteAtlas=rv;var av,sv,ov,lv=e("TextAsset",Es("cc.TextAsset")((nv=v((iv=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),s=0;s<r;s++)a[s]=arguments[s];return m(n=c(this,(e=o(t)).call.apply(e,[this].concat(a))),"text",nv,u(n)),n}return s(t,e),r(t,[{key:"toString",value:function(){return this.text}}]),t}(Tl)).prototype,"text",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),tv=iv))||tv);cc.TextAsset=lv;var uv=e("JsonAsset",Es("cc.JsonAsset")((ov=v((sv=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),s=0;s<r;s++)a[s]=arguments[s];return m(n=c(this,(e=o(t)).call.apply(e,[this].concat(a))),"json",ov,u(n)),n}return s(t,e),t}(Tl)).prototype,"json",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),av=sv))||av);cc.JsonAsset=uv;var cv="0123456789abcdef".split(""),hv=["","","",""],fv=hv.concat(hv,"-",hv,"-",hv,"-",hv,"-",hv,hv,hv),_v=fv.map((function(e,t){return"-"===e?NaN:t})).filter(isFinite);function dv(e){var t=e.split("@")[0];if(22!==t.length)return e;fv[0]=e[0],fv[1]=e[1];for(var i=2,n=2;i<22;i+=2){var r=nt[e.charCodeAt(i)],a=nt[e.charCodeAt(i+1)];fv[_v[n++]]=cv[r>>2],fv[_v[n++]]=cv[(3&r)<<2|a>>4],fv[_v[n++]]=cv[15&a]}return e.replace(t,fv.join(""))}var pv={_rawAssets:"",normalize:function(e){return e&&(46===e.charCodeAt(0)&&47===e.charCodeAt(1)?e=e.slice(2):47===e.charCodeAt(0)&&(e=e.slice(1))),e},raw:function(e){if((e=this.normalize(e)).startsWith("resources/")){var t=cc.loader._getResUuid(e.slice(10),cc.Asset,null,!0);if(t)return cc.AssetLibrary.getLibUrlNoExt(t,!0)+cc.path.extname(e)}else cc.errorID(7002,e);return this._rawAssets+e},_init:function(e){this._rawAssets=cc.path.stripSep(e)+"/"}};cc.url=pv,e("url",pv);var mv=function e(t,n){i(this,e),this.uuid=t,this.type=n};function vv(e,t){return!(e.length>t.length)||47===e.charCodeAt(t.length)}var gv=function(){function e(){i(this,e),this._pathToUuid=we(!0)}return r(e,[{key:"getUuid",value:function(e,t){e=pv.normalize(e);var i=this._pathToUuid[e];if(i)if(Array.isArray(i)){if(!t)return i[0].uuid;for(var n=0;n<i.length;n++){var r=i[n];if(Ue(r.type,t))return r.uuid}}else{if(!t||Ue(i.type,t))return i.uuid}return""}},{key:"getUuidArray",value:function(e,t,i){"/"===(e=pv.normalize(e))[e.length-1]&&(e=e.slice(0,-1));var n=this._pathToUuid,r=[];for(var a in n)if(a.startsWith(e)&&vv(a,e)||!e){var s=n[a];if(Array.isArray(s))for(var o=0;o<s.length;o++){var l=s[o];(!t||Ue(l.type,t))&&(r.push(l.uuid),i&&i.push(a))}else(!t||Ue(s.type,t))&&(r.push(s.uuid),i&&i.push(a))}return r}},{key:"add",value:function(e,t,i,n){n&&(e=e.substring(0,e.length-J(e).length));var r=new mv(t,i);st(this._pathToUuid,e,r,n)}},{key:"_getInfo_DEBUG",value:function(e,t){for(var i=this._pathToUuid,n=Object.keys(i),r=0;r<n.length;++r){var a=n[r],s=i[a];if(Array.isArray(s))for(var o=0;o<s.length;o++){var l=s[o];if(l.uuid===e)return t.path=a,t.type=l.type,!0}else if(s.uuid===e)return t.path=a,t.type=s.type,!0}return!1}},{key:"reset",value:function(){this._pathToUuid=we(!0)}}]),e}();function yv(e,t){var i=cc.loader.getItem(e);if(i){var n=i.dependKeys;if(n)for(var r=0;r<n.length;r++){var a=n[r];t[a]||(t[a]=!0,yv(a,t))}}}function bv(e,t){if(e._uuid){var i=cc.loader._getReferenceKey(e);t[i]||(t[i]=!0,yv(i,t))}}function Ev(e,i){for(var n=Object.getOwnPropertyNames(e),r=0;r<n.length;r++){var a=e[n[r]];if("object"===t(a)&&a)if(Array.isArray(a))for(var s=0;s<a.length;s++){var o=a[s];o instanceof El&&bv(o,i)}else if(a.constructor&&a.constructor!==Object)a instanceof El&&bv(a,i);else for(var l=Object.getOwnPropertyNames(a),u=0;u<l.length;u++){var c=a[l[u]];c instanceof El&&bv(c,i)}}}function Tv(e,t){for(var i=0;i<e._components.length;i++)Ev(e._components[i],t);for(var n=0;n<e._children.length;n++)Tv(e._children[n],t)}function Sv(e){var t={};return yv(e,t),Object.keys(t)}var xv,Av=0|998*Math.random(),wv=we(!0),Cv=[];!function(e){e[e.WORKING=0]="WORKING",e[e.COMPLETE=1]="COMPLETE",e[e.ERROR=2]="ERROR"}(xv||(xv={}));var Rv=we(!0);function kv(e){if(e){var t=e.split("?");if(t&&t[0]&&t[1]){var i={};return t[1].split("&").forEach((function(e){var t=e.split("=");i[t[0]]=t[1]})),i}}}function Ov(e,i){var n="object"===t(e)?e.url:e,r={queueId:i,id:n,url:n,rawUrl:void 0,urlParam:kv(n),type:"",error:null,content:null,complete:!1,states:{},deps:null,isScene:e.uuid&&cc.game._sceneInfos.find((function(t){return t.uuid===e.uuid}))};if("object"===t(e)&&(Fe(r,e),e.skips))for(var a=0;a<e.skips.length;a++){var s=e.skips[a];r.states[s]=xv.COMPLETE}return r.rawUrl=r.url,n&&!r.type&&(r.type=J(n).toLowerCase().substr(1)),r}var Iv=[];function Mv(e,t,i){if(!e||!t)return!1;var n=!1;if(Iv.push(t.id),t.deps){var r,a,s=t.deps;for(r=0;r<s.length;r++){if((a=s[r]).id===e.id){n=!0;break}if(!(Iv.indexOf(a.id)>=0)&&(a.deps&&Mv(e,a,!0))){n=!0;break}}}return i||(Iv.length=0),n}var Lv=e("LoadingItems",function(e){function t(e,n,r,a){var s;return i(this,t),(s=c(this,o(t).call(this))).map=we(!0),s.completed={},s.totalCount=0,s.completedCount=0,s._errorUrls=[],s._appending=!1,s._ownerQueue=null,s._id=++Av,wv[s._id]=u(s),s._pipeline=e,s.onProgress=r,s.onComplete=a,s._pipeline?s.active=!0:s.active=!1,n&&(n.length>0?s.append(n):s.allComplete()),s}return s(t,e),r(t,[{key:"append",value:function(e,i){var n=this;if(!this.active)return[];i&&!i.deps&&(i.deps=[]),this._appending=!0;var r,a,s,o,l=[];for(r=0;r<e.length;++r){if((a=e[r]).queueId&&!this.map[a.id]){if(this.map[a.id]=a,i&&i.deps.push(a),a.complete||Mv(i,a)){this.totalCount++,this.itemComplete(a.id);continue}if("continue"===function(){var e=n,r=wv[a.queueId];return r&&(n.totalCount++,t.registerQueueDep(i||n._id,a.id),r.addListener(a.id,(function(t){e.itemComplete(t.id)}))),"continue"}())continue}if("string"==typeof((o=a).url||o)){var u=(s=Ov(a,this._id)).id;this.map[u]||(this.map[u]=s,this.totalCount++,i&&i.deps.push(s),t.registerQueueDep(i||this._id,u),l.push(s))}}return this._appending=!1,this.completedCount===this.totalCount?this.allComplete():this._pipeline.flowIn(l),l}},{key:"_childOnProgress",value:function(e){if(this.onProgress){var t=Rv[this._id];this.onProgress(t?t.completed.length:this.completedCount,t?t.deps.length:this.totalCount,e)}}},{key:"allComplete",value:function(){var e=0===this._errorUrls.length?null:this._errorUrls;this.onComplete&&this.onComplete(e,this)}},{key:"isCompleted",value:function(){return this.completedCount>=this.totalCount}},{key:"isItemCompleted",value:function(e){return!!this.completed[e]}},{key:"exists",value:function(e){return!!this.map[e]}},{key:"getContent",value:function(e){var t=this.map[e],i=null;return t&&(t.content?i=t.content:t.alias&&(i=t.alias.content)),i}},{key:"getError",value:function(e){var t=this.map[e],i=null;return t&&(t.error?i=t.error:t.alias&&(i=t.alias.error)),i}},{key:"removeItem",value:function(e){var t=this.map[e];t&&this.completed[t.alias||e]&&(delete this.completed[e],delete this.map[e],t.alias&&(delete this.completed[t.alias.id],delete this.map[t.alias.id]),this.completedCount--,this.totalCount--)}},{key:"itemComplete",value:function(e){var i=this.map[e];if(i){var n=this._errorUrls.indexOf(e);if(i.error&&-1===n?this._errorUrls.push(e):i.error||-1===n||this._errorUrls.splice(n,1),this.completed[e]=i,this.completedCount++,t.finishDep(i.id),this.onProgress){var r=Rv[this._id];this.onProgress(r?r.completed.length:this.completedCount,r?r.deps.length:this.totalCount,i)}this.emit(e,i),this.removeAll(e),!this._appending&&this.completedCount>=this.totalCount&&this.allComplete()}}},{key:"destroy",value:function(){this.active=!1,this._appending=!1,this._pipeline=null,this._ownerQueue=null,this._errorUrls.length=0,this.onProgress=void 0,this.onComplete=void 0,this.map=we(!0),this.completed={},this.totalCount=0,this.completedCount=0,al.call(this),wv[this._id]=null,Rv[this._id]&&(Rv[this._id].completed.length=0,Rv[this._id].deps.length=0),-1===Cv.indexOf(this)&&Cv.length<10&&Cv.push(this)}},{key:"addListener",value:function(e,i,n){return f(o(t.prototype),"on",this).call(this,e,i,n)}},{key:"hasListener",value:function(e,i,n){return f(o(t.prototype),"hasEventListener",this).call(this,e,i,n)}},{key:"removeListener",value:function(e,i,n){return f(o(t.prototype),"off",this).call(this,e,i,n)}},{key:"removeAllListeners",value:function(e){f(o(t.prototype),"removeAll",this).call(this,e)}}],[{key:"create",value:function(e,i,n,r){void 0===n?"function"==typeof i&&(r=i,i=n=null):void 0===r&&("function"==typeof i?(r=n,n=i,i=null):(r=n,n=null));var a=Cv.pop();return a?(a._pipeline=e,a.onProgress=n,a.onComplete=r,wv[a._id]=a,a._pipeline&&(a.active=!0),i&&a.append(i)):a=new t(e,i,n,r),a}},{key:"getQueue",value:function(e){return e.queueId?wv[e.queueId]:null}},{key:"itemComplete",value:function(e){var t=wv[e.queueId];t&&t.itemComplete(e.id)}},{key:"initQueueDeps",value:function(e){var t=Rv[e._id];t?(t.completed.length=0,t.deps.length=0):t=Rv[e._id]={completed:[],deps:[]}}},{key:"registerQueueDep",value:function(e,t){var i=e.queueId||e;if(!i)return!1;var n=Rv[i];if(n)-1===n.deps.indexOf(t)&&n.deps.push(t);else if(e.id)for(var r in Rv){var a=Rv[r];-1!==a.deps.indexOf(e.id)&&-1===a.deps.indexOf(t)&&a.deps.push(t)}}},{key:"finishDep",value:function(e){for(var t in Rv){var i=Rv[t];-1!==i.deps.indexOf(e)&&-1===i.completed.indexOf(e)&&i.completed.push(e)}}}]),t}(al));Lv.ItemState=new cc.Enum(xv),cc.LoadingItems=Lv;var Pv=Lv.ItemState;function Bv(e,t){var i=e.id,n=t.states[i],r=e.next,a=e.pipeline;if(!t.error&&n!==Pv.WORKING&&n!==Pv.ERROR)if(n===Pv.COMPLETE)r?Bv(r,t):a.flowOut(t);else{t.states[i]=Pv.WORKING;var s=e.handle(t,(function(e,n){e?(t.error=e,t.states[i]=Pv.ERROR,a.flowOut(t)):(n&&(t.content=n),t.states[i]=Pv.COMPLETE,r?Bv(r,t):a.flowOut(t))}));s instanceof Error?(t.error=s,t.states[i]=Pv.ERROR,a.flowOut(t)):void 0!==s&&(null!==s&&(t.content=s),t.states[i]=Pv.COMPLETE,r?Bv(r,t):a.flowOut(t))}}var Dv=e("Pipeline",function(){function e(t){i(this,e),this._cache=we(!0),this._pipes=t;for(var n=0;n<t.length;++n){var r=t[n];r.handle&&r.id&&(r.pipeline=this,r.next=n<t.length-1?t[n+1]:null)}}return r(e,[{key:"insertPipe",value:function(e,t){if(!e.handle||!e.id||t>this._pipes.length)cc.warnID(4921);else if(this._pipes.indexOf(e)>0)cc.warnID(4922);else{e.pipeline=this;var i=null;t<this._pipes.length&&(i=this._pipes[t]);var n=null;t>0&&(n=this._pipes[t-1]),n&&(n.next=e),e.next=i,this._pipes.splice(t,0,e)}}},{key:"insertPipeAfter",value:function(e,t){var i=this._pipes.indexOf(e);i<0||this.insertPipe(t,i+1)}},{key:"appendPipe",value:function(e){e.handle&&e.id&&(e.pipeline=this,e.next=null,this._pipes.length>0&&(this._pipes[this._pipes.length-1].next=e),this._pipes.push(e))}},{key:"flowIn",value:function(e){var t,i,n=this._pipes[0];if(n){for(t=0;t<e.length;t++)(i=e[t]).isScene||(this._cache[i.id]=i);for(t=0;t<e.length;t++)Bv(n,i=e[t])}else for(t=0;t<e.length;t++)this.flowOut(e[t])}},{key:"flowInDeps",value:function(e,t,i){return Lv.create(this,(function(e,t){i(e,t),t.destroy()})).append(t,e)}},{key:"flowOut",value:function(e){e.error?delete this._cache[e.id]:this._cache[e.id]||e.isScene||(this._cache[e.id]=e),e.complete=!0,Lv.itemComplete(e)}},{key:"copyItemStates",value:function(e,t){if(t instanceof Array)for(var i=0;i<t.length;++i)t[i].states=e.states;else t.states=e.states}},{key:"getItem",value:function(e){var t=this._cache[e];return t?(t.alias&&(t=t.alias),t):t}},{key:"removeItem",value:function(e){var t=this._cache[e];t&&t.complete&&delete this._cache[e];return t}},{key:"clear",value:function(){for(var e in this._cache){var t=this._cache[e];delete this._cache[e],t.complete||(t.error=new Error("Canceled manually"),this.flowOut(t))}}}]),e}());Dv.ItemState=Pv,cc.Pipeline=Dv;var Fv="MD5Pipe",Nv=/(\.[^.\n\\/]*)$/,zv=/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,}).*/;var Uv=function(){function e(t,n,r){i(this,e),this.id=Fv,this.async=!1,this.pipeline=null,this.id=Fv,this.async=!1,this.pipeline=null,this.md5AssetsMap=t,this.md5NativeAssetsMap=n,this.libraryBase=r}return r(e,[{key:"handle",value:function(e){var t=!1;return"ttf"===e.type&&(t=!0),e.url=this.transformURL(e.url,t),e}},{key:"transformURL",value:function(e,t){var i=function(e){var t=e.match(zv);return t?t[1]:""}(e);if(i){var n=(!e.match(this.libraryBase)?this.md5NativeAssetsMap:this.md5AssetsMap)[i];if(n)if(t){var r=cc.path.dirname(e),a=cc.path.basename(e);e="".concat(r,".").concat(n,"/").concat(a)}else{var s=!1;e=e.replace(Nv,(function(e,t){return s=!0,"."+n+t})),s||(e=e+"."+n)}}return e}}]),e}();Uv.ID=Fv,Dv.MD5Pipe=Uv;var Gv,Vv=function(){function e(){i(this,e),this.jsons={}}return r(e,[{key:"load",value:function(e,t){t.length!==e.length&&cc.errorID(4915);for(var i=0;i<e.length;i++){var n=e[i],r=t[i];this.jsons[n]=r}}},{key:"retrieve",value:function(e){return this.jsons[e]||null}}]),e}(),Hv=function(){function e(){i(this,e),this.contents={}}return r(e,[{key:"load",value:function(e,t){var i=t.data;i.length!==e.length&&cc.errorID(4915);for(var n=0;n<e.length;n++)this.contents[e[n]]={base:i[n][0],mipmaps:i[n][1]}}},{key:"retrieve",value:function(e){var t=this.contents[e];return t?{__type__:cc.js._getClassId(cc.Texture2D),content:t}:null}}]),e}(),Wv=/\?/;function jv(e){return cc.game.config.noCache&&"string"==typeof e&&(Wv.test(e)?e+="&_t="+(new Date-0):e+="?_t="+(new Date-0)),e}function Xv(e,i){if(Array.isArray(e))for(var n=0,r=e.length;n<r;n++)Xv(e[n],i);else if("object"===t(e))for(var a in e)Xv(e[a],i),Number.isNaN(Number(a))||(e[i[a]]=e[a],delete e[a]);return null}!function(e){e[e.Invalid=0]="Invalid",e[e.Removed=1]="Removed",e[e.Downloading=2]="Downloading",e[e.Loaded=3]="Loaded"}(Gv||(Gv={}));var qv=function e(){i(this,e),this.unpacker=null,this.state=Gv.Invalid},Yv={},Kv={},Zv={};function Qv(e,t){return new Error("Can not retrieve "+e+" from packer "+t)}function Jv(e){for(var t in Kv=e,e)for(var i=e[t],n=0;n<i.length;n++){var r=i[n],a=1===i.length;st(Yv,r,t,a)}}function $v(e,t,i){var n=cc.AssetLibrary.getLibUrlNoExt(t)+".json";cc.loader.load({url:n,ignoreMaxConcurrency:!0},(function(n,r){if(n)return U(4916,e),i(n);var a=tg(e,t,r);a?i(null,a):i(Qv(e,t))}))}function eg(e,t){var i=Zv[e];i||((i=Zv[e]=new qv).state=Gv.Downloading),i.state!==Gv.Loaded&&(i.unpacker=new Vv,i.unpacker.load(Kv[e],t),i.state=Gv.Loaded)}function tg(e,t,i){var n=Zv[t];if(n.state!==Gv.Loaded){if("string"==typeof i&&(i=JSON.parse(i)),i.keys&&i.data){var r=i.keys;Xv(i=i.data,r)}Array.isArray(i)?n.unpacker=new Vv:i.type===Ke(Uc)&&(n.unpacker=new Hv),n.unpacker.load(Kv[t],i),n.state=Gv.Loaded}return n.unpacker.retrieve(e)}function ig(e){for(var t=Gv.Invalid,i="",n=0;n<e.length;n++){var r=e[n],a=Zv[r];if(a){var s=a.state;if(s===Gv.Loaded)return r;s>t&&(t=s,i=r)}}return t!==Gv.Invalid?i:e[0]}function ng(e,t){var i=e.uuid,n=Yv[i];if(n){Array.isArray(n)&&(n=ig(n));var r=Zv[n];if(r&&r.state===Gv.Loaded){var a=r.unpacker.retrieve(i);return a||Qv(i,n)}return r||(console.log("Create unpacker %s for %s",n,i),(r=Zv[n]=new qv).state=Gv.Downloading),$v(i,n,t),null}}var rg=Object.freeze({__proto__:null,initPacks:Jv,_loadNewPack:$v,_doPreload:eg,_doLoadNewPack:tg,_selectLoadedPack:ig,load:ng}),ag=/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,}).*/;var sg=Object.create(null),og=function(){function e(t){i(this,e),this.id="SubPackPipe",this.async=!1,this.pipeline=null;var n=function(e){var i=t[e];i.uuids&&i.uuids.forEach((function(e){var t=dv(e),n=t.split("@").map((function(e){return encodeURIComponent(e)}));t=n.join("@"),sg[t]=i.path}))};for(var r in t)n(r)}return r(e,[{key:"handle",value:function(e){return e.url=this.transformURL(e.url),null}},{key:"transformURL",value:function(e){var t=function(e){var t=e.match(ag);return t?t[1]:""}(e);if(t){var i=sg[t];if(i)return e.replace("res/raw-assets/",i+"raw-assets/")}return e}}]),e}();og.ID="SubPackPipe",Dv.SubPackPipe=og;var lg="",ug="",cg=we(!0);function hg(e,t){this.url=e,this.type=t}var fg,_g={_uuidToAsset:{},loadAsset:function(e,t,i){if("string"!=typeof e)return ut(t,new Error("[AssetLibrary] uuid must be string"),null);var n={uuid:e,type:"uuid"};i&&i.existingAsset&&(n.existingAsset=i.existingAsset),cc.loader.load(n,(function(i,n){if(i||!n)i=new Error("[AssetLibrary] loading JSON or dependencies failed: "+(i?i.message:"Unknown error"));else if(n.constructor===cc.SceneAsset){var r=cc.loader._getReferenceKey(e);n.scene.dependAssets=Sv(r)}t&&t(i,n)}))},getLibUrlNoExt:function(e,t){var i=(e=dv(e)).split("@").map((function(e){return encodeURIComponent(e)}));return e=i.join("@"),(t?ug+"assets/":lg)+e.slice(0,2)+"/"+e},_queryAssetInfoInEditor:function(e,t){t(new Error("Unable to load resource: EditorExtends is not defined."))},_getAssetInfoInRuntime:function(e,t){t=t||{url:null,raw:!1};var i=cg[e];return i&&!Ue(i.type,cc.Asset)?(t.url=ug+i.url,t.raw=!0):(t.url=this.getLibUrlNoExt(e)+".json",t.raw=!1),t},_uuidInSettings:function(e){return e in cg},queryAssetInfo:function(e,t){var i=this._getAssetInfoInRuntime(e);t(null,i.url,i.raw)},parseUuidInEditor:function(e){},loadJson:function(e,t){var i=""+((new Date).getTime()+Math.random()),n={uuid:i,type:"uuid",content:e,skips:[cc.loader.assetLoader.id,cc.loader.downloader.id]};cc.loader.load(n,(function(e,n){if(e)e=new Error("[AssetLibrary] loading JSON or dependencies failed: "+e.message);else{if(n.constructor===cc.SceneAsset){var r=cc.loader._getReferenceKey(i);n.scene.dependAssets=Sv(r)}if(function(e){return e&&(e.constructor===cc.SceneAsset||e instanceof cc.Scene)}(n)){var a=cc.loader._getReferenceKey(i);cc.loader.removeItem(a)}}n._uuid="",t&&t(e,n)}))},getAssetByUuid:function(e){return _g._uuidToAsset[e]||null},init:function(e){var t=e.libraryPath;t=t.replace(/\\/g,"/"),lg=cc.path.stripSep(t)+"/",ug=e.rawAssetsBase;var i=e.md5AssetsMap;if(i&&i.import){var n=0,r=we(!0),a=i.import;for(n=0;n<a.length;n+=2){var s=dv(a[n]).split("@").map((function(e){return encodeURIComponent(e)}));r[s.join("@")]=a[n+1]}var o=we(!0);for(a=i["raw-assets"],n=0;n<a.length;n+=2){var l=dv(a[n]).split("@").map((function(e){return encodeURIComponent(e)}));o[l.join("@")]=a[n+1]}var u=new Uv(r,o,lg);cc.loader.insertPipeAfter(cc.loader.assetLoader,u),cc.loader.md5Pipe=u}if(e.subpackages){var c=new og(e.subpackages);cc.loader.insertPipeAfter(cc.loader.assetLoader,c),cc.loader.subPackPipe=c}var h=cc.loader._assetTables;for(var f in h)h[f].reset();var _=e.rawAssets;if(_)for(var d in _){var p=_[d];for(var m in p){var v=p[m],g=v[0],y=v[1],b=qe(y);if(b){cg[m]=new hg(d+"/"+g,b);var E=1===v[2];h[d]||(h[d]=new gv),h[d].add(g,m,b,!E)}else cc.error("Cannot get",y)}}e.packedAssets&&Jv(e.packedAssets),cc.url._init(e.mountPaths&&e.mountPaths.assets||ug+"assets")}};cc.AssetLibrary=_g,e("AssetLibrary",_g);var dg,pg,mg,vg,gg,yg=e("Font",Es("cc.Font")(fg=function(e){function t(){return i(this,t),c(this,o(t).apply(this,arguments))}return s(t,e),t}(Tl))||fg);cc.Font=yg;var bg,Eg,Tg,Sg,xg,Ag,wg,Cg,Rg=e("TTFFont",(dg=Es("cc.TTFFont"),pg=Ts({override:!0}),dg((gg=v((vg=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),s=0;s<r;s++)a[s]=arguments[s];return m(n=c(this,(e=o(t)).call.apply(e,[this].concat(a))),"_fontFamily",gg,u(n)),n}return s(t,e),r(t,[{key:"_nativeAsset",get:function(){return this._fontFamily},set:function(e){this._fontFamily=e||"Arial"}}]),t}(yg)).prototype,"_fontFamily",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),v(vg.prototype,"_nativeAsset",[pg,Fs],Object.getOwnPropertyDescriptor(vg.prototype,"_nativeAsset"),vg.prototype),mg=vg))||mg));cc.TTFFont=Rg;var kg,Og=e("BitmapFont",(bg=Es("cc.BitmapFont"),Eg=Ts({type:Yc}),bg((xg=v((Sg=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),s=0;s<r;s++)a[s]=arguments[s];return m(n=c(this,(e=o(t)).call.apply(e,[this].concat(a))),"fntDataStr",xg,u(n)),m(n,"spriteFrame",Ag,u(n)),m(n,"fontSize",wg,u(n)),m(n,"fntConfig",Cg,u(n)),n}return s(t,e),t}(yg)).prototype,"fntDataStr",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Ag=v(Sg.prototype,"spriteFrame",[Eg],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),wg=v(Sg.prototype,"fontSize",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Cg=v(Sg.prototype,"fntConfig",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Tg=Sg))||Tg));cc.BitmapFont=Og;var Ig=e("LabelAtlas",Es("cc.LabelAtlas")(kg=function(e){function t(){return i(this,t),c(this,o(t).apply(this,arguments))}return s(t,e),t}(Og))||kg);cc.LabelAtlas=Ig;var Mg=[],Lg=function(){function e(){i(this,e),this.id="AssetLoader",this.async=!0,this.pipeline=null}return r(e,[{key:"handle",value:function(e,t){var i=e.uuid;if(!i)return e.content||null;cc.AssetLibrary.queryAssetInfo(i,(function(n,r,a){if(n)t(n);else if(e.url=e.rawUrl=r,e.isRawAsset=a,a){var s=J(r).toLowerCase();if(!s)return void t(new Error(W(4931,i,r)));s=s.substr(1);var o=Lv.getQueue(e);Mg[0]={queueId:e.queueId,id:r,url:r,type:s,error:null,alias:e,complete:!0},o.append(Mg),e.type=s,t(null,e.content)}else e.type="uuid",t(null,e.content)}))}}]),e}();function Pg(e,t){var i=e.url,n=cc.loader.getXMLHttpRequest(),r="Load binary data failed: "+i;n.open("GET",i,!0),n.responseType="arraybuffer",n.onload=function(){var e=n.response;e?t(null,e):t({status:n.status,errorMessage:r+"(no response)"})},n.onerror=function(){t({status:n.status,errorMessage:r+"(error)"})},n.ontimeout=function(){t({status:n.status,errorMessage:r+"(time out)"})},n.send(null)}function Bg(e,t){var i=e.url;i=jv(i);var n=cc.loader.getXMLHttpRequest(),r="Load text file failed: "+i;n.open("GET",i,!0),n.overrideMimeType&&n.overrideMimeType("text/plain; charset=utf-8"),n.onload=function(){4===n.readyState?200===n.status||0===n.status?t(null,n.responseText):t({status:n.status,errorMessage:r+"(wrong status)"}):t({status:n.status,errorMessage:r+"(wrong readyState)"})},n.onerror=function(){t({status:n.status,errorMessage:r+"(error)"})},n.ontimeout=function(){t({status:n.status,errorMessage:r+"(time out)"})},n.send(null)}Lg.ID="AssetLoader",Dv.AssetLoader=Lg;var Dg={INITIALIZING:0,PLAYING:1,STOPPED:2},Fg=function(){function e(t){var n=this;i(this,e),this._state=Dg.STOPPED,this._duration=0,this._interrupted=!1,this._blocking=!1,this._duration=t.duration,this._eventTarget=t.eventTarget,this._onHide=function(){n._blocking=!0,n._state===Dg.PLAYING&&(n.pause(),n._interrupted=!0)},this._onShow=function(){n._blocking=!1,n._interrupted&&(n.play(),n._interrupted=!1)},cc.game.on(cc.Game.EVENT_HIDE,this._onHide),cc.game.on(cc.Game.EVENT_SHOW,this._onShow)}return r(e,[{key:"getState",value:function(){return this._state}},{key:"getDuration",value:function(){return this._duration}},{key:"destroy",value:function(){cc.game.off(cc.Game.EVENT_HIDE,this._onHide),cc.game.off(cc.Game.EVENT_SHOW,this._onShow)}}]),e}();cc.internal.AudioPlayer=Fg;var Ng,zg,Ug,Gg,Vg,Hg,Wg,jg,Xg=function(e){function t(e){var n;return i(this,t),(n=c(this,o(t).call(this,e)))._volume=1,n._loop=!1,n._oneShoting=!1,n._cbRegistered=!1,n._audio=e.clip,n._remove_cb=function(){n._cbRegistered&&(cc.game.canvas.removeEventListener("touchend",n._on_gesture),cc.game.canvas.removeEventListener("mouseup",n._on_gesture),n._cbRegistered=!1)},n._post_play=function(){n._state=Dg.PLAYING,n._eventTarget.emit("started"),n._remove_cb()},n._post_gesture=function(){n._interrupted?(n._post_play(),n._interrupted=!1):(n._audio.pause(),n._audio.currentTime=0)},n._on_gesture=function(){if(n._audio){var e=n._audio.play();if(!e)return n._state=Dg.PLAYING,void cc.director.once(cc.Director.EVENT_AFTER_UPDATE,n._post_gesture);e.then(n._post_gesture),n._remove_cb()}},n._audio.volume=n._volume,n._audio.loop=n._loop,n._audio.addEventListener("ended",(function(){n._oneShoting||(n._state=Dg.STOPPED,n._audio.currentTime=0,n._eventTarget.emit("ended"))})),cc.game.canvas.addEventListener("touchend",n._on_gesture),cc.game.canvas.addEventListener("mouseup",n._on_gesture),n._cbRegistered=!0,n}return s(t,e),r(t,[{key:"play",value:function(){var e=this;if(this._audio&&this._state!==Dg.PLAYING)if(this._blocking)this._interrupted=!0;else{var t=this._audio.play();if(!t)return this._state=Dg.PLAYING,void cc.director.once(cc.Director.EVENT_AFTER_UPDATE,this._post_play);t.then(this._post_play).catch((function(){e._interrupted=!0}))}}},{key:"pause",value:function(){this._audio&&this._state===Dg.PLAYING&&(this._audio.pause(),this._state=Dg.STOPPED,this._oneShoting=!1)}},{key:"stop",value:function(){this._audio&&(this._audio.currentTime=0,this._state===Dg.PLAYING&&(this._audio.pause(),this._state=Dg.STOPPED,this._oneShoting=!1))}},{key:"playOneShot",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,i=this._audio;i&&(i.currentTime=0,i.volume=t,this._oneShoting||(i.loop=!1,this._oneShoting=!0,i.play().then((function(){i.addEventListener("ended",(function(){i.currentTime=0,i.volume=e._volume,i.loop=e._loop,e._oneShoting=!1}),{once:!0})})).catch((function(){e._oneShoting=!1}))))}},{key:"setCurrentTime",value:function(e){this._audio&&(this._audio.currentTime=_i(e,0,this._duration))}},{key:"getCurrentTime",value:function(){return this._audio?this._audio.currentTime:0}},{key:"setVolume",value:function(e,t){this._volume=e,this._audio&&(this._audio.volume=e)}},{key:"getVolume",value:function(){return this._audio?this._audio.volume:this._volume}},{key:"setLoop",value:function(e){this._loop=e,this._audio&&(this._audio.loop=e)}},{key:"getLoop",value:function(){return this._loop}},{key:"destroy",value:function(){this._audio&&(this._audio.src=""),f(o(t.prototype),"destroy",this).call(this)}}]),t}(Fg),qg=Il.__audioSupport,Yg=function(e){function t(e){var n;return i(this,t),(n=c(this,o(t).call(this,e)))._startTime=0,n._offset=0,n._volume=1,n._loop=!1,n._currentTimer=0,n._startInvoked=!1,n._audio=e.clip,n._context=qg.context,n._sourceNode=n._context.createBufferSource(),n._gainNode=n._context.createGain(),n._gainNode.connect(n._context.destination),n._onEndedCB=n._onEnded.bind(u(n)),n._onGestureCB=n._onGesture.bind(u(n)),n._onGestureProceedCB=n._onGestureProceed.bind(u(n)),"running"!==n._context.state&&n._context.resume&&(cc.game.canvas.addEventListener("touchend",n._onGestureCB),cc.game.canvas.addEventListener("mouseup",n._onGestureCB)),n}return s(t,e),r(t,[{key:"play",value:function(){this._audio&&this._state!==Dg.PLAYING&&(this._blocking||"running"!==this._context.state?this._interrupted=!0:this._doPlay())}},{key:"pause",value:function(){this._state===Dg.PLAYING&&(this._doStop(),this._offset+=this._context.currentTime-this._startTime,this._state=Dg.STOPPED,clearInterval(this._currentTimer))}},{key:"stop",value:function(){this._offset=0,this._state===Dg.PLAYING&&(this._doStop(),this._state=Dg.STOPPED,clearInterval(this._currentTimer))}},{key:"playOneShot",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;if(this._audio){var t=this._context.createGain();t.connect(this._context.destination),t.gain.value=e;var i=this._context.createBufferSource();i.buffer=this._audio,i.loop=!1,i.connect(t),i.start()}}},{key:"setCurrentTime",value:function(e){this._offset=_i(e,0,this._audio&&this._audio.duration||this._duration),this._state===Dg.PLAYING&&(this._doStop(),this._doPlay())}},{key:"getCurrentTime",value:function(){return this._state!==Dg.PLAYING?this._offset:this._context.currentTime-this._startTime+this._offset}},{key:"setVolume",value:function(e,t){this._volume=e,!t&&this._gainNode.gain.setTargetAtTime?this._gainNode.gain.setTargetAtTime(e,this._context.currentTime,.01):this._gainNode.gain.value=e}},{key:"getVolume",value:function(){return this._volume}},{key:"setLoop",value:function(e){this._loop=e,this._sourceNode.loop=e}},{key:"getLoop",value:function(){return this._loop}},{key:"destroy",value:function(){f(o(t.prototype),"destroy",this).call(this)}},{key:"_doPlay",value:function(){var e=this;this._state=Dg.PLAYING,this._sourceNode=this._context.createBufferSource(),this._sourceNode.buffer=this._audio,this._sourceNode.loop=this._loop,this._sourceNode.connect(this._gainNode),this._startTime=this._context.currentTime,this._startInvoked=!1,cc.director.once(cc.Director.EVENT_AFTER_UPDATE,this._playAndEmit,this),clearInterval(this._currentTimer),this._currentTimer=window.setInterval((function(){e._onEnded(),clearInterval(e._currentTimer),e._sourceNode.loop&&(e._currentTimer=window.setInterval(e._onEndedCB,1e3*e._audio.duration))}),1e3*(this._audio.duration-this._offset))}},{key:"_doStop",value:function(){this._startInvoked?this._sourceNode.stop():cc.director.off(cc.Director.EVENT_AFTER_UPDATE,this._playAndEmit,this)}},{key:"_playAndEmit",value:function(){this._sourceNode.start(0,this._offset),this._eventTarget.emit("started"),this._startInvoked=!0}},{key:"_onEnded",value:function(){this._offset=0,this._startTime=this._context.currentTime,this._sourceNode.loop||(this._eventTarget.emit("ended"),this._state=Dg.STOPPED)}},{key:"_onGestureProceed",value:function(){this._interrupted&&(this._doPlay(),this._interrupted=!1),cc.game.canvas.removeEventListener("touchend",this._onGestureCB),cc.game.canvas.removeEventListener("mouseup",this._onGestureCB)}},{key:"_onGesture",value:function(){"running"!==this._context.state?this._context.resume().then(this._onGestureProceedCB):this._onGestureProceed()}}]),t}(Fg),Kg=dt({WEB_AUDIO:0,DOM_AUDIO:1,JSB_AUDIO:2,UNKNOWN_AUDIO:3}),Zg=(Ng=Es("cc.AudioClip"),zg=Ts({type:Kg}),Ng((jg=Wg=function(e){function t(){var e;return i(this,t),m(e=c(this,o(t).call(this)),"_duration",Vg,u(e)),m(e,"_loadMode",Hg,u(e)),e._audio=null,e._player=null,e.loaded=!1,e}return s(t,e),r(t,[{key:"destroy",value:function(){return this._player&&this._player.destroy(),f(o(t.prototype),"destroy",this).call(this)}},{key:"play",value:function(){this._player&&this._player.play()}},{key:"pause",value:function(){this._player&&this._player.pause()}},{key:"stop",value:function(){this._player&&this._player.stop()}},{key:"playOneShot",value:function(e){this._player&&this._player.playOneShot(e)}},{key:"setCurrentTime",value:function(e){this._player&&this._player.setCurrentTime(e)}},{key:"getCurrentTime",value:function(){return this._player?this._player.getCurrentTime():0}},{key:"getDuration",value:function(){return this._player?this._player.getDuration():this._duration}},{key:"setVolume",value:function(e,t){this._player&&this._player.setVolume(e,t||!1)}},{key:"getVolume",value:function(){return this._player?this._player.getVolume():1}},{key:"setLoop",value:function(e){this._player&&this._player.setLoop(e)}},{key:"getLoop",value:function(){return!!this._player&&this._player.getLoop()}},{key:"_getPlayer",value:function(e){var t;return"undefined"!=typeof AudioBuffer&&e instanceof AudioBuffer?(t=Yg,this._loadMode=Kg.WEB_AUDIO):(t=Xg,this._loadMode=Kg.DOM_AUDIO),t}},{key:"_nativeAsset",set:function(e){if(this._audio=e,e){var t=this._getPlayer(e);this._player=new t({clip:e,duration:this._duration,eventTarget:this}),this.loaded=!0,this.emit("load")}else this._player=null,this._loadMode=Kg.UNKNOWN_AUDIO,this._duration=0,this.loaded=!1},get:function(){return this._audio}},{key:"loadMode",get:function(){return this._loadMode}},{key:"state",get:function(){return this._player?this._player.getState():Dg.INITIALIZING}}]),t}(Tl),Wg.PlayingState=Dg,Wg.AudioType=Kg,Wg.preventDeferredLoadDependents=!0,Vg=v((Gg=jg).prototype,"_duration",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Hg=v(Gg.prototype,"_loadMode",[zg],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Kg.UNKNOWN_AUDIO}}),Ug=Gg))||Ug);cc.AudioClip=Zg;var Qg=Il.__audioSupport,Jg=Qg.format;function $g(e,t){var i=document.createElement("audio");i.src=e.url;var n=function(){clearTimeout(r),i.removeEventListener("canplaythrough",a,!1),i.removeEventListener("error",s,!1),Qg.USE_LOADER_EVENT&&i.removeEventListener(Qg.USE_LOADER_EVENT,a,!1)},r=setTimeout((function(){0===i.readyState?s():a()}),8e3),a=function(){n(),t(null,i)},s=function(){n();var i="load audio failure - "+e.url;R(i),t(i)};i.addEventListener("canplaythrough",a,!1),i.addEventListener("error",s,!1),Qg.USE_LOADER_EVENT&&i.addEventListener(Qg.USE_LOADER_EVENT,a,!1)}function ey(e,t){var i=Qg.context;i||t(new Error(W(4926)));var n=cc.loader.getXMLHttpRequest();n.open("GET",e.url,!0),n.responseType="arraybuffer",n.onload=function(){i.decodeAudioData(n.response,(function(e){t(null,e)}),(function(){t("decode error - "+e.id,null)}))},n.onerror=function(){t("request error - "+e.id,null)},n.send()}function ty(e,t){if(0===Jg.length)return new Error(W(4927));var i;Qg.WEB_AUDIO?i=e._owner instanceof Zg?e._owner.loadMode===Kg.WEB_AUDIO?ey:$g:e.urlParam&&e.urlParam.useDom?$g:ey:i=$g;i(e,t)}function iy(){return null}function ny(e,t,i){var n=e.url,r=document,a=document.createElement("script");function s(){a.parentNode&&a.parentNode.removeChild(a),a.removeEventListener("load",s,!1),a.removeEventListener("error",o,!1),t(null,n)}function o(){a.parentNode&&a.parentNode.removeChild(a),a.removeEventListener("load",s,!1),a.removeEventListener("error",o,!1),t(new Error(W(4928,n)))}a.async=!!i,a.src=jv(n),a.addEventListener("load",s,!1),a.addEventListener("error",o,!1),r.body.appendChild(a)}function ry(e,t,i,n){void 0===i&&(i=!0);var r=jv(e.url);function a(){n.removeEventListener("load",a),n.removeEventListener("error",s),n.id=e.id,t(null,n)}function s(){n.removeEventListener("load",a),n.removeEventListener("error",s),"https:"!==window.location.protocol&&n.crossOrigin&&"anonymous"===n.crossOrigin.toLowerCase()?ry(e,t,!1,n):t(new Error(W(4930,r)))}if(n=n||new Image,i&&"file:"!==window.location.protocol?n.crossOrigin="anonymous":n.crossOrigin=null,n.complete&&n.naturalWidth>0&&n.src===r)return n;n.addEventListener("load",a),n.addEventListener("error",s),n.src=r}var ay={js:ny,png:ry,jpg:ry,bmp:ry,jpeg:ry,gif:ry,ico:ry,tiff:ry,webp:ry,image:ry,pvr:Pg,pkm:Pg,mp3:ty,ogg:ty,wav:ty,m4a:ty,txt:Bg,xml:Bg,vsh:Bg,fsh:Bg,atlas:Bg,tmx:Bg,tsx:Bg,json:Bg,ExportJson:Bg,plist:Bg,fnt:Bg,font:iy,eot:iy,ttf:iy,woff:iy,svg:iy,ttc:iy,uuid:function(e,t){var i=ng(e,t);return void 0===i?this.extMap.json(e,t):i||void 0},binary:Pg,bin:Pg,default:Bg},sy=e("Downloader",function(){function e(t){i(this,e),this.id="Downloader",this.async=!0,this.pipeline=null,this._curConcurrent=0,this._loadQueue=[],this._subpackages={},this.extMap=Fe(t,ay)}return r(e,[{key:"addHandlers",value:function(e){Fe(this.extMap,e)}},{key:"_handleLoadQueue",value:function(){for(;this._curConcurrent<cc.macro.DOWNLOAD_MAX_CONCURRENT;){var e=this._loadQueue.shift();if(!e)break;var t=this.handle(e.item,e.callback);void 0!==t&&(t instanceof Error?e.callback(t):e.callback(null,t))}}},{key:"handle",value:function(e,t){var i=this,n=this.extMap[e.type]||this.extMap.default,r=void 0;if(this._curConcurrent<cc.macro.DOWNLOAD_MAX_CONCURRENT){if(this._curConcurrent++,void 0!==(r=n.call(this,e,(function(e,n){i._curConcurrent=Math.max(0,i._curConcurrent-1),i._handleLoadQueue(),t&&t(e,n)}))))return this._curConcurrent=Math.max(0,this._curConcurrent-1),this._handleLoadQueue(),r}else if(e.ignoreMaxConcurrency){if(void 0!==(r=n.call(this,e,t)))return r}else this._loadQueue.push({item:e,callback:t})}},{key:"loadSubpackage",value:function(e,t){var i=this._subpackages[e];i?i.loaded?t&&t():ny({url:i.path},(function(e){e||(i.loaded=!0),t&&t(e)})):t&&t(new Error("Can't find subpackage ".concat(e)))}}]),e}());sy.ID="Downloader",sy.PackDownloader=rg,Dv.Downloader=sy;var oy=new(function(e){function t(){return i(this,t),c(this,o(t).apply(this,arguments))}return s(t,e),r(t,[{key:"parse",value:function(e){var t=this._parseXML(e),i=t.documentElement;if("plist"!==i.tagName)return cc.warnID(5100),{};for(var n=null,r=0,a=i.childNodes.length;r<a&&1!==(n=i.childNodes[r]).nodeType;r++);return t=null,this._parseNode(n)}},{key:"_parseNode",value:function(e){var t=null,i=e.tagName;if("dict"===i)t=this._parseDict(e);else if("array"===i)t=this._parseArray(e);else if("string"===i)if(1===e.childNodes.length)t=e.firstChild.nodeValue;else{t="";for(var n=0;n<e.childNodes.length;n++)t+=e.childNodes[n].nodeValue}else"false"===i?t=!1:"true"===i?t=!0:"real"===i?t=parseFloat(e.firstChild.nodeValue):"integer"===i&&(t=parseInt(e.firstChild.nodeValue,10));return t}},{key:"_parseArray",value:function(e){for(var t=[],i=0,n=e.childNodes.length;i<n;i++){var r=e.childNodes[i];1===r.nodeType&&t.push(this._parseNode(r))}return t}},{key:"_parseDict",value:function(e){for(var t={},i=null,n=0,r=e.childNodes.length;n<r;n++){var a=e.childNodes[n];1===a.nodeType&&("key"===a.tagName?i=a.firstChild.nodeValue:t[i]=this._parseNode(a))}return t}}]),t}(function(){function e(){i(this,e),window.DOMParser?(this._isSupportDOMParser=!0,this._parser=new DOMParser):(this._isSupportDOMParser=!1,this._parser=null)}return r(e,[{key:"parse",value:function(e){return this._parseXML(e)}},{key:"_parseXML",value:function(e){var t;return this._isSupportDOMParser?t=this._parser.parseFromString(e,"text/xml"):((t=new ActiveXObject("Microsoft.XMLDOM")).async="false",t.loadXML(e)),t}}]),e}()));function ly(e){return e&&(e[0]&&"cc.Scene"===e[0].__type__||e[1]&&"cc.Scene"===e[1].__type__||e[0]&&"cc.Prefab"===e[0].__type__)}function uy(e,i){var n,r;if("string"==typeof e.content)try{if((n=JSON.parse(e.content)).keys&&n.data){var a=n.keys;Xv(n=n.data,a)}}catch(t){return new Error(W(4923,e.id,t.stack))}else{if("object"!==t(e.content))return new Error(W(4924));n=e.content}if(null==n)return new Error(W(4923,e.id));var s=ly(n);r=s?cc._MissingScript.safeFindClass:function(e){var t=qe(e);return t||(cc.warnID(4903,e),Object)};var o,l=cc.deserialize.Details.pool.get();try{o=cc.deserialize(n,l,{classFinder:r,target:e.existingAsset,customEnv:e})}catch(t){return cc.deserialize.Details.pool.put(l),console.error(t),new Error("Failed to load asset ".concat(e.id,", exception occurs during deserialization: ").concat(t.stack,"."))}o._uuid=e.uuid;var u=function(e,t,i){var n=t.deferredLoadRaw;return n?e instanceof cc.Asset&&e.constructor.preventDeferredLoadDependents&&(n=!1):i&&(e instanceof cc.SceneAsset||e instanceof cc.Prefab)&&(n=e.asyncLoadAssets),n}(o,e,s),c=function(e,t,i,n){var r,a,s,o=i.uuidList,l=i.uuidObjList,u=i.uuidPropList,c=i._stillUseUrl,h=e.dependKeys=[];if(n)for(r=[],a=0;a<o.length;a++){s=o[a];var f=l[a],_=u[a],d=cc.AssetLibrary._getAssetInfoInRuntime(s);if(d.raw){var p=d.url;f[_]=p,h.push(p)}else r.push({type:"uuid",uuid:s,deferredLoadRaw:!0,_owner:f,_ownerProp:_,_stillUseUrl:c[a]})}else{for(r=new Array(o.length),a=0;a<o.length;a++)s=o[a],r[a]={type:"uuid",uuid:s,_owner:l[a],_ownerProp:u[a],_stillUseUrl:c[a]};t._native&&!t.constructor.preventPreloadNativeObject&&r.push({url:t.nativeUrl,_owner:t,_ownerProp:"_nativeAsset"})}return r}(e,o,l,u);cc.deserialize.Details.pool.put(l);var h=function(e,t){if(!e&&t.onLoaded)try{t.onLoaded()}catch(t){e=t}i(e,t)};if(0===c.length)return h(null,o);!function(e,t,i,n,r){t.content=i;var a=t.dependKeys;e.flowInDeps(t,n,(function(e,t){var s,o=t.map;for(var l in o)(s=o[l]).uuid&&s.content&&(s.content._uuid=s.uuid);for(var u=0;u<n.length;u++){var c=function(e){var t=e.content;this._stillUseUrl&&(t=t?t.nativeUrl:e.rawUrl),this._owner[this._ownerProp]=t,e.uuid!==i._uuid&&a.indexOf(e.id)<0&&a.push(e.id)},h=n[u],f=h.uuid,_=h.url;h._owner,h._ownerProp;if(s=o[_]){var d=h;if(s.complete||s.content){if(s.error)cc._throw(s.error);else c.call(d,s)}else{var p=Lv.getQueue(s),m=p._callbackTable[f];m?m.unshift(c,d):p.addListener(f,c,d)}}}r(e,i)}))}(this.pipeline,e,o,c,h)}uy.isSceneObj=ly;var cy=null,hy={},fy=-1,_y=[];function dy(){for(var e=!0,t=Date.now(),i=_y.length-1;i>=0;i--){var n=_y[i],r=n.fontFamilyName;if(t-n.startTime>6e4)cc.warnID(4933,r),n.callback(null,r),_y.splice(i,1);else{var a=n.refWidth;cy.font="40px "+r,a!==ss(cy,"BES bswy:->@")?(_y.splice(i,1),n.callback(null,r)):e=!1}}e&&(clearInterval(fy),fy=-1)}function py(e,t){var i=e.url,n=function(e){var t=e.lastIndexOf(".ttf");if(-1===t)return e;var i,n=e.lastIndexOf("/");i=-1===n?e.substring(0,t)+"_LABEL":e.substring(n+1,t)+"_LABEL";-1!==i.indexOf(" ")&&(i='"'+i+'"');return i}(i);if(hy[n])return n;if(!cy){var r=document.createElement("canvas");r.width=100,r.height=100,cy=r.getContext("2d")}var a="40px "+n;cy.font=a;var s=ss(cy,"BES bswy:->@"),o=document.createElement("style");o.type="text/css";var l="";isNaN(n-0)?l+="@font-face { font-family:"+n+"; src:":l+="@font-face { font-family:'"+n+"'; src:",l+="url('"+i+"');",o.textContent=l+"}",document.body.appendChild(o);var u=document.createElement("div"),c=u.style;c.fontFamily=n,u.innerHTML=".",c.position="absolute",c.left="-100px",c.top="-100px",document.body.appendChild(u);var h={fontFamilyName:n,refWidth:s,callback:t,startTime:Date.now()};_y.push(h),hy[n]=o,-1===fy&&(fy=setInterval(dy,100))}function my(e){if("string"!=typeof e.content)return new Error("JSON Loader: Input item doesn't contain string content");try{return JSON.parse(e.content)}catch(t){return new Error("JSON Loader: Parse json ["+e.id+"] failed : "+t)}}function vy(e){if(e._owner instanceof cc.Asset)return null;var t=e.content;if(cc.sys.platform!==cc.sys.FB_PLAYABLE_ADS&&!(t instanceof Image))return new Error("Image Loader: Input item doesn't contain Image content");var i=e.rawUrl,n=e.imageAsset||new Ju;return n._uuid=e.uuid,n._url=i,n._setRawAsset(i,!1),n._nativeAsset=t,n}function gy(e,t){if(e._owner instanceof cc.Asset)return null;var i=new cc.AudioClip;return i._setRawAsset(e.rawUrl,!1),i._nativeAsset=e.content,i}function yy(e){return e.load?e.load(e.content):e.content}function by(e,t){return e[t]<<8|e[t+1]}var Ey={png:vy,jpg:vy,bmp:vy,jpeg:vy,gif:vy,ico:vy,tiff:vy,webp:vy,image:vy,pvr:function(e){var t=e.content instanceof ArrayBuffer?e.content:e.content.buffer,i=new Int32Array(t,0,13);if(55727696===i[0]){var n=i[7],r=i[6],a=i[12]+52;return t=t.slice(a,t.byteLength),{_data:new Uint8Array(t),_compressed:!0,width:n,height:r}}if(559044176===i[11]){var s=i[0],o=i[1],l=i[2];return t=t.slice(s,t.byteLength),{_data:new Uint8Array(t),_compressed:!0,width:l,height:o}}return new Error("Invalid magic number in PVR header")},pkm:function(e){var t=e.content instanceof ArrayBuffer?e.content:e.content.buffer,i=new Uint8Array(t),n=by(i,6);if(0!==n&&1!==n&&3!==n)return new Error("Invalid magic number in ETC header");var r=by(i,12),a=by(i,14);return by(i,8),by(i,10),t=t.slice(16,t.byteLength),{_data:new Uint8Array(t),_compressed:!0,width:r,height:a}},mp3:gy,ogg:gy,wav:gy,m4a:gy,json:my,ExportJson:my,plist:function(e){if("string"!=typeof e.content)return new Error("Plist Loader: Input item doesn't contain string content");var t=oy.parse(e.content);return t||new Error("Plist Loader: Parse ["+e.id+"] failed")},uuid:uy,prefab:uy,fire:uy,scene:uy,binary:yy,bin:yy,font:py,eot:py,ttf:py,woff:py,svg:py,ttc:py,default:function(){return null}},Ty=e("Loader",function(){function e(t){i(this,e),this.id="Loader",this.async=!0,this.pipeline=null,this.extMap=Fe(t,Ey)}return r(e,[{key:"addHandlers",value:function(e){this.extMap=Fe(this.extMap,e)}},{key:"handle",value:function(e,t){return(this.extMap[e.type]||this.extMap.default).call(this,e,t)}}]),e}());Ty.ID="Loader",Dv.Loader=Ty;var Sy=Object.create(null);function xy(){return window.XMLHttpRequest?new window.XMLHttpRequest:new ActiveXObject("MSXML2.XMLHTTP")}Sy.assets=new gv,Sy.internal=new gv;var Ay={url:null,raw:!1};function wy(e){var i,n,r;if("object"===t(e)){if(n=e,e.url)return n;i=e.uuid}else n={},i=e;return r=n.type?"uuid"===n.type:cc.AssetLibrary._uuidInSettings(i),cc.AssetLibrary._getAssetInfoInRuntime(i,Ay),n.url=r?Ay.url:i,Ay.url&&"uuid"===n.type&&Ay.raw?(n.type=null,n.isRawAsset=!0):r||(n.isRawAsset=!0),n}var Cy=[],Ry=[],ky=function(e){function n(){var e;i(this,n);var t=new Lg,r=new sy,a=new Ty;return(e=c(this,o(n).call(this,[t,r,a]))).getXMLHttpRequest=xy,e.assetLoader=t,e.md5Pipe=null,e.downloader=r,e.loader=a,e.onProgress=null,e._assetTables=Sy,e._autoReleaseSetting=we(!0),e}return s(n,e),r(n,[{key:"init",value:function(e){}},{key:"addDownloadHandlers",value:function(e){this.downloader.addHandlers(e)}},{key:"addLoadHandlers",value:function(e){this.loader.addHandlers(e)}},{key:"load",value:function(e,t,i){void 0===i&&(i=t,t=this.onProgress||null);var n,r=this,a=!1;e instanceof Array||(e?(a=!0,e=[e]):e=[]),Cy.length=0;for(var s=0;s<e.length;++s){var o=e[s];if(o&&o.id&&(cc.warnID(4920,o.id),o.uuid||o.url||(o.url=o.id)),(n=wy(o)).url||n.uuid){var l=this._cache[n.url];Cy.push(l||n)}}var u=Lv.create(this,t,(function(e,t){ut((function(){if(i){if(a){var s=n.url;i.call(r,t.getError(s),t.getContent(s))}else i.call(r,e,t);i=null}t.destroy()}))}));Lv.initQueueDeps(u),u.append(Cy),Cy.length=0}},{key:"flowInDeps",value:function(e,t,i){Ry.length=0;for(var n=0;n<t.length;++n){var r=wy(t[n]);if(r.url||r.uuid){var a=this._cache[r.url];a?Ry.push(a):Ry.push(r)}}var s=Lv.create(this,e?function(e,t,i){s._ownerQueue&&s._ownerQueue.onProgress&&s._ownerQueue._childOnProgress(i)}:null,(function(t,n){i(t,n),e&&e.deps&&(e.deps.length=0),n.destroy()}));if(e){var o=Lv.getQueue(e);s._ownerQueue=o&&o._ownerQueue||o}var l=s.append(Ry,e);return Ry.length=0,l}},{key:"loadRes",value:function(e,t,i,n,r){5!==arguments.length&&(r=n,n=i,i="assets");var a=this._parseLoadResArgs(t,n,r);t=a.type,n=a.onProgress,r=a.onComplete;var s=this,o=s._getResUuid(e,t,i,!0);o?this.load({type:"uuid",uuid:o},n,(function(e,t){t&&s.setAutoReleaseRecursively(o,!1),r&&r(e,t)})):s._urlNotFound(e,t,r)}},{key:"loadResDir",value:function(e,t,i,n,r){if(5!==arguments.length&&(r=n,n=i,i="assets"),Sy[i]){var a=this._parseLoadResArgs(t,n,r);t=a.type,n=a.onProgress,r=a.onComplete;var s=[],o=Sy[i].getUuidArray(e,t,s);this._loadResUuids(o,n,(function(e,t,i){for(var n=t.length,a=0;a<n;++a)if(t[a]instanceof cc.SpriteAtlas){var s=t[a].getSpriteFrames();for(var o in s){var l=s[o];t.push(l),i&&i.push("".concat(i[a],"/").concat(l.name))}}r&&r(e,t,i)}),s)}}},{key:"loadResArray",value:function(e,t,i,n,r){5!==arguments.length&&(r=n,n=i,i="assets");var a=this._parseLoadResArgs(t,n,r);t=a.type,n=a.onProgress,r=a.onComplete;for(var s=[],o=0;o<e.length;o++){var l=e[o],u=this._getResUuid(l,t,i,!0);if(!u)return void this._urlNotFound(l,t,r);s.push(u)}this._loadResUuids(s,n,r)}},{key:"getRes",value:function(e,t){var i=this._cache[e];if(!i){var n=this._getResUuid(e,t,null,!0);if(!n)return null;var r=this._getReferenceKey(n);i=this._cache[r]}return i&&i.alias&&(i=i.alias),i&&i.complete?i.content:null}},{key:"getResCount",value:function(){return Object.keys(this._cache).length}},{key:"getDependsRecursively",value:function(e){if(e){var t=this._getReferenceKey(e),i=Sv(t);return i.push(t),i}return[]}},{key:"release",value:function(e){if(Array.isArray(e))for(var t=0;t<e.length;t++){var i=e[t];this.release(i)}else if(e){var n=this._getReferenceKey(e),r=this.getItem(n);if(r){this.removeItem(n);if((e=r.content)instanceof cc.Asset){var a=e.nativeUrl;a&&this.release(a),e.destroy()}0}}}},{key:"releaseAsset",value:function(e){var t=e._uuid;t&&this.release(t)}},{key:"releaseRes",value:function(e,t,i){var n=this._getResUuid(e,t,i,!0);n?this.release(n):cc.errorID(4914,e)}},{key:"releaseResDir",value:function(e,t,i){if(Sy[i=i||"assets"])for(var n=Sy[i].getUuidArray(e,t),r=0;r<n.length;r++){var a=n[r];this.release(a)}}},{key:"releaseAll",value:function(){for(var e in this._cache)this.release(e)}},{key:"removeItem",value:function(e){var t=Dv.prototype.removeItem.call(this,e);return delete this._autoReleaseSetting[e],t}},{key:"setAutoRelease",value:function(e,t){var i=this._getReferenceKey(e);i&&(this._autoReleaseSetting[i]=!!t)}},{key:"setAutoReleaseRecursively",value:function(e,t){t=!!t;var i=this._getReferenceKey(e);if(i){this._autoReleaseSetting[i]=t;for(var n=Sv(i),r=0;r<n.length;r++){var a=n[r];this._autoReleaseSetting[a]=t}}else 0}},{key:"isAutoRelease",value:function(e){var t=this._getReferenceKey(e);return!!t&&!!this._autoReleaseSetting[t]}},{key:"_getResUuid",value:function(e,t,i,n){var r="",a=Sy[i=i||"assets"];if(e&&a){var s=e.indexOf("?");if(-1!==s&&(e=e.substr(0,s)),!(r=a.getUuid(e,t))){var o=cc.path.extname(e);o&&(e=e.slice(0,-o.length),(r=a.getUuid(e,t))&&!n&&cc.warnID(4901,e,o))}}return!r&&t&&(Ue(t,Yc)||Ue(t,Uc)||Ue(t,Zc))&&cc.warnID(4934),r}},{key:"_getReferenceKey",value:function(e){var i;return"object"===t(e)?i=e._uuid||null:"string"==typeof e&&(i=this._getResUuid(e,null,null,!0)||e),i?(cc.AssetLibrary._getAssetInfoInRuntime(i,Ay),this._cache[Ay.url]?Ay.url:i):(cc.warnID(4800,e),i)}},{key:"_urlNotFound",value:function(e,t,i){ut((function(){e=cc.url.normalize(e);var n="".concat(t?Ce(t):"Asset",' in "resources/').concat(e,'" does not exist.');i&&i(new Error(n),[])}))}},{key:"_parseLoadResArgs",value:function(e,t,i){if(void 0===i){var n=Ue(e,cc.RawAsset);t?(i=t,n&&(t=this.onProgress||null)):void 0!==t||n||(i=e,t=this.onProgress||null,e=null),void 0===t||n||(t=e,e=null)}return{type:e,onProgress:t,onComplete:i}}},{key:"_loadResUuids",value:function(e,t,i,n){if(e.length>0){var r=this,a=e.map((function(e){return{type:"uuid",uuid:e}}));this.load(a,t,(function(e,t){if(i){for(var s=[],o=n&&[],l=0;l<a.length;++l){var u=a[l].uuid,c=r._getReferenceKey(u),h=t.getContent(c);h&&(r.setAutoReleaseRecursively(u,!1),s.push(h),o&&o.push(n[l]))}n?i(e,s,o):i(e,s)}}))}else i&&ut((function(){n?i(null,[],[]):i(null,[])}))}}]),n}(Dv),Oy=e("loader",cc.loader=new ky);var Iy,My,Ly,Py,By,Dy,Fy,Ny,zy=Object.freeze({__proto__:null,loadImage:function(e,t,i){H(!!e,3103);var n=Oy.getRes(e);return n?n.loaded?(t&&t.call(i,null,n),n):(n.once("load",(function(){t&&t.call(i,null,n)}),i),n):(n=new Ju,Oy.load({url:e,imageAsset:n},(function(e,r){if(e)return t&&t.call(i,e||new Error("Unknown error")),n;t&&t.call(i,null,r)})),n)},cacheImage:function(e,t){if(e&&t){var i=new Ju(t),n={id:e,url:e,error:null,content:i,complete:!1};return Oy.flowOut(n),i}},postLoadImage:function(e,t){e.loaded?t&&t():e.nativeUrl?Oy.load({url:e.nativeUrl,skips:e.isCompressed?void 0:["Loader"]},(function(i,n){n&&(e.loaded||(e._nativeAsset=n)),t&&t(i)})):t&&t()}});e("textureUtil",zy);var Uy,Gy,Vy,Hy,Wy=e("Skeleton",(Iy=Es("cc.Skeleton"),My=Ts([Ct]),Ly=Ts([Bn]),Iy((Dy=v((By=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),s=0;s<r;s++)a[s]=arguments[s];return m(n=c(this,(e=o(t)).call.apply(e,[this].concat(a))),"_joints",Dy,u(n)),m(n,"_bindposes",Fy,u(n)),m(n,"_hash",Ny,u(n)),n}return s(t,e),r(t,[{key:"destroy",value:function(){return cc.director.root.dataPoolManager.releaseSkeleton(this),f(o(t.prototype),"destroy",this).call(this)}},{key:"bindposes",get:function(){return this._bindposes},set:function(e){this._bindposes=e}},{key:"joints",get:function(){return this._joints},set:function(e){this._joints=e}},{key:"hash",get:function(){if(!this._hash){for(var e="",t=0;t<this._bindposes.length;t++){var i=this._bindposes[t];e+=i.m00.toPrecision(2)+" "+i.m01.toPrecision(2)+" "+i.m02.toPrecision(2)+" "+i.m03.toPrecision(2)+" "+i.m04.toPrecision(2)+" "+i.m05.toPrecision(2)+" "+i.m06.toPrecision(2)+" "+i.m07.toPrecision(2)+" "+i.m08.toPrecision(2)+" "+i.m09.toPrecision(2)+" "+i.m10.toPrecision(2)+" "+i.m11.toPrecision(2)+" "+i.m12.toPrecision(2)+" "+i.m13.toPrecision(2)+" "+i.m14.toPrecision(2)+" "+i.m15.toPrecision(2)+"\n"}this._hash=Jo(e,666)}return this._hash}}]),t}(Tl)).prototype,"_joints",[My],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Fy=v(By.prototype,"_bindposes",[Ly],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ny=v(By.prototype,"_hash",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Py=By))||Py));cc.Skeleton=Wy,function(e){e[e.ORTHO=0]="ORTHO",e[e.PERSPECTIVE=1]="PERSPECTIVE"}(Uy||(Uy={})),function(e){e[e.F1_8=0]="F1_8",e[e.F2_0=1]="F2_0",e[e.F2_2=2]="F2_2",e[e.F2_5=3]="F2_5",e[e.F2_8=4]="F2_8",e[e.F3_2=5]="F3_2",e[e.F3_5=6]="F3_5",e[e.F4_0=7]="F4_0",e[e.F4_5=8]="F4_5",e[e.F5_0=9]="F5_0",e[e.F5_6=10]="F5_6",e[e.F6_3=11]="F6_3",e[e.F7_1=12]="F7_1",e[e.F8_0=13]="F8_0",e[e.F9_0=14]="F9_0",e[e.F10_0=15]="F10_0",e[e.F11_0=16]="F11_0",e[e.F13_0=17]="F13_0",e[e.F14_0=18]="F14_0",e[e.F16_0=19]="F16_0",e[e.F18_0=20]="F18_0",e[e.F20_0=21]="F20_0",e[e.F22_0=22]="F22_0"}(Gy||(Gy={})),function(e){e[e.ISO100=0]="ISO100",e[e.ISO200=1]="ISO200",e[e.ISO400=2]="ISO400",e[e.ISO800=3]="ISO800"}(Vy||(Vy={})),function(e){e[e.D1=0]="D1",e[e.D2=1]="D2",e[e.D4=2]="D4",e[e.D8=3]="D8",e[e.D15=4]="D15",e[e.D30=5]="D30",e[e.D60=6]="D60",e[e.D125=7]="D125",e[e.D250=8]="D250",e[e.D500=9]="D500",e[e.D1000=10]="D1000",e[e.D2000=11]="D2000",e[e.D4000=12]="D4000"}(Hy||(Hy={}));var jy,Xy,qy,Yy,Ky,Zy,Qy,Jy,$y,eb,tb,ib,nb,rb,ab,sb,ob,lb,ub,cb,hb,fb,_b,db,pb,mb,vb,gb,yb,bb,Eb,Tb,Sb,xb,Ab,wb,Cb,Rb,kb=[1.8,2,2.2,2.5,2.8,3.2,3.5,4,4.5,5,5.6,6.3,7.1,8,9,10,11,13,14,16,18,20,22],Ob=[1,.5,.25,1/8,1/15,1/30,1/60,.008,.004,.002,.001,5e-4,25e-5],Ib=[100,200,400,800],Mb=new zi,Lb=new zi,Pb=new Bn,Bb=new Bn,Db=Bo.STENCIL<<1,Fb=function(){function e(){i(this,e),this._scene=null,this._name=null,this._enabled=!1,this._proj=-1,this._isWindowSize=!0,this._orthoHeight=10,this._fov=mi(45),this._nearClip=1,this._farClip=1e3,this._clearStencil=0,this._clearDepth=1,this._clearFlag=Bo.NONE,this._clearColor={r:0,g:0,b:0,a:0},this._viewport=new Jn(0,0,1,1),this._isProjDirty=!0,this._matView=new Bn,this._matViewInv=null,this._matProj=new Bn,this._matProjInv=new Bn,this._matViewProj=new Bn,this._matViewProjInv=new Bn,this._frustum=new Wa,this._forward=new zi,this._position=new zi,this._node=null,this._view=null,this._visibility=ku,this._priority=0,this._aperture=Gy.F16_0,this._shutter=Hy.D125,this._shutterValue=0,this._iso=Vy.ISO100,this._isoValue=0,this._ec=0,this._exposure=0,this._apertureValue=kb[this._aperture],this._shutterValue=Ob[this._shutter],this._isoValue=Ib[this._iso],this.updateExposure(),this._aspect=this._width=this._height=this._screenScale=1}return r(e,[{key:"initialize",value:function(e){this._name=e.name,this._node=e.node,this._proj=e.projection,this._priority=e.priority||0,this._view=cc.director.root.createView({camera:this,name:this._name,priority:this._priority,flows:e.flows}),this.changeTargetWindow(e.window),console.log("Created Camera: "+this._name+" "+this._width+"x"+this._height)}},{key:"destroy",value:function(){cc.director.root.destroyView(this._view),this._view=null,this._name=null}},{key:"attachToScene",value:function(e){this._scene=e,this._view&&this._view.enable(!0)}},{key:"detachFromScene",value:function(){this._scene=null,this._view&&this._view.enable(!1)}},{key:"resize",value:function(e,t){this._width=e,this._height=t,this._aspect=this._width/this._height,this._isProjDirty=!0}},{key:"setFixedSize",value:function(e,t){this._width=e,this._height=t,this._aspect=this._width/this._height,this._isWindowSize=!1}},{key:"update",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(this._node){if((this._node.hasChangedFlags||e)&&(Bn.invert(this._matView,this.node.worldMatrix),this._forward.x=-this._matView.m02,this._forward.y=-this._matView.m06,this._forward.z=-this._matView.m10,this._node.getWorldPosition(this._position)),this._isProjDirty){if(this._proj===Uy.PERSPECTIVE)Bn.perspective(this._matProj,this._fov,this._aspect,this._nearClip,this._farClip);else{var t=this._orthoHeight*this._aspect,i=this._orthoHeight;Bn.ortho(this._matProj,-t,t,-i,i,this._nearClip,this._farClip)}Bn.invert(this._matProjInv,this._matProj)}(this._node.hasChangedFlags||this._isProjDirty||e)&&(Bn.multiply(this._matViewProj,this._matProj,this._matView),Bn.invert(this._matViewProjInv,this._matViewProj),this._frustum.update(this._matViewProj,this._matViewProjInv)),this._isProjDirty=!1}}},{key:"getSplitFrustum",value:function(e,t,i){if(this._node){if(t=Math.max(t,this._nearClip),i=Math.min(i,this._farClip),Bn.invert(this._matView,this.node.worldMatrix),this._proj===Uy.PERSPECTIVE)Bn.perspective(Pb,this._fov,this._aspect,t,i);else{var n=this._orthoHeight*this._aspect,r=this._orthoHeight;Bn.ortho(Pb,-n,n,-r,r,t,i)}Bn.multiply(Bb,Pb,this._matView),Bn.invert(Pb,Bb),e.update(Bb,Pb)}}},{key:"changeTargetWindow",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=e||cc.director.root.mainWindow;t&&this._view&&(this._view.window=t,this.resize(t.width,t.height))}},{key:"screenPointToRay",value:function(e,t,i){var n=this._viewport.x*this._width,r=this._viewport.y*this._height,a=this._viewport.width*this._width,s=this._viewport.height*this._height;return zi.set(Mb,(t-n)/a*2-1,(i-r)/s*2-1,1),zi.transformMat4(Mb,Mb,this._matViewProjInv),this._proj===Uy.PERSPECTIVE?this._node&&this._node.getWorldPosition(Lb):(zi.set(Lb,(t-n)/a*2-1,(i-r)/s*2-1,-1),zi.transformMat4(Lb,Lb,this._matViewProjInv)),Cr.fromPoints(e,Lb,Mb)}},{key:"screenToWorld",value:function(e,t){var i=this._viewport.x*this._width,n=this._viewport.y*this._height,r=this._viewport.width*this._width,a=this._viewport.height*this._height;return this._proj===Uy.PERSPECTIVE?(zi.set(e,(t.x-i)/r*2-1,(t.y-n)/a*2-1,1),zi.transformMat4(e,e,this._matViewProjInv),this._node&&this._node.getWorldPosition(Mb),zi.lerp(e,Mb,e,pi(this._nearClip/this._farClip,1,t.z))):(zi.set(e,(t.x-i)/r*2-1,(t.y-n)/a*2-1,2*t.z-1),zi.transformMat4(e,e,this.matViewProjInv)),e}},{key:"worldToScreen",value:function(e,t){var i=this._viewport.x*this._width,n=this._viewport.y*this._height,r=this._viewport.width*this._width,a=this._viewport.height*this._height;return zi.transformMat4(e,t,this.matViewProj),e.x=i+.5*(e.x+1)*r,e.y=n+.5*(e.y+1)*a,e.z=.5*e.z+.5,e}},{key:"updateExposure",value:function(){var e=Math.log2(this._apertureValue*this._apertureValue/this._shutterValue*100/this._isoValue);this._exposure=.833333/Math.pow(2,e)}},{key:"screenScale",set:function(e){this._screenScale=e},get:function(){return this._screenScale}},{key:"enabled",set:function(e){this._enabled=e,this._view&&this._view.enable(e)},get:function(){return this._enabled}},{key:"view",get:function(){return this._view}},{key:"node",set:function(e){this._node=e},get:function(){return this._node}},{key:"isWindowSize",get:function(){return this._isWindowSize},set:function(e){this._isWindowSize=e}},{key:"orthoHeight",set:function(e){this._orthoHeight=e,this._isProjDirty=!0},get:function(){return this._orthoHeight}},{key:"projectionType",set:function(e){this._proj=e,this._isProjDirty=!0},get:function(){return this._proj}},{key:"viewport",set:function(e){this._viewport=e},get:function(){return this._viewport}},{key:"fov",set:function(e){this._fov=e,this._isProjDirty=!0},get:function(){return this._fov}},{key:"nearClip",set:function(e){this._nearClip=e,this._isProjDirty=!0},get:function(){return this._nearClip}},{key:"farClip",set:function(e){this._farClip=e,this._isProjDirty=!0},get:function(){return this._farClip}},{key:"clearColor",set:function(e){this._clearColor.r=e.r,this._clearColor.g=e.g,this._clearColor.b=e.b,this._clearColor.a=e.a},get:function(){return this._clearColor}},{key:"clearDepth",set:function(e){this._clearDepth=e},get:function(){return this._clearDepth}},{key:"clearStencil",set:function(e){this._clearStencil=e},get:function(){return this._clearStencil}},{key:"clearFlag",set:function(e){this._clearFlag=e},get:function(){return this._clearFlag}},{key:"scene",get:function(){return this._scene}},{key:"name",get:function(){return this._name}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"aspect",get:function(){return this._aspect}},{key:"matView",set:function(e){this._matView=e},get:function(){return this._matView}},{key:"matViewInv",set:function(e){this._matViewInv=e},get:function(){return this._matViewInv||this._node.worldMatrix}},{key:"matProj",set:function(e){this._matProj=e},get:function(){return this._matProj}},{key:"matProjInv",set:function(e){this._matProjInv=e},get:function(){return this._matProjInv}},{key:"matViewProj",set:function(e){this._matViewProj=e},get:function(){return this._matViewProj}},{key:"matViewProjInv",set:function(e){this._matViewProjInv=e},get:function(){return this._matViewProjInv}},{key:"frustum",set:function(e){this._frustum=e},get:function(){return this._frustum}},{key:"forward",set:function(e){this._forward=e},get:function(){return this._forward}},{key:"position",set:function(e){this._position=e},get:function(){return this._position}},{key:"visibility",set:function(e){this._visibility=e,this._view&&(this._view.visibility=e)},get:function(){return this._visibility}},{key:"priority",get:function(){return this._view?this._view.priority:-1},set:function(e){this._priority=e,this._view&&(this._view.priority=this._priority)}},{key:"aperture",set:function(e){this._aperture=e,this._apertureValue=kb[this._aperture],this.updateExposure()},get:function(){return this._aperture}},{key:"apertureValue",get:function(){return this._apertureValue}},{key:"shutter",set:function(e){this._shutter=e,this._shutterValue=Ob[this._shutter],this.updateExposure()},get:function(){return this._shutter}},{key:"shutterValue",get:function(){return this._shutterValue}},{key:"iso",set:function(e){this._iso=e,this._isoValue=Ib[this._iso],this.updateExposure()},get:function(){return this._iso}},{key:"isoValue",get:function(){return this._isoValue}},{key:"ec",set:function(e){this._ec=e},get:function(){return this._ec}},{key:"exposure",get:function(){return this._exposure}},{key:"flows",set:function(e){this._view&&this._view.setExecuteFlows(e)}}]),e}(),Nb=function(){function e(t){i(this,e),this._enabled=!0,this._skyColor=Float32Array.from([.2,.5,.8,1]),this._skyIllum=e.SKY_ILLUM,this._groundAlbedo=Float32Array.from([.2,.2,.2,1]),this._scene=t}return r(e,[{key:"enabled",set:function(e){this._enabled=e},get:function(){return this._enabled}},{key:"skyColor",get:function(){return this._skyColor},set:function(e){this._skyColor=e}},{key:"skyIllum",set:function(e){this._skyIllum=e},get:function(){return this._skyIllum}},{key:"groundAlbedo",get:function(){return this._groundAlbedo},set:function(e){this._groundAlbedo=e}}]),r(e,[{key:"update",value:function(){}}]),e}();Nb.SUN_ILLUM=65e3,Nb.SKY_ILLUM=2e4;var zb=new zi(0,1,0),Ub=new zi,Gb=new fn,Vb=(jy=Es("cc.AmbientInfo"),Xy=Ts({type:rr}),qy=Ts({type:rr}),jy((Zy=v((Ky=function(){function e(){i(this,e),m(this,"_skyColor",Zy,this),m(this,"_skyIllum",Qy,this),m(this,"_groundAlbedo",Jy,this),this._resource=null}return r(e,[{key:"skyColor",set:function(e){this._skyColor.set(e),this._resource&&rr.toArray(this._resource.skyColor,this.skyColor)},get:function(){return this._skyColor}},{key:"skyIllum",set:function(e){this._skyIllum=e,this._resource&&(this._resource.skyIllum=this.skyIllum)},get:function(){return this._skyIllum}},{key:"groundAlbedo",set:function(e){this._groundAlbedo.set(e),this._resource&&zi.toArray(this._resource.groundAlbedo,this.groundAlbedo)},get:function(){return this._groundAlbedo}},{key:"renderScene",set:function(e){this._resource=e.ambient,this.skyColor=this._skyColor,this.skyIllum=this._skyIllum,this.groundAlbedo=this._groundAlbedo}}]),e}()).prototype,"_skyColor",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rr(51,128,204,1)}}),Qy=v(Ky.prototype,"_skyIllum",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Nb.SKY_ILLUM}}),Jy=v(Ky.prototype,"_groundAlbedo",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rr(51,51,51,255)}}),v(Ky.prototype,"skyColor",[Xy],Object.getOwnPropertyDescriptor(Ky.prototype,"skyColor"),Ky.prototype),v(Ky.prototype,"skyIllum",[Bs],Object.getOwnPropertyDescriptor(Ky.prototype,"skyIllum"),Ky.prototype),v(Ky.prototype,"groundAlbedo",[qy],Object.getOwnPropertyDescriptor(Ky.prototype,"groundAlbedo"),Ky.prototype),Yy=Ky))||Yy);cc.AmbientInfo=Vb;var Hb=($y=Es("cc.SkyboxInfo"),eb=Ts(Zc),tb=Ts({type:wt}),ib=Ts({type:wt}),nb=Ts({type:Zc}),rb=Ts({type:wt}),$y((ob=v((sb=function(){function e(){i(this,e),m(this,"_envmap",ob,this),m(this,"_isRGBE",lb,this),m(this,"_enabled",ub,this),m(this,"_useIBL",cb,this),this._resource=null}return r(e,[{key:"enabled",set:function(e){this._enabled=e,this._resource&&(this._resource.enabled=this._enabled)},get:function(){return this._enabled}},{key:"useIBL",set:function(e){this._useIBL=e,this._resource&&(this._resource.useIBL=this._useIBL)},get:function(){return this._useIBL}},{key:"envmap",set:function(e){this._envmap=e,this._resource&&(this._resource.envmap=this._envmap)},get:function(){return this._envmap}},{key:"isRGBE",set:function(e){this._isRGBE=e,this._resource&&(this._resource.isRGBE=this._isRGBE)},get:function(){return this._isRGBE}},{key:"renderScene",set:function(e){this._resource=e.skybox,this.isRGBE=this._isRGBE,this.envmap=this._envmap,this.enabled=this._enabled,this.useIBL=this._useIBL}}]),e}()).prototype,"_envmap",[eb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lb=v(sb.prototype,"_isRGBE",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ub=v(sb.prototype,"_enabled",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),cb=v(sb.prototype,"_useIBL",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),v(sb.prototype,"enabled",[tb],Object.getOwnPropertyDescriptor(sb.prototype,"enabled"),sb.prototype),v(sb.prototype,"useIBL",[ib],Object.getOwnPropertyDescriptor(sb.prototype,"useIBL"),sb.prototype),v(sb.prototype,"envmap",[nb],Object.getOwnPropertyDescriptor(sb.prototype,"envmap"),sb.prototype),v(sb.prototype,"isRGBE",[rb],Object.getOwnPropertyDescriptor(sb.prototype,"isRGBE"),sb.prototype),ab=sb))||ab);cc.SkyboxInfo=Hb;var Wb=(hb=Es("cc.PlanarShadowInfo"),fb=Ts({type:wt}),_b=Ts({type:zi}),db=Ts({type:At}),pb=Ts({type:rr}),hb((gb=v((vb=function(){function e(){i(this,e),m(this,"_enabled",gb,this),m(this,"_normal",yb,this),m(this,"_distance",bb,this),m(this,"_shadowColor",Eb,this),this._resource=null}return r(e,[{key:"setPlaneFromNode",value:function(e){e.getWorldRotation(Gb),this.normal=zi.transformQuat(Ub,zb,Gb),e.getWorldPosition(Ub),this.distance=zi.dot(this._normal,Ub)}},{key:"enabled",set:function(e){this._enabled=e,this._resource&&(this._resource.enabled=e)},get:function(){return this._enabled}},{key:"normal",set:function(e){zi.copy(this._normal,e),this._resource&&(this._resource.normal=e)},get:function(){return this._normal}},{key:"distance",set:function(e){this._distance=e,this._resource&&(this._resource.distance=e)},get:function(){return this._distance}},{key:"shadowColor",set:function(e){this._shadowColor.set(e),this._resource&&(this._resource.shadowColor=e)},get:function(){return this._shadowColor}},{key:"renderScene",set:function(e){this._resource=e.planarShadows,this.normal=this._normal,this.distance=this._distance,this.shadowColor=this._shadowColor,this.enabled=this._enabled}}]),e}()).prototype,"_enabled",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),yb=v(vb.prototype,"_normal",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new zi(0,1,0)}}),bb=v(vb.prototype,"_distance",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Eb=v(vb.prototype,"_shadowColor",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rr(0,0,0,76)}}),v(vb.prototype,"enabled",[fb],Object.getOwnPropertyDescriptor(vb.prototype,"enabled"),vb.prototype),v(vb.prototype,"normal",[_b],Object.getOwnPropertyDescriptor(vb.prototype,"normal"),vb.prototype),v(vb.prototype,"distance",[db],Object.getOwnPropertyDescriptor(vb.prototype,"distance"),vb.prototype),v(vb.prototype,"shadowColor",[pb],Object.getOwnPropertyDescriptor(vb.prototype,"shadowColor"),vb.prototype),mb=vb))||mb);cc.PlanarShadowInfo=Wb;var jb,Xb,qb,Yb,Kb=(Tb=Es("cc.SceneGlobals"),Sb=Ts({type:Hb}),Tb((wb=v((Ab=function(){function e(){i(this,e),m(this,"ambient",wb,this),m(this,"planarShadows",Cb,this),m(this,"_skybox",Rb,this)}return r(e,[{key:"skybox",get:function(){return this._skybox},set:function(e){this._skybox=e}},{key:"renderScene",set:function(e){this.ambient.renderScene=e,this.skybox.renderScene=e,this.planarShadows.renderScene=e}}]),e}()).prototype,"ambient",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Vb}}),Cb=v(Ab.prototype,"planarShadows",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Wb}}),Rb=v(Ab.prototype,"_skybox",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Hb}}),v(Ab.prototype,"skybox",[Sb],Object.getOwnPropertyDescriptor(Ab.prototype,"skybox"),Ab.prototype),xb=Ab))||xb);cc.SceneGlobals=Kb;var Zb,Qb=e("Scene",Es("cc.Scene")((qb=v((Xb=function(e){function t(e){var n;return i(this,t),m(n=c(this,o(t).call(this,e)),"autoReleaseAssets",qb,u(n)),m(n,"_globals",Yb,u(n)),n._renderScene=null,n.dependAssets=null,n._prefabSyncedInLiveReload=!1,n._pos=zi.ZERO,n._rot=fn.IDENTITY,n._scale=zi.ONE,n._mat=Bn.IDENTITY,n._dirtyFlags=0,n._activeInHierarchy=!1,cc.director&&cc.director.root&&(n._renderScene=cc.director.root.createScene({})),n._inited=!cc.game||!cc.game._isCloning,n}return s(t,e),r(t,[{key:"renderScene",get:function(){return this._renderScene}},{key:"globals",get:function(){return this._globals}}]),r(t,[{key:"destroy",value:function(){var e=f(o(t.prototype),"destroy",this).call(this);return cc.director.root.destroyScene(this._renderScene),this._activeInHierarchy=!1,e}},{key:"addComponent",value:function(e){return N(3822),null}},{key:"_onHierarchyChanged",value:function(){}},{key:"_onBatchCreated",value:function(){f(o(t.prototype),"_onBatchCreated",this).call(this);for(var e=this._children.length,i=0;i<e;++i)this._children[i]._onBatchCreated()}},{key:"_onBatchRestored",value:function(){this._onBatchCreated()}},{key:"getPosition",value:function(e){return zi.copy(e||new zi,zi.ZERO)}},{key:"getRotation",value:function(e){return fn.copy(e||new fn,fn.IDENTITY)}},{key:"getScale",value:function(e){return zi.copy(e||new zi,zi.ONE)}},{key:"getWorldPosition",value:function(e){return zi.copy(e||new zi,zi.ZERO)}},{key:"getWorldRotation",value:function(e){return fn.copy(e||new fn,fn.IDENTITY)}},{key:"getWorldScale",value:function(e){return zi.copy(e||new zi,zi.ONE)}},{key:"getWorldMatrix",value:function(e){return Bn.copy(e||new Bn,Bn.IDENTITY)}},{key:"getWorldRS",value:function(e){return Bn.copy(e||new Bn,Bn.IDENTITY)}},{key:"getWorldRT",value:function(e){return Bn.copy(e||new Bn,Bn.IDENTITY)}},{key:"updateWorldTransform",value:function(){}},{key:"_instantiate",value:function(){}},{key:"_load",value:function(){this._inited||(this._onBatchCreated(),this._inited=!0),this.walk(wf._setScene)}},{key:"_activate",value:function(e){e=!1!==e,cc.director._nodeActivator.activateNode(this,e),this._globals.renderScene=this._renderScene}},{key:"position",get:function(){return zi.ZERO}},{key:"worldPosition",get:function(){return zi.ZERO}},{key:"rotation",get:function(){return fn.IDENTITY}},{key:"worldRotation",get:function(){return fn.IDENTITY}},{key:"scale",get:function(){return zi.ONE}},{key:"worldScale",get:function(){return zi.ONE}},{key:"eulerAngles",get:function(){return zi.ZERO}},{key:"worldMatrix",get:function(){return Bn.IDENTITY}}]),t}(wf)).prototype,"autoReleaseAssets",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Yb=v(Xb.prototype,"_globals",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Kb}}),jb=Xb))||jb);function Jb(e,t){if(t)0;else{var i=cc.director.getScene();if(!i)return null;t=i}return t.getChildByPath(e)}cc.Scene=Qb,cc.find=Jb;var $b=hl.Flags.HideInHierarchy,eE=e("PrivateNode",Es("cc.PrivateNode")(Zb=function(e){function t(e){var n;return i(this,t),(n=c(this,o(t).call(this,e)))._objFlags|=$b,n}return s(t,e),t}(o_))||Zb);cc.PrivateNode=eE;var tE=Qe.fastRemoveAt,iE=hl.Flags.IsStartCalled,nE=hl.Flags.IsOnEnableCalled,rE=(hl.Flags.IsEditorOnEnableCalled,"c.start();c._objFlags|="+iE);function aE(e,t){for(var i=t.constructor._executionOrder,n=t._id,r=0,a=e.length-1,s=a>>>1;r<=a;s=r+a>>>1){var o=e[s],l=o.constructor._executionOrder;if(l>i)a=s-1;else if(l<i)r=s+1;else{var u=o._id;if(u>n)a=s-1;else{if(!(u<n))return s;r=s+1}}}return~r}function sE(e,t){for(var i=e.array,n=e.i+1;n<i.length;){var r=i[n];r._enabled&&r.node._activeInHierarchy?++n:(e.removeAt(n),t&&(r._objFlags&=~t))}}var oE=function e(t){i(this,e);var n=fe;this._zero=new n([]),this._neg=new n([]),this._pos=new n([]),this._invoke=t};function lE(e,t){return e.constructor._executionOrder-t.constructor._executionOrder}oE.stableRemoveInactive=sE;var uE=function(e){function t(){return i(this,t),c(this,o(t).apply(this,arguments))}return s(t,e),r(t,[{key:"add",value:function(e){var t=e.constructor._executionOrder;(0===t?this._zero:t<0?this._neg:this._pos).array.push(e)}},{key:"remove",value:function(e){var t=e.constructor._executionOrder;(0===t?this._zero:t<0?this._neg:this._pos).fastRemove(e)}},{key:"cancelInactive",value:function(e){sE(this._zero,e),sE(this._neg,e),sE(this._pos,e)}},{key:"invoke",value:function(){var e=this._neg;e.array.length>0&&(e.array.sort(lE),this._invoke(e),e.array.length=0),this._invoke(this._zero),this._zero.array.length=0;var t=this._pos;t.array.length>0&&(t.array.sort(lE),this._invoke(t),t.array.length=0)}}]),t}(oE),cE=function(e){function t(){return i(this,t),c(this,o(t).apply(this,arguments))}return s(t,e),r(t,[{key:"add",value:function(e){var t=e.constructor._executionOrder;if(0===t)this._zero.array.push(e);else{var i=t<0?this._neg.array:this._pos.array,n=aE(i,e);n<0&&i.splice(~n,0,e)}}},{key:"remove",value:function(e){var t=e.constructor._executionOrder;if(0===t)this._zero.fastRemove(e);else{var i=t<0?this._neg:this._pos,n=aE(i.array,e);n>=0&&i.removeAt(n)}}},{key:"invoke",value:function(e){this._neg.array.length>0&&this._invoke(this._neg,e),this._invoke(this._zero,e),this._pos.array.length>0&&this._invoke(this._pos,e)}}]),t}(oE);function hE(e,t){if("function"==typeof e)return t?function(t,i){var n=t.array;for(t.i=0;t.i<n.length;++t.i){var r=n[t.i];e(r,i)}}:function(t){var i=t.array;for(t.i=0;t.i<i.length;++t.i){var n=i[t.i];e(n)}};var i="var a=it.array;for(it.i=0;it.i<a.length;++it.i){var c=a[it.i];"+e+"}";return t?Function("it","dt",i):Function("it",i)}var fE=function(){function e(){i(this,e),this.unscheduleAll()}return r(e,[{key:"unscheduleAll",value:function(){this.startInvoker=new uE(hE(rE)),this.updateInvoker=new cE(hE("c.update(dt)",!0)),this.lateUpdateInvoker=new cE(hE("c.lateUpdate(dt)",!0)),this.scheduleInNextFrame=[],this._updating=!1}},{key:"_onEnabled",value:function(e){cc.director.getScheduler().resumeTarget(e),e._objFlags|=nE,this._updating?this.scheduleInNextFrame.push(e):this._scheduleImmediate(e)}},{key:"_onDisabled",value:function(e){cc.director.getScheduler().pauseTarget(e),e._objFlags&=~nE;var t=this.scheduleInNextFrame.indexOf(e);t>=0?tE(this.scheduleInNextFrame,t):(!e.start||e._objFlags&iE||this.startInvoker.remove(e),e.update&&this.updateInvoker.remove(e),e.lateUpdate&&this.lateUpdateInvoker.remove(e))}},{key:"enableComp",value:function(e,t){if(!(e._objFlags&nE)){if(e.onEnable){if(t)return void t.add(e);if(e.onEnable(),!e.node._activeInHierarchy)return}this._onEnabled(e)}}},{key:"disableComp",value:function(e){e._objFlags&nE&&(e.onDisable&&e.onDisable(),this._onDisabled(e))}},{key:"startPhase",value:function(){this._updating=!0,this.scheduleInNextFrame.length>0&&this._deferredSchedule(),this.startInvoker.invoke()}},{key:"updatePhase",value:function(e){this.updateInvoker.invoke(e)}},{key:"lateUpdatePhase",value:function(e){this.lateUpdateInvoker.invoke(e),this._updating=!1}},{key:"_scheduleImmediate",value:function(e){!e.start||e._objFlags&iE||this.startInvoker.add(e),e.update&&this.updateInvoker.add(e),e.lateUpdate&&this.lateUpdateInvoker.add(e)}},{key:"_deferredSchedule",value:function(){for(var e=this.scheduleInNextFrame,t=0,i=e.length;t<i;t++){var n=e[t];this._scheduleImmediate(n)}e.length=0}}]),e}();fE.LifeCycleInvoker=oE,fE.OneOffInvoker=uE,fE.createInvokeImpl=hE,fE.invokeOnEnable=function(e){var t=cc.director._compScheduler,i=e.array;for(e.i=0;e.i<i.length;++e.i){var n=i[e.i];if(n._enabled)n.onEnable(),!n.node._activeInHierarchy||t._onEnabled(n)}};var _E=hl.Flags.IsPreloadStarted,dE=hl.Flags.IsOnLoadStarted,pE=hl.Flags.IsOnLoadCalled,mE=hl.Flags.Deactivating,vE="c.onLoad();c._objFlags|="+pE,gE=function(e){function t(){return i(this,t),c(this,o(t).apply(this,arguments))}return s(t,e),r(t,[{key:"add",value:function(e){this._zero.array.push(e)}},{key:"remove",value:function(e){this._zero.fastRemove(e)}},{key:"cancelInactive",value:function(e){fE.LifeCycleInvoker.stableRemoveInactive(this._zero,e)}},{key:"invoke",value:function(){this._invoke(this._zero),this._zero.array.length=0}}]),t}(fE.LifeCycleInvoker),yE=fE.createInvokeImpl("c.__preload();"),bE=fE.createInvokeImpl(vE),EE=new Ze(4);function TE(e,t,i){t?e._removeComponent(t):Qe.removeAt(e._components,i)}EE.get=function(){var e=this._get()||{preload:new gE(yE),onLoad:new fE.OneOffInvoker(bE),onEnable:new fE.OneOffInvoker(fE.invokeOnEnable)};e.preload._zero.i=-1;var t=e.onLoad;return t._zero.i=-1,t._neg.i=-1,t._pos.i=-1,(t=e.onEnable)._zero.i=-1,t._neg.i=-1,t._pos.i=-1,e};var SE,xE,AE,wE,CE,RE,kE,OE,IE,ME,LE,PE,BE,DE,FE,NE,zE,UE,GE,VE,HE,WE,jE,XE,qE,YE,KE,ZE,QE,JE,$E,eT,tT,iT,nT,rT,aT,sT,oT,lT,uT,cT,hT,fT,_T,dT,pT,mT,vT,gT,yT,bT,ET,TT,ST,xT,AT,wT,CT,RT,kT,OT,IT,MT=e("NodeActivator",function(){function e(){i(this,e),this.reset()}return r(e,[{key:"reset",value:function(){this._activatingStack=[]}},{key:"activateNode",value:function(e,t){if(t){var i=EE.get();this._activatingStack.push(i),this._activateNodeRecursively(e,i.preload,i.onLoad,i.onEnable),i.preload.invoke(),i.onLoad.invoke(),i.onEnable.invoke(),this._activatingStack.pop(),EE.put(i)}else{this._deactivateNodeRecursively(e);var n=this._activatingStack,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s;o.preload.cancelInactive(_E),o.onLoad.cancelInactive(dE),o.onEnable.cancelInactive()}}e.emit("active-in-hierarchy-changed",e)}},{key:"activateComp",value:function(e,t,i,n){if(e._objFlags&_E||(e._objFlags|=_E,e.__preload&&(t?t.add(e):e.__preload())),e._objFlags&dE||(e._objFlags|=dE,e.onLoad?i?i.add(e):(e.onLoad(),e._objFlags|=pE):e._objFlags|=pE),e._enabled){if(!e.node._activeInHierarchy)return;cc.director._compScheduler.enableComp(e,n)}}},{key:"destroyComp",value:function(e){cc.director._compScheduler.disableComp(e),e.onDestroy&&e._objFlags&pE&&e.onDestroy()}},{key:"_activateNodeRecursively",value:function(e,t,i,n){if(e._objFlags&mE)cc.errorID(3816,e.name);else{e._activeInHierarchy=!0;for(var r=e._components.length,a=0;a<r;++a){var s=e._components[a];s instanceof cc.Component?this.activateComp(s,t,i,n):(TE(e,s,a),--a,--r)}e._childArrivalOrder=e._children.length;for(var o=0,l=e._children.length;o<l;++o){var u=e._children[o];u._active&&this._activateNodeRecursively(u,t,i,n)}e._onPostActivated(!0)}}},{key:"_deactivateNodeRecursively",value:function(e){e._objFlags|=mE,e._activeInHierarchy=!1;for(var t=e._components.length,i=0;i<t;++i){var n=e._components[i];if(n._enabled&&(cc.director._compScheduler.disableComp(n),e._activeInHierarchy))return void(e._objFlags&=~mE)}for(var r=0,a=e._children.length;r<a;++r){var s=e._children[r];if(s._activeInHierarchy&&(this._deactivateNodeRecursively(s),e._activeInHierarchy))return void(e._objFlags&=~mE)}e._onPostActivated(!1),e._objFlags&=~mE}}]),e}());sr(wf.prototype,"BaseNode",[{name:"childrenCount",newName:"children.length",customGetter:function(){return this.children.length}}]),or(o_.prototype,"Node.prototype",[{name:"addLayer"},{name:"removeLayer"}]),or(du,"Layers",[{name:"All"},{name:"RaycastMask"},{name:"check"}]),sr(du,"Layers",[{name:"Default",newName:"DEFAULT",target:du.Enum,targetName:"Layers.Enum"},{name:"Always",newName:"ALWAYS",target:du.Enum,targetName:"Layers.Enum"},{name:"IgnoreRaycast",newName:"IGNORE_RAYCAST",target:du.Enum,targetName:"Layers.Enum"},{name:"Gizmos",newName:"GIZMOS",target:du.Enum,targetName:"Layers.Enum"},{name:"Editor",newName:"EDITOR",target:du.Enum,targetName:"Layers.Enum"},{name:"UI",newName:"UI_3D",target:du.Enum,targetName:"Layers.Enum"},{name:"UI2D",newName:"UI_2D",target:du.Enum,targetName:"Layers.Enum"},{name:"SceneGizmo",newName:"SCENE_GIZMO",target:du.Enum,targetName:"Layers.Enum"},{name:"makeInclusiveMask",newName:"makeMaskInclude",target:du,targetName:"Layers"},{name:"makeExclusiveMask",newName:"makeMaskExclude",target:du,targetName:"Layers"}]),or(du.Enum,"Layers.Enum",[{name:"ALWAYS"}]),or(du.BitMask,"Layers.BitMask",[{name:"ALWAYS"}]),pt(bo),pt(xo),pt(Eo),pt(ko),pt(Ro),pt(Oo),function(e){e[e.SCENE=0]="SCENE",e[e.POSTPROCESS=1]="POSTPROCESS",e[e.UI=2]="UI"}(IT||(IT={})),pt(IT);var LT=(SE=Es("RenderTextureDesc"),xE=Ts({type:bo}),AE=Ts({type:xo}),wE=Ts({type:Eo}),CE=Ts({type:no}),SE((OE=v((kE=function e(){i(this,e),m(this,"name",OE,this),m(this,"type",IE,this),m(this,"viewType",ME,this),m(this,"usage",LE,this),m(this,"format",PE,this),m(this,"width",BE,this),m(this,"height",DE,this)}).prototype,"name",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),IE=v(kE.prototype,"type",[xE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return bo.TEX2D}}),ME=v(kE.prototype,"viewType",[AE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return xo.TV2D}}),LE=v(kE.prototype,"usage",[wE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Eo.COLOR_ATTACHMENT}}),PE=v(kE.prototype,"format",[CE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return no.UNKNOWN}}),BE=v(kE.prototype,"width",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),DE=v(kE.prototype,"height",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),RE=kE))||RE),PT=(FE=Es("FrameBufferDesc"),NE=Ts({type:[Ct]}),FE((GE=v((UE=function e(){i(this,e),m(this,"name",GE,this),m(this,"renderPass",VE,this),m(this,"colorViews",HE,this),m(this,"depthStencilView",WE,this)}).prototype,"name",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),VE=v(UE.prototype,"renderPass",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),HE=v(UE.prototype,"colorViews",[NE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),WE=v(UE.prototype,"depthStencilView",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),zE=UE))||zE),BT=(jE=Es("ColorDesc"),XE=Ts({type:no}),qE=Ts({type:Ro}),YE=Ts({type:ko}),KE=Ts({type:Oo}),ZE=Ts({type:Oo}),jE(($E=v((JE=function e(){i(this,e),m(this,"format",$E,this),m(this,"loadOp",eT,this),m(this,"storeOp",tT,this),m(this,"sampleCount",iT,this),m(this,"beginLayout",nT,this),m(this,"endLayout",rT,this)}).prototype,"format",[XE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return no.UNKNOWN}}),eT=v(JE.prototype,"loadOp",[qE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ro.CLEAR}}),tT=v(JE.prototype,"storeOp",[YE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ko.STORE}}),iT=v(JE.prototype,"sampleCount",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),nT=v(JE.prototype,"beginLayout",[KE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Oo.COLOR_ATTACHMENT_OPTIMAL}}),rT=v(JE.prototype,"endLayout",[ZE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Oo.COLOR_ATTACHMENT_OPTIMAL}}),QE=JE))||QE),DT=(aT=Es("DepthStencilDesc"),sT=Ts({type:no}),oT=Ts({type:Ro}),lT=Ts({type:ko}),uT=Ts({type:Ro}),cT=Ts({type:ko}),hT=Ts({type:Oo}),fT=Ts({type:Oo}),aT((pT=v((dT=function e(){i(this,e),m(this,"format",pT,this),m(this,"depthLoadOp",mT,this),m(this,"depthStoreOp",vT,this),m(this,"stencilLoadOp",gT,this),m(this,"stencilStoreOp",yT,this),m(this,"sampleCount",bT,this),m(this,"beginLayout",ET,this),m(this,"endLayout",TT,this)}).prototype,"format",[sT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return no.UNKNOWN}}),mT=v(dT.prototype,"depthLoadOp",[oT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ro.CLEAR}}),vT=v(dT.prototype,"depthStoreOp",[lT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ko.STORE}}),gT=v(dT.prototype,"stencilLoadOp",[uT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ro.CLEAR}}),yT=v(dT.prototype,"stencilStoreOp",[cT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ko.STORE}}),bT=v(dT.prototype,"sampleCount",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),ET=v(dT.prototype,"beginLayout",[hT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Oo.COLOR_ATTACHMENT_OPTIMAL}}),TT=v(dT.prototype,"endLayout",[fT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Oo.COLOR_ATTACHMENT_OPTIMAL}}),_T=dT))||_T),FT=(ST=Es("RenderPassDesc"),xT=Ts({type:[BT]}),AT=Ts({type:DT}),ST((RT=v((CT=function e(){i(this,e),m(this,"index",RT,this),m(this,"colorAttachments",kT,this),m(this,"depthStencilAttachment",OT,this)}).prototype,"index",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),kT=v(CT.prototype,"colorAttachments",[xT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),OT=v(CT.prototype,"depthStencilAttachment",[AT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new DT}}),wT=CT))||wT);function NT(e,t){return e.hash===t.hash?e.depth===t.depth?e.shaderId-t.shaderId:e.depth-t.depth:e.hash-t.hash}function zT(e,t){return e.hash===t.hash?e.depth===t.depth?e.shaderId-t.shaderId:t.depth-e.depth:e.hash-t.hash}var UT,GT,VT,HT,WT,jT,XT,qT,YT,KT,ZT,QT,JT,$T,eS,tS,iS,nS,rS,aS,sS=function(){function e(t){i(this,e),this.cmdBuffCount=0,this._passDesc=t,this._passPool=new Qa((function(){return{hash:0,depth:0,shaderId:0,subModel:null,cmdBuff:null}}),64),this.cmdBuffs=new Ja(64),this.queue=new Ja(64,this._passDesc.sortFunc)}return r(e,[{key:"clear",value:function(){this.queue.clear(),this._passPool.reset(),this.cmdBuffCount=0}},{key:"insertRenderPass",value:function(e,t,i){var n=e.model.getSubModel(t),r=n.passes[i],a=n.psos[i];if(a.blendState.targets[0].blend!==this._passDesc.isTransparent||!(r.phase&this._passDesc.phases))return!1;var s=0|r.priority<<16|n.priority<<8|i,o=this._passPool.add();return o.hash=s,o.depth=e.depth,o.shaderId=a.shader.id,o.subModel=n,o.cmdBuff=n.commandBuffers[i],this.queue.push(o),!0}},{key:"sort",value:function(){this.queue.sort(),this.cmdBuffCount=this.queue.length;for(var e=0;e<this.queue.length;++e)this.cmdBuffs.array[e]=this.queue.array[e].cmdBuff}}]),e}(),oS=[{r:0,g:0,b:0,a:1}],lS=[];!function(e){e[e.FRONT_TO_BACK=0]="FRONT_TO_BACK",e[e.BACK_TO_FRONT=1]="BACK_TO_FRONT"}(aS||(aS={})),pt(aS);var uS,cS,hS,fS,_S,dS,pS,mS,vS,gS,yS,bS,ES,TS=(UT=Es("RenderQueueDesc"),GT=Ts({type:aS}),VT=Ts({type:[Ct]}),UT((jT=v((WT=function e(){i(this,e),m(this,"isTransparent",jT,this),m(this,"sortMode",XT,this),m(this,"stages",qT,this)}).prototype,"isTransparent",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),XT=v(WT.prototype,"sortMode",[GT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return aS.FRONT_TO_BACK}}),qT=v(WT.prototype,"stages",[VT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),HT=WT))||HT),SS=e("RenderStage",(YT=Es("RenderStage"),KT=Ts({displayOrder:0,visible:!0}),ZT=Ts({displayOrder:1,visible:!0}),QT=Ts({displayOrder:2,visible:!0}),JT=Ts({type:[TS],displayOrder:3,visible:!0}),YT((tS=v((eS=function(){function e(){i(this,e),m(this,"_name",tS,this),m(this,"_priority",iS,this),m(this,"frameBuffer",nS,this),m(this,"renderQueues",rS,this),this._renderQueues=[],this._flow=null,this._pipeline=null,this._device=null,this._framebuffer=null,this._cmdBuff=null,this._clearColors=null,this._clearDepth=1,this._clearStencil=0,this._renderArea=null,this._pass=null,this._pso=null}return r(e,[{key:"flow",get:function(){return this._flow}},{key:"pipeline",get:function(){return this._pipeline}},{key:"priority",get:function(){return this._priority}},{key:"framebuffer",get:function(){return this._framebuffer}}]),r(e,[{key:"initialize",value:function(e){return void 0!==e.name&&(this._name=e.name),this._priority=e.priority,e.framebuffer&&(this.frameBuffer=e.framebuffer),e.renderQueues&&(this.renderQueues=e.renderQueues),!0}},{key:"activate",value:function(e){if(this._flow=e,this._pipeline=e.pipeline,this._device=e.device,!this._flow.pipeline.root.device)throw new Error("");this._device=this._flow.pipeline.root.device,this._clearColors=[{r:.3,g:.6,b:.9,a:1}],this._renderArea={x:0,y:0,width:0,height:0};for(var t=0;t<this.renderQueues.length;t++){for(var i=0,n=0;n<this.renderQueues[t].stages.length;n++)i|=md(this.renderQueues[t].stages[n]);var r=NT;switch(this.renderQueues[t].sortMode){case aS.BACK_TO_FRONT:r=zT;break;case aS.FRONT_TO_BACK:r=NT}this._renderQueues[t]=new sS({isTransparent:this.renderQueues[t].isTransparent,phases:i,sortFunc:r})}"window"===this.frameBuffer?this._framebuffer=this._flow.pipeline.root.mainWindow.framebuffer:this._framebuffer=this._flow.pipeline.getFrameBuffer(this.frameBuffer)}},{key:"setClearColor",value:function(e){this._clearColors.length>0?this._clearColors[0]=e:this._clearColors.push(e)}},{key:"setClearColors",value:function(e){this._clearColors=e}},{key:"setClearDepth",value:function(e){this._clearDepth=e}},{key:"setClearStencil",value:function(e){this._clearStencil=e}},{key:"setRenderArea",value:function(e,t){this._renderArea.width=e,this._renderArea.height=t}},{key:"sortRenderQueue",value:function(){this._renderQueues.forEach(this.renderQueueClearFunc);for(var e=this._pipeline.renderObjects,t=0;t<e.length;++t)for(var i=e[t],n=0;n<i.model.subModelNum;n++)for(var r=0;r<i.model.getSubModel(n).passes.length;r++)for(var a=0;a<this._renderQueues.length;a++)this._renderQueues[a].insertRenderPass(i,n,r);this._renderQueues.forEach(this.renderQueueSortFunc)}},{key:"executeCommandBuffer",value:function(e){var t=e.camera,i=this._cmdBuff,n=t.viewport;this._renderArea.x=n.x*t.width,this._renderArea.y=n.y*t.height,this._renderArea.width=n.width*t.width*this.pipeline.shadingScale,this._renderArea.height=n.height*t.height*this.pipeline.shadingScale,t.clearFlag&Bo.COLOR&&(oS[0].a=t.clearColor.a,oS[0].r=t.clearColor.r,oS[0].g=t.clearColor.g,oS[0].b=t.clearColor.b),this._framebuffer||(this._framebuffer=e.window.framebuffer),i.begin(),i.beginRenderPass(this._framebuffer,this._renderArea,t.clearFlag,oS,t.clearDepth,t.clearStencil);for(var r=0;r<this._renderQueues.length;r++)i.execute(this._renderQueues[r].cmdBuffs.array,this._renderQueues[r].cmdBuffCount);i.endRenderPass(),i.end(),lS[0]=i,this._device.queue.submit(lS)}},{key:"createCmdBuffer",value:function(){this._cmdBuff=this._device.createCommandBuffer({allocator:this._device.commandAllocator,type:Co.PRIMARY})}},{key:"renderQueueClearFunc",value:function(e){e.clear()}},{key:"renderQueueSortFunc",value:function(e){e.sort()}}]),e}()).prototype,"_name",[KT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),iS=v(eS.prototype,"_priority",[ZT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),nS=v(eS.prototype,"frameBuffer",[QT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),rS=v(eS.prototype,"renderQueues",[JT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),$T=eS))||$T));cc.RenderStage=SS;var xS,AS,wS,CS,RS,kS,OS,IS,MS,LS,PS,BS=e("RenderFlow",(uS=Es("RenderFlow"),cS=Ts({displayOrder:0,visible:!0}),hS=Ts({displayOrder:1,visible:!0}),fS=Ts({type:cc.Material,displayOrder:2,visible:!0}),_S=Ts({type:IT,displayOrder:3,visible:!0}),dS=Ts({type:[SS],displayOrder:4,visible:!0}),uS((vS=v((mS=function(){function e(){i(this,e),this._device=null,this._pipeline=null,m(this,"_name",vS,this),m(this,"_priority",gS,this),m(this,"_material",yS,this),m(this,"_type",bS,this),m(this,"_stages",ES,this)}return r(e,[{key:"device",get:function(){return this._device}},{key:"pipeline",get:function(){return this._pipeline}},{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"stages",get:function(){return this._stages}},{key:"material",get:function(){return this._material}},{key:"type",get:function(){return this._type}}]),r(e,[{key:"initialize",value:function(e){void 0!==e.name&&(this._name=e.name),this._priority=e.priority,e.material&&(this._material=e.material),e.type&&(this._type=e.type)}},{key:"activate",value:function(e){this._device=e.device,this._pipeline=e,e.activateFlow(this),this._activateStages()}},{key:"resize",value:function(e,t){for(var i=0;i<this._stages.length;i++)this._stages[i].resize(e,t)}},{key:"render",value:function(e){for(var t=0;t<this._stages.length;t++)this._stages[t].render(e)}},{key:"destroyStages",value:function(){for(var e=0;e<this._stages.length;e++)this._stages[e].destroy();this._stages=[]}},{key:"_activateStages",value:function(){for(var e=0;e<this._stages.length;e++)this._stages[e].activate(this);this._stages.sort((function(e,t){return e.priority-t.priority}))}}]),e}()).prototype,"_name",[cS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),gS=v(mS.prototype,"_priority",[hS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),yS=v(mS.prototype,"_material",[fS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),bS=v(mS.prototype,"_type",[_S],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return IT.SCENE}}),ES=v(mS.prototype,"_stages",[dS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),pS=mS))||pS));cc.RenderFlow=BS;var DS,FS,NS,zS,US,GS=new zi,VS=e("RenderPipeline",(xS=Es("RenderPipeline"),AS=Ts({type:[BS],visible:!0}),wS=Ts({type:[LT]}),CS=Ts({type:[PT]}),RS=Ts({type:[FT]}),xS((IS=v((OS=function(){function e(){i(this,e),this._root=null,this._device=null,this._renderObjects=[],m(this,"_flows",IS,this),this._activeFlows=[],this._isHDRSupported=!1,this._isHDR=!1,this._lightMeterScale=1e4,this._fboCount=0,this._colorFmt=no.UNKNOWN,this._depthStencilFmt=no.UNKNOWN,this._shadingWidth=0,this._shadingHeight=0,this._shadingScale=1,this._curIdx="shading",this._prevIdx="shading1",this._usePostProcess=!1,this._useMSAA=!1,this._useSMAA=!1,this._quadVB=null,this._quadIB=null,this._quadIA=null,this._uboGlobal=new yu,this._globalBindings=new Map,this._defaultTex=null,this._defaultTexView=null,this._fpScale=1/1024,this._fpScaleInv=1024,this._macros={},this._useDynamicBatching=!1,m(this,"renderTextures",MS,this),m(this,"framebuffers",LS,this),m(this,"renderPasses",PS,this),this._renderTextures=new Map,this._textureViews=new Map,this._frameBuffers=new Map,this._renderPasses=new Map}return r(e,[{key:"root",get:function(){return this._root}},{key:"device",get:function(){return this._device}},{key:"name",get:function(){return Je.getClassName(this.constructor)}},{key:"renderObjects",get:function(){return this._renderObjects}},{key:"flows",get:function(){return this._flows}},{key:"activeFlows",get:function(){return this._activeFlows}},{key:"usePostProcess",get:function(){return this._usePostProcess}},{key:"isHDRSupported",get:function(){return this._isHDRSupported}},{key:"isHDR",get:function(){return this._isHDR}},{key:"shadingScale",get:function(){return this._shadingScale}},{key:"lightMeterScale",set:function(e){this._lightMeterScale=e},get:function(){return this._lightMeterScale}},{key:"useMSAA",get:function(){return this._useMSAA}},{key:"useSMAA",get:function(){return this._useSMAA}},{key:"quadIA",get:function(){return this._quadIA}},{key:"globalBindings",get:function(){return this._globalBindings}},{key:"defaultTexture",get:function(){return this._defaultTex}},{key:"fpScale",get:function(){return this._fpScale}},{key:"fpScaleInv",get:function(){return this._fpScaleInv}},{key:"macros",get:function(){return this._macros}},{key:"defaultGlobalUBOData",get:function(){return this._uboGlobal.view}},{key:"currShading",get:function(){return this._curIdx}},{key:"prevShading",get:function(){return this._prevIdx}},{key:"useDynamicBatching",get:function(){return this._useDynamicBatching}}]),r(e,[{key:"getTextureView",value:function(e){return this._textureViews.get(e)}},{key:"getRenderTexture",value:function(e){return this._renderTextures.get(e)}},{key:"getFrameBuffer",value:function(e){return this._frameBuffers.get(e)}},{key:"initialize",value:function(e){void 0!==e.enablePostProcess?this._usePostProcess=e.enablePostProcess:this._usePostProcess=!1,this._isHDR=void 0!==e.enableHDR&&e.enableHDR,this._useSMAA=void 0!==e.enableSMAA&&e.enableSMAA,this._useMSAA=void 0!==e.enableMSAA&&e.enableMSAA,e.renderTextures&&(this.renderTextures=e.renderTextures),e.framebuffers&&(this.framebuffers=e.framebuffers),e.renderPasses&&(this.renderPasses=e.renderPasses)}},{key:"activate",value:function(e){if(this._root=e,this._device=e.device,!this._initRenderResource())return console.error("RenderPipeline:"+this.name+" startup failed!"),!1;for(var t=0;t<this._flows.length;t++)this._flows[t].type===IT.SCENE&&this._flows[t].activate(this);return!0}},{key:"render",value:function(e){for(var t=0;t<e.flows.length;t++)e.flows[t].render(e)}},{key:"rebuild",value:function(){this.updateMacros()}},{key:"resize",value:function(e,t){var i=Math.floor(e*this._shadingScale),n=Math.floor(t*this._shadingScale);(i>this._shadingWidth||n>this._shadingHeight)&&this.resizeFBOs(i,n);for(var r=0;r<this._flows.length;r++)this._flows[r].resize(e,t)}},{key:"swapFBOs",value:function(){var e=this._curIdx;this._curIdx=this._prevIdx,this._prevIdx=e}},{key:"addRenderPass",value:function(e,t){t&&this._renderPasses.set(e,t)}},{key:"getRenderPass",value:function(e){var t=this._renderPasses.get(e);return t||null}},{key:"removeRenderPass",value:function(e){this._renderPasses.delete(e)}},{key:"clearRenderPasses",value:function(){this._renderPasses.clear()}},{key:"destroyFlows",value:function(){for(var e=0;e<this._flows.length;e++)this._flows[e].destroy();this._flows=[]}},{key:"getFlow",value:function(e){for(var t=0;t<this._flows.length;t++)if(this._flows[t].name===e)return this._flows[t];return null}},{key:"updateMacros",value:function(){Ld.destroyShaderByDefines(this._macros),this._macros.CC_USE_HDR=this._isHDR;for(var e=0;e<this._root.scenes.length;e++)this._root.scenes[e].onGlobalPipelineStateChanged()}},{key:"updateUBOs",value:function(e){var t=e.camera,i=t.scene,n=this._root.device,r=i.mainLight,a=i.ambient,s=this._uboGlobal.view;s[yu.TIME_OFFSET]=this._root.cumulativeTime,s[yu.TIME_OFFSET+1]=this._root.frameTime,s[yu.TIME_OFFSET+2]=cc.director.getTotalFrames(),s[yu.SCREEN_SIZE_OFFSET]=n.width,s[yu.SCREEN_SIZE_OFFSET+1]=n.height,s[yu.SCREEN_SIZE_OFFSET+2]=1/s[yu.SCREEN_SIZE_OFFSET],s[yu.SCREEN_SIZE_OFFSET+3]=1/s[yu.SCREEN_SIZE_OFFSET+1],s[yu.SCREEN_SCALE_OFFSET]=t.width/this._shadingWidth*this._shadingScale,s[yu.SCREEN_SCALE_OFFSET+1]=t.height/this._shadingHeight*this._shadingScale,s[yu.SCREEN_SCALE_OFFSET+2]=1/s[yu.SCREEN_SCALE_OFFSET],s[yu.SCREEN_SCALE_OFFSET+3]=1/s[yu.SCREEN_SCALE_OFFSET+1],s[yu.NATIVE_SIZE_OFFSET]=this._shadingWidth,s[yu.NATIVE_SIZE_OFFSET+1]=this._shadingHeight,s[yu.NATIVE_SIZE_OFFSET+2]=1/s[yu.NATIVE_SIZE_OFFSET],s[yu.NATIVE_SIZE_OFFSET+3]=1/s[yu.NATIVE_SIZE_OFFSET+1],Bn.toArray(s,t.matView,yu.MAT_VIEW_OFFSET),Bn.toArray(s,t.node.worldMatrix,yu.MAT_VIEW_INV_OFFSET),Bn.toArray(s,t.matProj,yu.MAT_PROJ_OFFSET),Bn.toArray(s,t.matProjInv,yu.MAT_PROJ_INV_OFFSET),Bn.toArray(s,t.matViewProj,yu.MAT_VIEW_PROJ_OFFSET),Bn.toArray(s,t.matViewProjInv,yu.MAT_VIEW_PROJ_INV_OFFSET),zi.toArray(s,t.position,yu.CAMERA_POS_OFFSET);var o=t.exposure;if(s[yu.EXPOSURE_OFFSET]=o,s[yu.EXPOSURE_OFFSET+1]=1/o,s[yu.EXPOSURE_OFFSET+2]=this._isHDR?1:0,s[yu.EXPOSURE_OFFSET+3]=this._fpScale/o,r){if(zi.toArray(s,r.direction,yu.MAIN_LIT_DIR_OFFSET),zi.toArray(s,r.color,yu.MAIN_LIT_COLOR_OFFSET),r.useColorTemperature){var l=r.colorTemperatureRGB;s[yu.MAIN_LIT_COLOR_OFFSET]*=l.x,s[yu.MAIN_LIT_COLOR_OFFSET+1]*=l.y,s[yu.MAIN_LIT_COLOR_OFFSET+2]*=l.z}this._isHDR?s[yu.MAIN_LIT_COLOR_OFFSET+3]=r.illuminance*this._fpScale:s[yu.MAIN_LIT_COLOR_OFFSET+3]=r.illuminance*o}else zi.toArray(s,zi.UNIT_Z,yu.MAIN_LIT_DIR_OFFSET),qi.toArray(s,qi.ZERO,yu.MAIN_LIT_COLOR_OFFSET);var u=a.skyColor;this._isHDR?u[3]=a.skyIllum*this._fpScale:u[3]=a.skyIllum*o,this._uboGlobal.view.set(u,yu.AMBIENT_SKY_OFFSET),this._uboGlobal.view.set(a.groundAlbedo,yu.AMBIENT_GROUND_OFFSET),this._globalBindings.get(yu.BLOCK.name).buffer.update(this._uboGlobal.view.buffer)}},{key:"sceneCulling",value:function(e){var t=e.camera,i=t.scene;this._renderObjects.length=0;var n=i.mainLight,r=i.planarShadows;n&&(n.update(),r.enabled&&n.node.hasChangedFlags&&r.updateDirLight(n)),i.skybox.enabled&&t.clearFlag&Db&&this.addVisibleModel(i.skybox,t);for(var a=i.models,s=0;s<a.length;s++){var o=a[s];if(o._resetUBOUpdateFlag(),o.enabled)if(e.visibility&du.BitMask.UI_2D)(o.node&&e.visibility===o.node.layer||e.visibility===o.visFlags)&&(o.updateTransform(),o.updateUBOs(),this.addVisibleModel(o,t));else if(o.node&&(e.visibility&o.node.layer)===o.node.layer||e.visibility&o.visFlags){if(o.updateTransform(),o.worldBounds&&!Sa.aabb_frustum(o.worldBounds,t.frustum))continue;o.updateUBOs(),this.addVisibleModel(o,t)}}r.enabled&&r.updateCommandBuffers(t.frustum)}},{key:"_initRenderResource",value:function(){this._usePostProcess&&((this._device.hasFeature(qo.FORMAT_R11G11B10F)||this._device.hasFeature(qo.TEXTURE_HALF_FLOAT)||this._device.hasFeature(qo.TEXTURE_FLOAT))&&(this._isHDRSupported=!0),this._fboCount=1,this._useMSAA&&(this._useMSAA=this.device.hasFeature(qo.MSAA))),this._isHDR&&this._isHDRSupported&&(this._device.hasFeature(qo.COLOR_HALF_FLOAT)&&this._device.hasFeature(qo.TEXTURE_HALF_FLOAT_LINEAR)?this._device.hasFeature(qo.FORMAT_R11G11B10F)?(this._colorFmt=no.R11G11B10F,this._isHDR=!0):this._device.hasFeature(qo.TEXTURE_HALF_FLOAT)&&(this._colorFmt=no.RGBA16F,this._isHDR=!0):this._device.hasFeature(qo.COLOR_FLOAT)&&this._device.hasFeature(qo.TEXTURE_FLOAT_LINEAR)&&this._device.hasFeature(qo.TEXTURE_FLOAT)&&(this._colorFmt=no.RGBA32F,this._isHDR=!0),this._isHDR=!1),this._isHDR||(this._colorFmt=no.RGBA8),24===this._device.depthBits?8===this._device.stencilBits?this._depthStencilFmt=no.D24S8:this._depthStencilFmt=no.D24:this._depthStencilFmt=no.D16,this._shadingScale=1,this._shadingWidth=Math.floor(this._device.width),this._shadingHeight=Math.floor(this._device.height),console.info("USE_POST_PROCESS: "+this._usePostProcess),this._usePostProcess&&(console.info("USE_MSAA: "+this._useMSAA),console.info("USE_SMAA: "+this._useSMAA),console.info("USE_HDR: "+this._isHDR)),console.info("SHADING_SIZE: "+this._shadingWidth+" x "+this._shadingHeight),console.info("SHADING_SCALE: "+this._shadingScale.toFixed(4)),console.info("SHADING_COLOR_FORMAT: "+Go[this._colorFmt].name),console.info("SHADING_DEPTH_FORMAT: "+Go[this._depthStencilFmt].name);for(var e=0;e<this.renderTextures.length;e++){var t=this.renderTextures[e];this._renderTextures.set(t.name,this._device.createTexture({type:t.type,usage:t.usage,format:this._getTextureFormat(t.format,t.usage),width:-1===t.width?this._shadingWidth:t.width,height:-1===t.height?this._shadingHeight:t.height}));var i=this._renderTextures.get(t.name);if(null==i)return console.error("RenderTexture:"+t.name+" not found!"),!1;this._textureViews.set(t.name,this._device.createTextureView({texture:i,type:t.viewType,format:this._getTextureFormat(t.format,t.usage)}))}for(var n=0;n<this.renderPasses.length;n++){var r=this.renderPasses[n];this._renderPasses.set(r.index,this._device.createRenderPass({colorAttachments:r.colorAttachments,depthStencilAttachment:r.depthStencilAttachment}))}for(var a=0;a<this.framebuffers.length;a++){var s=this.framebuffers[a],o=this._renderPasses.get(s.renderPass);if(null==o)return console.error("RenderPass:"+s.renderPass+" not found!"),!1;for(var l=[],u=0;u<s.colorViews.length;u++){var c=this._textureViews.get(s.colorViews[u]);if(null==c)return console.error("TextureView:"+s.colorViews[u]+" not found!"),!1;l.push(c)}var h=this._textureViews.get(s.depthStencilView);this._frameBuffers.set(s.name,this._device.createFramebuffer({renderPass:o,colorViews:l,depthStencilView:h}))}if(!this.createQuadInputAssembler())return!1;if(!this.createUBOs())return!1;var f=this._root.mainWindow,_=null;return f&&(_=f.renderPass),_?(this.addRenderPass(pu.DEFAULT,_),this.updateMacros(),!0):(console.error("RenderPass of main window is null."),!1)}},{key:"_destroy",value:function(){this.destroyFlows(),this.clearRenderPasses(),this.destroyQuadInputAssembler(),this.destroyUBOs();for(var e=this._renderTextures.values(),t=e.next();!t.done;)t.value.destroy(),t=e.next();for(var i=this._textureViews.values(),n=i.next();!n.done;)n.value.destroy(),n=i.next();for(var r=this._renderPasses.values(),a=r.next();!a.done;)a.value.destroy(),a=r.next();for(var s=this._frameBuffers.values(),o=s.next();!o.done;)o.value.destroy(),o=s.next()}},{key:"resizeFBOs",value:function(e,t){var i=this;this._shadingWidth=e,this._shadingHeight=t;for(var n=0;n<this.renderTextures.length;n++){var r=this.renderTextures[n];this._renderTextures.get(r.name).resize(e,t),this._textureViews.get(r.name).destroy(),this._textureViews.get(r.name).initialize({texture:this._renderTextures.get(r.name),type:r.viewType,format:this._getTextureFormat(r.format,r.usage)})}for(var a=0;a<this.framebuffers.length;a++){var s=this.framebuffers[a];this._frameBuffers.get(s.name).destroy(),this._frameBuffers.get(s.name).initialize({renderPass:this._renderPasses.get(s.renderPass),colorViews:s.colorViews.map((function(e){return i._textureViews.get(e)}),this),depthStencilView:this._textureViews.get(s.depthStencilView)})}console.info("Resizing shading fbos: "+this._shadingWidth+"x"+this._shadingHeight)}},{key:"createQuadInputAssembler",value:function(){var e=4*Float32Array.BYTES_PER_ELEMENT,t=4*e;if(this._quadVB=this._device.createBuffer({usage:ro.VERTEX|ro.TRANSFER_DST,memUsage:ao.HOST|ao.DEVICE,size:t,stride:e}),!this._quadVB)return!1;var i=new Float32Array(16),n=0;i[n++]=-1,i[n++]=-1,i[n++]=0,i[n++]=0,i[n++]=1,i[n++]=-1,i[n++]=1,i[n++]=0,i[n++]=-1,i[n++]=1,i[n++]=0,i[n++]=1,i[n++]=1,i[n++]=1,i[n++]=1,i[n++]=1,this._quadVB.update(i);var r=Uint8Array.BYTES_PER_ELEMENT,a=6*r;if(this._quadIB=this._device.createBuffer({usage:ro.INDEX|ro.TRANSFER_DST,memUsage:ao.HOST|ao.DEVICE,size:a,stride:r}),!this._quadIB)return!1;var s=new Uint8Array(6);s[0]=0,s[1]=1,s[2]=2,s[3]=1,s[4]=3,s[5]=2,this._quadIB.update(s);var o=[{name:"a_position",format:no.RG32F},{name:"a_texCoord",format:no.RG32F}];return this._quadIA=this._device.createInputAssembler({attributes:o,vertexBuffers:[this._quadVB],indexBuffer:this._quadIB}),!0}},{key:"destroyQuadInputAssembler",value:function(){this._quadVB&&(this._quadVB.destroy(),this._quadVB=null),this._quadIB&&(this._quadIB.destroy(),this._quadIB=null),this._quadIA&&(this._quadIA.destroy(),this._quadIA=null)}},{key:"createUBOs",value:function(){if(!this._globalBindings.get(yu.BLOCK.name)){var e=this._root.device.createBuffer({usage:ro.UNIFORM|ro.TRANSFER_DST,memUsage:ao.HOST|ao.DEVICE,size:yu.SIZE});this._globalBindings.set(yu.BLOCK.name,{type:wo.UNIFORM_BUFFER,blockInfo:yu.BLOCK,buffer:e})}if(!this._globalBindings.get(bu.BLOCK.name)){var t=this._root.device.createBuffer({usage:ro.UNIFORM|ro.TRANSFER_DST,memUsage:ao.HOST|ao.DEVICE,size:bu.SIZE});this._globalBindings.set(bu.BLOCK.name,{type:wo.UNIFORM_BUFFER,blockInfo:bu.BLOCK,buffer:t})}return this._globalBindings.get(Eu.name)||this._globalBindings.set(Eu.name,{type:wo.SAMPLER,samplerInfo:Eu}),!0}},{key:"destroyUBOs",value:function(){var e=this._globalBindings.get(yu.BLOCK.name);e&&(e.buffer.destroy(),this._globalBindings.delete(yu.BLOCK.name));var t=this._globalBindings.get(bu.BLOCK.name);t&&(t.buffer.destroy(),this._globalBindings.delete(bu.BLOCK.name))}},{key:"addVisibleModel",value:function(e,t){var i=0;e.node&&(zi.subtract(GS,e.node.worldPosition,t.position),i=zi.dot(GS,t.forward)),this._renderObjects.push({model:e,depth:i})}},{key:"activateFlow",value:function(e){this._activeFlows.push(e),this._activeFlows.sort((function(e,t){return e.priority-t.priority}))}},{key:"_getTextureFormat",value:function(e,t){return e===no.UNKNOWN?t&Eo.COLOR_ATTACHMENT?this._colorFmt:t&Eo.DEPTH_STENCIL_ATTACHMENT?this._depthStencilFmt:no.UNKNOWN:e}}]),e}()).prototype,"_flows",[AS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),MS=v(OS.prototype,"renderTextures",[wS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),LS=v(OS.prototype,"framebuffers",[CS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),PS=v(OS.prototype,"renderPasses",[RS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),kS=OS))||kS));cc.RenderPipeline=VS;var HS=e("RenderPipelineAsset",(DS=Es("cc.RenderPipelineAsset"),FS=Ts({type:VS}),DS((US=v((zS=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),s=0;s<r;s++)a[s]=arguments[s];return m(n=c(this,(e=o(t)).call.apply(e,[this].concat(a))),"renderPipeline",US,u(n)),n}return s(t,e),t}(Tl)).prototype,"renderPipeline",[FS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),NS=zS))||NS));cc.RenderPipelineAsset=HS,cc.textureUtil=zy;var WS=cc.Enum({JPG:0,PNG:1,TIFF:2,WEBP:3,PVR:4,ETC:5,S3TC:6,ATITC:7,TGA:8,RAWDATA:9,UNKNOWN:10}),jS=e("macro",{SUPPORT_TEXTURE_FORMATS:[".pkm",".pvr",".webp",".jpg",".jpeg",".bmp",".png"],KEY:{none:0,back:6,menu:18,backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,pause:19,capslock:20,escape:27,space:32,pageup:33,pagedown:34,end:35,home:36,left:37,up:38,right:39,down:40,select:41,insert:45,Delete:46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,num0:96,num1:97,num2:98,num3:99,num4:100,num5:101,num6:102,num7:103,num8:104,num9:105,"*":106,"+":107,"-":109,numdel:110,"/":111,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123,numlock:144,scrolllock:145,";":186,semicolon:186,equal:187,"=":187,",":188,comma:188,dash:189,".":190,period:190,forwardslash:191,grave:192,"[":219,openbracket:219,backslash:220,"]":221,closebracket:221,quote:222,dpadLeft:1e3,dpadRight:1001,dpadUp:1003,dpadDown:1004,dpadCenter:1005},ImageFormat:WS,RAD:Math.PI/180,DEG:180/Math.PI,REPEAT_FOREVER:Number.MAX_VALUE-1,FLT_EPSILON:1.192092896e-7,MIN_ZINDEX:-Math.pow(2,15),MAX_ZINDEX:Math.pow(2,15)-1,ORIENTATION_PORTRAIT:1,ORIENTATION_LANDSCAPE:2,ORIENTATION_AUTO:3,DENSITYDPI_DEVICE:"device-dpi",DENSITYDPI_HIGH:"high-dpi",DENSITYDPI_MEDIUM:"medium-dpi",DENSITYDPI_LOW:"low-dpi",FIX_ARTIFACTS_BY_STRECHING_TEXEL_TMX:!0,DIRECTOR_STATS_POSITION:new Mi(0,0),ENABLE_STACKABLE_ACTIONS:!0,TOUCH_TIMEOUT:5e3,BATCH_VERTEX_COUNT:2e4,ENABLE_TILEDMAP_CULLING:!0,DOWNLOAD_MAX_CONCURRENT:64,ENABLE_TRANSPARENT_CANVAS:!1,ENABLE_WEBGL_ANTIALIAS:!1,ENABLE_CULLING:!1,CLEANUP_IMAGE_CACHE:!1,SHOW_MESH_WIREFRAME:!1,ENABLE_MULTI_TOUCH:!0});cc.macro=jS;var XS,qS={topLeft:cc.v2(0,0),topRight:cc.v2(0,0),top:cc.v2(0,0),bottomLeft:cc.v2(0,0),bottomRight:cc.v2(0,0),bottom:cc.v2(0,0),center:cc.v2(0,0),left:cc.v2(0,0),right:cc.v2(0,0),width:0,height:0,init:function(e){var t=this.width=e.width,i=this.height=e.height,n=e.x,r=e.y,a=r+i,s=n+t;this.topLeft.x=n,this.topLeft.y=a,this.topRight.x=s,this.topRight.y=a,this.top.x=n+t/2,this.top.y=a,this.bottomLeft.x=n,this.bottomLeft.y=r,this.bottomRight.x=s,this.bottomRight.y=r,this.bottom.x=n+t/2,this.bottom.y=r,this.center.x=n+t/2,this.center.y=r+i/2,this.left.x=n,this.left.y=r+i/2,this.right.x=s,this.right.y=r+i/2}};cc.visibleRect=qS,function(e){e[e.GENERAL=100]="GENERAL"}(XS||(XS={}));var YS,KS=e("RenderView",function(){function e(t,n){i(this,e),this._name="",this._window=null,this._priority=0,this._visibility=ku,this._isEnable=!1,this._flows=[],this._root=t,this._camera=n}return r(e,[{key:"name",get:function(){return this._name}},{key:"window",get:function(){return this._window},set:function(e){this._window=e}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e,cc.director.root&&cc.director.root.sortViews()}},{key:"visibility",set:function(e){this._visibility=e},get:function(){return this._visibility}},{key:"camera",get:function(){return this._camera}},{key:"isEnable",get:function(){return this._isEnable}},{key:"flows",get:function(){return this._flows}}],[{key:"registerCreateFunc",value:function(t){t._createViewFun=function(t,i){return new e(t,i)}}}]),r(e,[{key:"initialize",value:function(e){return this._name=e.name,this.priority=e.priority,this.setExecuteFlows(e.flows),!0}},{key:"destroy",value:function(){this._window=null,this._priority=0}},{key:"enable",value:function(e){this._isEnable=e}},{key:"setExecuteFlows",value:function(e){if(this.flows.length=0,e&&1===e.length&&"UIFlow"===e[0])this._flows.push(cc.director.root.pipeline.getFlow("UIFlow"));else{var t=cc.director.root.pipeline.activeFlows,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r;(a.type===IT.SCENE||e&&-1!==e.indexOf(a.name))&&this.flows.push(a)}}}}]),e}());function ZS(e,t){t<1e3?t=1e3:t>15e3&&(t=15e3);var i=t*t,n=(.860117757+.000154118254*t+1.28641212e-7*i)/(1+.000842420235*t+7.08145163e-7*i),r=(.317398726+422806245e-13*t+4.20481691e-8*i)/(1-289741816e-13*t+1.61456053e-7*i),a=2*n-8*r+4,s=3*n/a,o=2*r/a,l=1/o*s,u=1/o*(1-s-o);e.x=3.2404542*l-1.5371385+-.4985314*u,e.y=-.969266*l+1.8760108+.041556*u,e.z=.0556434*l-.2040259+1.0572252*u}!function(e){e[e.DIRECTIONAL=0]="DIRECTIONAL",e[e.SPHERE=1]="SPHERE",e[e.SPOT=2]="SPOT",e[e.UNKNOWN=3]="UNKNOWN"}(YS||(YS={}));var QS=function(e){return 4*Math.PI*Math.PI*e*e},JS=function(){function e(){i(this,e),this._color=new zi(1,1,1),this._useColorTemp=!1,this._colorTemp=6550,this._colorTempRGB=new zi(1,1,1),this._scene=null,this._node=null,this._name=null,this._type=YS.UNKNOWN}return r(e,[{key:"color",set:function(e){this._color.set(e)},get:function(){return this._color}},{key:"useColorTemperature",set:function(e){this._useColorTemp=e},get:function(){return this._useColorTemp}},{key:"colorTemperature",set:function(e){this._colorTemp=e,ZS(this._colorTempRGB,this._colorTemp)},get:function(){return this._colorTemp}},{key:"colorTemperatureRGB",get:function(){return this._colorTempRGB}},{key:"node",set:function(e){this._node=e,this._node&&(this._node.hasChangedFlags=Nu.ROTATION)},get:function(){return this._node}},{key:"type",get:function(){return this._type}},{key:"name",get:function(){return this._name}},{key:"scene",get:function(){return this._scene}}]),r(e,[{key:"initialize",value:function(e,t){this._name=e,this._type=YS.UNKNOWN,this._node=t}},{key:"attachToScene",value:function(e){this._scene=e}},{key:"detachFromScene",value:function(){this._scene=null}},{key:"destroy",value:function(){this._name=null,this._type=YS.UNKNOWN,this._node=null}},{key:"update",value:function(){}}]),e}();function $S(e,t){return!(!t.worldBounds||Sa.aabb_aabb(t.worldBounds,e.aabb))}function ex(e,t){return!(!t.worldBounds||Sa.aabb_aabb(t.worldBounds,e.aabb)&&Sa.aabb_frustum(t.worldBounds,e.frustum))}(tx=new Wa).accurate=!0;var tx,ix,nx,rx=function(){var e=new zi,t=new zi,i=new fn,n=new Wa;n.accurate=!0;var r=new Bn,a=new Bn,s=new zi,o=new zi;return function(l,u,c,h,f,_){Bn.fromRT(r,c.node.getWorldRotation(i),u.node.getWorldPosition(e)),Bn.invert(a,r),u.getSplitFrustum(n,h,f),n.transform(a),zi.set(s,n.vertices[0].x,n.vertices[0].y,n.vertices[0].z),zi.copy(o,s);for(var d=1;d<n.vertices.length;d++)s.x=Math.min(s.x,n.vertices[d].x),s.y=Math.min(s.y,n.vertices[d].y),s.z=Math.min(s.z,n.vertices[d].z),o.x=Math.max(o.x,n.vertices[d].x),o.y=Math.max(o.y,n.vertices[d].y),o.z=Math.max(o.z,n.vertices[d].z);zi.set(t,(s.x+o.x)/2,(s.y+o.y)/2,o.z),t.z+=_,zi.transformMat4(e,t,r),Bn.fromRT(r,c.node.getWorldRotation(i),e),Wa.createOrtho(l,o.x-s.x,o.y-s.y,0,s.z-_-o.z,r)}}();!function(e){e[e.FORWARD=0]="FORWARD"}(ix||(ix={})),function(e){e[e.FORWARD=0]="FORWARD",e[e.UI=10]="UI"}(nx||(nx={}));var ax=[],sx=[],ox=function(e){function t(){return i(this,t),c(this,o(t).call(this))}return s(t,e),r(t,[{key:"activate",value:function(e){f(o(t.prototype),"activate",this).call(this,e),this._cmdBuff=this._device.createCommandBuffer({allocator:this._device.commandAllocator,type:Co.PRIMARY})}},{key:"destroy",value:function(){this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null)}},{key:"resize",value:function(e,t){}},{key:"rebuild",value:function(){}},{key:"render",value:function(e){this._renderQueues[0].clear();var t=this._pipeline.renderObjects,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}for(var a=r,s=0;s<a.model.subModelNum;s++)for(var o=0;o<a.model.getSubModel(s).passes.length;o++)this._renderQueues[0].insertRenderPass(a,s,o)}this._renderQueues[0].sort();var l=e.window.framebuffer,u=this._cmdBuff,c=e.camera,h=c.viewport;this._renderArea.x=h.x*c.width,this._renderArea.y=h.y*c.height,this._renderArea.width=h.width*c.width,this._renderArea.height=h.height*c.height,sx[0]=c.clearColor,u.begin(),u.beginRenderPass(l,this._renderArea,c.clearFlag,[c.clearColor],c.clearDepth,c.clearStencil),u.execute(this._renderQueues[0].cmdBuffs.array,this._renderQueues[0].cmdBuffCount),u.endRenderPass(),u.end(),ax[0]=u,this._device.queue.submit(ax)}}]),t}(SS);ox.initInfo={name:"UIStage",priority:0,renderQueues:[{isTransparent:!0,stages:["default"],sortMode:aS.BACK_TO_FRONT}],framebuffer:"window"};var lx=function(e){function t(){return i(this,t),c(this,o(t).call(this))}return s(t,e),r(t,[{key:"initialize",value:function(e){f(o(t.prototype),"initialize",this).call(this,e);var i=new ox;return i.initialize(ox.initInfo),this._stages.push(i),!0}},{key:"destroy",value:function(){this.destroyStages()}},{key:"rebuild",value:function(){}},{key:"render",value:function(e){e.camera.update(),this.pipeline.sceneCulling(e),this.pipeline.updateUBOs(e);var i=this.pipeline.defaultGlobalUBOData[yu.EXPOSURE_OFFSET+2];this.pipeline.defaultGlobalUBOData[yu.EXPOSURE_OFFSET+2]=0,this.pipeline.globalBindings.get(yu.BLOCK.name).buffer.update(this.pipeline.defaultGlobalUBOData.buffer),f(o(t.prototype),"render",this).call(this,e),this.pipeline.defaultGlobalUBOData[yu.EXPOSURE_OFFSET+2]=i,this.pipeline.globalBindings.get(yu.BLOCK.name).buffer.update(this.pipeline.defaultGlobalUBOData.buffer)}}]),t}(BS);lx.initInfo={name:"UIFlow",priority:nx.UI,type:IT.UI};var ux,cx,hx,fx,_x,dx,px,mx,vx,gx,yx,bx,Ex,Tx,Sx,xx=function(){function e(){i(this,e),this.queue=new Set}return r(e,[{key:"clear",value:function(){var e=this.queue.values(),t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.clear()}this.queue.clear()}},{key:"recordCommandBuffer",value:function(e){var t=this.queue.values(),i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}for(var a=r,s=!1,o=0;o<a.batches.length;++o){var l=a.batches[o];if(l.mergeCount){for(var u=0;u<l.vbs.length;++u)l.vbs[u].update(l.vbDatas[u]);l.vbIdx.update(l.vbIdxData.buffer),l.ubo.update(l.uboData.view),s||(e.bindPipelineState(l.pso),s=!0),e.bindBindingLayout(l.pso.pipelineLayout.layouts[0]),e.bindInputAssembler(l.ia),e.draw(l.ia)}}}}}]),e}(),Ax=[{r:0,g:0,b:0,a:1}],Cx=[],Rx=Es("ForwardStage")((hx=cx=function(e){function t(){var e;return i(this,t),(e=c(this,o(t).call(this)))._opaqueBatchedQueue=new xx,e}return s(t,e),r(t,[{key:"activate",value:function(e){f(o(t.prototype),"activate",this).call(this,e),this.createCmdBuffer()}},{key:"destroy",value:function(){this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null)}},{key:"resize",value:function(e,t){}},{key:"rebuild",value:function(){}},{key:"render",value:function(e){this._opaqueBatchedQueue.clear(),this._renderQueues.forEach(this.renderQueueClearFunc);for(var t=this._pipeline.renderObjects,i=0;i<t.length;++i){var n=t[i];if(n.model.isDynamicBatching)for(var r=0;r<n.model.subModelNum;++r)for(var a=n.model.subModels[r],s=a.passes,o=0;o<s.length;++o){var l=s[o],u=a.psos[o];if(l.batchedBuffer)l.batchedBuffer.merge(a,n,u),this._opaqueBatchedQueue.queue.add(l.batchedBuffer);else for(var c=0;c<this._renderQueues.length;c++)this._renderQueues[c].insertRenderPass(n,r,o)}else for(var h=0;h<n.model.subModelNum;h++)for(var f=0;f<n.model.getSubModel(h).passes.length;f++)for(var _=0;_<this._renderQueues.length;_++)this._renderQueues[_].insertRenderPass(n,h,f)}this._renderQueues.forEach(this.renderQueueSortFunc);var d,p,m=e.camera,v=this._cmdBuff,g=m.viewport;if(this._renderArea.x=g.x*m.width,this._renderArea.y=g.y*m.height,this._renderArea.width=g.width*m.width*this.pipeline.shadingScale,this._renderArea.height=g.height*m.height*this.pipeline.shadingScale,m.clearFlag&Bo.COLOR)if(this._pipeline.isHDR){d=Ax[0],p=m.clearColor,d.r=p.r*p.r,d.g=p.g*p.g,d.b=p.b*p.b;var y=this._pipeline.fpScale/m.exposure;Ax[0].r*=y,Ax[0].g*=y,Ax[0].b*=y}else Ax[0].r=m.clearColor.r,Ax[0].g=m.clearColor.g,Ax[0].b=m.clearColor.b;Ax[0].a=m.clearColor.a,this._pipeline.usePostProcess?this._pipeline.useMSAA?this._framebuffer=this._pipeline.getFrameBuffer("msaa"):this._framebuffer=this._pipeline.getFrameBuffer(this._pipeline.currShading):this._framebuffer=e.window.framebuffer;var b=m.scene.planarShadows;v.begin(),v.beginRenderPass(this._framebuffer,this._renderArea,m.clearFlag,Ax,m.clearDepth,m.clearStencil),v.execute(this._renderQueues[0].cmdBuffs.array,this._renderQueues[0].cmdBuffCount),this._opaqueBatchedQueue.recordCommandBuffer(v),m.visibility&du.BitMask.DEFAULT&&v.execute(b.cmdBuffs.array,b.cmdBuffCount),v.execute(this._renderQueues[1].cmdBuffs.array,this._renderQueues[1].cmdBuffCount),v.endRenderPass(),v.end(),Cx[0]=v,this._device.queue.submit(Cx),this._pipeline.useMSAA&&this._device.blitFramebuffer(this._framebuffer,this._pipeline.getFrameBuffer(this._pipeline.currShading),this._renderArea,this._renderArea,go.POINT)}}]),t}(SS),cx.initInfo={name:"ForwardStage",priority:ix.FORWARD,renderQueues:[{isTransparent:!1,sortMode:aS.FRONT_TO_BACK,stages:["default"]},{isTransparent:!0,sortMode:aS.BACK_TO_FRONT,stages:["default","planarShadow"]}]},ux=hx))||ux,kx=Es("ForwardFlow")((dx=_x=function(e){function t(){return i(this,t),c(this,o(t).call(this))}return s(t,e),r(t,[{key:"initialize",value:function(e){f(o(t.prototype),"initialize",this).call(this,e);var i=new Rx;i.initialize(Rx.initInfo),this._stages.push(i)}},{key:"render",value:function(e){e.camera.update(),this.pipeline.sceneCulling(e),this.pipeline.updateUBOs(e),f(o(t.prototype),"render",this).call(this,e)}},{key:"destroy",value:function(){this.destroyStages()}},{key:"rebuild",value:function(){}}]),t}(BS),_x.initInfo={name:"ForwardFlow",priority:nx.FORWARD},fx=dx))||fx,Ox=new Float32Array(4),Ix=Dr.create(0,0,0,1),Mx=[],Lx=[],Px=new zi,Bx=Es("ForwardPipeline")((vx=mx=function(e){function t(){var e;return i(this,t),(e=c(this,o(t).call(this)))._uboLights=new Au,e._lightsUBO=null,e._validLights=[],e._lightIndexOffset=[],e._lightIndices=[],e}return s(t,e),r(t,[{key:"lightsUBO",get:function(){return this._lightsUBO}}]),r(t,[{key:"initialize",value:function(e){f(o(t.prototype),"initialize",this).call(this,e);var i=new kx;i.initialize(kx.initInfo),this._flows.push(i)}},{key:"activate",value:function(e){if(!f(o(t.prototype),"activate",this).call(this,e))return!1;this._usePostProcess&&(this._useSMAA,this.getFlow("ToneMapFlow").activate(this));var i=new lx;return i.initialize(lx.initInfo),this._flows.push(i),i.activate(this),!0}},{key:"destroy",value:function(){var e=this._globalBindings.get(Au.BLOCK.name);e&&(e.buffer.destroy(),this._globalBindings.delete(Au.BLOCK.name)),this._destroy()}},{key:"rebuild",value:function(){f(o(t.prototype),"rebuild",this).call(this);for(var e=0;e<this._flows.length;e++)this._flows[e].rebuild()}},{key:"updateUBOs",value:function(e){f(o(t.prototype),"updateUBOs",this).call(this,e);for(var i=e.camera.exposure,n=0;n<this._renderObjects.length;n++){this._uboLights.view.fill(0);var r=n+1<this._renderObjects.length?this._lightIndexOffset[n+1]:this._lightIndices.length;if(this._renderObjects[n].model.localBindings.get(Au.BLOCK.name)){for(var a=0,s=0,l=this._lightIndexOffset[n];l<r;l++){var u=this._validLights[this._lightIndices[l]];if(u)switch(u.type){case YS.SPHERE:if(a>=Au.MAX_SPHERE_LIGHTS)continue;var c=u;if(zi.toArray(Ox,c.position),this._uboLights.view.set(Ox,Au.SPHERE_LIGHT_POS_OFFSET+4*a),Ox[0]=c.size,Ox[1]=c.range,Ox[2]=0,this._uboLights.view.set(Ox,Au.SPHERE_LIGHT_SIZE_RANGE_OFFSET+4*a),zi.toArray(Ox,u.color),u.useColorTemperature){var h=u.colorTemperatureRGB;Ox[0]*=h.x,Ox[1]*=h.y,Ox[2]*=h.z}this._isHDR?Ox[3]=c.luminance*this._fpScale*this._lightMeterScale:Ox[3]=c.luminance*i*this._lightMeterScale,this._uboLights.view.set(Ox,Au.SPHERE_LIGHT_COLOR_OFFSET+4*a),a++;break;case YS.SPOT:if(s>=Au.MAX_SPOT_LIGHTS)continue;var _=u;if(zi.toArray(Ox,_.position),Ox[3]=_.size,this._uboLights.view.set(Ox,Au.SPOT_LIGHT_POS_OFFSET+4*s),Ox[0]=_.size,Ox[1]=_.range,Ox[2]=_.spotAngle,this._uboLights.view.set(Ox,Au.SPOT_LIGHT_SIZE_RANGE_ANGLE_OFFSET+4*s),zi.toArray(Ox,_.direction),this._uboLights.view.set(Ox,Au.SPOT_LIGHT_DIR_OFFSET+4*s),zi.toArray(Ox,u.color),u.useColorTemperature){var d=u.colorTemperatureRGB;Ox[0]*=d.x,Ox[1]*=d.y,Ox[2]*=d.z}this._isHDR?Ox[3]=_.luminance*this._fpScale*this._lightMeterScale:Ox[3]=_.luminance*i*this._lightMeterScale,this._uboLights.view.set(Ox,Au.SPOT_LIGHT_COLOR_OFFSET+4*s),s++}}this._renderObjects[n].model.localBindings.get(Au.BLOCK.name).buffer.update(this._uboLights.view)}}}},{key:"sceneCulling",value:function(e){f(o(t.prototype),"sceneCulling",this).call(this,e),this._validLights.length=0;for(var i=e.camera.scene.sphereLights,n=0;n<i.length;n++){var r=i[n];r.update(),Dr.set(Ix,r.position.x,r.position.y,r.position.z,r.range),Sa.sphere_frustum(Ix,e.camera.frustum)&&this._validLights.push(r)}for(var a=e.camera.scene.spotLights,s=0;s<a.length;s++){var l=a[s];l.update(),Dr.set(Ix,l.position.x,l.position.y,l.position.z,l.range),Sa.sphere_frustum(Ix,e.camera.frustum)&&this._validLights.push(l)}this._lightIndexOffset.length=0,this._lightIndices.length=0;for(var u=0;u<this._renderObjects.length;u++)this._lightIndexOffset[u]=this._lightIndices.length,this._renderObjects[u].model.localBindings.get(Au.BLOCK.name)&&this.cullLightPerModel(this._renderObjects[u].model)}},{key:"createUBOs",value:function(){if(!this._globalBindings.get(Au.BLOCK.name)){var e=this._root.device.createBuffer({usage:ro.UNIFORM|ro.TRANSFER_DST,memUsage:ao.HOST|ao.DEVICE,size:Au.SIZE});if(!e)return!1;this._globalBindings.set(Au.BLOCK.name,{type:wo.UNIFORM_BUFFER,blockInfo:Au.BLOCK,buffer:e})}return f(o(t.prototype),"createUBOs",this).call(this)}},{key:"cullLightPerModel",value:function(e){Mx.length=0;for(var t=0;t<this._validLights.length;t++){var i=!1;switch(this._validLights[t].type){case YS.DIRECTIONAL:this._validLights[t],i=!1;break;case YS.SPHERE:i=$S(this._validLights[t],e);break;case YS.SPOT:i=ex(this._validLights[t],e)}i||(Mx.push(t),this._validLights[t].type===YS.DIRECTIONAL?Lx[t]=0:Lx[t]=zi.distance(this._validLights[t].position,e.node.getWorldPosition(Px)))}Mx.sort(this.sortLight),Array.prototype.push.apply(this._lightIndices,Mx)}},{key:"sortLight",value:function(e,t){return Lx[e]-Lx[t]}}]),t}(VS),mx.initInfo={},px=vx))||px,Dx=[],Fx=Es("ToneMapStage")((bx=yx=function(e){function t(){var e;return i(this,t),(e=c(this,o(t).call(this)))._hTexSampler=0,e._hBlendTexSampler=0,e._bindingLayout=null,e}return s(t,e),r(t,[{key:"activate",value:function(e){f(o(t.prototype),"activate",this).call(this,e),this._createCmdBuffer(),this.rebuild()}},{key:"_createCmdBuffer",value:function(){this._cmdBuff=this._device.createCommandBuffer({allocator:this._device.commandAllocator,type:Co.PRIMARY})}},{key:"destroy",value:function(){this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null)}},{key:"resize",value:function(e,t){}},{key:"rebuild",value:function(){this._pass=this._flow.material.passes[0],this._hTexSampler=this._pass.getBinding("u_texSampler");var e=this._pipeline.globalBindings.get(yu.BLOCK.name);this._pso=this._pass.createPipelineState(),this._bindingLayout=this._pso.pipelineLayout.layouts[0],this._pass.bindBuffer(yu.BLOCK.binding,e.buffer),this._pass.bindTextureView(this._hTexSampler,this._pipeline.getTextureView(this._pipeline.currShading)),this._pipeline.useSMAA&&(this._hBlendTexSampler=this._pass.getBinding("u_blendTexSampler"),this._pass.bindTextureView(this._hBlendTexSampler,this._pipeline.getTextureView("smaaBlend"))),this._pass.update(),this._bindingLayout.update()}},{key:"render",value:function(e){var t=e.camera;if(this._cmdBuff){this._renderArea.width=t.width,this._renderArea.height=t.height;var i=e.window.framebuffer;this._cmdBuff.begin(),this._cmdBuff.beginRenderPass(i,this._renderArea,Bo.ALL,[{r:0,g:0,b:0,a:1}],1,0),this._cmdBuff.bindPipelineState(this._pso),this._cmdBuff.bindBindingLayout(this._pso.pipelineLayout.layouts[0]),this._cmdBuff.bindInputAssembler(this._pipeline.quadIA),this._cmdBuff.draw(this._pipeline.quadIA),this._cmdBuff.endRenderPass(),this._cmdBuff.end()}Dx[0]=this._cmdBuff,this._device.queue.submit(Dx)}}]),t}(SS),yx.initInfo={name:"ToneMapStage",priority:0,framebuffer:"window"},gx=bx))||gx;Es("ToneMapFlow")((Sx=Tx=function(e){function t(){return i(this,t),c(this,o(t).call(this))}return s(t,e),r(t,[{key:"initialize",value:function(e){f(o(t.prototype),"initialize",this).call(this,e),this._material.recompileShaders({CC_USE_SMAA:this._pipeline.useSMAA});var i=new Fx;return i.initialize(Fx.initInfo),this._stages.push(i),!0}},{key:"destroy",value:function(){this._material&&this._material.destroy(),this.destroyStages()}},{key:"rebuild",value:function(){this._material&&this._material.recompileShaders({CC_USE_SMAA:this._pipeline.useSMAA});var e=this._stages,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.rebuild()}}}]),t}(BS),Tx.initInfo={name:"ToneMapFlow",priority:nx.FORWARD+1},Ex=Sx));cc.RenderPassStage=pu;var Nx=e("Game",function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),s=0;s<r;s++)a[s]=arguments[s];return(n=c(this,(e=o(t)).call.apply(e,[this].concat(a)))).frame=null,n.container=null,n.canvas=null,n.renderType=-1,n.eventTargetOn=f(o(t.prototype),"on",u(n)),n.eventTargetOnce=f(o(t.prototype),"once",u(n)),n.config={},n.onStart=null,n._persistRootNodes={},n._paused=!0,n._configLoaded=!1,n._isCloning=!1,n._prepared=!1,n._rendererInitialized=!1,n._gfxDevice=null,n._intervalId=null,n._lastTime=null,n._frameTime=null,n._sceneInfos=[],n.collisionMatrix=[],n.groupList=[],n}return s(t,e),r(t,[{key:"setFrameRate",value:function(e){var t=this.config;"number"!=typeof e&&(e=parseInt(e),isNaN(e)&&(e=60)),t.frameRate=e,this._intervalId&&window.cancelAnimationFrame(this._intervalId),this._intervalId=0,this._paused=!0,this._setAnimFrame(),this._runMainLoop()}},{key:"getFrameRate",value:function(){return this.config.frameRate||0}},{key:"step",value:function(){cc.director.mainLoop()}},{key:"pause",value:function(){this._paused||(this._paused=!0,this._intervalId&&(window.cancelAnimationFrame(this._intervalId),this._intervalId=0))}},{key:"resume",value:function(){this._paused&&(this._paused=!1,this._runMainLoop())}},{key:"isPaused",value:function(){return this._paused}},{key:"restart",value:function(){cc.director.once(cc.Director.EVENT_AFTER_DRAW,(function(){for(var e in cc.game._persistRootNodes)cc.game.removePersistRootNode(cc.game._persistRootNodes[e]);cc.director.getScene().destroy(),cc.Object._deferredDestroy(),cc.director.purgeDirector(),cc.director.reset(),cc.game.onStart()}))}},{key:"end",value:function(){this._gfxDevice&&(this._gfxDevice.destroy(),this._gfxDevice=null),close()}},{key:"on",value:function(e,i,n){this._prepared&&e===t.EVENT_ENGINE_INITED?i.call(n):this.eventTargetOn(e,i,n)}},{key:"once",value:function(e,i,n){this._prepared&&e===t.EVENT_ENGINE_INITED?i.call(n):this.eventTargetOnce(e,i,n)}},{key:"run",value:function(e,t){this._initConfig(e),this.onStart=t,this.prepare(cc.game.onStart&&cc.game.onStart.bind(cc.game))}},{key:"addPersistRootNode",value:function(e){if(cc.Node.isNode(e)&&e.uuid){var t=e.uuid;if(!this._persistRootNodes[t]){var i=cc.director._scene;if(cc.isValid(i))if(e.parent){if(!(e.parent instanceof cc.Scene))return void N(3801);if(e.parent!==i)return void N(3802)}else e.parent=i;this._persistRootNodes[t]=e,e._persistNode=!0}}else N(3800)}},{key:"removePersistRootNode",value:function(e){var t=e.uuid||"";e===this._persistRootNodes[t]&&(delete this._persistRootNodes[t],e._persistNode=!1)}},{key:"isPersistRootNode",value:function(e){return e._persistNode}},{key:"prepare",value:function(e){var i=this;if(this._prepared)e&&e();else{this._initEngine((function(){i._setAnimFrame(),i._runMainLoop(),i.emit(t.EVENT_GAME_INITED),e&&e()}))}}},{key:"_initEngine",value:function(e){var i=this;this._initRenderer(),this._initEvents(),console.log("Cocos Creator 3D v"+cc.ENGINE_VERSION),this.emit(t.EVENT_ENGINE_INITED),this._prepared=!0;var n=this.config;cc.loader.load({uuid:n.renderPipeline},(function(r,a){!r&&a instanceof cc.RenderPipeline?i.setRenderPipeline(a):(console.error("Failed load renderpipeline: ".concat(n.renderPipeline,", engine failed to initialize, all process stoped")),console.error(r),i.setRenderPipeline(null)),i._rendererInitialized=!0,i.emit(t.EVENT_RENDERER_INITED),cc.internal.SplashScreenWebgl?(cc.internal.SplashScreenWebgl.instance.setOnFinish(e),cc.internal.SplashScreenWebgl.instance.loadFinish=!0):e&&e()}))}},{key:"_setAnimFrame",value:function(){this._lastTime=new Date;var e=cc.game.config.frameRate;this._frameTime=1e3/e,60!==e&&30!==e?(window.requestAnimationFrame=this._stTime,window.cancelAnimationFrame=this._ctTime):(window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||this._stTime,window.cancelAnimationFrame=window.cancelAnimationFrame||window.cancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.webkitCancelRequestAnimationFrame||window.msCancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.ocancelAnimationFrame||this._ctTime)}},{key:"_stTime",value:function(e){var t=(new Date).getTime(),i=Math.max(0,cc.game._frameTime-(t-cc.game._lastTime)),n=window.setTimeout(e,i);return cc.game._lastTime=t+i,n}},{key:"_ctTime",value:function(e){window.clearTimeout(e)}},{key:"_runMainLoop",value:function(){var e,t=this,i=this.config,n=cc.director,r=!0,a=i.frameRate;X(!!i.showFPS),e=function(i){t._paused||(t._intervalId=window.requestAnimationFrame(e),30===a&&(r=!r)||n.mainLoop(i))},this._intervalId=window.requestAnimationFrame(e),this._paused=!1}},{key:"_initConfig",value:function(e){"number"!=typeof e.debugMode&&(e.debugMode=0),e.exposeClassName=!!e.exposeClassName,"number"!=typeof e.frameRate&&(e.frameRate=60);var t=e.renderMode;("number"!=typeof t||t>2||t<0)&&(e.renderMode=0),"boolean"!=typeof e.registerSystemEvent&&(e.registerSystemEvent=!0),e.showFPS=!!e.showFPS,this._sceneInfos=e.scenes||[],this.collisionMatrix=e.collisionMatrix||[],this.groupList=e.groupList||[],M(e.debugMode),this.config=e,this._configLoaded=!0}},{key:"_determineRenderType",value:function(){var e=this.config,i=parseInt(e.renderMode);this.renderType=t.RENDER_TYPE_CANVAS;var n=!1;if(0===i?cc.sys.capabilities.opengl?(this.renderType=t.RENDER_TYPE_WEBGL,n=!0):cc.sys.capabilities.canvas&&(this.renderType=t.RENDER_TYPE_CANVAS,n=!0):1===i&&cc.sys.capabilities.canvas?(this.renderType=t.RENDER_TYPE_CANVAS,n=!0):2===i&&cc.sys.capabilities.opengl&&(this.renderType=t.RENDER_TYPE_WEBGL,n=!0),!n)throw new Error(W(3820,i))}},{key:"_initRenderer",value:function(){if(!this._rendererInitialized){var e;if(this.canvas=this.config.adapter.canvas,this.frame=this.config.adapter.frame,this.container=this.config.adapter.container,e=this.canvas,this._determineRenderType(),this.renderType===t.RENDER_TYPE_WEBGL){var i=!!window.WebGL2RenderingContext,n=window.navigator.userAgent.toLowerCase();(-1!==n.indexOf("safari")&&-1===n.indexOf("chrome")||Il.browserType===Il.BROWSER_TYPE_UC)&&(i=!1),i&&cc.WebGL2GFXDevice?this._gfxDevice=new cc.WebGL2GFXDevice:cc.WebGLGFXDevice&&(this._gfxDevice=new cc.WebGLGFXDevice);var r={canvasElm:e,debug:!0,devicePixelRatio:window.devicePixelRatio,nativeWidth:Math.floor(screen.width*cc.view._devicePixelRatio),nativeHeight:Math.floor(screen.height*cc.view._devicePixelRatio)};!this._gfxDevice.initialize(r)&&i&&(this._gfxDevice=new cc.WebGLGFXDevice,this._gfxDevice.initialize(r))}if(!this._gfxDevice)return console.error("can not support canvas rendering in 3D"),void(this.renderType=t.RENDER_TYPE_CANVAS);this.canvas.oncontextmenu=function(){if(!cc._isContextMenuEnable)return!1}}}},{key:"_initEvents",value:function(){var e,i=window;void 0!==document.hidden?e="hidden":void 0!==document.mozHidden?e="mozHidden":void 0!==document.msHidden?e="msHidden":void 0!==document.webkitHidden&&(e="webkitHidden");var n=!1;function r(){n||(n=!0,cc.game.emit(t.EVENT_HIDE))}function a(){n&&(n=!1,cc.game.emit(t.EVENT_SHOW))}if(e)for(var s=["visibilitychange","mozvisibilitychange","msvisibilitychange","webkitvisibilitychange","qbrowserVisibilityChange"],o=0;o<s.length;o++)document.addEventListener(s[o],(function(t){var i=document[e];(i=i||t.hidden)?r():a()}));else i.addEventListener("blur",r),i.addEventListener("focus",a);navigator.userAgent.indexOf("MicroMessenger")>-1&&(i.onfocus=a),"onpageshow"in window&&"onpagehide"in window&&(i.addEventListener("pagehide",r),i.addEventListener("pageshow",a),document.addEventListener("pagehide",r),document.addEventListener("pageshow",a)),this.on(t.EVENT_HIDE,(function(){cc.game.pause()})),this.on(t.EVENT_SHOW,(function(){cc.game.resume()}))}},{key:"setRenderPipeline",value:function(e){e||(e=new Bx).initialize(Bx.initInfo),cc.director.root.setRenderPipeline(e)||this.setRenderPipeline(null)}}]),t}(ol));Nx.EVENT_HIDE="game_on_hide",Nx.EVENT_SHOW="game_on_show",Nx.EVENT_GAME_INITED="game_inited",Nx.EVENT_ENGINE_INITED="engine_inited",Nx.EVENT_RENDERER_INITED="renderer_inited",Nx.RENDER_TYPE_CANVAS=0,Nx.RENDER_TYPE_WEBGL=1,Nx.RENDER_TYPE_OPENGL=2,cc.Game=Nx;var zx=e("game",cc.game=new Nx),Ux=new(function(){function e(){i(this,e),this.meta={width:"device-width"},this.adaptationType=cc.sys.browserType}return r(e,[{key:"init",value:function(){this.html=document.getElementsByTagName("html")[0]}},{key:"availWidth",value:function(e){return cc.sys.isMobile||!e||e===this.html?window.innerWidth:e.clientWidth}},{key:"availHeight",value:function(e){return cc.sys.isMobile||!e||e===this.html?window.innerHeight:e.clientHeight}}]),e}());switch(cc.sys.os===cc.sys.OS_IOS&&(Ux.adaptationType=cc.sys.BROWSER_TYPE_SAFARI),Ux.adaptationType){case cc.sys.BROWSER_TYPE_SAFARI:Ux.meta["minimal-ui"]="true";case cc.sys.BROWSER_TYPE_SOUGOU:case cc.sys.BROWSER_TYPE_UC:Ux.availWidth=function(e){return e.clientWidth},Ux.availHeight=function(e){return e.clientHeight};break;case cc.sys.BROWSER_TYPE_WECHAT_GAME:Ux.availWidth=function(){return window.innerWidth},Ux.availHeight=function(){return window.innerHeight};break;case cc.sys.BROWSER_TYPE_WECHAT_GAME_SUB:var Gx=window.sharedCanvas||wx.getSharedCanvas();Ux.availWidth=function(){return Gx.width},Ux.availHeight=function(){return Gx.height}}var Vx=null,Hx=e("View",function(e){function t(){var e;i(this,t);u(e=c(this,o(t).call(this)));var n=Wx,r=jx;return e._frameSize=new Xn(0,0),e._designResolutionSize=new Xn(0,0),e._originalDesignResolutionSize=new Xn(0,0),e._scaleX=1,e._scaleY=1,e._viewportRect=new Jn(0,0,0,0),e._visibleRect=new Jn(0,0,0,0),e._autoFullScreen=!1,e._devicePixelRatio=1,e._retinaEnabled=!1,e._resizeCallback=null,e._resizing=!1,e._resizeWithBrowserSize=!1,e._orientationChanging=!0,e._isRotated=!1,e._orientation=cc.macro.ORIENTATION_AUTO,e._isAdjustViewport=!0,e._antiAliasEnabled=!1,e._resolutionPolicy=null,e._rpExactFit=new Xx(n.EQUAL_TO_FRAME,r.EXACT_FIT),e._rpShowAll=new Xx(n.EQUAL_TO_FRAME,r.SHOW_ALL),e._rpNoBorder=new Xx(n.EQUAL_TO_FRAME,r.NO_BORDER),e._rpFixedHeight=new Xx(n.EQUAL_TO_FRAME,r.FIXED_HEIGHT),e._rpFixedWidth=new Xx(n.EQUAL_TO_FRAME,r.FIXED_WIDTH),cc.game.once(cc.Game.EVENT_ENGINE_INITED,e.init,u(e)),e}return s(t,e),r(t,[{key:"init",value:function(){Ux.init(),this._initFrameSize(),this.enableAntiAlias(!0);var e=cc.game.canvas.width,t=cc.game.canvas.height;this._designResolutionSize.width=e,this._designResolutionSize.height=t,this._originalDesignResolutionSize.width=e,this._originalDesignResolutionSize.height=t,this._viewportRect.width=e,this._viewportRect.height=t,this._visibleRect.width=e,this._visibleRect.height=t,cc.winSize.width=this._visibleRect.width,cc.winSize.height=this._visibleRect.height,cc.visibleRect&&cc.visibleRect.init(this._visibleRect)}},{key:"resizeWithBrowserSize",value:function(e){e?this._resizeWithBrowserSize||(this._resizeWithBrowserSize=!0,window.addEventListener("resize",this._resizeEvent),window.addEventListener("orientationchange",this._orientationChange)):this._resizeWithBrowserSize&&(this._resizeWithBrowserSize=!1,window.removeEventListener("resize",this._resizeEvent),window.removeEventListener("orientationchange",this._orientationChange))}},{key:"setResizeCallback",value:function(e){"function"!=typeof e&&null!=e||(this._resizeCallback=e)}},{key:"setOrientation",value:function(e){(e&=cc.macro.ORIENTATION_AUTO)&&this._orientation!==e&&(this._orientation=e)}},{key:"adjustViewportMeta",value:function(e){this._isAdjustViewport=e}},{key:"enableRetina",value:function(e){this._retinaEnabled=!!e}},{key:"isRetinaEnabled",value:function(){return this._retinaEnabled}},{key:"enableAntiAlias",value:function(e){if(this._antiAliasEnabled!==e)if(this._antiAliasEnabled=e,cc.game.renderType===cc.Game.RENDER_TYPE_WEBGL){var t=cc.loader._cache;for(var i in t){var n=t[i],r=n&&n.content instanceof cc.Texture2D?n.content:null;if(r){var a=cc.Texture2D.Filter;e?r.setFilters(a.LINEAR,a.LINEAR):r.setFilters(a.NEAREST,a.NEAREST)}}}else if(cc.game.renderType===cc.Game.RENDER_TYPE_CANVAS){var s=cc.game.canvas.getContext("2d");s.imageSmoothingEnabled=e,s.mozImageSmoothingEnabled=e}}},{key:"isAntiAliasEnabled",value:function(){return this._antiAliasEnabled}},{key:"enableAutoFullScreen",value:function(e){e&&e!==this._autoFullScreen&&cc.sys.isMobile&&cc.sys.browserType!==cc.sys.BROWSER_TYPE_WECHAT?(this._autoFullScreen=!0,cc.screen.autoFullScreen(cc.game.frame)):this._autoFullScreen=!1}},{key:"isAutoFullScreenEnabled",value:function(){return this._autoFullScreen}},{key:"setCanvasSize",value:function(e,t){var i=cc.game.canvas,n=cc.game.container;i.width=e*this._devicePixelRatio,i.height=t*this._devicePixelRatio,i.style.width=e+"px",i.style.height=t+"px",n.style.width=e+"px",n.style.height=t+"px",this._resizeEvent()}},{key:"getCanvasSize",value:function(){return cc.size(cc.game.canvas.width,cc.game.canvas.height)}},{key:"getFrameSize",value:function(){return cc.size(this._frameSize.width,this._frameSize.height)}},{key:"setFrameSize",value:function(e,t){this._frameSize.width=e,this._frameSize.height=t,cc.frame.style.width=e+"px",cc.frame.style.height=t+"px",this._resizeEvent()}},{key:"getVisibleSize",value:function(){return cc.size(this._visibleRect.width,this._visibleRect.height)}},{key:"getVisibleSizeInPixel",value:function(){return cc.size(this._visibleRect.width*this._scaleX,this._visibleRect.height*this._scaleY)}},{key:"getVisibleOrigin",value:function(){return cc.v2(this._visibleRect.x,this._visibleRect.y)}},{key:"getVisibleOriginInPixel",value:function(){return cc.v2(this._visibleRect.x*this._scaleX,this._visibleRect.y*this._scaleY)}},{key:"getResolutionPolicy",value:function(){return this._resolutionPolicy}},{key:"setResolutionPolicy",value:function(e){var t=this;if(e instanceof Xx)t._resolutionPolicy=e;else{var i=Xx;e===i.EXACT_FIT&&(t._resolutionPolicy=t._rpExactFit),e===i.SHOW_ALL&&(t._resolutionPolicy=t._rpShowAll),e===i.NO_BORDER&&(t._resolutionPolicy=t._rpNoBorder),e===i.FIXED_HEIGHT&&(t._resolutionPolicy=t._rpFixedHeight),e===i.FIXED_WIDTH&&(t._resolutionPolicy=t._rpFixedWidth)}}},{key:"setDesignResolutionSize",value:function(e,t,i){if(e>0||t>0){this.setResolutionPolicy(i);var n=this._resolutionPolicy;if(n&&n.preApply(this),cc.sys.isMobile&&this._adjustViewportMeta(),this._orientationChanging=!0,this._resizing||this._initFrameSize(),n){this._originalDesignResolutionSize.width=this._designResolutionSize.width=e,this._originalDesignResolutionSize.height=this._designResolutionSize.height=t;var r=n.apply(this,this._designResolutionSize);if(r.scale&&2===r.scale.length&&(this._scaleX=r.scale[0],this._scaleY=r.scale[1]),r.viewport){var a=this._viewportRect,s=this._visibleRect,o=r.viewport;a.x=o.x,a.y=o.y,a.width=o.width,a.height=o.height,s.x=0,s.y=0,s.width=o.width/this._scaleX,s.height=o.height/this._scaleY}n.postApply(this),cc.winSize.width=this._visibleRect.width,cc.winSize.height=this._visibleRect.height,qS&&qS.init(this._visibleRect),this.emit("design-resolution-changed")}else cc.logID(2201)}else cc.logID(2200)}},{key:"getDesignResolutionSize",value:function(){return cc.size(this._designResolutionSize.width,this._designResolutionSize.height)}},{key:"setRealPixelResolution",value:function(e,t,i){this._setViewportMeta({width:e},!0),document.documentElement.style.width=e+"px",document.body.style.width=e+"px",document.body.style.left="0px",document.body.style.top="0px",this.setDesignResolutionSize(e,t,i)}},{key:"setViewportInPoints",value:function(e,t,i,n){var r=this._scaleX,a=this._scaleY;cc.game._renderContext.viewport(e*r+this._viewportRect.x,t*a+this._viewportRect.y,i*r,n*a)}},{key:"setScissorInPoints",value:function(e,t,i,n){var r=this._scaleX,a=this._scaleY,s=Math.ceil(e*r+this._viewportRect.x),o=Math.ceil(t*a+this._viewportRect.y),l=Math.ceil(i*r),u=Math.ceil(n*a),c=cc.game._renderContext;if(!Vx){var h=c.getParameter(c.SCISSOR_BOX);Vx=new Jn(h[0],h[1],h[2],h[3])}Vx.x===s&&Vx.y===o&&Vx.width===l&&Vx.height===u||(Vx.x=s,Vx.y=o,Vx.width=l,Vx.height=u,c.scissor(s,o,l,u))}},{key:"isScissorEnabled",value:function(){var e=cc.game._renderContext;return e.isEnabled(e.SCISSOR_TEST)}},{key:"getScissorRect",value:function(){var e=cc.game._renderContext;if(!Vx){var t=e.getParameter(e.SCISSOR_BOX);Vx=new Jn(t[0],t[1],t[2],t[3])}var i=1/this._scaleX,n=1/this._scaleY;return new Jn((Vx.x-this._viewportRect.x)*i,(Vx.y-this._viewportRect.y)*n,Vx.width*i,Vx.height*n)}},{key:"getViewportRect",value:function(){return this._viewportRect}},{key:"getScaleX",value:function(){return this._scaleX}},{key:"getScaleY",value:function(){return this._scaleY}},{key:"getDevicePixelRatio",value:function(){return this._devicePixelRatio}},{key:"convertToLocationInView",value:function(e,t,i,n){var r=n||cc.v2(),a=this._devicePixelRatio*(e-i.left),s=this._devicePixelRatio*(i.top+i.height-t);return this._isRotated?(r.x=cc.game.canvas.width-s,r.y=a):(r.x=a,r.y=s),r}},{key:"_convertPointWithScale",value:function(e){var t=this._viewportRect;e.x=(e.x-t.x)/this._scaleX,e.y=(e.y-t.y)/this._scaleY}},{key:"_resizeEvent",value:function(){var e=cc.view,t=e._frameSize.width,i=e._frameSize.height,n=e._isRotated;if(cc.sys.isMobile){var r=cc.game.container.style,a=r.margin;r.margin="0",r.display="none",e._initFrameSize(),r.margin=a,r.display="block"}else e._initFrameSize();if(e._orientationChanging||e._isRotated!==n||e._frameSize.width!==t||e._frameSize.height!==i){var s=e._originalDesignResolutionSize.width,o=e._originalDesignResolutionSize.height;e._resizing=!0,s>0&&e.setDesignResolutionSize(s,o,e._resolutionPolicy),e._resizing=!1,e._resizeCallback&&e._resizeCallback.call()}}},{key:"_orientationChange",value:function(){cc.view._orientationChanging=!0,cc.view._resizeEvent()}},{key:"_initFrameSize",value:function(){var e=this._frameSize,t=Ux.availWidth(cc.game.frame),i=Ux.availHeight(cc.game.frame),n=t>=i;!cc.sys.isMobile||n&&this._orientation&cc.macro.ORIENTATION_LANDSCAPE||!n&&this._orientation&cc.macro.ORIENTATION_PORTRAIT?(e.width=t,e.height=i,cc.game.container.style["-webkit-transform"]="rotate(0deg)",cc.game.container.style.transform="rotate(0deg)",this._isRotated=!1):(e.width=i,e.height=t,cc.game.container.style["-webkit-transform"]="rotate(90deg)",cc.game.container.style.transform="rotate(90deg)",cc.game.container.style["-webkit-transform-origin"]="0px 0px 0px",cc.game.container.style.transformOrigin="0px 0px 0px",this._isRotated=!0,cc.game.canvas.style["-webkit-transform"]="translateZ(0px)",cc.game.canvas.style.transform="translateZ(0px)"),this._orientationChanging&&setTimeout((function(){cc.view._orientationChanging=!1}),1e3)}},{key:"_adjustSizeKeepCanvasSize",value:function(){var e=this._originalDesignResolutionSize.width,t=this._originalDesignResolutionSize.height;e>0&&this.setDesignResolutionSize(e,t,this._resolutionPolicy)}},{key:"_setViewportMeta",value:function(e,t){var i=document.getElementById("cocosMetaElement");i&&t&&document.head.removeChild(i);var n,r,a,s=document.getElementsByName("viewport"),o=s?s[0]:null;for(r in n=o?o.content:"",(i=i||document.createElement("meta")).id="cocosMetaElement",i.name="viewport",i.content="",e)-1===n.indexOf(r)?n+=","+r+"="+e[r]:t&&(a=new RegExp(r+"s*=s*[^,]+"),n.replace(a,r+"="+e[r]));/^,/.test(n)&&(n=n.substr(1)),i.content=n,o&&(o.content=n),document.head.appendChild(i)}},{key:"_adjustViewportMeta",value:function(){this._isAdjustViewport&&(this._setViewportMeta(Ux.meta,!1),this._isAdjustViewport=!1)}},{key:"_convertMouseToLocation",value:function(e,t){e.x=this._devicePixelRatio*(e.x-t.left),e.y=this._devicePixelRatio*(t.top+t.height-e.y)}},{key:"_convertTouchWidthScale",value:function(e){var t=this._viewportRect,i=this._scaleX,n=this._scaleY;e._point.x=(e._point.x-t.x)/i,e._point.y=(e._point.y-t.y)/n,e._prevPoint.x=(e._prevPoint.x-t.x)/i,e._prevPoint.y=(e._prevPoint.y-t.y)/n}},{key:"_convertTouchesWithScale",value:function(e){for(var t,i,n=this._viewportRect,r=this._scaleX,a=this._scaleY,s=0;s<e.length;s++){var o=e[s];t=o._point,i=o._prevPoint,t.x=(t.x-n.x)/r,t.y=(t.y-n.y)/a,i.x=(i.x-n.x)/r,i.y=(i.y-n.y)/a}}}]),t}(ol)),Wx=function(){function e(){i(this,e),this.name="ContainerStrategy"}return r(e,[{key:"preApply",value:function(e){}},{key:"apply",value:function(e,t){}},{key:"postApply",value:function(e){}},{key:"_setupContainer",value:function(e,t,i){var n=cc.game.canvas,r=cc.game.container;cc.sys.platform!==cc.sys.WECHAT_GAME&&(cc.sys.os===cc.sys.OS_ANDROID&&(document.body.style.width=(e._isRotated?i:t)+"px",document.body.style.height=(e._isRotated?t:i)+"px"),r.style.width=n.style.width=t+"px",r.style.height=n.style.height=i+"px");var a=e._devicePixelRatio=1;e.isRetinaEnabled()&&(a=e._devicePixelRatio=Math.min(2,window.devicePixelRatio||1)),n.width=t*a,n.height=i*a}},{key:"_fixContainer",value:function(){document.body.insertBefore(cc.game.container,document.body.firstChild);var e=document.body.style;e.width=window.innerWidth+"px",e.height=window.innerHeight+"px",e.overflow="hidden";var t=cc.game.container.style;t.position="fixed",t.left=t.top="0px",document.body.scrollTop=0}}]),e}(),jx=function(){function e(){i(this,e),this.name="ContentStrategy",this._result={scale:[1,1],viewport:null}}return r(e,[{key:"preApply",value:function(e){}},{key:"apply",value:function(e,t){return{scale:[1,1]}}},{key:"postApply",value:function(e){}},{key:"_buildResult",value:function(e,t,i,n,r,a){Math.abs(e-i)<2&&(i=e),Math.abs(t-n)<2&&(n=t);var s=new Jn(Math.round((e-i)/2),Math.round((t-n)/2),i,n);return this._result.scale=[r,a],this._result.viewport=s,this._result}}]),e}();!function(){var e=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),s=0;s<r;s++)a[s]=arguments[s];return(n=c(this,(e=o(t)).call.apply(e,[this].concat(a)))).name="EqualToFrame",n}return s(t,e),r(t,[{key:"apply",value:function(e){var t=e._frameSize.height,i=cc.game.container.style;this._setupContainer(e,e._frameSize.width,e._frameSize.height),e._isRotated?i.margin="0 0 0 "+t+"px":i.margin="0px",i.padding="0px"}}]),t}(Wx),t=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),s=0;s<r;s++)a[s]=arguments[s];return(n=c(this,(e=o(t)).call.apply(e,[this].concat(a)))).name="ProportionalToFrame",n}return s(t,e),r(t,[{key:"apply",value:function(e,t){var i,n,r=e._frameSize.width,a=e._frameSize.height,s=cc.game.container.style,o=t.width,l=t.height,u=r/o,c=a/l;u<c?(i=r,n=l*u):(i=o*c,n=a);var h=Math.round((r-i)/2),f=Math.round((a-n)/2);i=r-2*h,n=a-2*f,this._setupContainer(e,i,n),e._isRotated?s.margin="0 0 0 "+a+"px":s.margin="0px",s.paddingLeft=h+"px",s.paddingRight=h+"px",s.paddingTop=f+"px",s.paddingBottom=f+"px"}}]),t}(Wx),n=("undefined"==typeof window?global:window).__globalAdapter;n&&(n.adaptContainerStrategy&&n.adaptContainerStrategy(Wx.prototype),n.adaptView&&n.adaptView(Hx.prototype)),Wx.EQUAL_TO_FRAME=new e,Wx.PROPORTION_TO_FRAME=new t;var a=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),s=0;s<r;s++)a[s]=arguments[s];return(n=c(this,(e=o(t)).call.apply(e,[this].concat(a)))).name="ExactFit",n}return s(t,e),r(t,[{key:"apply",value:function(e,t){var i=cc.game.canvas.width,n=cc.game.canvas.height,r=i/t.width,a=n/t.height;return this._buildResult(i,n,i,n,r,a)}}]),t}(jx),l=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),s=0;s<r;s++)a[s]=arguments[s];return(n=c(this,(e=o(t)).call.apply(e,[this].concat(a)))).name="ShowAll",n}return s(t,e),r(t,[{key:"apply",value:function(e,t){var i,n,r=cc.game.canvas.width,a=cc.game.canvas.height,s=t.width,o=t.height,l=r/s,u=a/o,c=0;return l<u?(i=r,n=o*(c=l)):(i=s*(c=u),n=a),this._buildResult(r,a,i,n,c,c)}}]),t}(jx),u=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),s=0;s<r;s++)a[s]=arguments[s];return(n=c(this,(e=o(t)).call.apply(e,[this].concat(a)))).name="NoBorder",n}return s(t,e),r(t,[{key:"apply",value:function(e,t){var i,n,r,a=cc.game.canvas.width,s=cc.game.canvas.height,o=t.width,l=t.height,u=a/o,c=s/l;return u<c?(n=o*(i=c),r=s):(n=a,r=l*(i=u)),this._buildResult(a,s,n,r,i,i)}}]),t}(jx),h=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),s=0;s<r;s++)a[s]=arguments[s];return(n=c(this,(e=o(t)).call.apply(e,[this].concat(a)))).name="FixedHeight",n}return s(t,e),r(t,[{key:"apply",value:function(e,t){var i=cc.game.canvas.width,n=cc.game.canvas.height,r=n/t.height,a=i,s=n;return this._buildResult(i,n,a,s,r,r)}}]),t}(jx),f=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),s=0;s<r;s++)a[s]=arguments[s];return(n=c(this,(e=o(t)).call.apply(e,[this].concat(a)))).name="FixedWidth",n}return s(t,e),r(t,[{key:"apply",value:function(e,t){var i=cc.game.canvas.width,n=cc.game.canvas.height,r=i/t.width,a=i,s=n;return this._buildResult(i,n,a,s,r,r)}}]),t}(jx);jx.EXACT_FIT=new a,jx.SHOW_ALL=new l,jx.NO_BORDER=new u,jx.FIXED_HEIGHT=new h,jx.FIXED_WIDTH=new f}();var Xx=e("ResolutionPolicy",function(){function e(t,n){i(this,e),this.name="ResolutionPolicy",this._containerStrategy=null,this._contentStrategy=null,this.setContainerStrategy(t),this.setContentStrategy(n)}return r(e,[{key:"preApply",value:function(e){this._containerStrategy.preApply(e),this._contentStrategy.preApply(e)}},{key:"apply",value:function(e,t){return this._containerStrategy.apply(e,t),this._contentStrategy.apply(e,t)}},{key:"postApply",value:function(e){this._containerStrategy.postApply(e),this._contentStrategy.postApply(e)}},{key:"setContainerStrategy",value:function(e){e instanceof Wx&&(this._containerStrategy=e)}},{key:"setContentStrategy",value:function(e){e instanceof jx&&(this._contentStrategy=e)}},{key:"canvasSize",get:function(){return cc.v2(cc.game.canvas.width,cc.game.canvas.height)}}]),e}());Xx.EXACT_FIT=0,Xx.NO_BORDER=1,Xx.SHOW_ALL=2,Xx.FIXED_HEIGHT=3,Xx.FIXED_WIDTH=4,Xx.UNKNOWN=5,Xx.ContainerStrategy=Wx,Xx.ContentStrategy=jx,cc.ResolutionPolicy=Xx;var qx=e("view",Hx.instance=cc.view=new Hx);cc.winSize=cc.v2();var Yx=new Mi,Kx=e("Touch",function(){function e(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;i(this,e),this._point=new Mi,this._prevPoint=new Mi,this._lastModified=0,this._id=null,this._startPoint=new Mi,this._startPointCaptured=!1,this.setTouchInfo(r,t,n)}return r(e,[{key:"getLocation",value:function(e){return e||(e=new Mi),e.set(this._point.x,this._point.y),e}},{key:"getLocationX",value:function(){return this._point.x}},{key:"getLocationY",value:function(){return this._point.y}},{key:"getUILocation",value:function(e){return e||(e=new Mi),e.set(this._point.x,this._point.y),cc.view._convertPointWithScale(e),e}},{key:"getUILocationX",value:function(){var e=cc.view.getViewportRect();return(this._point.x-e.x)/cc.view.getScaleX()}},{key:"getUILocationY",value:function(){var e=cc.view.getViewportRect();return(this._point.y-e.y)/cc.view.getScaleY()}},{key:"getPreviousLocation",value:function(e){return e||(e=new Mi),e.set(this._prevPoint.x,this._prevPoint.y),e}},{key:"getUIPreviousLocation",value:function(e){return e||(e=new Mi),e.set(this._prevPoint.x,this._prevPoint.y),cc.view._convertPointWithScale(e),e}},{key:"getStartLocation",value:function(e){return e||(e=new Mi),e.set(this._startPoint.x,this._startPoint.y),e}},{key:"getUIStartLocation",value:function(e){return e||(e=new Mi),e.set(this._startPoint.x,this._startPoint.y),cc.view._convertPointWithScale(e),e}},{key:"getDelta",value:function(e){return e||(e=new Mi),e.set(this._point),e.subtract(this._prevPoint),e}},{key:"getUIDelta",value:function(e){return e||(e=new Mi),Yx.set(this._point),Yx.subtract(this._prevPoint),e.set(cc.view.getScaleX(),cc.view.getScaleY()),Mi.divide(e,Yx,e),e}},{key:"getLocationInView",value:function(e){return e||(e=new Mi),e.set(this._point.x,cc.view._designResolutionSize.height-this._point.y),e}},{key:"getPreviousLocationInView",value:function(e){return e||(e=new Mi),e.set(this._prevPoint.x,cc.view._designResolutionSize.height-this._prevPoint.y),e}},{key:"getStartLocationInView",value:function(e){return e||(e=new Mi),e.set(this._startPoint.x,cc.view._designResolutionSize.height-this._startPoint.y),e}},{key:"getID",value:function(){return this._id}},{key:"setTouchInfo",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1?arguments[1]:void 0,i=arguments.length>2?arguments[2]:void 0;this._prevPoint=this._point,this._point=new Mi(t||0,i||0),this._id=e,this._startPointCaptured||(this._startPoint=new Mi(this._point),this._startPointCaptured=!0)}},{key:"_setPoint",value:function(e,i){"object"===t(e)?(this._point.x=e.x,this._point.y=e.y):(this._point.x=e||0,this._point.y=i||0)}},{key:"_setPrevPoint",value:function(e,i){"object"===t(e)?this._prevPoint=new Mi(e.x,e.y):this._prevPoint=new Mi(e||0,i||0)}}]),e}());cc.Touch=Kx;var Zx,Qx=jS.TOUCH_TIMEOUT,Jx=new Mi,$x=new Mi,eA=function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;i(this,e),this.x=t,this.y=n,this.z=r,this.timestamp=a},tA=new(function(){function e(){i(this,e),this._mousePressed=!1,this._isRegisterEvent=!1,this._preTouchPoint=new Mi,this._prevMousePoint=new Mi,this._preTouchPool=[],this._preTouchPoolPointer=0,this._touches=[],this._touchesIntegerDict={},this._indexBitsUsed=0,this._maxTouches=8,this._accelEnabled=!1,this._accelInterval=.2,this._accelMinus=1,this._accelCurTime=0,this._acceleration=null,this._accelDeviceEvent=null,this._glView=null,this._minus=0,this._pointLocked=!1}return r(e,[{key:"handleTouchesBegin",value:function(e){for(var t=[],i=this._touchesIntegerDict,n=Il.now(),r=0;r<e.length;++r){var a=e[r],s=a.getID();if(null!==s)if(void 0===i[s]){var o=this._getUnUsedIndex();if(-1===o){cc.logID(2300,o);continue}var l=new Kx(a._point.x,a._point.y,a.getID());this._touches[o]=l,l._lastModified=n,l._setPrevPoint(a._prevPoint),i[s]=o,t.push(l)}}if(t.length>0){var u=new eh(t);u._eventCode=eh.BEGAN,ph.dispatchEvent(u)}}},{key:"handleTouchesMove",value:function(e){for(var t=[],i=this._touches,n=Il.now(),r=0;r<e.length;++r){var a=e[r],s=a.getID();if(null!==s){var o=this._touchesIntegerDict[s];void 0!==o&&i[o]&&(i[o]._setPoint(a._point),i[o]._setPrevPoint(a._prevPoint),i[o]._lastModified=n,t.push(i[o]))}}if(t.length>0){var l=new eh(t);l._eventCode=eh.MOVED,ph.dispatchEvent(l)}}},{key:"handleTouchesEnd",value:function(e){var t=this.getSetOfTouchesEndOrCancel(e);if(t.length>0){var i=new eh(t);i._eventCode=eh.ENDED,ph.dispatchEvent(i)}this._preTouchPool.length=0}},{key:"handleTouchesCancel",value:function(e){var t=this.getSetOfTouchesEndOrCancel(e);if(t.length>0){var i=new eh(t);i._eventCode=eh.CANCELLED,ph.dispatchEvent(i)}this._preTouchPool.length=0}},{key:"getSetOfTouchesEndOrCancel",value:function(e){for(var t=[],i=this._touches,n=this._touchesIntegerDict,r=0;r<e.length;++r){var a=e[r],s=a.getID();if(null!==s){var o=n[s];void 0!==o&&i[o]&&(i[o]._setPoint(a._point),i[o]._setPrevPoint(a._prevPoint),t.push(i[o]),this._removeUsedIndexBit(o),delete n[s])}}return t}},{key:"getHTMLElementPosition",value:function(e){if(Il.platform===Il.WECHAT_GAME)return{left:0,top:0,width:window.innerWidth,height:window.innerHeight};var t=document.documentElement,i=Il.os===Il.OS_IOS&&Il.isBrowser?window.screenLeft:window.pageXOffset;i-=t.clientLeft;var n=Il.os===Il.OS_IOS&&Il.isBrowser?window.screenTop:window.pageYOffset;if(n-=t.clientTop,e.getBoundingClientRect){var r=e.getBoundingClientRect();return{left:r.left+i,top:r.top+n,width:r.width,height:r.height}}return e instanceof HTMLCanvasElement?{left:i,top:n,width:e.width,height:e.height}:{left:i,top:n,width:parseInt(e.style.width||"0",void 0),height:parseInt(e.style.height||"0",void 0)}}},{key:"getPreTouch",value:function(e){for(var t=null,i=this._preTouchPool,n=e.getID(),r=i.length-1;r>=0;r--)if(i[r].getID()===n){t=i[r];break}return t||(t=e),t}},{key:"setPreTouch",value:function(e){for(var t=!1,i=this._preTouchPool,n=e.getID(),r=i.length-1;r>=0;r--)if(i[r].getID()===n){i[r]=e,t=!0;break}t||(i.length<=50?i.push(e):(i[this._preTouchPoolPointer]=e,this._preTouchPoolPointer=(this._preTouchPoolPointer+1)%50))}},{key:"getTouchByXY",value:function(e,t,i,n){var r=this._preTouchPoint,a=this._glView.convertToLocationInView(t,i,n);this._pointLocked&&(a.x=r.x+e.movementX,a.y=r.y-e.movementY);var s=new Kx(a.x,a.y,0);return s._setPrevPoint(r.x,r.y),r.x=a.x,r.y=a.y,s}},{key:"getMouseEvent",value:function(e,t,i){var n=this._prevMousePoint,r=new $c(i);return r._setPrevCursor(n.x,n.y),n.x=e.x,n.y=e.y,this._glView._convertMouseToLocation(n,t),r.setLocation(n.x,n.y),r}},{key:"getPointByEvent",value:function(e,t){return null!=e.pageX?{x:e.pageX,y:e.pageY}:(Il.platform===Il.WECHAT_GAME?(t.left=0,t.top=0):(t.left-=document.body.scrollLeft,t.top-=document.body.scrollTop),{x:e.clientX,y:e.clientY})}},{key:"getTouchesByEvent",value:function(e,t){for(var i=[],n=this._glView,r=this._preTouchPoint,a=e.changedTouches.length,s=0;s<a;s++){var o=e.changedTouches[s];if(o){var l=void 0;l=Il.BROWSER_TYPE_FIREFOX===Il.browserType?n.convertToLocationInView(o.pageX,o.pageY,t,Jx):n.convertToLocationInView(o.clientX,o.clientY,t,Jx);var u=void 0;null!=o.identifier?(u=new Kx(l.x,l.y,o.identifier),this.getPreTouch(u).getLocation($x),u._setPrevPoint($x.x,$x.y),this.setPreTouch(u)):(u=new Kx(l.x,l.y))._setPrevPoint(r.x,r.y),r.x=l.x,r.y=l.y,i.push(u)}}return i}},{key:"registerSystemEvent",value:function(e){if(!this._isRegisterEvent&&e){this._glView=cc.view;var t=Il.isMobile,i="mouse"in Il.capabilities,n="touches"in Il.capabilities;Il.platform===Il.WECHAT_GAME&&(t=!1,n=!0,i=!1),i&&this._registerMouseEvents(e,t),window.navigator.msPointerEnabled&&this._registerMousePointerEvents(e),n&&this._registerTouchEvents(e),cc.sys.browserType!==cc.sys.BROWSER_TYPE_WECHAT_GAME_SUB&&this._registerKeyboardEvent(),this._isRegisterEvent=!0}}},{key:"setAccelerometerEnabled",value:function(e){if(this._accelEnabled!==e){this._accelEnabled=e;var t=cc.director.getScheduler();t.enableForTarget(this),this._accelEnabled?(this._registerAccelerometerEvent(),this._accelCurTime=0,t.scheduleUpdate(this)):(this._unregisterAccelerometerEvent(),this._accelCurTime=0,t.unscheduleUpdate(this))}}},{key:"didAccelerate",value:function(e){if(this._accelEnabled){var t=this._acceleration,i=0,n=0,r=0;if(this._accelDeviceEvent===window.DeviceMotionEvent){var a=e.accelerationIncludingGravity;a&&(i=this._accelMinus*(a.x||0)*.1,n=this._accelMinus*(a.y||0)*.1,r=.1*(a.z||0))}else{var s=e;i=(s.gamma||0)/90*.981,n=-(s.beta||0)/90*.981,r=(s.alpha||0)/90*.981}if(cc.view._isRotated){var o=i;i=-n,n=o}t.x=i,t.y=n,t.z=r,t.timestamp=e.timeStamp||Date.now();var l=t.x;90===window.orientation?(t.x=-t.y,t.y=l):-90===window.orientation?(t.x=t.y,t.y=-l):180===window.orientation&&(t.x=-t.x,t.y=-t.y),cc.sys.os===cc.sys.OS_ANDROID&&cc.sys.browserType!==cc.sys.BROWSER_TYPE_MOBILE_QQ&&(t.x=-t.x,t.y=-t.y)}}},{key:"update",value:function(e){this._accelCurTime>this._accelInterval&&(this._accelCurTime-=this._accelInterval,ph.dispatchEvent(new th(this._acceleration))),this._accelCurTime+=e}},{key:"setAccelerometerInterval",value:function(e){this._accelInterval!==e&&(this._accelInterval=e)}},{key:"_getUnUsedIndex",value:function(){for(var e=this._indexBitsUsed,t=cc.sys.now(),i=0;i<this._maxTouches;i++){if(!(1&e))return this._indexBitsUsed|=1<<i,i;var n=this._touches[i];if(t-n._lastModified>Qx){this._removeUsedIndexBit(i);var r=n.getID();return null!==r&&delete this._touchesIntegerDict[r],i}e>>=1}return-1}},{key:"_removeUsedIndexBit",value:function(e){if(!(e<0||e>=this._maxTouches)){var t=1<<e;t=~t,this._indexBitsUsed&=t}}},{key:"_registerMouseEvents",value:function(e,t){this._registerPointerLockEvent(),t||this._registerWindowMouseEvents(e),this._registerElementMouseEvents(e,t)}},{key:"_registerPointerLockEvent",value:function(){var e=this,t=function(){var t=cc.game.canvas;document.pointerLockElement===t||document.mozPointerLockElement===t?e._pointLocked=!0:e._pointLocked=!1};"onpointerlockchange"in document?document.addEventListener("pointerlockchange",t,!1):"onmozpointerlockchange"in document&&document.addEventListener("mozpointerlockchange",t,!1)}},{key:"_registerWindowMouseEvents",value:function(e){var t=this;window.addEventListener("mousedown",(function(){t._mousePressed=!0}),!1),window.addEventListener("mouseup",(function(i){if(t._mousePressed){t._mousePressed=!1;var n=t.getHTMLElementPosition(e),r=t.getPointByEvent(i,n);if(!$n(n.left,n.top,n.width,n.height).contains(new Mi(r.x,r.y))){t.handleTouchesEnd([t.getTouchByXY(i,r.x,r.y,n)]);var a=t.getMouseEvent(r,n,$c.UP);a.setButton(i.button),ph.dispatchEvent(a)}}}),!1)}},{key:"_registerElementMouseEvents",value:function(e,t){var i=this,n=function(t,n,r){e.addEventListener(t,(function(t){var a=i.getHTMLElementPosition(e),s=i.getPointByEvent(t,a),o=i.getMouseEvent(s,a,n);o.setButton(t.button),r(t,o,s,a),ph.dispatchEvent(o),t.stopPropagation(),t.preventDefault()}))};t||(n("mousedown",$c.DOWN,(function(t,n,r,a){i._mousePressed=!0,i.handleTouchesBegin([i.getTouchByXY(t,r.x,r.y,a)]),e.focus()})),n("mouseup",$c.UP,(function(e,t,n,r){i._mousePressed=!1,i.handleTouchesEnd([i.getTouchByXY(e,n.x,n.y,r)])})),n("mousemove",$c.MOVE,(function(e,t,n,r){i.handleTouchesMove([i.getTouchByXY(e,n.x,n.y,r)]),i._mousePressed||t.setButton(null),void 0!==e.movementX&&void 0!==e.movementY&&(t.movementX=e.movementX,t.movementY=e.movementY)}))),n("mousewheel",$c.SCROLL,(function(e,t,i,n){t.setScrollData(0,e.wheelDelta)})),n("DOMMouseScroll",$c.SCROLL,(function(e,t,i,n){t.setScrollData(0,-120*e.detail)}))}},{key:"_registerMousePointerEvents",value:function(e){var t=this,i={MSPointerDown:this.handleTouchesBegin,MSPointerMove:this.handleTouchesMove,MSPointerUp:this.handleTouchesEnd,MSPointerCancel:this.handleTouchesCancel},n=function(n){var r=i[n];e.addEventListener(n,(function(i){var n=t.getHTMLElementPosition(e);n.left-=document.documentElement.scrollLeft,n.top-=document.documentElement.scrollTop,r.call(t,[t.getTouchByXY(i,i.clientX,i.clientY,n)]),i.stopPropagation()}),!1)};for(var r in i)n(r)}},{key:"_registerTouchEvents",value:function(e){cc.sys.browserType===cc.sys.BROWSER_TYPE_WECHAT_GAME_SUB?this._registerWXGameTouchEvents(e):this._registerHTMLTouchEvents(e)}},{key:"_registerWXGameTouchEvents",value:function(e){var t=this,i=function(i){return function(n){var r=t.getHTMLElementPosition(e),a=document.body;r.left-=a.scrollLeft||0,r.top-=a.scrollTop||0,i(t.getTouchesByEvent(n,r))}};wx.onTouchStart(i((function(e){t.handleTouchesBegin(e)}))),wx.onTouchEnd(i((function(e){t.handleTouchesEnd(e)}))),wx.onTouchMove(i((function(e){t.handleTouchesMove(e)}))),wx.onTouchCancel(i((function(e){t.handleTouchesCancel(e)})))}},{key:"_registerHTMLTouchEvents",value:function(e){var t=this,i=function(i){return function(n){if(n.changedTouches){var r=t.getHTMLElementPosition(e),a=document.body;r.left-=a.scrollLeft||0,r.top-=a.scrollTop||0,i(t.getTouchesByEvent(n,r)),n.stopPropagation(),n.preventDefault()}}};e.addEventListener("touchstart",i((function(i){t.handleTouchesBegin(i),Il.platform!==Il.WECHAT_GAME&&e.focus()})),!1),e.addEventListener("touchmove",i((function(e){t.handleTouchesMove(e)})),!1),e.addEventListener("touchend",i((function(e){t.handleTouchesEnd(e)})),!1),e.addEventListener("touchcancel",i((function(e){t.handleTouchesCancel(e)})),!1)}},{key:"_registerKeyboardEvent",value:function(){var e=cc.game.canvas;e.addEventListener("keydown",(function(e){ph.dispatchEvent(new ih(e,!0)),e.stopPropagation(),e.preventDefault()}),!1),e.addEventListener("keyup",(function(e){ph.dispatchEvent(new ih(e,!1)),e.stopPropagation(),e.preventDefault()}),!1)}},{key:"_registerAccelerometerEvent",value:function(){var e=this;this._acceleration=new eA,this._accelDeviceEvent=window.DeviceMotionEvent||window.DeviceOrientationEvent,cc.sys.browserType===cc.sys.BROWSER_TYPE_MOBILE_QQ&&(this._accelDeviceEvent=window.DeviceOrientationEvent);var t=this._accelDeviceEvent===window.DeviceMotionEvent?"devicemotion":"deviceorientation",i=navigator.userAgent;(/Android/.test(i)||/Adr/.test(i)&&cc.sys.browserType===cc.BROWSER_TYPE_UC)&&(this._minus=-1),Zx=function(){return e.didAccelerate.apply(e,arguments)},window.addEventListener(t,Zx,!1)}},{key:"_unregisterAccelerometerEvent",value:function(){var e=this._accelDeviceEvent===window.DeviceMotionEvent?"devicemotion":"deviceorientation";Zx&&window.removeEventListener(e,Zx,!1)}}]),e}());zx.once(Nx.EVENT_ENGINE_INITED,(function(){zx.config.registerSystemEvent&&tA.registerSystemEvent(zx.canvas)})),cc.internal.inputManager=tA;var iA=null,nA=null,rA=null,aA=null,sA=e("SystemEvent",function(e){function t(){return i(this,t),c(this,o(t).call(this))}return s(t,e),r(t,[{key:"setAccelerometerEnabled",value:function(e){tA.setAccelerometerEnabled(e)}},{key:"setAccelerometerInterval",value:function(e){tA.setAccelerometerInterval(e)}},{key:"on",value:function(e,i,n){return f(o(t.prototype),"on",this).call(this,e,i,n),e!==Kc.KEY_DOWN&&e!==Kc.KEY_UP||iA||(iA=nh.create({event:nh.KEYBOARD,onKeyPressed:function(e,t){t.type=Kc.KEY_DOWN,oA.emit(t.type,t)},onKeyReleased:function(e,t){t.type=Kc.KEY_UP,oA.emit(t.type,t)}}),ph.addListener(iA,256)),e===Kc.DEVICEMOTION&&(nA||(nA=nh.create({event:nh.ACCELERATION,callback:function(e,t){t.type=Kc.DEVICEMOTION,cc.systemEvent.emit(t.type,t)}}),ph.addListener(nA,256))),e!==Kc.TOUCH_START&&e!==Kc.TOUCH_MOVE&&e!==Kc.TOUCH_END&&e!==Kc.TOUCH_CANCEL||rA||(rA=nh.create({event:nh.TOUCH_ONE_BY_ONE,onTouchBegan:function(e,t){return t.type=Kc.TOUCH_START,cc.systemEvent.emit(t.type,e,t),!0},onTouchMoved:function(e,t){t.type=Kc.TOUCH_MOVE,cc.systemEvent.emit(t.type,e,t)},onTouchEnded:function(e,t){t.type=Kc.TOUCH_END,cc.systemEvent.emit(t.type,e,t)},onTouchCancelled:function(e,t){t.type=Kc.TOUCH_CANCEL,cc.systemEvent.emit(t.type,e,t)}}),ph.addListener(rA,256)),e!==Kc.MOUSE_DOWN&&e!==Kc.MOUSE_MOVE&&e!==Kc.MOUSE_UP&&e!==Kc.MOUSE_WHEEL||aA||(aA=nh.create({event:nh.MOUSE,onMouseDown:function(e){e.type=Kc.MOUSE_DOWN,cc.systemEvent.emit(e.type,e)},onMouseMove:function(e){e.type=Kc.MOUSE_MOVE,cc.systemEvent.emit(e.type,e)},onMouseUp:function(e){e.type=Kc.MOUSE_UP,cc.systemEvent.emit(e.type,e)},onMouseScroll:function(e){e.type=Kc.MOUSE_WHEEL,cc.systemEvent.emit(e.type,e)}}),ph.addListener(aA,256)),i}},{key:"off",value:function(e,i,n){if(f(o(t.prototype),"off",this).call(this,e,i,n),iA&&(e===Kc.KEY_DOWN||e===Kc.KEY_UP)){var r=this.hasEventListener(Kc.KEY_DOWN),a=this.hasEventListener(Kc.KEY_UP);r||a||(ph.removeListener(iA),iA=null)}if(nA&&e===Kc.DEVICEMOTION&&(ph.removeListener(nA),nA=null),rA&&(e===Kc.TOUCH_START||e===Kc.TOUCH_MOVE||e===Kc.TOUCH_END||e===Kc.TOUCH_CANCEL)){var s=this.hasEventListener(Kc.TOUCH_START),l=this.hasEventListener(Kc.TOUCH_MOVE),u=this.hasEventListener(Kc.TOUCH_END),c=this.hasEventListener(Kc.TOUCH_CANCEL);s||l||u||c||(ph.removeListener(rA),rA=null)}if(aA&&(e===Kc.MOUSE_DOWN||e===Kc.MOUSE_MOVE||e===Kc.MOUSE_UP||e===Kc.MOUSE_WHEEL)){var h=this.hasEventListener(Kc.MOUSE_DOWN),_=this.hasEventListener(Kc.MOUSE_MOVE),d=this.hasEventListener(Kc.MOUSE_UP),p=this.hasEventListener(Kc.MOUSE_WHEEL);h||_||d||p||(ph.removeListener(aA),aA=null)}}}]),t}(ol));sA.EventType=Kc,cc.SystemEvent=sA;var oA=e("systemEvent",new sA);cc.systemEvent=oA,sr(Kc,"Node.EventType",[{name:"POSITION_PART",newName:"TRANSFORM_CHANGED"},{name:"ROTATION_PART",newName:"TRANSFORM_CHANGED"},{name:"SCALE_PART",newName:"TRANSFORM_CHANGED"}]);var lA=e("screen",{_supportsFullScreen:!1,_preOnFullScreenChange:null,_touchEvent:"",_fn:null,_fnMap:[["requestFullscreen","exitFullscreen","fullscreenchange","fullscreenEnabled","fullscreenElement"],["requestFullScreen","exitFullScreen","fullScreenchange","fullScreenEnabled","fullScreenElement"],["webkitRequestFullScreen","webkitCancelFullScreen","webkitfullscreenchange","webkitIsFullScreen","webkitCurrentFullScreenElement"],["mozRequestFullScreen","mozCancelFullScreen","mozfullscreenchange","mozFullScreen","mozFullScreenElement"],["msRequestFullscreen","msExitFullscreen","MSFullscreenChange","msFullscreenEnabled","msFullscreenElement"]],init:function(){this._fn={};var e,t,i,n,r=this._fnMap;for(e=0,t=r.length;e<t;e++)if((i=r[e])&&void 0!==document[i[1]]){for(e=0,n=i.length;e<n;e++)this._fn[r[0][e]]=i[e];break}this._supportsFullScreen=void 0!==this._fn.requestFullscreen,this._touchEvent="ontouchstart"in window?"touchstart":"mousedown"},fullScreen:function(){return!!this._supportsFullScreen&&(void 0!==document[this._fn.fullscreenElement]&&null!==document[this._fn.fullscreenElement])},requestFullScreen:function(e,t){if(this._supportsFullScreen){if(e=e||document.documentElement,t){var i=this._fn.fullscreenchange;this._preOnFullScreenChange&&document.removeEventListener(i,this._preOnFullScreenChange),this._preOnFullScreenChange=t,document.addEventListener(i,t,!1)}return e[this._fn.requestFullscreen]()}},exitFullScreen:function(){return!this._supportsFullScreen||document[this._fn.exitFullscreen]()},autoFullScreen:function(e,t){e=e||document.body;var i=cc.game.canvas||e,n=this;this.requestFullScreen(e,t),i.addEventListener(this._touchEvent,(function r(){i.removeEventListener(n._touchEvent,r),n.requestFullScreen(e,t)}))}});lA.init(),cc.screen=lA;var uA,cA,hA=0,fA={},_A=function(e){if(void 0===fA[e]){var t=1<<hA;fA[e]=t,hA+=1}};!function(e){e[e.OPAQUE=0]="OPAQUE",e[e.TRANSPARENT=1]="TRANSPARENT",e[e.OVERLAY=2]="OVERLAY"}(uA||(uA={})),function(e){e[e.DEFAULT=1]="DEFAULT",e[e.FORWARD=2]="FORWARD",e[e.SHADOWCAST=4]="SHADOWCAST"}(cA||(cA={}));var dA,pA=function(e){function t(){var e;i(this,t),(e=c(this,o(t).call(this))).uploadedAnim=void 0,e._skeleton=null,e._staticModelBounds=null,e._mesh=null,e._type="skinning",e._dataPoolManager=cc.director.root.dataPoolManager;var n=new Float32Array(4),r=e._dataPoolManager.jointsTexturePool.getDefaultJointsTexture(),a=e._dataPoolManager.jointsAnimationInfo.get();return e._jointsMedium={buffer:null,jointsTextureInfo:n,texture:r,animInfo:a,boundsInfo:null},e}return s(t,e),r(t,[{key:"destroy",value:function(){f(o(t.prototype),"destroy",this).call(this),this._jointsMedium.buffer&&(this._jointsMedium.buffer.destroy(),this._jointsMedium.buffer=null,this.uploadedAnim=void 0)}},{key:"bindSkeleton",value:function(e,t,i){this._skeleton=e,this._mesh=i,e&&t&&i&&(this._transform=t,this._jointsMedium.animInfo=this._dataPoolManager.jointsAnimationInfo.get(t.uuid),this._jointsMedium.buffer||(this._jointsMedium.buffer=this._device.createBuffer({usage:ro.UNIFORM|ro.TRANSFER_DST,memUsage:ao.HOST|ao.DEVICE,size:wu.SIZE,stride:wu.SIZE})))}},{key:"updateTransform",value:function(){if(f(o(t.prototype),"updateTransform",this).call(this),this.uploadedAnim){var e=this._jointsMedium,i=e.animInfo,n=e.boundsInfo[i.data[1]],r=this._transform;this._worldBounds&&n&&n.transform(r._mat,r._pos,r._rot,r._scale,this._worldBounds)}}},{key:"updateUBOs",value:function(){if(!f(o(t.prototype),"updateUBOs",this).call(this))return!1;var e=this._jointsMedium.animInfo;return e.dirty&&(e.buffer.update(e.data),e.dirty=!1),!0}},{key:"createBoundingShape",value:function(e,i){f(o(t.prototype),"createBoundingShape",this).call(this,e,i),this._staticModelBounds=this._modelBounds&&Fa.clone(this._modelBounds)}},{key:"uploadAnimation",value:function(e){if(this._skeleton&&this._mesh&&this.uploadedAnim!==e){this.uploadedAnim=e;var t=this._dataPoolManager,i=e?t.jointsTexturePool.getJointsTextureWithAnimation(this._skeleton,e):t.jointsTexturePool.getDefaultJointsTexture(this._skeleton);t.jointsAnimationInfo.switchClip(this._jointsMedium.animInfo,e),this._applyJointsTexture(i),this._jointsMedium.boundsInfo=e?t.animatedBoundsInfo.get(this._mesh,this._skeleton,e):null,this._modelBounds=e?null:this._staticModelBounds}}},{key:"_applyJointsTexture",value:function(e){if(e){var t=this._jointsMedium.texture;t&&t!==e&&this._dataPoolManager.jointsTexturePool.releaseHandle(t),this._jointsMedium.texture=e;var i=this._jointsMedium,n=i.buffer,r=i.jointsTextureInfo;r[0]=e.handle.texture.width,r[1]=1/r[0],r[2]=e.pixelOffset+.1,n&&n.update(r);var a=yc.getSampler(this._device,A_),s=this._subModels,o=Array.isArray(s),l=0;for(s=o?s:s[Symbol.iterator]();;){var u;if(o){if(l>=s.length)break;u=s[l++]}else{if((l=s.next()).done)break;u=l.value}var c=u;if(c.psos){var h=c.psos,f=Array.isArray(h),_=0;for(h=f?h:h[Symbol.iterator]();;){var d;if(f){if(_>=h.length)break;d=h[_++]}else{if((_=h.next()).done)break;d=_.value}var p=d.pipelineLayout.layouts[0];p.bindTextureView(Ru.binding,e.handle.texView),p.bindSampler(Ru.binding,a)}}}var m=this._implantPSOs,v=Array.isArray(m),g=0;for(m=v?m:m[Symbol.iterator]();;){var y;if(v){if(g>=m.length)break;y=m[g++]}else{if((g=m.next()).done)break;y=g.value}var b=y.pipelineLayout.layouts[0];b.bindTextureView(Ru.binding,e.handle.texView),b.bindSampler(Ru.binding,a),b.update()}}}},{key:"createPipelineState",value:function(e){var i=f(o(t.prototype),"createPipelineState",this).call(this,e),n=this._jointsMedium,r=n.buffer,a=n.texture,s=n.animInfo,l=i.pipelineLayout.layouts[0];l.bindBuffer(wu.BLOCK.binding,r),l.bindBuffer(Cu.BLOCK.binding,s.buffer);var u=yc.getSampler(this._device,A_);return a&&(l.bindTextureView(Ru.binding,a.handle.texView),l.bindSampler(Ru.binding,u)),i}}]),t}(Zu),mA=new zi(0,0,-1),vA=new zi,gA=new Fa,yA=new fn,bA={allocator:null,type:Co.SECONDARY},EA=function(){function e(t){i(this,e),this._enabled=!1,this._normal=new zi(0,1,0),this._distance=0,this._matLight=new Bn,this._data=Float32Array.from([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,.3]),this._cmdBuffCount=0,this._psoRecord=new Map,this._cbRecord=new Map,this._scene=t,this._globalBindings=t.root.pipeline.globalBindings.get(bu.BLOCK.name),this._cmdBuffs=new Ja(64),this._matNormal=new np,this._matNormal.initialize({effectName:"pipeline/planar-shadow"}),this._matSkinning=new np,this._matSkinning.initialize({effectName:"pipeline/planar-shadow",defines:{USE_SKINNING:!0}})}return r(e,[{key:"enabled",set:function(e){this._enabled=e,this._scene.mainLight&&this.updateDirLight(this._scene.mainLight),this._cmdBuffs.clear()},get:function(){return this._enabled}},{key:"normal",set:function(e){zi.copy(this._normal,e),this._scene.mainLight&&this.updateDirLight(this._scene.mainLight)},get:function(){return this._normal}},{key:"distance",set:function(e){this._distance=e,this._scene.mainLight&&this.updateDirLight(this._scene.mainLight)},get:function(){return this._distance}},{key:"shadowColor",set:function(e){rr.toArray(this._data,e,bu.SHADOW_COLOR_OFFSET),this._globalBindings.buffer.update(this.data)}},{key:"matLight",get:function(){return this._matLight}},{key:"data",get:function(){return this._data}},{key:"cmdBuffs",get:function(){return this._cmdBuffs}},{key:"cmdBuffCount",get:function(){return this._cmdBuffs.length}}]),r(e,[{key:"updateSphereLight",value:function(e){e.node.getWorldPosition(vA);var t=this._normal,i=this._distance+.001,n=zi.dot(t,vA),r=vA.x,a=vA.y,s=vA.z,o=t.x,l=t.y,u=t.z,c=this._matLight;c.m00=n-i-r*o,c.m01=-a*o,c.m02=-s*o,c.m03=-o,c.m04=-r*l,c.m05=n-i-a*l,c.m06=-s*l,c.m07=-l,c.m08=-r*u,c.m09=-a*u,c.m10=n-i-s*u,c.m11=-u,c.m12=r*i,c.m13=a*i,c.m14=s*i,c.m15=n,Bn.toArray(this.data,this._matLight),this._globalBindings.buffer.update(this.data)}},{key:"updateDirLight",value:function(e){e.node.getWorldRotation(yA),zi.transformQuat(vA,mA,yA);var t=this._normal,i=this._distance+.001,n=1/zi.dot(t,vA),r=vA.x*n,a=vA.y*n,s=vA.z*n,o=t.x,l=t.y,u=t.z,c=this._matLight;c.m00=1-o*r,c.m01=-o*a,c.m02=-o*s,c.m03=0,c.m04=-l*r,c.m05=1-l*a,c.m06=-l*s,c.m07=0,c.m08=-u*r,c.m09=-u*a,c.m10=1-u*s,c.m11=0,c.m12=r*i,c.m13=a*i,c.m14=s*i,c.m15=1,Bn.toArray(this.data,this._matLight,bu.MAT_LIGHT_PLANE_PROJ_OFFSET),this._globalBindings.buffer.update(this.data)}},{key:"updateCommandBuffers",value:function(e){if(this._cmdBuffs.clear(),this._scene.mainLight){var t=this._scene.models,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r;if(a.enabled&&a.node&&a.castShadow&&(!a.worldBounds||(Fa.transform(gA,a.worldBounds,this._matLight),Sa.aabb_frustum(gA,e)))){var s=this._psoRecord.get(a),o=!1;s||(s=this._createPSO(a),this._psoRecord.set(a,s),o=!0),a.UBOUpdated||a.updateUBOs();for(var l=0;l<a.subModelNum;l++){var u=a.getSubModel(l).inputAssembler;if(u){var c=this._cbRecord.get(u);!o&&c||((c=this._createOrReuseCommandBuffer(c)).begin(),c.bindPipelineState(s),c.bindBindingLayout(s.pipelineLayout.layouts[0]),c.bindInputAssembler(u),c.draw(u),c.end(),this._cbRecord.set(u,c)),this.cmdBuffs.push(c)}}}}}}},{key:"destroyShadowModel",value:function(e){var t=this._psoRecord.get(e);t&&(this._destroyPSO(e,t),this._psoRecord.delete(e));for(var i=0;i<e.subModelNum;i++){var n=e.getSubModel(i).inputAssembler,r=this._cbRecord.get(n);n&&r&&(r.destroy(),this._cbRecord.delete(n))}}},{key:"onGlobalPipelineStateChanged",value:function(){for(var e=this._cbRecord.values(),t=e.next();!t.done;)t.value.destroy(),t=e.next();this._cbRecord.clear();for(var i=this._psoRecord.keys(),n=i.next();!n.done;)this._destroyPSO(n.value,this._psoRecord.get(n.value)),n=i.next();this._psoRecord.clear()}},{key:"destroy",value:function(){this.onGlobalPipelineStateChanged(),this._matNormal.destroy(),this._matSkinning.destroy()}},{key:"_createPSO",value:function(e){var t=e instanceof pA?this._matSkinning:this._matNormal,i=e.createPipelineState(t.passes[0]);return e.insertImplantPSO(i),i.pipelineLayout.layouts[0].update(),i}},{key:"_destroyPSO",value:function(e,t){var i=e instanceof pA?this._matSkinning:this._matNormal;e.removeImplantPSO(t),i.passes[0].destroyPipelineState(t)}},{key:"_createOrReuseCommandBuffer",value:function(e){var t=this._scene.root.device;return bA.allocator=t.commandAllocator,e?(e.status===Ks.SUCCESS&&e.destroy(),e.initialize(bA)):e=t.createCommandBuffer(bA),e}}]),e}();!function(e){e[e.positions=to.ATTR_POSITION]="positions",e[e.normals=to.ATTR_NORMAL]="normals",e[e.uvs=to.ATTR_TEX_COORD]="uvs",e[e.colors=to.ATTR_COLOR]="colors"}(dA||(dA={}));var TA=[{name:to.ATTR_POSITION,format:no.RGB32F},{name:to.ATTR_NORMAL,format:no.RGB32F},{name:to.ATTR_TEX_COORD,format:no.RG32F},{name:to.ATTR_COLOR,format:no.RGBA32F}],SA=new zi;function xA(e,t,i){i=i||{};var n,r=[],a=0,s=[],o=0;if(e.positions.length>0){if(n=null,e.attributes){var l=e.attributes,u=Array.isArray(l),c=0;for(l=u?l:l[Symbol.iterator]();;){var h;if(u){if(c>=l.length)break;h=l[c++]}else{if((c=l.next()).done)break;h=c.value}var f=h;if(f.name===to.ATTR_POSITION){n=f;break}}}n||(n=TA[0]);var _=Go[n.format];r.push(n),o=Math.max(o,Math.floor(e.positions.length/_.count)),s.push({offset:a,data:e.positions,attribute:n}),a+=_.size}if(e.normals&&e.normals.length>0){if(n=null,e.attributes){var d=e.attributes,p=Array.isArray(d),m=0;for(d=p?d:d[Symbol.iterator]();;){var v;if(p){if(m>=d.length)break;v=d[m++]}else{if((m=d.next()).done)break;v=m.value}var g=v;if(g.name===to.ATTR_NORMAL){n=g;break}}}n||(n=TA[1]);var y=Go[n.format];r.push(n),o=Math.max(o,Math.floor(e.normals.length/y.count)),s.push({offset:a,data:e.normals,attribute:n}),a+=y.size}if(e.uvs&&e.uvs.length>0){if(n=null,e.attributes){var b=e.attributes,E=Array.isArray(b),T=0;for(b=E?b:b[Symbol.iterator]();;){var S;if(E){if(T>=b.length)break;S=b[T++]}else{if((T=b.next()).done)break;S=T.value}var x=S;if(x.name===to.ATTR_TEX_COORD){n=x;break}}}n||(n=TA[2]);var A=Go[n.format];r.push(n),o=Math.max(o,Math.floor(e.uvs.length/A.count)),s.push({offset:a,data:e.uvs,attribute:n}),a+=A.size}if(e.colors&&e.colors.length>0){if(n=null,e.attributes){var w=e.attributes,C=Array.isArray(w),R=0;for(w=C?w:w[Symbol.iterator]();;){var k;if(C){if(R>=w.length)break;k=w[R++]}else{if((R=w.next()).done)break;k=R.value}var O=k;if(O.name===to.ATTR_COLOR){n=O;break}}}n||(n=TA[3]);var I=Go[n.format];r.push(n),o=Math.max(o,Math.floor(e.colors.length/I.count)),s.push({offset:a,data:e.colors,attribute:n}),a+=I.size}if(e.customAttributes){var M=e.customAttributes,L=Array.isArray(M),P=0;for(M=L?M:M[Symbol.iterator]();;){var B;if(L){if(P>=M.length)break;B=M[P++]}else{if((P=M.next()).done)break;B=P.value}var D=B,F=Go[D.attr.format];r.push(D.attr),o=Math.max(o,Math.floor(D.values.length/F.count)),s.push({offset:a,data:D.values,attribute:D.attr}),a+=F.size}}for(var N=new Zs,z=new ArrayBuffer(o*a),U=new DataView(z),G=0,V=s;G<V.length;G++){var H=V[G];K_(U,H.data,H.attribute.format,H.offset,a)}N.setNextAlignment(0);var W={attributes:r,view:{offset:N.getLength(),length:z.byteLength,count:o,stride:a}};N.addBuffer(z);var j=null,X=0;if(e.indices){var q=e.indices;X=q.length,j=new ArrayBuffer(2*X),K_(new DataView(j),q,no.R16UI)}var Y={primitiveMode:e.primitiveMode||lo.TRIANGLE_LIST,vertexBundelIndices:[0]};if(Y.primitiveMode>=lo.TRIANGLE_LIST){var K=Float32Array.from(e.positions);N.setNextAlignment(4),Y.geometricInfo={doubleSided:e.doubleSided,view:{offset:N.getLength(),length:K.byteLength,count:e.positions.length/4,stride:4}},N.addBuffer(K.buffer)}j&&(N.setNextAlignment(2),Y.indexView={offset:N.getLength(),length:j.byteLength,count:X,stride:2},N.addBuffer(j));var Z=e.minPos;if(!Z&&i.calculateBounds){Z=zi.set(new zi,1/0,1/0,1/0);for(var Q=0;Q<o;++Q)zi.set(SA,e.positions[3*Q+0],e.positions[3*Q+1],e.positions[3*Q+2]),zi.min(Z,Z,SA)}var J=e.maxPos;if(!J&&i.calculateBounds){J=zi.set(new zi,-1/0,-1/0,-1/0);for(var $=0;$<o;++$)zi.set(SA,e.positions[3*$+0],e.positions[3*$+1],e.positions[3*$+2]),zi.max(J,J,SA)}var ee={vertexBundles:[W],primitives:[Y]};return Z&&(ee.minPosition=new zi(Z.x,Z.y,Z.z)),J&&(ee.maxPosition=new zi(J.x,J.y,J.z)),t||(t=new su),t.reset({struct:ee,data:new Uint8Array(N.getCombined())}),t}var AA=Object.freeze({__proto__:null,find:Jb,toPPM:function(e,t,i){return"P3 ".concat(t," ").concat(i," 255\n").concat(e.filter((function(e,t){return t%4<3})).toString(),"\n")},readMesh:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i={positions:[]},n=new DataView(e._nativeAsset),r=e.struct,a=r.primitives[t],s=a.vertexBundelIndices,o=Array.isArray(s),l=0;for(s=o?s:s[Symbol.iterator]();;){var u;if(o){if(l>=s.length)break;u=s[l++]}else{if((l=s.next()).done)break;u=l.value}var c=u,h=r.vertexBundles[c],f=h.view.offset,_=h.view,d=_.length,p=_.stride,m=h.attributes,v=Array.isArray(m),g=0;for(m=v?m:m[Symbol.iterator]();;){var y;if(v){if(g>=m.length)break;y=m[g++]}else{if((g=m.next()).done)break;y=g.value}var b=y,E=dA[b.name];E&&(i[E]=(i[E]||[]).concat(Z_(n,b.format,f,d,p))),f+=Go[b.format].size}}var T=a.indexView;return i.indices=Z_(n,no["R".concat(8*T.stride,"UI")],T.offset,T.length),i},createMesh:xA,readBuffer:Z_,writeBuffer:K_,mapBuffer:Q_});function wA(e){return void 0===(e=e||{}).includeNormal&&(e.includeNormal=!0),void 0===e.includeUV&&(e.includeUV=!0),e}function CA(e){var t=(e=e||{}).widthSegments||1,i=e.heightSegments||1,n=e.lengthSegments||1,r=(e.width||1)/2,a=(e.height||1)/2,s=(e.length||1)/2,o=[zi.set(MA,-r,-a,s),zi.set(LA,r,-a,s),zi.set(PA,r,a,s),zi.set(BA,-r,a,s),zi.set(DA,r,-a,-s),zi.set(FA,-r,-a,-s),zi.set(NA,-r,a,-s),zi.set(zA,r,a,-s)],l=[[2,3,1],[4,5,7],[7,6,2],[1,0,4],[1,4,2],[5,0,6]],u=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],c=[],h=[],f=[],_=[],d=new zi(-r,-a,-s),p=new zi(r,a,s),m=Math.sqrt(r*r+a*a+s*s);function v(e,t,i){var n,r,a,s,d=c.length/3,p=l[e],m=u[e];for(s=0;s<=i;s++)for(a=0;a<=t;a++)if(n=a/t,r=s/i,zi.lerp(RA,o[p[0]],o[p[1]],n),zi.lerp(kA,o[p[0]],o[p[2]],r),zi.subtract(OA,kA,o[p[0]]),zi.add(IA,RA,OA),c.push(IA.x,IA.y,IA.z),h.push(m[0],m[1],m[2]),f.push(n,r),a<t&&s<i){var v=t+1,g=a+s*v,y=a+(s+1)*v,b=a+1+(s+1)*v,E=a+1+s*v;_.push(d+g,d+E,d+y),_.push(d+y,d+E,d+b)}}return v(0,t,i),v(4,n,i),v(1,t,i),v(5,n,i),v(3,t,n),v(2,t,n),{positions:c,normals:h,uvs:f,indices:_,minPos:d,maxPos:p,boundingRadius:m}}e("utils",AA);var RA=new zi,kA=new zi,OA=new zi,IA=new zi,MA=new zi,LA=new zi,PA=new zi,BA=new zi,DA=new zi,FA=new zi,NA=new zi,zA=new zi,UA=new zi(0,0,0),GA=new zi(0,0,0);function VA(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.5,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},r=.5*i,a=n.radialSegments||32,s=n.heightSegments||1,o=void 0===n.capped||n.capped,l=n.arc||2*Math.PI,u=0;o||(e>0&&u++,t>0&&u++);var c=(a+1)*(s+1);o&&(c+=(a+1)*u+a*u);var h=a*s*2*3;o&&(h+=a*u*3);var f=new Array(h),_=new Array(3*c),d=new Array(3*c),p=new Array(2*c),m=Math.max(e,t),v=new zi(-m,-r,-m),g=new zi(m,r,m),y=Math.sqrt(m*m+r*r),b=0,E=0;return T(),o&&(t>0&&S(!1),e>0&&S(!0)),{positions:_,normals:d,uvs:p,indices:f,minPos:v,maxPos:g,boundingRadius:y};function T(){for(var n=[],o=e-t,u=o*o/i*Math.sign(o),c=0;c<=s;c++){for(var h=[],m=c/s,v=m*o+t,g=0;g<=a;++g){var y=g/a,T=y*l,S=Math.sin(T),x=Math.cos(T);_[3*b]=v*S,_[3*b+1]=m*i-r,_[3*b+2]=v*x,zi.normalize(UA,zi.set(GA,S,-u,x)),d[3*b]=UA.x,d[3*b+1]=UA.y,d[3*b+2]=UA.z,p[2*b]=2*(1-y)%1,p[2*b+1]=m,h.push(b),++b}n.push(h)}for(var A=0;A<s;++A)for(var w=0;w<a;++w){var C=n[A][w],R=n[A+1][w],k=n[A+1][w+1],O=n[A][w+1];f[E]=C,++E,f[E]=O,++E,f[E]=R,++E,f[E]=O,++E,f[E]=k,++E,f[E]=R,++E}}function S(i){for(var n=i?e:t,s=i?1:-1,o=b,u=1;u<=a;++u)_[3*b]=0,_[3*b+1]=r*s,_[3*b+2]=0,d[3*b]=0,d[3*b+1]=s,d[3*b+2]=0,p[2*b]=.5,p[2*b+1]=.5,++b;for(var c=b,h=0;h<=a;++h){var m=h/a*l,v=Math.cos(m),g=Math.sin(m);_[3*b]=n*g,_[3*b+1]=r*s,_[3*b+2]=n*v,d[3*b]=0,d[3*b+1]=s,d[3*b+2]=0,p[2*b]=.5-.5*g*s,p[2*b+1]=.5+.5*v,++b}for(var y=0;y<a;++y){var T=o+y,S=c+y;i?(f[E]=S+1,++E,f[E]=T,++E,f[E]=S,++E):(f[E]=T,++E,f[E]=S+1,++E,f[E]=S,++E)}}}var HA=new zi(0,0,0),WA=new zi(0,0,0),jA=new zi(0,0,0),XA=new zi(0,0,0),qA=new zi(0,0,0),YA=new zi(0,0,0),KA=new zi(0,0,0);var ZA=new zi(0,0,0),QA=new zi(0,0,0);var JA=Object.freeze({__proto__:null,box:CA,cone:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return VA(0,e,t,i)},cylinder:VA,plane:function(e){var t=function(e){return(e=wA(e)).width=e.width||10,e.length=e.length||10,e.widthSegments=e.widthSegments||10,e.lengthSegments=e.lengthSegments||10,e}(e),i=t.width,n=t.length,r=t.widthSegments,a=t.lengthSegments,s=.5*i,o=.5*n,l=[],u=[],c=[],h=new zi(-s,0,-o),f=new zi(s,0,o),_=Math.sqrt(i*i+n*n);zi.set(qA,-s,0,o),zi.set(YA,s,0,o),zi.set(KA,-s,0,-o);for(var d=0;d<=a;d++)for(var p=0;p<=r;p++){var m=p/r,v=d/a;if(zi.lerp(HA,qA,YA,m),zi.lerp(WA,qA,KA,v),zi.subtract(jA,WA,qA),zi.add(XA,HA,jA),l.push(XA.x,XA.y,XA.z),t.includeUV&&u.push(m,v),p<r&&d<a){var g=r+1,y=p+d*g,b=p+(d+1)*g,E=p+1+(d+1)*g,T=p+1+d*g;c.push(y,T,b),c.push(T,E,b)}}var S={positions:l,indices:c,minPos:h,maxPos:f,boundingRadius:_};if(t.includeNormal){var x=(a+1)*(r+1),A=new Array(3*x);S.normals=A;for(var w=0;w<x;++w)A[3*w+0]=0,A[3*w+1]=1,A[3*w+2]=0}return t.includeUV&&(S.uvs=u),S},quad:function(e){var t=wA(e),i={positions:[-.5,-.5,0,-.5,.5,0,.5,.5,0,.5,-.5,0],indices:[0,3,1,3,2,1],minPos:{x:-.5,y:-.5,z:0},maxPos:{x:.5,y:.5,z:0},boundingRadius:Math.sqrt(.5)};return!1!==t.includeNormal&&(i.normals=[0,0,1,0,0,1,0,0,1,0,0,1]),!1!==t.includeUV&&(i.uvs=[0,0,0,1,1,1,1,0]),i},sphere:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=void 0!==t.segments?t.segments:32,n=[],r=[],a=[],s=[],o=new zi(-e,-e,-e),l=new zi(e,e,e),u=e,c=0;c<=i;++c)for(var h=c*Math.PI/i,f=Math.sin(h),_=-Math.cos(h),d=0;d<=i;++d){var p=2*d*Math.PI/i-Math.PI/2,m=Math.sin(p),v=Math.cos(p),g=m*f,y=_,b=v*f,E=d/i,T=c/i;if(n.push(g*e,y*e,b*e),r.push(g,y,b),a.push(E,T),c<i&&d<i){var S=i+1,x=S*c+d,A=S*(c+1)+d,w=S*(c+1)+d+1,C=S*c+d+1;s.push(x,C,A),s.push(C,w,A)}}return{positions:n,indices:s,normals:r,uvs:a,minPos:o,maxPos:l,boundingRadius:u}},torus:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.4,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.1,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=i.radialSegments||32,r=i.tubularSegments||32,a=i.arc||2*Math.PI,s=[],o=[],l=[],u=[],c=new zi(-e-t,-t,-e-t),h=new zi(e+t,t,e+t),f=e+t,_=0;_<=n;_++)for(var d=0;d<=r;d++){var p=d/r,m=_/n,v=p*a,g=m*Math.PI*2,y=(e+t*Math.cos(g))*Math.sin(v),b=t*Math.sin(g),E=(e+t*Math.cos(g))*Math.cos(v),T=Math.sin(v)*Math.cos(g),S=Math.sin(g),x=Math.cos(v)*Math.cos(g);if(s.push(y,b,E),o.push(T,S,x),l.push(p,m),d<r&&_<n){var A=r+1,w=A*_+d,C=A*(_+1)+d,R=A*(_+1)+d+1,k=A*_+d+1;u.push(w,k,C),u.push(k,R,C)}}return{positions:s,normals:o,uvs:l,indices:u,minPos:c,maxPos:h,boundingRadius:f}},capsule:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.5,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},r=i-e-t,a=n.sides||32,s=n.heightSegments||32,o=t/i,l=r/i,u=e/i,c=Math.floor(s*o),h=Math.floor(s*u),f=Math.floor(s*l),_=r+t-i/2,d=t-i/2,p=t-i/2,m=n.arc||2*Math.PI,v=[],g=[],y=[],b=[],E=Math.max(e,t),T=new zi(-E,-i/2,-E),S=new zi(E,i/2,E),x=i/2,A=0,w=[];return R(),C(),k(),{positions:v,normals:g,uvs:y,indices:b,minPos:T,maxPos:S,boundingRadius:x};function C(){for(var i=(e-t)/r,n=0;n<=f;n++){for(var s=[],u=n/f,c=u*(e-t)+t,h=0;h<=a;++h){var _=h/a,p=u*l+o,E=_*m-m/4,T=Math.sin(E),S=Math.cos(E);v.push(c*T),v.push(u*r+d),v.push(c*S),zi.normalize(ZA,zi.set(QA,T,-i,S)),g.push(ZA.x),g.push(ZA.y),g.push(ZA.z),y.push(_,p),s.push(A),++A}w.push(s)}for(var x=0;x<f;++x)for(var C=0;C<a;++C){var R=w[x][C],k=w[x+1][C],O=w[x+1][C+1],I=w[x][C+1];b.push(R),b.push(I),b.push(k),b.push(I),b.push(O),b.push(k)}}function R(){for(var e=0;e<=c;++e)for(var i=e*Math.PI/c/2,n=Math.sin(i),r=-Math.cos(i),o=0;o<=a;++o){var l=2*o*Math.PI/a-Math.PI/2,u=Math.sin(l)*n,h=r,f=Math.cos(l)*n,_=o/a,d=e/s;if(v.push(u*t,h*t+p,f*t),g.push(u,h,f),y.push(_,d),e<c&&o<a){var m=a+1,E=m*e+o,T=m*(e+1)+o,S=m*(e+1)+o+1,x=m*e+o+1;b.push(E,x,T),b.push(x,S,T)}++A}}function k(){for(var t=0;t<=h;++t)for(var i=t*Math.PI/h/2+Math.PI/2,n=Math.sin(i),r=-Math.cos(i),o=0;o<=a;++o){var l=2*o*Math.PI/a-Math.PI/2,c=Math.sin(l)*n,d=r,p=Math.cos(l)*n,m=o/a,E=t/s+(1-u);if(v.push(c*e,d*e+_,p*e),g.push(c,d,p),y.push(m,E),t<h&&o<a){var T=a+1,S=T*t+o+w[f][a]+1,x=T*(t+1)+o+w[f][a]+1,A=T*(t+1)+o+1+w[f][a]+1,C=T*t+o+1+w[f][a]+1;b.push(S,C,x),b.push(C,A,x)}}}},circle:function(e){var t=function(e){return(e=wA(e)).segments=64,e}(e).segments,i=new Array(3*(t+1));i[0]=0,i[1]=0,i[2]=0;var n=new Array(1+2*t);n[0]=0;for(var r=2*Math.PI/t,a=0;a<t;++a){var s=r*a,o=Math.cos(s),l=Math.sin(s),u=3*(a+1);i[u+0]=o,i[u+1]=l,i[u+2]=0;var c=2*a;n[1+c]=a+1,n[1+(c+1)]=a+2}return t>0&&(n[n.length-1]=1),{positions:i,indices:n,minPos:{x:1,y:1,z:0},maxPos:{x:-1,y:-1,z:0},boundingRadius:1,primitiveMode:lo.TRIANGLE_FAN}},translate:function(e,t){for(var i=t.x||0,n=t.y||0,r=t.z||0,a=Math.floor(e.positions.length/3),s=0;s<a;++s){var o=3*s,l=3*s+1,u=3*s+2;e.positions[o]=e.positions[o]+i,e.positions[l]=e.positions[l]+n,e.positions[u]=e.positions[u]+r}return e.minPos&&(e.minPos.x+=i,e.minPos.y+=n,e.minPos.z+=r),e.maxPos&&(e.maxPos.x+=i,e.maxPos.y+=n,e.maxPos.z+=r),e},scale:function(e,t){for(var i=t.x||0,n=t.y||0,r=t.z||0,a=Math.floor(e.positions.length/3),s=0;s<a;++s){var o=3*s,l=3*s+1,u=3*s+2;e.positions[o]*=i,e.positions[l]*=n,e.positions[u]*=r}return e.minPos&&(e.minPos.x*=i,e.minPos.y*=n,e.minPos.z*=r),e.maxPos&&(e.maxPos.x*=i,e.maxPos.y*=n,e.maxPos.z*=r),e.boundingRadius=Math.max(Math.max(i,n),r),e},wireframed:function(e){var t=e.indices;if(!t)return e;if(e.primitiveMode&&e.primitiveMode!==lo.TRIANGLE_LIST)return e;for(var i=[[0,1],[1,2],[2,0]],n=[],r={},a=0;a<t.length;a+=3)for(var s=0;s<3;++s){var o=t[a+i[s][0]],l=t[a+i[s][1]],u=o>l?l<<16|o:o<<16|l;void 0===r[u]&&(r[u]=0,n.push(o,l))}return e.indices=n,e.primitiveMode=lo.LINE_LIST,e},wireframe:function(e){for(var t=[[0,1],[1,2],[2,0]],i=[],n={},r=0;r<e.length;r+=3)for(var a=0;a<3;++a){var s=e[r+t[a][0]],o=e[r+t[a][1]],l=s>o?o<<16|s:s<<16|o;void 0===n[l]&&(n[l]=0,i.push(s,o))}return i},invWinding:function(e){for(var t=[],i=0;i<e.length;i+=3)t.push(e[i],e[i+2],e[i+1]);return t},toWavefrontOBJ:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;if(!e.indices||!e.uvs||!e.normals||void 0!==e.primitiveMode&&e.primitiveMode!==lo.TRIANGLE_LIST)return"";for(var i=e.positions,n=e.uvs,r=e.normals,a=e.indices,s=function(e){return"".concat(a[e]+1,"/").concat(a[e]+1,"/").concat(a[e]+1)},o="",l=0;l<i.length;l+=3)o+="v ".concat(i[l]*t," ").concat(i[l+1]*t," ").concat(i[l+2]*t,"\n");for(var u=0;u<n.length;u+=2)o+="vt ".concat(n[u]," ").concat(n[u+1],"\n");for(var c=0;c<r.length;c+=3)o+="vn ".concat(r[c]," ").concat(r[c+1]," ").concat(r[c+2],"\n");for(var h=0;h<a.length;h+=3)o+="f ".concat(s(h)," ").concat(s(h+1)," ").concat(s(h+2),"\n");return o},normals:function(e,t){for(var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,n=new Array(2*e.length),r=0;r<e.length/3;++r){var a=3*r,s=6*r;n[s+0]=e[a+0],n[s+1]=e[a+1],n[s+2]=e[a+2],n[s+3]=e[a+0]+t[a+0]*i,n[s+4]=e[a+1]+t[a+1]*i,n[s+5]=e[a+2]+t[a+2]*i}return n},applyDefaultGeometryOptions:wA});e("primitives",JA);var $A=null,ew=null,tw=function(e){function t(e){var n;if(i(this,t),(n=c(this,o(t).call(this)))._default=P_.get("default-cube-texture"),n._envmap=n._default,n._isRGBE=!1,n._useIBL=!1,n._scene=e,n._globalBinding=n._scene.root.pipeline.globalBindings.get(Eu.name),!ew){var r=new np;r.initialize({effectName:"pipeline/skybox",defines:{USE_RGBE_CUBEMAP:n._isRGBE}}),ew=new xp({parent:r})}return $A||($A=xA(CA({width:2,height:2,length:2}))),n.initSubModel(0,$A.renderingMesh.getSubmesh(0),ew),n}return s(t,e),r(t,[{key:"useIBL",set:function(e){this._useIBL=e,this._updatePipeline()},get:function(){return this._useIBL}},{key:"isRGBE",set:function(e){this._isRGBE=e,ew.recompileShaders({USE_RGBE_CUBEMAP:this._isRGBE}),this.setSubModelMaterial(0,ew),this._updateGlobalBinding(),this._updatePipeline()},get:function(){return this._isRGBE}},{key:"envmap",set:function(e){var t=e||this._default;this._envmap=t,this._scene.ambient.groundAlbedo[3]=this._envmap.mipmapLevel,this._updateGlobalBinding()},get:function(){return this._envmap}}]),r(t,[{key:"_updatePipeline",value:function(){var e=this._useIBL?this._isRGBE?2:1:0,t=this._scene.root.pipeline;t.macros.CC_USE_IBL!==e&&(t.macros.CC_USE_IBL=e,this._scene.onGlobalPipelineStateChanged())}},{key:"_updateGlobalBinding",value:function(){var e=this._envmap.getGFXTextureView(),t=yc.getSampler(this._device,this._envmap.getSamplerHash());this._globalBinding.sampler=t,this._globalBinding.textureView=e;var i=ew;i.passes[0].bindSampler(Eu.binding,t),i.passes[0].bindTextureView(Eu.binding,e);var n=this._matPSORecord.get(i),r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}s.pipelineLayout.layouts[0].update()}}}]),t}(Zu),iw=function(){function e(t){i(this,e),this._name="",this._cameras=[],this._models=[],this._sphereLights=[],this._spotLights=[],this._mainLight=null,this._modelId=0,this._root=t,this._ambient=new Nb(this),this._skybox=new tw(this),this._planarShadows=new EA(this)}return r(e,[{key:"root",get:function(){return this._root}},{key:"name",get:function(){return this._name}},{key:"cameras",get:function(){return this._cameras}},{key:"ambient",get:function(){return this._ambient}},{key:"skybox",get:function(){return this._skybox}},{key:"planarShadows",get:function(){return this._planarShadows}},{key:"mainLight",get:function(){return this._mainLight}},{key:"sphereLights",get:function(){return this._sphereLights}},{key:"spotLights",get:function(){return this._spotLights}},{key:"models",get:function(){return this._models}},{key:"rayResultCanvas",get:function(){return fw}},{key:"rayResultModels",get:function(){return uw}},{key:"rayResultAll",get:function(){return _w}},{key:"rayResultSingleModel",get:function(){return dw}}],[{key:"registerCreateFunc",value:function(t){t._createSceneFun=function(t){return new e(t)}}}]),r(e,[{key:"initialize",value:function(e){return this._name=e.name,!0}},{key:"destroy",value:function(){this.removeCameras(),this.removeSphereLights(),this.removeSpotLights(),this.removeModels(),this._skybox.destroy(),this._planarShadows.destroy()}},{key:"addCamera",value:function(e){e.attachToScene(this),this._cameras.push(e)}},{key:"removeCamera",value:function(e){for(var t=0;t<this._cameras.length;++t)if(this._cameras[t]===e)return this._cameras.splice(t,1),void e.detachFromScene()}},{key:"removeCameras",value:function(){var e=this._cameras,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.detachFromScene()}this._cameras.splice(0)}},{key:"setMainLight",value:function(e){e.attachToScene(this),this._mainLight=e}},{key:"unsetMainLight",value:function(e){e.detachFromScene(),this._mainLight=null}},{key:"addSphereLight",value:function(e){e.attachToScene(this),this._sphereLights.push(e)}},{key:"removeSphereLight",value:function(e){for(var t=0;t<this._sphereLights.length;++t)if(this._sphereLights[t]===e)return e.detachFromScene(),void this._sphereLights.splice(t,1)}},{key:"addSpotLight",value:function(e){e.attachToScene(this),this._spotLights.push(e)}},{key:"removeSpotLight",value:function(e){for(var t=0;t<this._spotLights.length;++t)if(this._spotLights[t]===e)return e.detachFromScene(),void this._spotLights.splice(t,1)}},{key:"removeSphereLights",value:function(){for(var e=0;e<this._sphereLights.length;++e)this._sphereLights[e].detachFromScene();this._sphereLights.length=0}},{key:"removeSpotLights",value:function(){for(var e=0;e<this._spotLights.length;++e)this._spotLights[e].detachFromScene();this._spotLights=[]}},{key:"addModel",value:function(e){e.attachToScene(this),this._models.push(e)}},{key:"removeModel",value:function(e){for(var t=0;t<this._models.length;++t)if(this._models[t]===e)return this._planarShadows.destroyShadowModel(e),e.detachFromScene(),void this._models.splice(t,1)}},{key:"removeModels",value:function(){var e=this._models,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n;this._planarShadows.destroyShadowModel(r),r.detachFromScene()}this._models.length=0}},{key:"onGlobalPipelineStateChanged",value:function(){var e=this._models,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.onGlobalPipelineStateChanged()}this._skybox.onGlobalPipelineStateChanged(),this._planarShadows.onGlobalPipelineStateChanged()}},{key:"generateModelId",value:function(){return this._modelId++}},{key:"raycastAll",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:du.Enum.DEFAULT|du.Enum.UI_2D,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1/0,n=this.raycastAllModels(e,t,i),r=this.raycastAllCanvas(e,t,i),a=n||r;return _w.length=0,a&&(Array.prototype.push.apply(_w,uw),Array.prototype.push.apply(_w,fw)),a}},{key:"raycastAllModels",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:du.Enum.DEFAULT,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1/0;lw.reset();var n=this._models,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s,l=o.transform;if(l&&o.enabled&&o.node.layer&t&~du.Enum.IGNORE_RAYCAST&&o.worldBounds){var u=Sa.ray_aabb(e,o.worldBounds);if(!(u<=0||u>=i)){if(!(o instanceof pA&&o.uploadedAnim)){Bn.invert(aw,l.getWorldMatrix(aw)),zi.transformMat4(nw.o,e.o,aw),zi.normalize(nw.d,zi.transformMat4Normal(nw.d,e.d,aw)),u=1/0;for(var c=0;c<o.subModelNum;++c){var h=o.getSubModel(c).subMeshData;if(h&&h.geometricInfo){var f=h.geometricInfo,_=f.positions,d=f.indices,p=f.doubleSided;pw(_,d,h.primitiveMode,p,i),u=Math.min(u,sw*zi.multiply(rw,nw.d,l.worldScale).length())}}}if(u<i){var m=lw.add();m.node=o.node,m.distance=u,uw[lw.length-1]=m}}}}return uw.length=lw.length,uw.length>0}},{key:"raycastSingleModel",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:du.Enum.DEFAULT,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1/0;lw.reset();var r=t,a=r.transform;if(!(a&&r.enabled&&r.node.layer&i&~du.Enum.IGNORE_RAYCAST&&r.worldBounds))return!1;var s=Sa.ray_aabb(e,r.worldBounds);if(s<=0||s>=n)return!1;if(!(r instanceof pA&&r.uploadedAnim)){Bn.invert(aw,a.getWorldMatrix(aw)),zi.transformMat4(nw.o,e.o,aw),zi.normalize(nw.d,zi.transformMat4Normal(nw.d,e.d,aw)),s=1/0;for(var o=0;o<r.subModelNum;++o){var l=r.getSubModel(o).subMeshData;if(l&&l.geometricInfo){var u=l.geometricInfo,c=u.positions,h=u.indices,f=u.doubleSided;pw(c,h,l.primitiveMode,f,n),s=Math.min(s,sw*zi.multiply(rw,nw.d,a.worldScale).length())}}}if(s<n){var _=lw.add();_.node=r.node,_.distance=s,dw[lw.length-1]=_}return dw.length=lw.length,dw.length>0}},{key:"raycastAllCanvas",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:du.Enum.UI_2D,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1/0;hw.reset();var n=cc.director.getScene().getComponentsInChildren(cc.CanvasComponent);if(null!=n&&n.length>0)for(var r=0;r<n.length;r++){var a=n[r].node;null!=a&&a.active&&this._raycastUI2DNodeRecursiveChildren(e,a,t,i)}return fw.length=hw.length,fw.length>0}},{key:"_raycastUI2DNode",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:du.Enum.UI_2D,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1/0;var r=t._uiProps.uiTransformComp;if(!(null==r||t.layer&du.Enum.IGNORE_RAYCAST)&&t.layer&i){r.getComputeAABB(cw);var a=Sa.ray_aabb(e,cw);if(!(a<=0)&&a<n){var s=hw.add();return s.node=t,s.distance=a,s}}}},{key:"_raycastUI2DNodeRecursiveChildren",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:du.Enum.UI_2D,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1/0,r=this._raycastUI2DNode(e,t,i,n);null!=r&&(fw[hw.length-1]=r);var a=t.children,s=Array.isArray(a),o=0;for(a=s?a:a[Symbol.iterator]();;){var l;if(s){if(o>=a.length)break;l=a[o++]}else{if((o=a.next()).done)break;l=o.value}var u=l;null!=u&&u.active&&this._raycastUI2DNodeRecursiveChildren(e,u,i,n)}}}]),e}(),nw=Cr.create(),rw=new zi,aw=new Bn,sw=1/0,ow=Oa.create(),lw=new Qa((function(){return{node:null,distance:1/0}}),8),uw=[],cw=new Fa,hw=new Qa((function(){return{node:null,distance:1/0}}),8),fw=[],_w=[],dw=[],pw=function(e,t,i,n){var r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1/0;if(sw=r,i===lo.TRIANGLE_LIST)for(var a=t.length,s=0;s<a;s+=3){var o=3*t[s],l=3*t[s+1],u=3*t[s+2];zi.set(ow.a,e[o],e[o+1],e[o+2]),zi.set(ow.b,e[l],e[l+1],e[l+2]),zi.set(ow.c,e[u],e[u+1],e[u+2]);var c=Sa.ray_triangle(nw,ow,n);c<=0||c>=sw||(sw=c)}else if(i===lo.TRIANGLE_STRIP)for(var h=t.length-2,f=0,_=0;_<h;_+=1){var d=3*t[_-f],p=3*t[_+f+1],m=3*t[_+2];zi.set(ow.a,e[d],e[d+1],e[d+2]),zi.set(ow.b,e[p],e[p+1],e[p+2]),zi.set(ow.c,e[m],e[m+1],e[m+2]),f=~f;var v=Sa.ray_triangle(nw,ow,n);v<=0||v>=sw||(sw=v)}else if(i===lo.TRIANGLE_FAN){var g=t.length-1,y=3*t[0];zi.set(ow.a,e[y],e[y+1],e[y+2]);for(var b=1;b<g;b+=1){var E=3*t[b],T=3*t[b+1];zi.set(ow.b,e[E],e[E+1],e[E+2]),zi.set(ow.c,e[T],e[T+1],e[T+2]);var S=Sa.ray_triangle(nw,ow,n);S<=0||S>=sw||(sw=S)}}};sr(iw.prototype,"RenderScene.prototype",[{name:"raycastUI",newName:"raycastAllCanvas"},{name:"raycastUI2D",newName:"raycastAllCanvas"},{name:"raycast",newName:"raycastAllModels"},{name:"raycastModels",newName:"raycastAllModels"},{name:"raycastModel",newName:"raycastSingleModel"}]),or(iw.prototype,"RenderScene.prototype",[{name:"raycastUI2DNode"},{name:"raycastUINode"}]);var mw={};or(mw,"CameraVisFlags",[{name:"GENERAL"}]),sr(mw,"CameraVisFlags",[{name:"PROFILER",newName:"PROFILER",target:du.BitMask,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:du.BitMask,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:du.BitMask,targetName:"EDITOR"},{name:"UI",newName:"UI",target:du.BitMask,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:du.BitMask,targetName:"UI_2D"}]),cc.CameraVisFlags=mw;var vw={};or(vw,"VisibilityFlags",[{name:"GENERAL"}]),sr(vw,"VisibilityFlags",[{name:"ALWALS",newName:"ALWALS",target:du.Enum,targetName:"ALWALS"},{name:"PROFILER",newName:"PROFILER",target:du.Enum,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:du.Enum,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:du.Enum,targetName:"EDITOR"},{name:"UI",newName:"UI",target:du.Enum,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:du.Enum,targetName:"UI_2D"}]),cc.VisibilityFlags=vw;var gw,yw=new zi(0,0,-1),bw=new zi,Ew=new fn,Tw=function(e){function t(){var e;return i(this,t),(e=c(this,o(t).call(this)))._dir=new zi(1,-1,-1),e._illum=Nb.SUN_ILLUM,e._type=YS.DIRECTIONAL,e}return s(t,e),r(t,[{key:"direction",set:function(e){this._dir=e,zi.normalize(this._dir,this._dir)},get:function(){return this._dir}},{key:"illuminance",set:function(e){this._illum=e},get:function(){return this._illum}}]),r(t,[{key:"update",value:function(){this._node&&this._node.hasChangedFlags&&(this._dir=zi.transformQuat(bw,yw,this._node.getWorldRotation(Ew)),zi.normalize(this._dir,this._dir))}}]),t}(JS),Sw=function(e){function t(){var e;return i(this,t),(e=c(this,o(t).call(this)))._needUpdate=!1,e._size=.15,e._range=1,e._luminance=1700/QS(e._size),e._type=YS.SPHERE,e._aabb=Fa.create(),e._pos=new zi,e}return s(t,e),r(t,[{key:"position",get:function(){return this._pos}},{key:"size",set:function(e){this._size=e},get:function(){return this._size}},{key:"range",set:function(e){this._range=e,this._needUpdate=!0},get:function(){return this._range}},{key:"luminance",set:function(e){this._luminance=e},get:function(){return this._luminance}},{key:"aabb",get:function(){return this._aabb}}]),r(t,[{key:"update",value:function(){this._node&&(this._node.hasChangedFlags||this._needUpdate)&&(this._node.getWorldPosition(this._pos),Fa.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,this._range,this._range,this._range),this._needUpdate=!1)}}]),t}(JS),xw=new zi(0,0,-1),Aw=(new zi,new fn),ww=new Bn,Cw=new Bn,Rw=new Bn,kw=new Bn,Ow=function(e){function t(){var e;return i(this,t),(e=c(this,o(t).call(this)))._dir=new zi(1,-1,-1),e._size=.15,e._range=5,e._luminance=1700/QS(e._size),e._spotAngle=Math.cos(Math.PI/6),e._angle=0,e._needUpdate=!1,e._type=YS.SPOT,e._aabb=Fa.create(),e._frustum=Wa.create(),e._pos=new zi,e}return s(t,e),r(t,[{key:"position",get:function(){return this._pos}},{key:"size",set:function(e){this._size=e},get:function(){return this._size}},{key:"range",set:function(e){this._range=e,this._needUpdate=!0},get:function(){return this._range}},{key:"luminance",set:function(e){this._luminance=e},get:function(){return this._luminance}},{key:"direction",get:function(){return this._dir}},{key:"spotAngle",get:function(){return this._spotAngle},set:function(e){this._angle=.5*e,this._spotAngle=Math.cos(.5*e),this._needUpdate=!0}},{key:"aabb",get:function(){return this._aabb}},{key:"frustum",get:function(){return this._frustum}}]),r(t,[{key:"update",value:function(){this._node&&(this._node.hasChangedFlags||this._needUpdate)&&(this._node.getWorldPosition(this._pos),zi.transformQuat(this._dir,xw,this._node.getWorldRotation(Aw)),zi.normalize(this._dir,this._dir),Fa.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,this._range,this._range,this._range),this._node.getWorldRT(ww),Bn.invert(ww,ww),Bn.perspective(Cw,this._angle,1,.001,this._range),Bn.multiply(Rw,Cw,ww),this._frustum.update(Rw,kw),this._needUpdate=!1)}}]),t}(JS),Iw=function e(){i(this,e),this.material=null,this.vertexCount=0,this.indiceCount=0},Mw=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),s=0;s<r;s++)a[s]=arguments[s];return(n=c(this,(e=o(t)).call.apply(e,[this].concat(a)))).vData=null,n.uvDirty=!0,n.vertDirty=!0,n._datas=[],n._indices=[],n._pivotX=0,n._pivotY=0,n._width=0,n._height=0,n}return s(t,e),r(t,[{key:"updateSizeNPivot",value:function(e,t,i,n){e===this._width&&t===this._height&&i===this._pivotX&&n===this._pivotY||(this._width=e,this._height=t,this._pivotX=i,this._pivotY=n,this.vertDirty=!0)}},{key:"clear",value:function(){this._datas.length=0,this._indices.length=0,this._pivotX=0,this._pivotY=0,this._width=0,this._height=0,this.uvDirty=!0,this.vertDirty=!0,this.material=null,this.vertexCount=0,this.indiceCount=0}},{key:"dataLength",get:function(){return this._datas.length},set:function(e){var t=this._datas;if(t.length!==e){var i=t.length,n=0;for(n=e;n<i;n++)Pw.free(t[n]);for(n=i;n<e;n++)t[n]=Pw.alloc();t.length=e}}},{key:"datas",get:function(){return this._datas}}],[{key:"add",value:function(){return Bw.add()}},{key:"remove",value:function(e){var t=Bw.data.indexOf(e);-1!==t&&(Bw.data[t].clear(),Bw.removeAt(t))}}]),t}(Iw),Lw=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),s=0;s<r;s++)a[s]=arguments[s];return(n=c(this,(e=o(t)).call.apply(e,[this].concat(a)))).vData=new Float32Array(2304*Float32Array.BYTES_PER_ELEMENT),n.iData=new Uint16Array(1536),n.vertexStart=0,n.indiceStart=0,n.byteStart=0,n.byteCount=0,n._formatByte=9*Float32Array.BYTES_PER_ELEMENT,n}return s(t,e),r(t,[{key:"request",value:function(e,t){var i=this.byteCount+e*this._formatByte,n=this.indiceCount+t;if(e+this.vertexCount>65535)return!1;var r=this.vData.byteLength,a=this.iData.length,s=this.vData.length,o=this.iData.length;if(i>r||n>a){for(;r<i||a<n;)r=4*(s*=2),a=o*=2;var l=new Float32Array(this.vData.buffer);this.vData=new Float32Array(s),this.vData.set(l,0);var u=new Uint16Array(this.iData.buffer);this.iData=new Uint16Array(o),this.iData.set(u,0)}return this.vertexCount+=e,this.indiceCount+=t,this.byteCount=i,!0}},{key:"reset",value:function(){this.vertexCount=0,this.indiceCount=0,this.byteCount=0,this.vertexStart=0,this.indiceStart=0,this.byteStart=0}}]),t}(Iw),Pw=new Za((function(){return{x:0,y:0,z:0,u:0,v:0,color:rr.WHITE.clone()}}),128),Bw=new Qa((function(){return new Mw}),32),Dw=_A,Fw=Object.freeze({__proto__:null,addStage:Dw,createIA:function(e,t){if(!t.positions)return console.error("The data must have positions field"),null;for(var i=[],n=t.positions.length/3,r=0;r<n;++r)i.push(t.positions[3*r],t.positions[3*r+1],t.positions[3*r+2]),t.normals&&i.push(t.normals[3*r],t.normals[3*r+1],t.normals[3*r+2]),t.uvs&&i.push(t.uvs[2*r],t.uvs[2*r+1]),t.colors&&i.push(t.colors[3*r],t.uvs[3*r+1],t.colors[3*r+2]);var a=[];a.push({name:to.ATTR_POSITION,format:no.RGB32F}),t.normals&&a.push({name:to.ATTR_NORMAL,format:no.RGB32F}),t.uvs&&a.push({name:to.ATTR_TEX_COORD,format:no.RG32F}),t.colors&&a.push({name:to.ATTR_COLOR,format:no.RGB32F});var s=e.createBuffer({usage:ro.VERTEX|ro.TRANSFER_DST,memUsage:ao.HOST|ao.DEVICE,size:4*i.length,stride:4*i.length/n});s.update(new Float32Array(i));var o=e.createBuffer({usage:ro.INDEX|ro.TRANSFER_DST,memUsage:ao.HOST|ao.DEVICE,size:2*t.indices.length,stride:2});return o.update(new Uint16Array(t.indices)),e.createInputAssembler({attributes:a,vertexBuffers:[s],indexBuffer:o})},get RenderQueue(){return uA},get PassStage(){return cA},genHandle:vd,getBindingTypeFromHandle:gd,getTypeFromHandle:yd,getBindingFromHandle:bd,getOffsetFromHandle:Ed,customizeType:Td,type2reader:Sd,type2writer:xd,type2default:Ad,assignDefines:wd,Pass:jd,programLib:Ld,get SamplerInfoIndex(){return Qu},genSamplerHash:nc,samplerLib:yc,nearestPOT:d_,TextureBufferPool:v_,MaterialInstance:xp,PassInstance:Sp,get JointsMediumType(){return m_},selectJointsMediumType:y_,jointsTextureSamplerHash:A_,JointsTexturePool:w_,JointsAnimationInfo:C_,AnimatedBoundsInfo:I_,SkinningModel:pA,Ambient:Nb,get CameraProjection(){return Uy},get CameraAperture(){return Gy},get CameraISO(){return Vy},get CameraShutter(){return Hy},SKYBOX_FLAG:Db,Camera:Fb,customizationManager:Mu,CameraVisFlags:mw,VisibilityFlags:vw,DirectionalLight:Tw,ColorTemperatureToRGB:ZS,get LightType(){return YS},nt2lm:QS,Light:JS,Model:Zu,PlanarShadows:EA,RenderScene:iw,Skybox:tw,SphereLight:Sw,SpotLight:Ow,SubModel:Lu});e("renderer",Fw);var Nw,zw,Uw,Gw,Vw,Hw,Ww,jw,Xw,qw,Yw,Kw,Zw,Qw,Jw=e("UIComponent",Es("cc.UIComponent")(gw=ws(Lf)(gw=Rs(110)(gw=ks(gw=As(gw=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),s=0;s<r;s++)a[s]=arguments[s];return(n=c(this,(e=o(t)).call.apply(e,[this].concat(a))))._lastParent=null,n}return s(t,e),r(t,[{key:"__preload",value:function(){this.node._uiProps.uiComp=this}},{key:"onEnable",value:function(){}},{key:"onDisable",value:function(){}},{key:"onDestroy",value:function(){this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null)}},{key:"updateAssembler",value:function(e){}},{key:"postUpdateAssembler",value:function(e){}}]),t}(Ph))||gw)||gw)||gw)||gw)||gw);pt(mo),function(e){e[e.ADDCOLOR=0]="ADDCOLOR",e[e.ADDCOLORANDTEXTURE=1]="ADDCOLORANDTEXTURE",e[e.GRAYSCALE=2]="GRAYSCALE"}(Qw||(Qw=e("InstanceMaterialType",{})));var $w,eC,tC,iC,nC,rC,aC,sC,oC,lC,uC,cC,hC,fC,_C,dC,pC,mC,vC,gC,yC,bC,EC,TC,SC,xC,AC,wC,CC,RC,kC={parent:null,owner:null,subModelIdx:0},OC=e("UIRenderComponent",(Nw=Es("cc.UIRenderComponent"),zw=Ts({type:mo,displayOrder:0,tooltip:""}),Uw=Ts({type:mo,displayOrder:1,tooltip:""}),Gw=Ts({displayOrder:2,tooltip:""}),Vw=Ts({type:np,displayOrder:3,tooltip:"",visible:!1}),Nw((Zw=Kw=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),s=0;s<r;s++)a[s]=arguments[s];return m(n=c(this,(e=o(t)).call.apply(e,[this].concat(a))),"_srcBlendFactor",jw,u(n)),m(n,"_dstBlendFactor",Xw,u(n)),m(n,"_color",qw,u(n)),m(n,"_sharedMaterial",Yw,u(n)),n._assembler=null,n._postAssembler=null,n._renderData=null,n._renderDataFlag=!0,n._renderFlag=!0,n._delegateSrc=null,n._material=null,n._instanceMaterialType=Qw.ADDCOLORANDTEXTURE,n._blendTemplate={blendState:{targets:[{blendSrc:mo.SRC_ALPHA,blendDst:mo.ONE_MINUS_SRC_ALPHA}]},depthStencilState:{},rasterizerState:{}},n}return s(t,e),r(t,[{key:"__preload",value:function(){f(o(t.prototype),"__preload",this).call(this),this._instanceMaterial(),this._flushAssembler&&this._flushAssembler()}},{key:"onEnable",value:function(){f(o(t.prototype),"onEnable",this).call(this),this.node.on(Kc.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.on(Kc.SIZE_CHANGED,this._nodeStateChange,this),this._renderFlag=this._canRender()}},{key:"onDisable",value:function(){f(o(t.prototype),"onDisable",this).call(this),this.node.off(Kc.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.off(Kc.SIZE_CHANGED,this._nodeStateChange,this),this._renderFlag=!1}},{key:"onDestroy",value:function(){f(o(t.prototype),"onDestroy",this).call(this),this.destroyRenderData(),this._material&&this._material.destroy(),this._updateMaterial(null),this._renderData=null}},{key:"markForUpdateRenderData",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(this._renderFlag=this._canRender(),e&&this._renderFlag){var t=this._renderData;t&&(t.vertDirty=!0),this._renderDataFlag=e}else e||(this._renderDataFlag=e)}},{key:"requestRenderData",value:function(){var e=Mw.add();return this._renderData=e,e}},{key:"destroyRenderData",value:function(){this._renderData&&(Mw.remove(this._renderData),this._renderData=null)}},{key:"updateAssembler",value:function(e){f(o(t.prototype),"updateAssembler",this).call(this,e),this._renderFlag&&(this._checkAndUpdateRenderData(),this._render(e))}},{key:"postUpdateAssembler",value:function(e){f(o(t.prototype),"postUpdateAssembler",this).call(this,e),this._renderFlag&&this._postRender(e)}},{key:"_render",value:function(e){}},{key:"_postRender",value:function(e){}},{key:"_checkAndUpdateRenderData",value:function(){this._renderDataFlag&&(this._assembler.updateRenderData(this),this._renderDataFlag=!1)}},{key:"_canRender",value:function(){return null!==this.material&&this.enabled&&(this._delegateSrc?this._delegateSrc.activeInHierarchy:this.enabledInHierarchy)}},{key:"_postCanRender",value:function(){}},{key:"_updateColor",value:function(){this._assembler&&this._assembler.updateColor&&this._assembler.updateColor(this)}},{key:"_updateMaterial",value:function(e){this._material=e,this._updateBlendFunc()}},{key:"_updateBlendFunc",value:function(){if(this._material){var e=this._blendTemplate.blendState.targets[0];e.blendDst===this._dstBlendFactor&&e.blendSrc===this._srcBlendFactor||(e.blendDst=this._dstBlendFactor,e.blendSrc=this._srcBlendFactor,this._blendTemplate.depthStencilState=this._material.passes[0].depthStencilState,this._blendTemplate.rasterizerState=this._material.passes[0].rasterizerState,this._material.overridePipelineStates(this._blendTemplate,0))}}},{key:"_nodeStateChange",value:function(e){this._renderData&&this.markForUpdateRenderData();var i=this.node.children,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a.getComponent(t);s&&s.markForUpdateRenderData()}}},{key:"_instanceMaterial",value:function(){var e=null;if(kC.owner=new wp,this._sharedMaterial)kC.parent=this._sharedMaterial,e=new xp(kC);else switch(this._instanceMaterialType){case Qw.ADDCOLOR:kC.parent=P_.get("ui-base-material"),e=new xp(kC);break;case Qw.ADDCOLORANDTEXTURE:kC.parent=P_.get("ui-sprite-material"),e=new xp(kC);break;case Qw.GRAYSCALE:kC.parent=P_.get("ui-sprite-gray-material"),e=new xp(kC)}this._updateMaterial(e)}},{key:"srcBlendFactor",get:function(){return this._srcBlendFactor},set:function(e){this._srcBlendFactor!==e&&(this._srcBlendFactor=e,this._updateBlendFunc())}},{key:"dstBlendFactor",get:function(){return this._dstBlendFactor},set:function(e){this._dstBlendFactor!==e&&(this._dstBlendFactor=e,this._updateBlendFunc())}},{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this._updateColor(),this.markForUpdateRenderData())}},{key:"sharedMaterial",get:function(){return this._sharedMaterial},set:function(e){this._sharedMaterial!==e&&(this._sharedMaterial=e,this._instanceMaterial&&this._instanceMaterial())}},{key:"material",get:function(){return this._material||this._instanceMaterial&&this._instanceMaterial(),this._material}},{key:"renderData",get:function(){return this._renderData}},{key:"delegateSrc",set:function(e){this._delegateSrc=e}}]),t}(Jw),Kw.BlendState=mo,Kw.Assembler=null,Kw.PostAssembler=null,v((Ww=Zw).prototype,"srcBlendFactor",[zw],Object.getOwnPropertyDescriptor(Ww.prototype,"srcBlendFactor"),Ww.prototype),v(Ww.prototype,"dstBlendFactor",[Uw],Object.getOwnPropertyDescriptor(Ww.prototype,"dstBlendFactor"),Ww.prototype),v(Ww.prototype,"color",[Gw],Object.getOwnPropertyDescriptor(Ww.prototype,"color"),Ww.prototype),v(Ww.prototype,"sharedMaterial",[Vw],Object.getOwnPropertyDescriptor(Ww.prototype,"sharedMaterial"),Ww.prototype),jw=v(Ww.prototype,"_srcBlendFactor",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return mo.SRC_ALPHA}}),Xw=v(Ww.prototype,"_dstBlendFactor",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return mo.ONE_MINUS_SRC_ALPHA}}),qw=v(Ww.prototype,"_color",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return rr.WHITE.clone()}}),Yw=v(Ww.prototype,"_sharedMaterial",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Hw=Ww))||Hw));cc.UIRenderComponent=OC,function(e){e[e.SIMPLE=0]="SIMPLE",e[e.SLICED=1]="SLICED",e[e.TILED=2]="TILED",e[e.FILLED=3]="FILLED"}(AC||(AC={})),pt(AC),function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL",e[e.RADIAL=2]="RADIAL"}(wC||(wC={})),pt(wC),function(e){e[e.CUSTOM=0]="CUSTOM",e[e.TRIMMED=1]="TRIMMED",e[e.RAW=2]="RAW"}(CC||(CC={})),pt(CC),function(e){e.SPRITE_FRAME_CHANGED="spriteframe-changed"}(RC||(RC={}));var IC,MC,LC,PC,BC,DC,FC,NC,zC=e("SpriteComponent",($w=Es("cc.SpriteComponent"),eC=Rs(110),tC=Cs("UI/Render/Sprite"),iC=Ts({type:rv,displayOrder:4,tooltip:" Atlas "}),nC=Ts({type:Yc,displayOrder:5,tooltip:" Sprite  SpriteFrame "}),rC=Ts({type:AC,displayOrder:6,tooltip:"\n- Simple \n- Sliced UI  \n- Filled"}),aC=Ts({type:wC,tooltip:"HorizontalVerticalRadial"}),sC=Ts({tooltip:" 0 ~ 1"}),oC=Ts({range:[0,1,.1],tooltip:" 0 ~ 1 "}),lC=Ts({range:[0,1,.1],tooltip:" 0 ~ 1 "}),uC=Ts({displayOrder:8,tooltip:""}),cC=Ts({type:CC,displayOrder:7,tooltip:" Sprite CUSTOM TRIMMED RAW "}),$w(hC=eC(hC=tC((xC=SC=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),s=0;s<r;s++)a[s]=arguments[s];return m(n=c(this,(e=o(t)).call.apply(e,[this].concat(a))),"_spriteFrame",_C,u(n)),m(n,"_type",dC,u(n)),m(n,"_fillType",pC,u(n)),m(n,"_sizeMode",mC,u(n)),m(n,"_fillCenter",vC,u(n)),m(n,"_fillStart",gC,u(n)),m(n,"_fillRange",yC,u(n)),m(n,"_isTrimmedMode",bC,u(n)),m(n,"_useGrayscale",EC,u(n)),m(n,"_atlas",TC,u(n)),n}return s(t,e),r(t,[{key:"__preload",value:function(){this._useGrayscale&&(this._instanceMaterialType=Qw.GRAYSCALE),f(o(t.prototype),"__preload",this)&&f(o(t.prototype),"__preload",this).call(this),this._spriteFrame&&(this._spriteFrame.on("load",this._markForUpdateUvDirty,this),this._markForUpdateUvDirty())}},{key:"onEnable",value:function(){f(o(t.prototype),"onEnable",this).call(this),this._activateMaterial()}},{key:"onDestroy",value:function(){f(o(t.prototype),"onDestroy",this).call(this),this.destroyRenderData(),this._spriteFrame&&this._spriteFrame.off("load")}},{key:"changeSpriteFrameFromAtlas",value:function(e){if(this._atlas){var t=this._atlas.getSpriteFrame(e);this.spriteFrame=t}else console.warn("SpriteAtlas is null.")}},{key:"_render",value:function(e){e.commitComp(this,this._spriteFrame.getGFXTextureView(),this._assembler)}},{key:"_canRender",value:function(){if(!f(o(t.prototype),"_canRender",this).call(this))return!1;var e=this._spriteFrame;return!(!e||!e.textureLoaded())}},{key:"_flushAssembler",value:function(){var e=t.Assembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this._material,this.markForUpdateRenderData(),this._updateColor())}},{key:"_applySpriteSize",value:function(){if(this._spriteFrame){if(CC.RAW===this._sizeMode){var e=this._spriteFrame.originalSize;this.node.setContentSize(e)}else if(CC.TRIMMED===this._sizeMode){var t=this._spriteFrame.getRect();this.node.setContentSize(t.width,t.height)}this._activateMaterial()}}},{key:"_resized",value:function(){}},{key:"_activateMaterial",value:function(){var e=this._spriteFrame,t=this._material;cc.game.renderType!==cc.game.RENDER_TYPE_CANVAS?(e&&t&&(t.setProperty("mainTexture",e),this.markForUpdateRenderData()),this._renderData&&(this._renderData.material=t)):this.markForUpdateRenderData()}},{key:"_onTextureLoaded",value:function(){this.isValid&&this._applySpriteSize()}},{key:"_applySpriteFrame",value:function(e){var t=this._spriteFrame;this._renderData&&(e&&e.off("load",this._markForUpdateUvDirty),t&&t.on("load",this._markForUpdateUvDirty,this),this._renderData.uvDirty||(this._renderData.uvDirty=!e||!t||e.uvHash!==t.uvHash),this._renderDataFlag=this._renderData.uvDirty),t&&(e&&t===e||(t.loaded?this._onTextureLoaded():t.once("load",this._onTextureLoaded,this)))}},{key:"_markForUpdateUvDirty",value:function(){this._renderData&&(this._renderData.uvDirty=!0,this._renderDataFlag=!0)}},{key:"spriteAtlas",get:function(){return this._atlas},set:function(e){this._atlas!==e&&(this._atlas=e)}},{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(e){if(this._spriteFrame!==e){var t=this._spriteFrame;this._spriteFrame=e,this.markForUpdateRenderData(!1),this._applySpriteFrame(t)}}},{key:"type",get:function(){return this._type},set:function(e){this._type!==e&&(this._type=e,this._flushAssembler())}},{key:"fillType",get:function(){return this._fillType},set:function(e){this._fillType!==e&&(e===wC.RADIAL||this._fillType===wC.RADIAL?(this.destroyRenderData(),this._renderData=null):this._renderData&&this.markForUpdateRenderData(!0)),this._fillType=e,this._flushAssembler()}},{key:"fillCenter",get:function(){return this._fillCenter},set:function(e){this._fillCenter.x=e.x,this._fillCenter.y=e.y,this._type===AC.FILLED&&this._renderData&&this.markForUpdateRenderData()}},{key:"fillStart",get:function(){return this._fillStart},set:function(e){this._fillStart=_i(e,-1,1),this._type===AC.FILLED&&this._renderData&&(this.markForUpdateRenderData(),this._renderData.uvDirty=!0)}},{key:"fillRange",get:function(){return this._fillRange},set:function(e){this._fillRange=_i(e,0,1),this._type===AC.FILLED&&this._renderData&&(this.markForUpdateRenderData(),this._renderData.uvDirty=!0)}},{key:"trim",get:function(){return this._isTrimmedMode},set:function(e){this._isTrimmedMode!==e&&(this._isTrimmedMode=e,this._type===AC.SIMPLE&&this._renderData&&this.markForUpdateRenderData(!0))}},{key:"grayscale",get:function(){return this._useGrayscale},set:function(e){this._useGrayscale!==e&&(this._useGrayscale=e,this._instanceMaterialType=!0===e?Qw.GRAYSCALE:Qw.ADDCOLORANDTEXTURE,this._instanceMaterial())}},{key:"sizeMode",get:function(){return this._sizeMode},set:function(e){this._sizeMode!==e&&(this._sizeMode=e,e!==CC.CUSTOM&&this._applySpriteSize())}}]),t}(OC),SC.FillType=wC,SC.Type=AC,SC.SizeMode=CC,SC.EventType=RC,v((fC=xC).prototype,"spriteAtlas",[iC],Object.getOwnPropertyDescriptor(fC.prototype,"spriteAtlas"),fC.prototype),v(fC.prototype,"spriteFrame",[nC],Object.getOwnPropertyDescriptor(fC.prototype,"spriteFrame"),fC.prototype),v(fC.prototype,"type",[rC],Object.getOwnPropertyDescriptor(fC.prototype,"type"),fC.prototype),v(fC.prototype,"fillType",[aC],Object.getOwnPropertyDescriptor(fC.prototype,"fillType"),fC.prototype),v(fC.prototype,"fillCenter",[sC],Object.getOwnPropertyDescriptor(fC.prototype,"fillCenter"),fC.prototype),v(fC.prototype,"fillStart",[oC],Object.getOwnPropertyDescriptor(fC.prototype,"fillStart"),fC.prototype),v(fC.prototype,"fillRange",[lC],Object.getOwnPropertyDescriptor(fC.prototype,"fillRange"),fC.prototype),v(fC.prototype,"trim",[uC],Object.getOwnPropertyDescriptor(fC.prototype,"trim"),fC.prototype),v(fC.prototype,"grayscale",[Ts],Object.getOwnPropertyDescriptor(fC.prototype,"grayscale"),fC.prototype),v(fC.prototype,"sizeMode",[cC],Object.getOwnPropertyDescriptor(fC.prototype,"sizeMode"),fC.prototype),_C=v(fC.prototype,"_spriteFrame",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),dC=v(fC.prototype,"_type",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return AC.SIMPLE}}),pC=v(fC.prototype,"_fillType",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return wC.HORIZONTAL}}),mC=v(fC.prototype,"_sizeMode",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return CC.TRIMMED}}),vC=v(fC.prototype,"_fillCenter",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Mi(0,0)}}),gC=v(fC.prototype,"_fillStart",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),yC=v(fC.prototype,"_fillRange",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),bC=v(fC.prototype,"_isTrimmedMode",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),EC=v(fC.prototype,"_useGrayscale",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),TC=v(fC.prototype,"_atlas",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),hC=fC))||hC)||hC)||hC));cc.SpriteComponent=zC;var UC=e("SubContextView",(IC=Es("cc.SubContextView"),MC=Rs(110),LC=ws(Lf),PC=Cs("Components/SubContextView"),BC=Ts({tooltip:""}),IC(DC=MC(DC=LC(DC=PC((v((FC=function(e){function t(){var e;return i(this,t),m(e=c(this,o(t).call(this)),"_fps",NC,u(e)),e._updatedTime=0,e._updateInterval=0,e._sprite=null,e._imageAsset=new Ju,e._context=null,e._updatedTime=performance.now(),e}return s(t,e),r(t,[{key:"fps",get:function(){return this._fps},set:function(e){this._fps!==e&&(this._fps=e,this._updateInterval=1/e,this._updateSubContextFrameRate())}}]),r(t,[{key:"onLoad",value:function(){if(wx&&wx.getOpenDataContext){this._updateInterval=1e3/this._fps,this._context=wx.getOpenDataContext(),this.reset();var e=this._imageAsset,t=this._context.canvas;if(e.reset(t),e._texture.create(t.width,t.height),this._sprite=this.node.getComponent(zC),this._sprite||(this._sprite=this.node.addComponent(zC)),this._sprite.spriteFrame)this._sprite.spriteFrame.texture=this._imageAsset._texture;else{var i=new Yc;i.texture=this._imageAsset._texture,this._sprite.spriteFrame=i}}else this.enabled=!1}},{key:"onEnable",value:function(){this._runSubContextMainLoop(),this._registerNodeEvent(),this._updateSubContextFrameRate(),this.updateSubContextViewport()}},{key:"onDisable",value:function(){this._unregisterNodeEvent(),this._stopSubContextMainLoop()}},{key:"update",value:function(e){if(void 0===e)return this._context&&this._context.postMessage({fromEngine:!0,event:"step"}),void this._updateSubContextTexture();performance.now()-this._updatedTime>=this._updateInterval&&(this._updatedTime+=this._updateInterval,this._updateSubContextTexture())}},{key:"reset",value:function(){if(this._context){this.updateSubContextViewport();var e=this._context.canvas,t=this.node.getComponent(Lf);e&&(e.width=t.width,e.height=t.height)}}},{key:"updateSubContextViewport",value:function(){if(this._context){var e=this.node.getComponent(Lf).getBoundingBoxToWorld(),t=qx.getScaleX(),i=qx.getScaleY(),n=qx.getViewportRect();this._context.postMessage({fromEngine:!0,event:"viewport",x:e.x*t+n.x,y:e.y*i+n.y,width:e.width*t,height:e.height*i})}}},{key:"_updateSubContextTexture",value:function(){var e=this._imageAsset;if(e&&this._context&&!(e.width<=0||e.height<=0)){var t=this._context.canvas;e.reset(t),(t.width>e.width||t.height>e.height)&&this._imageAsset._texture.create(t.width,t.height),this._imageAsset._texture.uploadData(t)}}},{key:"_registerNodeEvent",value:function(){this.node.on(o_.EventType.TRANSFORM_CHANGED,this.updateSubContextViewport,this),this.node.on(o_.EventType.SIZE_CHANGED,this.updateSubContextViewport,this)}},{key:"_unregisterNodeEvent",value:function(){this.node.off(o_.EventType.TRANSFORM_CHANGED,this.updateSubContextViewport,this),this.node.off(o_.EventType.SIZE_CHANGED,this.updateSubContextViewport,this)}},{key:"_runSubContextMainLoop",value:function(){this._context&&this._context.postMessage({fromEngine:!0,event:"mainLoop",value:!0})}},{key:"_stopSubContextMainLoop",value:function(){this._context&&this._context.postMessage({fromEngine:!0,event:"mainLoop",value:!1})}},{key:"_updateSubContextFrameRate",value:function(){this._context&&this._context.postMessage({fromEngine:!0,event:"frameRate",value:this._fps})}}]),t}(Ph)).prototype,"fps",[BC],Object.getOwnPropertyDescriptor(FC.prototype,"fps"),FC.prototype),NC=v(FC.prototype,"_fps",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),DC=FC))||DC)||DC)||DC)||DC));cc.SubContextView=UC;var GC=e("System",function(){function e(){i(this,e),this._id="",this._priority=0,this._executeInEditMode=!1}return r(e,[{key:"init",value:function(){}},{key:"update",value:function(e){}},{key:"postUpdate",value:function(e){}},{key:"priority",set:function(e){this._priority=e},get:function(){return this._priority}},{key:"id",set:function(e){this._id=e},get:function(){return this._id}}],[{key:"sortByPriority",value:function(e,t){return e._priority<t._priority?1:e._priority>t.priority?-1:0}}]),e}()),VC=new ve("Scheduler"),HC=function e(t,n,r,a){i(this,e),this.target=t,this.priority=n,this.paused=r,this.markedForDeletion=a};HC.get=function(e,t,i,n){var r=HC._listEntries.pop();return r?(r.target=e,r.priority=t,r.paused=i,r.markedForDeletion=n):r=new HC(e,t,i,n),r},HC.put=function(e){HC._listEntries.length<20&&(e.target=null,HC._listEntries.push(e))},HC._listEntries=[];var WC=function e(t,n,r,a){i(this,e),this.list=t,this.entry=n,this.target=r,this.callback=a};WC.get=function(e,t,i,n){var r=WC._hashUpdateEntries.pop();return r?(r.list=e,r.entry=t,r.target=i,r.callback=n):r=new WC(e,t,i,n),r},WC.put=function(e){WC._hashUpdateEntries.length<20&&(e.list=e.entry=e.target=e.callback=null,WC._hashUpdateEntries.push(e))},WC._hashUpdateEntries=[];var jC=function e(t,n,r,a,s,o){i(this,e),this.timers=t,this.target=n,this.timerIndex=r,this.currentTimer=a,this.currentTimerSalvaged=s,this.paused=o};jC.get=function(e,t,i,n,r,a){var s=jC._hashTimerEntries.pop();return s?(s.timers=e,s.target=t,s.timerIndex=i,s.currentTimer=n,s.currentTimerSalvaged=r,s.paused=a):s=new jC(e,t,i,n,r,a),s},jC.put=function(e){jC._hashTimerEntries.length<20&&(e.timers=e.target=e.currentTimer=null,jC._hashTimerEntries.push(e))},jC._hashTimerEntries=[];var XC=function(){function e(){i(this,e),this._lock=!1,this._scheduler=null,this._elapsed=-1,this._runForever=!1,this._useDelay=!1,this._timesExecuted=0,this._repeat=0,this._delay=0,this._interval=0,this._target=null,this._callback=null}return r(e,[{key:"initWithCallback",value:function(e,t,i,n,r,a){return this._lock=!1,this._scheduler=e,this._target=i,this._callback=t,this._elapsed=-1,this._interval=n,this._delay=a,this._useDelay=this._delay>0,this._repeat=r,this._runForever=this._repeat===cc.macro.REPEAT_FOREVER,!0}},{key:"getInterval",value:function(){return this._interval}},{key:"setInterval",value:function(e){this._interval=e}},{key:"update",value:function(e){-1===this._elapsed?(this._elapsed=0,this._timesExecuted=0):(this._elapsed+=e,this._runForever&&!this._useDelay?this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0):(this._useDelay?this._elapsed>=this._delay&&(this.trigger(),this._elapsed-=this._delay,this._timesExecuted+=1,this._useDelay=!1):this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0,this._timesExecuted+=1),this._callback&&!this._runForever&&this._timesExecuted>this._repeat&&this.cancel()))}},{key:"getCallback",value:function(){return this._callback}},{key:"trigger",value:function(){this._target&&this._callback&&(this._lock=!0,this._callback.call(this._target,this._elapsed),this._lock=!1)}},{key:"cancel",value:function(){this._scheduler.unschedule(this._callback,this._target)}}]),e}();XC._timers=[],XC.get=function(){return XC._timers.pop()||new XC},XC.put=function(e){XC._timers.length<20&&!e._lock&&(e._scheduler=e._target=e._callback=null,XC._timers.push(e))};var qC=e("Scheduler",function(e){function t(){var e;return i(this,t),(e=c(this,o(t).call(this)))._timeScale=1,e._updatesNegList=[],e._updates0List=[],e._updatesPosList=[],e._hashForUpdates=we(!0),e._hashForTimers=we(!0),e._currentTarget=null,e._currentTargetSalvaged=!1,e._updateHashLocked=!1,e._arrayForTimers=[],e}return s(t,e),r(t,null,[{key:"enableForTarget",value:function(e){var t=!1;e.uuid?t=!0:e.id&&(t=!0),t||(e.__instanceId?cc.warnID(1513):e.id=VC.getNewId())}}]),r(t,[{key:"setTimeScale",value:function(e){this._timeScale=e}},{key:"getTimeScale",value:function(){return this._timeScale}},{key:"update",value:function(e){var t,i,n,r,a;for(this._updateHashLocked=!0,1!==this._timeScale&&(e*=this._timeScale),t=0,n=(i=this._updatesNegList).length;t<n;t++)(r=i[t]).paused||r.markedForDeletion||r.target.update(e);for(t=0,n=(i=this._updates0List).length;t<n;t++)(r=i[t]).paused||r.markedForDeletion||r.target.update(e);for(t=0,n=(i=this._updatesPosList).length;t<n;t++)(r=i[t]).paused||r.markedForDeletion||r.target.update(e);var s=this._arrayForTimers;for(t=0;t<s.length;t++){if(a=s[t],this._currentTarget=a,this._currentTargetSalvaged=!1,!a.paused)for(a.timerIndex=0;a.timerIndex<a.timers.length;++a.timerIndex)a.currentTimer=a.timers[a.timerIndex],a.currentTimerSalvaged=!1,a.currentTimer.update(e),a.currentTimer=null;this._currentTargetSalvaged&&0===this._currentTarget.timers.length&&(this._removeHashElement(this._currentTarget),--t)}for(t=0,i=this._updatesNegList;t<i.length;)(r=i[t]).markedForDeletion?this._removeUpdateFromHash(r):t++;for(t=0,i=this._updates0List;t<i.length;)(r=i[t]).markedForDeletion?this._removeUpdateFromHash(r):t++;for(t=0,i=this._updatesPosList;t<i.length;)(r=i[t]).markedForDeletion?this._removeUpdateFromHash(r):t++;this._updateHashLocked=!1,this._currentTarget=null}},{key:"schedule",value:function(e,t,i,n,r,a){if("function"!=typeof e){var s=e;e=t,t=s}3!==arguments.length&&4!==arguments.length&&5!==arguments.length||(a=!!n,n=cc.macro.REPEAT_FOREVER,r=0),cc.assertID(t,1502);var o=t.uuid||t.id;if(o){var l,u,c=this._hashForTimers[o];if(c?c.paused!==a&&cc.warnID(1511):(c=jC.get(null,t,0,null,null,a),this._arrayForTimers.push(c),this._hashForTimers[o]=c),null==c.timers)c.timers=[];else for(u=0;u<c.timers.length;++u)if((l=c.timers[u])&&e===l._callback)return cc.logID(1507,l.getInterval(),i),void(l._interval=i);(l=XC.get()).initWithCallback(this,e,t,i,n,r),c.timers.push(l),this._currentTarget===c&&this._currentTargetSalvaged&&(this._currentTargetSalvaged=!1)}else cc.errorID(1510)}},{key:"scheduleUpdate",value:function(e,t,i){var n=e.uuid||e.id;if(n){var r=this._hashForUpdates[n];if(r&&r.entry){if(r.entry.priority===t)return r.entry.markedForDeletion=!1,void(r.entry.paused=i);if(this._updateHashLocked)return cc.logID(1506),r.entry.markedForDeletion=!1,void(r.entry.paused=i);this.unscheduleUpdate(e)}var a,s=HC.get(e,t,i,!1);0===t?(a=this._updates0List,this._appendIn(a,s)):(a=t<0?this._updatesNegList:this._updatesPosList,this._priorityIn(a,s,t)),this._hashForUpdates[n]=WC.get(a,s,e,null)}else cc.errorID(1510)}},{key:"unschedule",value:function(e,t){if(t&&e){var i=t.uuid||t.id;if(i){var n=this._hashForTimers[i];if(n)for(var r=n.timers,a=0,s=r.length;a<s;a++){var o=r[a];if(e===o._callback)return o!==n.currentTimer||n.currentTimerSalvaged||(n.currentTimerSalvaged=!0),r.splice(a,1),XC.put(o),n.timerIndex>=a&&n.timerIndex--,void(0===r.length&&(this._currentTarget===n?this._currentTargetSalvaged=!0:this._removeHashElement(n)))}}else cc.errorID(1510)}}},{key:"unscheduleUpdate",value:function(e){if(e){var t=e.uuid||e.id;if(t){var i=this._hashForUpdates[t];i&&(this._updateHashLocked?i.entry.markedForDeletion=!0:this._removeUpdateFromHash(i.entry))}else cc.errorID(1510)}}},{key:"unscheduleAllForTarget",value:function(e){if(e){var t=e.uuid||e.id;if(t){var i=this._hashForTimers[t];if(i){var n=i.timers;n.indexOf(i.currentTimer)>-1&&!i.currentTimerSalvaged&&(i.currentTimerSalvaged=!0);for(var r=0,a=n.length;r<a;r++)XC.put(n[r]);n.length=0,this._currentTarget===i?this._currentTargetSalvaged=!0:this._removeHashElement(i)}this.unscheduleUpdate(e)}else cc.errorID(1510)}}},{key:"unscheduleAll",value:function(){this.unscheduleAllWithMinPriority(cc.Scheduler.PRIORITY_SYSTEM)}},{key:"unscheduleAllWithMinPriority",value:function(e){var t,i,n,r=this._arrayForTimers;for(t=r.length-1;t>=0;t--)i=r[t],this.unscheduleAllForTarget(i.target);var a=0;if(e<0)for(t=0;t<this._updatesNegList.length;)a=this._updatesNegList.length,(n=this._updatesNegList[t])&&n.priority>=e&&this.unscheduleUpdate(n.target),a===this._updatesNegList.length&&t++;if(e<=0)for(t=0;t<this._updates0List.length;)a=this._updates0List.length,(n=this._updates0List[t])&&this.unscheduleUpdate(n.target),a===this._updates0List.length&&t++;for(t=0;t<this._updatesPosList.length;)a=this._updatesPosList.length,(n=this._updatesPosList[t])&&n.priority>=e&&this.unscheduleUpdate(n.target),a===this._updatesPosList.length&&t++}},{key:"isScheduled",value:function(e,t){cc.assertID(e,1508),cc.assertID(t,1509);var i=t.uuid||t.id;if(i){var n=this._hashForTimers[i];if(!n)return!1;if(null==n.timers)return!1;for(var r=n.timers,a=0;a<r.length;++a){if(e===r[a]._callback)return!0}return!1}cc.errorID(1510)}},{key:"pauseAllTargets",value:function(){return this.pauseAllTargetsWithMinPriority(cc.Scheduler.PRIORITY_SYSTEM)}},{key:"pauseAllTargetsWithMinPriority",value:function(e){var t,i,n,r,a=[],s=this._arrayForTimers;for(i=0,n=s.length;i<n;i++)(t=s[i])&&(t.paused=!0,a.push(t.target));if(e<0)for(i=0;i<this._updatesNegList.length;i++)(r=this._updatesNegList[i])&&r.priority>=e&&(r.paused=!0,a.push(r.target));if(e<=0)for(i=0;i<this._updates0List.length;i++)(r=this._updates0List[i])&&(r.paused=!0,a.push(r.target));for(i=0;i<this._updatesPosList.length;i++)(r=this._updatesPosList[i])&&r.priority>=e&&(r.paused=!0,a.push(r.target));return a}},{key:"resumeTargets",value:function(e){if(e)for(var t=0;t<e.length;t++)this.resumeTarget(e[t])}},{key:"pauseTarget",value:function(e){cc.assertID(e,1503);var t=e.uuid||e.id;if(t){var i=this._hashForTimers[t];i&&(i.paused=!0);var n=this._hashForUpdates[t];n&&(n.entry.paused=!0)}else cc.errorID(1510)}},{key:"resumeTarget",value:function(e){cc.assertID(e,1504);var t=e.uuid||e.id;if(t){var i=this._hashForTimers[t];i&&(i.paused=!1);var n=this._hashForUpdates[t];n&&(n.entry.paused=!1)}else cc.errorID(1510)}},{key:"isTargetPaused",value:function(e){cc.assertID(e,1505);var t=e.uuid||e.id;if(!t)return cc.errorID(1510),!1;var i=this._hashForTimers[t];if(i)return i.paused;var n=this._hashForUpdates[t];return!!n&&n.entry.paused}},{key:"_removeHashElement",value:function(e){var t=e.target.uuid||e.target.id;delete this._hashForTimers[t];for(var i=this._arrayForTimers,n=0,r=i.length;n<r;n++)if(i[n]===e){i.splice(n,1);break}jC.put(e)}},{key:"_removeUpdateFromHash",value:function(e){var t=e.target.uuid||e.target.id,i=this._hashForUpdates[t];if(i){for(var n=i.list,r=i.entry,a=0,s=n.length;a<s;a++)if(n[a]===r){n.splice(a,1);break}delete this._hashForUpdates[t],HC.put(r),WC.put(i)}}},{key:"_priorityIn",value:function(e,t,i){for(var n=0;n<e.length;n++)if(i<e[n].priority)return void e.splice(n,0,t);e.push(t)}},{key:"_appendIn",value:function(e,t){e.push(t)}}]),t}(GC));qC.PRIORITY_SYSTEM=1<<31,qC.PRIORITY_NON_SYSTEM=qC.PRIORITY_SYSTEM+1,qC.ID="scheduler",cc.Scheduler=qC;var YC,KC=function(){function e(t){i(this,e),this.jointsTexturePool=new w_(t),this.jointsAnimationInfo=new C_(t),this.animatedBoundsInfo=new I_}return r(e,[{key:"releaseMesh",value:function(e){this.animatedBoundsInfo.releaseMesh(e)}},{key:"releaseSkeleton",value:function(e){this.jointsTexturePool.releaseSkeleton(e),this.animatedBoundsInfo.releaseSkeleton(e)}},{key:"releaseAnimationClip",value:function(e){this.jointsTexturePool.releaseAnimationClip(e),this.animatedBoundsInfo.releaseAnimationClip(e)}},{key:"clear",value:function(){this.jointsTexturePool.clear(),this.jointsAnimationInfo.clear(),this.animatedBoundsInfo.clear()}}]),e}(),ZC=e("MeshBuffer",function(){function e(t){i(this,e),this.vData=null,this.iData=null,this.vb=null,this.ib=null,this.ia=null,this.byteStart=0,this.byteOffset=0,this.indiceStart=0,this.indiceOffset=0,this.vertexStart=0,this.vertexOffset=0,this.lastByteOffset=1,this.dirty=!1,this._vertexFormatBytes=9*Float32Array.BYTES_PER_ELEMENT,this._initVDataCount=256*this._vertexFormatBytes,this._initIDataCount=1536,this._outofCallback=null,this.batcher=t}return r(e,[{key:"initialize",value:function(e,t){this._outofCallback=t;var i=9*Float32Array.BYTES_PER_ELEMENT;this.vb=this.vb||this.batcher.device.createBuffer({usage:ro.VERTEX|ro.TRANSFER_DST,memUsage:ao.HOST|ao.DEVICE,size:0,stride:i});var n=Uint16Array.BYTES_PER_ELEMENT;this.ib=this.ib||this.batcher.device.createBuffer({usage:ro.INDEX|ro.TRANSFER_DST,memUsage:ao.HOST|ao.DEVICE,size:0,stride:n}),this.ia=this.ia||this.batcher.device.createInputAssembler({attributes:e,vertexBuffers:[this.vb],indexBuffer:this.ib}),this._reallocBuffer()}},{key:"request",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:4,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:6;this.lastByteOffset=this.byteOffset;var i=this.byteOffset+e*this._vertexFormatBytes,n=this.indiceOffset+t;if(e+this.vertexOffset>65535)return this.batcher.autoMergeBatches(),this._outofCallback&&this._outofCallback.call(this.batcher,e,t),!1;var r=this.vData.byteLength,a=this.iData.length;if(i>r||n>a){for(;r<i||a<n;)this._initVDataCount*=2,this._initIDataCount*=2,r=4*this._initVDataCount,a=this._initIDataCount;this._reallocBuffer()}return this.vertexOffset+=e,this.indiceOffset+=t,this.byteOffset=i,this.dirty=!0,!0}},{key:"reset",value:function(){this.byteStart=0,this.byteOffset=0,this.indiceStart=0,this.indiceOffset=0,this.vertexStart=0,this.vertexOffset=0,this.lastByteOffset=0,this.dirty=!1}},{key:"destroy",value:function(){this.ib.destroy(),this.vb.destroy(),this.ia.destroy(),this.ib=null,this.vb=null,this.ia=null}},{key:"uploadData",value:function(){if(0!==this.byteOffset&&this.dirty){var e=new Float32Array(this.vData.buffer,0,this.byteOffset>>2),t=new Uint16Array(this.iData.buffer,0,this.indiceOffset);this.byteOffset>this.vb.size&&this.vb.resize(this.byteOffset),this.vb.update(e),2*this.indiceOffset>this.ib.size&&this.ib.resize(2*this.indiceOffset),this.ib.update(t)}}},{key:"_reallocBuffer",value:function(){this._reallocVData(!0),this._reallocIData(!0)}},{key:"_reallocVData",value:function(e){var t;if(this.vData&&(t=new Uint8Array(this.vData.buffer)),this.vData=new Float32Array(this._initVDataCount),t&&e)for(var i=new Uint8Array(this.vData.buffer),n=0,r=t.length;n<r;n++)i[n]=t[n]}},{key:"_reallocIData",value:function(e){var t=this.iData;if(this.iData=new Uint16Array(this._initIDataCount),t&&e)for(var i=this.iData,n=0,r=t.length;n<r;n++)i[n]=t[n]}}]),e}());ZC.OPACITY_OFFSET=8,function(e){e[e.DISABLED=0]="DISABLED",e[e.CLEAR=1]="CLEAR",e[e.ENTER_LEVEL=2]="ENTER_LEVEL",e[e.ENABLED=3]="ENABLED",e[e.EXIT_LEVEL=4]="EXIT_LEVEL"}(YC||(YC={}));var QC=e("StencilManager",function(){function e(){i(this,e),this.stage=YC.DISABLED,this._maskStack=[],this._stencilPattern={stencilTest:!0,func:fo.ALWAYS,stencilMask:65535,writeMask:65535,failOp:_o.KEEP,zFailOp:_o.KEEP,passOp:_o.KEEP,ref:1},this._defaultPipelineState={depthStencilState:{},rasterizerState:{},blendState:{}}}return r(e,[{key:"pushMask",value:function(e){this._maskStack.push(e)}},{key:"clear",value:function(){this.stage=YC.CLEAR}},{key:"enterLevel",value:function(){this.stage=YC.ENTER_LEVEL}},{key:"enableMask",value:function(){this.stage=YC.ENABLED}},{key:"exitMask",value:function(){0!==this._maskStack.length&&(this._maskStack.pop(),0===this._maskStack.length?this.stage=YC.DISABLED:this.stage=YC.ENABLED)}},{key:"handleMaterial",value:function(e){var t=this._stencilPattern;if(this.stage===YC.DISABLED)t.stencilTest=!1,t.func=fo.ALWAYS,t.failOp=_o.KEEP,t.stencilMask=t.writeMask=65535,t.ref=1;else if(t.stencilTest=!0,this.stage===YC.ENABLED)t.func=fo.EQUAL,t.failOp=_o.KEEP,t.stencilMask=t.ref=this.getStencilRef(),t.writeMask=this.getWriteMask();else if(this.stage===YC.CLEAR){var i=this._maskStack[this._maskStack.length-1];t.func=fo.NEVER,t.failOp=i.inverted?_o.REPLACE:_o.ZERO,t.writeMask=t.stencilMask=t.ref=this.getWriteMask()}else if(this.stage===YC.ENTER_LEVEL){var n=this._maskStack[this._maskStack.length-1];t.func=fo.NEVER,t.failOp=n.inverted?_o.ZERO:_o.REPLACE,t.writeMask=t.stencilMask=t.ref=this.getWriteMask()}var r=e.passes[0];if(this._changed(r)){var a=this._stencilPattern;return this._defaultPipelineState.depthStencilState={stencilTestFront:a.stencilTest,stencilFuncFront:a.func,stencilReadMaskFront:a.stencilMask,stencilWriteMaskFront:a.writeMask,stencilFailOpFront:a.failOp,stencilZFailOpFront:a.zFailOp,stencilPassOpFront:a.passOp,stencilRefFront:a.ref,stencilTestBack:a.stencilTest,stencilFuncBack:a.func,stencilReadMaskBack:a.stencilMask,stencilWriteMaskBack:a.writeMask,stencilFailOpBack:a.failOp,stencilZFailOpBack:a.zFailOp,stencilPassOpBack:a.passOp,stencilRefBack:a.ref},this._defaultPipelineState.blendState=r.blendState,this._defaultPipelineState.rasterizerState=r.rasterizerState,e.overridePipelineStates(this._defaultPipelineState),!0}return!1}},{key:"getWriteMask",value:function(){return 1<<this._maskStack.length-1}},{key:"getExitWriteMask",value:function(){return 1<<this._maskStack.length}},{key:"getStencilRef",value:function(){for(var e=0,t=0;t<this._maskStack.length;++t)e+=1<<t;return e}},{key:"reset",value:function(){this._maskStack.length=0,this.stage=YC.DISABLED}},{key:"_changed",value:function(e){var t=e.depthStencilState,i=this._stencilPattern;return i.stencilTest!==t.stencilTestFront||i.func!==t.stencilFuncFront||i.failOp!==t.stencilFailOpFront||i.zFailOp!==t.stencilZFailOpFront||i.passOp!==t.stencilPassOpFront||i.stencilMask!==t.stencilReadMaskFront||i.writeMask!==t.stencilWriteMaskFront||i.ref!==t.stencilRefFront}}]),e}());QC.sharedManager=null,QC.sharedManager=new QC;var JC=function(e){function t(){var e;return i(this,t),(e=c(this,o(t).call(this)))._subModel=new $C,e}return s(t,e),r(t,[{key:"updateTransform",value:function(){}},{key:"updateUBOs",value:function(){return!1}},{key:"directInitialize",value:function(e,t){this._subModel.directInitialize(e,t.material,t.pipelineState),this._subModels[0]=this._subModel}},{key:"destroy",value:function(){this._subModel.destroy()}}]),t}(Zu),$C=function(e){function t(){var e;return i(this,t),(e=c(this,o(t).call(this))).psos=[],e}return s(t,e),r(t,[{key:"directInitialize",value:function(e,t,i){this._inputAssembler=e,this.psos[0]=i,this.material=t}},{key:"destroy",value:function(){this.commandBuffers.length>0&&this.commandBuffers[0].destroy()}}]),t}(Lu),eR=function(){function e(){i(this,e),this.camera=null,this.bufferBatch=null,this.model=null,this.material=null,this.texView=null,this.firstIdx=0,this.idxCount=0,this.pipelineState=null,this.bindingLayout=null,this.useLocalData=null,this.isStatic=!1}return r(e,[{key:"destroy",value:function(e){this.pipelineState&&(e._getUIMaterial(this.material).revertPipelineState(this.pipelineState),this.pipelineState=null),this.bindingLayout&&(this.bindingLayout=null)}},{key:"clear",value:function(e){this.pipelineState&&(e._getUIMaterial(this.material).revertPipelineState(this.pipelineState),this.pipelineState=null),this.camera=null,this.bufferBatch=null,this.material=null,this.texView=null,this.firstIdx=0,this.idxCount=0,this.model=null,this.isStatic=!1}}]),e}(),tR=function(){function e(){i(this,e),this._material=null,this._pass=null,this._refCount=0,this._psos=null}return r(e,[{key:"material",get:function(){return this._material}},{key:"pass",get:function(){return this._pass}}]),r(e,[{key:"initialize",value:function(e){var t=this;return!!e.material&&(this._material=new np,this._material.copy(e.material),this._pass=this._material.passes[0],this._pass.update(),this._psos=new Za((function(){return t._pass.createPipelineState()}),1),!0)}},{key:"increase",value:function(){return this._refCount++,this._refCount}},{key:"decrease",value:function(){return this._refCount--,0===this._refCount&&this.destroy(),this._refCount}},{key:"getPipelineState",value:function(){return this._psos.alloc()}},{key:"revertPipelineState",value:function(e){this._psos.free(e)}},{key:"destroy",value:function(){var e=this;this._psos&&this._psos.clear((function(t){e._pass.destroyPipelineState(t)})),this._material&&(this._material.destroy(),this._material=null),this._refCount=0}}]),e}(),iR=[{name:to.ATTR_POSITION,format:no.RGB32F},{name:to.ATTR_TEX_COORD,format:no.RG32F},{name:to.ATTR_COLOR,format:no.RGBA32F}],nR=Object.freeze({__proto__:null,vfmt:iR});e("UIVertexFormat",nR);var rR=function(){function e(t){var n=this;i(this,e),this._screens=[],this._bufferBatchPool=new Qa((function(){return new ZC(n)}),128),this._drawBatchPool=new Za((function(){return new eR}),128),this._cmdBuff=null,this._attributes=[],this._meshBuffers=[],this._meshBufferUseCount=0,this._uiMaterials=new Map,this._canvasMaterials=new Map,this._uiModelPool=null,this._emptyMaterial=new np,this._currMaterial=this._emptyMaterial,this._currTexView=null,this._currCanvas=null,this._currMeshBuffer=null,this._currStaticRoot=null,this._parentOpacity=1,this._root=t,this.device=t.device,this._scene=this._root.createScene({name:"GUIScene"}),this._uiModelPool=new Za((function(){var e=cc.director.root.createModel(JC);return e.enabled=!0,e.visFlags|=du.Enum.UI_3D,e}),2),this._modelInUse=new Ja(10),this._batches=new Ja(64),cc.director.on(cc.Director.EVENT_BEFORE_DRAW,this.update,this)}return r(e,[{key:"renderScene",get:function(){return this._scene}},{key:"currBufferBatch",get:function(){return this._currMeshBuffer},set:function(e){e&&(this._currMeshBuffer=e)}},{key:"currStaticRoot",set:function(e){this._currStaticRoot=e}}]),r(e,[{key:"initialize",value:function(){return this._attributes=iR,this._requireBufferBatch(),this._cmdBuff=this.device.createCommandBuffer({allocator:this.device.commandAllocator,type:Co.PRIMARY}),!0}},{key:"destroy",value:function(){var e=this._batches.array,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.destroy(this)}var r=this._meshBuffers,a=Array.isArray(r),s=0;for(r=a?r:r[Symbol.iterator]();;){var o;if(a){if(s>=r.length)break;o=r[s++]}else{if((s=r.next()).done)break;o=s.value}o.destroy()}this._meshBuffers.splice(0),this._destroyUIMaterials(),this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null)}},{key:"getRenderSceneGetter",value:function(){return Object.getOwnPropertyDescriptor(Object.getPrototypeOf(this),"renderScene").get.bind(this)}},{key:"_getUIMaterial",value:function(e){if(this._uiMaterials.has(e.hash))return this._uiMaterials.get(e.hash);var t=new tR;return t.initialize({material:e}),this._uiMaterials.set(e.hash,t),t}},{key:"_removeUIMaterial",value:function(e){this._uiMaterials.has(e)&&0===this._uiMaterials.get(e).decrease()&&this._uiMaterials.delete(e)}},{key:"addScreen",value:function(e){for(var t=this._screens,i=0;i<t.length;i++){var n=t[i];if(n.camera){var r=n.camera.view.visibility,a=this._canvasMaterials.get(r);if(a){for(var s=a.keys(),o=s.next();!o.done;)this._removeUIMaterial(o.value),o=s.next();a.clear()}}}this._screens.push(e),this._screens.sort(this._screenSort);for(var l=0;l<t.length;l++){var u=t[l];u.camera&&(u.camera.view.visibility=du.BitMask.UI_2D|l+1,this._canvasMaterials.has(u.camera.view.visibility)||this._canvasMaterials.set(u.camera.view.visibility,new Map))}}},{key:"getScreen",value:function(e){for(var t=this._screens,i=0;i<t.length;++i){var n=t[i];if(n.camera&&n.camera.view.visibility===e)return n}return null}},{key:"removeScreen",value:function(e){var t=this,i=this._screens.indexOf(e);if(-1!==i){if(this._screens.splice(i,1),e.camera){for(var n=this._canvasMaterials.get(e.camera.view.visibility),r=n.keys(),a=r.next();!a.done;)this._removeUIMaterial(a.value),a=r.next();n.clear()}for(var s,o=i;o<this._screens.length;o++)(s=this._screens[o].camera)&&function(){var e=t._canvasMaterials.get(s.view.visibility);s.view.visibility=du.BitMask.UI_2D|o+1;var i=t._canvasMaterials.get(s.view.visibility);e.forEach((function(e,t){i.set(t,e)})),e.clear()}()}}},{key:"update",value:function(e){if(this._renderScreens(),this._batches.length>0)for(var t=this._meshBuffers,i=0;i<t.length;++i){var n=t[i];n.uploadData(),n.reset()}this.render(),this._reset()}},{key:"sortScreens",value:function(){this._screens.sort(this._screenSort)}},{key:"render",value:function(){for(var e=0,t=0;t<this._modelInUse.length;t++)this._scene.removeModel(this._modelInUse.get(t)),this._uiModelPool.free(this._modelInUse.get(t));if(this._modelInUse.clear(),this._batches.length)for(var i=0;i<this._batches.length;++i){var n=this._batches.array[i];if(n.model){if(n.camera){var r=n.camera.view.visibility;n.model.visFlags=r,n.model.node.layer=r}for(var a=0;a<n.model.subModelNum;a++)n.model.getSubModel(a).priority=e++}else{var s=n.bindingLayout;s.bindTextureView(vu.CUSTOM_SAMPLER_BINDING_START_POINT,n.texView),s.update();var o=n.bufferBatch.ia;o.firstIndex=n.firstIdx,o.indexCount=n.idxCount;var l=this._uiModelPool.alloc();l.directInitialize(o,n),this._scene.addModel(l),l.getSubModel(0).priority=e++,n.camera&&(l.visFlags=n.camera.view.visibility,null==this._canvasMaterials.get(n.camera.view.visibility).get(n.material.hash)&&(this._uiMaterials.get(n.material.hash).increase(),this._canvasMaterials.get(n.camera.view.visibility).set(n.material.hash,1))),this._modelInUse.push(l)}}}},{key:"commitComp",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2?arguments[2]:void 0,n=e,r=t;this._currMaterial.hash===n.material.hash&&this._currTexView===r||(this.autoMergeBatches(),this._currMaterial=n.material,this._currTexView=r),i&&(i.fillBuffers(n,this),this._applyOpacity(n))}},{key:"commitModel",value:function(e,t,i){if((this._currMaterial!==this._emptyMaterial&&this.autoMergeBatches(),i)&&(QC.sharedManager.handleMaterial(i)&&t))for(var n=0;n<t.subModelNum;n++)t.setSubModelMaterial(n,i);var r=this._currCanvas,a=this._drawBatchPool.alloc();a.camera=r&&r.camera,a.model=t,a.bufferBatch=null,a.material=i,a.texView=null,a.firstIdx=0,a.idxCount=0,a.pipelineState=null,a.bindingLayout=null,this._currMaterial=this._emptyMaterial,this._currTexView=null,this._batches.push(a)}},{key:"commitStaticBatch",value:function(e){this._batches.concat(e.drawBatchList),this.finishMergeBatches()}},{key:"autoMergeBatches",value:function(){var e=this._currMaterial,t=this._currMeshBuffer,i=t.indiceStart,n=t.indiceOffset-i;if(n&&e){var r=this._currCanvas;QC.sharedManager.handleMaterial(e);var a=this._currStaticRoot?this._currStaticRoot._requireDrawBatch():this._drawBatchPool.alloc();a.camera=r&&r.camera,a.bufferBatch=t,a.material=e,a.texView=this._currTexView,a.firstIdx=i,a.idxCount=n,a.pipelineState=this._getUIMaterial(e).getPipelineState(),a.bindingLayout=a.pipelineState.pipelineLayout.layouts[0],this._batches.push(a),t.vertexStart=t.vertexOffset,t.indiceStart=t.indiceOffset,t.byteStart=t.byteOffset}}},{key:"forceMergeBatches",value:function(e,t){this._currMaterial=e,this._currTexView=t,this.autoMergeBatches()}},{key:"finishMergeBatches",value:function(){this.autoMergeBatches(),this._currMaterial=this._emptyMaterial,this._currTexView=null}},{key:"_destroyUIMaterials",value:function(){for(var e=this._uiMaterials.values(),t=e.next();!t.done;){t.value.destroy(),t=e.next()}this._uiMaterials.clear()}},{key:"_walk",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=e.children.length,n=this._parentOpacity;if(this._parentOpacity*=e._uiProps.opacity,this._preprocess(e),i>0&&!e._static)for(var r=e.children,a=0;a<r.length;++a){var s=r[a];this._walk(s,t)}this._postprocess(e),this._parentOpacity=n,t+=1}},{key:"_renderScreens",value:function(){for(var e=this._screens,t=0;t<e.length;++t){var i=e[t];i.enabledInHierarchy&&(this._currCanvas=i,this._recursiveScreenNode(i.node))}}},{key:"_preprocess",value:function(e){if(e._uiProps.uiTransformComp){e._uiProps.uiTransformComp._canvas=this._currCanvas;var t=e._uiProps.uiComp;t&&t.enabledInHierarchy&&t.updateAssembler(this)}}},{key:"_postprocess",value:function(e){var t=e._uiProps.uiComp;t&&t.enabledInHierarchy&&t.postUpdateAssembler(this)}},{key:"_recursiveScreenNode",value:function(e){this._walk(e),this.autoMergeBatches()}},{key:"_reset",value:function(){for(var e=0;e<this._batches.length;++e){var t=this._batches.array[e];t.isStatic||(t.clear(this),this._drawBatchPool.free(t))}this._parentOpacity=1,this._batches.clear(),this._currMaterial=this._emptyMaterial,this._currCanvas=null,this._currTexView=null,this._meshBufferUseCount=0,this._requireBufferBatch(),QC.sharedManager.reset()}},{key:"_createMeshBuffer",value:function(){var e=this._bufferBatchPool.add();return e.initialize(this._attributes,this._requireBufferBatch.bind(this)),this._meshBuffers.push(e),e}},{key:"_requireBufferBatch",value:function(){this._meshBufferUseCount>=this._meshBuffers.length?this._currMeshBuffer=this._createMeshBuffer():this._currMeshBuffer=this._meshBuffers[this._meshBufferUseCount],this._meshBufferUseCount++,2===arguments.length&&this._currMeshBuffer.request(arguments[0],arguments[1])}},{key:"_screenSort",value:function(e,t){var i=e.priority-t.priority;return 0===i?e.node.getSiblingIndex()-t.node.getSiblingIndex():i}},{key:"_applyOpacity",value:function(e){for(var t=e.color.a/255,i=this._parentOpacity=this._parentOpacity*t,n=this._currMeshBuffer.byteOffset>>2,r=this._currMeshBuffer.vData,a=this._currMeshBuffer.lastByteOffset>>2;a<n;a+=9)r[a+ZC.OPACITY_OFFSET]=i;this._currMeshBuffer.lastByteOffset=this._currMeshBuffer.byteOffset}}]),e}(),aR=function(){function e(t){i(this,e),this._windows=[],this._mainWindow=null,this._curWindow=null,this._tempWindow=null,this._pipeline=null,this._ui=null,this._scenes=[],this._views=[],this._modelPools=new Map,this._cameraPool=null,this._lightPools=new Map,this._directLightPool=null,this._sphereLightPool=null,this._spotLightPool=null,this._time=0,this._frameTime=0,this._fpsTime=0,this._frameCount=0,this._fps=0,this._fixedFPS=0,this._fixedFPSFrameTime=0,this._device=t,this._dataPoolMgr=new KC(t),iw.registerCreateFunc(this),KS.registerCreateFunc(this),this._cameraPool=new Za((function(){return new Fb}),4)}return r(e,[{key:"device",get:function(){return this._device}},{key:"mainWindow",get:function(){return this._mainWindow}},{key:"curWindow",set:function(e){this._curWindow=e},get:function(){return this._curWindow}},{key:"tempWindow",set:function(e){this._tempWindow=e},get:function(){return this._tempWindow}},{key:"windows",get:function(){return this._windows}},{key:"pipeline",get:function(){return this._pipeline}},{key:"ui",get:function(){return this._ui}},{key:"scenes",get:function(){return this._scenes}},{key:"views",get:function(){return this._views}},{key:"cumulativeTime",get:function(){return this._time}},{key:"frameTime",get:function(){return this._frameTime}},{key:"frameCount",get:function(){return this._frameCount}},{key:"fps",get:function(){return this._fps}},{key:"fixedFPS",set:function(e){e>0?(this._fixedFPS=e,this._fixedFPSFrameTime=1e3/e):this._fixedFPSFrameTime=0},get:function(){return this._fixedFPS}},{key:"dataPoolManager",get:function(){return this._dataPoolMgr}}]),r(e,[{key:"initialize",value:function(e){var t=this;return!!this._device.mainWindow&&(this._mainWindow=this._device.mainWindow,this._curWindow=this._mainWindow,P_.initBuiltinRes(this._device),cc.view.on("design-resolution-changed",(function(){var e=cc.game.canvas.width,i=cc.game.canvas.height;t.resize(e,i)}),this),!0)}},{key:"destroy",value:function(){this.destroyViews(),this.destroyScenes(),this._pipeline&&(this._pipeline.destroy(),this._pipeline=null),this._ui&&(this._ui.destroy(),this._ui=null),this._curWindow=null,this._mainWindow=null,this.dataPoolManager.clear()}},{key:"resize",value:function(e,t){this._device.resize(e,t),this._mainWindow.resize(e,t);var i=this._windows,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;s.isOffscreen||s.resize(e,t)}this._pipeline&&this._pipeline.resize(e,t);var o=this._views,l=Array.isArray(o),u=0;for(o=l?o:o[Symbol.iterator]();;){var c;if(l){if(u>=o.length)break;c=o[u++]}else{if((u=o.next()).done)break;c=u.value}var h=c;h.camera.isWindowSize&&h.camera.resize(e,t)}}},{key:"setRenderPipeline",value:function(e){return this._pipeline=e,!!this._pipeline.activate(this)&&(this._ui=new rR(this),!!this._ui.initialize()||(this.destroy(),!1))}},{key:"activeWindow",value:function(e){this._curWindow=e}},{key:"resetCumulativeTime",value:function(){this._time=0}},{key:"frameMove",value:function(e){this._frameTime=e,++this._frameCount,this._time+=this._frameTime,this._fpsTime+=this._frameTime,this._fpsTime>1&&(this._fps=this._frameCount,this._frameCount=0,this._fpsTime=0);for(var t=this._views,i=0;i<t.length;i++){var n=t[i];n.isEnable&&n.window&&(n.window.isOffscreen||!n.window.isOffscreen&&n.window===this._curWindow)&&this._pipeline&&this._pipeline.render(n)}}},{key:"createWindow",value:function(e){if(this._device){var t=this._device.createWindow(e);if(t)return this._windows.push(t),t}return null}},{key:"destroyWindow",value:function(e){for(var t=0;t<this._windows.length;++t)if(this._windows[t]===e)return e.destroy(),void this._windows.splice(t,1)}},{key:"destroyWindows",value:function(){var e=this._windows,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.destroy()}this._windows=[]}},{key:"createScene",value:function(e){var t=this._createSceneFun(this);return t.initialize(e),this._scenes.push(t),t}},{key:"destroyScene",value:function(e){for(var t=0;t<this._scenes.length;++t)if(this._scenes[t]===e)return e.destroy(),void this._scenes.splice(t,1)}},{key:"destroyScenes",value:function(){var e=this._scenes,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.destroy()}this._scenes=[]}},{key:"createView",value:function(e){var t=this._createViewFun(this,e.camera);return t.initialize(e),this._views.push(t),this.sortViews(),t}},{key:"destroyView",value:function(e){for(var t=0;t<this._views.length;++t)if(this._views[t]===e)return this._views.splice(t,1),void e.destroy()}},{key:"destroyViews",value:function(){var e=this._views,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.destroy()}this._views=[]}},{key:"createModel",value:function(e){var t=this._modelPools.get(e);return t||(this._modelPools.set(e,new Za((function(){return new e}),10)),t=this._modelPools.get(e)),t.alloc()}},{key:"destroyModel",value:function(e){var t=this._modelPools.get(e.constructor);t&&(t.free(e),e.destroy(),e.scene&&e.scene.removeModel(e))}},{key:"createCamera",value:function(){return this._cameraPool.alloc()}},{key:"destroyCamera",value:function(e){this._cameraPool.free(e),e.destroy(),e.scene&&e.scene.removeCamera(e)}},{key:"createLight",value:function(e){var t=this._lightPools.get(e);return t||(this._lightPools.set(e,new Za((function(){return new e}),4)),t=this._lightPools.get(e)),t.alloc()}},{key:"destroyLight",value:function(e){var t=this._lightPools.get(e.constructor);if(e.destroy(),t&&(t.free(e),e.scene))switch(e.type){case YS.SPHERE:e.scene.removeSphereLight(e);break;case YS.SPOT:e.scene.removeSpotLight(e)}}},{key:"sortViews",value:function(){this._views.sort((function(e,t){return e.priority-t.priority}))}}]),e}(),sR=e("Director",function(e){function t(){var e;return i(this,t),(e=c(this,o(t).call(this)))._invalid=!1,e._paused=!1,e._purgeDirectorInNextLoop=!1,e._root=null,e._loadingScene="",e._scene=null,e._totalFrames=0,e._lastUpdate=0,e._deltaTime=0,e._scheduler=new qC,e._compScheduler=new fE,e._nodeActivator=new MT,e._systems=[],cc.game.on(Nx.EVENT_SHOW,(function(){e._lastUpdate=performance.now()})),cc.game.once(Nx.EVENT_RENDERER_INITED,e._initOnRendererInitialized,u(e)),cc.game.once(Nx.EVENT_ENGINE_INITED,e._initOnEngineInitialized,u(e)),e}return s(t,e),r(t,[{key:"calculateDeltaTime",value:function(){var e=performance.now();this._deltaTime=(e-this._lastUpdate)/1e3,this._lastUpdate=e}},{key:"convertToGL",value:function(e){var t=cc.game.container,i=cc.view,n=t.getBoundingClientRect(),r=n.left+window.pageXOffset-t.clientLeft,a=n.top+window.pageYOffset-t.clientTop,s=i._devicePixelRatio*(e.x-r),o=i._devicePixelRatio*(a+n.height-e.y);return i._isRotated?Bi(i._viewportRect.width-o,s):Bi(s,o)}},{key:"convertToUI",value:function(e){var t=cc.game.container,i=cc.view,n=t.getBoundingClientRect(),r=n.left+window.pageXOffset-t.clientLeft,a=n.top+window.pageYOffset-t.clientTop,s=Bi(0,0);return i._isRotated?(s.x=r+e.y/i._devicePixelRatio,s.y=a+n.height-(i._viewportRect.width-e.x)/i._devicePixelRatio):(s.x=r+e.x*i._devicePixelRatio,s.y=a+n.height-e.y*i._devicePixelRatio),s}},{key:"end",value:function(){this._purgeDirectorInNextLoop=!0}},{key:"getWinSize",value:function(){return qn(cc.winSize)}},{key:"getWinSizeInPixels",value:function(){return qn(cc.winSize)}},{key:"pause",value:function(){this._paused||(this._paused=!0)}},{key:"purgeCachedData",value:function(){cc.loader.releaseAll()}},{key:"purgeDirector",value:function(){this._scheduler.unscheduleAll(),this._compScheduler.unscheduleAll(),this._nodeActivator.reset(),ph&&ph.setEnabled(!1),cc.isValid(this._scene)&&this._scene.destroy(),this._scene=null,this.stopAnimation(),null!=this._root&&this._root.destroy(),this._root=null,cc.loader.releaseAll()}},{key:"reset",value:function(){this.purgeDirector(),this.emit(t.EVENT_RESET),ph&&ph.setEnabled(!0),this.startAnimation()}},{key:"runSceneImmediate",value:function(e,t,i){cc.assertID(e instanceof cc.Scene,1216);var n=cc.loader._getReferenceKey(e.uuid);cc.loader.removeItem(n),e._load();for(var r=Object.keys(cc.game._persistRootNodes).map((function(e){return cc.game._persistRootNodes[e]})),a=0;a<r.length;a++){var s=r[a];s.emit(cc.Node.SCENE_CHANGED_FOR_PERSISTS,e.renderScene);var o=e.getChildByUuid(s.uuid);if(o){var l=o.getSiblingIndex();o._destroyImmediate(),e.insertChild(s,l)}else s.parent=e}var u=this._scene;!function(e,t,i){var n=cc.loader._autoReleaseSetting,r=we();if(t)for(var a=0;a<t.length;a++)r[t[a]]=!0;for(var s=0;s<i.length;s++)Tv(i[s],r);if(e)for(var o=0;o<e.length;o++){var l=e[o];!1===n[l]||r[l]||cc.loader.release(l)}for(var u=Object.keys(n),c=0;c<u.length;c++){var h=u[c];!0!==n[h]||r[h]||cc.loader.release(h)}}(u&&u.autoReleaseAssets&&u.dependAssets,e.dependAssets,r),cc.isValid(u)&&u.destroy(),this._scene=null,hl._deferredDestroy(),t&&t(),this.emit(cc.Director.EVENT_BEFORE_SCENE_LAUNCH,e),this._scene=e,e._activate(),this._root&&this._root.resetCumulativeTime(),this.startAnimation(),i&&i(null,e),this.emit(cc.Director.EVENT_AFTER_SCENE_LAUNCH,e)}},{key:"runScene",value:function(e,t,i){var n=this;cc.assertID(e,1205),cc.assertID(e instanceof cc.Scene,1216),e._load(),this.once(cc.Director.EVENT_AFTER_UPDATE,(function(){n.runSceneImmediate(e,t,i)}))}},{key:"_getSceneUuid",value:function(e){var t=cc.game._sceneInfos;if("string"==typeof e){e.endsWith(".scene")||(e+=".scene"),"/"===e[0]||e.startsWith("db://")||(e="/"+e);for(var i=0;i<t.length;i++){var n=t[i];if(n.url.endsWith(e))return n}}else if("number"==typeof e){if(0<=e&&e<t.length)return t[e];cc.errorID(1206,e)}else cc.errorID(1207,e);return null}},{key:"loadScene",value:function(e,t,i){if(this._loadingScene)return cc.errorID(1208,e,this._loadingScene),!1;var n=this._getSceneUuid(e);if(n){var r=n.uuid;return this.emit(cc.Director.EVENT_BEFORE_SCENE_LOADING,e),this._loadingScene=e,this._loadSceneByUuid(r,t,i),!0}return cc.errorID(1209,e),!1}},{key:"preloadScene",value:function(e,t,i){var n,r;void 0===i?(r=t,n=void 0):(r=i,n=t);var a=this._getSceneUuid(e);if(a)this.emit(cc.Director.EVENT_BEFORE_SCENE_LOADING,e),cc.loader.load({uuid:a.uuid,type:"uuid"},n,(function(t,i){t&&cc.errorID(1210,e,t.message),r&&r(t,i)}));else{var s='Can not preload the scene "'+e+'" because it is not in the build settings.';r&&r(new Error(s)),cc.error("preloadScene: "+s)}}},{key:"_loadSceneByUuid",value:function(e,t,i,n){var r,a;r=t,a=i,console.time("LoadScene "+e),cc.AssetLibrary.loadAsset(e,(function(t,i){console.timeEnd("LoadScene "+e);var n=vR;if(n._loadingScene="",t)t="Failed to load scene: "+t,cc.error(t);else{if(i instanceof cc.SceneAsset){var s=i.scene;return s._id=i._uuid,s._name=i._name,void n.runSceneImmediate(s,a,r)}t="The asset "+e+" is not a scene",cc.error(t)}r&&r(t)}))}},{key:"resume",value:function(){this._paused&&(this._lastUpdate=performance.now(),this._lastUpdate||cc.logID(1200),this._paused=!1,this._deltaTime=0)}},{key:"setDepthTest",value:function(e){cc.Camera.main&&(cc.Camera.main.depth=!!e)}},{key:"setClearColor",value:function(e){cc.Camera.main&&(cc.Camera.main.backgroundColor=e)}},{key:"getRunningScene",value:function(){return this._scene}},{key:"getScene",value:function(){return this._scene}},{key:"getAnimationInterval",value:function(){return 1e3/cc.game.getFrameRate()}},{key:"setAnimationInterval",value:function(e){cc.game.setFrameRate(Math.round(1e3/e))}},{key:"getDeltaTime",value:function(){return this._deltaTime}},{key:"getCurrentTime",value:function(){return this._lastUpdate}},{key:"getTotalFrames",value:function(){return this._totalFrames}},{key:"isPaused",value:function(){return this._paused}},{key:"getScheduler",value:function(){return this._scheduler}},{key:"setScheduler",value:function(e){this._scheduler!==e&&(this.unregisterSystem(this._scheduler),this._scheduler=e,this.registerSystem(qC.ID,e,200))}},{key:"registerSystem",value:function(e,t,i){t.id=e,t.priority=i,t.init(),this._systems.push(t),this._systems.sort(GC.sortByPriority)}},{key:"unregisterSystem",value:function(e){Qe.fastRemove(this._systems,e),this._systems.sort(GC.sortByPriority)}},{key:"getSystem",value:function(e){return this._systems.find((function(t){return t.id===e}))}},{key:"getAnimationManager",value:function(){return this.getSystem(cc.AnimationManager.ID)}},{key:"startAnimation",value:function(){this._invalid=!1,this._lastUpdate=performance.now()}},{key:"stopAnimation",value:function(){this._invalid=!0}},{key:"mainLoop",value:function(e){if(this._purgeDirectorInNextLoop)this._purgeDirectorInNextLoop=!1,this.purgeDirector();else if(!this._invalid){this.calculateDeltaTime();var i=this._deltaTime;if(!this._paused){this.emit(t.EVENT_BEFORE_UPDATE),this._compScheduler.startPhase(),this._compScheduler.updatePhase(i);for(var n=0;n<this._systems.length;++n)this._systems[n].update(i);this._compScheduler.lateUpdatePhase(i),this.emit(t.EVENT_AFTER_UPDATE),hl._deferredDestroy();for(var r=0;r<this._systems.length;++r)this._systems[r].postUpdate(i)}this.emit(t.EVENT_BEFORE_DRAW),this._root.frameMove(this._deltaTime),this._root.device.present(),this.emit(t.EVENT_AFTER_DRAW),ph.frameUpdateListeners(),o_.bookOfChange.clear(),this._totalFrames++}}},{key:"_initOnRendererInitialized",value:function(){this._totalFrames=0,this._lastUpdate=performance.now(),this._paused=!1,this._purgeDirectorInNextLoop=!1,ph&&ph.setEnabled(!0),this.registerSystem(qC.ID,this._scheduler,200),this.emit(t.EVENT_INIT)}},{key:"_initOnEngineInitialized",value:function(){cc.loader.init(this),this._root=new aR(cc.game._gfxDevice);return!!this._root.initialize({})}},{key:"root",get:function(){return this._root}}]),t}(ol));sR.EVENT_INIT="director_init",sR.EVENT_RESET="director_reset",sR.EVENT_BEFORE_SCENE_LOADING="director_before_scene_loading",sR.EVENT_BEFORE_SCENE_LAUNCH="director_before_scene_launch",sR.EVENT_AFTER_SCENE_LAUNCH="director_after_scene_launch",sR.EVENT_BEFORE_UPDATE="director_before_update",sR.EVENT_AFTER_UPDATE="director_after_update",sR.EVENT_BEFORE_DRAW="director_before_draw",sR.EVENT_AFTER_DRAW="director_after_draw",sR.EVENT_BEFORE_PHYSICS="director_before_physics",sR.EVENT_AFTER_PHYSICS="director_after_physics",cc.Director=sR;var oR,lR,uR,cR,hR,fR,_R,dR,pR,mR,vR=e("director",sR.instance=cc.director=new sR),gR=e("EventHandler",(oR=Es("cc.ClickEvent"),lR=Ts(cc.Node),oR((v((cR=function(){function e(){i(this,e),m(this,"target",hR,this),m(this,"component",fR,this),m(this,"_componentId",_R,this),m(this,"handler",dR,this),m(this,"customEventData",pR,this)}return r(e,[{key:"emit",value:function(e){var t=this.target;if(cc.isValid(t)){this._genCompIdIfNeeded();var i=cc.js._getClassById(this._componentId),n=t.getComponent(i);if(cc.isValid(n)){var r=n[this.handler];"function"==typeof r&&(null!=this.customEventData&&""!==this.customEventData&&(e=e.slice()).push(this.customEventData),r.apply(n,e))}}}},{key:"_compName2Id",value:function(e){var t=cc.js.getClassByName(e);return cc.js._getClassId(t)}},{key:"_compId2Name",value:function(e){var t=cc.js._getClassById(e);return cc.js.getClassName(t)}},{key:"_genCompIdIfNeeded",value:function(){this._componentId||(this._componentName=this.component,this.component="")}},{key:"_componentName",get:function(){return this._genCompIdIfNeeded(),this._compId2Name(this._componentId)},set:function(e){this._componentId=this._compName2Id(e)}}],[{key:"emitEvents",value:function(t){for(var i=arguments.length,n=new Array(i>1?i-1:0),r=1;r<i;r++)n[r-1]=arguments[r];for(var a=0,s=t.length;a<s;a++){var o=t[a];o instanceof e&&o.emit(n)}}}]),e}()).prototype,"_componentName",[Ts],Object.getOwnPropertyDescriptor(cR.prototype,"_componentName"),cR.prototype),hR=v(cR.prototype,"target",[lR],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),fR=v(cR.prototype,"component",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),_R=v(cR.prototype,"_componentId",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),dR=v(cR.prototype,"handler",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),pR=v(cR.prototype,"customEventData",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),uR=cR))||uR));cc.Component.EventHandler=gR;var yR=[Kc.TOUCH_START,Kc.TOUCH_END,Kc.TOUCH_MOVE,Kc.MOUSE_DOWN,Kc.MOUSE_MOVE,Kc.MOUSE_UP,Kc.MOUSE_ENTER,Kc.MOUSE_LEAVE,Kc.MOUSE_WHEEL];function bR(e){e.propagationStopped=!0}var ER,TR,SR,xR,AR,wR,CR,RR,kR,OR,IR,MR,LR,PR,BR,DR,FR,NR,zR,UR,GR,VR,HR,WR,jR,XR,qR,YR,KR,ZR,QR,JR,$R,ek,tk=e("BlockInputEventsComponent",Es("cc.BlockInputEventsComponent")(mR=Cs("Components/BlockInputEvents")(mR=function(e){function t(){return i(this,t),c(this,o(t).apply(this,arguments))}return s(t,e),r(t,[{key:"onEnable",value:function(){for(var e=0;e<yR.length;e++)this.node.on(yR[e],bR,this)}},{key:"onDisable",value:function(){for(var e=0;e<yR.length;e++)this.node.off(yR[e],bR,this)}}]),t}(Ph))||mR)||mR);cc.BlockInputEventsComponent=tk;var ik,nk,rk,ak,sk,ok,lk,uk,ck,hk,fk,_k,dk,pk,mk,vk,gk,yk,bk,Ek,Tk,Sk,xk,Ak,wk,Ck,Rk,kk,Ok,Ik=new zi,Mk=dt({ORTHO:0,PERSPECTIVE:1}),Lk=dt({SKYBOX:Db|Bo.DEPTH_STENCIL,SOLID_COLOR:Bo.ALL,DEPTH_ONLY:Bo.DEPTH_STENCIL,DONT_CLEAR:Bo.NONE}),Pk=e("CameraComponent",(ER=Es("cc.CameraComponent"),TR=Cs("Components/Camera"),SR=Ts({type:Mk,tooltip:""}),xR=Ts({tooltip:""}),AR=Ts({tooltip:""}),wR=Ts({tooltip:""}),CR=Ts({tooltip:""}),RR=Ts({tooltip:""}),kR=Ts({tooltip:""}),OR=Ts({tooltip:""}),IR=Ts({tooltip:""}),MR=Ts({type:Lk,tooltip:""}),LR=Ts({tooltip:" viewport"}),PR=Ts({visible:!1}),BR=Ts({type:du.BitMask,tooltip:" Component  visibility "}),DR=Ts({type:Oc,tooltip:" RenderTexture"}),ER(FR=TR(FR=As((ek=$R=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),s=0;s<r;s++)a[s]=arguments[s];return m(n=c(this,(e=o(t)).call.apply(e,[this].concat(a))),"_projection",zR,u(n)),m(n,"_priority",UR,u(n)),m(n,"_fov",GR,u(n)),m(n,"_orthoHeight",VR,u(n)),m(n,"_near",HR,u(n)),m(n,"_far",WR,u(n)),m(n,"_color",jR,u(n)),m(n,"_depth",XR,u(n)),m(n,"_stencil",qR,u(n)),m(n,"_clearFlags",YR,u(n)),m(n,"_rect",KR,u(n)),m(n,"_screenScale",ZR,u(n)),m(n,"_visibility",QR,u(n)),m(n,"_targetTexture",JR,u(n)),n._camera=null,n._inEditorMode=!1,n._flows=void 0,n}return s(t,e),r(t,[{key:"onLoad",value:function(){cc.director.on(cc.Director.EVENT_AFTER_SCENE_LAUNCH,this.onSceneChanged,this),this._createCamera()}},{key:"onEnable",value:function(){this._camera&&this._attachToScene()}},{key:"onDisable",value:function(){this._camera&&this._detachFromScene()}},{key:"onDestroy",value:function(){this._camera&&(cc.director.root.destroyCamera(this._camera),this._camera=null),this._targetTexture&&this._targetTexture.off("resize")}},{key:"screenPointToRay",value:function(e,t,i){return i||(i=Cr.create()),this._camera&&this._camera.screenPointToRay(i,e,t),i}},{key:"worldToScreen",value:function(e,t){return t||(t=new zi),this._camera&&this._camera.worldToScreen(t,e),t}},{key:"screenToWorld",value:function(e,t){return t||(t=this.node.getWorldPosition()),this._camera&&this._camera.screenToWorld(t,e),t}},{key:"convertToUINode",value:function(e,t,i){if(i||(i=new zi),!this._camera)return i;this.worldToScreen(e,Ik);var n=t.getComponent("cc.UITransformComponent"),r=qx.getVisibleSize(),a=Ik.x-.5*this._camera.width,s=Ik.y-.5*this._camera.height;return Ik.x=a/cc.view.getScaleX()+.5*r.width,Ik.y=s/cc.view.getScaleY()+.5*r.height,n&&n.convertToNodeSpaceAR(Ik,i),i}},{key:"_createCamera",value:function(){if(this._camera=cc.director.root.createCamera(),this._camera.initialize({name:this.node.name,node:this.node,projection:this._projection,window:this._inEditorMode?cc.director.root&&cc.director.root.mainWindow:cc.director.root&&cc.director.root.tempWindow,priority:this._priority,flows:this._flows}),this._camera){this._camera.viewport=this._rect,this._camera.fov=mi(this._fov),this._camera.orthoHeight=this._orthoHeight,this._camera.nearClip=this._near,this._camera.farClip=this._far;var e=this._color.x,t=this._color.y,i=this._color.z,n=this._color.w;this._camera.clearColor={r:e,g:t,b:i,a:n},this._camera.clearDepth=this._depth,this._camera.clearStencil=this._stencil,this._camera.clearFlag=this._clearFlags,this._camera.visibility=this._visibility}this._updateTargetTexture()}},{key:"_attachToScene",value:function(){this.node.scene&&this._camera&&(this._camera&&this._camera.scene&&this._camera.scene.removeCamera(this._camera),this._getRenderScene().addCamera(this._camera))}},{key:"_detachFromScene",value:function(){this._camera&&this._camera.scene&&this._camera.scene.removeCamera(this._camera)}},{key:"onSceneChanged",value:function(e){this._camera&&null==this._camera.scene&&this._attachToScene()}},{key:"_chechTargetTextureEvent",value:function(e){var t=this;e&&e.off("resize"),this._targetTexture&&this._targetTexture.on("resize",(function(e){t._camera&&t._camera.setFixedSize(e.width,e.height)}),this)}},{key:"_updateTargetTexture",value:function(){if(this._camera&&this._targetTexture){var e=this._targetTexture.getGFXWindow();this._camera.changeTargetWindow(e),this._camera.setFixedSize(e.width,e.height)}}},{key:"camera",get:function(){return this._camera}},{key:"projection",get:function(){return this._projection},set:function(e){this._projection=e,this._camera&&(this._camera.projectionType=e)}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e,this._camera&&(this._camera.priority=e)}},{key:"fov",get:function(){return this._fov},set:function(e){this._fov=e,this._camera&&(this._camera.fov=mi(e))}},{key:"orthoHeight",get:function(){return this._orthoHeight},set:function(e){this._orthoHeight=e,this._camera&&(this._camera.orthoHeight=e)}},{key:"near",get:function(){return this._near},set:function(e){this._near=e,this._camera&&(this._camera.nearClip=e)}},{key:"far",get:function(){return this._far},set:function(e){this._far=e,this._camera&&(this._camera.farClip=e)}},{key:"color",get:function(){return this._color},set:function(e){this._color.set(e),this._camera&&(this._camera.clearColor.r=e.x,this._camera.clearColor.g=e.y,this._camera.clearColor.b=e.z,this._camera.clearColor.a=e.w)}},{key:"depth",get:function(){return this._depth},set:function(e){this._depth=e,this._camera&&(this._camera.clearDepth=e)}},{key:"stencil",get:function(){return this._stencil},set:function(e){this._stencil=e,this._camera&&(this._camera.clearStencil=e)}},{key:"clearFlags",get:function(){return this._clearFlags},set:function(e){this._clearFlags=e,this._camera&&(this._camera.clearFlag=e)}},{key:"rect",get:function(){return this._rect},set:function(e){this._rect=e,this._camera&&(this._camera.viewport=e)}},{key:"screenScale",get:function(){return this._screenScale},set:function(e){this._screenScale=e,this._camera&&(this._camera.screenScale=e)}},{key:"visibility",get:function(){return this._visibility},set:function(e){this._visibility=e,this._camera&&(this._camera.visibility=e)}},{key:"targetTexture",get:function(){return this._targetTexture},set:function(e){if(this._targetTexture!==e){var t=this._targetTexture;this._targetTexture=e,this._chechTargetTextureEvent(t),this._updateTargetTexture(),!e&&this._camera&&(this._camera.changeTargetWindow(null),this._camera.isWindowSize=!0)}}},{key:"inEditorMode",get:function(){return this._inEditorMode},set:function(e){this._inEditorMode=e,this._camera&&this._camera.changeTargetWindow(e?cc.director.root&&cc.director.root.mainWindow:cc.director.root&&cc.director.root.tempWindow)}},{key:"flows",set:function(e){this._camera&&(this._camera.flows=e),this._flows=e}}]),t}(Ph),$R.ProjectionType=Mk,$R.CameraClearFlag=Lk,zR=v((NR=ek).prototype,"_projection",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Mk.PERSPECTIVE}}),UR=v(NR.prototype,"_priority",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),GR=v(NR.prototype,"_fov",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 45}}),VR=v(NR.prototype,"_orthoHeight",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),HR=v(NR.prototype,"_near",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),WR=v(NR.prototype,"_far",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),jR=v(NR.prototype,"_color",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rr("#334C78")}}),XR=v(NR.prototype,"_depth",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),qR=v(NR.prototype,"_stencil",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),YR=v(NR.prototype,"_clearFlags",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Lk.SOLID_COLOR}}),KR=v(NR.prototype,"_rect",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Jn(0,0,1,1)}}),ZR=v(NR.prototype,"_screenScale",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),QR=v(NR.prototype,"_visibility",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ku}}),JR=v(NR.prototype,"_targetTexture",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),v(NR.prototype,"projection",[SR],Object.getOwnPropertyDescriptor(NR.prototype,"projection"),NR.prototype),v(NR.prototype,"priority",[xR],Object.getOwnPropertyDescriptor(NR.prototype,"priority"),NR.prototype),v(NR.prototype,"fov",[AR],Object.getOwnPropertyDescriptor(NR.prototype,"fov"),NR.prototype),v(NR.prototype,"orthoHeight",[wR],Object.getOwnPropertyDescriptor(NR.prototype,"orthoHeight"),NR.prototype),v(NR.prototype,"near",[CR],Object.getOwnPropertyDescriptor(NR.prototype,"near"),NR.prototype),v(NR.prototype,"far",[RR],Object.getOwnPropertyDescriptor(NR.prototype,"far"),NR.prototype),v(NR.prototype,"color",[kR],Object.getOwnPropertyDescriptor(NR.prototype,"color"),NR.prototype),v(NR.prototype,"depth",[OR],Object.getOwnPropertyDescriptor(NR.prototype,"depth"),NR.prototype),v(NR.prototype,"stencil",[IR],Object.getOwnPropertyDescriptor(NR.prototype,"stencil"),NR.prototype),v(NR.prototype,"clearFlags",[MR],Object.getOwnPropertyDescriptor(NR.prototype,"clearFlags"),NR.prototype),v(NR.prototype,"rect",[LR],Object.getOwnPropertyDescriptor(NR.prototype,"rect"),NR.prototype),v(NR.prototype,"screenScale",[PR],Object.getOwnPropertyDescriptor(NR.prototype,"screenScale"),NR.prototype),v(NR.prototype,"visibility",[BR],Object.getOwnPropertyDescriptor(NR.prototype,"visibility"),NR.prototype),v(NR.prototype,"targetTexture",[DR],Object.getOwnPropertyDescriptor(NR.prototype,"targetTexture"),NR.prototype),FR=NR))||FR)||FR)||FR)),Bk=new zi,Dk=dt({SOLID_COLOR:Bo.ALL,DEPTH_STENCIL:Bo.DEPTH_STENCIL,NONE:Bo.NONE}),Fk=dt({OVERLAY:0,INTERSPERSE:1}),Nk=e("CanvasComponent",(ik=Es("cc.CanvasComponent"),nk=Rs(100),rk=ws(Lf),ak=Cs("UI/Canvas"),sk=Ts({type:Dk,tooltip:""}),ok=Ts({tooltip:""}),lk=Ts({type:Fk,tooltip:"Canvas intersperse  Canvas overlay  Canvas \n intersperse  3D  Canvas  clearFlags  none"}),uk=Ts({tooltip:" RenderMode  intersperse  RenderMode  overlay  Canvas  Canvas  priority "}),ck=Ts({type:Oc,tooltip:""}),hk=Ts({type:Dk}),fk=Ts({type:Fk}),ik(_k=nk(_k=rk(_k=ak(_k=As(_k=ks((v((dk=function(e){function t(){var e;return i(this,t),m(e=c(this,o(t).call(this)),"_priority",pk,u(e)),m(e,"_targetTexture",mk,u(e)),m(e,"_clearFlag",vk,u(e)),m(e,"_color",gk,u(e)),m(e,"_renderMode",yk,u(e)),e._camera=null,e._pos=new zi,e._thisOnResized=e.alignWithScreen.bind(u(e)),e}return s(t,e),r(t,[{key:"clearFlag",get:function(){return this._clearFlag},set:function(e){this._clearFlag=e,this._camera&&(this._camera.clearFlag=this._clearFlag)}},{key:"color",get:function(){return this._color},set:function(e){rr.copy(this._color,e),this._camera&&(this._camera.clearColor.r=e.r/255,this._camera.clearColor.g=e.g/255,this._camera.clearColor.b=e.b/255,this._camera.clearColor.a=e.a/255)}},{key:"renderMode",get:function(){return this._renderMode},set:function(e){this._renderMode=e,this._camera&&(this._camera.priority=this._getViewPriority())}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e,this._camera&&(this._camera.priority=this._getViewPriority()),vR.root&&vR.root.ui&&vR.root.ui.sortScreens()}},{key:"targetTexture",get:function(){return this._targetTexture},set:function(e){if(this._targetTexture!==e){var t=this._targetTexture;this._targetTexture=e,this._checkTargetTextureEvent(t),this._updateTargetTexture()}}},{key:"visibility",get:function(){return this._camera?this._camera.view.visibility:-1}},{key:"camera",get:function(){return this._camera}}]),r(t,[{key:"__preload",value:function(){var e=new o_("UICamera_"+this.node.name);if(e.setPosition(0,0,1e3),this._camera=vR.root.createCamera(),this._camera.initialize({name:"ui_"+this.node.name,node:e,projection:Pk.ProjectionType.ORTHO,priority:this._getViewPriority(),flows:["UIFlow"]}),this._camera.fov=45,this._camera.clearFlag=this.clearFlag,this._camera.farClip=2e3,this._camera.viewport=new Jn(0,0,1,1),this.color=this._color,this._targetTexture){var t=this._targetTexture.getGFXWindow();this._camera.changeTargetWindow(t)}qx.on("design-resolution-changed",this._thisOnResized),this.alignWithScreen(),vR.root.ui.addScreen(this)}},{key:"onEnable",value:function(){this._camera&&vR.root.ui.renderScene.addCamera(this._camera)}},{key:"onDisable",value:function(){this._camera&&vR.root.ui.renderScene.removeCamera(this._camera)}},{key:"onDestroy",value:function(){vR.root.ui.removeScreen(this),this._camera&&vR.root.destroyCamera(this._camera),this._targetTexture&&this._targetTexture.off("resize"),qx.off("design-resolution-changed",this._thisOnResized)}},{key:"alignWithScreen",value:function(){var e,t;this.node.getPosition(this._pos);var i=qS;e=i,t=qx.getDesignResolutionSize();var n=0,r=0;qx.getResolutionPolicy()===Xx.NO_BORDER&&(n=.5*(t.width-i.width),r=.5*(t.height-i.height)),zi.set(Bk,.5*i.width+n,.5*i.height+r,0),this._pos.equals(Bk)||this.node.setPosition(Bk),this.node.width!==e.width&&(this.node.width=e.width),this.node.height!==e.height&&(this.node.height=e.height),this.node.getWorldPosition(Bk);var a=this._camera;if(a){if(this._targetTexture)a.setFixedSize(i.width,i.height),a.orthoHeight=i.height/2;else{var s=zx.canvas;a.resize(s.width,s.height),a.orthoHeight=zx.canvas.height/qx.getScaleY()/2}a.node.setPosition(Bk.x,Bk.y,1e3),a.update()}}},{key:"_checkTargetTextureEvent",value:function(e){var t=this;e&&e.off("resize"),this._targetTexture&&this._targetTexture.on("resize",(function(e){t._camera&&t._camera.setFixedSize(e.width,e.height)}),this)}},{key:"_updateTargetTexture",value:function(){if(this._camera){var e=this._camera;if(this._targetTexture){var t=this._targetTexture.getGFXWindow();e.changeTargetWindow(t),e.orthoHeight=qS.height/2,e.isWindowSize=!1}else e.changeTargetWindow(),e.orthoHeight=zx.canvas.height/qx.getScaleY()/2,e.isWindowSize=!0}}},{key:"_getViewPriority",value:function(){return this._renderMode===Fk.OVERLAY?this._priority|1<<30:this._priority}}]),t}(Ph)).prototype,"clearFlag",[sk],Object.getOwnPropertyDescriptor(dk.prototype,"clearFlag"),dk.prototype),v(dk.prototype,"color",[ok],Object.getOwnPropertyDescriptor(dk.prototype,"color"),dk.prototype),v(dk.prototype,"renderMode",[lk],Object.getOwnPropertyDescriptor(dk.prototype,"renderMode"),dk.prototype),v(dk.prototype,"priority",[uk],Object.getOwnPropertyDescriptor(dk.prototype,"priority"),dk.prototype),v(dk.prototype,"targetTexture",[ck],Object.getOwnPropertyDescriptor(dk.prototype,"targetTexture"),dk.prototype),pk=v(dk.prototype,"_priority",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),mk=v(dk.prototype,"_targetTexture",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),vk=v(dk.prototype,"_clearFlag",[hk],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Dk.NONE}}),gk=v(dk.prototype,"_color",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rr(0,0,0,0)}}),yk=v(dk.prototype,"_renderMode",[fk],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Fk.OVERLAY}}),_k=dk))||_k)||_k)||_k)||_k)||_k)||_k));cc.CanvasComponent=Nk,or(Jw.prototype,"UIComponent",[{name:"_visibility"},{name:"setVisibility"}]);var zk,Uk,Gk,Vk,Hk,Wk,jk,Xk,qk,Yk,Kk,Zk,Qk,Jk,$k,eO,tO,iO,nO,rO,aO,sO,oO,lO,uO,cO,hO,fO,_O,dO,pO,mO,vO,gO,yO,bO,EO,TO,SO,xO,AO,wO,CO,RO,kO,OO,IO,MO,LO,PO,BO,DO,FO,NO,zO,UO,GO,VO,HO,WO,jO,XO,qO,YO,KO,ZO,QO,JO,$O,eI,tI,iI,nI,rI,aI,sI,oI,lI,uI,cI,hI,fI,_I,dI,pI,mI,vI=e("SkinningModelComponent",(bk=Es("cc.SkinningModelComponent"),Ek=Rs(100),Tk=Cs("Components/SkinningModel"),Sk=Ts(Wy),xk=Ts(o_),Ak=Ts({type:Wy}),wk=Ts({type:o_}),bk(Ck=Ek(Ck=As(Ck=Tk((kk=v((Rk=function(e){function t(){var e;return i(this,t),m(e=c(this,o(t).call(this)),"_skeleton",kk,u(e)),m(e,"_skinningRoot",Ok,u(e)),e._clip=null,e._modelType=pA,e}return s(t,e),r(t,[{key:"skeleton",get:function(){return this._skeleton},set:function(e){this._skeleton=e,this._update()}},{key:"skinningRoot",get:function(){return this._skinningRoot},set:function(e){this._skinningRoot=e,this._update()}},{key:"model",get:function(){return this._model}}]),r(t,[{key:"uploadAnimation",value:function(e){this._clip=e,this._model&&this._model.uploadAnimation(e)}},{key:"_updateModelParams",value:function(){this._update(),f(o(t.prototype),"_updateModelParams",this).call(this)}},{key:"_getBuiltinMaterial",value:function(){return P_.get("missing-skinning-material")}},{key:"_update",value:function(){if(this._model){var e=this._model;e.bindSkeleton(this._skeleton,this._skinningRoot,this._mesh),e.uploadAnimation(this._clip)}}}]),t}(Rp)).prototype,"_skeleton",[Sk],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ok=v(Rk.prototype,"_skinningRoot",[xk],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),v(Rk.prototype,"skeleton",[Ak],Object.getOwnPropertyDescriptor(Rk.prototype,"skeleton"),Rk.prototype),v(Rk.prototype,"skinningRoot",[wk],Object.getOwnPropertyDescriptor(Rk.prototype,"skinningRoot"),Rk.prototype),Ck=Rk))||Ck)||Ck)||Ck)||Ck)),gI={name:to.ATTR_BATCH_ID,format:no.R32F,isNormalized:!1},yI={name:to.ATTR_BATCH_UV,format:no.RG32F,isNormalized:!1},bI=Go[gI.format].size+Go[yI.format].size,EI=e("SkinningModelUnit",(zk=Es("cc.SkinningModelUnit"),Uk=Ts(su),Gk=Ts(Wy),Vk=Ts(np),Hk=Ts({type:vI}),zk((Xk=v((jk=function(){function e(){i(this,e),m(this,"mesh",Xk,this),m(this,"skeleton",qk,this),m(this,"material",Yk,this),m(this,"_offset",Kk,this),m(this,"_size",Zk,this)}return r(e,[{key:"offset",set:function(e){Mi.copy(this._offset,e)},get:function(){return this._offset}},{key:"size",set:function(e){Mi.copy(this._size,e)},get:function(){return this._size}},{key:"copyFrom",set:function(e){e&&(this.mesh=e.mesh,this.skeleton=e.skeleton,this.material=e.getMaterial(0))},get:function(){return null}}]),e}()).prototype,"mesh",[Uk],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),qk=v(jk.prototype,"skeleton",[Gk],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Yk=v(jk.prototype,"material",[Vk],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Kk=v(jk.prototype,"_offset",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Mi(0,0)}}),Zk=v(jk.prototype,"_size",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Mi(1,1)}}),v(jk.prototype,"offset",[Ts],Object.getOwnPropertyDescriptor(jk.prototype,"offset"),jk.prototype),v(jk.prototype,"size",[Ts],Object.getOwnPropertyDescriptor(jk.prototype,"size"),jk.prototype),v(jk.prototype,"copyFrom",[Hk],Object.getOwnPropertyDescriptor(jk.prototype,"copyFrom"),jk.prototype),Wk=jk))||Wk)),TI=e("BatchedSkinningModelComponent",(Qk=Es("cc.BatchedSkinningModelComponent"),Jk=Rs(100),$k=Cs("Components/BatchedSkinningModel"),eO=Ts({tooltip:""}),tO=Ts({type:[Ct],tooltip:" unit "}),iO=Ts({type:[EI],tooltip:""}),nO=Ts({override:!0,visible:!1}),rO=Ts({override:!0,visible:!1}),Qk(aO=Jk(aO=As(aO=$k((oO=v((sO=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),s=0;s<r;s++)a[s]=arguments[s];return m(n=c(this,(e=o(t)).call.apply(e,[this].concat(a))),"atlasSize",oO,u(n)),m(n,"batchableTextureNames",lO,u(n)),m(n,"units",uO,u(n)),n._textures={},n._batchMaterial=null,n}return s(t,e),r(t,[{key:"onLoad",value:function(){f(o(t.prototype),"onLoad",this).call(this),this.cook()}},{key:"onDestroy",value:function(){for(var e=0,i=Object.keys(this._textures);e<i.length;e++){var n=i[e];this._textures[n].destroy()}this._textures={},this._mesh&&(this._mesh.destroy(),this._mesh=null),f(o(t.prototype),"onDestroy",this).call(this)}},{key:"_onMaterialModified",value:function(e,i){this.cookMaterials(),f(o(t.prototype),"_onMaterialModified",this).call(this,e,this.getMaterial(e))}},{key:"cook",value:function(){this.cookMaterials(),this.cookSkeletons(),this.cookMeshes()}},{key:"cookMaterials",value:function(){var e=this;this._batchMaterial||(this._batchMaterial=this.getMaterial(0));var t=this.getMaterial(0);if(t&&this._batchMaterial&&this._batchMaterial.effectAsset){t.copy(this._batchMaterial),this.resizeAtlases();for(var i=t.effectAsset.techniques[t.technique],n=function(n){var r=i.passes[n];if(!r.properties)return"continue";for(var a=function(){var i=o[s];if(r.properties[i].type>=io.SAMPLER1D){var a=null;e.batchableTextureNames.find((function(e){return e===i}))?((a=e._textures[i])||(a=e.createTexture(i)),e.cookTextures(a,i,n)):e.units.some((function(e){return a=e.material&&e.material.getProperty(i,n)})),a&&t.setProperty(i,a,n)}else{var l=[],u=e.units,c=Array.isArray(u),h=0;for(u=c?u:u[Symbol.iterator]();;){var f;if(c){if(h>=u.length)break;f=u[h++]}else{if((h=u.next()).done)break;f=h.value}var _=f;_.material&&l.push(_.material.getProperty(i.slice(0,-3),n))}t.setProperty(i,l,n)}},s=0,o=Object.keys(r.properties);s<o.length;s++)a()},r=0;r<i.passes.length;r++)n(r)}else console.warn("incomplete batch material!")}},{key:"cookSkeletons",value:function(){if(this._skinningRoot){var e=new Wy,t=[],i=this.units,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;if(s&&s.skeleton)for(var o=s.skeleton,l=function(i){var n=o.joints[i];if(e.joints.findIndex((function(e){return e===n}))>=0)return"continue";e.joints.push(n),t.push(o.bindposes[i]||new Bn)},u=0;u<o.joints.length;u++)l(u)}var c=Array.from(Array(e.joints.length).keys()).sort((function(t,i){return e.joints[t]>e.joints[i]?1:e.joints[t]<e.joints[i]?-1:0}));e.joints=e.joints.map((function(e,t,i){return i[c[t]]})),e.bindposes=t.map((function(e,t,i){return i[c[t]]})),this._skeleton&&this._skeleton.destroy(),this.skeleton=e}else console.warn("no skinning root specified!")}},{key:"cookMeshes",value:function(){var e=this,t=!1,i=this.units,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}if(a.mesh){t=!0;break}}if(this._mesh?this._mesh.destroyRenderingMesh():this._mesh=new su,t&&this._skinningRoot){for(var s,o=0,l=no.UNKNOWN,u=0,c=no.UNKNOWN,h=new Array(this.units.length),f=this.units.length,_=0;_<f;_++){var d=this.units[_];d&&d.skeleton&&(h[_]=d.skeleton.joints.map((function(t){return e._skeleton.joints.findIndex((function(e){return t===e}))})))}for(var p=function(t){var i=e.units[t];if(!i||!i.mesh||!i.mesh.data)return"continue";var n=JSON.parse(JSON.stringify(i.mesh.struct)),r=0,a=n.vertexBundles,f=Array.isArray(a),_=0;for(a=f?a:a[Symbol.iterator]();;){var d;if(f){if(_>=a.length)break;d=a[_++]}else{if((_=a.next()).done)break;d=_.value}var p=d;p.attributes.push(gI),p.attributes.push(yI),p.view.offset=r,p.view.length+=p.view.count*bI,p.view.stride+=bI,r+=p.view.length}var m=n.primitives,v=Array.isArray(m),g=0;for(m=v?m:m[Symbol.iterator]();;){var y;if(v){if(g>=m.length)break;y=m[g++]}else{if((g=m.next()).done)break;y=g.value}var b=y;b.indexView&&(b.indexView.offset=r,r+=b.indexView.length),b.geometricInfo&&(r=4*Math.ceil(r/4),b.geometricInfo.view.offset=r,r+=b.geometricInfo.view.length)}var E=i.mesh.data,T=0,S=new Uint8Array(r);s=new DataView(S.buffer);for(var x=0;x<n.vertexBundles.length;x++){var A=i.mesh.readAttribute(x,to.ATTR_TEX_COORD),w=i.mesh.struct.vertexBundles[x].view,C=n.vertexBundles[x].view,R=w.stride,k=C.stride;T=w.offset,r=C.offset;for(var O=0;O<C.count;O++){var I=E.subarray(T,T+R);S.set(I,r),s.setFloat32(r+R,t,cc.sys.isLittleEndian),s.setFloat32(r+R+4,A[2*O],cc.sys.isLittleEndian),s.setFloat32(r+R+8,A[2*O+1],cc.sys.isLittleEndian),r+=k,T+=R}}for(var M=0;M<n.primitives.length;M++){var L=i.mesh.struct.primitives[M],P=n.primitives[M];if(L.indexView&&P.indexView){var B=L.indexView.stride,D=P.indexView.stride;T=L.indexView.offset,r=P.indexView.offset;for(var F=0;F<P.indexView.count;F++){var N=E.subarray(T,T+B);S.set(N,r),r+=D,T+=B}}if(L.geometricInfo&&P.geometricInfo){var z=L.geometricInfo.view.stride,U=P.geometricInfo.view.stride;T=L.geometricInfo.view.offset,r=P.geometricInfo.view.offset;for(var G=0;G<P.geometricInfo.view.count;G++){var V=E.subarray(T,T+z);S.set(V,r),r+=U,T+=z}}}var H=new su;H.reset({struct:n,data:S});var W=i.offset,j=i.size,X=function(){if(Y){if(K>=q.length)return"break";Z=q[K++]}else{if((K=q.next()).done)return"break";Z=K.value}var e=Z;o=e.view.offset,l=no.UNKNOWN;var i=e.attributes,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var f=a;if(f.name===to.ATTR_BATCH_UV){l=f.format;break}o+=Go[f.format].size}l&&Q_(s,(function(e,t){var i,n=0===t?"x":"y";return(e=(i=e)-Math.floor(i))*j[n]+W[n]}),l,o,e.view.length,e.view.stride,s);var _=h[t];if(!_)return"continue";u=e.view.offset,c=no.UNKNOWN;var d=e.attributes,p=Array.isArray(d),m=0;for(d=p?d:d[Symbol.iterator]();;){var v;if(p){if(m>=d.length)break;v=d[m++]}else{if((m=d.next()).done)break;v=m.value}var g=v;if(g.name===to.ATTR_JOINTS){c=g.format;break}u+=Go[g.format].size}c&&Q_(s,(function(e){return _[e]}),c,u,e.view.length,e.view.stride,s)};var q=n.vertexBundles,Y=Array.isArray(q),K=0;e:for(q=Y?q:q[Symbol.iterator]();;){var Z;switch(X()){case"break":break e;case"continue":continue}}e._mesh.merge(H)},m=0;m<f;m++)p(m);this._onMeshChanged(this._mesh),this._updateModels()}}},{key:"cookTextures",value:function(e,t,i){var n=[],r=[],a=[],s=[],o=this.units,l=Array.isArray(o),u=0;for(o=l?o:o[Symbol.iterator]();;){var c;if(l){if(u>=o.length)break;c=o[u++]}else{if((u=o.next()).done)break;c=u.value}var h=c;if(h.material){var f=h.material.getProperty(t,i);if(f&&f.image&&f.image.data){var _=new Uo;_.texOffset.x=h.offset.x*this.atlasSize,_.texOffset.y=h.offset.y*this.atlasSize,_.texExtent.width=h.size.x*this.atlasSize,_.texExtent.height=h.size.y*this.atlasSize;var d=f.image.data;d instanceof HTMLCanvasElement||d instanceof HTMLImageElement?(n.push(d),r.push(_)):(a.push(d),s.push(_))}}}var p=e.getGFXTexture(),m=cc.director.root.device;a.length>0&&m.copyBuffersToTexture(a,p,s),n.length>0&&m.copyTexImagesToTexture(n,p,r)}},{key:"createTexture",value:function(e){var t=new Uc;return t.setFilters(Gu.LINEAR,Gu.LINEAR),t.reset({width:this.atlasSize,height:this.atlasSize,format:zu.RGBA8888}),t.loaded=!0,this._textures[e]=t,t}},{key:"resizeAtlases",value:function(){for(var e=0,t=Object.keys(this._textures);e<t.length;e++){var i=t[e];this._textures[i].reset({width:this.atlasSize,height:this.atlasSize,format:zu.RGBA8888})}}},{key:"mesh",get:function(){return this._mesh},set:function(e){d(o(t.prototype),"mesh",e,this,!0)}},{key:"skeleton",get:function(){return this._skeleton},set:function(e){d(o(t.prototype),"skeleton",e,this,!0)}}]),t}(vI)).prototype,"atlasSize",[eO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1024}}),lO=v(sO.prototype,"batchableTextureNames",[tO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),uO=v(sO.prototype,"units",[iO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),v(sO.prototype,"mesh",[nO],Object.getOwnPropertyDescriptor(sO.prototype,"mesh"),sO.prototype),v(sO.prototype,"skeleton",[rO],Object.getOwnPropertyDescriptor(sO.prototype,"skeleton"),sO.prototype),aO=sO))||aO)||aO)||aO)||aO)),SI=dt({LUMINOUS_POWER:0,LUMINANCE:1}),xI=e("LightComponent",(cO=Es("cc.LightComponent"),hO=Ts({tooltip:""}),fO=Ts({tooltip:""}),_O=Ts({slide:!0,range:[1e3,15e3,1],tooltip:""}),cO((bO=yO=function(e){function t(){var e;return i(this,t),m(e=c(this,o(t).call(this)),"_color",mO,u(e)),m(e,"_useColorTemperature",vO,u(e)),m(e,"_colorTemperature",gO,u(e)),e._type=YS.UNKNOWN,e._light=null,e._lightType=JS,e}return s(t,e),r(t,[{key:"color",get:function(){return this._color},set:function(e){this._color=e,this._light&&(this._light.color.x=e.r/255,this._light.color.y=e.g/255,this._light.color.z=e.b/255)}},{key:"useColorTemperature",get:function(){return this._useColorTemperature},set:function(e){this._useColorTemperature=e,this._light&&(this._light.useColorTemperature=e)}},{key:"colorTemperature",get:function(){return this._colorTemperature},set:function(e){this._colorTemperature=e,this._light&&(this._light.colorTemperature=e)}},{key:"type",get:function(){return this._type}}]),r(t,[{key:"onLoad",value:function(){this._createLight()}},{key:"onEnable",value:function(){this._attachToScene()}},{key:"onDisable",value:function(){this._detachFromScene()}},{key:"onDestroy",value:function(){this._destroyLight()}},{key:"_createLight",value:function(){this._light||(this._light=cc.director.root.createLight(this._lightType)),this.color=this._color,this.useColorTemperature=this._useColorTemperature,this.colorTemperature=this._colorTemperature,this._light.node=this.node}},{key:"_destroyLight",value:function(){this._light&&(cc.director.root.destroyLight(this),this._light=null)}},{key:"_attachToScene",value:function(){if(this._detachFromScene(),this._light&&!this._light.scene&&this.node.scene)switch(this._type){case YS.DIRECTIONAL:this._getRenderScene().setMainLight(this._light);break;case YS.SPHERE:this._getRenderScene().addSphereLight(this._light);break;case YS.SPOT:this._getRenderScene().addSpotLight(this._light)}}},{key:"_detachFromScene",value:function(){if(this._light&&this._light.scene)switch(this._type){case YS.DIRECTIONAL:this._light.scene.unsetMainLight(this._light);break;case YS.SPHERE:this._light.scene.removeSphereLight(this._light);break;case YS.SPOT:this._light.scene.removeSpotLight(this._light)}}}]),t}(Ph),yO.Type=YS,yO.PhotometricTerm=SI,mO=v((pO=bO).prototype,"_color",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return rr.WHITE.clone()}}),vO=v(pO.prototype,"_useColorTemperature",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),gO=v(pO.prototype,"_colorTemperature",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 6550}}),v(pO.prototype,"color",[hO],Object.getOwnPropertyDescriptor(pO.prototype,"color"),pO.prototype),v(pO.prototype,"useColorTemperature",[fO],Object.getOwnPropertyDescriptor(pO.prototype,"useColorTemperature"),pO.prototype),v(pO.prototype,"colorTemperature",[_O],Object.getOwnPropertyDescriptor(pO.prototype,"colorTemperature"),pO.prototype),dO=pO))||dO)),AI=e("DirectionalLightComponent",(EO=Es("cc.DirectionalLightComponent"),TO=Cs("Light/DirectionalLight"),SO=Ts({unit:"lx",tooltip:""}),EO(xO=TO(xO=As((wO=v((AO=function(e){function t(){var e;return i(this,t),m(e=c(this,o(t).call(this)),"_illuminance",wO,u(e)),e._type=YS.DIRECTIONAL,e._light=null,e._lightType=Tw,e}return s(t,e),r(t,[{key:"illuminance",get:function(){return this._illuminance},set:function(e){this._illuminance=e,this._light&&(this._light.illuminance=this._illuminance)}}]),r(t,[{key:"_createLight",value:function(){f(o(t.prototype),"_createLight",this).call(this),this._light&&(this.illuminance=this._illuminance)}}]),t}(xI)).prototype,"_illuminance",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 65e3}}),v(AO.prototype,"illuminance",[SO],Object.getOwnPropertyDescriptor(AO.prototype,"illuminance"),AO.prototype),xO=AO))||xO)||xO)||xO)),wI=Es("cc.EditorCameraComponent")(CO=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),s=0;s<r;s++)a[s]=arguments[s];return(n=c(this,(e=o(t)).call.apply(e,[this].concat(a))))._uiEditorCamera=null,n}return s(t,e),r(t,[{key:"onLoad",value:function(){f(o(t.prototype),"onLoad",this).call(this),this._inEditorMode=!0}},{key:"onEnable",value:function(){f(o(t.prototype),"onEnable",this).call(this),this._uiEditorCamera&&(cc.director.root.ui.renderScene.addCamera(this._uiEditorCamera),this._uiEditorCamera.enabled=!0)}},{key:"onDisable",value:function(){f(o(t.prototype),"onDisable",this).call(this),this._uiEditorCamera&&cc.director.root.ui.renderScene.removeCamera(this._uiEditorCamera)}},{key:"onDestroy",value:function(){f(o(t.prototype),"onDestroy",this).call(this),this._uiEditorCamera&&(cc.director.root.destroyCamera(this._uiEditorCamera),this._uiEditorCamera=null)}},{key:"_createCamera",value:function(){var e=this._camera;f(o(t.prototype),"_createCamera",this).call(this),this._camera!==e&&this._camera&&(this._uiEditorCamera&&(cc.director.root.destroyCamera(this._uiEditorCamera),this._uiEditorCamera=null),this._uiEditorCamera=cc.director.root.createCamera(),this._uiEditorCamera.initialize({name:"Editor UICamera",node:this._camera.node,projection:this._projection,window:cc.director.root.mainWindow,priority:this._priority+1,flows:["UIFlow"]}),this._uiEditorCamera.enabled=!0,this._uiEditorCamera.visibility=Ou,this._uiEditorCamera.viewport=this._camera.viewport,this._uiEditorCamera.fov=this._camera.fov,this._uiEditorCamera.nearClip=this._camera.nearClip,this._uiEditorCamera.farClip=this._camera.farClip,this._uiEditorCamera.clearColor=this._camera.clearColor,this._uiEditorCamera.clearDepth=this._camera.clearDepth,this._uiEditorCamera.clearStencil=this._camera.clearStencil,this._uiEditorCamera.clearFlag=Bo.DEPTH_STENCIL)}},{key:"projection",set:function(e){d(o(t.prototype),"projection",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.projectionType=e)}},{key:"fov",set:function(e){d(o(t.prototype),"fov",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.fov=mi(e))}},{key:"orthoHeight",set:function(e){d(o(t.prototype),"orthoHeight",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.orthoHeight=e)}},{key:"near",set:function(e){d(o(t.prototype),"near",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.nearClip=e)}},{key:"far",set:function(e){d(o(t.prototype),"far",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.farClip=e)}},{key:"color",set:function(e){d(o(t.prototype),"color",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.clearColor=e)}},{key:"depth",set:function(e){d(o(t.prototype),"depth",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.clearDepth=e)}},{key:"stencil",set:function(e){d(o(t.prototype),"stencil",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.clearStencil=e)}},{key:"clearFlags",set:function(e){d(o(t.prototype),"clearFlags",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.clearFlag=e)}},{key:"rect",set:function(e){d(o(t.prototype),"rect",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.viewport=e)}},{key:"screenScale",set:function(e){d(o(t.prototype),"screenScale",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.screenScale=e)}}]),t}(Pk))||CO,CI=e("SphereLightComponent",(RO=Es("cc.SphereLightComponent"),kO=Cs("Light/SphereLight"),OO=Ts({unit:"lm",tooltip:""}),IO=Ts({unit:"cd/m",tooltip:""}),MO=Ts({type:SI,tooltip:""}),LO=Ts({tooltip:""}),PO=Ts({tooltip:""}),RO(BO=kO(BO=As((FO=v((DO=function(e){function t(){var e;return i(this,t),m(e=c(this,o(t).call(this)),"_size",FO,u(e)),m(e,"_luminance",NO,u(e)),m(e,"_term",zO,u(e)),m(e,"_range",UO,u(e)),e._type=YS.SPHERE,e._light=null,e._lightType=Sw,e}return s(t,e),r(t,[{key:"luminousPower",get:function(){return this._luminance*QS(this._size)},set:function(e){this._luminance=e/QS(this._size),this._light&&(this._light.luminance=this._luminance)}},{key:"luminance",get:function(){return this._luminance},set:function(e){this._luminance=e,this._light&&(this._light.luminance=e)}},{key:"term",get:function(){return this._term},set:function(e){this._term=e}},{key:"size",get:function(){return this._size},set:function(e){this._size=e,this._light&&(this._light.size=e)}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._light&&(this._light.range=e)}}]),r(t,[{key:"_createLight",value:function(){f(o(t.prototype),"_createLight",this).call(this),this._light&&(this.luminance=this._luminance,this.size=this._size,this.range=this._range)}}]),t}(xI)).prototype,"_size",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.15}}),NO=v(DO.prototype,"_luminance",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1700/QS(.15)}}),zO=v(DO.prototype,"_term",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return SI.LUMINOUS_POWER}}),UO=v(DO.prototype,"_range",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),v(DO.prototype,"luminousPower",[OO],Object.getOwnPropertyDescriptor(DO.prototype,"luminousPower"),DO.prototype),v(DO.prototype,"luminance",[IO],Object.getOwnPropertyDescriptor(DO.prototype,"luminance"),DO.prototype),v(DO.prototype,"term",[MO],Object.getOwnPropertyDescriptor(DO.prototype,"term"),DO.prototype),v(DO.prototype,"size",[LO],Object.getOwnPropertyDescriptor(DO.prototype,"size"),DO.prototype),v(DO.prototype,"range",[PO],Object.getOwnPropertyDescriptor(DO.prototype,"range"),DO.prototype),BO=DO))||BO)||BO)||BO)),RI=e("SpotLightComponent",(GO=Es("cc.SpotLightComponent"),VO=Cs("Light/SpotLight"),HO=Ts({unit:"lm",tooltip:""}),WO=Ts({unit:"cd/m",tooltip:""}),jO=Ts({type:SI,tooltip:""}),XO=Ts({tooltip:""}),qO=Ts({tooltip:""}),YO=Ts({slide:!0,range:[2,180,1],tooltip:""}),GO(KO=VO(KO=As((QO=v((ZO=function(e){function t(){var e;return i(this,t),m(e=c(this,o(t).call(this)),"_size",QO,u(e)),m(e,"_luminance",JO,u(e)),m(e,"_term",$O,u(e)),m(e,"_range",eI,u(e)),m(e,"_spotAngle",tI,u(e)),e._type=YS.SPOT,e._light=null,e._lightType=Ow,e}return s(t,e),r(t,[{key:"luminousPower",get:function(){return this._luminance*QS(this._size)},set:function(e){this._luminance=e/QS(this._size),this._light&&(this._light.luminance=this._luminance)}},{key:"luminance",get:function(){return this._luminance},set:function(e){this._luminance=e,this._light&&(this._light.luminance=e)}},{key:"term",get:function(){return this._term},set:function(e){this._term=e}},{key:"size",get:function(){return this._size},set:function(e){this._size=e,this._light&&(this._light.size=e)}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._light&&(this._light.range=e)}},{key:"spotAngle",get:function(){return this._spotAngle},set:function(e){this._spotAngle=e,this._light&&(this._light.spotAngle=mi(e))}}]),r(t,[{key:"_createLight",value:function(){f(o(t.prototype),"_createLight",this).call(this),this._light&&(this.luminance=this._luminance,this.size=this._size,this.range=this._range,this.spotAngle=this._spotAngle)}}]),t}(xI)).prototype,"_size",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.15}}),JO=v(ZO.prototype,"_luminance",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1700/QS(.15)}}),$O=v(ZO.prototype,"_term",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return SI.LUMINOUS_POWER}}),eI=v(ZO.prototype,"_range",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),tI=v(ZO.prototype,"_spotAngle",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),v(ZO.prototype,"luminousPower",[HO],Object.getOwnPropertyDescriptor(ZO.prototype,"luminousPower"),ZO.prototype),v(ZO.prototype,"luminance",[WO],Object.getOwnPropertyDescriptor(ZO.prototype,"luminance"),ZO.prototype),v(ZO.prototype,"term",[jO],Object.getOwnPropertyDescriptor(ZO.prototype,"term"),ZO.prototype),v(ZO.prototype,"size",[XO],Object.getOwnPropertyDescriptor(ZO.prototype,"size"),ZO.prototype),v(ZO.prototype,"range",[qO],Object.getOwnPropertyDescriptor(ZO.prototype,"range"),ZO.prototype),v(ZO.prototype,"spotAngle",[YO],Object.getOwnPropertyDescriptor(ZO.prototype,"spotAngle"),ZO.prototype),KO=ZO))||KO)||KO)||KO));or(Rp.prototype,"ModelComponent.prototype",[{name:"enableDynamicBatching"},{name:"receiveShadows"}]),cc.CameraComponent=Pk,cc.EditorComponent=wI,cc.RenderableComponent=wp,cc.ModelComponent=Rp,cc.SkinningModelComponent=vI,cc.BatchedSkinningModelComponent=TI,cc.SkinningModelUnit=EI,cc.LightComponent=xI,cc.DirectionalLightComponent=AI,cc.SphereLightComponent=CI,cc.SpotLightComponent=RI,cc.utils=AA;e("UICoordinateTrackerComponent",(iI=Es("cc.UICoordinateTrackerComponent"),nI=Cs("Components/UICoordinateTracker"),rI=Rs(110),aI=Ts({type:o_,tooltip:""}),sI=Ts({type:Pk,tooltip:""}),oI=Ts({tooltip:""}),lI=Ts({tooltip:""}),uI=Ts({type:[gR],tooltip:""}),iI(cI=nI(cI=rI((v((hI=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),s=0;s<r;s++)a[s]=arguments[s];return m(n=c(this,(e=o(t)).call.apply(e,[this].concat(a))),"syncEvents",fI,u(n)),m(n,"_target",_I,u(n)),m(n,"_camera",dI,u(n)),m(n,"_useScale",pI,u(n)),m(n,"_distance",mI,u(n)),n._transformPos=new zi,n._viewPos=new zi,n._canMove=!0,n._lastWpos=new zi,n._lastCameraPos=new zi,n}return s(t,e),r(t,[{key:"onEnable",value:function(){this._checkCanMove()}},{key:"update",value:function(){var e=this.node.worldPosition,t=this._camera;if(this._canMove&&t._camera&&(!this._lastWpos.equals(e)||!this._lastCameraPos.equals(t.node.worldPosition))&&(this._lastWpos.set(e),this._lastCameraPos.set(t.node.worldPosition),t._camera.update(),Xp.WorldNode3DToLocalNodeUI(t,e,this._target,this._transformPos),this._useScale&&zi.transformMat4(this._viewPos,this.node.worldPosition,t._camera.matView),this.syncEvents.length>0)){var i=this._distance/Math.abs(this._viewPos.z);gR.emitEvents(this.syncEvents,this._transformPos,i)}}},{key:"_checkCanMove",value:function(){this._canMove=!(!this._camera||!this._target)}},{key:"target",get:function(){return this._target},set:function(e){this._target!==e&&(this._target=e,this._checkCanMove())}},{key:"camera",get:function(){return this._camera},set:function(e){this._camera!==e&&(this._camera=e,this._checkCanMove())}},{key:"useScale",get:function(){return this._useScale},set:function(e){this._useScale!==e&&(this._useScale=e)}},{key:"distance",get:function(){return this._distance},set:function(e){this._distance!==e&&(this._distance=e)}}]),t}(Ph)).prototype,"target",[aI],Object.getOwnPropertyDescriptor(hI.prototype,"target"),hI.prototype),v(hI.prototype,"camera",[sI],Object.getOwnPropertyDescriptor(hI.prototype,"camera"),hI.prototype),v(hI.prototype,"useScale",[oI],Object.getOwnPropertyDescriptor(hI.prototype,"useScale"),hI.prototype),v(hI.prototype,"distance",[lI],Object.getOwnPropertyDescriptor(hI.prototype,"distance"),hI.prototype),fI=v(hI.prototype,"syncEvents",[uI],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_I=v(hI.prototype,"_target",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),dI=v(hI.prototype,"_camera",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),pI=v(hI.prototype,"_useScale",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),mI=v(hI.prototype,"_distance",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),cI=hI))||cI)||cI)||cI));var kI,OI,II,MI,LI,PI,BI,DI,FI,NI,zI=Es("cc.animation.UniformProxyFactory")((II=v((OI=function(){function e(t,n){i(this,e),m(this,"passIndex",II,this),m(this,"uniformName",MI,this),m(this,"channelIndex",LI,this),this.passIndex=n||0,this.uniformName=t||""}return r(e,[{key:"forTarget",value:function(e){var t=e.passes[this.passIndex],i=t.getHandle(this.uniformName);if(void 0===i)throw new Error('Material "'.concat(e.name,'" has no uniform "').concat(this.uniformName,'"'));var n=jd.getBindingTypeFromHandle(i);if(n===wo.UNIFORM_BUFFER){var r=void 0===this.channelIndex?i:t.getHandle(this.uniformName,this.channelIndex,io.FLOAT);if(void 0===r)throw new Error('Uniform "'.concat(this.uniformName," (in material ").concat(e.name,") has no channel ").concat(this.channelIndex,'"'));return function(e,t){var i=e.shaderInfo.blocks,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a.members,o=Array.isArray(s),l=0;for(s=o?s:s[Symbol.iterator]();;){var u;if(o){if(l>=s.length)break;u=s[l++]}else{if((l=s.next()).done)break;u=l.value}var c=u;if(c.name===t)return c.count>1}}return!1}(t,this.uniformName)?{set:function(e){t.setUniformArray(r,e)}}:{set:function(e){t.setUniform(r,e)}}}if(n===wo.SAMPLER){var a=jd.getBindingFromHandle(i),s=t.properties[this.uniformName],o=s&&s.value?s.value+"-texture":Ad[s.type],l=P_.get(o);return l||(console.warn("illegal texture default value: "+o),l=P_.get("default-texture")),{set:function(e){e||(e=l);var i=e.getGFXTextureView();i&&i.texture.width&&i.texture.height&&(t.bindTextureView(a,i),e instanceof Rc&&t.bindSampler(a,yc.getSampler(cc.game._gfxDevice,e.getSamplerHash())))}}}throw new Error("Animations are not available for uniforms with binding type ".concat(n,"."))}}]),e}()).prototype,"passIndex",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),MI=v(OI.prototype,"uniformName",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),LI=v(OI.prototype,"channelIndex",[Bs],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){}}),kI=OI))||kI;function UI(e,t,n,a){var s,o,l,u,c,h=new t,f=new t,_=new t,d=Es(e)((l=v((o=function(){function e(n,r,a){i(this,e),m(this,"dataPoint",l,this),m(this,"inTangent",u,this),m(this,"outTangent",c,this),this.dataPoint=n||new t,this.inTangent=r||new t,this.outTangent=a||new t}return r(e,[{key:"lerp",value:function(e,t,i){var r=this.dataPoint,s=e.dataPoint;f=n(f,this.inTangent,i),_=n(_,e.outTangent,i);var o=t*t*t,l=t*t,u=o-2*l+t,c=-2*o+3*l,d=o-l;return h=n(h,r,2*o-3*l+1),h=a(h,h,f,u),h=a(h,h,s,c),h=a(h,h,_,d)}},{key:"getNoLerp",value:function(){return this.dataPoint}}]),e}()).prototype,"dataPoint",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new t}}),u=v(o.prototype,"inTangent",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new t}}),c=v(o.prototype,"outTangent",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new t}}),s=o))||s;if(t===fn){var p=d.prototype.lerp;d.prototype.lerp=function(e,t,i){var n=p.call(this,e,t,i);return fn.normalize(n,n),n}}return d}var GI=e("CubicSplineVec2Value",UI("cc.CubicSplineVec2Value",Mi,Mi.multiplyScalar,Mi.scaleAndAdd));cc.CubicSplineVec2Value=GI;var VI=e("CubicSplineVec3Value",UI("cc.CubicSplineVec3Value",zi,zi.multiplyScalar,zi.scaleAndAdd));cc.CubicSplineVec3Value=VI;var HI=e("CubicSplineVec4Value",UI("cc.CubicSplineVec4Value",qi,qi.multiplyScalar,qi.scaleAndAdd));cc.CubicSplineVec4Value=HI;var WI=e("CubicSplineQuatValue",UI("cc.CubicSplineQuatValue",fn,fn.multiplyScalar,fn.scaleAndAdd));cc.CubicSplineQuatValue=WI;var jI=e("CubicSplineNumberValue",Es("cc.CubicSplineNumberValue")((DI=v((BI=function(){function e(t,n,r){i(this,e),m(this,"dataPoint",DI,this),m(this,"inTangent",FI,this),m(this,"outTangent",NI,this),this.dataPoint=t,this.inTangent=n,this.outTangent=r}return r(e,[{key:"lerp",value:function(e,t,i){var n=this.dataPoint,r=e.dataPoint,a=t*t*t,s=t*t;return n*(2*a-3*s+1)+this.outTangent*i*(a-2*s+t)+r*(-2*a+3*s)+e.inTangent*i*(a-s)}},{key:"getNoLerp",value:function(){return this.dataPoint}}]),e}()).prototype,"dataPoint",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),FI=v(BI.prototype,"inTangent",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),NI=v(BI.prototype,"outTangent",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),PI=BI))||PI);function XI(e){return e*e}function qI(e){return e*(2-e)}function YI(e){return e*e*e}function KI(e){return--e*e*e+1}function ZI(e){return e*e*e*e}function QI(e){return 1- --e*e*e*e}function JI(e){return e*e*e*e*e}function $I(e){return--e*e*e*e*e+1}function eM(e){return 1-Math.cos(e*Math.PI/2)}function tM(e){return Math.sin(e*Math.PI/2)}function iM(e){return 0===e?0:Math.pow(1024,e-1)}function nM(e){return 1===e?1:1-Math.pow(2,-10*e)}function rM(e){return 1-Math.sqrt(1-e*e)}function aM(e){return Math.sqrt(1- --e*e)}function sM(e){var t,i=.1;return 0===e?0:1===e?1:(!i||i<1?(i=1,t=.1):t=.4*Math.asin(1/i)/(2*Math.PI),-i*Math.pow(2,10*(e-=1))*Math.sin((e-t)*(2*Math.PI)/.4))}function oM(e){var t,i=.1;return 0===e?0:1===e?1:(!i||i<1?(i=1,t=.1):t=.4*Math.asin(1/i)/(2*Math.PI),i*Math.pow(2,-10*e)*Math.sin((e-t)*(2*Math.PI)/.4)+1)}function lM(e){var t=1.70158;return e*e*((t+1)*e-t)}function uM(e){var t=1.70158;return--e*e*((t+1)*e+t)+1}function cM(e){return 1-hM(1-e)}function hM(e){return e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375}cc.CubicSplineNumberValue=jI,e("animation",Object.freeze({__proto__:null,UniformProxyFactory:zI,isPropertyPath:l_,isCustomPath:u_,HierarchyPath:c_,ComponentPath:h_,CubicSplineVec2Value:GI,CubicSplineVec3Value:VI,CubicSplineVec4Value:HI,CubicSplineQuatValue:WI,CubicSplineNumberValue:jI}));var fM=TM(XI,qI),_M=TM(YI,KI),dM=TM(ZI,QI),pM=TM(JI,$I),mM=TM(eM,tM),vM=TM(iM,nM),gM=TM(rM,aM),yM=TM(sM,oM),bM=TM(lM,uM),EM=TM(cM,hM);function TM(e,t){return function(i){return i<.5?t(2*i)/2:e(2*i-1)/2+.5}}var SM=Object.freeze({__proto__:null,constant:function(){return 0},linear:function(e){return e},quadIn:XI,quadOut:qI,quadInOut:function(e){return(e*=2)<1?.5*e*e:-.5*(--e*(e-2)-1)},cubicIn:YI,cubicOut:KI,cubicInOut:function(e){return(e*=2)<1?.5*e*e*e:.5*((e-=2)*e*e+2)},quartIn:ZI,quartOut:QI,quartInOut:function(e){return(e*=2)<1?.5*e*e*e*e:-.5*((e-=2)*e*e*e-2)},quintIn:JI,quintOut:$I,quintInOut:function(e){return(e*=2)<1?.5*e*e*e*e*e:.5*((e-=2)*e*e*e*e+2)},sineIn:eM,sineOut:tM,sineInOut:function(e){return.5*(1-Math.cos(Math.PI*e))},expoIn:iM,expoOut:nM,expoInOut:function(e){return 0===e?0:1===e?1:(e*=2)<1?.5*Math.pow(1024,e-1):.5*(2-Math.pow(2,-10*(e-1)))},circIn:rM,circOut:aM,circInOut:function(e){return(e*=2)<1?-.5*(Math.sqrt(1-e*e)-1):.5*(Math.sqrt(1-(e-=2)*e)+1)},elasticIn:sM,elasticOut:oM,elasticInOut:function(e){var t,i=.1;return 0===e?0:1===e?1:(!i||i<1?(i=1,t=.1):t=.4*Math.asin(1/i)/(2*Math.PI),(e*=2)<1?i*Math.pow(2,10*(e-=1))*Math.sin((e-t)*(2*Math.PI)/.4)*-.5:i*Math.pow(2,-10*(e-=1))*Math.sin((e-t)*(2*Math.PI)/.4)*.5+1)},backIn:lM,backOut:uM,backInOut:function(e){var t=2.5949095;return(e*=2)<1?e*e*((t+1)*e-t)*.5:.5*((e-=2)*e*((t+1)*e+t)+2)},bounceIn:cM,bounceOut:hM,bounceInOut:function(e){return e<.5?.5*cM(2*e):.5*hM(2*e-1)+.5},smooth:function(e){return e<=0?0:e>=1?1:e*e*(3-2*e)},fade:function(e){return e<=0?0:e>=1?1:e*e*e*(e*(6*e-15)+10)},quadOutIn:fM,cubicOutIn:_M,quartOutIn:dM,quintOutIn:pM,sineOutIn:mM,expoOutIn:vM,circOutIn:gM,elasticOutIn:yM,backOutIn:bM,bounceOutIn:EM});e("easing",SM);function xM(e,t){for(var i=0,n=e.length-1,r=n>>>1;i<=n;r=i+n>>>1){var a=e[r];if(a>t+1e-6)n=r-1;else{if(!(a<t-1e-6))return r;i=r+1}}return~i}function AM(e,t,i,n,r){var a=1-r;return e*a*a*a+3*t*a*a*r+3*i*a*r*r+n*r*r*r}cc.bezier=AM;var wM,CM,RM=Math.cos,kM=Math.acos,OM=Math.max,IM=2*Math.PI,MM=Math.sqrt;function LM(e){return e<0?-Math.pow(-e,1/3):Math.pow(e,1/3)}function PM(e,t){var i=function(e,t){var i,n,r,a,s=t-0,o=t-e[0],l=3*s,u=3*o,c=3*(t-e[2]),h=1/(-s+u-c+(t-1)),f=(l-6*o+c)*h,_=f*(1/3),d=(-l+u)*h,p=1/3*(3*d-f*f),m=p*(1/3),v=(2*f*f*f-9*f*d+27*(s*h))/27,g=v/2,y=g*g+m*m*m;if(y<0){var b=1/3*-p,E=MM(b*b*b),T=-v/(2*E),S=kM(T<-1?-1:T>1?1:T),x=2*LM(E);return n=x*RM(S*(1/3))-_,r=x*RM((S+IM)*(1/3))-_,a=x*RM((S+2*IM)*(1/3))-_,0<=n&&n<=1?0<=r&&r<=1?0<=a&&a<=1?OM(n,r,a):OM(n,r):0<=a&&a<=1?OM(n,a):n:0<=r&&r<=1?0<=a&&a<=1?OM(r,a):r:a}if(0===y)return r=-(i=g<0?LM(-g):-LM(g))-_,0<=(n=2*i-_)&&n<=1?0<=r&&r<=1?OM(n,r):n:r;var A=MM(y);return n=(i=LM(-g+A))-LM(g+A)-_}(e,t),n=1-i;return 0*n*n*n+3*e[1]*i*n*n+3*e[3]*i*i*n+1*i*i*i}cc.bezierByTime=PM,function(e){e[e.Loop=2]="Loop",e[e.ShouldWrap=4]="ShouldWrap",e[e.PingPong=22]="PingPong",e[e.Reverse=36]="Reverse"}(wM||(wM={})),function(e){e[e.Default=0]="Default",e[e.Normal=1]="Normal",e[e.Reverse=wM.Reverse]="Reverse",e[e.Loop=wM.Loop]="Loop",e[e.LoopReverse=wM.Loop|wM.Reverse]="LoopReverse",e[e.PingPong=wM.PingPong]="PingPong",e[e.PingPongReverse=wM.PingPong|wM.Reverse]="PingPongReverse"}(CM||(CM={})),pt(CM);var BM=function(){function e(t){i(this,e),this.ratio=0,this.time=0,this.direction=1,this.stopped=!0,this.iterations=0,this.frameIndex=void 0,t&&this.set(t)}return r(e,[{key:"set",value:function(e){this.ratio=e.ratio,this.time=e.time,this.direction=e.direction,this.stopped=e.stopped,this.iterations=e.iterations,this.frameIndex=e.frameIndex}}]),e}();var DM=e("RatioSampler",function(){function e(t){var n,r;i(this,e),this.ratios=t;for(var a=!0,s=1,o=t.length;s<o;s++)if(n=t[s]-t[s-1],1===s)r=n;else if(Math.abs(n-r)>1e-6){a=!1;break}this._findRatio=a?UM:xM}return r(e,[{key:"sample",value:function(e){return this._findRatio(this.ratios,e)}}]),e}());cc.RatioSampler=DM;var FM=e("AnimCurve",function(){function e(t,n){i(this,e),this.types=void 0,this.type=null,this._values=[],this._lerp=void 0,this._duration=n,this._values=t.values;var r=function(t){return"string"==typeof t?t:Array.isArray(t)?t[0]===t[1]&&t[2]===t[3]?e.Linear:e.Bezier(t):e.Linear};if(void 0!==t.easingMethod)this.type=r(t.easingMethod);else if(Array.isArray(t.easingMethods))this.types=t.easingMethods.map(r);else if(void 0!==t.easingMethods){this.types=new Array(this._values.length).fill(null);for(var a=0,s=Object.keys(t.easingMethods);a<s.length;a++){var o=s[a];this.types[o]=r(t.easingMethods[o])}}else this.type=null;var l=t.values[0];(void 0===t.interpolate||t.interpolate)&&(this._lerp=rL(l))}return r(e,null,[{key:"Bezier",value:function(e){return e}}]),r(e,[{key:"hasLerp",value:function(){return!!this._lerp}},{key:"valueAt",value:function(e){var t=this._values[e];return t&&t.getNoLerp?t.getNoLerp():t}},{key:"valueBetween",value:function(e,t,i,n,r){if(this._lerp){var a=this.types?this.types[t]:this.type,s=r-i,o=(e-i)/s;a&&(o=zM(o,a));var l=this._values[t],u=this._values[n];return this._lerp(l,u,o,s*this._duration)}return this.valueAt(t)}},{key:"empty",value:function(){return 0===this._values.length}}]),e}());FM.Linear=null,cc.AnimCurve=FM;e("EventInfo",function(){function e(){i(this,e),this.events=[]}return r(e,[{key:"add",value:function(e,t){this.events.push({func:e||"",params:t||[]})}}]),e}());function NM(e,t,i){var n=t.sample(i);if(n<0)if((n=~n)<=0)n=0;else{if(!(n>=t.ratios.length))return e.valueBetween(i,n-1,t.ratios[n-1],n,t.ratios[n]);n=t.ratios.length-1}return e.valueAt(n)}function zM(e,t){if("string"==typeof t){var i=SM[t];i?e=i(e):U(3906,t)}else Array.isArray(t)&&(e=PM(t,e));return e}function UM(e,t){var i=e.length-1;if(0===i)return 0;var n=e[0];if(t<n)return 0;var r=e[i];if(t>r)return i;var a=(t=(t-n)/(r-n))/(1/i),s=0|a;return a-s<1e-6?s:s+1-a<1e-6?s+1:~(s+1)}cc.sampleAnimationCurve=NM;var GM,VM,HM,WM,jM,XM,qM,YM,KM,ZM,QM,JM,$M,eL,tL,iL,nL,rL=function(){function e(e,t,i,n){return e.lerp(t,i,n)}return function(i){if(null!==i){if("number"==typeof i)return pi;if("object"===t(i)&&i.constructor){if(i instanceof fn)return n=new fn,function(e,t,i,r){return fn.slerp(n,e,t,i)};if(i instanceof mt)return function(e){var t=new e;return function(i,n,r){return e.lerp(t,i,n,r),t}}(i.constructor);if(i.constructor===Number)return pi;if("function"==typeof i.lerp)return e}var n}}}(),aL=e("AnimationClip",(GM=Es("cc.AnimationClip"),VM=Ts({visible:!1}),GM((nL=iL=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),s=0;s<r;s++)a[s]=arguments[s];return m(n=c(this,(e=o(t)).call.apply(e,[this].concat(a))),"sample",jM,u(n)),m(n,"speed",XM,u(n)),m(n,"wrapMode",qM,u(n)),m(n,"events",YM,u(n)),m(n,"_duration",KM,u(n)),m(n,"_keys",ZM,u(n)),m(n,"_stepness",QM,u(n)),m(n,"curveDatas",JM,u(n)),m(n,"_curves",$M,u(n)),m(n,"_commonTargets",eL,u(n)),m(n,"_hash",tL,u(n)),n.frameRate=0,n._ratioSamplers=[],n._data=null,n}return s(t,e),r(t,[{key:"onLoaded",value:function(){this.frameRate=this.sample,this._migrateCurveDatas(),this._decodeCVTAs()}},{key:"getPropertyCurves",value:function(){return this._runtimeCurves||this._createPropertyCurves(),this._runtimeCurves}},{key:"updateCurveDatas",value:function(){this._migrateCurveDatas(),delete this._runtimeCurves}},{key:"updateEventDatas",value:function(){delete this._runtimeEvents}},{key:"getEventGroupIndexAtRatio",value:function(e){return this._runtimeEvents||this._createRuntimeEvents(),function(e,t){for(var i=0,n=e.length-1,r=n>>>1;i<=n;r=i+n>>>1){var a=e[r];if(a>t+1e-6)n=r-1;else{if(!(a<t-1e-6))return r;i=r+1}}return~i}(this._runtimeEvents.ratios,e)}},{key:"hasEvents",value:function(){return 0!==this.events.length}},{key:"destroy",value:function(){return cc.director.root.dataPoolManager.releaseAnimationClip(this),f_.destroy(this),f(o(t.prototype),"destroy",this).call(this)}},{key:"_createPropertyCurves",value:function(){var e=this;this._ratioSamplers=this._keys.map((function(t){return new DM(t.map((function(t){return t/e._duration})))})),this._runtimeCurves=this._curves.map((function(t){return{curve:new FM(t.data,e._duration),modifiers:t.modifiers,valueAdapter:t.valueAdapter,sampler:e._ratioSamplers[t.data.keys],commonTarget:t.commonTarget}})),this._applyStepness()}},{key:"_createRuntimeEvents",value:function(){var e=this;var t=[],i=[],n=function(){if(a){if(s>=r.length)return"break";o=r[s++]}else{if((s=r.next()).done)return"break";o=s.value}var n=o,l=n.frame/e._duration,u=t.findIndex((function(e){return e===l}));u<0&&(u=t.length,t.push(l),i.push({events:[]})),i[u].events.push({functionName:n.func,parameters:n.params})},r=this.events.sort((function(e,t){return e.frame-t.frame})),a=Array.isArray(r),s=0;for(r=a?r:r[Symbol.iterator]();;){var o;if("break"===n())break}this._runtimeEvents={ratios:t,eventGroups:i}}},{key:"_applyStepness",value:function(){this._runtimeCurves}},{key:"_migrateCurveDatas",value:function(){if(this.curveDatas){for(var e=0,t=Object.keys(this.curveDatas);e<t.length;e++){var i=t[e],n=new c_;n.path=i;var r=this.curveDatas[i];if(r.props)for(var a=0,s=Object.keys(r.props);a<s.length;a++){var o=s[a],l=r.props[o];this._curves.push({modifiers:[n,o],data:l})}if(r.comps)for(var u=0,c=Object.keys(r.comps);u<c.length;u++){var h=c[u],f=new h_;f.component=h;for(var _=r.comps[h],d=0,p=Object.keys(_);d<p.length;d++){var m=p[d],v=_[m];this._curves.push({modifiers:[n,f,m],data:v})}}}delete this.curveDatas}}},{key:"_decodeCVTAs",value:function(){var e=ArrayBuffer.isView(this._nativeAsset)?this._nativeAsset.buffer:this._nativeAsset;if(e){for(var t=this._keys,i=0;i<t.length;++i){var n=t[i];n instanceof bm&&(t[i]=n.decompress(e))}for(var r=0;r<this._curves.length;++r){var a=this._curves[r];a.data.values instanceof bm&&(a.data.values=a.data.values.decompress(e))}}}},{key:"duration",get:function(){return this._duration},set:function(e){this._duration=e}},{key:"keys",get:function(){return this._keys},set:function(e){this._keys=e}},{key:"eventGroups",get:function(){return this._runtimeEvents||this._createRuntimeEvents(),this._runtimeEvents.eventGroups}},{key:"stepness",get:function(){return this._stepness},set:function(e){this._stepness=e,this._applyStepness()}},{key:"hash",get:function(){return this._hash||(this._hash=Jo(JSON.stringify(f_.getOrExtract(this).data),666)),this._hash}},{key:"curves",get:function(){return this._curves},set:function(e){this._curves=e,delete this._runtimeCurves}},{key:"data",get:function(){return this._data}},{key:"commonTargets",get:function(){return this._commonTargets},set:function(e){this._commonTargets=e}}],[{key:"createWithSpriteFrames",value:function(e,i){if(!Array.isArray(e))return U(3905),null;var n=new t;n.sample=i||n.sample,n.duration=e.length/n.sample;for(var r=1/n.sample,a=new Array(e.length),s=new Array(a.length),o=0;o<e.length;o++)a[o]=o*r,s[o]=e[o];return n.keys=[a],n.curves=[{modifiers:[new h_("cc.SpriteComponent"),"spriteFrame"],data:{keys:0,values:s}}],n}}]),t}(Tl),iL.preventDeferredLoadDependents=!0,iL.WrapMode=CM,jM=v((WM=nL).prototype,"sample",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),XM=v(WM.prototype,"speed",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),qM=v(WM.prototype,"wrapMode",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return CM.Normal}}),YM=v(WM.prototype,"events",[VM],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),KM=v(WM.prototype,"_duration",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ZM=v(WM.prototype,"_keys",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),QM=v(WM.prototype,"_stepness",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),JM=v(WM.prototype,"curveDatas",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{}}}),$M=v(WM.prototype,"_curves",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),eL=v(WM.prototype,"_commonTargets",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),tL=v(WM.prototype,"_hash",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),HM=WM))||HM));function sL(e,t,i){return i.value||(i.value=new zi),0===i.weight&&zi.zero(i.value),0===t?i.value:1===t?zi.copy(i.value,e):zi.scaleAndAdd(i.value,i.value,e,t)}function oL(e,t,i){if(i.value||(i.value=new fn),0===i.weight&&fn.identity(i.value),0===t)return i.value;if(1===t)return fn.copy(i.value,e);var n=t/(i.weight+t);return fn.slerp(i.value,i.value,e,n)}cc.AnimationClip=aL;var lL,uL,cL=function(){function e(t,n,r){var a;i(this,e);for(var s=0;s<n.length;++s){var o=n[s];if(l_(o))if(s!==n.length-1||r){if(!(o in t))throw new Error('Target object has no property "'.concat(o,'"'));t=t[o]}else a=o;else t=o.get(t)}if(void 0!==a)this._ap={isProxy:!1,object:t,property:a};else{if(!r)throw new Error("Bad animation curve.");this._ap={isProxy:!0,proxy:r.forTarget(t)}}}return r(e,[{key:"setValue",value:function(e){this._ap.isProxy?this._ap.proxy.set(e):this._ap.object[this._ap.property]=e}},{key:"getValue",value:function(){if(this._ap.isProxy){if(this._ap.proxy.get)return this._ap.proxy.get();throw new Error("Target doesn't provide a get method.")}return this._ap.object[this._ap.property]}}]),e}(),hL=function(e){function t(e,n,r){var a;i(this,t);var s=(a=c(this,o(t).call(this,e,n,r))).getValue(),l=fL(s);if(!l)throw new Error("Value is not copyable!");return a._buffer=l.createBuffer(),a._copy=l.copy,a}return s(t,e),r(t,[{key:"peek",value:function(){return this._buffer}},{key:"pull",value:function(){var e=this.getValue();this._copy(this._buffer,e)}},{key:"push",value:function(){this.setValue(this._buffer)}}]),t}(cL),fL=((lL=new Map).set(Mi,{createBuffer:function(){return new Mi},copy:Mi.copy}),lL.set(zi,{createBuffer:function(){return new zi},copy:zi.copy}),lL.set(qi,{createBuffer:function(){return new qi},copy:qi.copy}),lL.set(rr,{createBuffer:function(){return new rr},copy:rr.copy}),function(e){return lL.get(null==e?void 0:e.constructor)}),_L=function(){function e(){i(this,e),this._isPlaying=!1,this._isPaused=!1,this._stepOnce=!1}return r(e,[{key:"play",value:function(){this._isPlaying?this._isPaused?(this._isPaused=!1,this.onResume()):this.onError(W(3912)):(this._isPlaying=!0,this.onPlay())}},{key:"stop",value:function(){this._isPlaying&&(this._isPlaying=!1,this.onStop(),this._isPaused=!1)}},{key:"pause",value:function(){this._isPlaying&&!this._isPaused&&(this._isPaused=!0,this.onPause())}},{key:"resume",value:function(){this._isPlaying&&this._isPaused&&(this._isPaused=!1,this.onResume())}},{key:"step",value:function(){this.pause(),this._stepOnce=!0,this._isPlaying||this.play()}},{key:"update",value:function(e){}},{key:"onPlay",value:function(){}},{key:"onPause",value:function(){}},{key:"onResume",value:function(){}},{key:"onStop",value:function(){}},{key:"onError",value:function(e){}},{key:"isPlaying",get:function(){return this._isPlaying}},{key:"isPaused",get:function(){return this._isPaused}}]),e}();!function(e){e[e.NodePosition=0]="NodePosition",e[e.NodeScale=1]="NodeScale",e[e.NodeRotation=2]="NodeRotation",e[e.None=3]="None"}(uL||(uL={}));var dL=function(){function e(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;if(i(this,e),this._curve=t.curve,this._curveDetail=t,this._boundTarget=new cL(n,t.modifiers,t.valueAdapter),this._rootTarget=n,this._isNodeTarget=n instanceof o_,this._propertySpecialization=uL.None,this._blendFunction=null,this._isNodeTarget&&Array.isArray(t.modifiers)&&1===t.modifiers.length)switch(t.modifiers[0]){case"position":this._propertySpecialization=uL.NodePosition,this._blendFunction=sL;break;case"rotation":this._propertySpecialization=uL.NodeRotation,this._blendFunction=oL;break;case"scale":this._propertySpecialization=uL.NodeScale,this._blendFunction=sL}this._blendTarget=r}return r(e,[{key:"attachToBlendState",value:function(e){this._rootTargetProperty&&(this._blendTarget=e.refPropertyBlendTarget(this._rootTarget,this._rootTargetProperty))}},{key:"detachFromBlendState",value:function(e){this._rootTargetProperty&&(this._blendTarget=null,e.deRefPropertyBlendTarget(this._rootTarget,this._rootTargetProperty))}},{key:"applySample",value:function(e,t,i,n,r){var a;this._curve.empty()||(a=this._curve.hasLerp()&&i?this._curve.valueBetween(e,n.from,n.fromRatio,n.to,n.toRatio):this._curve.valueAt(t),this._setValue(a,r))}},{key:"_setValue",value:function(e,t){if(!this._blendFunction||!this._blendTarget||this._blendTarget.refCount<=1)switch(this._propertySpecialization){case uL.NodePosition:this._rootTarget.setPosition(e);break;case uL.NodeRotation:this._rootTarget.setRotation(e);break;case uL.NodeScale:this._rootTarget.setScale(e);break;default:this._boundTarget.setValue(e)}else this._blendTarget.value=this._blendFunction(e,t,this._blendTarget),this._blendTarget.weight+=t}},{key:"propertyName",get:function(){return this._rootTargetProperty||""}},{key:"curveDetail",get:function(){return this._curveDetail}}]),e}();var pL=e("AnimationState",function(e){function t(e){var n,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";return i(this,t),(n=c(this,o(t).call(this))).duration=1,n.speed=1,n.time=0,n.weight=0,n.frameRate=0,n._lastframeEventOn=!1,n._wrapMode=CM.Normal,n._repeatCount=1,n._currentFramePlayed=!1,n._delay=0,n._delayTime=0,n._wrappedInfo=new BM,n._lastWrapInfo=null,n._lastWrapInfoEvent=null,n._process=n.process,n._target=null,n._targetNode=null,n._samplerSharedGroups=[],n._commonTargetStatuses=[],n._curveLoaded=!1,n._ignoreIndex=-1,n._clip=e,n._name=r||e&&e.name,n}return s(t,e),r(t,[{key:"clip",get:function(){return this._clip}},{key:"name",get:function(){return this._name}},{key:"length",get:function(){return this.duration}},{key:"wrapMode",get:function(){return this._wrapMode},set:function(e){this._wrapMode=e,this.time=0,e&wM.Loop?this.repeatCount=1/0:this.repeatCount=1}},{key:"repeatCount",get:function(){return this._repeatCount},set:function(e){this._repeatCount=e;var t=this._wrapMode&wM.ShouldWrap,i=(this.wrapMode&wM.Reverse)===wM.Reverse;this._process=e!==1/0||t||i?this.process:this.simpleProcess}},{key:"delay",get:function(){return this._delay},set:function(e){this._delayTime=this._delay=e}}]),r(t,[{key:"initialize",value:function(e,t){var i=this;if(!this._curveLoaded){this._curveLoaded=!0,this._samplerSharedGroups.length=0,this._targetNode=e;var n=this._clip;this.duration=n.duration,this.speed=n.speed,this.wrapMode=n.wrapMode,this.frameRate=n.sample,(this.wrapMode&wM.Loop)===wM.Loop?this.repeatCount=1/0:this.repeatCount=1,this._commonTargetStatuses=n.commonTargets.map((function(t,i){return{target:new hL(e,t.modifiers,t.valueAdapter),changed:!1}})),t||(t=n.getPropertyCurves());for(var r=function(n){var r=t[n],a=i._samplerSharedGroups.find((function(e){return e.sampler===r.sampler}));a||(a={sampler:r.sampler,curves:[],samplerResultCache:{from:0,fromRatio:0,to:0,toRatio:0}},i._samplerSharedGroups.push(a));try{var s=new dL(r,"number"==typeof r.commonTarget?i._commonTargetStatuses[r.commonTarget].target.peek():e);s.commonTargetIndex=r.commonTarget,a.curves.push(s)}catch(e){}},a=0;a<t.length;++a)r(a)}}},{key:"_emit",value:function(e,t){this._target&&this._target.isValid&&this._target.emit(e,e,t)}},{key:"emit",value:function(){for(var e=new Array(arguments.length),t=0,i=e.length;t<i;t++)e[t]=t<0||arguments.length<=t?void 0:arguments[t];cc.director.getAnimationManager().pushDelayEvent(this,"_emit",e)}},{key:"on",value:function(e,t,i){return this._target&&this._target.isValid?("lastframe"===e&&(this._lastframeEventOn=!0),this._target.on(e,t,i)):null}},{key:"once",value:function(e,t,i){var n=this;return this._target&&this._target.isValid?("lastframe"===e&&(this._lastframeEventOn=!0),this._target.once(e,(function(e){t.call(i,e),n._lastframeEventOn=!1}))):null}},{key:"off",value:function(e,t,i){this._target&&this._target.isValid&&("lastframe"===e&&(this._target.hasEventListener(e)||(this._lastframeEventOn=!1)),this._target.off(e,t,i))}},{key:"_setEventTarget",value:function(e){this._target=e}},{key:"setTime",value:function(e){this._currentFramePlayed=!1,this.time=e||0,this._lastWrapInfoEvent=null,this._ignoreIndex=-1;var t=this.getWrappedInfo(e,this._wrappedInfo),i=t.direction,n=this._clip.getEventGroupIndexAtRatio(t.ratio);n<0&&(n=~n-1,i<0&&(n+=1),this._ignoreIndex=n)}},{key:"update",value:function(e){this._delayTime>0&&(this._delayTime-=e,this._delayTime>0)||(this._currentFramePlayed?this.time+=e*this.speed:this._currentFramePlayed=!0,this._process())}},{key:"_needReverse",value:function(e){var t=this.wrapMode,i=!1;(t&wM.PingPong)===wM.PingPong&&(e-(0|e)==0&&e>0&&(e-=1),1&e&&(i=!i));return(t&wM.Reverse)===wM.Reverse&&(i=!i),i}},{key:"getWrappedInfo",value:function(e,t){t=t||new BM;var i=!1,n=this.duration,r=this.repeatCount,a=e>0?e/n:-e/n;if(a>=r){a=r,i=!0;var s=r-(0|r);0===s&&(s=1),e=s*n*(e>0?1:-1)}if(e>n){var o=e%n;e=0===o?n:o}else e<0&&0!==(e%=n)&&(e+=n);var l=!1,u=this._wrapMode&wM.ShouldWrap;u&&(l=this._needReverse(a));var c=l?-1:1;return this.speed<0&&(c*=-1),u&&l&&(e=n-e),t.ratio=e/n,t.time=e,t.direction=c,t.stopped=i,t.iterations=a,t}},{key:"sample",value:function(){var e=this.getWrappedInfo(this.time,this._wrappedInfo);return this._sampleCurves(e.ratio),this._sampleEvents(e),e}},{key:"process",value:function(){var e,t=this.sample();this._lastframeEventOn&&(e=this._lastWrapInfo?this._lastWrapInfo:this._lastWrapInfo=new BM(t),this.repeatCount>1&&(0|t.iterations)>(0|e.iterations)&&this.emit("lastframe",this),e.set(t));t.stopped&&(this.stop(),this.emit("finished",this))}},{key:"simpleProcess",value:function(){var e=this.duration,t=this.time%e;t<0&&(t+=e);var i=t/e;this._sampleCurves(i),this._clip.hasEvents()&&this._sampleEvents(this.getWrappedInfo(this.time,this._wrappedInfo)),this._lastframeEventOn&&(void 0===this._lastIterations&&(this._lastIterations=i),(this.time>0&&this._lastIterations>i||this.time<0&&this._lastIterations<i)&&this.emit("lastframe",this),this._lastIterations=i)}},{key:"attachToBlendState",value:function(e){var t=this._samplerSharedGroups,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r.curves,s=Array.isArray(a),o=0;for(a=s?a:a[Symbol.iterator]();;){var l;if(s){if(o>=a.length)break;l=a[o++]}else{if((o=a.next()).done)break;l=o.value}l.attachToBlendState(e)}}}},{key:"detachFromBlendState",value:function(e){var t=this._samplerSharedGroups,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r.curves,s=Array.isArray(a),o=0;for(a=s?a:a[Symbol.iterator]();;){var l;if(s){if(o>=a.length)break;l=a[o++]}else{if((o=a.next()).done)break;l=o.value}l.detachFromBlendState(e)}}}},{key:"cache",value:function(e){}},{key:"onPlay",value:function(){this.setTime(0),this._delayTime=this._delay,cc.director.getAnimationManager().addAnimation(this),this.emit("play",this)}},{key:"onStop",value:function(){this.isPaused||cc.director.getAnimationManager().removeAnimation(this),this.emit("stop",this)}},{key:"onResume",value:function(){cc.director.getAnimationManager().addAnimation(this),this.emit("resume",this)}},{key:"onPause",value:function(){cc.director.getAnimationManager().removeAnimation(this),this.emit("pause",this)}},{key:"_sampleCurves",value:function(e){for(var t=0;t<this._commonTargetStatuses.length;++t){var i=this._commonTargetStatuses[t];i.target.pull(),i.changed=!1}for(var n=0,r=this._samplerSharedGroups.length;n<r;++n){var a=this._samplerSharedGroups[n],s=a.sampler,o=a.samplerResultCache,l=0,u=!1;s?(l=s.sample(e))<0&&((l=~l)<=0?l=0:l>=s.ratios.length?l=s.ratios.length-1:(u=!0,o.from=l-1,o.fromRatio=s.ratios[o.from],o.to=l,o.toRatio=s.ratios[o.to])):l=0;for(var c=0,h=a.curves.length;c<h;++c){var f=a.curves[c];f.applySample(e,l,u,o,this.weight),void 0!==f.commonTargetIndex&&(this._commonTargetStatuses[f.commonTargetIndex].changed=!0)}}for(var _=0;_<this._commonTargetStatuses.length;++_){var d=this._commonTargetStatuses[_];d.changed&&d.target.push()}}},{key:"_sampleEvents",value:function(e){var t=this._clip.eventGroups.length,i=e.direction,n=this._clip.getEventGroupIndexAtRatio(e.ratio);if(n<0&&(n=~n-1,i<0&&(n+=1)),this._ignoreIndex!==n&&(this._ignoreIndex=-1),e.frameIndex=n,!this._lastWrapInfoEvent)return this._fireEvent(n),void(this._lastWrapInfoEvent=new BM(e));var r=this.wrapMode,a=mL(e.iterations),s=this._lastWrapInfoEvent,o=mL(s.iterations),l=s.frameIndex,u=s.direction,c=-1!==o&&a!==o;if(l===n&&c&&1===t)this._fireEvent(0);else if(l!==n||c){i=u;do{if(l!==n){if(-1===i&&0===l&&n>0?((r&wM.PingPong)===wM.PingPong?i*=-1:l=t,o++):1===i&&l===t-1&&n<t-1&&((r&wM.PingPong)===wM.PingPong?i*=-1:l=-1,o++),l===n)break;if(o>a)break}l+=i,cc.director.getAnimationManager().pushDelayEvent(this,"_fireEvent",[l])}while(l!==n&&l>-1&&l<t)}this._lastWrapInfoEvent.set(e)}},{key:"_fireEvent",value:function(e){if(this._targetNode&&this._targetNode.isValid){var t=this._clip.eventGroups;if(!(e<0||e>=t.length||this._ignoreIndex===e)){var i=t[e],n=this._targetNode.components,r=i.events,a=Array.isArray(r),s=0;for(r=a?r:r[Symbol.iterator]();;){var o;if(a){if(s>=r.length)break;o=r[s++]}else{if((s=r.next()).done)break;o=s.value}var l=o,u=l.functionName,c=n,h=Array.isArray(c),f=0;for(c=h?c:c[Symbol.iterator]();;){var _;if(h){if(f>=c.length)break;_=c[f++]}else{if((f=c.next()).done)break;_=f.value}var d=_,p=d[u];"function"==typeof p&&p.apply(d,l.parameters)}}}}}},{key:"curveLoaded",get:function(){return this._curveLoaded}}]),t}(_L));function mL(e){return e-(0|e)==0&&(e-=1),0|e}cc.AnimationState=pL;var vL,gL,yL,bL,EL,TL,SL,xL,AL,wL,CL,RL,kL,OL,IL,ML=function(e){function t(){var e;return i(this,t),(e=c(this,o(t).call(this)))._managedStates=[],e._fadings=[],e}return s(t,e),r(t,[{key:"update",value:function(e){if(this.isPlaying&&!this.isPaused){for(var t=0;t<this._managedStates.length;++t){var i=this._managedStates[t].state;i&&(i.weight=0)}for(var n=1,r=this._fadings.length,a=0;a<this._fadings.length;++a){if(0===n){r=a;break}var s=this._fadings[a];s.easeTime+=e;var o=di(s.easeTime/s.easeDuration),l=o*n;n*=1-o,s.target.state&&(s.target.state.weight+=l)}if(r!==this._fadings.length){for(var u=r;u<this._fadings.length;++u){var c=this._fadings[u];--c.target.reference,c.target.reference<=0&&(c.target.state&&c.target.state.stop(),de(this._managedStates,c.target))}this._fadings.splice(r)}}}},{key:"crossFade",value:function(e,t){0===t&&this.clear();var i=this._managedStates.find((function(t){return t.state===e}));i||(i={state:e,reference:0},e&&e.play(),this._managedStates.push(i)),++i.reference,this._fadings.unshift({easeDuration:t,easeTime:0,target:i})}},{key:"clear",value:function(){for(var e=0;e<this._managedStates.length;++e){var t=this._managedStates[e].state;t&&t.stop()}this._managedStates.length=0,this._fadings.length=0}},{key:"onPlay",value:function(){f(o(t.prototype),"onPlay",this).call(this),cc.director.getAnimationManager().addCrossFade(this)}},{key:"onPause",value:function(){f(o(t.prototype),"onPause",this).call(this),cc.director.getAnimationManager().removeCrossFade(this);for(var e=0;e<this._managedStates.length;++e){var i=this._managedStates[e].state;i&&i.pause()}}},{key:"onResume",value:function(){f(o(t.prototype),"onResume",this).call(this),cc.director.getAnimationManager().addCrossFade(this);for(var e=0;e<this._managedStates.length;++e){var i=this._managedStates[e].state;i&&i.resume()}}},{key:"onStop",value:function(){f(o(t.prototype),"onStop",this).call(this),cc.director.getAnimationManager().removeCrossFade(this),this.clear()}}]),t}(_L);!function(e){e.PLAY="play",e.STOP="stop",e.PAUSE="pause",e.RESUME="resume",e.LASTFRAME="lastframe",e.FINISHED="finished"}(IL||(IL=e("EventType",{}))),pt(IL);var LL=e("AnimationComponent",(vL=Es("cc.AnimationComponent"),gL=Rs(99),yL=Cs("Components/Animation"),bL=Ts({type:[aL],tooltip:""}),EL=Ts({type:aL,tooltip:""}),TL=Ts({tooltip:""}),SL=Ts({type:[aL]}),vL(xL=gL(xL=As(xL=yL((OL=kL=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),s=0;s<r;s++)a[s]=arguments[s];return m(n=c(this,(e=o(t)).call.apply(e,[this].concat(a))),"playOnLoad",wL,u(n)),n._callbackTable=we(!0),n._crossFade=new ML,n._nameToState=we(!0),m(n,"_clips",CL,u(n)),m(n,"_defaultClip",RL,u(n)),n}return s(t,e),r(t,[{key:"onLoad",value:function(){this.clips=this._clips;for(var e=0,t=Object.keys(this._nameToState);e<t.length;e++){var i=t[e];this._nameToState[i].initialize(this.node)}}},{key:"start",value:function(){this.playOnLoad&&this._defaultClip&&this.crossFade(this._defaultClip.name,0)}},{key:"onEnable",value:function(){this._crossFade.resume()}},{key:"onDisable",value:function(){this._crossFade.pause()}},{key:"onDestroy",value:function(){this._crossFade.stop();for(var e=0,t=Object.keys(this._nameToState);e<t.length;e++){var i=t[e];this._nameToState[i].stop()}this._nameToState=we(!0)}},{key:"play",value:function(e){if(!e){if(!this._defaultClip)return;e=this._defaultClip.name}this.crossFade(e,0)}},{key:"crossFade",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.3,i=this._nameToState[e];i&&(this._crossFade.play(),this._crossFade.crossFade(i,t))}},{key:"pause",value:function(){this._crossFade.pause()}},{key:"resume",value:function(){this._crossFade.resume()}},{key:"stop",value:function(){this._crossFade.stop()}},{key:"getAnimationState",value:function(e){return this.getState(e)}},{key:"getState",value:function(e){var t=this._nameToState[e];return t&&!t.curveLoaded&&t.initialize(this.node),t||null}},{key:"createState",value:function(e,t){return t=t||e.name,this.removeState(t),this._doCreateState(e,t)}},{key:"removeState",value:function(e){var t=this._nameToState[e];t&&(t.stop(),delete this._nameToState[e])}},{key:"addClip",value:function(e,t){return pe(this._clips,e)||this._clips.push(e),this.createState(e,t)}},{key:"removeClip",value:function(e,t){for(var i,n=0,r=Object.keys(this._nameToState);n<r.length;n++){var a=r[n];if((i=this._nameToState[a]).clip===e)break}if(e===this._defaultClip){if(!t)return void N(3902);this._defaultClip=null}if(i&&i.isPlaying){if(!t)return void N(3903);i.stop()}this._clips=this._clips.filter((function(t){return t!==e})),i&&delete this._nameToState[i.name]}},{key:"on",value:function(e,t,i){var n=ol.prototype.on.call(this,e,t,i);if("lastframe"===e)for(var r=0,a=Object.keys(this._nameToState);r<a.length;r++){var s=a[r];this._nameToState[s]._lastframeEventOn=!0}return n}},{key:"off",value:function(e,t,i){if("lastframe"===e)for(var n=this._nameToState,r=0,a=Object.keys(n);r<a.length;r++){n[a[r]]._lastframeEventOn=!1}ol.prototype.off.call(this,e,t,i)}},{key:"targetOff",value:function(e){}},{key:"once",value:function(e,t,i){}},{key:"dispatchEvent",value:function(e){}},{key:"hasEventListener",value:function(e,t,i){return!1}},{key:"removeAll",value:function(e){}},{key:"emit",value:function(e){}},{key:"_createState",value:function(e,t){return new pL(e,t)}},{key:"_doCreateState",value:function(e,t){var i=this._createState(e,t);return i._setEventTarget(this),this.node&&i.initialize(this.node),this._nameToState[i.name]=i,i}},{key:"_getStateByNameOrDefaultClip",value:function(e){if(!e){if(!this._defaultClip)return null;e=this._defaultClip.name}var t=this._nameToState[e];return t||null}},{key:"_removeStateOfAutomaticClip",value:function(e){for(var t in this._nameToState){var i=this._nameToState[t];FL(e,i.clip)&&(i.stop(),delete this._nameToState[t])}}},{key:"clips",get:function(){return this._clips},set:function(e){var t=this;this._crossFade&&this._crossFade.clear();var i=this._clips,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;s&&this._removeStateOfAutomaticClip(s)}var o=e,l=Array.isArray(o),u=0;for(o=l?o:o[Symbol.iterator]();;){var c;if(l){if(u>=o.length)break;c=o[u++]}else{if((u=o.next()).done)break;c=u.value}var h=c;h&&this.createState(h)}var f=e.find((function(e){return FL(e,t._defaultClip)}));this._defaultClip=f||null,this._clips=e}},{key:"defaultClip",get:function(){return this._defaultClip},set:function(e){(this._defaultClip=e,e)&&(this._clips.findIndex((function(t){return FL(t,e)}))>=0||(this._clips.push(e),this.createState(e)))}}]),t}(Ph),kL.EventType=IL,v((AL=OL).prototype,"clips",[bL],Object.getOwnPropertyDescriptor(AL.prototype,"clips"),AL.prototype),v(AL.prototype,"defaultClip",[EL],Object.getOwnPropertyDescriptor(AL.prototype,"defaultClip"),AL.prototype),wL=v(AL.prototype,"playOnLoad",[TL],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),CL=v(AL.prototype,"_clips",[SL],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),RL=v(AL.prototype,"_defaultClip",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),xL=AL))||xL)||xL)||xL)||xL)),PL=LL.prototype,BL=PL.on,DL=PL.off;function FL(e,t){return e===t||!(!e||!t||e.name!==t.name&&e._uuid!==t._uuid)}ll(LL,[al,ol]),LL.prototype.on=BL,LL.prototype.off=DL,cc.AnimationComponent=LL,sr(LL.prototype,"AnimationComponent",[{name:"getAnimationState",newName:"getState"},{name:"removeClip",newName:"removeState",customFunction:function(){var e=arguments.length<=0?void 0:arguments[0];return LL.prototype.removeState.call(this,e.name)}}]);var NL,zL,UL,GL=function(){function e(){i(this,e),this._blendTargets=[]}return r(e,[{key:"refPropertyBlendTarget",value:function(e,t){var i=this._blendTargets.find((function(t){return t.target===e}));i||(i={target:e,properties:[]},this._blendTargets.push(i));var n=i.properties,r=n.find((function(e){return e.name===t}));return r||(r={name:t,weight:0,value:void 0,refCount:0},n.push(r)),++r.refCount,r}},{key:"deRefPropertyBlendTarget",value:function(e,t){var i=this._blendTargets.findIndex((function(t){return t.target===e}));if(!(i<0)){var n=this._blendTargets[i].properties,r=n.findIndex((function(e){return e.name===t}));if(!(r<0)){var a=n[r];--a.refCount,a.refCount>0||(n.length>=2?n.splice(r,1):this._blendTargets.splice(i,1))}}}},{key:"apply",value:function(){for(var e=this._blendTargets,t=0;t<e.length;t++)for(var i=e[t],n=i.target,r=i.properties,a=0;a<r.length;a++){var s=r[a];0!==s.weight&&(n instanceof o_?"position"===s.name?n.setPosition(s.value):"rotation"===s.name?n.setRotation(s.value):n.setScale(s.value):n[s.name]=s.value)}}},{key:"clear",value:function(){for(var e=this._blendTargets,t=0;t<e.length;t++){var i=e[t].properties,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}a.weight=0}}}}]),e}(),VL=e("AnimationManager",Es((UL=zL=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),s=0;s<r;s++)a[s]=arguments[s];return(n=c(this,(e=o(t)).call.apply(e,[this].concat(a))))._anims=new fe([]),n._delayEvents=[],n._blendState=new GL,n._crossFades=[],n}return s(t,e),r(t,[{key:"addCrossFade",value:function(e){this._crossFades.push(e)}},{key:"removeCrossFade",value:function(e){de(this._crossFades,e)}},{key:"update",value:function(e){var t=this._crossFades,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.update(e)}this._blendState.clear();var a=this._anims,s=a.array;for(a.i=0;a.i<s.length;++a.i){var o=s[a.i];o.isPlaying&&!o.isPaused&&o.update(e)}this._blendState.apply();for(var l=this._delayEvents,u=0,c=l.length;u<c;u++){var h=l[u];h.target[h.func].apply(h.target,h.args)}l.length=0}},{key:"destruct",value:function(){}},{key:"addAnimation",value:function(e){-1===this._anims.array.indexOf(e)&&(e.attachToBlendState(this._blendState),this._anims.push(e))}},{key:"removeAnimation",value:function(e){var t=this._anims.array.indexOf(e);t>=0?(e.detachFromBlendState(this._blendState),this._anims.fastRemoveAt(t)):U(3907)}},{key:"pushDelayEvent",value:function(e,t,i){this._delayEvents.push({target:e,func:t,args:i})}},{key:"blendState",get:function(){return this._blendState}}]),t}(GC),zL.ID="animation",NL=UL))||NL);vR.on(sR.EVENT_INIT,(function(){var e=new VL;vR.registerSystem(VL.ID,e,qC.PRIORITY_SYSTEM)})),cc.AnimationManager=VL;var HL=new Bn;function WL(e,t,i){for(Bn.identity(i);e!==t;)Bn.fromRTS(HL,e.rotation,e.position,e.scale),Bn.multiply(i,HL,i),e=e.parent}var jL,XL,qL,YL,KL,ZL,QL,JL,$L,eP,tP,iP,nP,rP,aP,sP,oP=new Bn,lP=[],uP=e("SkeletalAnimationState",function(e){function t(e){var n,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",a=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];return i(this,t),(n=c(this,o(t).call(this,e,r)))._preSample=!0,n._frames=1,n._animInfo=null,n._sockets=[],n._preSample=a,n}return s(t,e),r(t,[{key:"initialize",value:function(e){if(!this._curveLoaded)if(this._preSample){var i=f_.getOrExtract(this.clip).info;f(o(t.prototype),"initialize",this).call(this,e,lP),this._frames=i.frames-1,this._animInfo=cc.director.root.dataPoolManager.jointsAnimationInfo.create(e.uuid),this.duration=this._frames/i.sample}else f(o(t.prototype),"initialize",this).call(this,e)}},{key:"onPlay",value:function(){f(o(t.prototype),"onPlay",this).call(this);for(var e=this._targetNode.getComponentsInChildren(vI),i=0;i<e.length;++i){var n=e[i];n.skinningRoot===this._targetNode&&n.uploadAnimation(this.clip)}}},{key:"rebuildSocketCurves",value:function(e){this._sockets.length=0;for(var t=0;t<e.length;++t){var i=this._buildSocketData(e[t]);i&&this._sockets.push(i)}}},{key:"_sampleCurves",value:function(e){var t=this._animInfo,i=e*this._frames+.5|0;t.data[1]=i,t.dirty=!0;for(var n=0;n<this._sockets.length;++n){var r=this._sockets[n],a=r.target,s=r.frames;a.matrix=s[i]}}},{key:"_buildSocketData",value:function(e){if(!this._targetNode)return null;var t=this._targetNode.getChildByPath(e.path);if(!t||!e.target)return null;for(var i=e.path,n=f_.getOrExtract(this.clip).data,r=i,a=n[r],s=t;!a;){var o=r.lastIndexOf("/");if(a=n[r=r.substring(0,o)],s=s.parent,o<0)return null}var l={target:e.target,frames:a.worldMatrix.values.map((function(e){return e.clone()}))};WL(t,s,oP);for(var u=0;u<l.frames.length;u++){var c=l.frames[u];Bn.multiply(c,c,oP)}return l}}]),t}(pL));cc.SkeletalAnimationState=uP;var cP=e("Socket",(jL=Es("cc.SkeletalAnimationComponent.Socket"),XL=Ts(o_),jL((KL=v((YL=function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;i(this,e),m(this,"path",KL,this),m(this,"target",ZL,this),this.path=t,this.target=n}).prototype,"path",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),ZL=v(YL.prototype,"target",[XL],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),qL=YL))||qL)),hP=new Bn,fP=new Bn;function _P(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],n=0;n<e.children.length;n++){var r=e.children[n];if(r){var a=t?"".concat(t,"/").concat(r.name):r.name;i.push(a),_P(r,a,i)}}return i}var dP,pP,mP,vP,gP=e("SkeletalAnimationComponent",(QL=Es("cc.SkeletalAnimationComponent"),JL=Rs(99),$L=Cs("Components/SkeletalAnimation"),eP=Ts({type:[cP]}),tP=Ts({type:[cP],tooltip:"Joint Sockets"}),QL(iP=JL(iP=As(iP=$L((sP=aP=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),s=0;s<r;s++)a[s]=arguments[s];return m(n=c(this,(e=o(t)).call.apply(e,[this].concat(a))),"_sockets",rP,u(n)),n._enablePreSample=!0,n}return s(t,e),r(t,[{key:"onDestroy",value:function(){f(o(t.prototype),"onDestroy",this).call(this),cc.director.root.dataPoolManager.jointsAnimationInfo.destroy(this.node.uuid)}},{key:"start",value:function(){f(o(t.prototype),"start",this).call(this),this.sockets=this._sockets}},{key:"querySockets",value:function(){var e=this._defaultClip&&Object.keys(f_.getOrExtract(this._defaultClip).data).sort().reduce((function(e,t){return t.startsWith(e[e.length-1])?e:(e.push(t),e)}),[])||[];if(!e.length)return["default animation clip missing/invalid"];for(var t=[],i=0;i<e.length;i++){var n=e[i],r=this.node.getChildByPath(n);r&&(t.push(n),_P(r,n,t))}return t}},{key:"rebuildSocketAnimations",value:function(){var e=this._sockets,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n,a=this.node.getChildByPath(r.path),s=r.target;a&&s&&(s.name="".concat(r.path.substring(r.path.lastIndexOf("/")+1)," Socket"),s.parent=this.node,WL(a,this.node,hP),Bn.fromRTS(fP,s.rotation,s.position,s.scale),Bn.equals(fP,hP)||(s.matrix=hP))}for(var o=0,l=Object.keys(this._nameToState);o<l.length;o++){var u=l[o];this._nameToState[u].rebuildSocketCurves(this._sockets)}}},{key:"createSocket",value:function(e){var t=this._sockets.find((function(t){return t.path===e}));if(t)return t.target;if(!this.node.getChildByPath(e))return console.warn("illegal socket path"),null;var i=new o_;return i.parent=this.node,this._sockets.push(new cP(e,i)),this.rebuildSocketAnimations(),i}},{key:"_createState",value:function(e,t){return new uP(e,t,this._enablePreSample)}},{key:"_doCreateState",value:function(e,i){var n=f(o(t.prototype),"_doCreateState",this).call(this,e,i);return n.rebuildSocketCurves(this._sockets),n}},{key:"sockets",get:function(){return this._sockets},set:function(e){this._sockets=e,this.rebuildSocketAnimations()}},{key:"enablePreSample",set:function(e){this._enablePreSample=e,this.clips=this._clips},get:function(){return this._enablePreSample}}]),t}(LL),aP.Socket=cP,rP=v((nP=sP).prototype,"_sockets",[eP],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),v(nP.prototype,"sockets",[tP],Object.getOwnPropertyDescriptor(nP.prototype,"sockets"),nP.prototype),iP=nP))||iP)||iP)||iP)||iP));cc.SkeletalAnimationComponent=gP,cc.easing=SM;var yP=e("HierachyModifier",Es("cc.HierachyModifier")(dP=function(e){function t(){return i(this,t),c(this,o(t).apply(this,arguments))}return s(t,e),t}(c_))||dP);cc.HierachyModifier=yP;var bP=e("ComponentModifier",Es("cc.ComponentModifier")(pP=function(e){function t(){return i(this,t),c(this,o(t).apply(this,arguments))}return s(t,e),t}(h_))||pP);cc.ComponentModifier=bP;var EP=e("CurveValueAdapter",Es("cc.CurveValueAdapter")(mP=function(){function e(){i(this,e)}return r(e,[{key:"forTarget",value:function(e){return{set:function(){}}}}]),e}())||mP);cc.CurveValueAdapter=EP;var TP=e("UniformCurveValueAdapter",Es("cc.UniformCurveValueAdapter")(vP=function(e){function t(){return i(this,t),c(this,o(t).apply(this,arguments))}return s(t,e),t}(zI))||vP);function SP(e){return"string"==typeof e}function xP(e){return"number"==typeof e}function AP(e,t){return e instanceof t}cc.UniformCurveValueAdapter=TP,cc.isPropertyModifier=SP,cc.isElementModifier=xP,cc.isCustomTargetModifier=AP;var wP,CP=function(){function e(t,n,r){i(this,e),this._total=0,this._value=0,this._averageValue=0,this._accumValue=0,this._accumSamples=0,this._id=t,this._opts=n,this._accumStart=r}return r(e,[{key:"value",get:function(){return this._value},set:function(e){this._value=e}}]),r(e,[{key:"sample",value:function(e){this._average(this._value,e)}},{key:"human",value:function(){var e=this._opts,t=e.average,i=e.isInteger,n=t?this._averageValue:this._value;return i?Math.round(n):Math.round(100*n)/100}},{key:"alarm",value:function(){return this._opts.below&&this._value<this._opts.below||this._opts.over&&this._value>this._opts.over}},{key:"_average",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(this._opts.average){this._accumValue+=e,++this._accumSamples;var i=t;i-this._accumStart>=this._opts.average&&(this._averageValue=this._accumValue/this._accumSamples,this._accumValue=0,this._accumStart=i,this._accumSamples=0)}}}]),e}(),RP=Es("cc.PerfCounter")(wP=function(e){function t(e,n,r){var a;return i(this,t),(a=c(this,o(t).call(this,e,n,r)))._time=r,a}return s(t,e),r(t,[{key:"start",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;this._time=e}},{key:"end",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;this._value=e-this._time,this._average(this._value)}},{key:"tick",value:function(){this.end(),this.start()}},{key:"frame",value:function(e){var t=e,i=t-this._time;this._total++,i>(this._opts.average||1e3)&&(this._value=1e3*this._total/i,this._total=0,this._time=t,this._average(this._value))}}]),t}(CP))||wP,kP={0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,".":10},OP={frame:{desc:"Frame time (ms)",min:0,max:50,average:500},fps:{desc:"Framerate (FPS)",below:30,average:500,isInteger:!0},draws:{desc:"Draw call",isInteger:!0},tricount:{desc:"Triangle",isInteger:!0},logic:{desc:"Game Logic (ms)",min:0,max:50,average:500,color:"#080"},physics:{desc:"Physics (ms)",min:0,max:50,average:500},render:{desc:"Renderer (ms)",min:0,max:50,average:500,color:"#f90"},textureMemory:{desc:"GFX Texture Mem(M)"},bufferMemory:{desc:"GFX Buffer Mem(M)"}},IP=24,MP=.18,LP=8,PP=256,BP=256,DP=e("Profiler",function(){function e(){i(this,e),this._stats=null,this.id="__Profiler__",this._showFPS=!1,this._rootNode=null,this._device=null,this._canvas=null,this._ctx=null,this._texture=null,this._textureView=null,this._region=new Uo,this._canvasArr=[],this._regionArr=[this._region],this.digitsData=null,this._canvasDone=!1,this._statsDone=!1,this._inited=!1,this._lineHeight=BP/(Object.keys(OP).length+1),this._wordHeight=0,this._eachNumWidth=0,this._totalLines=0,this.lastTime=0,this._uvOffset=[],this._canvas=document.createElement("canvas"),this._ctx=this._canvas.getContext("2d"),this._region=new Uo,this._canvasArr.push(this._canvas)}return r(e,[{key:"isShowingStats",value:function(){return this._showFPS}},{key:"hideStats",value:function(){this._showFPS&&(this._rootNode&&(this._rootNode.active=!1),cc.director.off(cc.Director.EVENT_BEFORE_UPDATE,this.beforeUpdate,this),cc.director.off(cc.Director.EVENT_AFTER_UPDATE,this.afterUpdate,this),cc.director.off(cc.Director.EVENT_BEFORE_PHYSICS,this.beforePhysics,this),cc.director.off(cc.Director.EVENT_AFTER_PHYSICS,this.afterPhysics,this),cc.director.off(cc.Director.EVENT_BEFORE_DRAW,this.beforeDraw,this),cc.director.off(cc.Director.EVENT_AFTER_DRAW,this.afterDraw,this),this._showFPS=!1)}},{key:"showStats",value:function(){this._showFPS||(this.initDevice(),this.generateCanvas(),this.generateStats(),cc.game.once(cc.Game.EVENT_ENGINE_INITED,this.generateNode,this),this._rootNode&&(this._rootNode.active=!0),cc.director.on(cc.Director.EVENT_BEFORE_UPDATE,this.beforeUpdate,this),cc.director.on(cc.Director.EVENT_AFTER_UPDATE,this.afterUpdate,this),cc.director.on(cc.Director.EVENT_BEFORE_PHYSICS,this.beforePhysics,this),cc.director.on(cc.Director.EVENT_AFTER_PHYSICS,this.afterPhysics,this),cc.director.on(cc.Director.EVENT_BEFORE_DRAW,this.beforeDraw,this),cc.director.on(cc.Director.EVENT_AFTER_DRAW,this.afterDraw,this),this._showFPS=!0,this._canvasDone=!0,this._statsDone=!0)}},{key:"initDevice",value:function(){this._device||(this._device=cc.director.root.device)}},{key:"generateCanvas",value:function(){if(!this._canvasDone){var e=PP,t=BP;this._ctx&&this._canvas&&(this._canvas.width=e,this._canvas.height=t,this._canvas.style.width="".concat(this._canvas.width),this._canvas.style.height="".concat(this._canvas.height),this._ctx.font="".concat(IP,"px Arial"),this._ctx.textBaseline="top",this._ctx.fillStyle="#fff",this._texture=this._device.createTexture({type:bo.TEX2D,usage:Eo.SAMPLED,format:no.RGBA8,width:e,height:t,mipLevel:1}),this._textureView=this._device.createTextureView({texture:this._texture,type:xo.TV2D,format:no.RGBA8}),this._region.texExtent.width=e,this._region.texExtent.height=t)}}},{key:"generateStats",value:function(){if(!this._statsDone&&this._ctx&&this._canvas){this._stats=null;var e=performance.now();this._ctx.textAlign="left";var t=0;for(var i in OP){var n=OP[i];this._ctx.fillText(n.desc,0,t*this._lineHeight),n.counter=new RP(i,n,e),t++}this._totalLines=t,this._wordHeight=this._totalLines*this._lineHeight/this._canvas.height;var r=new Array;r[0]=0;for(var a=0;a<"0123456789. ".length;++a){var s=this._ctx.measureText("0123456789. "[a]).width;this._eachNumWidth=Math.max(this._eachNumWidth,s),r[a+1]=r[a]+s/this._canvas.width}for(var o=0;o<"0123456789. ".length;++o)this._ctx.fillText("0123456789. "[o],o*this._eachNumWidth,this._totalLines*this._lineHeight);this._eachNumWidth/=this._canvas.width;for(var l=Math.ceil(r.length/4),u=0;u<l;u++)this._uvOffset.push(new qi(r[4*u],r[4*u+1],r[4*u+2],r[4*u+3]));this._stats=OP,this._canvasArr[0]=this._canvas,this.updateTexture()}}},{key:"generateNode",value:function(){if(!this._rootNode||!this._rootNode.isValid){this._rootNode=new o_("PROFILER_NODE"),cc.game.addPersistRootNode(this._rootNode);var e=new o_("Profiler_Camera");e.setPosition(0,0,1),e.parent=this._rootNode;var t=e.addComponent("cc.CameraComponent");t.projection=Pk.ProjectionType.ORTHO,t.near=0,t.far=0,t.orthoHeight=this._device.height,t.visibility=du.BitMask.PROFILER,t.clearFlags=Bo.NONE,t.priority=4294967295,t.flows=["UIFlow"];var i=new o_("Profiler_Root");i.parent=this._rootNode;for(var n=MP,r=n/this._totalLines,a=n/this._wordHeight,s=r/IP,o=this._eachNumWidth*this._canvas.width*s,l=[0,n,0,a,n,0,a,0,0,0,0,0],u=[0,2,1,0,3,2],c=[0,0,-1,0,1,0,-1,0,1,this._wordHeight,-1,0,0,this._wordHeight,-1,0],h=0,f=0;f<this._totalLines;f++)for(var _=0;_<LP;_++){l.push(a+_*o,n-f*r,0),l.push(a+(_+1)*o,n-f*r,0),l.push(a+(_+1)*o,n-(f+1)*r,0),l.push(a+_*o,n-(f+1)*r,0),h=4*(f*LP+_+1),u.push(0+h,2+h,1+h,0+h,3+h,2+h);var d=f*LP+_,p=Math.floor(d/4),m=d-4*p;c.push(0,this._wordHeight,p,m),c.push(this._eachNumWidth,this._wordHeight,p,m),c.push(this._eachNumWidth,1,p,m),c.push(0,1,p,m)}var v=i.addComponent("cc.ModelComponent");v.mesh=xA({positions:l,indices:u,colors:c});var g=new np;g.initialize({effectName:"util/profiler"}),g.setProperty("offset",new qi(-.9,-.9,this._eachNumWidth,0));var y=g.passes[0],b=y.getBinding("mainTexture"),E=y.getBinding("digits");y.bindTextureView(b,this._textureView),this.digitsData=y.blocks[E],v.material=g,v.node.layer=du.Enum.PROFILER,this._inited=!0}}},{key:"beforeUpdate",value:function(){if(this._stats){var e=performance.now();this.getCounter("frame").end(e),this.getCounter("frame").start(e),this.getCounter("logic").start(e)}}},{key:"afterUpdate",value:function(){if(this._stats){var e=performance.now();cc.director.isPaused()?this.getCounter("frame").start(e):this.getCounter("logic").end(e)}}},{key:"beforePhysics",value:function(){if(this._stats){var e=performance.now();this.getCounter("physics").start(e)}}},{key:"afterPhysics",value:function(){if(this._stats){var e=performance.now();this.getCounter("physics").end(e)}}},{key:"beforeDraw",value:function(){if(this._stats){var e=performance.now();this.getCounter("render").start(e)}}},{key:"afterDraw",value:function(){if(this._stats&&this._inited){var e=performance.now();if(this.getCounter("fps").frame(e),this.getCounter("render").end(e),!(e-this.lastTime<500)){this.lastTime=e;var t=this._device;this.getCounter("draws").value=t.numDrawCalls,this.getCounter("bufferMemory").value=t.memoryStatus.bufferSize/1048576,this.getCounter("textureMemory").value=t.memoryStatus.textureSize/1048576,this.getCounter("tricount").value=t.numTris;var i=0,n=this.digitsData.view;for(var r in this._stats){var a=this._stats[r];a.counter.sample(e);for(var s=a.counter.human().toString(),o=LP-1;o>=0;o--){var l=i*LP+o,u=s[s.length-(LP-o)],c=kP[u];void 0===c&&(c=11),n[l]=c}i++}this.digitsData.dirty=!0}}}},{key:"getCounter",value:function(e){return this._stats[e].counter}},{key:"updateTexture",value:function(){cc.director.root.device.copyTexImagesToTexture(this._canvasArr,this._texture,this._regionArr)}}]),e}()),FP=e("profiler",new DP);cc.profiler=FP;var NP={};function zP(e,t,i){var n=e.createShader(t);if(n){if(e.shaderSource(n,i),e.compileShader(n),e.getShaderParameter(n,e.COMPILE_STATUS))return n;console.error("compile shader error",n),console.log(e.getShaderInfoLog(n)),e.deleteShader(n)}else console.error("create shader error",i)}sr(NP,"vmath",[{name:"vec2",newName:"Vec2",target:dr,targetName:"math"},{name:"vec3",newName:"Vec3",target:dr,targetName:"math"},{name:"vec4",newName:"Vec4",target:dr,targetName:"math"},{name:"quat",newName:"Quat",target:dr,targetName:"math"},{name:"mat3",newName:"Mat3",target:dr,targetName:"math"},{name:"mat4",newName:"Mat4",target:dr,targetName:"math"},{name:"color4",newName:"Color",target:dr,targetName:"math"},{name:"rect",newName:"Rect",target:dr,targetName:"math"},{name:"approx",newName:"approx",target:dr,targetName:"math"},{name:"EPSILON",newName:"EPSILON",target:dr,targetName:"math"},{name:"equals",newName:"equals",target:dr,targetName:"math"},{name:"clamp",newName:"clamp",target:dr,targetName:"math"},{name:"clamp01",newName:"clamp01",target:dr,targetName:"math"},{name:"lerp",newName:"lerp",target:dr,targetName:"math"},{name:"toRadian",newName:"toRadian",target:dr,targetName:"math"},{name:"toDegree",newName:"toDegree",target:dr,targetName:"math"},{name:"random",newName:"random",target:dr,targetName:"math"},{name:"randomRange",newName:"randomRange",target:dr,targetName:"math"},{name:"randomRangeInt",newName:"randomRangeInt",target:dr,targetName:"math"},{name:"pseudoRandom",newName:"pseudoRandom",target:dr,targetName:"math"},{name:"pseudoRandomRangeInt",newName:"pseudoRandomRangeInt",target:dr,targetName:"math"},{name:"nextPow2",newName:"nextPow2",target:dr,targetName:"math"},{name:"repeat",newName:"repeat",target:dr,targetName:"math"},{name:"pingPong",newName:"pingPong",target:dr,targetName:"math"},{name:"inverseLerp",newName:"inverseLerp",target:dr,targetName:"math"}]),cc.vmath=NP,sr(qC.prototype,"Scheduler.prototype",[{name:"enableForTarget",newName:"enableForTarget",target:qC,targetName:"Scheduler"}]);var UP=function(){function e(){i(this,e),this.logoImage=new Image,this.textImage=document.createElement("canvas"),this.vertices=new Float32Array([-1,-1,-1,1,1,-1,1,-1,-1,1,1,1]),this.texcoords=new Float32Array([0,0,0,1,1,0,1,0,0,1,1,1]),this.logoMat33=new Float32Array([1,0,0,0,1,0,0,0,1]),this.textMat33=new Float32Array([1,0,0,0,1,0,0,0,1]),this.callBack=null,this.cancelAnimate=!1,this.handle=-1,this.startTime=-1,this._isStart=!1,this._directCall=!1,this._splashFinish=!1,this._loadFinish=!1}return r(e,[{key:"_tryToStart",value:function(){this._splashFinish&&this._loadFinish&&this.callBack&&(this.cancelAnimate=!0,cancelAnimationFrame(this.handle),this.destroy(),this.callBack())}},{key:"setOnFinish",value:function(t){if((!this._isStart||this._directCall)&&t)return delete e._ins,t();this.callBack=t}},{key:"main",value:function(e){if(window._CCSettings&&window._CCSettings.splashScreen?(this.setting=window._CCSettings.splashScreen,this.setting.totalTime=null!=this.setting.totalTime?this.setting.totalTime:3e3,this.setting.base64src=null!=this.setting.base64src?this.setting.base64src:"",this.setting.effect=null!=this.setting.effect?this.setting.effect:"Fade-InOut",this.setting.clearColor=null!=this.setting.clearColor?this.setting.clearColor:{r:.88,g:.88,b:.88,a:1},this.setting.displayRatio=null!=this.setting.displayRatio?this.setting.displayRatio:.4,this.setting.displayWatermark=null==this.setting.displayWatermark||this.setting.displayWatermark):this.setting={totalTime:3e3,base64src:"",effect:"Fade-InOut",clearColor:{r:.88,g:.88,b:.88,a:1},displayRatio:.4,displayWatermark:!0},null==e||""==this.setting.base64src||this.setting.totalTime<=0)return this.callBack&&this.callBack(),this.callBack=null,this.setting=null,void(this._directCall=!0);var t=!!window.WebGL2RenderingContext,i=window.navigator.userAgent.toLowerCase();(-1!==i.indexOf("safari")&&-1===i.indexOf("chrome")||Il.browserType===Il.BROWSER_TYPE_UC)&&(t=!1);var n={alpha:jS.ENABLE_TRANSPARENT_CANVAS,antialias:!0,depth:!0,stencil:!0,premultipliedAlpha:!0,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1},r=null,a=null;if(t&&cc.WebGL2GFXDevice?null==(a=e.getContext("webgl2",n))&&(r=e.getContext("webgl",n)):r=e.getContext("webgl",n),null==r&&null==a)return console.error("this device does not support webgl");null!=r&&(this.gl=r),null!=a&&(this.gl=a);var s=this.textImage;s.width=300,s.height=30,s.style.width="".concat(s.width),s.style.height="".concat(s.height);var o=s.getContext("2d");o.font="".concat(18,"px Arial"),o.textBaseline="top",o.textAlign="left",o.fillStyle="`#424242`",o.fillText("Powered by Cocos Creator 3D",30,8),this.logoImage.onload=this.init.bind(this),this.logoImage.src=this.setting.base64src,this._isStart=!0}},{key:"init",value:function(){var e=this;this.initMatrix(),this.initProgram(),this.initBuffer(),this.initTexture(),this.initState();var t=this;this.handle=requestAnimationFrame((function i(n){e.cancelAnimate||(t.frame(n),requestAnimationFrame(i))}))}},{key:"initMatrix",value:function(){var e=this.gl.canvas.width,t=this.gl.canvas.height,i=this.setting.displayRatio,n=this.logoImage.width/2,r=this.logoImage.height/2,a=this.textImage.width/2,s=this.textImage.height/2;e<t?(r=(n=e/2*i)/(this.logoImage.width/this.logoImage.height),s=(a=e/2*.5)/(this.textImage.width/this.textImage.height)):(r=(n=t/2*i)/(this.logoImage.width/this.logoImage.height),s=(a=t/2*.5)/(this.textImage.width/this.textImage.height)),this.logoMat33[0]=n,this.logoMat33[4]=r,this.logoMat33[6]=e/2,this.logoMat33[7]=t/2,this.textMat33[0]=a,this.textMat33[4]=s,this.textMat33[6]=e/2,this.textMat33[7]=.9*t}},{key:"initProgram",value:function(){var e=this.gl;this.vertexShader=zP(e,e.VERTEX_SHADER,"precision mediump float;attribute vec2 a_position;attribute vec2 a_texCoord;uniform vec2 u_resolution;uniform mat3 u_worldMat;varying vec2 v_texCoord;void main() {vec3 wpos = u_worldMat * vec3(a_position, 1.0);vec2 clipSpace = wpos.xy / u_resolution * 2.0 - 1.0;gl_Position = vec4(clipSpace * vec2(1, -1), 0, 1);v_texCoord = a_texCoord;}"),this.fragmentShader=zP(e,e.FRAGMENT_SHADER,"precision mediump float;uniform float u_alpha;uniform sampler2D u_image;varying vec2 v_texCoord;void main(){gl_FragColor = texture2D(u_image,v_texCoord);gl_FragColor.xyz *= clamp(u_alpha, 0.0, 1.0);}"),this.program=function(e,t,i){var n=e.createProgram();if(n){e.attachShader(n,t),e.attachShader(n,i),e.linkProgram(n);var r=e.getProgramParameter(n,e.LINK_STATUS);if(r)return n;console.error("link program error",r),console.log(e.getProgramInfoLog(n)),e.deleteProgram(n)}else console.error("create program error")}(e,this.vertexShader,this.fragmentShader)}},{key:"initBuffer",value:function(){var e=this.gl;e.useProgram(this.program),this.positionBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.positionBuffer),e.bufferData(e.ARRAY_BUFFER,this.vertices,e.STATIC_DRAW),this.texcoordBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.texcoordBuffer),e.bufferData(e.ARRAY_BUFFER,this.texcoords,e.STATIC_DRAW);var t=e.getAttribLocation(this.program,"a_position");e.enableVertexAttribArray(t),e.bindBuffer(e.ARRAY_BUFFER,this.positionBuffer);var i=2,n=e.FLOAT,r=!1,a=0,s=0;e.vertexAttribPointer(t,i,n,r,a,s);var o=e.getAttribLocation(this.program,"a_texCoord");e.enableVertexAttribArray(o),e.bindBuffer(e.ARRAY_BUFFER,this.texcoordBuffer);i=2,n=e.FLOAT,r=!1,a=0,s=0;e.vertexAttribPointer(o,i,n,r,a,s)}},{key:"initTexture",value:function(){var e=this.gl;this.textureLogo=e.createTexture(),e.bindTexture(e.TEXTURE_2D,this.textureLogo),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,this.logoImage),this.textureText=e.createTexture(),e.bindTexture(e.TEXTURE_2D,this.textureText),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,this.textImage)}},{key:"initState",value:function(){var e=this.gl;e.useProgram(this.program);var t=e.getUniformLocation(this.program,"u_resolution");e.uniform2f(t,e.canvas.width,e.canvas.height),e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA)}},{key:"frame",value:function(e){var t=this.gl,i=this.program,n=this.textureLogo,r=this.textureText,a=this.setting.clearColor,s=this.logoMat33,o=this.textMat33;this.startTime<0&&(this.startTime=e);var l=e-this.startTime,u=KI(di(l/this.setting.totalTime));t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),t.bindFramebuffer(t.FRAMEBUFFER,null),t.viewport(0,0,t.canvas.width,t.canvas.height),t.clearColor(a.r,a.g,a.b,a.a),t.depthMask(!0),t.clearDepth(1),t.clearStencil(0),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT|t.STENCIL_BUFFER_BIT),t.useProgram(this.program);var c=t.getUniformLocation(this.program,"u_resolution");t.uniform2f(c,t.canvas.width,t.canvas.height);var h=t.getUniformLocation(i,"u_alpha");t.uniform1f(h,u),h=t.getUniformLocation(i,"u_worldMat"),t.uniformMatrix3fv(h,!1,s),t.bindTexture(t.TEXTURE_2D,n),t.drawArrays(t.TRIANGLES,0,6),this.setting.displayWatermark&&(t.uniformMatrix3fv(h,!1,o),t.bindTexture(t.TEXTURE_2D,r),t.drawArrays(t.TRIANGLES,0,6)),l>this.setting.totalTime&&(this.splashFinish=!0)}},{key:"destroy",value:function(){delete e._ins,this.gl.deleteProgram(this.program),this.gl.deleteShader(this.vertexShader),this.gl.deleteShader(this.fragmentShader),this.gl.deleteBuffer(this.positionBuffer),this.gl.deleteBuffer(this.texcoordBuffer),this.gl.deleteTexture(this.textureLogo),this.gl.deleteTexture(this.textureText)}},{key:"loadFinish",set:function(e){this._loadFinish=e,this._tryToStart()}},{key:"splashFinish",set:function(e){this._splashFinish=e,this._tryToStart()}}],[{key:"instance",get:function(){return null==e._ins&&(e._ins=new e),e._ins}}]),e}();cc.internal.SplashScreenWebgl=UP,cc.math=dr,cc.geometry=Ka;var GP,VP,HP,WP,jP,XP,qP,YP=e("NodePool",function(){function e(t){i(this,e),this.poolHandlerComp=t,this._pool=[]}return r(e,[{key:"size",value:function(){return this._pool.length}},{key:"clear",value:function(){for(var e=this._pool.length,t=0;t<e;++t)this._pool[t].destroy();this._pool.length=0}},{key:"put",value:function(e){if(e&&-1===this._pool.indexOf(e)){e.removeFromParent();var t=this.poolHandlerComp?e.getComponent(this.poolHandlerComp):null;t&&t.unuse&&t.unuse(),this._pool.push(e)}}},{key:"get",value:function(){var e=this._pool.length-1;if(e<0)return null;var t=this._pool[e];this._pool.length=e;var i=this.poolHandlerComp?t.getComponent(this.poolHandlerComp):null;if(i&&i.reuse){for(var n,r=arguments.length,a=new Array(r),s=0;s<r;s++)a[s]=arguments[s];(n=i.reuse).apply.apply(n,[i].concat(a))}return t}}]),e}());cc.NodePool=YP,function(e){e[e.BOX=0]="BOX",e[e.SPHERE=1]="SPHERE",e[e.CYLINDER=2]="CYLINDER",e[e.CONE=3]="CONE",e[e.CAPSULE=4]="CAPSULE",e[e.TORUS=5]="TORUS",e[e.PLANE=6]="PLANE",e[e.QUAD=7]="QUAD"}(qP||(qP={})),pt(qP);var KP=e("Primitive",(GP=Es("cc.Primitive"),VP=Ts({type:qP}),GP((jP=v((WP=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),s=0;s<r;s++)a[s]=arguments[s];return m(n=c(this,(e=o(t)).call.apply(e,[this].concat(a))),"type",jP,u(n)),m(n,"info",XP,u(n)),n}return s(t,e),r(t,[{key:"onLoaded",value:function(){xA(JA[qP[this.type]](this.info),this)}}]),t}(su)).prototype,"type",[VP],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return qP.BOX}}),XP=v(WP.prototype,"info",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{}}}),HP=WP))||HP));cc.Primitive=KP,cc.renderer=Fw;e("cclegacy",cc);cc.primitives=JA;var ZP,QP=function(e){function t(e){var n;return i(this,t),(n=c(this,o(t).call(this,e)))._gpuBindingLayout=null,n}return s(t,e),r(t,[{key:"gpuBindingLayout",get:function(){return this._gpuBindingLayout}}]),r(t,[{key:"initialize",value:function(e){this._bindingUnits=new Array(e.bindings.length);for(var t=0;t<e.bindings.length;++t){var i=e.bindings[t];this._bindingUnits[t]={binding:i.binding,type:i.bindingType,name:i.name,buffer:null,texView:null,sampler:null}}this._gpuBindingLayout={gpuBindings:new Array(e.bindings.length)};for(var n=0;n<e.bindings.length;++n){var r=e.bindings[n];this._gpuBindingLayout.gpuBindings[n]={binding:r.binding,type:r.bindingType,name:r.name,gpuBuffer:null,gpuTexView:null,gpuSampler:null}}return this._status=Ks.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuBindingLayout=null,this._status=Ks.UNREADY}},{key:"update",value:function(){if(this._isDirty&&this._gpuBindingLayout){for(var e=0;e<this._bindingUnits.length;++e){var t=this._bindingUnits[e];switch(t.type){case wo.UNIFORM_BUFFER:t.buffer&&(this._gpuBindingLayout.gpuBindings[e].gpuBuffer=t.buffer.gpuBuffer);break;case wo.SAMPLER:t.texView&&(this._gpuBindingLayout.gpuBindings[e].gpuTexView=t.texView.gpuTextureView),t.sampler&&(this._gpuBindingLayout.gpuBindings[e].gpuSampler=t.sampler.gpuSampler)}}this._isDirty=!1}}}]),t}(sd);function JP(e,t){switch(e){case no.R8:return t.UNSIGNED_BYTE;case no.R8SN:return t.BYTE;case no.R8UI:return t.UNSIGNED_BYTE;case no.R8I:return t.BYTE;case no.R16F:return ZP.HALF_FLOAT_OES;case no.R16UI:return t.UNSIGNED_SHORT;case no.R16I:return t.SHORT;case no.R32F:return t.FLOAT;case no.R32UI:return t.UNSIGNED_INT;case no.R32I:return t.INT;case no.RG8:return t.UNSIGNED_BYTE;case no.RG8SN:return t.BYTE;case no.RG8UI:return t.UNSIGNED_BYTE;case no.RG8I:return t.BYTE;case no.RG16F:return ZP.HALF_FLOAT_OES;case no.RG16UI:return t.UNSIGNED_SHORT;case no.RG16I:return t.SHORT;case no.RG32F:return t.FLOAT;case no.RG32UI:return t.UNSIGNED_INT;case no.RG32I:return t.INT;case no.RGB8:case no.SRGB8:return t.UNSIGNED_BYTE;case no.RGB8SN:return t.BYTE;case no.RGB8UI:return t.UNSIGNED_BYTE;case no.RGB8I:return t.BYTE;case no.RGB16F:return ZP.HALF_FLOAT_OES;case no.RGB16UI:return t.UNSIGNED_SHORT;case no.RGB16I:return t.SHORT;case no.RGB32F:return t.FLOAT;case no.RGB32UI:return t.UNSIGNED_INT;case no.RGB32I:return t.INT;case no.RGBA8:case no.SRGB8_A8:return t.UNSIGNED_BYTE;case no.RGBA8SN:return t.BYTE;case no.RGBA8UI:return t.UNSIGNED_BYTE;case no.RGBA8I:return t.BYTE;case no.RGBA16F:return ZP.HALF_FLOAT_OES;case no.RGBA16UI:return t.UNSIGNED_SHORT;case no.RGBA16I:return t.SHORT;case no.RGBA32F:return t.FLOAT;case no.RGBA32UI:return t.UNSIGNED_INT;case no.RGBA32I:return t.INT;case no.R5G6B5:return t.UNSIGNED_SHORT_5_6_5;case no.R11G11B10F:return t.FLOAT;case no.RGB5A1:return t.UNSIGNED_SHORT_5_5_5_1;case no.RGBA4:return t.UNSIGNED_SHORT_4_4_4_4;case no.RGB10A2:return t.UNSIGNED_BYTE;case no.RGB10A2UI:return t.UNSIGNED_INT;case no.RGB9E5:return t.UNSIGNED_BYTE;case no.D16:case no.D16S8:return t.UNSIGNED_SHORT;case no.D24:return t.UNSIGNED_INT;case no.D24S8:return ZP.UNSIGNED_INT_24_8_WEBGL;case no.D32F:case no.D32F_S8:return t.FLOAT;case no.BC1:case no.BC1_SRGB:case no.BC2:case no.BC2_SRGB:case no.BC3:case no.BC3_SRGB:case no.BC4:return t.UNSIGNED_BYTE;case no.BC4_SNORM:return t.BYTE;case no.BC5:return t.UNSIGNED_BYTE;case no.BC5_SNORM:return t.BYTE;case no.BC6H_SF16:case no.BC6H_UF16:return t.FLOAT;case no.BC7:case no.BC7_SRGB:case no.ETC_RGB8:case no.ETC2_RGB8:case no.ETC2_SRGB8:case no.ETC2_RGB8_A1:case no.ETC2_SRGB8_A1:case no.ETC2_RGB8:case no.ETC2_SRGB8:case no.EAC_R11:return t.UNSIGNED_BYTE;case no.EAC_R11SN:return t.BYTE;case no.EAC_RG11:return t.UNSIGNED_BYTE;case no.EAC_RG11SN:return t.BYTE;case no.PVRTC_RGB2:case no.PVRTC_RGBA2:case no.PVRTC_RGB4:case no.PVRTC_RGBA4:case no.PVRTC2_2BPP:case no.PVRTC2_4BPP:default:return t.UNSIGNED_BYTE}}function $P(e,t){switch(e){case no.A8:return t.ALPHA;case no.L8:return t.LUMINANCE;case no.LA8:return t.LUMINANCE_ALPHA;case no.RGB8:case no.RGB16F:case no.RGB32F:return t.RGB;case no.RGBA8:case no.RGBA16F:case no.RGBA32F:return t.RGBA;case no.R5G6B5:return t.RGB565;case no.RGB5A1:return t.RGB5_A1;case no.RGBA4:return t.RGBA4;case no.D16:return t.DEPTH_COMPONENT;case no.D16S8:return t.DEPTH_STENCIL;case no.D24:return t.DEPTH_COMPONENT;case no.D24S8:return t.DEPTH_STENCIL;case no.D32F:return t.DEPTH_COMPONENT;case no.D32F_S8:return t.DEPTH_STENCIL;case no.BC1:return ZP.COMPRESSED_RGB_S3TC_DXT1_EXT;case no.BC1_ALPHA:return ZP.COMPRESSED_RGBA_S3TC_DXT1_EXT;case no.BC1_SRGB:return ZP.COMPRESSED_SRGB_S3TC_DXT1_EXT;case no.BC1_SRGB_ALPHA:return ZP.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case no.BC2:return ZP.COMPRESSED_RGBA_S3TC_DXT3_EXT;case no.BC2_SRGB:return ZP.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case no.BC3:return ZP.COMPRESSED_RGBA_S3TC_DXT5_EXT;case no.BC3_SRGB:return ZP.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case no.ETC_RGB8:return ZP.COMPRESSED_RGB_ETC1_WEBGL;case no.PVRTC_RGB2:return ZP.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case no.PVRTC_RGBA2:return ZP.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case no.PVRTC_RGB4:return ZP.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case no.PVRTC_RGBA4:return ZP.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;default:return console.error("Unsupported GFXFormat, convert to WebGL internal format failed."),t.RGBA}}function eB(e,t){switch(e){case no.A8:return t.ALPHA;case no.L8:return t.LUMINANCE;case no.LA8:return t.LUMINANCE_ALPHA;case no.RGB8:case no.RGB16F:case no.RGB32F:return t.RGB;case no.RGBA8:case no.RGBA16F:case no.RGBA32F:return t.RGBA;case no.R5G6B5:return t.RGB;case no.RGB5A1:case no.RGBA4:return t.RGBA;case no.D16:return t.DEPTH_COMPONENT;case no.D16S8:return t.DEPTH_STENCIL;case no.D24:return t.DEPTH_COMPONENT;case no.D24S8:return t.DEPTH_STENCIL;case no.D32F:return t.DEPTH_COMPONENT;case no.D32F_S8:return t.DEPTH_STENCIL;case no.BC1:return ZP.COMPRESSED_RGB_S3TC_DXT1_EXT;case no.BC1_ALPHA:return ZP.COMPRESSED_RGBA_S3TC_DXT1_EXT;case no.BC1_SRGB:return ZP.COMPRESSED_SRGB_S3TC_DXT1_EXT;case no.BC1_SRGB_ALPHA:return ZP.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case no.BC2:return ZP.COMPRESSED_RGBA_S3TC_DXT3_EXT;case no.BC2_SRGB:return ZP.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case no.BC3:return ZP.COMPRESSED_RGBA_S3TC_DXT5_EXT;case no.BC3_SRGB:return ZP.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case no.ETC_RGB8:return ZP.COMPRESSED_RGB_ETC1_WEBGL;case no.ETC2_RGB8:return ZP.COMPRESSED_RGB8_ETC2;case no.ETC2_SRGB8:return ZP.COMPRESSED_SRGB8_ETC2;case no.ETC2_RGB8_A1:return ZP.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case no.ETC2_SRGB8_A1:return ZP.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case no.ETC2_RGBA8:return ZP.COMPRESSED_RGBA8_ETC2_EAC;case no.ETC2_SRGB8_A8:return ZP.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case no.EAC_R11:return ZP.COMPRESSED_R11_EAC;case no.EAC_R11SN:return ZP.COMPRESSED_SIGNED_R11_EAC;case no.EAC_RG11:return ZP.COMPRESSED_RG11_EAC;case no.EAC_RG11SN:return ZP.COMPRESSED_SIGNED_RG11_EAC;case no.PVRTC_RGB2:return ZP.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case no.PVRTC_RGBA2:return ZP.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case no.PVRTC_RGB4:return ZP.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case no.PVRTC_RGBA4:return ZP.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;default:return console.error("Unsupported GFXFormat, convert to WebGL format failed."),t.RGBA}}function tB(e,t){switch(e){case io.BOOL:return t.BOOL;case io.BOOL2:return t.BOOL_VEC2;case io.BOOL3:return t.BOOL_VEC3;case io.BOOL4:return t.BOOL_VEC4;case io.INT:return t.INT;case io.INT2:return t.INT_VEC2;case io.INT3:return t.INT_VEC3;case io.INT4:return t.INT_VEC4;case io.UINT:return t.UNSIGNED_INT;case io.FLOAT:return t.FLOAT;case io.FLOAT2:return t.FLOAT_VEC2;case io.FLOAT3:return t.FLOAT_VEC3;case io.FLOAT4:return t.FLOAT_VEC4;case io.MAT2:return t.FLOAT_MAT2;case io.MAT3:return t.FLOAT_MAT3;case io.MAT4:return t.FLOAT_MAT4;case io.SAMPLER2D:return t.SAMPLER_2D;case io.SAMPLER_CUBE:return t.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GL type failed."),io.UNKNOWN}}function iB(e,t){switch(e){case t.BOOL:return io.BOOL;case t.BOOL_VEC2:return io.BOOL2;case t.BOOL_VEC3:return io.BOOL3;case t.BOOL_VEC4:return io.BOOL4;case t.INT:return io.INT;case t.INT_VEC2:return io.INT2;case t.INT_VEC3:return io.INT3;case t.INT_VEC4:return io.INT4;case t.UNSIGNED_INT:return io.UINT;case t.FLOAT:return io.FLOAT;case t.FLOAT_VEC2:return io.FLOAT2;case t.FLOAT_VEC3:return io.FLOAT3;case t.FLOAT_VEC4:return io.FLOAT4;case t.FLOAT_MAT2:return io.MAT2;case t.FLOAT_MAT3:return io.MAT3;case t.FLOAT_MAT4:return io.MAT4;case t.SAMPLER_2D:return io.SAMPLER2D;case t.SAMPLER_CUBE:return io.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GFXType failed."),io.UNKNOWN}}function nB(e,t){switch(e){case t.BOOL:return 4;case t.BOOL_VEC2:return 8;case t.BOOL_VEC3:return 12;case t.BOOL_VEC4:return 16;case t.INT:return 4;case t.INT_VEC2:return 8;case t.INT_VEC3:return 12;case t.INT_VEC4:return 16;case t.UNSIGNED_INT:case t.FLOAT:return 4;case t.FLOAT_VEC2:return 8;case t.FLOAT_VEC3:return 12;case t.FLOAT_VEC4:case t.FLOAT_MAT2:return 16;case t.FLOAT_MAT3:return 36;case t.FLOAT_MAT4:return 64;case t.SAMPLER_2D:case t.SAMPLER_CUBE:return 4;default:return console.error("Unsupported GLType, get type failed."),0}}function rB(e,t){switch(e){case t.FLOAT_MAT2:return 2;case t.FLOAT_MAT3:return 3;case t.FLOAT_MAT4:return 4;default:return 1}}!function(e){e[e.RGBA16F_EXT=34842]="RGBA16F_EXT",e[e.RGB16F_EXT=34843]="RGB16F_EXT",e[e.RGBA32F_EXT=34836]="RGBA32F_EXT",e[e.FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT=33297]="FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT",e[e.UNSIGNED_NORMALIZED_EXT=35863]="UNSIGNED_NORMALIZED_EXT",e[e.UNSIGNED_INT_24_8_WEBGL=34042]="UNSIGNED_INT_24_8_WEBGL",e[e.HALF_FLOAT_OES=36193]="HALF_FLOAT_OES",e[e.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",e[e.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",e[e.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",e[e.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",e[e.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",e[e.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",e[e.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",e[e.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",e[e.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",e[e.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",e[e.COMPRESSED_SRGB8_ETC2=37493]="COMPRESSED_SRGB8_ETC2",e[e.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",e[e.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC"}(ZP||(ZP={}));var aB,sB=[512,513,514,515,516,517,518,519],oB=[0,7680,7681,7682,7683,5386,34055,34056],lB=[32774,32778,32779,32774,32774],uB=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772];!function(e){e[e.BEGIN_RENDER_PASS=0]="BEGIN_RENDER_PASS",e[e.END_RENDER_PASS=1]="END_RENDER_PASS",e[e.BIND_STATES=2]="BIND_STATES",e[e.DRAW=3]="DRAW",e[e.UPDATE_BUFFER=4]="UPDATE_BUFFER",e[e.COPY_BUFFER_TO_TEXTURE=5]="COPY_BUFFER_TO_TEXTURE",e[e.COUNT=6]="COUNT"}(aB||(aB={}));var cB=function e(t){i(this,e),this.refCount=0,this.cmdType=t},hB=function(e){function t(){var e;return i(this,t),(e=c(this,o(t).call(this,aB.BEGIN_RENDER_PASS))).gpuFramebuffer=null,e.renderArea={x:0,y:0,width:0,height:0},e.clearFlag=Bo.NONE,e.clearColors=[],e.clearDepth=1,e.clearStencil=0,e}return s(t,e),r(t,[{key:"clear",value:function(){this.gpuFramebuffer=null,this.clearColors.length=0}}]),t}(cB),fB=function(e){function t(){var e;return i(this,t),(e=c(this,o(t).call(this,aB.BIND_STATES))).gpuPipelineState=null,e.gpuBindingLayout=null,e.gpuInputAssembler=null,e.viewport=null,e.scissor=null,e.lineWidth=null,e.depthBias=null,e.blendConstants=null,e.depthBounds=null,e.stencilWriteMask=null,e.stencilCompareMask=null,e}return s(t,e),r(t,[{key:"clear",value:function(){this.gpuPipelineState=null,this.gpuBindingLayout=null,this.gpuInputAssembler=null,this.viewport=null,this.scissor=null,this.lineWidth=null,this.depthBias=null,this.blendConstants=null,this.depthBounds=null,this.stencilWriteMask=null,this.stencilCompareMask=null}}]),t}(cB),_B=function(e){function t(){var e;return i(this,t),(e=c(this,o(t).call(this,aB.DRAW))).drawInfo={vertexCount:0,firstVertex:0,indexCount:0,firstIndex:0,vertexOffset:0,instanceCount:0,firstInstance:0},e}return s(t,e),r(t,[{key:"clear",value:function(){}}]),t}(cB),dB=function(e){function t(){var e;return i(this,t),(e=c(this,o(t).call(this,aB.UPDATE_BUFFER))).gpuBuffer=null,e.buffer=null,e.offset=0,e.size=0,e}return s(t,e),r(t,[{key:"clear",value:function(){this.gpuBuffer=null,this.buffer=null}}]),t}(cB),pB=function(e){function t(){var e;return i(this,t),(e=c(this,o(t).call(this,aB.COPY_BUFFER_TO_TEXTURE))).gpuBuffer=null,e.gpuTexture=null,e.dstLayout=null,e.regions=[],e}return s(t,e),r(t,[{key:"clear",value:function(){this.gpuBuffer=null,this.gpuTexture=null,this.dstLayout=null,this.regions.length=0}}]),t}(cB),mB=function(){function e(){i(this,e),this.cmds=new Ja(1),this.beginRenderPassCmds=new Ja(1),this.bindStatesCmds=new Ja(1),this.drawCmds=new Ja(1),this.updateBufferCmds=new Ja(1),this.copyBufferToTextureCmds=new Ja(1)}return r(e,[{key:"clearCmds",value:function(e){this.beginRenderPassCmds.length&&(e.beginRenderPassCmdPool.freeCmds(this.beginRenderPassCmds),this.beginRenderPassCmds.clear()),this.bindStatesCmds.length&&(e.bindStatesCmdPool.freeCmds(this.bindStatesCmds),this.bindStatesCmds.clear()),this.drawCmds.length&&(e.drawCmdPool.freeCmds(this.drawCmds),this.drawCmds.clear()),this.updateBufferCmds.length&&(e.updateBufferCmdPool.freeCmds(this.updateBufferCmds),this.updateBufferCmds.clear()),this.copyBufferToTextureCmds.length&&(e.copyBufferToTextureCmdPool.freeCmds(this.copyBufferToTextureCmds),this.copyBufferToTextureCmds.clear()),this.cmds.clear()}}]),e}();function vB(e,t,i,n,r){if(t.usage&ro.UNIFORM)i instanceof Float32Array?t.vf32.set(i,n/Float32Array.BYTES_PER_ELEMENT):t.vf32.set(new Float32Array(i),n/Float32Array.BYTES_PER_ELEMENT);else if(t.usage&ro.INDIRECT)t.indirects=i.drawInfos;else{var a=i,s=e.gl,o=e.stateCache;switch(t.glTarget){case s.ARRAY_BUFFER:e.useVAO&&o.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),o.glVAO=null),e.stateCache.glArrayBuffer!==t.glBuffer&&(s.bindBuffer(s.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer);break;case s.ELEMENT_ARRAY_BUFFER:e.useVAO&&o.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),o.glVAO=null),e.stateCache.glElementArrayBuffer!==t.glBuffer&&(s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer);break;default:return void console.error("Unsupported GFXBufferType, update buffer failed.")}r===a.byteLength?s.bufferSubData(t.glTarget,n,a):s.bufferSubData(t.glTarget,n,a.slice(0,r))}}var gB=new Array(aB.COUNT);function yB(e,t){for(var i=e.gl,n=e.stateCache,r=0;r<aB.COUNT;++r)gB[r]=0;for(var a,s,o,l=null,u=null,c=!1,h=null,f=i.TRIANGLES,_=0;_<t.cmds.length;++_){var d=t.cmds.array[_],p=gB[d]++;switch(d){case aB.BEGIN_RENDER_PASS:var m=t.beginRenderPassCmds.array[p],v=0;if(m.gpuFramebuffer){n.glFramebuffer!==m.gpuFramebuffer.glFramebuffer&&(i.bindFramebuffer(i.FRAMEBUFFER,m.gpuFramebuffer.glFramebuffer),n.glFramebuffer=m.gpuFramebuffer.glFramebuffer),n.viewport.left===m.renderArea.x&&n.viewport.top===m.renderArea.y&&n.viewport.width===m.renderArea.width&&n.viewport.height===m.renderArea.height||(i.viewport(m.renderArea.x,m.renderArea.y,m.renderArea.width,m.renderArea.height),n.viewport.left=m.renderArea.x,n.viewport.top=m.renderArea.y,n.viewport.width=m.renderArea.width,n.viewport.height=m.renderArea.height),n.scissorRect.x===m.renderArea.x&&n.scissorRect.y===m.renderArea.y&&n.scissorRect.width===m.renderArea.width&&n.scissorRect.height===m.renderArea.height||(i.scissor(m.renderArea.x,m.renderArea.y,m.renderArea.width,m.renderArea.height),n.scissorRect.x=m.renderArea.x,n.scissorRect.y=m.renderArea.y,n.scissorRect.width=m.renderArea.width,n.scissorRect.height=m.renderArea.height);var g=m.gpuFramebuffer.gpuRenderPass,y=m.clearColors.length;e.WEBGL_draw_buffers||(y=1);for(var b=0;b<y;++b){var E=g.colorAttachments[b];if(E.format!==no.UNKNOWN)switch(E.loadOp){case Ro.LOAD:break;case Ro.CLEAR:if(m.clearFlag&Bo.COLOR){n.bs.targets[0].blendColorMask!==vo.ALL&&i.colorMask(!0,!0,!0,!0);var T=m.clearColors[0];i.clearColor(T.r,T.g,T.b,T.a),v|=i.COLOR_BUFFER_BIT}break;case Ro.DISCARD:}}if(g.depthStencilAttachment&&g.depthStencilAttachment.format!==no.UNKNOWN){switch(g.depthStencilAttachment.depthLoadOp){case Ro.LOAD:break;case Ro.CLEAR:m.clearFlag&Bo.DEPTH&&(n.dss.depthWrite||i.depthMask(!0),i.clearDepth(m.clearDepth),v|=i.DEPTH_BUFFER_BIT);break;case Ro.DISCARD:}if(Go[g.depthStencilAttachment.format].hasStencil)switch(g.depthStencilAttachment.stencilLoadOp){case Ro.LOAD:break;case Ro.CLEAR:m.clearFlag&Bo.STENCIL&&(n.dss.stencilWriteMaskFront||i.stencilMaskSeparate(i.FRONT,65535),n.dss.stencilWriteMaskBack||i.stencilMaskSeparate(i.BACK,65535),i.clearStencil(m.clearStencil),v|=i.STENCIL_BUFFER_BIT);break;case Ro.DISCARD:}}if(v&&i.clear(v),v&i.COLOR_BUFFER_BIT){var S=n.bs.targets[0].blendColorMask;if(S!==vo.ALL){var x=(S&vo.R)!==vo.NONE,A=(S&vo.G)!==vo.NONE,w=(S&vo.B)!==vo.NONE,C=(S&vo.A)!==vo.NONE;i.colorMask(x,A,w,C)}}v&i.DEPTH_BUFFER_BIT&&!n.dss.depthWrite&&i.depthMask(!1),v&i.STENCIL_BUFFER_BIT&&(n.dss.stencilWriteMaskFront||i.stencilMaskSeparate(i.FRONT,0),n.dss.stencilWriteMaskBack||i.stencilMaskSeparate(i.BACK,0))}break;case aB.BIND_STATES:var R=t.bindStatesCmds.array[p];if(c=!1,R.gpuPipelineState){if(l=R.gpuPipelineState,f=R.gpuPipelineState.glPrimitive,R.gpuPipelineState.gpuShader){var k=R.gpuPipelineState.gpuShader.glProgram;n.glProgram!==k&&(i.useProgram(k),n.glProgram=k,c=!0),u=R.gpuPipelineState.gpuShader}var O=R.gpuPipelineState.rs;if(O){if(n.rs.cullMode!==O.cullMode){switch(O.cullMode){case ho.NONE:i.disable(i.CULL_FACE);break;case ho.FRONT:i.enable(i.CULL_FACE),i.cullFace(i.FRONT);break;case ho.BACK:i.enable(i.CULL_FACE),i.cullFace(i.BACK)}n.rs.cullMode=O.cullMode}var I=e.reverseCW?!O.isFrontFaceCCW:O.isFrontFaceCCW;n.rs.isFrontFaceCCW!==I&&(i.frontFace(I?i.CCW:i.CW),n.rs.isFrontFaceCCW=I),n.rs.depthBias===O.depthBias&&n.rs.depthBiasSlop===O.depthBiasSlop||(i.polygonOffset(O.depthBias,O.depthBiasSlop),n.rs.depthBias=O.depthBias,n.rs.depthBiasSlop=O.depthBiasSlop),n.rs.lineWidth!==O.lineWidth&&(i.lineWidth(O.lineWidth),n.rs.lineWidth=O.lineWidth)}var M=R.gpuPipelineState.dss;M&&(n.dss.depthTest!==M.depthTest&&(M.depthTest?i.enable(i.DEPTH_TEST):i.disable(i.DEPTH_TEST),n.dss.depthTest=M.depthTest),n.dss.depthWrite!==M.depthWrite&&(i.depthMask(M.depthWrite),n.dss.depthWrite=M.depthWrite),n.dss.depthFunc!==M.depthFunc&&(i.depthFunc(sB[M.depthFunc]),n.dss.depthFunc=M.depthFunc),n.dss.stencilTestFront===M.stencilTestFront&&n.dss.stencilTestBack===M.stencilTestBack||(M.stencilTestFront||M.stencilTestBack?i.enable(i.STENCIL_TEST):i.disable(i.STENCIL_TEST),n.dss.stencilTestFront=M.stencilTestFront,n.dss.stencilTestBack=M.stencilTestBack),n.dss.stencilFuncFront===M.stencilFuncFront&&n.dss.stencilRefFront===M.stencilRefFront&&n.dss.stencilReadMaskFront===M.stencilReadMaskFront||(i.stencilFuncSeparate(i.FRONT,sB[M.stencilFuncFront],M.stencilRefFront,M.stencilReadMaskFront),n.dss.stencilFuncFront=M.stencilFuncFront,n.dss.stencilRefFront=M.stencilRefFront,n.dss.stencilReadMaskFront=M.stencilReadMaskFront),n.dss.stencilFailOpFront===M.stencilFailOpFront&&n.dss.stencilZFailOpFront===M.stencilZFailOpFront&&n.dss.stencilPassOpFront===M.stencilPassOpFront||(i.stencilOpSeparate(i.FRONT,oB[M.stencilFailOpFront],oB[M.stencilZFailOpFront],oB[M.stencilPassOpFront]),n.dss.stencilFailOpFront=M.stencilFailOpFront,n.dss.stencilZFailOpFront=M.stencilZFailOpFront,n.dss.stencilPassOpFront=M.stencilPassOpFront),n.dss.stencilWriteMaskFront!==M.stencilWriteMaskFront&&(i.stencilMaskSeparate(i.FRONT,M.stencilWriteMaskFront),n.dss.stencilWriteMaskFront=M.stencilWriteMaskFront),n.dss.stencilFuncBack===M.stencilFuncBack&&n.dss.stencilRefBack===M.stencilRefBack&&n.dss.stencilReadMaskBack===M.stencilReadMaskBack||(i.stencilFuncSeparate(i.BACK,sB[M.stencilFuncBack],M.stencilRefBack,M.stencilReadMaskBack),n.dss.stencilFuncBack=M.stencilFuncBack,n.dss.stencilRefBack=M.stencilRefBack,n.dss.stencilReadMaskBack=M.stencilReadMaskBack),n.dss.stencilFailOpBack===M.stencilFailOpBack&&n.dss.stencilZFailOpBack===M.stencilZFailOpBack&&n.dss.stencilPassOpBack===M.stencilPassOpBack||(i.stencilOpSeparate(i.BACK,oB[M.stencilFailOpBack],oB[M.stencilZFailOpBack],oB[M.stencilPassOpBack]),n.dss.stencilFailOpBack=M.stencilFailOpBack,n.dss.stencilZFailOpBack=M.stencilZFailOpBack,n.dss.stencilPassOpBack=M.stencilPassOpBack),n.dss.stencilWriteMaskBack!==M.stencilWriteMaskBack&&(i.stencilMaskSeparate(i.BACK,M.stencilWriteMaskBack),n.dss.stencilWriteMaskBack=M.stencilWriteMaskBack));var L=R.gpuPipelineState.bs;if(L){n.bs.isA2C!==L.isA2C&&(L.isA2C?i.enable(i.SAMPLE_ALPHA_TO_COVERAGE):i.disable(i.SAMPLE_ALPHA_TO_COVERAGE),n.bs.isA2C=L.isA2C),n.bs.blendColor[0]===L.blendColor[0]&&n.bs.blendColor[1]===L.blendColor[1]&&n.bs.blendColor[2]===L.blendColor[2]&&n.bs.blendColor[3]===L.blendColor[3]||(i.blendColor(L.blendColor[0],L.blendColor[1],L.blendColor[2],L.blendColor[3]),n.bs.blendColor[0]=L.blendColor[0],n.bs.blendColor[1]=L.blendColor[1],n.bs.blendColor[2]=L.blendColor[2],n.bs.blendColor[3]=L.blendColor[3]);var P=L.targets[0],B=n.bs.targets[0];B.blend!==P.blend&&(P.blend?i.enable(i.BLEND):i.disable(i.BLEND),B.blend=P.blend),B.blendEq===P.blendEq&&B.blendAlphaEq===P.blendAlphaEq||(i.blendEquationSeparate(lB[P.blendEq],lB[P.blendAlphaEq]),B.blendEq=P.blendEq,B.blendAlphaEq=P.blendAlphaEq),B.blendSrc===P.blendSrc&&B.blendDst===P.blendDst&&B.blendSrcAlpha===P.blendSrcAlpha&&B.blendDstAlpha===P.blendDstAlpha||(i.blendFuncSeparate(uB[P.blendSrc],uB[P.blendDst],uB[P.blendSrcAlpha],uB[P.blendDstAlpha]),B.blendSrc=P.blendSrc,B.blendDst=P.blendDst,B.blendSrcAlpha=P.blendSrcAlpha,B.blendDstAlpha=P.blendDstAlpha),B.blendColorMask!==P.blendColorMask&&(i.colorMask((P.blendColorMask&vo.R)!==vo.NONE,(P.blendColorMask&vo.G)!==vo.NONE,(P.blendColorMask&vo.B)!==vo.NONE,(P.blendColorMask&vo.A)!==vo.NONE),B.blendColorMask=P.blendColorMask)}}if(R.gpuBindingLayout&&u)for(var D=R.gpuBindingLayout.gpuBindings.length,F=0;F<D;F++){var N=R.gpuBindingLayout.gpuBindings[F];switch(N.type){case wo.UNIFORM_BUFFER:if(N.gpuBuffer&&N.gpuBuffer.buffer){for(var z=null,U=u.glBlocks.length,G=0;G<U;G++){var V=u.glBlocks[G];if(V.binding===N.binding){z=V;break}}if(z&&N.gpuBuffer.vf32)for(var H=z.glActiveUniforms.length,W=0;W<H;W++){var j=z.glActiveUniforms[W];switch(j.glType){case i.BOOL:case i.INT:for(var X=0;X<j.array.length;++X){var q=j.begin+X;if(N.gpuBuffer.vf32[q]!==j.array[X]){for(var Y=X,K=j.begin+X;Y<j.array.length;++Y,++K)j.array[Y]=N.gpuBuffer.vf32[K];i.uniform1iv(j.glLoc,j.array);break}}break;case i.BOOL_VEC2:case i.INT_VEC2:for(var Z=0;Z<j.array.length;++Z){var Q=j.begin+Z;if(N.gpuBuffer.vf32[Q]!==j.array[Z]){for(var J=Z,$=j.begin+Z;J<j.array.length;++J,++$)j.array[J]=N.gpuBuffer.vf32[$];i.uniform2iv(j.glLoc,j.array);break}}break;case i.BOOL_VEC3:case i.INT_VEC3:for(var ee=0;ee<j.array.length;++ee){var te=j.begin+ee;if(N.gpuBuffer.vf32[te]!==j.array[ee]){for(var ie=ee,ne=j.begin+ee;ie<j.array.length;++ie,++ne)j.array[ie]=N.gpuBuffer.vf32[ne];i.uniform3iv(j.glLoc,j.array);break}}break;case i.BOOL_VEC4:case i.INT_VEC4:for(var re=0;re<j.array.length;++re){var ae=j.begin+re;if(N.gpuBuffer.vf32[ae]!==j.array[re]){for(var se=re,oe=j.begin+re;se<j.array.length;++se,++oe)j.array[se]=N.gpuBuffer.vf32[oe];i.uniform4iv(j.glLoc,j.array);break}}break;case i.FLOAT:for(var le=0;le<j.array.length;++le){var ue=j.begin+le;if(N.gpuBuffer.vf32[ue]!==j.array[le]){for(var ce=le,he=j.begin+le;ce<j.array.length;++ce,++he)j.array[ce]=N.gpuBuffer.vf32[he];i.uniform1fv(j.glLoc,j.array);break}}break;case i.FLOAT_VEC2:for(var fe=0;fe<j.array.length;++fe){var _e=j.begin+fe;if(N.gpuBuffer.vf32[_e]!==j.array[fe]){for(var de=fe,pe=j.begin+fe;de<j.array.length;++de,++pe)j.array[de]=N.gpuBuffer.vf32[pe];i.uniform2fv(j.glLoc,j.array);break}}break;case i.FLOAT_VEC3:for(var me=0;me<j.array.length;++me){var ve=j.begin+me;if(N.gpuBuffer.vf32[ve]!==j.array[me]){for(var ge=me,ye=j.begin+me;ge<j.array.length;++ge,++ye)j.array[ge]=N.gpuBuffer.vf32[ye];i.uniform3fv(j.glLoc,j.array);break}}break;case i.FLOAT_VEC4:for(var be=0;be<j.array.length;++be){var Ee=j.begin+be;if(N.gpuBuffer.vf32[Ee]!==j.array[be]){for(var Te=be,Se=j.begin+be;Te<j.array.length;++Te,++Se)j.array[Te]=N.gpuBuffer.vf32[Se];i.uniform4fv(j.glLoc,j.array);break}}break;case i.FLOAT_MAT2:for(var xe=0;xe<j.array.length;++xe){var Ae=j.begin+xe;if(N.gpuBuffer.vf32[Ae]!==j.array[xe]){for(var we=xe,Ce=j.begin+xe;we<j.array.length;++we,++Ce)j.array[we]=N.gpuBuffer.vf32[Ce];i.uniformMatrix2fv(j.glLoc,!1,j.array);break}}break;case i.FLOAT_MAT3:for(var Re=0;Re<j.array.length;++Re){var ke=j.begin+Re;if(N.gpuBuffer.vf32[ke]!==j.array[Re]){for(var Oe=Re,Ie=j.begin+Re;Oe<j.array.length;++Oe,++Ie)j.array[Oe]=N.gpuBuffer.vf32[Ie];i.uniformMatrix3fv(j.glLoc,!1,j.array);break}}break;case i.FLOAT_MAT4:for(var Me=0;Me<j.array.length;++Me){var Le=j.begin+Me;if(N.gpuBuffer.vf32[Le]!==j.array[Me]){for(var Pe=Me,Be=j.begin+Me;Pe<j.array.length;++Pe,++Be)j.array[Pe]=N.gpuBuffer.vf32[Be];i.uniformMatrix4fv(j.glLoc,!1,j.array);break}}}}}break;case wo.SAMPLER:if(N.gpuSampler){for(var De=null,Fe=u.glSamplers.length,Ne=0;Ne<Fe;Ne++){var ze=u.glSamplers[Ne];if(ze.binding===N.binding){De=ze;break}}if(De)for(var Ue=De.units.length,Ge=0;Ge<Ue;Ge++){var Ve=De.units[Ge];if(N.gpuTexView&&N.gpuTexView.gpuTexture.size>0){var He=N.gpuTexView.gpuTexture,We=n.glTexUnits[Ve];We.glTexture!==He.glTexture&&(n.texUnit!==Ve&&(i.activeTexture(i.TEXTURE0+Ve),n.texUnit=Ve),He.glTexture?i.bindTexture(He.glTarget,He.glTexture):i.bindTexture(He.glTarget,e.nullTex2D.gpuTexture.glTexture),We.glTexture=He.glTexture);var je=N.gpuSampler;He.isPowerOf2?(a=je.glWrapS,s=je.glWrapT):(a=i.CLAMP_TO_EDGE,s=i.CLAMP_TO_EDGE),o=He.isPowerOf2?He.mipLevel<=1&&(je.glMinFilter===i.LINEAR_MIPMAP_NEAREST||je.glMinFilter===i.LINEAR_MIPMAP_LINEAR)?i.LINEAR:je.glMinFilter:je.glMinFilter===i.LINEAR||je.glMinFilter===i.LINEAR_MIPMAP_NEAREST||je.glMinFilter===i.LINEAR_MIPMAP_LINEAR?i.LINEAR:i.NEAREST,He.glWrapS!==a&&(n.texUnit!==Ve&&(i.activeTexture(i.TEXTURE0+Ve),n.texUnit=Ve),i.texParameteri(He.glTarget,i.TEXTURE_WRAP_S,a),He.glWrapS=a),He.glWrapT!==s&&(n.texUnit!==Ve&&(i.activeTexture(i.TEXTURE0+Ve),n.texUnit=Ve),i.texParameteri(He.glTarget,i.TEXTURE_WRAP_T,s),He.glWrapT=s),He.glMinFilter!==o&&(n.texUnit!==Ve&&(i.activeTexture(i.TEXTURE0+Ve),n.texUnit=Ve),i.texParameteri(He.glTarget,i.TEXTURE_MIN_FILTER,o),He.glMinFilter=o),He.glMagFilter!==je.glMagFilter&&(n.texUnit!==Ve&&(i.activeTexture(i.TEXTURE0+Ve),n.texUnit=Ve),i.texParameteri(He.glTarget,i.TEXTURE_MAG_FILTER,je.glMagFilter),He.glMagFilter=je.glMagFilter)}}}else console.error("Not found sampler on binding unit "+N.binding)}}if(R.gpuInputAssembler&&u&&(c||h!==R.gpuInputAssembler))if(h=R.gpuInputAssembler,e.useVAO){var Xe=e.OES_vertex_array_object,qe=e.ANGLE_instanced_arrays,Ye=h.glVAOs.get(u.glProgram);if(!Ye){Ye=Xe.createVertexArrayOES(),h.glVAOs.set(u.glProgram,Ye),Xe.bindVertexArrayOES(Ye),i.bindBuffer(i.ARRAY_BUFFER,null),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null);for(var Ke=void 0,Ze=u.glInputs.length,Qe=0;Qe<Ze;Qe++){var Je=u.glInputs[Qe];Ke=null;for(var $e=h.glAttribs.length,et=0;et<$e;et++){var tt=h.glAttribs[et];if(tt.name===Je.name){Ke=tt;break}}if(Ke){i.bindBuffer(i.ARRAY_BUFFER,Ke.glBuffer);for(var it=0;it<Ke.componentCount;++it){var nt=Je.glLoc+it,rt=Ke.offset+Ke.size*it;i.enableVertexAttribArray(nt),n.glCurrentAttribLocs[nt]=!0,i.vertexAttribPointer(nt,Ke.count,Ke.glType,Ke.isNormalized,Ke.stride,rt),qe&&qe.vertexAttribDivisorANGLE(nt,Ke.isInstanced?1:0)}}}var at=h.gpuIndexBuffer;at&&i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,at.glBuffer),Xe.bindVertexArrayOES(null),i.bindBuffer(i.ARRAY_BUFFER,null),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),n.glArrayBuffer=null,n.glElementArrayBuffer=null}n.glVAO!==Ye&&(Xe.bindVertexArrayOES(Ye),n.glVAO=Ye)}else{for(var st=0;st<e.maxVertexAttributes;++st)n.glCurrentAttribLocs[st]=!1;for(var ot=u.glInputs.length,lt=0;lt<ot;lt++){for(var ut=u.glInputs[lt],ct=null,ht=h.glAttribs.length,ft=0;ft<ht;ft++){var _t=h.glAttribs[ft];if(_t.name===ut.name){ct=_t;break}}if(ct){n.glArrayBuffer!==ct.glBuffer&&(i.bindBuffer(i.ARRAY_BUFFER,ct.glBuffer),n.glArrayBuffer=ct.glBuffer);for(var dt=0;dt<ct.componentCount;++dt){var pt=ut.glLoc+dt,mt=ct.offset+ct.size*dt;!n.glEnabledAttribLocs[pt]&&pt>=0&&(i.enableVertexAttribArray(pt),n.glEnabledAttribLocs[pt]=!0),n.glCurrentAttribLocs[pt]=!0,i.vertexAttribPointer(pt,ct.count,ct.glType,ct.isNormalized,ct.stride,mt)}}}var vt=h.gpuIndexBuffer;vt&&n.glElementArrayBuffer!==vt.glBuffer&&(i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,vt.glBuffer),n.glElementArrayBuffer=vt.glBuffer);for(var gt=0;gt<e.maxVertexAttributes;++gt)n.glEnabledAttribLocs[gt]!==n.glCurrentAttribLocs[gt]&&(i.disableVertexAttribArray(gt),n.glEnabledAttribLocs[gt]=!1)}if(l)for(var yt=l.dynamicStates.length,bt=0;bt<yt;bt++){switch(l.dynamicStates[bt]){case Mo.VIEWPORT:R.viewport&&(n.viewport.left===R.viewport.left&&n.viewport.top===R.viewport.top&&n.viewport.width===R.viewport.width&&n.viewport.height===R.viewport.height||(i.viewport(R.viewport.left,R.viewport.top,R.viewport.width,R.viewport.height),n.viewport.left=R.viewport.left,n.viewport.top=R.viewport.top,n.viewport.width=R.viewport.width,n.viewport.height=R.viewport.height));break;case Mo.SCISSOR:R.scissor&&(n.scissorRect.x===R.scissor.x&&n.scissorRect.y===R.scissor.y&&n.scissorRect.width===R.scissor.width&&n.scissorRect.height===R.scissor.height||(i.scissor(R.scissor.x,R.scissor.y,R.scissor.width,R.scissor.height),n.scissorRect.x=R.scissor.x,n.scissorRect.y=R.scissor.y,n.scissorRect.width=R.scissor.width,n.scissorRect.height=R.scissor.height));break;case Mo.LINE_WIDTH:R.lineWidth&&n.rs.lineWidth!==R.lineWidth&&(i.lineWidth(R.lineWidth),n.rs.lineWidth=R.lineWidth);break;case Mo.DEPTH_BIAS:R.depthBias&&(n.rs.depthBias===R.depthBias.constantFactor&&n.rs.depthBiasSlop===R.depthBias.slopeFactor||(i.polygonOffset(R.depthBias.constantFactor,R.depthBias.slopeFactor),n.rs.depthBias=R.depthBias.constantFactor,n.rs.depthBiasSlop=R.depthBias.slopeFactor));break;case Mo.BLEND_CONSTANTS:R.blendConstants&&(n.bs.blendColor[0]===R.blendConstants[0]&&n.bs.blendColor[1]===R.blendConstants[1]&&n.bs.blendColor[2]===R.blendConstants[2]&&n.bs.blendColor[3]===R.blendConstants[3]||(i.blendColor(R.blendConstants[0],R.blendConstants[1],R.blendConstants[2],R.blendConstants[3]),n.bs.blendColor[0]=R.blendConstants[0],n.bs.blendColor[1]=R.blendConstants[1],n.bs.blendColor[2]=R.blendConstants[2],n.bs.blendColor[3]=R.blendConstants[3]));break;case Mo.STENCIL_WRITE_MASK:if(R.stencilWriteMask)switch(R.stencilWriteMask.face){case Lo.FRONT:n.dss.stencilWriteMaskFront!==R.stencilWriteMask.writeMask&&(i.stencilMaskSeparate(i.FRONT,R.stencilWriteMask.writeMask),n.dss.stencilWriteMaskFront=R.stencilWriteMask.writeMask);break;case Lo.BACK:n.dss.stencilWriteMaskBack!==R.stencilWriteMask.writeMask&&(i.stencilMaskSeparate(i.BACK,R.stencilWriteMask.writeMask),n.dss.stencilWriteMaskBack=R.stencilWriteMask.writeMask);break;case Lo.ALL:n.dss.stencilWriteMaskFront===R.stencilWriteMask.writeMask&&n.dss.stencilWriteMaskBack===R.stencilWriteMask.writeMask||(i.stencilMask(R.stencilWriteMask.writeMask),n.dss.stencilWriteMaskFront=R.stencilWriteMask.writeMask,n.dss.stencilWriteMaskBack=R.stencilWriteMask.writeMask)}break;case Mo.STENCIL_COMPARE_MASK:if(R.stencilCompareMask)switch(R.stencilCompareMask.face){case Lo.FRONT:n.dss.stencilRefFront===R.stencilCompareMask.reference&&n.dss.stencilReadMaskFront===R.stencilCompareMask.compareMask||(i.stencilFuncSeparate(i.FRONT,sB[n.dss.stencilFuncFront],R.stencilCompareMask.reference,R.stencilCompareMask.compareMask),n.dss.stencilRefFront=R.stencilCompareMask.reference,n.dss.stencilReadMaskFront=R.stencilCompareMask.compareMask);break;case Lo.BACK:n.dss.stencilRefBack===R.stencilCompareMask.reference&&n.dss.stencilReadMaskBack===R.stencilCompareMask.compareMask||(i.stencilFuncSeparate(i.BACK,sB[n.dss.stencilFuncBack],R.stencilCompareMask.reference,R.stencilCompareMask.compareMask),n.dss.stencilRefBack=R.stencilCompareMask.reference,n.dss.stencilReadMaskBack=R.stencilCompareMask.compareMask);break;case Lo.ALL:n.dss.stencilRefFront===R.stencilCompareMask.reference&&n.dss.stencilReadMaskFront===R.stencilCompareMask.compareMask&&n.dss.stencilRefBack===R.stencilCompareMask.reference&&n.dss.stencilReadMaskBack===R.stencilCompareMask.compareMask||(i.stencilFunc(sB[n.dss.stencilFuncBack],R.stencilCompareMask.reference,R.stencilCompareMask.compareMask),n.dss.stencilRefFront=R.stencilCompareMask.reference,n.dss.stencilReadMaskFront=R.stencilCompareMask.compareMask,n.dss.stencilRefBack=R.stencilCompareMask.reference,n.dss.stencilReadMaskBack=R.stencilCompareMask.compareMask)}}}break;case aB.DRAW:var Et=t.drawCmds.array[p],Tt=e.ANGLE_instanced_arrays;if(h&&u)if(h.gpuIndirectBuffer)for(var St=h.gpuIndirectBuffer.indirects.length,xt=0;xt<St;xt++){var At=h.gpuIndirectBuffer.indirects[xt],wt=h.gpuIndexBuffer;if(At.instanceCount&&Tt)if(wt&&At.indexCount>-1){var Ct=At.firstIndex*wt.stride;Tt.drawElementsInstancedANGLE(f,At.indexCount,h.glIndexType,Ct,At.instanceCount)}else Tt.drawArraysInstancedANGLE(f,At.firstVertex,At.vertexCount,At.instanceCount);else if(wt&&At.indexCount>-1){var Rt=At.firstIndex*wt.stride;i.drawElements(f,At.indexCount,h.glIndexType,Rt)}else i.drawArrays(f,At.firstVertex,At.vertexCount)}else{var kt=h.gpuIndexBuffer;if(Et.drawInfo.instanceCount&&Tt)if(kt&&Et.drawInfo.indexCount>-1){var Ot=Et.drawInfo.firstIndex*kt.stride;Tt.drawElementsInstancedANGLE(f,Et.drawInfo.indexCount,h.glIndexType,Ot,Et.drawInfo.instanceCount)}else Tt.drawArraysInstancedANGLE(f,Et.drawInfo.firstVertex,Et.drawInfo.vertexCount,Et.drawInfo.instanceCount);else if(kt&&Et.drawInfo.indexCount>-1){var It=Et.drawInfo.firstIndex*kt.stride;i.drawElements(f,Et.drawInfo.indexCount,h.glIndexType,It)}else i.drawArrays(f,Et.drawInfo.firstVertex,Et.drawInfo.vertexCount)}break;case aB.UPDATE_BUFFER:var Mt=t.updateBufferCmds.array[p];vB(e,Mt.gpuBuffer,Mt.buffer,Mt.offset,Mt.size);break;case aB.COPY_BUFFER_TO_TEXTURE:var Lt=t.copyBufferToTextureCmds.array[p];bB(e,[Lt.gpuBuffer.buffer],Lt.gpuTexture,Lt.regions)}}}function bB(e,t,i,n){var r=e.gl,a=e.stateCache.glTexUnits[e.stateCache.texUnit];a.glTexture!==i.glTexture&&(r.bindTexture(i.glTarget,i.glTexture),a.glTexture=i.glTexture);var s=0,o=0,l=1,u=1,c=0,h=Go[i.format].isCompressed;switch(i.glTarget){case r.TEXTURE_2D:for(var f=0;f<n.length;f++){var _=n[f];for(l=_.texExtent.width,u=_.texExtent.height,s=_.texSubres.baseMipLevel;s<_.texSubres.levelCount;++s){var d=t[o++];h?i.glInternelFmt!==ZP.COMPRESSED_RGB_ETC1_WEBGL?r.compressedTexSubImage2D(r.TEXTURE_2D,s,_.texOffset.x,_.texOffset.y,l,u,i.glFormat,d):r.compressedTexImage2D(r.TEXTURE_2D,s,i.glInternelFmt,l,u,0,d):r.texSubImage2D(r.TEXTURE_2D,s,_.texOffset.x,_.texOffset.y,l,u,i.glFormat,i.glType,d),l=Math.max(1,l>>1),u=Math.max(1,l>>1)}}break;case r.TEXTURE_CUBE_MAP:for(var p=0;p<n.length;p++){var m=n[p];o=0;var v=m.texSubres.baseArrayLayer+m.texSubres.layerCount;for(c=m.texSubres.baseArrayLayer;c<v;++c){l=m.texExtent.width,u=m.texExtent.height;var g=m.texSubres.baseMipLevel+m.texSubres.levelCount;for(s=m.texSubres.baseMipLevel;s<g;++s){var y=t[o++];h?i.glInternelFmt!==ZP.COMPRESSED_RGB_ETC1_WEBGL?r.compressedTexSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+c,s,m.texOffset.x,m.texOffset.y,l,u,i.glFormat,y):r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+c,s,i.glInternelFmt,l,u,0,y):r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+c,s,m.texOffset.x,m.texOffset.y,l,u,i.glFormat,i.glType,y),l=Math.max(1,l>>1),u=Math.max(1,l>>1)}}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}i.flags&So.GEN_MIPMAP&&r.generateMipmap(i.glTarget)}var EB=function(e){function t(e){var n;return i(this,t),(n=c(this,o(t).call(this,e)))._gpuBuffer=null,n._uniformBuffer=null,n._indirectBuffer=null,n}return s(t,e),r(t,[{key:"gpuBuffer",get:function(){return this._gpuBuffer}}]),r(t,[{key:"initialize",value:function(e){return this._usage=e.usage,this._memUsage=e.memUsage,this._size=e.size,this._stride=Math.max(e.stride||this._size,1),this._count=this._size/this._stride,this._flags=void 0!==e.flags?e.flags:so.NONE,this._usage&ro.INDIRECT?this._indirectBuffer={drawInfos:[]}:this._usage&ro.UNIFORM&&this._size>0&&(this._uniformBuffer=new Uint8Array(this._size)),this._flags&so.BAKUP_BUFFER&&(this._bufferView=new Uint8Array(this._size)),this._gpuBuffer={usage:e.usage,memUsage:e.memUsage,size:e.size,stride:this._stride,buffer:null,vf32:null,indirects:[],glTarget:0,glBuffer:null},e.usage&ro.INDIRECT?this._gpuBuffer.indirects=this._indirectBuffer.drawInfos:this._usage&ro.UNIFORM&&(this._gpuBuffer.buffer=this._uniformBuffer),function(e,t){var i=e.gl,n=e.stateCache,r=t.memUsage&ao.HOST?i.DYNAMIC_DRAW:i.STATIC_DRAW;if(t.usage&ro.VERTEX){t.glTarget=i.ARRAY_BUFFER;var a=i.createBuffer();a&&(t.glBuffer=a,t.size>0&&(e.useVAO&&n.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),n.glVAO=null),e.stateCache.glArrayBuffer!==t.glBuffer&&(i.bindBuffer(i.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer),i.bufferData(i.ARRAY_BUFFER,t.size,r),i.bindBuffer(i.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null))}else if(t.usage&ro.INDEX){t.glTarget=i.ELEMENT_ARRAY_BUFFER;var s=i.createBuffer();s&&(t.glBuffer=s,t.size>0&&(e.useVAO&&n.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),n.glVAO=null),e.stateCache.glElementArrayBuffer!==t.glBuffer&&(i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer),i.bufferData(i.ELEMENT_ARRAY_BUFFER,t.size,r),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null))}else t.usage&ro.UNIFORM?(t.glTarget=i.NONE,t.buffer&&(t.vf32=new Float32Array(t.buffer.buffer))):t.usage&ro.INDIRECT?t.glTarget=i.NONE:t.usage&ro.TRANSFER_DST?t.glTarget=i.NONE:t.usage&ro.TRANSFER_SRC?t.glTarget=i.NONE:(console.error("Unsupported GFXBufferType, create buffer failed."),t.glTarget=i.NONE)}(this._device,this._gpuBuffer),this._device.memoryStatus.bufferSize+=this._size,this._status=Ks.SUCCESS,!0}},{key:"destroy",value:function(){var e,t;this._gpuBuffer&&(e=this._device,(t=this._gpuBuffer).glBuffer&&(e.gl.deleteBuffer(t.glBuffer),t.glBuffer=null),this._device.memoryStatus.bufferSize-=this._size,this._gpuBuffer=null),this._bufferView=null,this._status=Ks.UNREADY}},{key:"resize",value:function(e){var t,i,n,r,a,s=this._size;if(this._size=e,this._count=this._size/this._stride,this._uniformBuffer&&(this._uniformBuffer=new Uint8Array(this._size)),this._bufferView&&s!==e){var o=this._bufferView;this._bufferView=new Uint8Array(this._size),this._bufferView.set(o),this._gpuBuffer&&(this._gpuBuffer.buffer=this._bufferView)}this._gpuBuffer&&(this._uniformBuffer&&(this._gpuBuffer.buffer=this._uniformBuffer),this._gpuBuffer.size=this._size,this._size>0&&(t=this._device,i=this._gpuBuffer,n=t.gl,r=t.stateCache,a=i.memUsage&ao.HOST?n.DYNAMIC_DRAW:n.STATIC_DRAW,i.usage&ro.VERTEX?(t.useVAO&&r.glVAO&&(t.OES_vertex_array_object.bindVertexArrayOES(null),r.glVAO=null),t.stateCache.glArrayBuffer!==i.glBuffer&&n.bindBuffer(n.ARRAY_BUFFER,i.glBuffer),i.buffer?n.bufferData(n.ARRAY_BUFFER,i.buffer,a):n.bufferData(n.ARRAY_BUFFER,i.size,a),n.bindBuffer(n.ARRAY_BUFFER,null),t.stateCache.glArrayBuffer=null):i.usage&ro.INDEX?(t.useVAO&&r.glVAO&&(t.OES_vertex_array_object.bindVertexArrayOES(null),r.glVAO=null),t.stateCache.glElementArrayBuffer!==i.glBuffer&&n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,i.glBuffer),i.buffer?n.bufferData(n.ELEMENT_ARRAY_BUFFER,i.buffer,a):n.bufferData(n.ELEMENT_ARRAY_BUFFER,i.size,a),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),t.stateCache.glElementArrayBuffer=null):i.usage&ro.UNIFORM?i.buffer&&(i.vf32=new Float32Array(i.buffer.buffer)):i.usage&ro.INDIRECT||i.usage&ro.TRANSFER_DST||i.usage&ro.TRANSFER_SRC?i.glTarget=n.NONE:(console.error("Unsupported GFXBufferType, create buffer failed."),i.glTarget=n.NONE),this._device.memoryStatus.bufferSize-=s,this._device.memoryStatus.bufferSize+=this._size,this._bufferView&&(this._device.memoryStatus.bufferSize-=s,this._device.memoryStatus.bufferSize+=this._size)))}},{key:"update",value:function(e,t,i){var n;if(n=void 0!==i?i:this._usage&ro.INDIRECT?0:e.byteLength,this._bufferView&&e!==this._bufferView.buffer){var r=new Uint8Array(e,0,i);this._bufferView.set(r,t)}vB(this._device,this._gpuBuffer,e,t||0,n)}}]),t}(H_),TB=function(){function e(t,n){i(this,e),this._freeIdx=0,this._frees=new Array(n),this._freeCmds=new Ja(n);for(var r=0;r<n;++r)this._frees[r]=new t;this._freeIdx=n-1}return r(e,[{key:"alloc",value:function(e){if(this._freeIdx<0){var t=2*this._frees.length,i=this._frees;this._frees=new Array(t);for(var n=t-i.length,r=0;r<n;++r)this._frees[r]=new e;for(var a=n,s=0;a<t;++a,++s)this._frees[a]=i[s];this._freeIdx+=n}var o=this._frees[this._freeIdx];return this._frees[this._freeIdx--]=null,++o.refCount,o}},{key:"free",value:function(e){0==--e.refCount&&this._freeCmds.push(e)}},{key:"freeCmds",value:function(e){for(var t=0;t<e.length;++t)0==--e.array[t].refCount&&this._freeCmds.push(e.array[t])}},{key:"release",value:function(){for(var e=0;e<this._freeCmds.length;++e){var t=this._freeCmds.array[e];t.clear(),this._frees[++this._freeIdx]=t}this._freeCmds.clear()}}]),e}(),SB=function(e){function t(e){var n;return i(this,t),(n=c(this,o(t).call(this,e))).beginRenderPassCmdPool=new TB(hB,1),n.bindStatesCmdPool=new TB(fB,1),n.drawCmdPool=new TB(_B,1),n.updateBufferCmdPool=new TB(dB,1),n.copyBufferToTextureCmdPool=new TB(pB,1),n}return s(t,e),r(t,[{key:"initialize",value:function(e){return this._status=Ks.SUCCESS,!0}},{key:"destroy",value:function(){this._status=Ks.UNREADY}},{key:"clearCmds",value:function(e){e.beginRenderPassCmds.length&&(this.beginRenderPassCmdPool.freeCmds(e.beginRenderPassCmds),e.beginRenderPassCmds.clear()),e.bindStatesCmds.length&&(this.bindStatesCmdPool.freeCmds(e.bindStatesCmds),e.bindStatesCmds.clear()),e.drawCmds.length&&(this.drawCmdPool.freeCmds(e.drawCmds),e.drawCmds.clear()),e.updateBufferCmds.length&&(this.updateBufferCmdPool.freeCmds(e.updateBufferCmds),e.updateBufferCmds.clear()),e.copyBufferToTextureCmds.length&&(this.copyBufferToTextureCmdPool.freeCmds(e.copyBufferToTextureCmds),e.copyBufferToTextureCmds.clear()),e.cmds.clear()}},{key:"releaseCmds",value:function(){this.beginRenderPassCmdPool.release(),this.bindStatesCmdPool.release(),this.drawCmdPool.release(),this.updateBufferCmdPool.release(),this.copyBufferToTextureCmdPool.release()}}]),t}(od),xB=function(e){function t(e){var n;return i(this,t),(n=c(this,o(t).call(this,e))).cmdPackage=new mB,n._webGLAllocator=null,n._isInRenderPass=!1,n._curGPUPipelineState=null,n._curGPUBindingLayout=null,n._curGPUInputAssembler=null,n._curViewport=null,n._curScissor=null,n._curLineWidth=null,n._curDepthBias=null,n._curBlendConstants=[],n._curDepthBounds=null,n._curStencilWriteMask=null,n._curStencilCompareMask=null,n._isStateInvalied=!1,n}return s(t,e),r(t,[{key:"initialize",value:function(e){return!!e.allocator&&(this._allocator=e.allocator,this._webGLAllocator=this._allocator,this._type=e.type,this._status=Ks.SUCCESS,!0)}},{key:"destroy",value:function(){this._webGLAllocator&&(this._webGLAllocator.clearCmds(this.cmdPackage),this._allocator=null,this._webGLAllocator=null),this._status=Ks.UNREADY}},{key:"begin",value:function(){this._webGLAllocator.clearCmds(this.cmdPackage),this._curGPUPipelineState=null,this._curGPUBindingLayout=null,this._curGPUInputAssembler=null,this._curViewport=null,this._curScissor=null,this._curLineWidth=null,this._curDepthBias=null,this._curBlendConstants=[],this._curDepthBounds=null,this._curStencilWriteMask=null,this._curStencilCompareMask=null,this._numDrawCalls=0,this._numTris=0}},{key:"end",value:function(){this._isStateInvalied&&this.bindStates(),this._isInRenderPass=!1}},{key:"beginRenderPass",value:function(e,t,i,n,r,a){var s=this._webGLAllocator.beginRenderPassCmdPool.alloc(hB);s.gpuFramebuffer=e.gpuFramebuffer,s.renderArea=t,s.clearFlag=i,s.clearColors.length=n.length;for(var o=0;o<n.length;++o)s.clearColors[o]=n[o];s.clearDepth=r,s.clearStencil=a,this.cmdPackage.beginRenderPassCmds.push(s),this.cmdPackage.cmds.push(aB.BEGIN_RENDER_PASS),this._isInRenderPass=!0}},{key:"endRenderPass",value:function(){this._isInRenderPass=!1}},{key:"bindPipelineState",value:function(e){var t=e.gpuPipelineState;this._curGPUPipelineState=t,this._isStateInvalied=!0}},{key:"bindBindingLayout",value:function(e){var t=e.gpuBindingLayout;this._curGPUBindingLayout=t,this._isStateInvalied=!0}},{key:"bindInputAssembler",value:function(e){var t=e.gpuInputAssembler;this._curGPUInputAssembler=t,this._isStateInvalied=!0}},{key:"setViewport",value:function(e){this._curViewport?this._curViewport.left===e.left&&this._curViewport.top===e.top&&this._curViewport.width===e.width&&this._curViewport.height===e.height&&this._curViewport.minDepth===e.minDepth&&this._curViewport.maxDepth===e.maxDepth||(this._curViewport.left=e.left,this._curViewport.top=e.top,this._curViewport.width=e.width,this._curViewport.height=e.height,this._curViewport.minDepth=e.minDepth,this._curViewport.maxDepth=e.maxDepth,this._isStateInvalied=!0):this._curViewport={left:e.left,top:e.top,width:e.width,height:e.height,minDepth:e.minDepth,maxDepth:e.maxDepth},this._curViewport!==e&&(this._curViewport=e,this._isStateInvalied=!0)}},{key:"setScissor",value:function(e){this._curScissor?this._curScissor.x===e.x&&this._curScissor.y===e.y&&this._curScissor.width===e.width&&this._curScissor.height===e.height||(this._curScissor.x=e.x,this._curScissor.y=e.y,this._curScissor.width=e.width,this._curScissor.height=e.height,this._isStateInvalied=!0):this._curScissor={x:e.x,y:e.y,width:e.width,height:e.height}}},{key:"setLineWidth",value:function(e){this._curLineWidth!==e&&(this._curLineWidth=e,this._isStateInvalied=!0)}},{key:"setDepthBias",value:function(e,t,i){this._curDepthBias?this._curDepthBias.constantFactor===e&&this._curDepthBias.clamp===t&&this._curDepthBias.slopeFactor===i||(this._curDepthBias.constantFactor=e,this._curDepthBias.clamp=t,this._curDepthBias.slopeFactor=i,this._isStateInvalied=!0):(this._curDepthBias={constantFactor:e,clamp:t,slopeFactor:i},this._isStateInvalied=!0)}},{key:"setBlendConstants",value:function(e){(this._curBlendConstants||4!==e.length)&&(4!==e.length||this._curBlendConstants[0]===e[0]&&this._curBlendConstants[1]===e[1]&&this._curBlendConstants[2]===e[2]&&this._curBlendConstants[3]===e[3])||(this._curBlendConstants=[e[0],e[1],e[2],e[3]],this._isStateInvalied=!0)}},{key:"setDepthBound",value:function(e,t){this._curDepthBounds&&this._curDepthBounds.minBounds===e&&this._curDepthBounds.maxBounds===t||(this._curDepthBounds={minBounds:e,maxBounds:t},this._isStateInvalied=!0)}},{key:"setStencilWriteMask",value:function(e,t){this._curStencilWriteMask?this._curStencilWriteMask.face===e&&this._curStencilWriteMask.writeMask===t||(this._curStencilWriteMask.face=e,this._curStencilWriteMask.writeMask=t,this._isStateInvalied=!0):(this._curStencilWriteMask={face:e,writeMask:t},this._isStateInvalied=!0)}},{key:"setStencilCompareMask",value:function(e,t,i){this._curStencilCompareMask?this._curStencilCompareMask.face===e&&this._curStencilCompareMask.reference===t&&this._curStencilCompareMask.compareMask===i||(this._curStencilCompareMask.face=e,this._curStencilCompareMask.reference=t,this._curStencilCompareMask.compareMask=i,this._isStateInvalied=!0):(this._curStencilCompareMask={face:e,reference:t,compareMask:i},this._isStateInvalied=!0)}},{key:"draw",value:function(e){if(this._type===Co.PRIMARY&&this._isInRenderPass||this._type===Co.SECONDARY){this._isStateInvalied&&this.bindStates();var t=this._allocator.drawCmdPool.alloc(_B);e.extractCmdDraw(t),this.cmdPackage.drawCmds.push(t),this.cmdPackage.cmds.push(aB.DRAW),++this._numDrawCalls;var i=e.indexCount||e.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=i/3*Math.max(e.instanceCount,1);break;case 5:case 6:this._numTris+=(i-2)*Math.max(e.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")}},{key:"updateBuffer",value:function(e,t,i,n){if(this._type===Co.PRIMARY&&!this._isInRenderPass||this._type===Co.SECONDARY){var r=e.gpuBuffer;if(r){var a=this._webGLAllocator.updateBufferCmdPool.alloc(dB);if(a){var s;s=void 0!==n?n:e.usage&ro.INDIRECT?0:t.byteLength;var o=t;a.gpuBuffer=r,a.buffer=o,a.offset=void 0!==i?i:0,a.size=s,this.cmdPackage.updateBufferCmds.push(a),this.cmdPackage.cmds.push(aB.UPDATE_BUFFER)}}}else console.error("Command 'updateBuffer' must be recorded outside a render pass.")}},{key:"copyBufferToTexture",value:function(e,t,i,n){if(this._type===Co.PRIMARY&&!this._isInRenderPass||this._type===Co.SECONDARY){var r=e.gpuBuffer,a=t.gpuTexture;if(r&&a){var s=this._webGLAllocator.copyBufferToTextureCmdPool.alloc(pB);s&&(s.gpuBuffer=r,s.gpuTexture=a,s.dstLayout=i,s.regions=n,this.cmdPackage.copyBufferToTextureCmds.push(s),this.cmdPackage.cmds.push(aB.COPY_BUFFER_TO_TEXTURE))}}else console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.")}},{key:"execute",value:function(e,t){for(var i=0;i<t;++i){for(var n=e[i],r=0;r<n.cmdPackage.beginRenderPassCmds.length;++r){var a=n.cmdPackage.beginRenderPassCmds.array[r];++a.refCount,this.cmdPackage.beginRenderPassCmds.push(a)}for(var s=0;s<n.cmdPackage.bindStatesCmds.length;++s){var o=n.cmdPackage.bindStatesCmds.array[s];++o.refCount,this.cmdPackage.bindStatesCmds.push(o)}for(var l=0;l<n.cmdPackage.drawCmds.length;++l){var u=n.cmdPackage.drawCmds.array[l];++u.refCount,this.cmdPackage.drawCmds.push(u)}for(var c=0;c<n.cmdPackage.updateBufferCmds.length;++c){var h=n.cmdPackage.updateBufferCmds.array[c];++h.refCount,this.cmdPackage.updateBufferCmds.push(h)}for(var f=0;f<n.cmdPackage.copyBufferToTextureCmds.length;++f){var _=n.cmdPackage.copyBufferToTextureCmds.array[f];++_.refCount,this.cmdPackage.copyBufferToTextureCmds.push(_)}this.cmdPackage.cmds.concat(n.cmdPackage.cmds.array),this._numDrawCalls+=n._numDrawCalls,this._numTris+=n._numTris}}},{key:"bindStates",value:function(){var e=this._webGLAllocator.bindStatesCmdPool.alloc(fB);e&&(e.gpuPipelineState=this._curGPUPipelineState,e.gpuBindingLayout=this._curGPUBindingLayout,e.gpuInputAssembler=this._curGPUInputAssembler,e.viewport=this._curViewport,e.scissor=this._curScissor,e.lineWidth=this._curLineWidth,e.depthBias=this._curDepthBias,e.blendConstants=this._curBlendConstants,e.depthBounds=this._curDepthBounds,e.stencilWriteMask=this._curStencilWriteMask,e.stencilCompareMask=this._curStencilCompareMask,this.cmdPackage.bindStatesCmds.push(e),this.cmdPackage.cmds.push(aB.BIND_STATES),this._isStateInvalied=!1)}},{key:"webGLDevice",get:function(){return this._device}}]),t}(W_),AB=function(e){function t(e){var n;return i(this,t),(n=c(this,o(t).call(this,e)))._gpuFramebuffer=null,n}return s(t,e),r(t,[{key:"gpuFramebuffer",get:function(){return this._gpuFramebuffer}}]),r(t,[{key:"initialize",value:function(e){if(this._renderPass=e.renderPass,this._colorViews=e.colorViews||[],this._depthStencilView=e.depthStencilView||null,this._isOffscreen=void 0===e.isOffscreen||e.isOffscreen,this._isOffscreen){var t=[];if(void 0!==e.colorViews){var i=e.colorViews,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;t.push(s.gpuTextureView)}}var o=null;e.depthStencilView&&(o=e.depthStencilView.gpuTextureView),this._gpuFramebuffer={gpuRenderPass:e.renderPass.gpuRenderPass,gpuColorViews:t,gpuDepthStencilView:o,isOffscreen:this._isOffscreen,glFramebuffer:null},function(e,t){if(t.isOffscreen){var i=e.gl,n=[],r=i.createFramebuffer();if(r){t.glFramebuffer=r,e.stateCache.glFramebuffer!==t.glFramebuffer&&(i.bindFramebuffer(i.FRAMEBUFFER,t.glFramebuffer),e.stateCache.glFramebuffer=t.glFramebuffer);for(var a=0;a<t.gpuColorViews.length;++a){var s=t.gpuColorViews[a];s&&(s.gpuTexture.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+a,s.gpuTexture.glTarget,s.gpuTexture.glTexture,s.baseLevel):i.framebufferRenderbuffer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+a,i.RENDERBUFFER,s.gpuTexture.glRenderbuffer),n.push(i.COLOR_ATTACHMENT0+a))}var o=t.gpuDepthStencilView;if(o){var l=Go[o.format].hasStencil?i.DEPTH_STENCIL_ATTACHMENT:i.DEPTH_ATTACHMENT;o.gpuTexture.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,l,o.gpuTexture.glTarget,o.gpuTexture.glTexture,o.baseLevel):i.framebufferRenderbuffer(i.FRAMEBUFFER,l,i.RENDERBUFFER,o.gpuTexture.glRenderbuffer)}e.WEBGL_draw_buffers&&e.WEBGL_draw_buffers.drawBuffersWEBGL(n);var u=i.checkFramebufferStatus(i.FRAMEBUFFER);if(u!==i.FRAMEBUFFER_COMPLETE)switch(u){case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case i.FRAMEBUFFER_UNSUPPORTED:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_UNSUPPORTED")}}}}(this._device,this._gpuFramebuffer)}else this._gpuFramebuffer={gpuRenderPass:e.renderPass.gpuRenderPass,gpuColorViews:[],gpuDepthStencilView:null,isOffscreen:!1,glFramebuffer:null};return this._status=Ks.SUCCESS,!0}},{key:"destroy",value:function(){var e,t;this._isOffscreen&&this._gpuFramebuffer&&(e=this._device,(t=this._gpuFramebuffer).glFramebuffer&&(e.gl.deleteFramebuffer(t.glFramebuffer),t.glFramebuffer=null)),this._gpuFramebuffer=null,this._status=Ks.UNREADY}}]),t}(j_),wB=function(e){function t(e){var n;return i(this,t),(n=c(this,o(t).call(this,e)))._gpuInputAssembler=null,n}return s(t,e),r(t,[{key:"gpuInputAssembler",get:function(){return this._gpuInputAssembler}}]),r(t,[{key:"initialize",value:function(e){if(0===e.vertexBuffers.length)return console.error("GFXInputAssemblerInfo.vertexBuffers is null."),!1;if(this._attributes=e.attributes,this._vertexBuffers=e.vertexBuffers,void 0!==e.indexBuffer)this._indexBuffer=e.indexBuffer,this._indexCount=this._indexBuffer.size/this._indexBuffer.stride;else{var t=this._vertexBuffers[0];this._vertexCount=t.size/t.stride}this._indirectBuffer=e.indirectBuffer||null;for(var i=new Array(e.vertexBuffers.length),n=0;n<e.vertexBuffers.length;++n){var r=e.vertexBuffers[n];r.gpuBuffer&&(i[n]=r.gpuBuffer)}var a=null,s=0;if(e.indexBuffer&&(a=e.indexBuffer.gpuBuffer))switch(a.stride){case 1:s=5121;break;case 2:s=5123;break;case 4:s=5125;break;default:console.error("Error index buffer stride.")}var o=null;return void 0!==e.indirectBuffer&&(o=e.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:e.attributes,gpuVertexBuffers:i,gpuIndexBuffer:a,gpuIndirectBuffer:o,glAttribs:[],glIndexType:s,glVAOs:new Map},function(e,t){var i=e.gl;t.glAttribs=new Array(t.attributes.length);for(var n=[0,0,0,0,0,0,0,0],r=0;r<t.attributes.length;++r){var a=t.attributes[r],s=void 0!==a.stream?a.stream:0,o=t.gpuVertexBuffers[s],l=JP(a.format,i),u=Go[a.format].size;t.glAttribs[r]={name:a.name,glBuffer:o.glBuffer,glType:l,size:u,count:Go[a.format].count,stride:o.stride,componentCount:rB(l,i),isNormalized:void 0!==a.isNormalized&&a.isNormalized,isInstanced:void 0!==a.isInstanced&&a.isInstanced,offset:n[s]},n[s]+=u}}(this._device,this._gpuInputAssembler),this._status=Ks.SUCCESS,!0}},{key:"destroy",value:function(){var e=this._device;this._gpuInputAssembler&&e.useVAO&&function(e,t){for(var i=t.glVAOs.values(),n=i.next();!n.done;)e.OES_vertex_array_object.deleteVertexArrayOES(n.value),n=i.next();t.glVAOs.clear()}(e,this._gpuInputAssembler),this._gpuInputAssembler=null,this._status=Ks.UNREADY}},{key:"extractCmdDraw",value:function(e){e.drawInfo.vertexCount=this._vertexCount,e.drawInfo.firstVertex=this._firstVertex,e.drawInfo.indexCount=this._indexCount,e.drawInfo.firstIndex=this._firstIndex,e.drawInfo.vertexOffset=this._vertexOffset,e.drawInfo.instanceCount=this._instanceCount,e.drawInfo.firstInstance=this._firstInstance}}]),t}(J_),CB=function(e){function t(e){var n;return i(this,t),(n=c(this,o(t).call(this,e)))._gpuPipelineLayout=null,n}return s(t,e),r(t,[{key:"gpuPipelineLayout",get:function(){return this._gpuPipelineLayout}}]),r(t,[{key:"initialize",value:function(e){return this._layouts=e.layouts,this._pushConstantsRanges=e.pushConstantsRanges||[],this._status=Ks.SUCCESS,!0}},{key:"destroy",value:function(){this._status=Ks.UNREADY}}]),t}($_),RB=[0,1,3,2,0,0,0,4,5,6,0,0,0,0],kB=function(e){function t(e){var n;return i(this,t),(n=c(this,o(t).call(this,e)))._gpuPipelineState=null,n}return s(t,e),r(t,[{key:"gpuPipelineState",get:function(){return this._gpuPipelineState}}]),r(t,[{key:"initialize",value:function(e){return this._primitive=e.primitive,this._shader=e.shader,this._is=e.inputState,this._rs=e.rasterizerState,this._dss=e.depthStencilState,this._bs=e.blendState,this._dynamicStates=e.dynamicStates||[],this._hash=e.hash,this._layout=e.layout,this._renderPass=e.renderPass,this._gpuPipelineState={glPrimitive:RB[e.primitive],gpuShader:e.shader.gpuShader,rs:e.rasterizerState,dss:e.depthStencilState,bs:e.blendState,dynamicStates:void 0!==e.dynamicStates?e.dynamicStates:[],gpuLayout:e.layout.gpuPipelineLayout,gpuRenderPass:e.renderPass.gpuRenderPass},this._status=Ks.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuPipelineState=null,this._status=Ks.UNREADY}}]),t}(G_),OB=function(e){function t(e){var n;return i(this,t),(n=c(this,o(t).call(this,e))).numDrawCalls=0,n.numTris=0,n._isAsync=!1,n}return s(t,e),r(t,[{key:"initialize",value:function(e){return this._type=e.type,this._status=Ks.SUCCESS,!0}},{key:"destroy",value:function(){this._status=Ks.UNREADY}},{key:"submit",value:function(e,t){if(!this._isAsync)for(var i=e.length,n=0;n<i;n++){var r=e[n];yB(this._device,r.cmdPackage),this.numDrawCalls+=r.numDrawCalls,this.numTris+=r.numTris}}},{key:"clear",value:function(){this.numDrawCalls=0,this.numTris=0}}]),t}(ed),IB=function(e){function t(e){var n;return i(this,t),(n=c(this,o(t).call(this,e)))._gpuRenderPass=null,n}return s(t,e),r(t,[{key:"gpuRenderPass",get:function(){return this._gpuRenderPass}}]),r(t,[{key:"initialize",value:function(e){return this._colorInfos=e.colorAttachments||[],this._depthStencilInfo=e.depthStencilAttachment||null,this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._status=Ks.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuRenderPass=null,this._status=Ks.UNREADY}}]),t}(td),MB=[10497,33648,33071,33071],LB=function(e){function t(e){var n;return i(this,t),(n=c(this,o(t).call(this,e)))._gpuSampler=null,n._state=new id,n}return s(t,e),r(t,[{key:"gpuSampler",get:function(){return this._gpuSampler}}]),r(t,[{key:"initialize",value:function(e){void 0!==e.name&&(this._state.name=e.name),void 0!==e.minFilter&&(this._state.minFilter=e.minFilter),void 0!==e.magFilter&&(this._state.magFilter=e.magFilter),void 0!==e.mipFilter&&(this._state.mipFilter=e.mipFilter),void 0!==e.addressU&&(this._state.addressU=e.addressU),void 0!==e.addressV&&(this._state.addressV=e.addressV),void 0!==e.addressW&&(this._state.addressW=e.addressW),void 0!==e.maxAnisotropy&&(this._state.maxAnisotropy=e.maxAnisotropy),void 0!==e.cmpFunc&&(this._state.cmpFunc=e.cmpFunc),void 0!==e.borderColor&&(this._state.borderColor=e.borderColor),void 0!==e.minLOD&&(this._state.minLOD=e.minLOD),void 0!==e.maxLOD&&(this._state.maxLOD=e.maxLOD),void 0!==e.mipLODBias&&(this._state.mipLODBias=e.mipLODBias);var t=0,i=0,n=this._state.minFilter,r=this._state.magFilter,a=this._state.mipFilter;t=n===go.LINEAR||n===go.ANISOTROPIC?a===go.LINEAR||a===go.ANISOTROPIC?9987:a===go.POINT?9985:9729:a===go.LINEAR||a===go.ANISOTROPIC?9986:a===go.POINT?9984:9728,i=r===go.LINEAR||r===go.ANISOTROPIC?9729:9728;var s=MB[this._state.addressU],o=MB[this._state.addressV],l=MB[this._state.addressW];return this._gpuSampler={glMinFilter:t,glMagFilter:i,glWrapS:s,glWrapT:o,glWrapR:l},this._status=Ks.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuSampler=null,this._status=Ks.UNREADY}}]),t}(nd),PB=function(e){function n(e){var t;return i(this,n),(t=c(this,o(n).call(this,e)))._gpuShader=null,t}return s(n,e),r(n,[{key:"gpuShader",get:function(){return this._gpuShader}}]),r(n,[{key:"initialize",value:function(e){this._name=e.name,this._stages=e.stages,void 0!==e.blocks&&(this._blocks=e.blocks),void 0!==e.samplers&&(this._samplers=e.samplers),this._gpuShader={name:e.name?e.name:"",blocks:void 0!==e.blocks?e.blocks:[],samplers:void 0!==e.samplers?e.samplers:[],gpuStages:new Array(e.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplers:[]};for(var i=0;i<e.stages.length;++i){var n=e.stages[i];this._gpuShader.gpuStages[i]={type:n.type,source:n.source,macros:n.macros?n.macros:[],glShader:null}}return function(e,i){for(var n=e.gl,r=function(e){var t=i.gpuStages[e],r=0,a="",s=1;switch(t.type){case Ao.VERTEX:a="VertexShader",r=n.VERTEX_SHADER;break;case Ao.FRAGMENT:a="FragmentShader",r=n.FRAGMENT_SHADER;break;default:return console.error("Unsupported GFXShaderType."),{v:void 0}}var o=n.createShader(r);if(o&&(t.glShader=o,n.shaderSource(t.glShader,t.source),n.compileShader(t.glShader),!n.getShaderParameter(t.glShader,n.COMPILE_STATUS))){console.error(a+" in '"+i.name+"' compilation failed."),console.error("Shader source dump:",t.source.replace(/^|\n/g,(function(){return"\n".concat(s++," ")}))),console.error(n.getShaderInfoLog(t.glShader));for(var l=0;l<i.gpuStages.length;l++){var u=i.gpuStages[e];u.glShader&&(n.deleteShader(u.glShader),u.glShader=null)}return{v:void 0}}},a=0;a<i.gpuStages.length;a++){var s=r(a);if("object"===t(s))return s.v}var o=n.createProgram();if(o){i.glProgram=o;for(var l=0;l<i.gpuStages.length;l++){var u=i.gpuStages[l];n.attachShader(i.glProgram,u.glShader)}n.linkProgram(i.glProgram);for(var c=0;c<i.gpuStages.length;c++){var h=i.gpuStages[c];h.glShader&&(n.detachShader(i.glProgram,h.glShader),n.deleteShader(h.glShader),h.glShader=null)}if(!n.getProgramParameter(i.glProgram,n.LINK_STATUS))return console.error("Failed to link shader '"+i.name+"'."),void console.error(n.getProgramInfoLog(i.glProgram));console.info("Shader '"+i.name+"' compilation succeeded.");var f=n.getProgramParameter(i.glProgram,n.ACTIVE_ATTRIBUTES);i.glInputs=new Array(f);for(var _=0;_<f;++_){var d=n.getActiveAttrib(i.glProgram,_);if(d){var p=void 0,m=d.name.indexOf("[");p=-1!==m?d.name.substr(0,m):d.name;var v=n.getAttribLocation(i.glProgram,p),g=iB(d.type,n),y=nB(d.type,n);i.glInputs[_]={binding:v,name:p,type:g,stride:y,count:d.size,size:y*d.size,glType:d.type,glLoc:v}}}if(i.blocks.length>0){i.glBlocks=new Array(i.blocks.length);for(var b=0;b<i.blocks.length;++b){var E=i.blocks[b],T={binding:E.binding,name:E.name,size:0,glUniforms:new Array(E.members.length),glActiveUniforms:[],isUniformPackage:!0};i.glBlocks[b]=T;for(var S=0;S<E.members.length;++S){var x=E.members[S],A=tB(x.type,n),w=nB(A,n),C=w*x.count,R=T.size/4,k=new Array(C/4);k.fill(0),T.glUniforms[S]={binding:-1,name:x.name,type:x.type,stride:w,count:x.count,size:C,offset:T.size,glType:A,glLoc:-1,array:k,begin:R},T.size+=C}}}if(i.samplers.length>0){i.glSamplers=new Array(i.samplers.length);for(var O=0;O<i.samplers.length;++O){var I=i.samplers[O];i.glSamplers[O]={binding:I.binding,name:I.name,type:I.type,units:[],glType:tB(I.type,n),glLoc:-1}}}for(var M=n.getProgramParameter(i.glProgram,n.ACTIVE_UNIFORMS),L=0,P=[],B=0;B<M;++B){var D=n.getActiveUniform(i.glProgram,B);if(D){var F=n.getUniformLocation(i.glProgram,D.name);if(null!==F){var N=void 0,z=D.name.indexOf("[");if(N=-1!==z?D.name.substr(0,z):D.name,D.type===n.SAMPLER_2D||D.type===n.SAMPLER_CUBE)for(var U=0;U<i.glSamplers.length;U++){var G=i.glSamplers[U];if(G.name===N){for(var V=0;V<D.size;++V)G.units.push(L+V);G.glLoc=F,L+=D.size,P.push(G);break}}else for(var H=0;H<i.glBlocks.length;H++)for(var W=i.glBlocks[H],j=0;j<W.glUniforms.length;j++){var X=W.glUniforms[j];if(X.name===N){X.glLoc=F,W.glActiveUniforms.push(X);break}}}}}if(P.length){e.stateCache.glProgram!==i.glProgram&&(n.useProgram(i.glProgram),e.stateCache.glProgram=i.glProgram);for(var q=0;q<P.length;q++){var Y=P[q];n.uniform1iv(Y.glLoc,Y.units)}}}}(this._device,this._gpuShader),this._status=Ks.SUCCESS,!0}},{key:"destroy",value:function(){var e,t;this._gpuShader&&(e=this._device,(t=this._gpuShader).glProgram&&(e.gl.deleteProgram(t.glProgram),t.glProgram=null),this._gpuShader=null),this._status=Ks.UNREADY}}]),n}(rd),BB=function e(){i(this,e),this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glVAO=null,this.texUnit=0,this.glRenderbuffer=null,this.glFramebuffer=null,this.glProgram=null,this.glTexUnits=new Array(Js),this.viewport={left:0,top:0,width:0,height:0,minDepth:0,maxDepth:0},this.scissorRect={x:0,y:0,width:0,height:0},this.rs=new D_,this.dss=new F_,this.bs=new z_,this.glEnabledAttribLocs=new Array(Qs),this.glCurrentAttribLocs=new Array(Qs),this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.fill(!1);for(var t=0;t<Js;++t)this.glTexUnits[t]={glTexture:null}};function DB(e){return e>0&&0==(e&e-1)}var FB=function(e){function t(e){var n;return i(this,t),(n=c(this,o(t).call(this,e)))._gpuTexture=null,n}return s(t,e),r(t,[{key:"gpuTexture",get:function(){return this._gpuTexture}}]),r(t,[{key:"initialize",value:function(e){var t;switch(this._type=e.type,this._usage=e.usage,this._format=e.format,this._width=e.width,this._height=e.height,void 0!==e.depth&&(this._depth=e.depth),void 0!==e.arrayLayer&&(this._arrayLayer=e.arrayLayer),void 0!==e.mipLevel&&(this._mipLevel=e.mipLevel),void 0!==e.samples&&(this._samples=e.samples),void 0!==e.flags&&(this._flags=e.flags),this._isPowerOf2=DB(this._width)&&DB(this._height),this._size=Ho(this._format,this.width,this.height,this.depth,this.mipLevel)*this._arrayLayer,this._flags&So.BAKUP_BUFFER&&(this._buffer=new ArrayBuffer(this._size)),e.type){case bo.TEX1D:t=e.arrayLayer?e.arrayLayer<=1?xo.TV1D:xo.TV1D_ARRAY:xo.TV1D;break;case bo.TEX2D:var i=So.NONE;e.flags&&(i=e.flags),t=e.arrayLayer?e.arrayLayer<=1?xo.TV2D:i&So.CUBEMAP?xo.CUBE:xo.TV2D_ARRAY:xo.TV2D;break;case bo.TEX3D:t=xo.TV3D;break;default:t=xo.TV2D}return this._gpuTexture={type:this._type,viewType:t,format:this._format,usage:this._usage,width:this._width,height:this._height,depth:this._depth,size:this._size,arrayLayer:this._arrayLayer,mipLevel:this._mipLevel,samples:this._samples,flags:this._flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternelFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0},function(e,t){var i=e.gl;t.glInternelFmt=$P(t.format,i),t.glFormat=eB(t.format,i),t.glType=JP(t.format,i);var n=t.width,r=t.height;switch(t.viewType){case xo.TV2D:t.viewType=xo.TV2D,t.glTarget=i.TEXTURE_2D;var a=Math.max(n,r);if(a>e.maxTextureSize&&U(9100,a,e.maxTextureSize),!e.WEBGL_depth_texture&&Go[t.format].hasDepth){var s=i.createRenderbuffer();s&&t.size>0&&(t.glRenderbuffer=s,e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(i.bindRenderbuffer(i.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),t.glInternelFmt===i.DEPTH_COMPONENT&&(t.glInternelFmt=i.DEPTH_COMPONENT16),i.renderbufferStorage(i.RENDERBUFFER,t.glInternelFmt,n,r))}else if(t.samples===To.X1){var o=i.createTexture();if(o&&t.size>0){t.glTexture=o;var l=e.stateCache.glTexUnits[e.stateCache.texUnit];if(l.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_2D,t.glTexture),l.glTexture=t.glTexture),Go[t.format].isCompressed)if(t.glInternelFmt!==ZP.COMPRESSED_RGB_ETC1_WEBGL)for(var u=0;u<t.mipLevel;++u){var c=Vo(t.format,n,r,1),h=new Uint8Array(c);i.compressedTexImage2D(i.TEXTURE_2D,u,t.glInternelFmt,n,r,0,h),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}else{var f=Vo(t.format,2,2,1),_=new Uint8Array(f);i.compressedTexImage2D(i.TEXTURE_2D,0,t.glInternelFmt,2,2,0,_)}else for(var d=0;d<t.mipLevel;++d)i.texImage2D(i.TEXTURE_2D,d,t.glInternelFmt,n,r,0,t.glFormat,t.glType,null),n=Math.max(1,n>>1),r=Math.max(1,r>>1);t.isPowerOf2?(t.glWrapS=i.REPEAT,t.glWrapT=i.REPEAT):(t.glWrapS=i.CLAMP_TO_EDGE,t.glWrapT=i.CLAMP_TO_EDGE),t.glMinFilter=i.LINEAR,t.glMagFilter=i.LINEAR,i.texParameteri(t.glTarget,i.TEXTURE_WRAP_S,t.glWrapS),i.texParameteri(t.glTarget,i.TEXTURE_WRAP_T,t.glWrapT),i.texParameteri(t.glTarget,i.TEXTURE_MIN_FILTER,t.glMinFilter),i.texParameteri(t.glTarget,i.TEXTURE_MAG_FILTER,t.glMagFilter)}}break;case xo.CUBE:t.viewType=xo.CUBE,t.glTarget=i.TEXTURE_CUBE_MAP;var p=Math.max(n,r);p>e.maxCubeMapTextureSize&&U(9100,p,e.maxTextureSize);var m=i.createTexture();if(m&&t.size>0){t.glTexture=m;var v=e.stateCache.glTexUnits[e.stateCache.texUnit];if(v.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_CUBE_MAP,t.glTexture),v.glTexture=t.glTexture),Go[t.format].isCompressed)if(t.glInternelFmt!==ZP.COMPRESSED_RGB_ETC1_WEBGL)for(var g=0;g<6;++g){n=t.width,r=t.height;for(var y=0;y<t.mipLevel;++y){var b=Vo(t.format,n,r,1),E=new Uint8Array(b);i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+g,y,t.glInternelFmt,n,r,0,E),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}}else for(var T=0;T<6;++T){var S=Vo(t.format,2,2,1),x=new Uint8Array(S);i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+T,0,t.glInternelFmt,2,2,0,x)}else for(var A=0;A<6;++A){n=t.width,r=t.height;for(var w=0;w<t.mipLevel;++w)i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+A,w,t.glInternelFmt,n,r,0,t.glFormat,t.glType,null),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}t.isPowerOf2?(t.glWrapS=i.REPEAT,t.glWrapT=i.REPEAT):(t.glWrapS=i.CLAMP_TO_EDGE,t.glWrapT=i.CLAMP_TO_EDGE),t.glMinFilter=i.LINEAR,t.glMagFilter=i.LINEAR,i.texParameteri(t.glTarget,i.TEXTURE_WRAP_S,t.glWrapS),i.texParameteri(t.glTarget,i.TEXTURE_WRAP_T,t.glWrapT),i.texParameteri(t.glTarget,i.TEXTURE_MIN_FILTER,t.glMinFilter),i.texParameteri(t.glTarget,i.TEXTURE_MAG_FILTER,t.glMagFilter)}break;default:console.error("Unsupported GFXTextureType, create texture failed."),t.viewType=xo.TV2D,t.glTarget=i.TEXTURE_2D}}(this._device,this._gpuTexture),this._device.memoryStatus.textureSize+=this._size,this._status=Ks.SUCCESS,!0}},{key:"destroy",value:function(){var e,t;this._gpuTexture&&(e=this._device,(t=this._gpuTexture).glTexture&&(e.gl.deleteTexture(t.glTexture),t.glTexture=null),t.glRenderbuffer&&(e.gl.deleteRenderbuffer(t.glRenderbuffer),t.glRenderbuffer=null),this._device.memoryStatus.textureSize-=this._size,this._gpuTexture=null),this._status=Ks.UNREADY,this._buffer=null}},{key:"resize",value:function(e,t){var i=this._size;this._width=e,this._height=t,this._size=Ho(this._format,this.width,this.height,this.depth,this.mipLevel)*this._arrayLayer,this._gpuTexture&&(this._gpuTexture.width=this._width,this._gpuTexture.height=this._height,this._gpuTexture.size=this._size,function(e,t){var i=e.gl;t.glInternelFmt=$P(t.format,i),t.glFormat=eB(t.format,i),t.glType=JP(t.format,i);var n=t.width,r=t.height;switch(t.viewType){case xo.TV2D:t.viewType=xo.TV2D,t.glTarget=i.TEXTURE_2D;var a=Math.max(n,r);if(a>e.maxTextureSize&&U(9100,a,e.maxTextureSize),t.samples===To.X1){var s=e.stateCache.glTexUnits[e.stateCache.texUnit];if(s.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_2D,t.glTexture),s.glTexture=t.glTexture),Go[t.format].isCompressed){if(t.glInternelFmt!==ZP.COMPRESSED_RGB_ETC1_WEBGL)for(var o=0;o<t.mipLevel;++o){var l=Vo(t.format,n,r,1),u=new Uint8Array(l);i.compressedTexImage2D(i.TEXTURE_2D,o,t.glInternelFmt,n,r,0,u),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}}else for(var c=0;c<t.mipLevel;++c)i.texImage2D(i.TEXTURE_2D,c,t.glInternelFmt,n,r,0,t.glFormat,t.glType,null),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}break;case xo.CUBE:t.viewType=xo.CUBE,t.glTarget=i.TEXTURE_CUBE_MAP;var h=Math.max(n,r);h>e.maxCubeMapTextureSize&&U(9100,h,e.maxTextureSize);var f=e.stateCache.glTexUnits[e.stateCache.texUnit];if(f.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_CUBE_MAP,t.glTexture),f.glTexture=t.glTexture),Go[t.format].isCompressed){if(t.glInternelFmt!==ZP.COMPRESSED_RGB_ETC1_WEBGL)for(var _=0;_<6;++_){n=t.width,r=t.height;for(var d=0;d<t.mipLevel;++d){var p=Vo(t.format,n,r,1),m=new Uint8Array(p);i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+_,d,t.glInternelFmt,n,r,0,m),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}}}else for(var v=0;v<6;++v){n=t.width,r=t.height;for(var g=0;g<t.mipLevel;++g)i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+v,g,t.glInternelFmt,n,r,0,t.glFormat,t.glType,null),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}break;default:console.error("Unsupported GFXTextureType, create texture failed."),t.viewType=xo.TV2D,t.glTarget=i.TEXTURE_2D}}(this._device,this._gpuTexture),this._device.memoryStatus.textureSize-=i,this._device.memoryStatus.textureSize+=this._size),this._status=Ks.UNREADY}}]),t}(ad),NB=function(e){function t(e){var n;return i(this,t),(n=c(this,o(t).call(this,e)))._gpuTextureView=null,n}return s(t,e),r(t,[{key:"gpuTextureView",get:function(){return this._gpuTextureView}}]),r(t,[{key:"initialize",value:function(e){return this._texture=e.texture,this._type=e.type,this._format=e.format,void 0!==e.baseLevel&&(this._baseLevel=e.baseLevel),void 0!==e.levelCount&&(this._levelCount=e.levelCount),void 0!==e.baseLayer&&(this._baseLayer=e.baseLayer),void 0!==e.layerCount&&(this._layerCount=e.layerCount),this._gpuTextureView={gpuTexture:e.texture.gpuTexture,type:e.type,format:e.format,baseLevel:e.baseLevel?e.baseLevel:0,levelCount:e.levelCount?e.levelCount:1},this._status=Ks.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuTextureView=null,this._texture=null,this._status=Ks.UNREADY}}]),t}(B_),zB=function(e){function t(e){return i(this,t),c(this,o(t).call(this,e))}return s(t,e),r(t,[{key:"initialize",value:function(e){void 0!==e.title&&(this._title=e.title),void 0!==e.left&&(this._left=e.left),void 0!==e.top&&(this._top=e.top),void 0!==e.isOffscreen&&(this._isOffscreen=e.isOffscreen),this._width=e.width,this._height=e.height,this._nativeWidth=this._width,this._nativeHeight=this._height,this._colorFmt=e.colorFmt,this._depthStencilFmt=e.depthStencilFmt,this._renderPass=this._device.createRenderPass({colorAttachments:[{format:this._colorFmt,loadOp:Ro.CLEAR,storeOp:ko.STORE,sampleCount:1,beginLayout:Oo.COLOR_ATTACHMENT_OPTIMAL,endLayout:Oo.COLOR_ATTACHMENT_OPTIMAL}],depthStencilAttachment:{format:this._depthStencilFmt,depthLoadOp:Ro.CLEAR,depthStoreOp:ko.STORE,stencilLoadOp:Ro.CLEAR,stencilStoreOp:ko.STORE,sampleCount:1,beginLayout:Oo.DEPTH_STENCIL_ATTACHMENT_OPTIMAL,endLayout:Oo.DEPTH_STENCIL_ATTACHMENT_OPTIMAL}});var t=[];return this._isOffscreen&&(this._colorFmt!==no.UNKNOWN&&(this._colorTex=this._device.createTexture({type:bo.TEX2D,usage:Eo.COLOR_ATTACHMENT|Eo.SAMPLED,format:this._colorFmt,width:this._width,height:this._height,depth:1,arrayLayer:1,mipLevel:1,flags:So.NONE}),this._colorTexView=this._device.createTextureView({texture:this._colorTex,type:xo.TV2D,format:this._colorFmt,baseLevel:0,levelCount:1,baseLayer:0,layerCount:1}),t.push(this._colorTexView)),this._depthStencilFmt!==no.UNKNOWN&&(this._depthStencilTex=this._device.createTexture({type:bo.TEX2D,usage:Eo.DEPTH_STENCIL_ATTACHMENT,format:this._depthStencilFmt,width:this._width,height:this._height,depth:1,arrayLayer:1,mipLevel:1,flags:So.NONE}),this._depthStencilTexView=this._device.createTextureView({texture:this._depthStencilTex,type:xo.TV2D,format:this._depthStencilFmt,baseLevel:0,levelCount:1,baseLayer:0,layerCount:1}))),this._framebuffer=this._device.createFramebuffer({renderPass:this._renderPass,colorViews:t,depthStencilView:this._depthStencilTexView,isOffscreen:this._isOffscreen}),this._status=Ks.SUCCESS,!0}},{key:"destroy",value:function(){this._depthStencilTexView&&(this._depthStencilTexView.destroy(),this._depthStencilTexView=null),this._depthStencilTex&&(this._depthStencilTex.destroy(),this._depthStencilTex=null),this._colorTexView&&(this._colorTexView.destroy(),this._colorTexView=null),this._colorTex&&(this._colorTex.destroy(),this._colorTex=null),this._framebuffer&&(this._framebuffer.destroy(),this._framebuffer=null),this._renderPass&&(this._renderPass.destroy(),this._renderPass=null),this._status=Ks.UNREADY}},{key:"resize",value:function(e,t){this._width=e,this._height=t,(e>this._nativeWidth||t>this._nativeHeight)&&(this._nativeWidth=e,this._nativeHeight=t,this._depthStencilTex&&(this._depthStencilTex.resize(e,t),this._depthStencilTexView.destroy(),this._depthStencilTexView.initialize({texture:this._depthStencilTex,type:xo.TV2D,format:this._depthStencilFmt})),this._colorTex&&(this._colorTex.resize(e,t),this._colorTexView.destroy(),this._colorTexView.initialize({texture:this._colorTex,type:xo.TV2D,format:this._colorFmt})),this._framebuffer&&this._framebuffer.isOffscreen&&(this._framebuffer.destroy(),this._framebuffer.initialize({renderPass:this._renderPass,colorViews:[this._colorTexView],depthStencilView:this._depthStencilTexView})))}}]),t}(ld),UB=function(e){function t(){var e;return i(this,t),(e=c(this,o(t).call(this))).stateCache=new BB,e.nullTex2D=null,e.nullTexCube=null,e._webGLRC=null,e._isAntialias=!0,e._isPremultipliedAlpha=!0,e._useVAO=!1,e._extensions=null,e._EXT_texture_filter_anisotropic=null,e._EXT_frag_depth=null,e._EXT_shader_texture_lod=null,e._EXT_sRGB=null,e._OES_vertex_array_object=null,e._EXT_color_buffer_half_float=null,e._WEBGL_color_buffer_float=null,e._WEBGL_compressed_texture_etc1=null,e._WEBGL_compressed_texture_etc=null,e._WEBGL_compressed_texture_pvrtc=null,e._WEBGL_compressed_texture_astc=null,e._WEBGL_compressed_texture_s3tc=null,e._WEBGL_compressed_texture_s3tc_srgb=null,e._WEBGL_debug_shaders=null,e._WEBGL_draw_buffers=null,e._WEBGL_lose_context=null,e._WEBGL_depth_texture=null,e._WEBGL_debug_renderer_info=null,e._OES_texture_half_float=null,e._OES_texture_half_float_linear=null,e._OES_texture_float=null,e._OES_texture_float_linear=null,e._OES_standard_derivatives=null,e._OES_element_index_uint=null,e._ANGLE_instanced_arrays=null,e}return s(t,e),r(t,[{key:"gl",get:function(){return this._webGLRC}},{key:"webGLQueue",get:function(){return this._queue}},{key:"isAntialias",get:function(){return this._isAntialias}},{key:"isPremultipliedAlpha",get:function(){return this._isPremultipliedAlpha}},{key:"useVAO",get:function(){return this._useVAO}},{key:"EXT_texture_filter_anisotropic",get:function(){return this._EXT_texture_filter_anisotropic}},{key:"EXT_frag_depth",get:function(){return this._EXT_frag_depth}},{key:"EXT_shader_texture_lod",get:function(){return this._EXT_shader_texture_lod}},{key:"EXT_sRGB",get:function(){return this._EXT_sRGB}},{key:"OES_vertex_array_object",get:function(){return this._OES_vertex_array_object}},{key:"WEBGL_color_buffer_float",get:function(){return this._WEBGL_color_buffer_float}},{key:"WEBGL_compressed_texture_etc1",get:function(){return this._WEBGL_compressed_texture_etc1}},{key:"WEBGL_compressed_texture_pvrtc",get:function(){return this._WEBGL_compressed_texture_pvrtc}},{key:"WEBGL_compressed_texture_astc",get:function(){return this._WEBGL_compressed_texture_astc}},{key:"WEBGL_compressed_texture_s3tc",get:function(){return this._WEBGL_compressed_texture_s3tc}},{key:"WEBGL_compressed_texture_s3tc_srgb",get:function(){return this._WEBGL_compressed_texture_s3tc_srgb}},{key:"WEBGL_debug_shaders",get:function(){return this._WEBGL_debug_shaders}},{key:"WEBGL_draw_buffers",get:function(){return this._WEBGL_draw_buffers}},{key:"WEBGL_lose_context",get:function(){return this._WEBGL_lose_context}},{key:"WEBGL_depth_texture",get:function(){return this._WEBGL_depth_texture}},{key:"WEBGL_debug_renderer_info",get:function(){return this._WEBGL_debug_renderer_info}},{key:"OES_texture_half_float",get:function(){return this._OES_texture_half_float}},{key:"OES_texture_half_float_linear",get:function(){return this._OES_texture_half_float_linear}},{key:"OES_texture_float",get:function(){return this._OES_texture_float}},{key:"OES_standard_derivatives",get:function(){return this._OES_standard_derivatives}},{key:"OES_element_index_uint",get:function(){return this._OES_element_index_uint}},{key:"ANGLE_instanced_arrays",get:function(){return this._ANGLE_instanced_arrays}}]),r(t,[{key:"initialize",value:function(e){this._canvas=e.canvasElm,this._isAntialias=void 0===e.isAntialias||e.isAntialias,this._isPremultipliedAlpha=void 0===e.isPremultipliedAlpha||e.isPremultipliedAlpha;try{var t={alpha:jS.ENABLE_TRANSPARENT_CANVAS,antialias:this._isAntialias,depth:!0,stencil:!0,premultipliedAlpha:this._isPremultipliedAlpha,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};this._webGLRC=this._canvas.getContext("webgl",t)}catch(e){return console.error(e),!1}if(!this._webGLRC)return console.error("This device does not support WebGL."),!1;this._canvas2D=document.createElement("canvas"),console.info("WebGL device initialized."),this._gfxAPI=Xo.WEBGL,this._deviceName="WebGL";var i=this._webGLRC;this._WEBGL_debug_renderer_info=this.getExtension("WEBGL_debug_renderer_info"),this._WEBGL_debug_renderer_info?(this._renderer=i.getParameter(this._WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=i.getParameter(this._WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=i.getParameter(i.RENDERER),this._vendor=i.getParameter(i.VENDOR)),this._version=i.getParameter(i.VERSION),this._maxVertexAttributes=i.getParameter(i.MAX_VERTEX_ATTRIBS),this._maxVertexUniformVectors=i.getParameter(i.MAX_VERTEX_UNIFORM_VECTORS),this._maxFragmentUniformVectors=i.getParameter(i.MAX_FRAGMENT_UNIFORM_VECTORS),this._maxTextureUnits=i.getParameter(i.MAX_TEXTURE_IMAGE_UNITS),this._maxVertexTextureUnits=i.getParameter(i.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._maxTextureSize=i.getParameter(i.MAX_TEXTURE_SIZE),this._maxCubeMapTextureSize=i.getParameter(i.MAX_CUBE_MAP_TEXTURE_SIZE),this._depthBits=i.getParameter(i.DEPTH_BITS),this._stencilBits=i.getParameter(i.STENCIL_BITS),this._devicePixelRatio=e.devicePixelRatio||1,this._width=this._canvas.width,this._height=this._canvas.height,this._nativeWidth=Math.max(e.nativeWidth||this._width,0),this._nativeHeight=Math.max(e.nativeHeight||this._height,0),this._colorFmt=no.RGBA8,24===this._depthBits?8===this._stencilBits?this._depthStencilFmt=no.D24S8:this._depthStencilFmt=no.D24:8===this._stencilBits?this._depthStencilFmt=no.D16S8:this._depthStencilFmt=no.D16,this._extensions=i.getSupportedExtensions();var n="";if(this._extensions){var r=this._extensions,a=Array.isArray(r),s=0;for(r=a?r:r[Symbol.iterator]();;){var o;if(a){if(s>=r.length)break;o=r[s++]}else{if((s=r.next()).done)break;o=s.value}n+=o+" "}console.debug("EXTENSIONS: "+n)}this._EXT_texture_filter_anisotropic=this.getExtension("EXT_texture_filter_anisotropic"),this._EXT_frag_depth=this.getExtension("EXT_frag_depth"),this._EXT_shader_texture_lod=this.getExtension("EXT_shader_texture_lod"),this._EXT_sRGB=this.getExtension("EXT_sRGB"),this._OES_vertex_array_object=this.getExtension("OES_vertex_array_object"),this._EXT_color_buffer_half_float=this.getExtension("EXT_color_buffer_half_float"),this._WEBGL_color_buffer_float=this.getExtension("WEBGL_color_buffer_float"),this._WEBGL_compressed_texture_etc1=this.getExtension("WEBGL_compressed_texture_etc1"),this._WEBGL_compressed_texture_etc=this.getExtension("WEBGL_compressed_texture_etc"),this._WEBGL_compressed_texture_pvrtc=this.getExtension("WEBGL_compressed_texture_pvrtc"),this._WEBGL_compressed_texture_astc=this.getExtension("WEBGL_compressed_texture_astc"),this._WEBGL_compressed_texture_s3tc=this.getExtension("WEBGL_compressed_texture_s3tc"),this._WEBGL_compressed_texture_s3tc_srgb=this.getExtension("WEBGL_compressed_texture_s3tc_srgb"),this._WEBGL_debug_shaders=this.getExtension("WEBGL_debug_shaders"),this._WEBGL_draw_buffers=this.getExtension("WEBGL_draw_buffers"),this._WEBGL_lose_context=this.getExtension("WEBGL_lose_context"),this._WEBGL_depth_texture=this.getExtension("WEBGL_depth_texture"),this._OES_texture_half_float=this.getExtension("OES_texture_half_float"),this._OES_texture_half_float_linear=this.getExtension("OES_texture_half_float_linear"),this._OES_texture_float=this.getExtension("OES_texture_float"),this._OES_texture_float_linear=this.getExtension("OES_texture_float_linear"),this._OES_standard_derivatives=this.getExtension("OES_standard_derivatives"),this._OES_element_index_uint=this.getExtension("OES_element_index_uint"),this._ANGLE_instanced_arrays=this.getExtension("ANGLE_instanced_arrays"),this._features.fill(!1),this._WEBGL_color_buffer_float&&(this._features[qo.COLOR_FLOAT]=!0),this._EXT_color_buffer_half_float&&(this._features[qo.COLOR_HALF_FLOAT]=!0),this._OES_texture_float&&(this._features[qo.TEXTURE_FLOAT]=!0),this._OES_texture_half_float&&(this._features[qo.TEXTURE_HALF_FLOAT]=!0),this._OES_texture_float_linear&&(this._features[qo.TEXTURE_FLOAT_LINEAR]=!0),this._OES_texture_half_float_linear&&(this._features[qo.TEXTURE_HALF_FLOAT_LINEAR]=!0),this._WEBGL_depth_texture&&(this._features[qo.FORMAT_D24S8]=!0);var l="";this._WEBGL_compressed_texture_etc1&&(this._features[qo.FORMAT_ETC1]=!0,l+="etc1 "),this._WEBGL_compressed_texture_etc&&(this._features[qo.FORMAT_ETC2]=!0,l+="etc2 "),this._WEBGL_compressed_texture_s3tc&&(this._features[qo.FORMAT_DXT]=!0,l+="dxt "),this._WEBGL_compressed_texture_pvrtc&&(this._features[qo.FORMAT_PVRTC]=!0,l+="pvrtc "),this._WEBGL_compressed_texture_astc&&(this._features[qo.FORMAT_ASTC]=!0,l+="astc "),this._features[qo.MSAA]=!1,this._OES_vertex_array_object&&(Il.platform===Il.WECHAT_GAME&&Il.os===Il.OS_IOS||(this._useVAO=!0)),Il.platform===Il.WECHAT_GAME&&Il.os===Il.OS_ANDROID&&(i.detachShader=function(){}),this._OES_element_index_uint&&(this._features[qo.ELEMENT_INDEX_UINT]=!0),console.info("RENDERER: "+this._renderer),console.info("VENDOR: "+this._vendor),console.info("VERSION: "+this._version),console.info("DPR: "+this._devicePixelRatio),console.info("SCREEN_SIZE: "+this._width+" x "+this._height),console.info("NATIVE_SIZE: "+this._nativeWidth+" x "+this._nativeHeight),console.info("MAX_VERTEX_UNIFORM_VECTORS: "+this._maxVertexUniformVectors),console.info("DEPTH_BITS: "+this._depthBits),console.info("STENCIL_BITS: "+this._stencilBits),this._EXT_texture_filter_anisotropic&&console.info("MAX_TEXTURE_MAX_ANISOTROPY_EXT: "+this._EXT_texture_filter_anisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT),console.info("USE_VAO: "+this._useVAO),console.info("COMPRESSED_FORMAT: "+l),this.initStates(i),this._queue=this.createQueue({type:Po.GRAPHICS});var u=this._webGLRC.canvas;this._mainWindow=this.createWindow({title:u.title||"",left:u.offsetLeft||0,top:u.offsetTop||0,width:this._webGLRC.drawingBufferWidth,height:this._webGLRC.drawingBufferHeight,colorFmt:this._colorFmt,depthStencilFmt:this._depthStencilFmt}),this._cmdAllocator=this.createCommandAllocator({}),this.nullTex2D=new FB(this),this.nullTex2D.initialize({type:bo.TEX2D,usage:Eo.SAMPLED,format:no.RGBA8,width:2,height:2,flags:So.GEN_MIPMAP}),this.nullTexCube=new FB(this),this.nullTexCube.initialize({type:bo.TEX2D,usage:Eo.SAMPLED,format:no.RGBA8,width:2,height:2,arrayLayer:6,flags:So.CUBEMAP|So.GEN_MIPMAP});var c={buffOffset:0,buffStride:0,buffTexHeight:0,texOffset:{x:0,y:0,z:0},texExtent:{width:2,height:2,depth:1},texSubres:{baseMipLevel:0,levelCount:1,baseArrayLayer:0,layerCount:1}},h=new Uint8Array(this.nullTex2D.size);return h.fill(0),this.copyBuffersToTexture([h],this.nullTex2D,[c]),c.texSubres.layerCount=6,this.copyBuffersToTexture([h,h,h,h,h,h],this.nullTexCube,[c]),!0}},{key:"destroy",value:function(){this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._mainWindow&&(this._mainWindow.destroy(),this._mainWindow=null),this._cmdAllocator&&(this._cmdAllocator.destroy(),this._cmdAllocator=null),this._queue&&(this._queue.destroy(),this._queue=null),this._webGLRC=null}},{key:"resize",value:function(e,t){this._width===e&&this._height===t||(console.info("Resizing device: "+e+"x"+t),this._canvas.width=e,this._canvas.height=t,this._width=e,this._height=t)}},{key:"createBuffer",value:function(e){var t=new EB(this);return t.initialize(e),t}},{key:"createTexture",value:function(e){var t=new FB(this);return t.initialize(e),t}},{key:"createTextureView",value:function(e){var t=new NB(this);return t.initialize(e),t}},{key:"createSampler",value:function(e){var t=new LB(this);return t.initialize(e),t}},{key:"createBindingLayout",value:function(e){var t=new QP(this);return t.initialize(e),t}},{key:"createShader",value:function(e){var t=new PB(this);return t.initialize(e),t}},{key:"createInputAssembler",value:function(e){var t=new wB(this);return t.initialize(e),t}},{key:"createRenderPass",value:function(e){var t=new IB(this);return t.initialize(e),t}},{key:"createFramebuffer",value:function(e){var t=new AB(this);return t.initialize(e),t}},{key:"createPipelineLayout",value:function(e){var t=new CB(this);return t.initialize(e),t}},{key:"createPipelineState",value:function(e){var t=new kB(this);return t.initialize(e),t}},{key:"createCommandAllocator",value:function(e){var t=new SB(this);return t.initialize(e),t}},{key:"createCommandBuffer",value:function(e){var t=new xB(this);return t.initialize(e),t}},{key:"createQueue",value:function(e){var t=new OB(this);return t.initialize(e),t}},{key:"createWindow",value:function(e){var t=new zB(this);return t.initialize(e),t}},{key:"present",value:function(){this._cmdAllocator.releaseCmds();var e=this._queue;this._numDrawCalls=e.numDrawCalls,this._numTris=e.numTris,e.clear()}},{key:"copyBuffersToTexture",value:function(e,t,i){bB(this,e,t.gpuTexture,i)}},{key:"copyTexImagesToTexture",value:function(e,t,i){!function(e,t,i,n){var r=e.gl,a=e.stateCache.glTexUnits[e.stateCache.texUnit];a.glTexture!==i.glTexture&&(r.bindTexture(i.glTarget,i.glTexture),a.glTexture=i.glTexture);var s=0,o=0,l=0;switch(i.glTarget){case r.TEXTURE_2D:for(var u=0;u<n.length;u++){var c=n[u];for(s=c.texSubres.baseMipLevel;s<c.texSubres.levelCount;++s)r.texSubImage2D(r.TEXTURE_2D,s,c.texOffset.x,c.texOffset.y,i.glFormat,i.glType,t[o++])}break;case r.TEXTURE_CUBE_MAP:for(var h=0;h<n.length;h++){var f=n[h],_=f.texSubres.baseArrayLayer+f.texSubres.layerCount;for(l=f.texSubres.baseArrayLayer;l<_;++l){var d=f.texSubres.baseMipLevel+f.texSubres.levelCount;for(s=f.texSubres.baseMipLevel;s<d;++s)r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,s,f.texOffset.x,f.texOffset.y,i.glFormat,i.glType,t[o++])}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}i.flags&So.GEN_MIPMAP&&i.isPowerOf2&&r.generateMipmap(i.glTarget)}(this,e,t.gpuTexture,i)}},{key:"copyFramebufferToBuffer",value:function(e,t,i){var n=this._webGLRC,r=e.gpuFramebuffer,a=this.stateCache.glFramebuffer;this.stateCache.glFramebuffer!==r.glFramebuffer&&(n.bindFramebuffer(n.FRAMEBUFFER,r.glFramebuffer),this.stateCache.glFramebuffer=r.glFramebuffer);var s=new Uint8Array(t),o=i,l=Array.isArray(o),u=0;for(o=l?o:o[Symbol.iterator]();;){var c;if(l){if(u>=o.length)break;c=o[u++]}else{if((u=o.next()).done)break;c=u.value}var h=c,f=h.buffOffset+h.buffTexHeight*h.buffStride,_=h.texExtent.width,d=h.texExtent.height,p=Vo(no.RGBA8,_,d,1),m=s.subarray(f,f+p);n.readPixels(h.texOffset.x,h.texOffset.y,_,d,n.RGBA,n.UNSIGNED_BYTE,m)}this.stateCache.glFramebuffer!==a&&(n.bindFramebuffer(n.FRAMEBUFFER,a),this.stateCache.glFramebuffer=a)}},{key:"blitFramebuffer",value:function(e,t,i,n,r){}},{key:"getExtension",value:function(e){for(var t=["","WEBKIT_","MOZ_"],i=0;i<t.length;++i){var n=this._webGLRC.getExtension(t[i]+e);if(n)return n}return null}},{key:"initStates",value:function(e){e.activeTexture(e.TEXTURE0),e.pixelStorei(e.PACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,0),e.bindFramebuffer(e.FRAMEBUFFER,null),e.disable(e.SCISSOR_TEST),e.enable(e.CULL_FACE),e.cullFace(e.BACK),e.frontFace(e.CCW),e.disable(e.POLYGON_OFFSET_FILL),e.polygonOffset(0,0),e.enable(e.DEPTH_TEST),e.depthMask(!0),e.depthFunc(e.LESS),e.depthRange(0,1),e.stencilFuncSeparate(e.FRONT,e.ALWAYS,1,65535),e.stencilOpSeparate(e.FRONT,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.FRONT,65535),e.stencilFuncSeparate(e.BACK,e.ALWAYS,1,65535),e.stencilOpSeparate(e.BACK,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.BACK,65535),e.disable(e.STENCIL_TEST),e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.disable(e.BLEND),e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ONE,e.ZERO,e.ONE,e.ZERO),e.colorMask(!0,!0,!0,!0),e.blendColor(0,0,0,0)}}]),t}(Ko);cc.WebGLGFXDevice=UB;var GB=function(e){function t(e){var n;return i(this,t),(n=c(this,o(t).call(this,e)))._gpuBindingLayout=null,n}return s(t,e),r(t,[{key:"gpuBindingLayout",get:function(){return this._gpuBindingLayout}}]),r(t,[{key:"initialize",value:function(e){this._bindingUnits=new Array(e.bindings.length);for(var t=0;t<e.bindings.length;++t){var i=e.bindings[t];this._bindingUnits[t]={binding:i.binding,type:i.bindingType,name:i.name,buffer:null,texView:null,sampler:null}}this._gpuBindingLayout={gpuBindings:new Array(e.bindings.length)};for(var n=0;n<e.bindings.length;++n){var r=e.bindings[n];this._gpuBindingLayout.gpuBindings[n]={binding:r.binding,type:r.bindingType,name:r.name,gpuBuffer:null,gpuTexView:null,gpuSampler:null}}return this._status=Ks.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuBindingLayout=null,this._status=Ks.UNREADY}},{key:"update",value:function(){if(this._isDirty&&this._gpuBindingLayout){for(var e=0;e<this._bindingUnits.length;++e){var t=this._bindingUnits[e];switch(t.type){case wo.UNIFORM_BUFFER:t.buffer&&(this._gpuBindingLayout.gpuBindings[e].gpuBuffer=t.buffer.gpuBuffer);break;case wo.SAMPLER:t.texView&&(this._gpuBindingLayout.gpuBindings[e].gpuTexView=t.texView.gpuTextureView),t.sampler&&(this._gpuBindingLayout.gpuBindings[e].gpuSampler=t.sampler.gpuSampler)}}this._isDirty=!1}}}]),t}(sd),VB=[10497,33648,33071,33071],HB=[1,2,4,8,16,32,64],WB=new Float32Array(4);function jB(e,t){switch(e){case no.R8:return t.UNSIGNED_BYTE;case no.R8SN:return t.BYTE;case no.R8UI:return t.UNSIGNED_BYTE;case no.R8I:return t.BYTE;case no.R16F:return t.HALF_FLOAT;case no.R16UI:return t.UNSIGNED_SHORT;case no.R16I:return t.SHORT;case no.R32F:return t.FLOAT;case no.R32UI:return t.UNSIGNED_INT;case no.R32I:return t.INT;case no.RG8:return t.UNSIGNED_BYTE;case no.RG8SN:return t.BYTE;case no.RG8UI:return t.UNSIGNED_BYTE;case no.RG8I:return t.BYTE;case no.RG16F:return t.HALF_FLOAT;case no.RG16UI:return t.UNSIGNED_SHORT;case no.RG16I:return t.SHORT;case no.RG32F:return t.FLOAT;case no.RG32UI:return t.UNSIGNED_INT;case no.RG32I:return t.INT;case no.RGB8:case no.SRGB8:return t.UNSIGNED_BYTE;case no.RGB8SN:return t.BYTE;case no.RGB8UI:return t.UNSIGNED_BYTE;case no.RGB8I:return t.BYTE;case no.RGB16F:return t.HALF_FLOAT;case no.RGB16UI:return t.UNSIGNED_SHORT;case no.RGB16I:return t.SHORT;case no.RGB32F:return t.FLOAT;case no.RGB32UI:return t.UNSIGNED_INT;case no.RGB32I:return t.INT;case no.RGBA8:case no.SRGB8_A8:return t.UNSIGNED_BYTE;case no.RGBA8SN:return t.BYTE;case no.RGBA8UI:return t.UNSIGNED_BYTE;case no.RGBA8I:return t.BYTE;case no.RGBA16F:return t.HALF_FLOAT;case no.RGBA16UI:return t.UNSIGNED_SHORT;case no.RGBA16I:return t.SHORT;case no.RGBA32F:return t.FLOAT;case no.RGBA32UI:return t.UNSIGNED_INT;case no.RGBA32I:return t.INT;case no.R5G6B5:return t.UNSIGNED_SHORT_5_6_5;case no.R11G11B10F:return t.UNSIGNED_INT_10F_11F_11F_REV;case no.RGB5A1:return t.UNSIGNED_SHORT_5_5_5_1;case no.RGBA4:return t.UNSIGNED_SHORT_4_4_4_4;case no.RGB10A2:case no.RGB10A2UI:return t.UNSIGNED_INT_2_10_10_10_REV;case no.RGB9E5:return t.FLOAT;case no.D16:case no.D16S8:return t.UNSIGNED_SHORT;case no.D24:return t.UNSIGNED_INT;case no.D24S8:return t.UNSIGNED_INT_24_8;case no.D32F:return t.FLOAT;case no.D32F_S8:return t.FLOAT_32_UNSIGNED_INT_24_8_REV;case no.BC1:case no.BC1_SRGB:case no.BC2:case no.BC2_SRGB:case no.BC3:case no.BC3_SRGB:case no.BC4:return t.UNSIGNED_BYTE;case no.BC4_SNORM:return t.BYTE;case no.BC5:return t.UNSIGNED_BYTE;case no.BC5_SNORM:return t.BYTE;case no.BC6H_SF16:case no.BC6H_UF16:return t.FLOAT;case no.BC7:case no.BC7_SRGB:case no.ETC_RGB8:case no.ETC2_RGB8:case no.ETC2_SRGB8:case no.ETC2_RGB8_A1:case no.ETC2_SRGB8_A1:case no.ETC2_RGB8:case no.ETC2_SRGB8:case no.EAC_R11:return t.UNSIGNED_BYTE;case no.EAC_R11SN:return t.BYTE;case no.EAC_RG11:return t.UNSIGNED_BYTE;case no.EAC_RG11SN:return t.BYTE;case no.PVRTC_RGB2:case no.PVRTC_RGBA2:case no.PVRTC_RGB4:case no.PVRTC_RGBA4:case no.PVRTC2_2BPP:case no.PVRTC2_4BPP:default:return t.UNSIGNED_BYTE}}function XB(e,t){switch(e){case no.A8:return t.ALPHA;case no.L8:return t.LUMINANCE;case no.LA8:return t.LUMINANCE_ALPHA;case no.R8:return t.R8;case no.R8SN:return t.R8_SNORM;case no.R8UI:return t.R8UI;case no.R8I:return t.R8I;case no.RG8:return t.RG8;case no.RG8SN:return t.RG8_SNORM;case no.RG8UI:return t.RG8UI;case no.RG8I:return t.RG8I;case no.RGB8:return t.RGB8;case no.RGB8SN:return t.RGB8_SNORM;case no.RGB8UI:return t.RGB8UI;case no.RGB8I:return t.RGB8I;case no.RGBA8:return t.RGBA8;case no.RGBA8SN:return t.RGBA8_SNORM;case no.RGBA8UI:return t.RGBA8UI;case no.RGBA8I:return t.RGBA8I;case no.R16I:return t.R16I;case no.R16UI:return t.R16UI;case no.R16F:return t.R16F;case no.RG16I:return t.RG16I;case no.RG16UI:return t.RG16UI;case no.RG16F:return t.RG16F;case no.RGB16I:return t.RGB16I;case no.RGB16UI:return t.RGB16UI;case no.RGB16F:return t.RGB16F;case no.RGBA16I:return t.RGBA16I;case no.RGBA16UI:return t.RGBA16UI;case no.RGBA16F:return t.RGBA16F;case no.R32I:return t.R32I;case no.R32UI:return t.R32UI;case no.R32F:return t.R32F;case no.RG32I:return t.RG32I;case no.RG32UI:return t.RG32UI;case no.RG32F:return t.RG32F;case no.RGB32I:return t.RGB32I;case no.RGB32UI:return t.RGB32UI;case no.RGB32F:return t.RGB32F;case no.RGBA32I:return t.RGBA32I;case no.RGBA32UI:return t.RGBA32UI;case no.RGBA32F:return t.RGBA32F;case no.R5G6B5:return t.RGB565;case no.RGB5A1:return t.RGB5_A1;case no.RGBA4:return t.RGBA4;case no.RGB10A2:return t.RGB10_A2;case no.RGB10A2UI:return t.RGB10_A2UI;case no.R11G11B10F:return t.R11F_G11F_B10F;case no.D16:return t.DEPTH_COMPONENT16;case no.D16S8:return t.DEPTH_STENCIL;case no.D24:return t.DEPTH_COMPONENT24;case no.D24S8:return t.DEPTH24_STENCIL8;case no.D32F:return t.DEPTH_COMPONENT32F;case no.D32F_S8:return t.DEPTH32F_STENCIL8;case no.BC1:return ZP.COMPRESSED_RGB_S3TC_DXT1_EXT;case no.BC1_ALPHA:return ZP.COMPRESSED_RGBA_S3TC_DXT1_EXT;case no.BC1_SRGB:return ZP.COMPRESSED_SRGB_S3TC_DXT1_EXT;case no.BC1_SRGB_ALPHA:return ZP.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case no.BC2:return ZP.COMPRESSED_RGBA_S3TC_DXT3_EXT;case no.BC2_SRGB:return ZP.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case no.BC3:return ZP.COMPRESSED_RGBA_S3TC_DXT5_EXT;case no.BC3_SRGB:return ZP.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case no.ETC_RGB8:return ZP.COMPRESSED_RGB_ETC1_WEBGL;case no.ETC2_RGB8:return ZP.COMPRESSED_RGB8_ETC2;case no.ETC2_SRGB8:return ZP.COMPRESSED_SRGB8_ETC2;case no.ETC2_RGB8_A1:return ZP.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case no.ETC2_SRGB8_A1:return ZP.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case no.ETC2_RGBA8:return ZP.COMPRESSED_RGBA8_ETC2_EAC;case no.ETC2_SRGB8_A8:return ZP.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case no.EAC_R11:return ZP.COMPRESSED_R11_EAC;case no.EAC_R11SN:return ZP.COMPRESSED_SIGNED_R11_EAC;case no.EAC_RG11:return ZP.COMPRESSED_RG11_EAC;case no.EAC_RG11SN:return ZP.COMPRESSED_SIGNED_RG11_EAC;case no.PVRTC_RGB2:return ZP.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case no.PVRTC_RGBA2:return ZP.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case no.PVRTC_RGB4:return ZP.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case no.PVRTC_RGBA4:return ZP.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;default:return console.error("Unsupported GFXFormat, convert to WebGL internal format failed."),t.RGBA}}function qB(e,t){switch(e){case no.A8:return t.ALPHA;case no.L8:return t.LUMINANCE;case no.LA8:return t.LUMINANCE_ALPHA;case no.R8:case no.R8SN:return t.RED;case no.R8UI:case no.R8I:return t.RED;case no.RG8:case no.RG8SN:case no.RG8UI:case no.RG8I:return t.RG;case no.RGB8:case no.RGB8SN:case no.RGB8UI:case no.RGB8I:return t.RGB;case no.RGBA8:case no.RGBA8SN:case no.RGBA8UI:case no.RGBA8I:return t.RGBA;case no.R16UI:case no.R16I:case no.R16F:return t.RED;case no.RG16UI:case no.RG16I:case no.RG16F:return t.RG;case no.RGB16UI:case no.RGB16I:case no.RGB16F:return t.RGB;case no.RGBA16UI:case no.RGBA16I:case no.RGBA16F:return t.RGBA;case no.R32UI:case no.R32I:case no.R32F:return t.RED;case no.RG32UI:case no.RG32I:case no.RG32F:return t.RG;case no.RGB32UI:case no.RGB32I:case no.RGB32F:return t.RGB;case no.RGBA32UI:case no.RGBA32I:case no.RGBA32F:case no.RGB10A2:return t.RGBA;case no.R11G11B10F:case no.R5G6B5:return t.RGB;case no.RGB5A1:case no.RGBA4:return t.RGBA;case no.D16:return t.DEPTH_COMPONENT;case no.D16S8:return t.DEPTH_STENCIL;case no.D24:return t.DEPTH_COMPONENT;case no.D24S8:return t.DEPTH_STENCIL;case no.D32F:return t.DEPTH_COMPONENT;case no.D32F_S8:return t.DEPTH_STENCIL;case no.BC1:return ZP.COMPRESSED_RGB_S3TC_DXT1_EXT;case no.BC1_ALPHA:return ZP.COMPRESSED_RGBA_S3TC_DXT1_EXT;case no.BC1_SRGB:return ZP.COMPRESSED_SRGB_S3TC_DXT1_EXT;case no.BC1_SRGB_ALPHA:return ZP.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case no.BC2:return ZP.COMPRESSED_RGBA_S3TC_DXT3_EXT;case no.BC2_SRGB:return ZP.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case no.BC3:return ZP.COMPRESSED_RGBA_S3TC_DXT5_EXT;case no.BC3_SRGB:return ZP.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case no.ETC_RGB8:return ZP.COMPRESSED_RGB_ETC1_WEBGL;case no.PVRTC_RGB2:return ZP.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case no.PVRTC_RGBA2:return ZP.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case no.PVRTC_RGB4:return ZP.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case no.PVRTC_RGBA4:return ZP.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;default:return console.error("Unsupported GFXFormat, convert to WebGL format failed."),t.RGBA}}function YB(e,t){switch(e){case io.BOOL:return t.BOOL;case io.BOOL2:return t.BOOL_VEC2;case io.BOOL3:return t.BOOL_VEC3;case io.BOOL4:return t.BOOL_VEC4;case io.INT:return t.INT;case io.INT2:return t.INT_VEC2;case io.INT3:return t.INT_VEC3;case io.INT4:return t.INT_VEC4;case io.UINT:return t.UNSIGNED_INT;case io.FLOAT:return t.FLOAT;case io.FLOAT2:return t.FLOAT_VEC2;case io.FLOAT3:return t.FLOAT_VEC3;case io.FLOAT4:return t.FLOAT_VEC4;case io.MAT2:return t.FLOAT_MAT2;case io.MAT2X3:return t.FLOAT_MAT2x3;case io.MAT2X4:return t.FLOAT_MAT2x4;case io.MAT3X2:return t.FLOAT_MAT3x2;case io.MAT3:return t.FLOAT_MAT3;case io.MAT3X4:return t.FLOAT_MAT3x4;case io.MAT4X2:return t.FLOAT_MAT4x2;case io.MAT4X3:return t.FLOAT_MAT4x3;case io.MAT4:return t.FLOAT_MAT4;case io.SAMPLER2D:return t.SAMPLER_2D;case io.SAMPLER2D_ARRAY:return t.SAMPLER_2D_ARRAY;case io.SAMPLER3D:return t.SAMPLER_3D;case io.SAMPLER_CUBE:return t.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GL type failed."),io.UNKNOWN}}function KB(e,t){switch(e){case t.BOOL:return io.BOOL;case t.BOOL_VEC2:return io.BOOL2;case t.BOOL_VEC3:return io.BOOL3;case t.BOOL_VEC4:return io.BOOL4;case t.INT:return io.INT;case t.INT_VEC2:return io.INT2;case t.INT_VEC3:return io.INT3;case t.INT_VEC4:return io.INT4;case t.UNSIGNED_INT:return io.UINT;case t.UNSIGNED_INT_VEC2:return io.UINT2;case t.UNSIGNED_INT_VEC3:return io.UINT3;case t.UNSIGNED_INT_VEC4:return io.UINT4;case t.UNSIGNED_INT:return io.UINT;case t.FLOAT:return io.FLOAT;case t.FLOAT_VEC2:return io.FLOAT2;case t.FLOAT_VEC3:return io.FLOAT3;case t.FLOAT_VEC4:return io.FLOAT4;case t.FLOAT_MAT2:return io.MAT2;case t.FLOAT_MAT2x3:return io.MAT2X3;case t.FLOAT_MAT2x4:return io.MAT2X4;case t.FLOAT_MAT3x2:return io.MAT3X2;case t.FLOAT_MAT3:return io.MAT3;case t.FLOAT_MAT3x4:return io.MAT3X4;case t.FLOAT_MAT4x2:return io.MAT4X2;case t.FLOAT_MAT4x3:return io.MAT4X3;case t.FLOAT_MAT4:return io.MAT4;case t.SAMPLER_2D:return io.SAMPLER2D;case t.SAMPLER_2D_ARRAY:return io.SAMPLER2D_ARRAY;case t.SAMPLER_3D:return io.SAMPLER3D;case t.SAMPLER_CUBE:return io.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GFXType failed."),io.UNKNOWN}}function ZB(e,t){switch(e){case t.BOOL:return 4;case t.BOOL_VEC2:return 8;case t.BOOL_VEC3:return 12;case t.BOOL_VEC4:return 16;case t.INT:return 4;case t.INT_VEC2:return 8;case t.INT_VEC3:return 12;case t.INT_VEC4:return 16;case t.UNSIGNED_INT:return 4;case t.UNSIGNED_INT_VEC2:return 8;case t.UNSIGNED_INT_VEC3:return 12;case t.UNSIGNED_INT_VEC4:return 16;case t.FLOAT:return 4;case t.FLOAT_VEC2:return 8;case t.FLOAT_VEC3:return 12;case t.FLOAT_VEC4:case t.FLOAT_MAT2:return 16;case t.FLOAT_MAT2x3:return 24;case t.FLOAT_MAT2x4:return 32;case t.FLOAT_MAT3x2:return 24;case t.FLOAT_MAT3:return 36;case t.FLOAT_MAT3x4:return 48;case t.FLOAT_MAT4x2:return 32;case t.FLOAT_MAT4x3:return 48;case t.FLOAT_MAT4:return 64;case t.SAMPLER_2D:case t.SAMPLER_2D_ARRAY:case t.SAMPLER_2D_ARRAY_SHADOW:case t.SAMPLER_3D:case t.SAMPLER_CUBE:case t.INT_SAMPLER_2D:case t.INT_SAMPLER_2D_ARRAY:case t.INT_SAMPLER_3D:case t.INT_SAMPLER_CUBE:case t.UNSIGNED_INT_SAMPLER_2D:case t.UNSIGNED_INT_SAMPLER_2D_ARRAY:case t.UNSIGNED_INT_SAMPLER_3D:case t.UNSIGNED_INT_SAMPLER_CUBE:return 4;default:return console.error("Unsupported GLType, get type failed."),0}}function QB(e,t){switch(e){case t.FLOAT_MAT2:case t.FLOAT_MAT2x3:case t.FLOAT_MAT2x4:return 2;case t.FLOAT_MAT3x2:case t.FLOAT_MAT3:case t.FLOAT_MAT3x4:return 3;case t.FLOAT_MAT4x2:case t.FLOAT_MAT4x3:case t.FLOAT_MAT4:return 4;default:return 1}}var JB,$B=[512,513,514,515,516,517,518,519],eD=[0,7680,7681,7682,7683,5386,34055,34056],tD=[32774,32778,32779,32774,32774],iD=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772];!function(e){e[e.BEGIN_RENDER_PASS=0]="BEGIN_RENDER_PASS",e[e.END_RENDER_PASS=1]="END_RENDER_PASS",e[e.BIND_STATES=2]="BIND_STATES",e[e.DRAW=3]="DRAW",e[e.UPDATE_BUFFER=4]="UPDATE_BUFFER",e[e.COPY_BUFFER_TO_TEXTURE=5]="COPY_BUFFER_TO_TEXTURE",e[e.COUNT=6]="COUNT"}(JB||(JB={}));var nD=function e(t){i(this,e),this.refCount=0,this.cmdType=t},rD=function(e){function t(){var e;return i(this,t),(e=c(this,o(t).call(this,JB.BEGIN_RENDER_PASS))).gpuFramebuffer=null,e.renderArea={x:0,y:0,width:0,height:0},e.clearFlag=Bo.NONE,e.clearColors=[],e.clearDepth=1,e.clearStencil=0,e}return s(t,e),r(t,[{key:"clear",value:function(){this.gpuFramebuffer=null,this.clearColors.length=0}}]),t}(nD),aD=function(e){function t(){var e;return i(this,t),(e=c(this,o(t).call(this,JB.BIND_STATES))).gpuPipelineState=null,e.gpuBindingLayout=null,e.gpuInputAssembler=null,e.viewport=null,e.scissor=null,e.lineWidth=null,e.depthBias=null,e.blendConstants=null,e.depthBounds=null,e.stencilWriteMask=null,e.stencilCompareMask=null,e}return s(t,e),r(t,[{key:"clear",value:function(){this.gpuPipelineState=null,this.gpuBindingLayout=null,this.gpuInputAssembler=null,this.viewport=null,this.scissor=null,this.lineWidth=null,this.depthBias=null,this.blendConstants=null,this.depthBounds=null,this.stencilWriteMask=null,this.stencilCompareMask=null}}]),t}(nD),sD=function(e){function t(){var e;return i(this,t),(e=c(this,o(t).call(this,JB.DRAW))).drawInfo={vertexCount:0,firstVertex:0,indexCount:0,firstIndex:0,vertexOffset:0,instanceCount:0,firstInstance:0},e}return s(t,e),r(t,[{key:"clear",value:function(){}}]),t}(nD),oD=function(e){function t(){var e;return i(this,t),(e=c(this,o(t).call(this,JB.UPDATE_BUFFER))).gpuBuffer=null,e.buffer=null,e.offset=0,e.size=0,e}return s(t,e),r(t,[{key:"clear",value:function(){this.gpuBuffer=null,this.buffer=null}}]),t}(nD),lD=function(e){function t(){var e;return i(this,t),(e=c(this,o(t).call(this,JB.COPY_BUFFER_TO_TEXTURE))).gpuBuffer=null,e.gpuTexture=null,e.dstLayout=null,e.regions=[],e}return s(t,e),r(t,[{key:"clear",value:function(){this.gpuBuffer=null,this.gpuTexture=null,this.dstLayout=null,this.regions.length=0}}]),t}(nD),uD=function(){function e(){i(this,e),this.cmds=new Ja(1),this.beginRenderPassCmds=new Ja(1),this.bindStatesCmds=new Ja(1),this.drawCmds=new Ja(1),this.updateBufferCmds=new Ja(1),this.copyBufferToTextureCmds=new Ja(1)}return r(e,[{key:"clearCmds",value:function(e){this.beginRenderPassCmds.length&&(e.beginRenderPassCmdPool.freeCmds(this.beginRenderPassCmds),this.beginRenderPassCmds.clear()),this.bindStatesCmds.length&&(e.bindStatesCmdPool.freeCmds(this.bindStatesCmds),this.bindStatesCmds.clear()),this.drawCmds.length&&(e.drawCmdPool.freeCmds(this.drawCmds),this.drawCmds.clear()),this.updateBufferCmds.length&&(e.updateBufferCmdPool.freeCmds(this.updateBufferCmds),this.updateBufferCmds.clear()),this.copyBufferToTextureCmds.length&&(e.copyBufferToTextureCmdPool.freeCmds(this.copyBufferToTextureCmds),this.copyBufferToTextureCmds.clear()),this.cmds.clear()}}]),e}();function cD(e,t,i,n,r){if(t.usage&ro.INDIRECT)t.indirects=i.drawInfos;else{var a=i,s=e.gl,o=e.stateCache;switch(t.glTarget){case s.ARRAY_BUFFER:o.glVAO&&(s.bindVertexArray(null),o.glVAO=null),o.glArrayBuffer!==t.glBuffer&&(s.bindBuffer(s.ARRAY_BUFFER,t.glBuffer),o.glArrayBuffer=t.glBuffer),r===a.byteLength?s.bufferSubData(t.glTarget,n,a):s.bufferSubData(t.glTarget,n,a.slice(0,r));break;case s.ELEMENT_ARRAY_BUFFER:o.glVAO&&(s.bindVertexArray(null),o.glVAO=null),o.glElementArrayBuffer!==t.glBuffer&&(s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,t.glBuffer),o.glElementArrayBuffer=t.glBuffer),r===a.byteLength?s.bufferSubData(t.glTarget,n,a):s.bufferSubData(t.glTarget,n,a.slice(0,r));break;case s.UNIFORM_BUFFER:o.glUniformBuffer!==t.glBuffer&&(s.bindBuffer(s.UNIFORM_BUFFER,t.glBuffer),o.glUniformBuffer=t.glBuffer),r===a.byteLength?s.bufferSubData(t.glTarget,n,a):s.bufferSubData(t.glTarget,n,new Float32Array(a,0,r/4));break;default:return void console.error("Unsupported GFXBufferType, update buffer failed.")}}}var hD=new Array(JB.COUNT);function fD(e,t){for(var i=e.gl,n=e.stateCache,r=0;r<JB.COUNT;++r)hD[r]=0;for(var a=null,s=null,o=!1,l=null,u=i.TRIANGLES,c=0;c<t.cmds.length;++c){var h=t.cmds.array[c],f=hD[h]++;switch(h){case JB.BEGIN_RENDER_PASS:var _=t.beginRenderPassCmds.array[f],d=0;if(_.gpuFramebuffer){n.glFramebuffer!==_.gpuFramebuffer.glFramebuffer&&(i.bindFramebuffer(i.FRAMEBUFFER,_.gpuFramebuffer.glFramebuffer),n.glFramebuffer=_.gpuFramebuffer.glFramebuffer),n.viewport.left===_.renderArea.x&&n.viewport.top===_.renderArea.y&&n.viewport.width===_.renderArea.width&&n.viewport.height===_.renderArea.height||(i.viewport(_.renderArea.x,_.renderArea.y,_.renderArea.width,_.renderArea.height),n.viewport.left=_.renderArea.x,n.viewport.top=_.renderArea.y,n.viewport.width=_.renderArea.width,n.viewport.height=_.renderArea.height),n.scissorRect.x===_.renderArea.x&&n.scissorRect.y===_.renderArea.y&&n.scissorRect.width===_.renderArea.width&&n.scissorRect.height===_.renderArea.height||(i.scissor(_.renderArea.x,_.renderArea.y,_.renderArea.width,_.renderArea.height),n.scissorRect.x=_.renderArea.x,n.scissorRect.y=_.renderArea.y,n.scissorRect.width=_.renderArea.width,n.scissorRect.height=_.renderArea.height);for(var p=_.gpuFramebuffer.gpuRenderPass,m=[],v=0;v<_.clearColors.length;++v){var g=p.colorAttachments[v];if(g.format!==no.UNKNOWN)switch(g.loadOp){case Ro.LOAD:break;case Ro.CLEAR:if(_.clearFlag&Bo.COLOR)if(n.bs.targets[0].blendColorMask!==vo.ALL&&i.colorMask(!0,!0,!0,!0),_.gpuFramebuffer.isOffscreen)WB[0]=_.clearColors[v].r,WB[1]=_.clearColors[v].g,WB[2]=_.clearColors[v].b,WB[3]=_.clearColors[v].a,i.clearBufferfv(i.COLOR,v,WB);else{var y=_.clearColors[0];i.clearColor(y.r,y.g,y.b,y.a),d|=i.COLOR_BUFFER_BIT}break;case Ro.DISCARD:m.push(i.COLOR_ATTACHMENT0+v)}}if(p.depthStencilAttachment&&p.depthStencilAttachment.format!==no.UNKNOWN){switch(p.depthStencilAttachment.depthLoadOp){case Ro.LOAD:break;case Ro.CLEAR:_.clearFlag&Bo.DEPTH&&(n.dss.depthWrite||i.depthMask(!0),i.clearDepth(_.clearDepth),d|=i.DEPTH_BUFFER_BIT);break;case Ro.DISCARD:m.push(i.DEPTH_ATTACHMENT)}if(Go[p.depthStencilAttachment.format].hasStencil)switch(p.depthStencilAttachment.stencilLoadOp){case Ro.LOAD:break;case Ro.CLEAR:_.clearFlag&Bo.STENCIL&&(n.dss.stencilWriteMaskFront||i.stencilMaskSeparate(i.FRONT,65535),n.dss.stencilWriteMaskBack||i.stencilMaskSeparate(i.BACK,65535),i.clearStencil(_.clearStencil),d|=i.STENCIL_BUFFER_BIT);break;case Ro.DISCARD:m.push(i.STENCIL_ATTACHMENT)}}if(m.length&&i.invalidateFramebuffer(i.FRAMEBUFFER,m),d&&i.clear(d),d&i.COLOR_BUFFER_BIT){var b=n.bs.targets[0].blendColorMask;if(b!==vo.ALL){var E=(b&vo.R)!==vo.NONE,T=(b&vo.G)!==vo.NONE,S=(b&vo.B)!==vo.NONE,x=(b&vo.A)!==vo.NONE;i.colorMask(E,T,S,x)}}d&i.DEPTH_BUFFER_BIT&&!n.dss.depthWrite&&i.depthMask(!1),d&i.STENCIL_BUFFER_BIT&&(n.dss.stencilWriteMaskFront||i.stencilMaskSeparate(i.FRONT,0),n.dss.stencilWriteMaskBack||i.stencilMaskSeparate(i.BACK,0))}break;case JB.END_RENDER_PASS:break;case JB.BIND_STATES:var A=t.bindStatesCmds.array[f];if(o=!1,A.gpuPipelineState){if(a=A.gpuPipelineState,u=A.gpuPipelineState.glPrimitive,A.gpuPipelineState.gpuShader){var w=A.gpuPipelineState.gpuShader.glProgram;n.glProgram!==w&&(i.useProgram(w),n.glProgram=w,o=!0),s=A.gpuPipelineState.gpuShader}var C=A.gpuPipelineState.rs;if(C){if(n.rs.cullMode!==C.cullMode){switch(C.cullMode){case ho.NONE:i.disable(i.CULL_FACE);break;case ho.FRONT:i.enable(i.CULL_FACE),i.cullFace(i.FRONT);break;case ho.BACK:i.enable(i.CULL_FACE),i.cullFace(i.BACK)}e.stateCache.rs.cullMode=C.cullMode}var R=e.reverseCW?!C.isFrontFaceCCW:C.isFrontFaceCCW;e.stateCache.rs.isFrontFaceCCW!==R&&(i.frontFace(R?i.CCW:i.CW),e.stateCache.rs.isFrontFaceCCW=R),e.stateCache.rs.depthBias===C.depthBias&&e.stateCache.rs.depthBiasSlop===C.depthBiasSlop||(i.polygonOffset(C.depthBias,C.depthBiasSlop),e.stateCache.rs.depthBias=C.depthBias,e.stateCache.rs.depthBiasSlop=C.depthBiasSlop),e.stateCache.rs.lineWidth!==C.lineWidth&&(i.lineWidth(C.lineWidth),e.stateCache.rs.lineWidth=C.lineWidth)}var k=A.gpuPipelineState.dss;k&&(n.dss.depthTest!==k.depthTest&&(k.depthTest?i.enable(i.DEPTH_TEST):i.disable(i.DEPTH_TEST),n.dss.depthTest=k.depthTest),n.dss.depthWrite!==k.depthWrite&&(i.depthMask(k.depthWrite),n.dss.depthWrite=k.depthWrite),n.dss.depthFunc!==k.depthFunc&&(i.depthFunc($B[k.depthFunc]),n.dss.depthFunc=k.depthFunc),n.dss.stencilTestFront===k.stencilTestFront&&n.dss.stencilTestBack===k.stencilTestBack||(k.stencilTestFront||k.stencilTestBack?i.enable(i.STENCIL_TEST):i.disable(i.STENCIL_TEST),n.dss.stencilTestFront=k.stencilTestFront,n.dss.stencilTestBack=k.stencilTestBack),n.dss.stencilFuncFront===k.stencilFuncFront&&n.dss.stencilRefFront===k.stencilRefFront&&n.dss.stencilReadMaskFront===k.stencilReadMaskFront||(i.stencilFuncSeparate(i.FRONT,$B[k.stencilFuncFront],k.stencilRefFront,k.stencilReadMaskFront),n.dss.stencilFuncFront=k.stencilFuncFront,n.dss.stencilRefFront=k.stencilRefFront,n.dss.stencilReadMaskFront=k.stencilReadMaskFront),n.dss.stencilFailOpFront===k.stencilFailOpFront&&n.dss.stencilZFailOpFront===k.stencilZFailOpFront&&n.dss.stencilPassOpFront===k.stencilPassOpFront||(i.stencilOpSeparate(i.FRONT,eD[k.stencilFailOpFront],eD[k.stencilZFailOpFront],eD[k.stencilPassOpFront]),n.dss.stencilFailOpFront=k.stencilFailOpFront,n.dss.stencilZFailOpFront=k.stencilZFailOpFront,n.dss.stencilPassOpFront=k.stencilPassOpFront),n.dss.stencilWriteMaskFront!==k.stencilWriteMaskFront&&(i.stencilMaskSeparate(i.FRONT,k.stencilWriteMaskFront),n.dss.stencilWriteMaskFront=k.stencilWriteMaskFront),n.dss.stencilFuncBack===k.stencilFuncBack&&n.dss.stencilRefBack===k.stencilRefBack&&n.dss.stencilReadMaskBack===k.stencilReadMaskBack||(i.stencilFuncSeparate(i.BACK,$B[k.stencilFuncBack],k.stencilRefBack,k.stencilReadMaskBack),n.dss.stencilFuncBack=k.stencilFuncBack,n.dss.stencilRefBack=k.stencilRefBack,n.dss.stencilReadMaskBack=k.stencilReadMaskBack),n.dss.stencilFailOpBack===k.stencilFailOpBack&&n.dss.stencilZFailOpBack===k.stencilZFailOpBack&&n.dss.stencilPassOpBack===k.stencilPassOpBack||(i.stencilOpSeparate(i.BACK,eD[k.stencilFailOpBack],eD[k.stencilZFailOpBack],eD[k.stencilPassOpBack]),n.dss.stencilFailOpBack=k.stencilFailOpBack,n.dss.stencilZFailOpBack=k.stencilZFailOpBack,n.dss.stencilPassOpBack=k.stencilPassOpBack),n.dss.stencilWriteMaskBack!==k.stencilWriteMaskBack&&(i.stencilMaskSeparate(i.BACK,k.stencilWriteMaskBack),n.dss.stencilWriteMaskBack=k.stencilWriteMaskBack));var O=A.gpuPipelineState.bs;if(O){n.bs.isA2C!==O.isA2C&&(O.isA2C?i.enable(i.SAMPLE_ALPHA_TO_COVERAGE):i.disable(i.SAMPLE_ALPHA_TO_COVERAGE),n.bs.isA2C=O.isA2C),n.bs.blendColor[0]===O.blendColor[0]&&n.bs.blendColor[1]===O.blendColor[1]&&n.bs.blendColor[2]===O.blendColor[2]&&n.bs.blendColor[3]===O.blendColor[3]||(i.blendColor(O.blendColor[0],O.blendColor[1],O.blendColor[2],O.blendColor[3]),n.bs.blendColor[0]=O.blendColor[0],n.bs.blendColor[1]=O.blendColor[1],n.bs.blendColor[2]=O.blendColor[2],n.bs.blendColor[3]=O.blendColor[3]);var I=O.targets[0],M=n.bs.targets[0];M.blend!==I.blend&&(I.blend?i.enable(i.BLEND):i.disable(i.BLEND),M.blend=I.blend),M.blendEq===I.blendEq&&M.blendAlphaEq===I.blendAlphaEq||(i.blendEquationSeparate(tD[I.blendEq],tD[I.blendAlphaEq]),M.blendEq=I.blendEq,M.blendAlphaEq=I.blendAlphaEq),M.blendSrc===I.blendSrc&&M.blendDst===I.blendDst&&M.blendSrcAlpha===I.blendSrcAlpha&&M.blendDstAlpha===I.blendDstAlpha||(i.blendFuncSeparate(iD[I.blendSrc],iD[I.blendDst],iD[I.blendSrcAlpha],iD[I.blendDstAlpha]),M.blendSrc=I.blendSrc,M.blendDst=I.blendDst,M.blendSrcAlpha=I.blendSrcAlpha,M.blendDstAlpha=I.blendDstAlpha),M.blendColorMask!==I.blendColorMask&&(i.colorMask((I.blendColorMask&vo.R)!==vo.NONE,(I.blendColorMask&vo.G)!==vo.NONE,(I.blendColorMask&vo.B)!==vo.NONE,(I.blendColorMask&vo.A)!==vo.NONE),M.blendColorMask=I.blendColorMask)}}if(A.gpuBindingLayout&&s)for(var L=A.gpuBindingLayout.gpuBindings,P=0;P<L.length;P++){var B=L[P];switch(B.type){case wo.UNIFORM_BUFFER:if(B.gpuBuffer)for(var D=0;D<s.glBlocks.length;D++){var F=s.glBlocks[D];if(F.binding===B.binding){n.glBindUBOs[F.binding]!==B.gpuBuffer.glBuffer&&(i.bindBufferBase(i.UNIFORM_BUFFER,F.binding,B.gpuBuffer.glBuffer),n.glBindUBOs[F.binding]=B.gpuBuffer.glBuffer,n.glUniformBuffer=B.gpuBuffer.glBuffer);break}}break;case wo.SAMPLER:if(B.gpuSampler){for(var N=null,z=0;z<s.glSamplers.length;z++){var U=s.glSamplers[z];if(U.binding===B.binding){N=U;break}}if(N)for(var G=0;G<N.units.length;G++){var V=N.units[G],H=n.glTexUnits[V];if(B.gpuTexView&&B.gpuTexView.gpuTexture.size>0){var W=B.gpuTexView.gpuTexture;H.glTexture!==W.glTexture&&(n.texUnit!==V&&(i.activeTexture(i.TEXTURE0+V),n.texUnit=V),W.glTexture?i.bindTexture(W.glTarget,W.glTexture):i.bindTexture(W.glTarget,e.nullTex2D.gpuTexture.glTexture),H.glTexture=W.glTexture);var j=B.gpuSampler;n.glSamplerUnits[V]!==j.glSampler&&(i.bindSampler(V,j.glSampler),n.glSamplerUnits[V]=j.glSampler)}}}else console.error("Not found sampler on binding unit "+B.binding)}}if(A.gpuInputAssembler&&s&&(o||l!==A.gpuInputAssembler))if(l=A.gpuInputAssembler,e.useVAO){var X=l.glVAOs.get(s.glProgram);if(!X){X=i.createVertexArray(),l.glVAOs.set(s.glProgram,X),i.bindVertexArray(X),i.bindBuffer(i.ARRAY_BUFFER,null),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null);for(var q=void 0,Y=0;Y<s.glInputs.length;Y++){var K=s.glInputs[Y];q=null;for(var Z=0;Z<l.glAttribs.length;Z++){var Q=l.glAttribs[Z];if(Q.name===K.name){q=Q;break}}if(q){i.bindBuffer(i.ARRAY_BUFFER,q.glBuffer);for(var J=0;J<q.componentCount;++J){var $=K.glLoc+J,ee=q.offset+q.size*J;i.enableVertexAttribArray($),n.glCurrentAttribLocs[$]=!0,i.vertexAttribPointer($,q.count,q.glType,q.isNormalized,q.stride,ee),i.vertexAttribDivisor($,q.isInstanced?1:0)}}}var te=l.gpuIndexBuffer;te&&i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,te.glBuffer),i.bindVertexArray(null),i.bindBuffer(i.ARRAY_BUFFER,null),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),n.glArrayBuffer=null,n.glElementArrayBuffer=null}n.glVAO!==X&&(i.bindVertexArray(X),n.glVAO=X)}else{for(var ie=0;ie<e.maxVertexAttributes;++ie)n.glCurrentAttribLocs[ie]=!1;for(var ne=0;ne<s.glInputs.length;ne++){for(var re=s.glInputs[ne],ae=null,se=0;se<l.glAttribs.length;se++){var oe=l.glAttribs[se];if(oe.name===re.name){ae=oe;break}}if(ae){n.glArrayBuffer!==ae.glBuffer&&(i.bindBuffer(i.ARRAY_BUFFER,ae.glBuffer),n.glArrayBuffer=ae.glBuffer);for(var le=0;le<ae.componentCount;++le){var ue=re.glLoc+le,ce=ae.offset+ae.size*le;!n.glEnabledAttribLocs[ue]&&ue>=0&&(i.enableVertexAttribArray(ue),n.glEnabledAttribLocs[ue]=!0),n.glCurrentAttribLocs[ue]=!0,i.vertexAttribPointer(ue,ae.count,ae.glType,ae.isNormalized,ae.stride,ce)}}}var he=l.gpuIndexBuffer;he&&n.glElementArrayBuffer!==he.glBuffer&&(i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,he.glBuffer),n.glElementArrayBuffer=he.glBuffer);for(var fe=0;fe<e.maxVertexAttributes;++fe)n.glEnabledAttribLocs[fe]!==n.glCurrentAttribLocs[fe]&&(i.disableVertexAttribArray(fe),n.glEnabledAttribLocs[fe]=!1)}if(a)for(var _e=0;_e<a.dynamicStates.length;_e++){switch(a.dynamicStates[_e]){case Mo.VIEWPORT:A.viewport&&(n.viewport.left===A.viewport.left&&n.viewport.top===A.viewport.top&&n.viewport.width===A.viewport.width&&n.viewport.height===A.viewport.height||(i.viewport(A.viewport.left,A.viewport.top,A.viewport.width,A.viewport.height),n.viewport.left=A.viewport.left,n.viewport.top=A.viewport.top,n.viewport.width=A.viewport.width,n.viewport.height=A.viewport.height));break;case Mo.SCISSOR:A.scissor&&(n.scissorRect.x===A.scissor.x&&n.scissorRect.y===A.scissor.y&&n.scissorRect.width===A.scissor.width&&n.scissorRect.height===A.scissor.height||(i.scissor(A.scissor.x,A.scissor.y,A.scissor.width,A.scissor.height),n.scissorRect.x=A.scissor.x,n.scissorRect.y=A.scissor.y,n.scissorRect.width=A.scissor.width,n.scissorRect.height=A.scissor.height));break;case Mo.LINE_WIDTH:A.lineWidth&&n.rs.lineWidth!==A.lineWidth&&(i.lineWidth(A.lineWidth),n.rs.lineWidth=A.lineWidth);break;case Mo.DEPTH_BIAS:A.depthBias&&(n.rs.depthBias===A.depthBias.constantFactor&&n.rs.depthBiasSlop===A.depthBias.slopeFactor||(i.polygonOffset(A.depthBias.constantFactor,A.depthBias.slopeFactor),n.rs.depthBias=A.depthBias.constantFactor,n.rs.depthBiasSlop=A.depthBias.slopeFactor));break;case Mo.BLEND_CONSTANTS:A.blendConstants&&(n.bs.blendColor[0]===A.blendConstants[0]&&n.bs.blendColor[1]===A.blendConstants[1]&&n.bs.blendColor[2]===A.blendConstants[2]&&n.bs.blendColor[3]===A.blendConstants[3]||(i.blendColor(A.blendConstants[0],A.blendConstants[1],A.blendConstants[2],A.blendConstants[3]),n.bs.blendColor[0]=A.blendConstants[0],n.bs.blendColor[1]=A.blendConstants[1],n.bs.blendColor[2]=A.blendConstants[2],n.bs.blendColor[3]=A.blendConstants[3]));break;case Mo.STENCIL_WRITE_MASK:if(A.stencilWriteMask)switch(A.stencilWriteMask.face){case Lo.FRONT:n.dss.stencilWriteMaskFront!==A.stencilWriteMask.writeMask&&(i.stencilMaskSeparate(i.FRONT,A.stencilWriteMask.writeMask),n.dss.stencilWriteMaskFront=A.stencilWriteMask.writeMask);break;case Lo.BACK:n.dss.stencilWriteMaskBack!==A.stencilWriteMask.writeMask&&(i.stencilMaskSeparate(i.BACK,A.stencilWriteMask.writeMask),n.dss.stencilWriteMaskBack=A.stencilWriteMask.writeMask);break;case Lo.ALL:n.dss.stencilWriteMaskFront===A.stencilWriteMask.writeMask&&n.dss.stencilWriteMaskBack===A.stencilWriteMask.writeMask||(i.stencilMask(A.stencilWriteMask.writeMask),n.dss.stencilWriteMaskFront=A.stencilWriteMask.writeMask,n.dss.stencilWriteMaskBack=A.stencilWriteMask.writeMask)}break;case Mo.STENCIL_COMPARE_MASK:if(A.stencilCompareMask)switch(A.stencilCompareMask.face){case Lo.FRONT:n.dss.stencilRefFront===A.stencilCompareMask.reference&&n.dss.stencilReadMaskFront===A.stencilCompareMask.compareMask||(i.stencilFuncSeparate(i.FRONT,$B[n.dss.stencilFuncFront],A.stencilCompareMask.reference,A.stencilCompareMask.compareMask),n.dss.stencilRefFront=A.stencilCompareMask.reference,n.dss.stencilReadMaskFront=A.stencilCompareMask.compareMask);break;case Lo.BACK:n.dss.stencilRefBack===A.stencilCompareMask.reference&&n.dss.stencilReadMaskBack===A.stencilCompareMask.compareMask||(i.stencilFuncSeparate(i.BACK,$B[n.dss.stencilFuncBack],A.stencilCompareMask.reference,A.stencilCompareMask.compareMask),n.dss.stencilRefBack=A.stencilCompareMask.reference,n.dss.stencilReadMaskBack=A.stencilCompareMask.compareMask);break;case Lo.ALL:n.dss.stencilRefFront===A.stencilCompareMask.reference&&n.dss.stencilReadMaskFront===A.stencilCompareMask.compareMask&&n.dss.stencilRefBack===A.stencilCompareMask.reference&&n.dss.stencilReadMaskBack===A.stencilCompareMask.compareMask||(i.stencilFunc($B[n.dss.stencilFuncBack],A.stencilCompareMask.reference,A.stencilCompareMask.compareMask),n.dss.stencilRefFront=A.stencilCompareMask.reference,n.dss.stencilReadMaskFront=A.stencilCompareMask.compareMask,n.dss.stencilRefBack=A.stencilCompareMask.reference,n.dss.stencilReadMaskBack=A.stencilCompareMask.compareMask)}}}break;case JB.DRAW:var de=t.drawCmds.array[f];if(l&&s)if(l.gpuIndirectBuffer)for(var pe=l.gpuIndirectBuffer.indirects,me=0;me<pe.length;me++){var ve=pe[me],ge=l.gpuIndexBuffer;if(ve.instanceCount)if(ge&&ve.indexCount>-1){var ye=ve.firstIndex*ge.stride;i.drawElementsInstanced(u,ve.indexCount,l.glIndexType,ye,ve.instanceCount)}else i.drawArraysInstanced(u,ve.firstVertex,ve.vertexCount,ve.instanceCount);else if(ge&&ve.indexCount>-1){var be=ve.firstIndex*ge.stride;i.drawElements(u,ve.indexCount,l.glIndexType,be)}else i.drawArrays(u,ve.firstVertex,ve.vertexCount)}else if(de.drawInfo.instanceCount)if(l.gpuIndexBuffer&&de.drawInfo.indexCount>-1){var Ee=de.drawInfo.firstIndex*l.gpuIndexBuffer.stride;i.drawElementsInstanced(u,de.drawInfo.indexCount,l.glIndexType,Ee,de.drawInfo.instanceCount)}else i.drawArraysInstanced(u,de.drawInfo.firstVertex,de.drawInfo.vertexCount,de.drawInfo.instanceCount);else if(l.gpuIndexBuffer&&de.drawInfo.indexCount>-1){var Te=de.drawInfo.firstIndex*l.gpuIndexBuffer.stride;i.drawElements(u,de.drawInfo.indexCount,l.glIndexType,Te)}else i.drawArrays(u,de.drawInfo.firstVertex,de.drawInfo.vertexCount);break;case JB.UPDATE_BUFFER:var Se=t.updateBufferCmds.array[f];cD(e,Se.gpuBuffer,Se.buffer,Se.offset,Se.size);break;case JB.COPY_BUFFER_TO_TEXTURE:var xe=t.copyBufferToTextureCmds.array[f];_D(e,[xe.gpuBuffer.buffer],xe.gpuTexture,xe.regions)}}}function _D(e,t,i,n){var r=e.gl,a=e.stateCache.glTexUnits[e.stateCache.texUnit];a.glTexture!==i.glTexture&&(r.bindTexture(i.glTarget,i.glTexture),a.glTexture=i.glTexture);var s=0,o=0,l=1,u=1,c=0,h=Go[i.format].isCompressed;switch(i.glTarget){case r.TEXTURE_2D:for(var f=0;f<n.length;f++){var _=n[f];for(l=_.texExtent.width,u=_.texExtent.height,s=_.texSubres.baseMipLevel;s<_.texSubres.levelCount;++s){var d=t[o++];h?i.glInternelFmt!==ZP.COMPRESSED_RGB_ETC1_WEBGL?r.compressedTexSubImage2D(r.TEXTURE_2D,s,_.texOffset.x,_.texOffset.y,l,u,i.glFormat,d):r.compressedTexImage2D(r.TEXTURE_2D,s,i.glInternelFmt,l,u,0,d):r.texSubImage2D(r.TEXTURE_2D,s,_.texOffset.x,_.texOffset.y,l,u,i.glFormat,i.glType,d),l=Math.max(1,l>>1),u=Math.max(1,l>>1)}}break;case r.TEXTURE_CUBE_MAP:for(var p=0;p<n.length;p++){var m=n[p];o=0;var v=m.texSubres.baseArrayLayer+m.texSubres.layerCount;for(c=m.texSubres.baseArrayLayer;c<v;++c){l=m.texExtent.width,u=m.texExtent.height;var g=m.texSubres.baseMipLevel+m.texSubres.levelCount;for(s=m.texSubres.baseMipLevel;s<g;++s){var y=t[o++];h?i.glInternelFmt!==ZP.COMPRESSED_RGB_ETC1_WEBGL?r.compressedTexSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+c,s,m.texOffset.x,m.texOffset.y,l,u,i.glFormat,y):r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+c,s,i.glInternelFmt,l,u,0,y):r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+c,s,m.texOffset.x,m.texOffset.y,l,u,i.glFormat,i.glType,y),l=Math.max(1,l>>1),u=Math.max(1,l>>1)}}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}i.flags&So.GEN_MIPMAP&&r.generateMipmap(i.glTarget)}var dD=function(e){function t(e){var n;return i(this,t),(n=c(this,o(t).call(this,e)))._gpuBuffer=null,n._indirectBuffer=null,n}return s(t,e),r(t,[{key:"gpuBuffer",get:function(){return this._gpuBuffer}}]),r(t,[{key:"initialize",value:function(e){return this._usage=e.usage,this._memUsage=e.memUsage,this._size=e.size,this._stride=Math.max(e.stride||this._size,1),this._count=this._size/this._stride,this._flags=void 0!==e.flags?e.flags:so.NONE,this._usage&ro.INDIRECT&&(this._indirectBuffer={drawInfos:[]}),this._flags&so.BAKUP_BUFFER&&(this._bufferView=new Uint8Array(this._size)),this._gpuBuffer={usage:e.usage,memUsage:e.memUsage,size:e.size,stride:this._stride,buffer:null,vf32:null,indirects:[],glTarget:0,glBuffer:null},e.usage&ro.INDIRECT&&(this._gpuBuffer.indirects=this._indirectBuffer.drawInfos),function(e,t){var i=e.gl,n=e.stateCache,r=t.memUsage&ao.HOST?i.DYNAMIC_DRAW:i.STATIC_DRAW;if(t.usage&ro.VERTEX){t.glTarget=i.ARRAY_BUFFER;var a=i.createBuffer();a&&(t.glBuffer=a,t.size>0&&(e.useVAO&&n.glVAO&&(i.bindVertexArray(null),n.glVAO=null),e.stateCache.glArrayBuffer!==t.glBuffer&&(i.bindBuffer(i.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer),i.bufferData(i.ARRAY_BUFFER,t.size,r),i.bindBuffer(i.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null))}else if(t.usage&ro.INDEX){t.glTarget=i.ELEMENT_ARRAY_BUFFER;var s=i.createBuffer();s&&(t.glBuffer=s,t.size>0&&(e.useVAO&&n.glVAO&&(i.bindVertexArray(null),n.glVAO=null),e.stateCache.glElementArrayBuffer!==t.glBuffer&&(i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer),i.bufferData(i.ELEMENT_ARRAY_BUFFER,t.size,r),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null))}else if(t.usage&ro.UNIFORM){t.glTarget=i.UNIFORM_BUFFER;var o=i.createBuffer();o&&t.size>0&&(t.glBuffer=o,e.stateCache.glUniformBuffer!==t.glBuffer&&(i.bindBuffer(i.UNIFORM_BUFFER,t.glBuffer),e.stateCache.glUniformBuffer=t.glBuffer),i.bufferData(i.UNIFORM_BUFFER,t.size,r),i.bindBuffer(i.UNIFORM_BUFFER,null),e.stateCache.glUniformBuffer=null)}else t.usage&ro.INDIRECT?t.glTarget=i.NONE:t.usage&ro.TRANSFER_DST?t.glTarget=i.NONE:t.usage&ro.TRANSFER_SRC?t.glTarget=i.NONE:(console.error("Unsupported GFXBufferType, create buffer failed."),t.glTarget=i.NONE)}(this._device,this._gpuBuffer),this._device.memoryStatus.bufferSize+=this._size,this._status=Ks.SUCCESS,!0}},{key:"destroy",value:function(){var e,t;this._gpuBuffer&&(e=this._device,(t=this._gpuBuffer).glBuffer&&(e.gl.deleteBuffer(t.glBuffer),t.glBuffer=null),this._device.memoryStatus.bufferSize-=this._size,this._gpuBuffer=null),this._bufferView=null,this._status=Ks.UNREADY}},{key:"resize",value:function(e){var t,i,n,r,a,s=this._size;if(this._size=e,this._count=this._size/this._stride,this._bufferView&&s!==e){var o=this._bufferView;this._bufferView=new Uint8Array(this._size),this._bufferView.set(o),this._gpuBuffer&&(this._gpuBuffer.buffer=this._bufferView)}this._gpuBuffer&&(this._gpuBuffer.size=this._size,this._size>0&&(t=this._device,i=this._gpuBuffer,n=t.gl,r=t.stateCache,a=i.memUsage&ao.HOST?n.DYNAMIC_DRAW:n.STATIC_DRAW,i.usage&ro.VERTEX?(t.useVAO&&r.glVAO&&(n.bindVertexArray(null),r.glVAO=null),r.glArrayBuffer!==i.glBuffer&&n.bindBuffer(n.ARRAY_BUFFER,i.glBuffer),i.buffer?n.bufferData(n.ARRAY_BUFFER,i.buffer,a):n.bufferData(n.ARRAY_BUFFER,i.size,a),n.bindBuffer(n.ARRAY_BUFFER,null),r.glArrayBuffer=null):i.usage&ro.INDEX?(t.useVAO&&r.glVAO&&(n.bindVertexArray(null),r.glVAO=null),t.stateCache.glElementArrayBuffer!==i.glBuffer&&n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,i.glBuffer),i.buffer?n.bufferData(n.ELEMENT_ARRAY_BUFFER,i.buffer,a):n.bufferData(n.ELEMENT_ARRAY_BUFFER,i.size,a),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),t.stateCache.glElementArrayBuffer=null):i.usage&ro.UNIFORM?(t.stateCache.glUniformBuffer!==i.glBuffer&&n.bindBuffer(n.UNIFORM_BUFFER,i.glBuffer),n.bufferData(n.UNIFORM_BUFFER,i.size,a),n.bindBuffer(n.UNIFORM_BUFFER,null),t.stateCache.glUniformBuffer=null):i.usage&ro.INDIRECT||i.usage&ro.TRANSFER_DST||i.usage&ro.TRANSFER_SRC?i.glTarget=n.NONE:(console.error("Unsupported GFXBufferType, create buffer failed."),i.glTarget=n.NONE),this._device.memoryStatus.bufferSize-=s,this._device.memoryStatus.bufferSize+=this._size,this._bufferView&&(this._device.memoryStatus.bufferSize-=s,this._device.memoryStatus.bufferSize+=this._size)))}},{key:"update",value:function(e,t,i){var n;if(n=void 0!==i?i:this._usage&ro.INDIRECT?0:e.byteLength,this._bufferView&&e!==this._bufferView.buffer){var r=new Uint8Array(e,0,i);this._bufferView.set(r,t)}cD(this._device,this._gpuBuffer,e,t||0,n)}}]),t}(H_),pD=function(){function e(t,n){i(this,e),this._freeIdx=0,this._frees=new Array(n),this._freeCmds=new Ja(n);for(var r=0;r<n;++r)this._frees[r]=new t;this._freeIdx=n-1}return r(e,[{key:"alloc",value:function(e){if(this._freeIdx<0){var t=2*this._frees.length,i=this._frees;this._frees=new Array(t);for(var n=t-i.length,r=0;r<n;++r)this._frees[r]=new e;for(var a=n,s=0;a<t;++a,++s)this._frees[a]=i[s];this._freeIdx+=n}var o=this._frees[this._freeIdx];return this._frees[this._freeIdx--]=null,++o.refCount,o}},{key:"free",value:function(e){0==--e.refCount&&this._freeCmds.push(e)}},{key:"freeCmds",value:function(e){for(var t=0;t<e.length;++t)0==--e.array[t].refCount&&this._freeCmds.push(e.array[t])}},{key:"release",value:function(){for(var e=0;e<this._freeCmds.length;++e){var t=this._freeCmds.array[e];t.clear(),this._frees[++this._freeIdx]=t}this._freeCmds.clear()}}]),e}(),mD=function(e){function t(e){var n;return i(this,t),(n=c(this,o(t).call(this,e))).beginRenderPassCmdPool=new pD(rD,1),n.bindStatesCmdPool=new pD(aD,1),n.drawCmdPool=new pD(sD,1),n.updateBufferCmdPool=new pD(oD,1),n.copyBufferToTextureCmdPool=new pD(lD,1),n}return s(t,e),r(t,[{key:"initialize",value:function(e){return this._status=Ks.SUCCESS,!0}},{key:"destroy",value:function(){this._status=Ks.UNREADY}},{key:"clearCmds",value:function(e){e.beginRenderPassCmds.length&&(this.beginRenderPassCmdPool.freeCmds(e.beginRenderPassCmds),e.beginRenderPassCmds.clear()),e.bindStatesCmds.length&&(this.bindStatesCmdPool.freeCmds(e.bindStatesCmds),e.bindStatesCmds.clear()),e.drawCmds.length&&(this.drawCmdPool.freeCmds(e.drawCmds),e.drawCmds.clear()),e.updateBufferCmds.length&&(this.updateBufferCmdPool.freeCmds(e.updateBufferCmds),e.updateBufferCmds.clear()),e.copyBufferToTextureCmds.length&&(this.copyBufferToTextureCmdPool.freeCmds(e.copyBufferToTextureCmds),e.copyBufferToTextureCmds.clear()),e.cmds.clear()}},{key:"releaseCmds",value:function(){this.beginRenderPassCmdPool.release(),this.bindStatesCmdPool.release(),this.drawCmdPool.release(),this.updateBufferCmdPool.release(),this.copyBufferToTextureCmdPool.release()}}]),t}(od),vD=function(e){function t(e){var n;return i(this,t),(n=c(this,o(t).call(this,e))).cmdPackage=new uD,n._webGLAllocator=null,n._isInRenderPass=!1,n._curGPUPipelineState=null,n._curGPUBindingLayout=null,n._curGPUInputAssembler=null,n._curViewport=null,n._curScissor=null,n._curLineWidth=null,n._curDepthBias=null,n._curBlendConstants=[],n._curDepthBounds=null,n._curStencilWriteMask=null,n._curStencilCompareMask=null,n._isStateInvalied=!1,n}return s(t,e),r(t,[{key:"initialize",value:function(e){return!!e.allocator&&(this._allocator=e.allocator,this._webGLAllocator=this._allocator,this._type=e.type,this._status=Ks.SUCCESS,!0)}},{key:"destroy",value:function(){this._webGLAllocator&&(this._webGLAllocator.clearCmds(this.cmdPackage),this._allocator=null,this._webGLAllocator=null),this._status=Ks.UNREADY}},{key:"begin",value:function(){this._webGLAllocator.clearCmds(this.cmdPackage),this._curGPUPipelineState=null,this._curGPUBindingLayout=null,this._curGPUInputAssembler=null,this._curViewport=null,this._curScissor=null,this._curLineWidth=null,this._curDepthBias=null,this._curBlendConstants=[],this._curDepthBounds=null,this._curStencilWriteMask=null,this._curStencilCompareMask=null,this._numDrawCalls=0,this._numTris=0}},{key:"end",value:function(){this._isStateInvalied&&this.bindStates(),this._isInRenderPass=!1}},{key:"beginRenderPass",value:function(e,t,i,n,r,a){var s=this._webGLAllocator.beginRenderPassCmdPool.alloc(rD);s.gpuFramebuffer=e.gpuFramebuffer,s.renderArea=t,s.clearFlag=i;for(var o=0;o<n.length;++o)s.clearColors[o]=n[o];s.clearDepth=r,s.clearStencil=a,this.cmdPackage.beginRenderPassCmds.push(s),this.cmdPackage.cmds.push(JB.BEGIN_RENDER_PASS),this._isInRenderPass=!0}},{key:"endRenderPass",value:function(){this._isInRenderPass=!1}},{key:"bindPipelineState",value:function(e){var t=e.gpuPipelineState;this._curGPUPipelineState=t,this._isStateInvalied=!0}},{key:"bindBindingLayout",value:function(e){var t=e.gpuBindingLayout;this._curGPUBindingLayout=t,this._isStateInvalied=!0}},{key:"bindInputAssembler",value:function(e){var t=e.gpuInputAssembler;this._curGPUInputAssembler=t,this._isStateInvalied=!0}},{key:"setViewport",value:function(e){this._curViewport?this._curViewport.left===e.left&&this._curViewport.top===e.top&&this._curViewport.width===e.width&&this._curViewport.height===e.height&&this._curViewport.minDepth===e.minDepth&&this._curViewport.maxDepth===e.maxDepth||(this._curViewport.left=e.left,this._curViewport.top=e.top,this._curViewport.width=e.width,this._curViewport.height=e.height,this._curViewport.minDepth=e.minDepth,this._curViewport.maxDepth=e.maxDepth,this._isStateInvalied=!0):this._curViewport={left:e.left,top:e.top,width:e.width,height:e.height,minDepth:e.minDepth,maxDepth:e.maxDepth},this._curViewport!==e&&(this._curViewport=e,this._isStateInvalied=!0)}},{key:"setScissor",value:function(e){this._curScissor?this._curScissor.x===e.x&&this._curScissor.y===e.y&&this._curScissor.width===e.width&&this._curScissor.height===e.height||(this._curScissor.x=e.x,this._curScissor.y=e.y,this._curScissor.width=e.width,this._curScissor.height=e.height,this._isStateInvalied=!0):this._curScissor={x:e.x,y:e.y,width:e.width,height:e.height}}},{key:"setLineWidth",value:function(e){this._curLineWidth!==e&&(this._curLineWidth=e,this._isStateInvalied=!0)}},{key:"setDepthBias",value:function(e,t,i){this._curDepthBias?this._curDepthBias.constantFactor===e&&this._curDepthBias.clamp===t&&this._curDepthBias.slopeFactor===i||(this._curDepthBias.constantFactor=e,this._curDepthBias.clamp=t,this._curDepthBias.slopeFactor=i,this._isStateInvalied=!0):(this._curDepthBias={constantFactor:e,clamp:t,slopeFactor:i},this._isStateInvalied=!0)}},{key:"setBlendConstants",value:function(e){(this._curBlendConstants||4!==e.length)&&(4!==e.length||this._curBlendConstants[0]===e[0]&&this._curBlendConstants[1]===e[1]&&this._curBlendConstants[2]===e[2]&&this._curBlendConstants[3]===e[3])||(this._curBlendConstants=[e[0],e[1],e[2],e[3]],this._isStateInvalied=!0)}},{key:"setDepthBound",value:function(e,t){this._curDepthBounds&&this._curDepthBounds.minBounds===e&&this._curDepthBounds.maxBounds===t||(this._curDepthBounds={minBounds:e,maxBounds:t},this._isStateInvalied=!0)}},{key:"setStencilWriteMask",value:function(e,t){this._curStencilWriteMask?this._curStencilWriteMask.face===e&&this._curStencilWriteMask.writeMask===t||(this._curStencilWriteMask.face=e,this._curStencilWriteMask.writeMask=t,this._isStateInvalied=!0):(this._curStencilWriteMask={face:e,writeMask:t},this._isStateInvalied=!0)}},{key:"setStencilCompareMask",value:function(e,t,i){this._curStencilCompareMask?this._curStencilCompareMask.face===e&&this._curStencilCompareMask.reference===t&&this._curStencilCompareMask.compareMask===i||(this._curStencilCompareMask.face=e,this._curStencilCompareMask.reference=t,this._curStencilCompareMask.compareMask=i,this._isStateInvalied=!0):(this._curStencilCompareMask={face:e,reference:t,compareMask:i},this._isStateInvalied=!0)}},{key:"draw",value:function(e){if(this._type===Co.PRIMARY&&this._isInRenderPass||this._type===Co.SECONDARY){this._isStateInvalied&&this.bindStates();var t=this._allocator.drawCmdPool.alloc(sD);e.extractCmdDraw(t),this.cmdPackage.drawCmds.push(t),this.cmdPackage.cmds.push(JB.DRAW),++this._numDrawCalls;var i=e.indexCount||e.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=i/3*Math.max(e.instanceCount,1);break;case 5:case 6:this._numTris+=(i-2)*Math.max(e.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")}},{key:"updateBuffer",value:function(e,t,i,n){if(this._type===Co.PRIMARY&&!this._isInRenderPass||this._type===Co.SECONDARY){var r=e.gpuBuffer;if(r){var a,s=this._webGLAllocator.updateBufferCmdPool.alloc(oD);a=void 0!==n?n:e.usage&ro.INDIRECT?0:t.byteLength;var o=t;s.gpuBuffer=r,s.buffer=o,s.offset=void 0!==i?i:0,s.size=a,this.cmdPackage.updateBufferCmds.push(s),this.cmdPackage.cmds.push(JB.UPDATE_BUFFER)}}else console.error("Command 'updateBuffer' must be recorded outside a render pass.")}},{key:"copyBufferToTexture",value:function(e,t,i,n){if(this._type===Co.PRIMARY&&!this._isInRenderPass||this._type===Co.SECONDARY){var r=e.gpuBuffer,a=t.gpuTexture;if(r&&a){var s=this._webGLAllocator.copyBufferToTextureCmdPool.alloc(lD);s.gpuBuffer=r,s.gpuTexture=a,s.dstLayout=i,s.regions=n,this.cmdPackage.copyBufferToTextureCmds.push(s),this.cmdPackage.cmds.push(JB.COPY_BUFFER_TO_TEXTURE)}}else console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.")}},{key:"execute",value:function(e,t){for(var i=0;i<t;++i){for(var n=e[i],r=0;r<n.cmdPackage.beginRenderPassCmds.length;++r){var a=n.cmdPackage.beginRenderPassCmds.array[r];++a.refCount,this.cmdPackage.beginRenderPassCmds.push(a)}for(var s=0;s<n.cmdPackage.bindStatesCmds.length;++s){var o=n.cmdPackage.bindStatesCmds.array[s];++o.refCount,this.cmdPackage.bindStatesCmds.push(o)}for(var l=0;l<n.cmdPackage.drawCmds.length;++l){var u=n.cmdPackage.drawCmds.array[l];++u.refCount,this.cmdPackage.drawCmds.push(u)}for(var c=0;c<n.cmdPackage.updateBufferCmds.length;++c){var h=n.cmdPackage.updateBufferCmds.array[c];++h.refCount,this.cmdPackage.updateBufferCmds.push(h)}for(var f=0;f<n.cmdPackage.copyBufferToTextureCmds.length;++f){var _=n.cmdPackage.copyBufferToTextureCmds.array[f];++_.refCount,this.cmdPackage.copyBufferToTextureCmds.push(_)}this.cmdPackage.cmds.concat(n.cmdPackage.cmds.array),this._numDrawCalls+=n._numDrawCalls,this._numTris+=n._numTris}}},{key:"bindStates",value:function(){var e=this._webGLAllocator.bindStatesCmdPool.alloc(aD);e.gpuPipelineState=this._curGPUPipelineState,e.gpuBindingLayout=this._curGPUBindingLayout,e.gpuInputAssembler=this._curGPUInputAssembler,e.viewport=this._curViewport,e.scissor=this._curScissor,e.lineWidth=this._curLineWidth,e.depthBias=this._curDepthBias,e.blendConstants=this._curBlendConstants,e.depthBounds=this._curDepthBounds,e.stencilWriteMask=this._curStencilWriteMask,e.stencilCompareMask=this._curStencilCompareMask,this.cmdPackage.bindStatesCmds.push(e),this.cmdPackage.cmds.push(JB.BIND_STATES),this._isStateInvalied=!1}},{key:"webGLDevice",get:function(){return this._device}}]),t}(W_),gD=function(e){function t(e){var n;return i(this,t),(n=c(this,o(t).call(this,e)))._gpuFramebuffer=null,n}return s(t,e),r(t,[{key:"gpuFramebuffer",get:function(){return this._gpuFramebuffer}}]),r(t,[{key:"initialize",value:function(e){if(this._renderPass=e.renderPass,this._colorViews=e.colorViews||[],this._depthStencilView=e.depthStencilView||null,this._isOffscreen=void 0===e.isOffscreen||e.isOffscreen,this._isOffscreen){var t=[];if(void 0!==e.colorViews){var i=e.colorViews,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;t.push(s.gpuTextureView)}}var o=null;e.depthStencilView&&(o=e.depthStencilView.gpuTextureView),this._gpuFramebuffer={gpuRenderPass:e.renderPass.gpuRenderPass,gpuColorViews:t,gpuDepthStencilView:o,isOffscreen:this._isOffscreen,glFramebuffer:null},function(e,t){if(t.isOffscreen){var i=e.gl,n=[],r=i.createFramebuffer();if(r){t.glFramebuffer=r,e.stateCache.glFramebuffer!==t.glFramebuffer&&(i.bindFramebuffer(i.FRAMEBUFFER,t.glFramebuffer),e.stateCache.glFramebuffer=t.glFramebuffer);for(var a=0;a<t.gpuColorViews.length;++a){var s=t.gpuColorViews[a];s&&(s.gpuTexture.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+a,s.gpuTexture.glTarget,s.gpuTexture.glTexture,s.baseLevel):i.framebufferRenderbuffer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+a,i.RENDERBUFFER,s.gpuTexture.glRenderbuffer),n.push(i.COLOR_ATTACHMENT0+a))}var o=t.gpuDepthStencilView;if(o){var l=Go[o.format].hasStencil?i.DEPTH_STENCIL_ATTACHMENT:i.DEPTH_ATTACHMENT;o.gpuTexture.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,l,o.gpuTexture.glTarget,o.gpuTexture.glTexture,o.baseLevel):i.framebufferRenderbuffer(i.FRAMEBUFFER,l,i.RENDERBUFFER,o.gpuTexture.glRenderbuffer)}i.drawBuffers(n);var u=i.checkFramebufferStatus(i.FRAMEBUFFER);if(u!==i.FRAMEBUFFER_COMPLETE)switch(u){case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case i.FRAMEBUFFER_UNSUPPORTED:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_UNSUPPORTED")}}}}(this._device,this._gpuFramebuffer)}else this._gpuFramebuffer={gpuRenderPass:e.renderPass.gpuRenderPass,gpuColorViews:[],gpuDepthStencilView:null,isOffscreen:e.isOffscreen,glFramebuffer:null};return this._status=Ks.SUCCESS,!0}},{key:"destroy",value:function(){var e,t;this._isOffscreen&&this._gpuFramebuffer&&(e=this._device,(t=this._gpuFramebuffer).glFramebuffer&&(e.gl.deleteFramebuffer(t.glFramebuffer),t.glFramebuffer=null)),this._gpuFramebuffer=null,this._status=Ks.UNREADY}}]),t}(j_),yD=function(e){function t(e){var n;return i(this,t),(n=c(this,o(t).call(this,e)))._gpuInputAssembler=null,n}return s(t,e),r(t,[{key:"gpuInputAssembler",get:function(){return this._gpuInputAssembler}}]),r(t,[{key:"initialize",value:function(e){if(0===e.vertexBuffers.length)return console.error("GFXInputAssemblerInfo.vertexBuffers is null."),!1;if(this._attributes=e.attributes,this._vertexBuffers=e.vertexBuffers,void 0!==e.indexBuffer)this._indexBuffer=e.indexBuffer,this._indexCount=this._indexBuffer.size/this._indexBuffer.stride;else{var t=this._vertexBuffers[0];this._vertexCount=t.size/t.stride}this._indirectBuffer=e.indirectBuffer||null;for(var i=new Array(e.vertexBuffers.length),n=0;n<e.vertexBuffers.length;++n){var r=e.vertexBuffers[n];r.gpuBuffer&&(i[n]=r.gpuBuffer)}var a=null,s=0;if(e.indexBuffer&&(a=e.indexBuffer.gpuBuffer))switch(a.stride){case 1:s=5121;break;case 2:s=5123;break;case 4:s=5125;break;default:console.error("Illegal index buffer stride.")}var o=null;return void 0!==e.indirectBuffer&&(o=e.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:e.attributes,gpuVertexBuffers:i,gpuIndexBuffer:a,gpuIndirectBuffer:o,glAttribs:[],glIndexType:s,glVAOs:new Map},function(e,t){var i=e.gl;t.glAttribs=new Array(t.attributes.length);for(var n=[0,0,0,0,0,0,0,0],r=0;r<t.attributes.length;++r){var a=t.attributes[r],s=void 0!==a.stream?a.stream:0,o=t.gpuVertexBuffers[s],l=jB(a.format,i),u=Go[a.format].size;t.glAttribs[r]={name:a.name,glBuffer:o.glBuffer,glType:l,size:u,count:Go[a.format].count,stride:o.stride,componentCount:QB(l,i),isNormalized:void 0!==a.isNormalized&&a.isNormalized,isInstanced:void 0!==a.isInstanced&&a.isInstanced,offset:n[s]},n[s]+=u}}(this._device,this._gpuInputAssembler),this._status=Ks.SUCCESS,!0}},{key:"destroy",value:function(){var e=this._device;this._gpuInputAssembler&&e.useVAO&&function(e,t){for(var i=t.glVAOs.values(),n=i.next();!n.done;)e.gl.deleteVertexArray(n.value),n=i.next();t.glVAOs.clear()}(e,this._gpuInputAssembler),this._gpuInputAssembler=null,this._status=Ks.UNREADY}},{key:"extractCmdDraw",value:function(e){e.drawInfo.vertexCount=this._vertexCount,e.drawInfo.firstVertex=this._firstVertex,e.drawInfo.indexCount=this._indexCount,e.drawInfo.firstIndex=this._firstIndex,e.drawInfo.vertexOffset=this._vertexOffset,e.drawInfo.instanceCount=this._instanceCount,e.drawInfo.firstInstance=this._firstInstance}}]),t}(J_),bD=function(e){function t(e){var n;return i(this,t),(n=c(this,o(t).call(this,e)))._gpuPipelineLayout=null,n}return s(t,e),r(t,[{key:"gpuPipelineLayout",get:function(){return this._gpuPipelineLayout}}]),r(t,[{key:"initialize",value:function(e){return this._layouts=e.layouts,this._pushConstantsRanges=e.pushConstantsRanges||[],this._status=Ks.SUCCESS,!0}},{key:"destroy",value:function(){this._status=Ks.UNREADY}}]),t}($_),ED=[0,1,3,2,0,0,0,4,5,6,0,0,0,0],TD=function(e){function t(e){var n;return i(this,t),(n=c(this,o(t).call(this,e)))._gpuPipelineState=null,n}return s(t,e),r(t,[{key:"gpuPipelineState",get:function(){return this._gpuPipelineState}}]),r(t,[{key:"initialize",value:function(e){return this._primitive=e.primitive,this._shader=e.shader,this._is=e.inputState,this._rs=e.rasterizerState,this._dss=e.depthStencilState,this._bs=e.blendState,this._dynamicStates=e.dynamicStates||[],this._hash=e.hash,this._layout=e.layout,this._renderPass=e.renderPass,this._gpuPipelineState={glPrimitive:ED[e.primitive],gpuShader:e.shader.gpuShader,rs:e.rasterizerState,dss:e.depthStencilState,bs:e.blendState,dynamicStates:void 0!==e.dynamicStates?e.dynamicStates:[],gpuLayout:e.layout.gpuPipelineLayout,gpuRenderPass:e.renderPass.gpuRenderPass},this._status=Ks.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuPipelineState=null,this._status=Ks.UNREADY}}]),t}(G_),SD=function(e){function t(e){var n;return i(this,t),(n=c(this,o(t).call(this,e))).numDrawCalls=0,n.numTris=0,n._isAsync=!1,n}return s(t,e),r(t,[{key:"initialize",value:function(e){return this._type=e.type,this._status=Ks.SUCCESS,!0}},{key:"destroy",value:function(){this._status=Ks.UNREADY}},{key:"submit",value:function(e,t){if(!this._isAsync){var i=e,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;fD(this._device,s.cmdPackage),this.numDrawCalls+=s.numDrawCalls,this.numTris+=s.numTris}}}},{key:"clear",value:function(){this.numDrawCalls=0,this.numTris=0}}]),t}(ed),xD=function(e){function t(e){var n;return i(this,t),(n=c(this,o(t).call(this,e)))._gpuRenderPass=null,n}return s(t,e),r(t,[{key:"gpuRenderPass",get:function(){return this._gpuRenderPass}}]),r(t,[{key:"initialize",value:function(e){return this._colorInfos=e.colorAttachments||[],this._depthStencilInfo=e.depthStencilAttachment||null,this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._status=Ks.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuRenderPass=null,this._status=Ks.UNREADY}}]),t}(td),AD=function(e){function t(e){var n;return i(this,t),(n=c(this,o(t).call(this,e)))._gpuSampler=null,n._state=new id,n}return s(t,e),r(t,[{key:"gpuSampler",get:function(){return this._gpuSampler}}]),r(t,[{key:"initialize",value:function(e){var t,i,n,r;return void 0!==e.name&&(this._state.name=e.name),void 0!==e.minFilter&&(this._state.minFilter=e.minFilter),void 0!==e.magFilter&&(this._state.magFilter=e.magFilter),void 0!==e.mipFilter&&(this._state.mipFilter=e.mipFilter),void 0!==e.addressU&&(this._state.addressU=e.addressU),void 0!==e.addressV&&(this._state.addressV=e.addressV),void 0!==e.addressW&&(this._state.addressW=e.addressW),void 0!==e.maxAnisotropy&&(this._state.maxAnisotropy=e.maxAnisotropy),void 0!==e.cmpFunc&&(this._state.cmpFunc=e.cmpFunc),void 0!==e.borderColor&&(this._state.borderColor=e.borderColor),void 0!==e.minLOD&&(this._state.minLOD=e.minLOD),void 0!==e.maxLOD&&(this._state.maxLOD=e.maxLOD),void 0!==e.mipLODBias&&(this._state.mipLODBias=e.mipLODBias),this._gpuSampler={glSampler:null,minFilter:this._state.minFilter,magFilter:this._state.magFilter,mipFilter:this._state.mipFilter,addressU:this._state.addressU,addressV:this._state.addressV,addressW:this._state.addressW,minLOD:this._state.minLOD,maxLOD:this._state.maxLOD,glMinFilter:0,glMagFilter:0,glWrapS:0,glWrapT:0,glWrapR:0},t=this._device,i=this._gpuSampler,n=t.gl,(r=n.createSampler())&&(i.minFilter===go.LINEAR||i.minFilter===go.ANISOTROPIC?i.mipFilter===go.LINEAR||i.mipFilter===go.ANISOTROPIC?i.glMinFilter=n.LINEAR_MIPMAP_LINEAR:i.mipFilter===go.POINT?i.glMinFilter=n.LINEAR_MIPMAP_NEAREST:i.glMinFilter=n.LINEAR:i.mipFilter===go.LINEAR||i.mipFilter===go.ANISOTROPIC?i.glMinFilter=n.NEAREST_MIPMAP_LINEAR:i.mipFilter===go.POINT?i.glMinFilter=n.NEAREST_MIPMAP_NEAREST:i.glMinFilter=n.NEAREST,i.magFilter===go.LINEAR||i.magFilter===go.ANISOTROPIC?i.glMagFilter=n.LINEAR:i.glMagFilter=n.NEAREST,i.glWrapS=VB[i.addressU],i.glWrapT=VB[i.addressV],i.glWrapR=VB[i.addressW],i.glSampler=r,n.samplerParameteri(r,n.TEXTURE_MIN_FILTER,i.glMinFilter),n.samplerParameteri(r,n.TEXTURE_MAG_FILTER,i.glMagFilter),n.samplerParameteri(r,n.TEXTURE_WRAP_S,i.glWrapS),n.samplerParameteri(r,n.TEXTURE_WRAP_T,i.glWrapT),n.samplerParameteri(r,n.TEXTURE_WRAP_R,i.glWrapR),n.samplerParameterf(r,n.TEXTURE_MIN_LOD,i.minLOD),n.samplerParameterf(r,n.TEXTURE_MAX_LOD,i.maxLOD)),this._status=Ks.SUCCESS,!0}},{key:"destroy",value:function(){var e,t;this._gpuSampler&&(e=this._device,(t=this._gpuSampler).glSampler&&(e.gl.deleteSampler(t.glSampler),t.glSampler=null),this._gpuSampler=null),this._status=Ks.UNREADY}}]),t}(nd),wD=function(e){function n(e){var t;return i(this,n),(t=c(this,o(n).call(this,e)))._gpuShader=null,t}return s(n,e),r(n,[{key:"gpuShader",get:function(){return this._gpuShader}}]),r(n,[{key:"initialize",value:function(e){this._name=e.name,this._stages=e.stages,void 0!==e.blocks&&(this._blocks=e.blocks),void 0!==e.samplers&&(this._samplers=e.samplers),this._gpuShader={name:e.name?e.name:"",blocks:void 0!==e.blocks?e.blocks:[],samplers:void 0!==e.samplers?e.samplers:[],gpuStages:new Array(e.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplers:[]};for(var i=0;i<e.stages.length;++i){var n=e.stages[i];this._gpuShader.gpuStages[i]={type:n.type,source:n.source,macros:n.macros?n.macros:[],glShader:null}}return function(e,i){for(var n=e.gl,r=function(e){var t=i.gpuStages[e],r=0,a="",s=1;switch(t.type){case Ao.VERTEX:a="VertexShader",r=n.VERTEX_SHADER;break;case Ao.FRAGMENT:a="FragmentShader",r=n.FRAGMENT_SHADER;break;default:return console.error("Unsupported GFXShaderType."),{v:void 0}}var o=n.createShader(r);if(o&&(t.glShader=o,n.shaderSource(t.glShader,"#version 300 es\n"+t.source),n.compileShader(t.glShader),!n.getShaderParameter(t.glShader,n.COMPILE_STATUS))){console.error(a+" in '"+i.name+"' compilation failed."),console.error("Shader source dump:",t.source.replace(/^|\n/g,(function(){return"\n".concat(s++," ")}))),console.error(n.getShaderInfoLog(t.glShader));for(var l=0;l<i.gpuStages.length;l++){var u=i.gpuStages[e];u.glShader&&(n.deleteShader(u.glShader),u.glShader=null)}return{v:void 0}}},a=0;a<i.gpuStages.length;a++){var s=r(a);if("object"===t(s))return s.v}var o=n.createProgram();if(o){i.glProgram=o;for(var l=0;l<i.gpuStages.length;l++){var u=i.gpuStages[l];n.attachShader(i.glProgram,u.glShader)}n.linkProgram(i.glProgram);for(var c=0;c<i.gpuStages.length;c++){var h=i.gpuStages[c];h.glShader&&(n.detachShader(i.glProgram,h.glShader),n.deleteShader(h.glShader),h.glShader=null)}if(!n.getProgramParameter(i.glProgram,n.LINK_STATUS))return console.error("Failed to link shader '"+i.name+"'."),void console.error(n.getProgramInfoLog(i.glProgram));console.info("Shader '"+i.name+"' compilation successed.");var f=n.getProgramParameter(i.glProgram,n.ACTIVE_ATTRIBUTES);i.glInputs=new Array(f);for(var _=0;_<f;++_){var d=n.getActiveAttrib(i.glProgram,_);if(d){var p=void 0,m=d.name.indexOf("[");p=-1!==m?d.name.substr(0,m):d.name;var v=n.getAttribLocation(i.glProgram,p),g=KB(d.type,n),y=ZB(d.type,n);i.glInputs[_]={binding:v,name:p,type:g,stride:y,count:d.size,size:y*d.size,glType:d.type,glLoc:v}}}var b,E,T,S,x,A,w,C,R,k,O=n.getProgramParameter(i.glProgram,n.ACTIVE_UNIFORM_BLOCKS);if(O){i.glBlocks=new Array(O);for(var I=0;I<O;++I){var M=(b=n.getActiveUniformBlockName(i.glProgram,I)).indexOf("[");-1!==M&&(b=b.substr(0,M)),S=-1;for(var L=0;L<i.blocks.length;L++){var P=i.blocks[L];if(P.name===b){S=P.binding;break}}if(S>=0){E=I,T=n.getActiveUniformBlockParameter(i.glProgram,E,n.UNIFORM_BLOCK_DATA_SIZE),x=n.getActiveUniformBlockParameter(i.glProgram,E,n.UNIFORM_BLOCK_ACTIVE_UNIFORMS),n.uniformBlockBinding(i.glProgram,E,S);var B={binding:S,idx:E,name:b,size:T,glUniforms:new Array(x),glActiveUniforms:[],isUniformPackage:!1};i.glBlocks[I]=B,A=n.getActiveUniformBlockParameter(i.glProgram,E,n.UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES),w=new Array(A.length);for(var D=0;D<A.length;++D)w[D]=A[D];C=n.getActiveUniforms(i.glProgram,w,n.UNIFORM_SIZE),R=n.getActiveUniforms(i.glProgram,w,n.UNIFORM_OFFSET);for(var F=0;F<x;++F)if(k=n.getActiveUniform(i.glProgram,A[F])){var N=ZB(k.type,n),z=C[F]*N,U=R[F]/4,G=new Array(z/4);G.fill(0),B.glUniforms[F]={binding:-1,name:k.name,type:KB(k.type,n),stride:N,count:k.size,size:z,offset:R[F],glType:k.type,glLoc:-1,array:G,begin:U}}}}}if(i.samplers.length>0){i.glSamplers=new Array(i.samplers.length);for(var V=0;V<i.samplers.length;++V){var H=i.samplers[V];i.glSamplers[V]={binding:H.binding,name:H.name,type:H.type,units:[],glType:YB(H.type,n),glLoc:-1}}}for(var W=n.getProgramParameter(i.glProgram,n.ACTIVE_UNIFORMS),j=0,X=[],q=0;q<W;++q){var Y=n.getActiveUniform(i.glProgram,q);if(Y){var K=n.getUniformLocation(i.glProgram,Y.name);if(null!==K){var Z=void 0,Q=Y.name.indexOf("[");if(Z=-1!==Q?Y.name.substr(0,Q):Y.name,Y.type===n.SAMPLER_2D||Y.type===n.SAMPLER_CUBE)for(var J=0;J<i.glSamplers.length;J++){var $=i.glSamplers[J];if($.name===Z){for(var ee=0;ee<Y.size;++ee)$.units.push(j+ee);$.glLoc=K,j+=Y.size,X.push($);break}}}}}if(X.length){e.stateCache.glProgram!==i.glProgram&&(n.useProgram(i.glProgram),e.stateCache.glProgram=i.glProgram);for(var te=0;te<X.length;te++){var ie=X[te];n.uniform1iv(ie.glLoc,ie.units)}}}}(this._device,this._gpuShader),this._status=Ks.SUCCESS,!0}},{key:"destroy",value:function(){var e,t;this._gpuShader&&(e=this._device,(t=this._gpuShader).glProgram&&(e.gl.deleteProgram(t.glProgram),t.glProgram=null),this._gpuShader=null),this._status=Ks.UNREADY}}]),n}(rd),CD=function e(){i(this,e),this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glUniformBuffer=null,this.glVAO=null,this.texUnit=0,this.glRenderbuffer=null,this.glFramebuffer=null,this.glReadFramebuffer=null,this.glProgram=null,this.glBindUBOs=new Array(eo),this.glBindUBOs.fill(null),this.glTexUnits=new Array(Js),this.glSamplerUnits=new Array(Js),this.glSamplerUnits.fill(null),this.viewport={left:0,top:0,width:0,height:0,minDepth:0,maxDepth:0},this.scissorRect={x:0,y:0,width:0,height:0},this.rs=new D_,this.dss=new F_,this.bs=new z_,this.glEnabledAttribLocs=new Array(Qs),this.glCurrentAttribLocs=new Array(Qs),this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.fill(!1);for(var t=0;t<Js;++t)this.glTexUnits[t]={glTexture:null}};function RD(e){return e>0&&0==(e&e-1)}var kD=function(e){function t(e){var n;return i(this,t),(n=c(this,o(t).call(this,e)))._gpuTexture=null,n}return s(t,e),r(t,[{key:"gpuTexture",get:function(){return this._gpuTexture}}]),r(t,[{key:"initialize",value:function(e){var t;switch(this._type=e.type,this._usage=e.usage,this._format=e.format,this._width=e.width,this._height=e.height,void 0!==e.depth&&(this._depth=e.depth),void 0!==e.arrayLayer&&(this._arrayLayer=e.arrayLayer),void 0!==e.mipLevel&&(this._mipLevel=e.mipLevel),void 0!==e.samples&&(this._samples=e.samples),void 0!==e.flags&&(this._flags=e.flags),this._isPowerOf2=RD(this._width)&&RD(this._height),this._size=Ho(this._format,this.width,this.height,this.depth,this.mipLevel)*this._arrayLayer,this._flags&So.BAKUP_BUFFER&&(this._buffer=new ArrayBuffer(this._size)),e.type){case bo.TEX1D:t=e.arrayLayer?e.arrayLayer<=1?xo.TV1D:xo.TV1D_ARRAY:xo.TV1D;break;case bo.TEX2D:var i=So.NONE;e.flags&&(i=e.flags),t=e.arrayLayer?e.arrayLayer<=1?xo.TV2D:i&So.CUBEMAP?xo.CUBE:xo.TV2D_ARRAY:xo.TV2D;break;case bo.TEX3D:t=xo.TV3D;break;default:t=xo.TV2D}return this._gpuTexture={type:this._type,viewType:t,format:this._format,usage:this._usage,width:this._width,height:this._height,depth:this._depth,size:this._size,arrayLayer:this._arrayLayer,mipLevel:this._mipLevel,samples:this._samples,flags:this._flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternelFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0},function(e,t){var i=e.gl;t.glInternelFmt=XB(t.format,i),t.glFormat=qB(t.format,i),t.glType=jB(t.format,i);var n=t.width,r=t.height;switch(t.viewType){case xo.TV2D:t.viewType=xo.TV2D,t.glTarget=i.TEXTURE_2D;var a=Math.max(n,r);if(a>e.maxTextureSize&&U(9100,a,e.maxTextureSize),t.samples===To.X1){var s=i.createTexture();if(s&&t.size>0){t.glTexture=s;var o=e.stateCache.glTexUnits[e.stateCache.texUnit];if(o.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_2D,t.glTexture),o.glTexture=t.glTexture),Go[t.format].isCompressed)if(t.glInternelFmt!==ZP.COMPRESSED_RGB_ETC1_WEBGL)for(var l=0;l<t.mipLevel;++l){var u=Vo(t.format,n,r,1),c=new Uint8Array(u);i.compressedTexImage2D(i.TEXTURE_2D,l,t.glInternelFmt,n,r,0,c),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}else{var h=Vo(t.format,2,2,1),f=new Uint8Array(h);i.compressedTexImage2D(i.TEXTURE_2D,0,t.glInternelFmt,2,2,0,f)}else for(var _=0;_<t.mipLevel;++_)i.texImage2D(i.TEXTURE_2D,_,t.glInternelFmt,n,r,0,t.glFormat,t.glType,null),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}}else{var d=i.createRenderbuffer();d&&t.size>0&&(t.glRenderbuffer=d,e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(i.bindRenderbuffer(i.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),i.renderbufferStorageMultisample(i.RENDERBUFFER,HB[t.samples],t.glInternelFmt,t.width,t.height))}break;case xo.CUBE:t.viewType=xo.CUBE,t.glTarget=i.TEXTURE_CUBE_MAP;var p=Math.max(n,r);p>e.maxCubeMapTextureSize&&U(9100,p,e.maxTextureSize);var m=i.createTexture();if(m&&t.size>0){t.glTexture=m;var v=e.stateCache.glTexUnits[e.stateCache.texUnit];if(v.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_CUBE_MAP,t.glTexture),v.glTexture=t.glTexture),Go[t.format].isCompressed)if(t.glInternelFmt!==ZP.COMPRESSED_RGB_ETC1_WEBGL)for(var g=0;g<6;++g){n=t.width,r=t.height;for(var y=0;y<t.mipLevel;++y){var b=Vo(t.format,n,r,1),E=new Uint8Array(b);i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+g,y,t.glInternelFmt,n,r,0,E),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}}else for(var T=0;T<6;++T){var S=Vo(t.format,2,2,1),x=new Uint8Array(S);i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+T,0,t.glInternelFmt,2,2,0,x)}else for(var A=0;A<6;++A){n=t.width,r=t.height;for(var w=0;w<t.mipLevel;++w)i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+A,w,t.glInternelFmt,n,r,0,t.glFormat,t.glType,null),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}}break;default:console.error("Unsupported GFXTextureType, create texture failed."),t.viewType=xo.TV2D,t.glTarget=i.TEXTURE_2D}}(this._device,this._gpuTexture),this._device.memoryStatus.textureSize+=this._size,this._status=Ks.SUCCESS,!0}},{key:"destroy",value:function(){var e,t;this._gpuTexture&&(e=this._device,(t=this._gpuTexture).glTexture&&(e.gl.deleteTexture(t.glTexture),t.glTexture=null),t.glRenderbuffer&&(e.gl.deleteRenderbuffer(t.glRenderbuffer),t.glRenderbuffer=null),this._device.memoryStatus.textureSize-=this._size,this._gpuTexture=null),this._status=Ks.UNREADY,this._buffer=null}},{key:"resize",value:function(e,t){var i=this._size;this._width=e,this._height=t,this._size=Ho(this._format,this.width,this.height,this.depth,this.mipLevel)*this._arrayLayer,this._gpuTexture&&(this._gpuTexture.width=this._width,this._gpuTexture.height=this._height,this._gpuTexture.size=this._size,function(e,t){var i=e.gl;t.glInternelFmt=XB(t.format,i),t.glFormat=qB(t.format,i),t.glType=jB(t.format,i);var n=t.width,r=t.height;switch(t.viewType){case xo.TV2D:t.viewType=xo.TV2D,t.glTarget=i.TEXTURE_2D;var a=Math.max(n,r);if(a>e.maxTextureSize&&U(9100,a,e.maxTextureSize),t.samples===To.X1){var s=e.stateCache.glTexUnits[e.stateCache.texUnit];if(s.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_2D,t.glTexture),s.glTexture=t.glTexture),Go[t.format].isCompressed){if(t.glInternelFmt!==ZP.COMPRESSED_RGB_ETC1_WEBGL)for(var o=0;o<t.mipLevel;++o){var l=Vo(t.format,n,r,1),u=new Uint8Array(l);i.compressedTexImage2D(i.TEXTURE_2D,o,t.glInternelFmt,n,r,0,u),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}}else for(var c=0;c<t.mipLevel;++c)i.texImage2D(i.TEXTURE_2D,c,t.glInternelFmt,n,r,0,t.glFormat,t.glType,null),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}else{var h=i.createRenderbuffer();h&&t.size>0&&(t.glRenderbuffer=h,e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(i.bindRenderbuffer(i.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),i.renderbufferStorageMultisample(i.RENDERBUFFER,HB[t.samples],t.glInternelFmt,t.width,t.height))}break;case xo.CUBE:t.viewType=xo.CUBE,t.glTarget=i.TEXTURE_CUBE_MAP;var f=Math.max(n,r);f>e.maxCubeMapTextureSize&&U(9100,f,e.maxTextureSize);var _=e.stateCache.glTexUnits[e.stateCache.texUnit];if(_.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_CUBE_MAP,t.glTexture),_.glTexture=t.glTexture),Go[t.format].isCompressed){if(t.glInternelFmt!==ZP.COMPRESSED_RGB_ETC1_WEBGL)for(var d=0;d<6;++d){n=t.width,r=t.height;for(var p=0;p<t.mipLevel;++p){var m=Vo(t.format,n,r,1),v=new Uint8Array(m);i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+d,p,t.glInternelFmt,n,r,0,v),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}}}else for(var g=0;g<6;++g){n=t.width,r=t.height;for(var y=0;y<t.mipLevel;++y)i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+g,y,t.glInternelFmt,n,r,0,t.glFormat,t.glType,null),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}break;default:console.error("Unsupported GFXTextureType, create texture failed."),t.viewType=xo.TV2D,t.glTarget=i.TEXTURE_2D}}(this._device,this._gpuTexture),this._device.memoryStatus.textureSize-=i,this._device.memoryStatus.textureSize+=this._size),this._status=Ks.UNREADY}}]),t}(ad),OD=function(e){function t(e){var n;return i(this,t),(n=c(this,o(t).call(this,e)))._gpuTextureView=null,n}return s(t,e),r(t,[{key:"gpuTextureView",get:function(){return this._gpuTextureView}}]),r(t,[{key:"initialize",value:function(e){return this._texture=e.texture,this._type=e.type,this._format=e.format,this._format=e.format,void 0!==e.baseLevel&&(this._baseLevel=e.baseLevel),void 0!==e.levelCount&&(this._levelCount=e.levelCount),void 0!==e.baseLayer&&(this._baseLayer=e.baseLayer),void 0!==e.layerCount&&(this._layerCount=e.layerCount),this._gpuTextureView={gpuTexture:e.texture.gpuTexture,type:e.type,format:e.format,baseLevel:e.baseLevel?e.baseLevel:0,levelCount:e.levelCount?e.levelCount:1},this._status=Ks.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuTextureView=null,this._texture=null,this._status=Ks.UNREADY}}]),t}(B_),ID=function(e){function t(e){return i(this,t),c(this,o(t).call(this,e))}return s(t,e),r(t,[{key:"initialize",value:function(e){void 0!==e.title&&(this._title=e.title),void 0!==e.left&&(this._left=e.left),void 0!==e.top&&(this._top=e.top),void 0!==e.isOffscreen&&(this._isOffscreen=e.isOffscreen),this._width=e.width,this._height=e.height,this._nativeWidth=this._width,this._nativeHeight=this._height,this._colorFmt=e.colorFmt,this._depthStencilFmt=e.depthStencilFmt,this._renderPass=this._device.createRenderPass({colorAttachments:[{format:this._colorFmt,loadOp:Ro.CLEAR,storeOp:ko.STORE,sampleCount:1,beginLayout:Oo.COLOR_ATTACHMENT_OPTIMAL,endLayout:Oo.COLOR_ATTACHMENT_OPTIMAL}],depthStencilAttachment:{format:this._depthStencilFmt,depthLoadOp:Ro.CLEAR,depthStoreOp:ko.STORE,stencilLoadOp:Ro.CLEAR,stencilStoreOp:ko.STORE,sampleCount:1,beginLayout:Oo.DEPTH_STENCIL_ATTACHMENT_OPTIMAL,endLayout:Oo.DEPTH_STENCIL_ATTACHMENT_OPTIMAL}});var t=[];return this._isOffscreen&&(this._colorFmt!==no.UNKNOWN&&(this._colorTex=this._device.createTexture({type:bo.TEX2D,usage:Eo.COLOR_ATTACHMENT|Eo.SAMPLED,format:this._colorFmt,width:this._width,height:this._height,depth:1,arrayLayer:1,mipLevel:1,flags:So.NONE}),this._colorTexView=this._device.createTextureView({texture:this._colorTex,type:xo.TV2D,format:this._colorFmt,baseLevel:0,levelCount:1,baseLayer:0,layerCount:1}),t.push(this._colorTexView)),this._depthStencilFmt!==no.UNKNOWN&&(this._depthStencilTex=this._device.createTexture({type:bo.TEX2D,usage:Eo.DEPTH_STENCIL_ATTACHMENT,format:this._depthStencilFmt,width:this._width,height:this._height,depth:1,arrayLayer:1,mipLevel:1,flags:So.NONE}),this._depthStencilTexView=this._device.createTextureView({texture:this._depthStencilTex,type:xo.TV2D,format:this._depthStencilFmt,baseLevel:0,levelCount:1,baseLayer:0,layerCount:1}))),this._framebuffer=this._device.createFramebuffer({renderPass:this._renderPass,colorViews:t,depthStencilView:this._depthStencilTexView,isOffscreen:this._isOffscreen}),this._status=Ks.SUCCESS,!0}},{key:"destroy",value:function(){this._depthStencilTexView&&(this._depthStencilTexView.destroy(),this._depthStencilTexView=null),this._depthStencilTex&&(this._depthStencilTex.destroy(),this._depthStencilTex=null),this._colorTexView&&(this._colorTexView.destroy(),this._colorTexView=null),this._colorTex&&(this._colorTex.destroy(),this._colorTex=null),this._framebuffer&&(this._framebuffer.destroy(),this._framebuffer=null),this._renderPass&&(this._renderPass.destroy(),this._renderPass=null),this._status=Ks.UNREADY}},{key:"resize",value:function(e,t){this._width=e,this._height=t,(e>this._nativeWidth||t>this._nativeHeight)&&(this._nativeWidth=e,this._nativeHeight=t,this._depthStencilTex&&(this._depthStencilTex.resize(e,t),this._depthStencilTexView.destroy(),this._depthStencilTexView.initialize({texture:this._depthStencilTex,type:xo.TV2D,format:this._depthStencilFmt})),this._colorTex&&(this._colorTex.resize(e,t),this._colorTexView.destroy(),this._colorTexView.initialize({texture:this._colorTex,type:xo.TV2D,format:this._colorFmt})),this._framebuffer&&this._framebuffer.isOffscreen&&(this._framebuffer.destroy(),this._framebuffer.initialize({renderPass:this._renderPass,colorViews:[this._colorTexView],depthStencilView:this._depthStencilTexView})))}}]),t}(ld),MD=function(e){function t(){var e;return i(this,t),(e=c(this,o(t).call(this))).stateCache=new CD,e.nullTex2D=null,e.nullTexCube=null,e._webGL2RC=null,e._isAntialias=!0,e._isPremultipliedAlpha=!0,e._useVAO=!0,e._extensions=null,e._EXT_texture_filter_anisotropic=null,e._OES_texture_float_linear=null,e._OES_texture_half_float_linear=null,e._EXT_color_buffer_float=null,e._EXT_disjoint_timer_query_webgl2=null,e._WEBGL_compressed_texture_etc1=null,e._WEBGL_compressed_texture_etc=null,e._WEBGL_compressed_texture_pvrtc=null,e._WEBGL_compressed_texture_astc=null,e._WEBGL_compressed_texture_s3tc=null,e._WEBGL_compressed_texture_s3tc_srgb=null,e._WEBGL_debug_renderer_info=null,e._WEBGL_texture_storage_multisample=null,e._WEBGL_debug_shaders=null,e._WEBGL_lose_context=null,e}return s(t,e),r(t,[{key:"gl",get:function(){return this._webGL2RC}},{key:"isAntialias",get:function(){return this._isAntialias}},{key:"isPremultipliedAlpha",get:function(){return this._isPremultipliedAlpha}},{key:"useVAO",get:function(){return this._useVAO}},{key:"EXT_texture_filter_anisotropic",get:function(){return this._EXT_texture_filter_anisotropic}},{key:"OES_texture_float_linear",get:function(){return this._OES_texture_float_linear}},{key:"EXT_color_buffer_float",get:function(){return this._EXT_color_buffer_float}},{key:"EXT_disjoint_timer_query_webgl2",get:function(){return this._EXT_disjoint_timer_query_webgl2}},{key:"WEBGL_compressed_texture_etc1",get:function(){return this._WEBGL_compressed_texture_etc1}},{key:"WEBGL_compressed_texture_etc",get:function(){return this._WEBGL_compressed_texture_etc}},{key:"WEBGL_compressed_texture_pvrtc",get:function(){return this._WEBGL_compressed_texture_pvrtc}},{key:"WEBGL_compressed_texture_s3tc",get:function(){return this._WEBGL_compressed_texture_s3tc}},{key:"WEBGL_compressed_texture_s3tc_srgb",get:function(){return this._WEBGL_compressed_texture_s3tc_srgb}}]),r(t,[{key:"initialize",value:function(e){this._canvas=e.canvasElm,this._isAntialias=void 0===e.isAntialias||e.isAntialias,this._isPremultipliedAlpha=void 0===e.isPremultipliedAlpha||e.isPremultipliedAlpha;try{var t={alpha:jS.ENABLE_TRANSPARENT_CANVAS,antialias:this._isAntialias,depth:!0,stencil:!0,premultipliedAlpha:this._isPremultipliedAlpha,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};this._webGL2RC=this._canvas.getContext("webgl2",t)}catch(e){return console.error(e),!1}if(!this._webGL2RC)return console.error("This device does not support WebGL2."),!1;this._canvas2D=document.createElement("canvas"),console.info("WebGL2 device initialized."),this._gfxAPI=Xo.WEBGL2,this._deviceName="WebGL2";var i=this._webGL2RC;this._WEBGL_debug_renderer_info=this.getExtension("WEBGL_debug_renderer_info"),this._WEBGL_debug_renderer_info?(this._renderer=i.getParameter(this._WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=i.getParameter(this._WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=i.getParameter(i.RENDERER),this._vendor=i.getParameter(i.VENDOR)),this._version=i.getParameter(i.VERSION),this._maxVertexAttributes=i.getParameter(i.MAX_VERTEX_ATTRIBS),this._maxVertexUniformVectors=i.getParameter(i.MAX_VERTEX_UNIFORM_VECTORS),this._maxFragmentUniformVectors=i.getParameter(i.MAX_FRAGMENT_UNIFORM_VECTORS),this._maxTextureUnits=i.getParameter(i.MAX_TEXTURE_IMAGE_UNITS),this._maxVertexTextureUnits=i.getParameter(i.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._maxUniformBufferBindings=i.getParameter(i.MAX_UNIFORM_BUFFER_BINDINGS),this._maxUniformBlockSize=i.getParameter(i.MAX_UNIFORM_BLOCK_SIZE),this._maxTextureSize=i.getParameter(i.MAX_TEXTURE_SIZE),this._maxCubeMapTextureSize=i.getParameter(i.MAX_CUBE_MAP_TEXTURE_SIZE),this._depthBits=i.getParameter(i.DEPTH_BITS),this._stencilBits=i.getParameter(i.STENCIL_BITS),this._devicePixelRatio=e.devicePixelRatio||1,this._width=this._canvas.width,this._height=this._canvas.height,this._nativeWidth=Math.max(e.nativeWidth||this._width,0),this._nativeHeight=Math.max(e.nativeHeight||this._height,0),this._colorFmt=no.RGBA8,32===this._depthBits?8===this._stencilBits?this._depthStencilFmt=no.D32F_S8:this._depthStencilFmt=no.D32F:24===this._depthBits?8===this._stencilBits?this._depthStencilFmt=no.D24S8:this._depthStencilFmt=no.D24:8===this._stencilBits?this._depthStencilFmt=no.D16S8:this._depthStencilFmt=no.D16,this._extensions=i.getSupportedExtensions();var n="";if(this._extensions){var r=this._extensions,a=Array.isArray(r),s=0;for(r=a?r:r[Symbol.iterator]();;){var o;if(a){if(s>=r.length)break;o=r[s++]}else{if((s=r.next()).done)break;o=s.value}n+=o+" "}console.debug("EXTENSIONS: "+n)}this._EXT_texture_filter_anisotropic=this.getExtension("EXT_texture_filter_anisotropic"),this._EXT_color_buffer_float=this.getExtension("EXT_color_buffer_float"),this._EXT_disjoint_timer_query_webgl2=this.getExtension("EXT_disjoint_timer_query_webgl2"),this._OES_texture_float_linear=this.getExtension("OES_texture_float_linear"),this._OES_texture_half_float_linear=this.getExtension("OES_texture_half_float_linear"),this._WEBGL_compressed_texture_etc1=this.getExtension("WEBGL_compressed_texture_etc1"),this._WEBGL_compressed_texture_etc=this.getExtension("WEBGL_compressed_texture_etc"),this._WEBGL_compressed_texture_pvrtc=this.getExtension("WEBGL_compressed_texture_pvrtc"),this._WEBGL_compressed_texture_astc=this.getExtension("WEBGL_compressed_texture_astc"),this._WEBGL_compressed_texture_s3tc=this.getExtension("WEBGL_compressed_texture_s3tc"),this._WEBGL_compressed_texture_s3tc_srgb=this.getExtension("WEBGL_compressed_texture_s3tc_srgb"),this._WEBGL_texture_storage_multisample=this.getExtension("WEBGL_texture_storage_multisample"),this._WEBGL_debug_shaders=this.getExtension("WEBGL_debug_shaders"),this._WEBGL_lose_context=this.getExtension("WEBGL_lose_context"),this._features.fill(!1),this._features[qo.TEXTURE_FLOAT]=!0,this._features[qo.TEXTURE_HALF_FLOAT]=!0,this._features[qo.FORMAT_R11G11B10F]=!0,this._features[qo.FORMAT_D24S8]=!0,this._features[qo.FORMAT_ETC2]=!0,this._features[qo.MSAA]=!0,this._features[qo.ELEMENT_INDEX_UINT]=!0,this._EXT_color_buffer_float&&(this._features[qo.COLOR_FLOAT]=!0,this._features[qo.COLOR_HALF_FLOAT]=!0),this._OES_texture_float_linear&&(this._features[qo.TEXTURE_FLOAT_LINEAR]=!0),this._OES_texture_half_float_linear&&(this._features[qo.TEXTURE_HALF_FLOAT_LINEAR]=!0);var l="";this._WEBGL_compressed_texture_etc1&&(this._features[qo.FORMAT_ETC1]=!0,l+="etc1 "),this._WEBGL_compressed_texture_etc&&(this._features[qo.FORMAT_ETC2]=!0,l+="etc2 "),this._WEBGL_compressed_texture_s3tc&&(this._features[qo.FORMAT_DXT]=!0,l+="dxt "),this._WEBGL_compressed_texture_pvrtc&&(this._features[qo.FORMAT_PVRTC]=!0,l+="pvrtc "),this._WEBGL_compressed_texture_astc&&(this._features[qo.FORMAT_ASTC]=!0,l+="astc "),console.info("RENDERER: "+this._renderer),console.info("VENDOR: "+this._vendor),console.info("VERSION: "+this._version),console.info("DPR: "+this._devicePixelRatio),console.info("SCREEN_SIZE: "+this._width+" x "+this._height),console.info("NATIVE_SIZE: "+this._nativeWidth+" x "+this._nativeHeight),console.info("MAX_VERTEX_UNIFORM_VECTORS: "+this._maxVertexUniformVectors),console.info("MAX_UNIFORM_BUFFER_BINDINGS: "+this._maxUniformBufferBindings),console.info("DEPTH_BITS: "+this._depthBits),console.info("STENCIL_BITS: "+this._stencilBits),this._EXT_texture_filter_anisotropic&&console.info("MAX_TEXTURE_MAX_ANISOTROPY_EXT: "+this._EXT_texture_filter_anisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT),console.info("USE_VAO: "+this._useVAO),console.info("COMPRESSED_FORMAT: "+l),this.initStates(i),this._queue=this.createQueue({type:Po.GRAPHICS});var u=this._webGL2RC.canvas;this._mainWindow=this.createWindow({title:u.title||"",left:u.offsetLeft||0,top:u.offsetTop||0,width:this._webGL2RC.drawingBufferWidth,height:this._webGL2RC.drawingBufferHeight,colorFmt:this._colorFmt,depthStencilFmt:this._depthStencilFmt}),this._cmdAllocator=this.createCommandAllocator({}),this.nullTex2D=new kD(this),this.nullTex2D.initialize({type:bo.TEX2D,usage:Eo.SAMPLED,format:no.RGBA8,width:2,height:2,flags:So.GEN_MIPMAP}),this.nullTexCube=new kD(this),this.nullTexCube.initialize({type:bo.TEX2D,usage:Eo.SAMPLED,format:no.RGBA8,width:2,height:2,arrayLayer:6,flags:So.CUBEMAP|So.GEN_MIPMAP});var c={buffOffset:0,buffStride:0,buffTexHeight:0,texOffset:{x:0,y:0,z:0},texExtent:{width:2,height:2,depth:1},texSubres:{baseMipLevel:0,levelCount:1,baseArrayLayer:0,layerCount:1}},h=new Uint8Array(this.nullTex2D.size);return h.fill(0),this.copyBuffersToTexture([h],this.nullTex2D,[c]),c.texSubres.layerCount=6,this.copyBuffersToTexture([h,h,h,h,h,h],this.nullTexCube,[c]),!0}},{key:"destroy",value:function(){this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._mainWindow&&(this._mainWindow.destroy(),this._mainWindow=null),this._cmdAllocator&&(this._cmdAllocator.destroy(),this._cmdAllocator=null),this._queue&&(this._queue.destroy(),this._queue=null),this._webGL2RC=null}},{key:"resize",value:function(e,t){this._width===e&&this._height===t||(console.info("Resizing device: "+e+"x"+t),this._canvas.width=e,this._canvas.height=t,this._width=e,this._height=t)}},{key:"createBuffer",value:function(e){var t=new dD(this);return t.initialize(e),t}},{key:"createTexture",value:function(e){var t=new kD(this);return t.initialize(e),t}},{key:"createTextureView",value:function(e){var t=new OD(this);return t.initialize(e),t}},{key:"createSampler",value:function(e){var t=new AD(this);return t.initialize(e),t}},{key:"createBindingLayout",value:function(e){var t=new GB(this);return t.initialize(e),t}},{key:"createShader",value:function(e){var t=new wD(this);return t.initialize(e),t}},{key:"createInputAssembler",value:function(e){var t=new yD(this);return t.initialize(e),t}},{key:"createRenderPass",value:function(e){var t=new xD(this);return t.initialize(e),t}},{key:"createFramebuffer",value:function(e){var t=new gD(this);return t.initialize(e),t}},{key:"createPipelineLayout",value:function(e){var t=new bD(this);return t.initialize(e),t}},{key:"createPipelineState",value:function(e){var t=new TD(this);return t.initialize(e),t}},{key:"createCommandAllocator",value:function(e){var t=new mD(this);return t.initialize(e),t}},{key:"createCommandBuffer",value:function(e){var t=new vD(this);return t.initialize(e),t}},{key:"createQueue",value:function(e){var t=new SD(this);return t.initialize(e),t}},{key:"createWindow",value:function(e){var t=new ID(this);return t.initialize(e),t}},{key:"present",value:function(){this._cmdAllocator.releaseCmds();var e=this._queue;this._numDrawCalls=e.numDrawCalls,this._numTris=e.numTris,e.clear()}},{key:"copyBuffersToTexture",value:function(e,t,i){_D(this,e,t.gpuTexture,i)}},{key:"copyTexImagesToTexture",value:function(e,t,i){!function(e,t,i,n){var r=e.gl,a=e.stateCache.glTexUnits[e.stateCache.texUnit];a.glTexture!==i.glTexture&&(r.bindTexture(i.glTarget,i.glTexture),a.glTexture=i.glTexture);var s=0,o=0,l=0;switch(i.glTarget){case r.TEXTURE_2D:for(var u=0;u<n.length;u++){var c=n[u];for(s=c.texSubres.baseMipLevel;s<c.texSubres.levelCount;++s)r.texSubImage2D(r.TEXTURE_2D,s,c.texOffset.x,c.texOffset.y,i.glFormat,i.glType,t[o++])}break;case r.TEXTURE_CUBE_MAP:for(var h=0;h<n.length;h++){var f=n[h],_=f.texSubres.baseArrayLayer+f.texSubres.layerCount;for(l=f.texSubres.baseArrayLayer;l<_;++l){var d=f.texSubres.baseMipLevel+f.texSubres.levelCount;for(s=f.texSubres.baseMipLevel;s<d;++s)r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,s,f.texOffset.x,f.texOffset.y,i.glFormat,i.glType,t[o++])}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}i.flags&So.GEN_MIPMAP&&r.generateMipmap(i.glTarget)}(this,e,t.gpuTexture,i)}},{key:"copyFramebufferToBuffer",value:function(e,t,i){var n=this._webGL2RC,r=e.gpuFramebuffer,a=this.stateCache.glFramebuffer;this.stateCache.glFramebuffer!==r.glFramebuffer&&(n.bindFramebuffer(n.FRAMEBUFFER,r.glFramebuffer),this.stateCache.glFramebuffer=r.glFramebuffer);var s=new Uint8Array(t),o=i,l=Array.isArray(o),u=0;for(o=l?o:o[Symbol.iterator]();;){var c;if(l){if(u>=o.length)break;c=o[u++]}else{if((u=o.next()).done)break;c=u.value}var h=c,f=h.buffOffset+h.buffTexHeight*h.buffStride,_=h.texExtent.width,d=h.texExtent.height,p=Vo(no.RGBA8,_,d,1),m=s.subarray(f,f+p);n.readPixels(h.texOffset.x,h.texOffset.y,_,d,n.RGBA,n.UNSIGNED_BYTE,m)}this.stateCache.glFramebuffer!==a&&(n.bindFramebuffer(n.FRAMEBUFFER,a),this.stateCache.glFramebuffer=a)}},{key:"blitFramebuffer",value:function(e,t,i,n,r){!function(e,t,i,n,r,a){var s=e.gl;e.stateCache.glReadFramebuffer!==t.glFramebuffer&&(s.bindFramebuffer(s.READ_FRAMEBUFFER,t.glFramebuffer),e.stateCache.glReadFramebuffer=t.glFramebuffer);var o=i.glFramebuffer!==e.stateCache.glFramebuffer;o&&s.bindFramebuffer(s.DRAW_FRAMEBUFFER,i.glFramebuffer);var l=0;t.gpuColorViews.length>0&&(l|=s.COLOR_BUFFER_BIT),t.gpuDepthStencilView&&(l|=s.DEPTH_BUFFER_BIT,Go[t.gpuDepthStencilView.format].hasStencil&&(l|=s.STENCIL_BUFFER_BIT));var u=a===go.LINEAR||a===go.ANISOTROPIC?s.LINEAR:s.NEAREST;s.blitFramebuffer(n.x,n.y,n.x+n.width,n.y+n.height,r.x,r.y,r.x+r.width,r.y+r.height,l,u),o&&s.bindFramebuffer(s.FRAMEBUFFER,e.stateCache.glFramebuffer)}(this,e.gpuFramebuffer,t.gpuFramebuffer,i,n,r)}},{key:"getExtension",value:function(e){for(var t=["","WEBKIT_","MOZ_"],i=0;i<t.length;++i){var n=this._webGL2RC.getExtension(t[i]+e);if(n)return n}return null}},{key:"initStates",value:function(e){e.activeTexture(e.TEXTURE0),e.pixelStorei(e.PACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,0),e.bindFramebuffer(e.FRAMEBUFFER,null),e.enable(e.CULL_FACE),e.cullFace(e.BACK),e.frontFace(e.CCW),e.polygonOffset(0,0),e.enable(e.DEPTH_TEST),e.depthMask(!0),e.depthFunc(e.LESS),e.stencilFuncSeparate(e.FRONT,e.ALWAYS,1,65535),e.stencilOpSeparate(e.FRONT,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.FRONT,65535),e.stencilFuncSeparate(e.BACK,e.ALWAYS,1,65535),e.stencilOpSeparate(e.BACK,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.BACK,65535),e.disable(e.STENCIL_TEST),e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.disable(e.BLEND),e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ONE,e.ZERO,e.ONE,e.ZERO),e.colorMask(!0,!0,!0,!0),e.blendColor(0,0,0,0)}}]),t}(Ko);cc.WebGL2GFXDevice=MD;var LD,PD,BD,DD,FD,ND,zD,UD,GD,VD,HD,WD,jD,XD,qD,YD,KD,ZD,QD,JD,$D,eF,tF,iF,nF,rF,aF,sF,oF,lF,uF,cF,hF,fF,_F,dF,pF,mF,vF,gF=new zi,yF=new Bn;function bF(e,t,i,n){var r=i.datas,a=t.currBufferBatch,s=a.byteOffset>>2,o=i.vertexCount,l=a.indiceOffset,u=a.vertexOffset;a.request(o,i.indiceCount)||(a=t.currBufferBatch,o=0,l=0,u=0);var c=a.vData,h=a.iData;e.getWorldMatrix(yF);for(var f=0;f<o;f++){var _=r[f];zi.set(gF,_.x,_.y,0),zi.transformMat4(gF,gF,yF),c[s++]=gF.x,c[s++]=gF.y,c[s++]=gF.z,c[s++]=_.u,c[s++]=_.v,rr.toArray(c,n,s),s+=4}for(var d=0,p=o/4;d<p;d++){var m=u+4*d;h[l++]=m,h[l++]=m+1,h[l++]=m+2,h[l++]=m+1,h[l++]=m+3,h[l++]=m+2}}!function(e){e[e.NONE=0]="NONE",e[e.COLOR=1]="COLOR",e[e.SPRITE=2]="SPRITE",e[e.SCALE=3]="SCALE"}(pF||(pF={})),pt(pF),function(e){e.NORMAL="normal",e.HOVER="hover",e.PRESSED="pressed",e.DISABLED="disabled"}(mF||(mF={})),function(e){e.CLICK="click"}(vF||(vF={}));var EF=e("ButtonComponent",(LD=Es("cc.ButtonComponent"),PD=Rs(110),BD=Cs("UI/Button"),DD=ws(Lf),FD=Ts({displayOrder:1,tooltip:""}),ND=Ts({type:pF,displayOrder:2,tooltip:""}),zD=Ts({tooltip:""}),UD=Ts({tooltip:""}),GD=Ts({tooltip:""}),VD=Ts({tooltip:""}),HD=Ts({min:0,max:10,tooltip:""}),WD=Ts({tooltip:" Button  scale * zoomScale"}),jD=Ts({type:Yc,tooltip:""}),XD=Ts({type:Yc,tooltip:""}),qD=Ts({type:Yc,tooltip:""}),YD=Ts({type:Yc,tooltip:""}),KD=Ts({type:o_,displayOrder:0,tooltip:" Button Button  Color  Sprite "}),ZD=Ts({type:[gR],displayOrder:3,tooltip:"1"}),LD(QD=PD(QD=BD(QD=DD((dF=_F=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),s=0;s<r;s++)a[s]=arguments[s];return m(n=c(this,(e=o(t)).call.apply(e,[this].concat(a))),"clickEvents",$D,u(n)),m(n,"_interactable",eF,u(n)),m(n,"_transition",tF,u(n)),m(n,"_normalColor",iF,u(n)),m(n,"_hoverColor",nF,u(n)),m(n,"_pressColor",rF,u(n)),m(n,"_disabledColor",aF,u(n)),m(n,"_normalSprite",sF,u(n)),m(n,"_hoverSprite",oF,u(n)),m(n,"_pressedSprite",lF,u(n)),m(n,"_disabledSprite",uF,u(n)),m(n,"_duration",cF,u(n)),m(n,"_zoomScale",hF,u(n)),m(n,"_target",fF,u(n)),n._pressed=!1,n._hovered=!1,n._fromColor=new rr,n._toColor=new rr,n._time=0,n._transitionFinished=!0,n._fromScale=new zi,n._toScale=new zi,n._originalScale=new zi,n._sprite=null,n._targetScale=new zi,n}return s(t,e),r(t,[{key:"__preload",value:function(){this.target||(this.target=this.node);var e=this.node.getComponent(zC);e&&(this._normalSprite=e.spriteFrame),this._applyTarget(),this._updateState()}},{key:"onEnable",value:function(){this._registerEvent()}},{key:"onDisable",value:function(){this._resetState(),this.node.off(Kc.TOUCH_START,this._onTouchBegan,this),this.node.off(Kc.TOUCH_MOVE,this._onTouchMove,this),this.node.off(Kc.TOUCH_END,this._onTouchEnded,this),this.node.off(Kc.TOUCH_CANCEL,this._onTouchCancel,this),this.node.off(Kc.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.off(Kc.MOUSE_LEAVE,this._onMouseMoveOut,this)}},{key:"update",value:function(e){var t=this._target?this._target:this.node;if(!this._transitionFinished&&(this._transition===pF.COLOR||this._transition===pF.SCALE)){this._time+=e;var i=1;this._duration>0&&(i=this._time/this._duration),i>=1&&(i=1,this._transitionFinished=!0);var n=t.getComponent(OC);n&&(this._transition===pF.COLOR?rr.lerp(n.color,this._fromColor,this._toColor,i):this.transition===pF.SCALE&&(t.getScale(this._targetScale),this._targetScale.x=pi(this._fromScale.x,this._toScale.x,i),this._targetScale.y=pi(this._fromScale.y,this._toScale.y,i),t.setScale(this._targetScale)))}}},{key:"_resizeNodeToTargetNode",value:function(){0}},{key:"_resetState",value:function(){this._pressed=!1,this._hovered=!1;var e=this._target;if(e){var t=e.getComponent(OC);if(t){var i=this._transition;i===pF.COLOR&&this._interactable?t.color=this._normalColor:i===pF.SCALE&&e.setScale(this._originalScale),this._transitionFinished=!0}}}},{key:"_registerEvent",value:function(){this.node.on(Kc.TOUCH_START,this._onTouchBegan,this),this.node.on(Kc.TOUCH_MOVE,this._onTouchMove,this),this.node.on(Kc.TOUCH_END,this._onTouchEnded,this),this.node.on(Kc.TOUCH_CANCEL,this._onTouchCancel,this),this.node.on(Kc.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.on(Kc.MOUSE_LEAVE,this._onMouseMoveOut,this)}},{key:"_getTargetSprite",value:function(e){var t=null;return e&&(t=e.getComponent(zC)),t}},{key:"_applyTarget",value:function(){this._sprite=this._getTargetSprite(this._target),this._target&&zi.copy(this._originalScale,this._target.getScale())}},{key:"_onTouchBegan",value:function(e){this._interactable&&this.enabledInHierarchy&&(this._pressed=!0,this._updateState(),e&&(e.propagationStopped=!0))}},{key:"_onTouchMove",value:function(e){if(this._interactable&&this.enabledInHierarchy&&this._pressed){if(!e)return!1;var t=e.touch;if(!t)return!1;var i,n=this.node._uiProps.uiTransformComp.isHit(t.getUILocation());if(this._transition===pF.SCALE&&this._target)n?(zi.copy(this._fromScale,this._originalScale),zi.multiplyScalar(this._toScale,this._originalScale,this._zoomScale),this._transitionFinished=!1):(this._time=0,this._transitionFinished=!0,this._target&&this._target.setScale(this._originalScale));else i=n?mF.PRESSED:mF.NORMAL,this._applyTransition(i);e&&(e.propagationStopped=!0)}}},{key:"_onTouchEnded",value:function(e){this._interactable&&this.enabledInHierarchy&&(this._pressed&&(gR.emitEvents(this.clickEvents,e),this.node.emit(vF.CLICK,this)),this._pressed=!1,this._updateState(),e&&(e.propagationStopped=!0))}},{key:"_onTouchCancel",value:function(e){this._interactable&&this.enabledInHierarchy&&(this._pressed=!1,this._updateState())}},{key:"_onMouseMoveIn",value:function(e){!this._pressed&&this.interactable&&this.enabledInHierarchy&&(this._transition!==pF.SPRITE||this._hoverSprite)&&(this._hovered||(this._hovered=!0,this._updateState()))}},{key:"_onMouseMoveOut",value:function(e){this._hovered&&(this._hovered=!1,this._updateState())}},{key:"_updateState",value:function(){var e=this._getButtonState();this._applyTransition(e)}},{key:"_getButtonState",value:function(){var e=mF.NORMAL;return this._interactable?this._pressed?e=mF.PRESSED:this._hovered&&(e=mF.HOVER):e=mF.DISABLED,e.toString()}},{key:"_updateColorTransition",value:function(e){var t=this[e+"Color"],i=this._target;if(i){var n=i.getComponent(OC);n&&(e===mF.DISABLED?n.color=t:(this._fromColor=n.color.clone(),this._toColor=t,this._time=0,this._transitionFinished=!1))}}},{key:"_updateSpriteTransition",value:function(e){var t=this[e+"Sprite"];this._sprite&&t&&(this._sprite.spriteFrame=t)}},{key:"_updateScaleTransition",value:function(e){this._interactable&&(e===mF.PRESSED?this._zoomUp():this._zoomBack())}},{key:"_zoomUp",value:function(){zi.copy(this._fromScale,this._originalScale),zi.multiplyScalar(this._toScale,this._originalScale,this._zoomScale),this._time=0,this._transitionFinished=!1}},{key:"_zoomBack",value:function(){this._target&&(zi.copy(this._fromScale,this._target.getScale()),zi.copy(this._toScale,this._originalScale),this._time=0,this._transitionFinished=!1)}},{key:"_applyTransition",value:function(e){var t=this._transition;t===pF.COLOR?this._updateColorTransition(e):t===pF.SPRITE?this._updateSpriteTransition(e):t===pF.SCALE&&this._updateScaleTransition(e)}},{key:"interactable",get:function(){return this._interactable},set:function(e){this._interactable=e,this._updateState(),this._interactable||this._resetState()}},{key:"_resizeToTarget",set:function(e){e&&this._resizeNodeToTargetNode()}},{key:"transition",get:function(){return this._transition},set:function(e){this._transition!==e&&(this._transition=e)}},{key:"normalColor",get:function(){return this._normalColor},set:function(e){this._normalColor!==e&&(this._normalColor.set(e),this._updateState())}},{key:"pressedColor",get:function(){return this._pressColor},set:function(e){this._pressColor!==e&&this._pressColor.set(e)}},{key:"hoverColor",get:function(){return this._hoverColor},set:function(e){this._hoverColor!==e&&this._hoverColor.set(e)}},{key:"disabledColor",get:function(){return this._disabledColor},set:function(e){this._disabledColor!==e&&(this._disabledColor.set(e),this._updateState())}},{key:"duration",get:function(){return this._duration},set:function(e){this._duration!==e&&(this._duration=e)}},{key:"zoomScale",get:function(){return this._zoomScale},set:function(e){this._zoomScale!==e&&(this._zoomScale=e)}},{key:"normalSprite",get:function(){return this._normalSprite},set:function(e){if(this._normalSprite!==e){this._normalSprite=e;var t=this.node.getComponent(zC);t&&(t.spriteFrame=e),this._updateState()}}},{key:"pressedSprite",get:function(){return this._pressedSprite},set:function(e){this._pressedSprite!==e&&(this._pressedSprite=e,this._updateState())}},{key:"hoverSprite",get:function(){return this._hoverSprite},set:function(e){this._hoverSprite!==e&&(this._hoverSprite=e,this._updateState())}},{key:"disabledSprite",get:function(){return this._disabledSprite},set:function(e){this._disabledSprite!==e&&(this._disabledSprite=e,this._updateState())}},{key:"target",get:function(){return this._target},set:function(e){this._target!==e&&(this._target=e,this._applyTarget())}}]),t}(Ph),_F.Transition=pF,_F.EventType=vF,v((JD=dF).prototype,"interactable",[FD],Object.getOwnPropertyDescriptor(JD.prototype,"interactable"),JD.prototype),v(JD.prototype,"transition",[ND],Object.getOwnPropertyDescriptor(JD.prototype,"transition"),JD.prototype),v(JD.prototype,"normalColor",[zD],Object.getOwnPropertyDescriptor(JD.prototype,"normalColor"),JD.prototype),v(JD.prototype,"pressedColor",[UD],Object.getOwnPropertyDescriptor(JD.prototype,"pressedColor"),JD.prototype),v(JD.prototype,"hoverColor",[GD],Object.getOwnPropertyDescriptor(JD.prototype,"hoverColor"),JD.prototype),v(JD.prototype,"disabledColor",[VD],Object.getOwnPropertyDescriptor(JD.prototype,"disabledColor"),JD.prototype),v(JD.prototype,"duration",[HD],Object.getOwnPropertyDescriptor(JD.prototype,"duration"),JD.prototype),v(JD.prototype,"zoomScale",[WD],Object.getOwnPropertyDescriptor(JD.prototype,"zoomScale"),JD.prototype),v(JD.prototype,"normalSprite",[jD],Object.getOwnPropertyDescriptor(JD.prototype,"normalSprite"),JD.prototype),v(JD.prototype,"pressedSprite",[XD],Object.getOwnPropertyDescriptor(JD.prototype,"pressedSprite"),JD.prototype),v(JD.prototype,"hoverSprite",[qD],Object.getOwnPropertyDescriptor(JD.prototype,"hoverSprite"),JD.prototype),v(JD.prototype,"disabledSprite",[YD],Object.getOwnPropertyDescriptor(JD.prototype,"disabledSprite"),JD.prototype),v(JD.prototype,"target",[KD],Object.getOwnPropertyDescriptor(JD.prototype,"target"),JD.prototype),$D=v(JD.prototype,"clickEvents",[ZD],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),eF=v(JD.prototype,"_interactable",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),tF=v(JD.prototype,"_transition",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return pF.NONE}}),iF=v(JD.prototype,"_normalColor",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rr(214,214,214,255)}}),nF=v(JD.prototype,"_hoverColor",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rr(211,211,211,255)}}),rF=v(JD.prototype,"_pressColor",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return rr.WHITE.clone()}}),aF=v(JD.prototype,"_disabledColor",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rr(124,124,124,255)}}),sF=v(JD.prototype,"_normalSprite",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),oF=v(JD.prototype,"_hoverSprite",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lF=v(JD.prototype,"_pressedSprite",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),uF=v(JD.prototype,"_disabledSprite",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),cF=v(JD.prototype,"_duration",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),hF=v(JD.prototype,"_zoomScale",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.2}}),fF=v(JD.prototype,"_target",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),QD=JD))||QD)||QD)||QD)||QD));cc.ButtonComponent=EF;var TF,SF,xF,AF,wF,CF,RF,kF,OF,IF,MF,LF,PF,BF,DF,FF,NF,zF,UF,GF,VF,HF,WF,jF,XF,qF,YF,KF,ZF,QF,JF,$F,eN,tN,iN,nN,rN,aN,sN,oN,lN,uN,cN=e("CanvasPool",function(){function e(){i(this,e),this.pool=[]}return r(e,[{key:"get",value:function(){var e=this.pool.pop();if(!e){var t=document.createElement("canvas"),i=t.getContext("2d");e={canvas:t,context:i}}return e}},{key:"put",value:function(e){this.pool.length>=32||this.pool.push(e)}}]),e}());!function(e){e[e.LEFT=0]="LEFT",e[e.CENTER=1]="CENTER",e[e.RIGHT=2]="RIGHT"}(sN||(sN=e("HorizontalTextAlignment",{}))),pt(sN),function(e){e[e.TOP=0]="TOP",e[e.CENTER=1]="CENTER",e[e.BOTTOM=2]="BOTTOM"}(oN||(oN=e("VerticalTextAlignment",{}))),pt(oN),function(e){e[e.NONE=0]="NONE",e[e.CLAMP=1]="CLAMP",e[e.SHRINK=2]="SHRINK",e[e.RESIZE_HEIGHT=3]="RESIZE_HEIGHT"}(lN||(lN=e("Overflow",{}))),pt(lN),function(e){e[e.NONE=0]="NONE",e[e.BITMAP=1]="BITMAP",e[e.CHAR=2]="CHAR"}(uN||(uN={})),pt(uN);var hN=e("LabelComponent",(TF=Es("cc.LabelComponent"),SF=Rs(110),xF=Cs("UI/Render/Label"),AF=Ts({displayOrder:4,multiline:!0,tooltip:"Label "}),wF=Ts({type:sN,displayOrder:5,tooltip:""}),CF=Ts({type:oN,displayOrder:6,tooltip:""}),RF=Ts({readonly:!0,displayName:"Actual Font Size",visible:!1}),kF=Ts({displayOrder:7,tooltip:" point "}),OF=Ts({displayOrder:8,tooltip:""}),IF=Ts({displayOrder:8,tooltip:" point "}),MF=Ts({type:lN,displayOrder:9,tooltip:"\n 1. CLAMP:  \n 2. SHRINK: \n 3. RESIZE_HEIGHT:  height ."}),LF=Ts({displayOrder:10,tooltip:""}),PF=Ts({type:yg,displayOrder:11,tooltip:"Label "}),BF=Ts({displayOrder:12,tooltip:""}),DF=Ts({type:uN,displayOrder:13,tooltip:"\n 1. NONE:  \n 2. BITMAP:  \n 3. CHAR: "}),FF=Ts({displayOrder:15,tooltip:""}),NF=Ts({displayOrder:16,tooltip:""}),zF=Ts({displayOrder:17,tooltip:""}),TF(UF=SF(UF=xF((aN=rN=function(e){function t(){var e;return i(this,t),m(e=c(this,o(t).call(this)),"_useOriginalSize",VF,u(e)),m(e,"_string",HF,u(e)),m(e,"_horizontalAlign",WF,u(e)),m(e,"_verticalAlign",jF,u(e)),m(e,"_actualFontSize",XF,u(e)),m(e,"_fontSize",qF,u(e)),m(e,"_fontFamily",YF,u(e)),m(e,"_lineHeight",KF,u(e)),m(e,"_overflow",ZF,u(e)),m(e,"_enableWrapText",QF,u(e)),m(e,"_font",JF,u(e)),m(e,"_isSystemFontUsed",$F,u(e)),e._spacingX=0,m(e,"_isItalic",eN,u(e)),m(e,"_isBold",tN,u(e)),m(e,"_isUnderline",iN,u(e)),m(e,"_cacheMode",nN,u(e)),e._N$file=null,e._texture=null,e._ttfSpriteFrame=null,e._userDefinedFont=null,e._assemblerData=null,e._fontAtlas=null,e._letterTexture=null,e._ttfSpriteFrame=null,e}return s(t,e),r(t,[{key:"string",get:function(){return this._string},set:function(e){e=e.toString(),this._string!==e&&(this._string=e,this.updateRenderData())}},{key:"horizontalAlign",get:function(){return this._horizontalAlign},set:function(e){this._horizontalAlign!==e&&(this._horizontalAlign=e,this.updateRenderData())}},{key:"verticalAlign",get:function(){return this._verticalAlign},set:function(e){this._verticalAlign!==e&&(this._verticalAlign=e,this.updateRenderData())}},{key:"actualFontSize",get:function(){return this._actualFontSize},set:function(e){this._actualFontSize=e}},{key:"fontSize",get:function(){return this._fontSize},set:function(e){this._fontSize!==e&&(this._fontSize=e,this.updateRenderData())}},{key:"fontFamily",get:function(){return this._fontFamily},set:function(e){this._fontFamily!==e&&(this._fontFamily=e,this.updateRenderData())}},{key:"lineHeight",get:function(){return this._lineHeight},set:function(e){this._lineHeight!==e&&(this._lineHeight=e,this.updateRenderData())}},{key:"overflow",get:function(){return this._overflow},set:function(e){this._overflow!==e&&(this._overflow=e,this.updateRenderData())}},{key:"enableWrapText",get:function(){return this._enableWrapText},set:function(e){this._enableWrapText!==e&&(this._enableWrapText=e,this.updateRenderData())}},{key:"font",get:function(){return this._font},set:function(e){this._font!==e&&(this._isSystemFontUsed=!e,this._font=e,"string"==typeof e&&N(4e3),this._renderData&&(this.destroyRenderData(),this._renderData=null),this._fontAtlas=null,this.updateRenderData(!0))}},{key:"useSystemFont",get:function(){return this._isSystemFontUsed},set:function(e){this._isSystemFontUsed!==e&&(this.destroyRenderData(),this._renderData=null,this._isSystemFontUsed=!!e,e&&(this.font=null,this._flushAssembler(),this.updateRenderData()))}},{key:"cacheMode",get:function(){return this._cacheMode},set:function(e){this._cacheMode!==e&&(this._cacheMode===uN.CHAR&&(this._ttfSpriteFrame=null),this._cacheMode=e,this.updateRenderData(!0))}},{key:"spriteFrame",get:function(){return this._texture}},{key:"isBold",get:function(){return this._isBold},set:function(e){this._isBold!==e&&(this._isBold=e,this.updateRenderData())}},{key:"isItalic",get:function(){return this._isItalic},set:function(e){this._isItalic!==e&&(this._isItalic=e,this.updateRenderData())}},{key:"isUnderline",get:function(){return this._isUnderline},set:function(e){this._isUnderline!==e&&(this._isUnderline=e,this.updateRenderData())}},{key:"assemblerData",get:function(){return this._assemblerData}},{key:"fontAtlas",get:function(){return this._fontAtlas},set:function(e){this._fontAtlas=e}},{key:"spacingX",get:function(){return this._spacingX},set:function(e){this._spacingX!==e&&(this._spacingX=e,this.updateRenderData())}},{key:"_bmFontOriginalSize",get:function(){return this._font instanceof Og?this._font.fontSize:-1}}]),r(t,[{key:"onEnable",value:function(){f(o(t.prototype),"onEnable",this).call(this),this._font||this._isSystemFontUsed||(this.useSystemFont=!0),this._isSystemFontUsed&&!this._fontFamily&&(this.fontFamily="Arial"),this.updateRenderData(!0)}},{key:"onDisable",value:function(){f(o(t.prototype),"onDisable",this).call(this)}},{key:"onDestroy",value:function(){if(this._assembler&&this._assembler.resetAssemblerData&&this._assembler.resetAssemblerData(this._assemblerData),this._assemblerData=null,this._ttfSpriteFrame){var e=this._ttfSpriteFrame.texture;if(e){var i=e;i.image&&i.image.destroy(),e.destroy()}this._ttfSpriteFrame=null}this._letterTexture=null,f(o(t.prototype),"onDestroy",this).call(this)}},{key:"updateRenderData",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.markForUpdateRenderData(),e&&(this._flushAssembler(),this._applyFontTexture(e))}},{key:"_render",value:function(e){e.commitComp(this,this._texture.getGFXTextureView(),this._assembler)}},{key:"_updateColor",value:function(){this._font instanceof Og?f(o(t.prototype),"_updateColor",this).call(this):this.updateRenderData(!1)}},{key:"_canRender",value:function(){if(!f(o(t.prototype),"_canRender",this).call(this)||!this._string)return!1;var e=this._font;if(e&&e instanceof Og){var i=e.spriteFrame;if(!i||!i.textureLoaded())return!1}return!0}},{key:"_flushAssembler",value:function(){var e=t.Assembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this._material)}},{key:"_flushMaterial",value:function(){this._updateMaterial(this._material)}},{key:"_applyFontTexture",value:function(e){var t=this,i=this._font;if(i instanceof Og){var n=i.spriteFrame,r=this;n&&n.loaded&&(r._texture=n,r._flushMaterial(),e&&t._renderFlag&&t._assembler&&t._renderData&&t._assembler.updateRenderData(t))}else{if(this.cacheMode===uN.CHAR&&Il.browserType!==Il.BROWSER_TYPE_WECHAT_GAME_SUB)this._letterTexture=this._assembler.getAssemblerData(),this._texture=this._letterTexture;else if(!this._ttfSpriteFrame){this._ttfSpriteFrame=new Yc,this._assemblerData=this._assembler.getAssemblerData();var a=new Ju(this._assemblerData.canvas)._texture;this._ttfSpriteFrame.texture=a}this.cacheMode!==uN.CHAR&&(this._texture=this._ttfSpriteFrame),this._flushMaterial()}e&&this._renderFlag&&this._assembler&&this._renderData&&this._assembler.updateRenderData(this)}}]),t}(OC),rN.HorizontalAlign=sN,rN.VerticalAlign=oN,rN.Overflow=lN,rN.CacheMode=uN,rN._canvasPool=new cN,v((GF=aN).prototype,"string",[AF],Object.getOwnPropertyDescriptor(GF.prototype,"string"),GF.prototype),v(GF.prototype,"horizontalAlign",[wF],Object.getOwnPropertyDescriptor(GF.prototype,"horizontalAlign"),GF.prototype),v(GF.prototype,"verticalAlign",[CF],Object.getOwnPropertyDescriptor(GF.prototype,"verticalAlign"),GF.prototype),v(GF.prototype,"actualFontSize",[RF],Object.getOwnPropertyDescriptor(GF.prototype,"actualFontSize"),GF.prototype),v(GF.prototype,"fontSize",[kF],Object.getOwnPropertyDescriptor(GF.prototype,"fontSize"),GF.prototype),v(GF.prototype,"fontFamily",[OF],Object.getOwnPropertyDescriptor(GF.prototype,"fontFamily"),GF.prototype),v(GF.prototype,"lineHeight",[IF],Object.getOwnPropertyDescriptor(GF.prototype,"lineHeight"),GF.prototype),v(GF.prototype,"overflow",[MF],Object.getOwnPropertyDescriptor(GF.prototype,"overflow"),GF.prototype),v(GF.prototype,"enableWrapText",[LF],Object.getOwnPropertyDescriptor(GF.prototype,"enableWrapText"),GF.prototype),v(GF.prototype,"font",[PF],Object.getOwnPropertyDescriptor(GF.prototype,"font"),GF.prototype),v(GF.prototype,"useSystemFont",[BF],Object.getOwnPropertyDescriptor(GF.prototype,"useSystemFont"),GF.prototype),v(GF.prototype,"cacheMode",[DF],Object.getOwnPropertyDescriptor(GF.prototype,"cacheMode"),GF.prototype),v(GF.prototype,"isBold",[FF],Object.getOwnPropertyDescriptor(GF.prototype,"isBold"),GF.prototype),v(GF.prototype,"isItalic",[NF],Object.getOwnPropertyDescriptor(GF.prototype,"isItalic"),GF.prototype),v(GF.prototype,"isUnderline",[zF],Object.getOwnPropertyDescriptor(GF.prototype,"isUnderline"),GF.prototype),VF=v(GF.prototype,"_useOriginalSize",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),HF=v(GF.prototype,"_string",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"label"}}),WF=v(GF.prototype,"_horizontalAlign",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return sN.CENTER}}),jF=v(GF.prototype,"_verticalAlign",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return oN.CENTER}}),XF=v(GF.prototype,"_actualFontSize",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),qF=v(GF.prototype,"_fontSize",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),YF=v(GF.prototype,"_fontFamily",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"Arial"}}),KF=v(GF.prototype,"_lineHeight",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),ZF=v(GF.prototype,"_overflow",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return lN.NONE}}),QF=v(GF.prototype,"_enableWrapText",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),JF=v(GF.prototype,"_font",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),$F=v(GF.prototype,"_isSystemFontUsed",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),eN=v(GF.prototype,"_isItalic",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),tN=v(GF.prototype,"_isBold",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),iN=v(GF.prototype,"_isUnderline",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),nN=v(GF.prototype,"_cacheMode",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return uN.NONE}}),UF=GF))||UF)||UF)||UF));cc.LabelComponent=hN;var fN,_N,dN,pN=function(){function e(){i(this,e)}return r(e,null,[{key:"add",value:function(e){var t=this._tabIndexList;-1===t.indexOf(e)&&t.push(e)}},{key:"remove",value:function(e){var t=this._tabIndexList,i=t.indexOf(e);-1!==i&&t.splice(i,1)}},{key:"resort",value:function(){this._tabIndexList.sort((function(e,t){return e._delegate.tabIndex-t._delegate.tabIndex}))}},{key:"next",value:function(e){var t=this._tabIndexList,i=t.indexOf(e);if(e.setFocus(!1),-1!==i){var n=t[i+1];n&&n._delegate.tabIndex>=0&&n.setFocus(!0)}}}]),e}();pN._tabIndexList=[],function(e){e[e.DEFAULT=0]="DEFAULT",e[e.DONE=1]="DONE",e[e.SEND=2]="SEND",e[e.SEARCH=3]="SEARCH",e[e.GO=4]="GO",e[e.NEXT=5]="NEXT"}(fN||(fN={})),dt(fN),function(e){e[e.ANY=0]="ANY",e[e.EMAIL_ADDR=1]="EMAIL_ADDR",e[e.NUMERIC=2]="NUMERIC",e[e.PHONE_NUMBER=3]="PHONE_NUMBER",e[e.URL=4]="URL",e[e.DECIMAL=5]="DECIMAL",e[e.SINGLE_LINE=6]="SINGLE_LINE"}(_N||(_N={})),dt(_N),function(e){e[e.PASSWORD=0]="PASSWORD",e[e.SENSITIVE=1]="SENSITIVE",e[e.INITIAL_CAPS_WORD=2]="INITIAL_CAPS_WORD",e[e.INITIAL_CAPS_SENTENCE=3]="INITIAL_CAPS_SENTENCE",e[e.INITIAL_CAPS_ALL_CHARACTERS=4]="INITIAL_CAPS_ALL_CHARACTERS",e[e.DEFAULT=5]="DEFAULT"}(dN||(dN={})),dt(dN);var mN=function(){function e(){i(this,e),this._editing=!1,this._delegate=null}return r(e,[{key:"init",value:function(e){}},{key:"onEnable",value:function(){}},{key:"update",value:function(){}},{key:"onDisable",value:function(){this._editing&&this.endEditing()}},{key:"clear",value:function(){this._delegate=null}},{key:"setTabIndex",value:function(e){}},{key:"setSize",value:function(e,t){}},{key:"setFocus",value:function(e){e?this.beginEditing():this.endEditing()}},{key:"isFocused",value:function(){return this._editing}},{key:"beginEditing",value:function(){}},{key:"endEditing",value:function(){}}]),e}(),vN=new Bn,gN=new Bn,yN=new zi,bN=null,EN=0,TN={zoomInvalid:!1};Il.OS_ANDROID!==Il.os||Il.browserType!==Il.BROWSER_TYPE_SOUGOU&&Il.browserType!==Il.BROWSER_TYPE_360||(TN.zoomInvalid=!0);var SN,xN,AN,wN,CN,RN,kN,ON,IN,MN,LN,PN,BN,DN,FN,NN,zN,UN,GN,VN,HN,WN,jN,XN,qN,YN,KN,ZN,QN,JN,$N,ez,tz,iz,nz,rz,az,sz,oz,lz,uz,cz,hz=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),s=0;s<r;s++)a[s]=arguments[s];return(n=c(this,(e=o(t)).call.apply(e,[this].concat(a))))._delegate=null,n._inputMode=_N.ANY,n._inputFlag=dN.DEFAULT,n._returnType=fN.DEFAULT,n._maxLength=50,n._placeholderText="",n._alwaysOnTop=!1,n._size=new Xn,n._node=null,n._editing=!1,n.__eventListeners={},n.__fullscreen=!1,n.__autoResize=!1,n.__rotateScreen=!1,n._edTxt=null,n._textColor=rr.WHITE.clone(),n._edFontSize=14,n._isTextArea=!1,n._textLabelFont=null,n._textLabelFontSize=null,n._textLabelFontColor=null,n._textLabelAlign=null,n._placeholderLabelFont=null,n._placeholderLabelFontSize=null,n._placeholderLabelFontColor=null,n._placeholderLabelAlign=null,n._placeholderLineHeight=null,n._placeholderStyleSheet=null,n._domId="EditBoxId_".concat(++EN),n}return s(t,e),r(t,[{key:"init",value:function(e){e&&(this._delegate=e,e.inputMode===_N.ANY?this._createTextArea():this._createInput(),pN.add(this),this.setTabIndex(e.tabIndex),this._initStyleSheet(),this._registerEventListeners(),this._addDomToGameContainer(),this.__fullscreen=qx.isAutoFullScreenEnabled(),this.__autoResize=qx._resizeWithBrowserSize)}},{key:"onEnable",value:function(){}},{key:"onDisable",value:function(){this._editing&&this._edTxt&&this._edTxt.blur()}},{key:"clear",value:function(){this._removeEventListeners(),this._removeDomFromGameContainer(),pN.remove(this),bN===this&&(bN=null),this._delegate=null}},{key:"update",value:function(){this._updateMatrix()}},{key:"setTabIndex",value:function(e){this._edTxt.tabIndex=e,pN.resort()}},{key:"setSize",value:function(e,t){var i=this._edTxt;i&&(i.style.width=e+"px",i.style.height=t+"px")}},{key:"setFocus",value:function(e){e?this.beginEditing():this._edTxt.blur()}},{key:"isFocused",value:function(){return this._editing}},{key:"beginEditing",value:function(){bN&&bN!==this&&bN.setFocus(!1),this._editing=!0,bN=this,this._showDom(),this._edTxt&&this._delegate&&(this._edTxt.focus(),this._delegate._editBoxEditingDidBegan())}},{key:"endEditing",value:function(){}},{key:"_createInput",value:function(){this._isTextArea=!1,this._edTxt=document.createElement("input")}},{key:"_createTextArea",value:function(){this._isTextArea=!0,this._edTxt=document.createElement("textarea")}},{key:"_addDomToGameContainer",value:function(){zx.container&&this._edTxt&&(zx.container.appendChild(this._edTxt),document.head.appendChild(this._placeholderStyleSheet))}},{key:"_removeDomFromGameContainer",value:function(){ot(zx.container,this._edTxt)&&this._edTxt&&zx.container.removeChild(this._edTxt),ot(document.head,this._placeholderStyleSheet)&&document.head.removeChild(this._placeholderStyleSheet),delete this._edTxt,delete this._placeholderStyleSheet}},{key:"_showDom",value:function(){this._updateMaxLength(),this._updateInputType(),this._updateStyleSheet(),this._edTxt&&this._delegate&&(this._edTxt.style.display="",this._delegate._hideLabels()),Il.isMobile&&this._showDomOnMobile()}},{key:"_hideDom",value:function(){var e=this._edTxt;e&&this._delegate&&(e.style.display="none",this._delegate._showLabels()),Il.isMobile&&this._hideDomOnMobile()}},{key:"_showDomOnMobile",value:function(){Il.os===Il.OS_ANDROID&&(this.__fullscreen&&(qx.enableAutoFullScreen(!1),lA.exitFullScreen()),this.__autoResize&&qx.resizeWithBrowserSize(!1),this._adjustWindowScroll())}},{key:"_hideDomOnMobile",value:function(){var e=this;Il.os===Il.OS_ANDROID&&setTimeout((function(){bN||(e.__fullscreen&&qx.enableAutoFullScreen(!0),e.__autoResize&&qx.resizeWithBrowserSize(!0))}),400),this._scrollBackWindow()}},{key:"_adjustWindowScroll",value:function(){var e=this;setTimeout((function(){window.scrollY<40&&e._edTxt.scrollIntoView({block:"start",inline:"nearest",behavior:"smooth"})}),400)}},{key:"_scrollBackWindow",value:function(){setTimeout((function(){Il.browserType!==Il.BROWSER_TYPE_WECHAT||Il.os!==Il.OS_IOS?window.scrollTo(0,0):window.top&&window.top.scrollTo(0,0)}),400)}},{key:"_updateMatrix",value:function(){if(this._edTxt){var e=this._delegate.node,t=qx.getScaleX(),i=qx.getScaleY(),n=qx.getViewportRect(),r=qx.getDevicePixelRatio();e.getWorldMatrix(vN);var a=e._uiProps.uiTransformComp;if(a&&zi.set(yN,-a.anchorX*a.width,-a.anchorY*a.height,yN.z),Bn.transform(vN,vN,yN),!e._uiProps.uiTransformComp)return!1;var s=vR.root.ui.getScreen(e._uiProps.uiTransformComp.visibility);if(s){s.node.getWorldRT(gN);var o=gN.m12,l=gN.m13,u=qS.center;gN.m12=u.x-(gN.m00*o+gN.m04*l),gN.m13=u.y-(gN.m01*o+gN.m05*l),Bn.multiply(gN,gN,vN),t/=r,i/=r;var c=zx.container,h=gN.m00*t,f=vN.m01,_=vN.m04,d=gN.m05*i,p=parseInt(c&&c.style.paddingLeft||"0");p+=n.x/r;var m=parseInt(c&&c.style.paddingBottom||"0");m+=n.y/r;var v=gN.m12*t+p,g=gN.m13*i+m;TN.zoomInvalid&&(this.setSize(this._size.width*h,this._size.height*d),h=1,d=1);var y="matrix("+h+","+-f+","+-_+","+d+","+v+","+-g+")";this._edTxt.style.transform=y,this._edTxt.style["-webkit-transform"]=y,this._edTxt.style["transform-origin"]="0px 100% 0px",this._edTxt.style["-webkit-transform-origin"]="0px 100% 0px"}}}},{key:"_updateInputType",value:function(){var e=this._delegate,t=e.inputMode,i=e.inputFlag,n=e.returnType,r=this._edTxt;if(this._inputMode!==t||this._inputFlag!==i||this._returnType!==n){if(this._inputMode=t,this._inputFlag=i,this._returnType=n,this._isTextArea){var a="none";return i===dN.INITIAL_CAPS_ALL_CHARACTERS?a="uppercase":i===dN.INITIAL_CAPS_WORD&&(a="capitalize"),void(r.style.textTransform=a)}if(r=r,i!==dN.PASSWORD){var s=r.type;t===_N.EMAIL_ADDR?s="email":t===_N.NUMERIC||t===_N.DECIMAL?s="number":t===_N.PHONE_NUMBER?(s="number",r.pattern="[0-9]*"):t===_N.URL?s="url":(s="text",n===fN.SEARCH&&(s="search")),r.type=s;var o="none";i===dN.INITIAL_CAPS_ALL_CHARACTERS?o="uppercase":i===dN.INITIAL_CAPS_WORD&&(o="capitalize"),r.style.textTransform=o}else r.type="password"}}},{key:"_updateMaxLength",value:function(){var e=this._delegate.maxLength;e<0&&(e=65535),this._edTxt.maxLength=e}},{key:"_initStyleSheet",value:function(){if(this._edTxt){var e=this._edTxt;e.style.fontSize=this._edFontSize+"px",e.style.color="#000000",e.style.border="0px",e.style.background="transparent",e.style.width="100%",e.style.height="100%",e.style.outline="medium",e.style.padding="0",e.style.textTransform="uppercase",e.style.display="none",e.style.position="absolute",e.style.bottom="0px",e.style.left="2px",e.className="cocosEditBox",e.style.fontFamily="Arial",e.id=this._domId,this._isTextArea?(e.style.resize="none",e.style.overflowY="scroll"):((e=e).type="text",e.style["-moz-appearance"]="textfield"),this._placeholderStyleSheet=document.createElement("style")}}},{key:"_updateStyleSheet",value:function(){var e=this._delegate,t=this._edTxt;t&&e&&(t.value=e.string,t.placeholder=e.placeholder,this._updateTextLabel(e.textLabel),this._updatePlaceholderLabel(e.placeholderLabel))}},{key:"_updateTextLabel",value:function(e){if(e){var t=e.font;if(t=!t||t instanceof Og?e.fontFamily:t._fontFamily,(this._textLabelFont!==t||this._textLabelFontSize!==e.fontSize||this._textLabelFontColor!==e.fontColor||this._textLabelAlign!==e.horizontalAlign)&&(this._textLabelFont=t,this._textLabelFontSize=e.fontSize,this._textLabelFontColor=e.fontColor,this._textLabelAlign=e.horizontalAlign,this._edTxt)){var i=this._edTxt;switch(i.style.fontSize="".concat(e.fontSize,"px"),i.style.color=e.color.toCSS("rgba"),i.style.fontFamily=t,e.horizontalAlign){case hN.HorizontalAlign.LEFT:i.style.textAlign="left";break;case hN.HorizontalAlign.CENTER:i.style.textAlign="center";break;case hN.HorizontalAlign.RIGHT:i.style.textAlign="right"}}}}},{key:"_updatePlaceholderLabel",value:function(e){if(e){var t=e.font;if(t=!t||t instanceof Og?e.fontFamily:e.font._fontFamily,this._placeholderLabelFont!==t||this._placeholderLabelFontSize!==e.fontSize||this._placeholderLabelFontColor!==e.fontColor||this._placeholderLabelAlign!==e.horizontalAlign||this._placeholderLineHeight!==e.fontSize){this._placeholderLabelFont=t,this._placeholderLabelFontSize=e.fontSize,this._placeholderLabelFontColor=e.fontColor,this._placeholderLabelAlign=e.horizontalAlign,this._placeholderLineHeight=e.fontSize;var i=this._placeholderStyleSheet,n=e.fontSize,r=e.color.toCSS("rgba"),a=e.fontSize,s="";switch(e.horizontalAlign){case hN.HorizontalAlign.LEFT:s="left";break;case hN.HorizontalAlign.CENTER:s="center";break;case hN.HorizontalAlign.RIGHT:s="right"}i.innerHTML="\n            #".concat(this._domId,"::-webkit-input-placeholder {\n                text-transform: initial;\n                font-family: ").concat(t,";\n                font-size: ").concat(n,"px;\n                color: ").concat(r,";\n                line-height: ").concat(a,"px;\n                text-align: ").concat(s,";\n            }\n            #").concat(this._domId,"::-moz-placeholder {\n                text-transform: initial;\n                font-family: ").concat(t,";\n                font-size: ").concat(n,"px;\n                color: ").concat(r,";\n                line-height: ").concat(a,"px;\n                text-align: ").concat(s,";\n            }\n            #").concat(this._domId,":-ms-input-placeholder {\n                text-transform: initial;\n                font-family: ").concat(t,";\n                font-size: ").concat(n,"px;\n                color: ").concat(r,";\n                line-height: ").concat(a,"px;\n                text-align: ").concat(s,";\n            }\n        ")}}}},{key:"_registerEventListeners",value:function(){if(this._edTxt){var e=this,t=this._edTxt,i=!1,n=this.__eventListeners;n.compositionStart=function(){i=!0},n.compositionEnd=function(){i=!1,e._delegate._editBoxTextChanged(t.value)},n.onInput=function(){i||e._delegate._editBoxTextChanged(t.value)},n.onClick=function(){e._editing&&Il.isMobile&&e._adjustWindowScroll()},n.onKeydown=function(i){i.keyCode===jS.KEY.enter?(i.propagationStopped=!0,e._delegate._editBoxEditingReturn(),e._isTextArea||t.blur()):i.keyCode===jS.KEY.tab&&(i.propagationStopped=!0,i.preventDefault(),pN.next(e))},n.onBlur=function(){e._editing=!1,bN=null,e._hideDom(),e._delegate._editBoxEditingDidEnded()},t.addEventListener("compositionstart",n.compositionStart),t.addEventListener("compositionend",n.compositionEnd),t.addEventListener("input",n.onInput),t.addEventListener("keydown",n.onKeydown),t.addEventListener("blur",n.onBlur),t.addEventListener("touchstart",n.onClick)}}},{key:"_removeEventListeners",value:function(){if(this._edTxt){var e=this._edTxt,t=this.__eventListeners;e.removeEventListener("compositionstart",t.compositionStart),e.removeEventListener("compositionend",t.compositionEnd),e.removeEventListener("input",t.onInput),e.removeEventListener("keydown",t.onKeydown),e.removeEventListener("blur",t.onBlur),e.removeEventListener("touchstart",t.onClick),t.compositionStart=null,t.compositionEnd=null,t.onInput=null,t.onKeydown=null,t.onBlur=null,t.onClick=null}}}]),t}(mN);function fz(e){return e.replace(/(?:^|\s)\S/g,(function(e){return e.toUpperCase()}))}function _z(e){return e.charAt(0).toUpperCase()+e.slice(1)}!function(e){e.EDITING_DID_BEGAN="editing-did-began",e.EDITING_DID_ENDED="editing-did-ended",e.TEXT_CHANGED="text-changed",e.EDITING_RETURN="editing-return"}(cz||(cz={}));var dz,pz,mz,vz,gz,yz,bz,Ez,Tz,Sz,xz,Az,wz,Cz,Rz,kz,Oz,Iz,Mz,Lz,Pz,Bz,Dz,Fz,Nz,zz,Uz,Gz,Vz,Hz,Wz,jz,Xz,qz,Yz,Kz,Zz=e("EditBoxComponent",(SN=Es("cc.EditBoxComponent"),xN=Rs(100),AN=Cs("UI/EditBox"),wN=Ts({tooltip:""}),CN=Ts({tooltip:" Label ",type:hN}),RN=Ts({tooltip:" Label ",type:hN}),kN=Ts({type:Yc,tooltip:""}),ON=Ts({type:fN,tooltip:""}),IN=Ts({type:dN,tooltip:""}),MN=Ts({type:_N,tooltip:": ANY "}),LN=Ts({tooltip:""}),PN=Ts({tooltip:""}),BN=Ts({type:rr,tooltip:""}),DN=Ts({tooltip:""}),FN=Ts({tooltip:""}),NN=Ts({tooltip:""}),zN=Ts({tooltip:""}),UN=Ts({tooltip:" Web "}),GN=Ts({tooltip:" DOM  tabIndex Web "}),VN=Ts({type:[gR],tooltip:""}),HN=Ts({type:[gR],tooltip:""}),WN=Ts({type:[gR],tooltip:" "}),jN=Ts({type:[gR],tooltip:", "}),SN(XN=xN(XN=AN(XN=As((uz=lz=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),s=0;s<r;s++)a[s]=arguments[s];return m(n=c(this,(e=o(t)).call.apply(e,[this].concat(a))),"editingDidBegan",YN,u(n)),m(n,"textChanged",KN,u(n)),m(n,"editingDidEnded",ZN,u(n)),m(n,"editingReturn",QN,u(n)),n._impl=null,n._background=null,m(n,"_textLabel",JN,u(n)),m(n,"_placeholderLabel",$N,u(n)),m(n,"_returnType",ez,u(n)),m(n,"_useOriginalSize",tz,u(n)),m(n,"_string",iz,u(n)),m(n,"_tabIndex",nz,u(n)),m(n,"_backgroundImage",rz,u(n)),m(n,"_inputFlag",az,u(n)),m(n,"_inputMode",sz,u(n)),m(n,"_maxLength",oz,u(n)),n._isLabelVisible=!1,n}return s(t,e),r(t,[{key:"__preload",value:function(){this._init()}},{key:"onEnable",value:function(){this._registerEvent(),this._impl&&this._impl.onEnable()}},{key:"update",value:function(){this._impl&&this._impl.update()}},{key:"onDisable",value:function(){this._unregisterEvent(),this._impl&&this._impl.onDisable()}},{key:"onDestroy",value:function(){this._impl&&this._impl.clear()}},{key:"setFocus",value:function(){this._impl&&this._impl.setFocus(!0)}},{key:"focus",value:function(){this._impl&&this._impl.setFocus(!0)}},{key:"blur",value:function(){this._impl&&this._impl.setFocus(!1)}},{key:"isFocused",value:function(){return!!this._impl&&this._impl.isFocused()}},{key:"_editBoxEditingDidBegan",value:function(){gR.emitEvents(this.editingDidBegan,this),this.node.emit(cz.EDITING_DID_BEGAN,this)}},{key:"_editBoxEditingDidEnded",value:function(){gR.emitEvents(this.editingDidEnded,this),this.node.emit(cz.EDITING_DID_ENDED,this)}},{key:"_editBoxTextChanged",value:function(e){e=this._updateLabelStringStyle(e,!0),this.string=e,gR.emitEvents(this.textChanged,e,this),this.node.emit(cz.TEXT_CHANGED,this)}},{key:"_editBoxEditingReturn",value:function(){gR.emitEvents(this.editingReturn,this),this.node.emit(cz.EDITING_RETURN,this)}},{key:"_showLabels",value:function(){this._isLabelVisible=!0,this._updateLabels()}},{key:"_hideLabels",value:function(){this._isLabelVisible=!1,this._textLabel&&(this._textLabel.node.active=!1),this._placeholderLabel&&(this._placeholderLabel.node.active=!1)}},{key:"_onTouchBegan",value:function(e){e.propagationStopped=!0}},{key:"_onTouchCancel",value:function(e){e.propagationStopped=!0}},{key:"_onTouchEnded",value:function(e){this._impl&&this._impl.beginEditing(),e.propagationStopped=!0}},{key:"_init",value:function(){this._createBackgroundSprite(),this._updatePlaceholderLabel(),this._updateTextLabel(),this._isLabelVisible=!0,this.node.on(Kc.SIZE_CHANGED,this._resizeChildNodes,this),(this._impl=new t._EditBoxImpl).init(this),this._updateString(this._string),this._syncSize()}},{key:"_createBackgroundSprite",value:function(){this._background||(this._background=this.node.getComponent(zC),this._background||(this._background=this.node.addComponent(zC))),this._background.type=zC.Type.SLICED,this._background.spriteFrame=this._backgroundImage}},{key:"_updateTextLabel",value:function(){var e=this._textLabel;if(!e){var t=this.node.getChildByName("TEXT_LABEL");t||(t=new o_("TEXT_LABEL")),(e=t.getComponent(hN))||(e=t.addComponent(hN)),t.parent=this.node,this._textLabel=e}this._textLabel.node._uiProps.uiTransformComp.setAnchorPoint(0,1),e.overflow=hN.Overflow.CLAMP,this._inputMode===_N.ANY?(e.verticalAlign=oN.TOP,e.enableWrapText=!0):(e.verticalAlign=oN.CENTER,e.enableWrapText=!1),e.string=this._updateLabelStringStyle(this._string)}},{key:"_updatePlaceholderLabel",value:function(){var e=this._placeholderLabel;if(!e){var t=this.node.getChildByName("PLACEHOLDER_LABEL");t||(t=new o_("PLACEHOLDER_LABEL")),(e=t.getComponent(hN))||(e=t.addComponent(hN)),t.parent=this.node,this._placeholderLabel=e}this._placeholderLabel.node._uiProps.uiTransformComp.setAnchorPoint(0,1),e.overflow=hN.Overflow.CLAMP,this._inputMode===_N.ANY?(e.verticalAlign=oN.TOP,e.enableWrapText=!0):(e.verticalAlign=oN.CENTER,e.enableWrapText=!1),e.string=this.placeholder}},{key:"_syncSize",value:function(){var e=this.node.getContentSize();this._background&&(this._background.node._uiProps.uiTransformComp.anchorPoint=this.node._uiProps.uiTransformComp.anchorPoint,this._background.node.setContentSize(e)),this._updateLabelPosition(e),this._impl&&this._impl.setSize(e.width,e.height)}},{key:"_updateLabels",value:function(){if(this._isLabelVisible){var e=this._string;this._textLabel&&(this._textLabel.node.active=""!==e),this._placeholderLabel&&(this._placeholderLabel.node.active=""===e)}}},{key:"_updateString",value:function(e){var t=this._textLabel;if(t){var i=e;i&&(i=this._updateLabelStringStyle(i)),t.string=i,this._updateLabels()}}},{key:"_updateLabelStringStyle",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=this._inputFlag;if(t||i!==dN.PASSWORD)i===dN.INITIAL_CAPS_ALL_CHARACTERS?e=e.toUpperCase():i===dN.INITIAL_CAPS_WORD?e=fz(e):i===dN.INITIAL_CAPS_SENTENCE&&(e=_z(e));else{for(var n="",r=e.length,a=0;a<r;++a)n+="";e=n}return e}},{key:"_registerEvent",value:function(){this.node.on(Kc.TOUCH_START,this._onTouchBegan,this),this.node.on(Kc.TOUCH_END,this._onTouchEnded,this)}},{key:"_unregisterEvent",value:function(){this.node.off(Kc.TOUCH_START,this._onTouchBegan,this),this.node.off(Kc.TOUCH_END,this._onTouchEnded,this)}},{key:"_updateLabelPosition",value:function(e){var t=this.node,i=-t.anchorX*t.width,n=-t.anchorY*t.height,r=this._placeholderLabel,a=this._textLabel;a&&(a.node.setContentSize(e.width-2,e.height),a.node.position=new zi(i+2,n+e.height,a.node.position.z),a.verticalAlign=this._inputMode===_N.ANY?oN.TOP:oN.CENTER,a.enableWrapText=this._inputMode===_N.ANY),r&&(r.node.setContentSize(e.width-2,e.height),r.lineHeight=e.height,r.node.position=new zi(i+2,n+e.height,r.node.position.z),r.verticalAlign=this._inputMode===_N.ANY?oN.TOP:oN.CENTER,r.enableWrapText=this._inputMode===_N.ANY)}},{key:"_resizeChildNodes",value:function(){var e=this._textLabel&&this._textLabel.node;e&&(e.position=new zi(-this.node.width/2,this.node.height/2,e.position.z),e.width=this.node.width,e.height=this.node.height);var t=this._placeholderLabel&&this._placeholderLabel.node;t&&(t.position=new zi(-this.node.width/2,this.node.height/2,t.position.z),t.width=this.node.width,t.height=this.node.height);var i=this._background&&this._background.node;i&&(i.width=this.node.width,i.height=this.node.height)}},{key:"string",get:function(){return this._string},set:function(e){this._maxLength>=0&&e.length>=this._maxLength&&(e=e.slice(0,this._maxLength)),this._string=e,this._updateString(e)}},{key:"textLabel",get:function(){return this._textLabel},set:function(e){this._textLabel!==e&&(this._textLabel=e,this._textLabel&&(this._updateTextLabel(),this._updateLabels()))}},{key:"placeholderLabel",get:function(){return this._placeholderLabel},set:function(e){this._placeholderLabel!==e&&(this._placeholderLabel=e,this._placeholderLabel&&(this._updatePlaceholderLabel(),this._updateLabels()))}},{key:"backgroundImage",get:function(){return this._backgroundImage},set:function(e){this._backgroundImage!==e&&(this._backgroundImage=e,this._createBackgroundSprite())}},{key:"returnType",get:function(){return this._returnType},set:function(e){this._returnType=e}},{key:"inputFlag",get:function(){return this._inputFlag},set:function(e){this._inputFlag=e,this._updateString(this._string)}},{key:"inputMode",get:function(){return this._inputMode},set:function(e){this._inputMode!==e&&(this._inputMode=e,this._updateTextLabel(),this._updatePlaceholderLabel())}},{key:"fontSize",get:function(){return this._textLabel?this._textLabel.fontSize:20},set:function(e){this._textLabel&&(this._textLabel.fontSize=e)}},{key:"lineHeight",get:function(){return this._textLabel?this._textLabel.lineHeight:40},set:function(e){this._textLabel&&(this._textLabel.lineHeight=e)}},{key:"fontColor",get:function(){return this._textLabel?this._textLabel.color:rr.WHITE.clone()},set:function(e){this._textLabel&&(this._textLabel.color=e)}},{key:"placeholder",get:function(){return this._placeholderLabel?this._placeholderLabel.string:""},set:function(e){this._placeholderLabel&&(this._placeholderLabel.string=e)}},{key:"placeholderFontSize",get:function(){return this._placeholderLabel?this._placeholderLabel.fontSize:20},set:function(e){this._placeholderLabel&&(this._placeholderLabel.fontSize=e)}},{key:"placeholderFontColor",get:function(){return this._placeholderLabel?this._placeholderLabel.color:rr.GRAY.clone()},set:function(e){this._placeholderLabel&&(this._placeholderLabel.color=e)}},{key:"maxLength",get:function(){return this._maxLength},set:function(e){this._maxLength=e}},{key:"stayOnTop",get:function(){},set:function(e){console.warn("stayOnTop is removed.")}},{key:"tabIndex",get:function(){return this._tabIndex},set:function(e){this._tabIndex!==e&&(this._tabIndex=e,this._impl&&this._impl.setTabIndex(e))}}]),t}(Ph),lz._EditBoxImpl=mN,lz.KeyboardReturnType=fN,lz.InputFlag=dN,lz.InputMode=_N,lz.EventType=cz,v((qN=uz).prototype,"string",[wN],Object.getOwnPropertyDescriptor(qN.prototype,"string"),qN.prototype),v(qN.prototype,"textLabel",[CN],Object.getOwnPropertyDescriptor(qN.prototype,"textLabel"),qN.prototype),v(qN.prototype,"placeholderLabel",[RN],Object.getOwnPropertyDescriptor(qN.prototype,"placeholderLabel"),qN.prototype),v(qN.prototype,"backgroundImage",[kN],Object.getOwnPropertyDescriptor(qN.prototype,"backgroundImage"),qN.prototype),v(qN.prototype,"returnType",[ON],Object.getOwnPropertyDescriptor(qN.prototype,"returnType"),qN.prototype),v(qN.prototype,"inputFlag",[IN],Object.getOwnPropertyDescriptor(qN.prototype,"inputFlag"),qN.prototype),v(qN.prototype,"inputMode",[MN],Object.getOwnPropertyDescriptor(qN.prototype,"inputMode"),qN.prototype),v(qN.prototype,"fontSize",[LN],Object.getOwnPropertyDescriptor(qN.prototype,"fontSize"),qN.prototype),v(qN.prototype,"lineHeight",[PN],Object.getOwnPropertyDescriptor(qN.prototype,"lineHeight"),qN.prototype),v(qN.prototype,"fontColor",[BN],Object.getOwnPropertyDescriptor(qN.prototype,"fontColor"),qN.prototype),v(qN.prototype,"placeholder",[DN],Object.getOwnPropertyDescriptor(qN.prototype,"placeholder"),qN.prototype),v(qN.prototype,"placeholderFontSize",[FN],Object.getOwnPropertyDescriptor(qN.prototype,"placeholderFontSize"),qN.prototype),v(qN.prototype,"placeholderFontColor",[NN],Object.getOwnPropertyDescriptor(qN.prototype,"placeholderFontColor"),qN.prototype),v(qN.prototype,"maxLength",[zN],Object.getOwnPropertyDescriptor(qN.prototype,"maxLength"),qN.prototype),v(qN.prototype,"stayOnTop",[UN],Object.getOwnPropertyDescriptor(qN.prototype,"stayOnTop"),qN.prototype),v(qN.prototype,"tabIndex",[GN],Object.getOwnPropertyDescriptor(qN.prototype,"tabIndex"),qN.prototype),YN=v(qN.prototype,"editingDidBegan",[VN],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),KN=v(qN.prototype,"textChanged",[HN],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ZN=v(qN.prototype,"editingDidEnded",[WN],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),QN=v(qN.prototype,"editingReturn",[jN],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),JN=v(qN.prototype,"_textLabel",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),$N=v(qN.prototype,"_placeholderLabel",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ez=v(qN.prototype,"_returnType",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fN.DEFAULT}}),tz=v(qN.prototype,"_useOriginalSize",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),iz=v(qN.prototype,"_string",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),nz=v(qN.prototype,"_tabIndex",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),rz=v(qN.prototype,"_backgroundImage",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),az=v(qN.prototype,"_inputFlag",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return dN.DEFAULT}}),sz=v(qN.prototype,"_inputMode",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _N.ANY}}),oz=v(qN.prototype,"_maxLength",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 20}}),XN=qN))||XN)||XN)||XN)||XN));Il.isBrowser&&(Zz._EditBoxImpl=hz),cc.EditBoxComponent=Zz;var Qz,Jz,$z,eU,tU,iU=Kc;!function(e){e[e.NONE=0]="NONE",e[e.HORIZONTAL=1]="HORIZONTAL",e[e.VERTICAL=2]="VERTICAL",e[e.GRID=3]="GRID"}(Qz||(Qz={})),pt(Qz),function(e){e[e.NONE=0]="NONE",e[e.CONTAINER=1]="CONTAINER",e[e.CHILDREN=2]="CHILDREN"}(Jz||(Jz={})),pt(Jz),function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL"}($z||($z={})),pt($z),function(e){e[e.BOTTOM_TO_TOP=0]="BOTTOM_TO_TOP",e[e.TOP_TO_BOTTOM=1]="TOP_TO_BOTTOM"}(eU||(eU={})),pt(eU),function(e){e[e.LEFT_TO_RIGHT=0]="LEFT_TO_RIGHT",e[e.RIGHT_TO_LEFT=1]="RIGHT_TO_LEFT"}(tU||(tU={})),pt(tU);var nU,rU,aU,sU,oU,lU,uU,cU,hU,fU,_U,dU,pU,mU,vU,gU,yU,bU,EU,TU,SU,xU,AU=new zi,wU=new zi,CU=e("LayoutComponent",(dz=Es("cc.LayoutComponent"),pz=Rs(110),mz=Cs("UI/Layout"),vz=ws(Lf),gz=Ts({type:Qz,tooltip:"\n 1. NONE \n 2. HORIZONTAL \n 3. VERTICAL\n 4. GRID, "}),yz=Ts({type:Jz,tooltip:"\n 1. NONE \n 2. CONTAINER,  \n 3. CHILDREN, "}),bz=Ts({tooltip:" GRID "}),Ez=Ts({type:$z,tooltip:" GRID "}),Tz=Ts({tooltip:""}),Sz=Ts({tooltip:""}),xz=Ts({tooltip:""}),Az=Ts({tooltip:""}),wz=Ts({tooltip:""}),Cz=Ts({tooltip:""}),Rz=Ts({type:eU,tooltip:""}),kz=Ts({type:tU,tooltip:""}),Oz=Ts({tooltip:""}),Iz=Ts({tooltip:""}),dz(Mz=pz(Mz=mz(Mz=vz(Mz=As((Kz=Yz=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),s=0;s<r;s++)a[s]=arguments[s];return m(n=c(this,(e=o(t)).call.apply(e,[this].concat(a))),"_resizeMode",Pz,u(n)),m(n,"_N$layoutType",Bz,u(n)),m(n,"_N$padding",Dz,u(n)),m(n,"_cellSize",Fz,u(n)),m(n,"_startAxis",Nz,u(n)),m(n,"_paddingLeft",zz,u(n)),m(n,"_paddingRight",Uz,u(n)),m(n,"_paddingTop",Gz,u(n)),m(n,"_paddingBottom",Vz,u(n)),m(n,"_spacingX",Hz,u(n)),m(n,"_spacingY",Wz,u(n)),m(n,"_verticalDirection",jz,u(n)),m(n,"_horizontalDirection",Xz,u(n)),m(n,"_affectedByScale",qz,u(n)),n._layoutSize=new Xn(300,200),n._layoutDirty=!0,n._isAlign=!1,n}return s(t,e),r(t,[{key:"updateLayout",value:function(){this._layoutDirty&&this.node.children.length>0&&(this._doLayout(),this._layoutDirty=!1)}},{key:"onEnable",value:function(){this._addEventListeners(),this.node.getContentSize().equals(new Xn)&&this.node.setContentSize(this._layoutSize),0!==this._N$padding&&this._migratePaddingData(),this._doLayoutDirty()}},{key:"onDisable",value:function(){this._removeEventListeners()}},{key:"_migratePaddingData",value:function(){this._paddingLeft=this._N$padding,this._paddingRight=this._N$padding,this._paddingTop=this._N$padding,this._paddingBottom=this._N$padding,this._N$padding=0}},{key:"_addEventListeners",value:function(){vR.on(sR.EVENT_AFTER_UPDATE,this.updateLayout,this),this.node.on(iU.SIZE_CHANGED,this._resized,this),this.node.on(iU.ANCHOR_CHANGED,this._doLayoutDirty,this),this.node.on(iU.CHILD_ADDED,this._childAdded,this),this.node.on(iU.CHILD_REMOVED,this._childRemoved,this),this._addChildrenEventListeners()}},{key:"_removeEventListeners",value:function(){vR.off(sR.EVENT_AFTER_UPDATE,this.updateLayout,this),this.node.off(iU.SIZE_CHANGED,this._resized,this),this.node.off(iU.ANCHOR_CHANGED,this._doLayoutDirty,this),this.node.off(iU.CHILD_ADDED,this._childAdded,this),this.node.off(iU.CHILD_REMOVED,this._childRemoved,this),this._removeChildrenEventListeners()}},{key:"_addChildrenEventListeners",value:function(){var e=this.node.children,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n;r.on(iU.TRANSFORM_CHANGED,this._doScaleDirty,this),r.on(iU.SIZE_CHANGED,this._doLayoutDirty,this),r.on(iU.TRANSFORM_CHANGED,this._transformDirty,this),r.on(iU.ANCHOR_CHANGED,this._doLayoutDirty,this),r.on("active-in-hierarchy-changed",this._doLayoutDirty,this)}}},{key:"_removeChildrenEventListeners",value:function(){var e=this.node.children,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n;r.off(iU.TRANSFORM_CHANGED,this._doScaleDirty,this),r.off(iU.SIZE_CHANGED,this._doLayoutDirty,this),r.off(iU.TRANSFORM_CHANGED,this._transformDirty,this),r.off(iU.ANCHOR_CHANGED,this._doLayoutDirty,this),r.off("active-in-hierarchy-changed",this._doLayoutDirty,this)}}},{key:"_childAdded",value:function(e){e.on(iU.TRANSFORM_CHANGED,this._doScaleDirty,this),e.on(iU.SIZE_CHANGED,this._doLayoutDirty,this),e.on(iU.TRANSFORM_CHANGED,this._transformDirty,this),e.on(iU.ANCHOR_CHANGED,this._doLayoutDirty,this),e.on("active-in-hierarchy-changed",this._doLayoutDirty,this),this._doLayoutDirty()}},{key:"_childRemoved",value:function(e){e.off(iU.TRANSFORM_CHANGED,this._doScaleDirty,this),e.off(iU.SIZE_CHANGED,this._doLayoutDirty,this),e.off(iU.TRANSFORM_CHANGED,this._transformDirty,this),e.off(iU.ANCHOR_CHANGED,this._doLayoutDirty,this),e.off("active-in-hierarchy-changed",this._doLayoutDirty,this),this._doLayoutDirty()}},{key:"_resized",value:function(){this._layoutSize=this.node.getContentSize(),this._doLayoutDirty()}},{key:"_doLayoutHorizontally",value:function(e,t,i,n){var r=this.node.getAnchorPoint(),a=this.node.children,s=1,o=this._paddingLeft,l=-r.x*e;this._horizontalDirection===tU.RIGHT_TO_LEFT&&(s=-1,l=(1-r.x)*e,o=this._paddingRight);var u=l+s*o-s*this._spacingX,c=0,h=0,f=0,_=0,d=0,p=0,m=0,v=a,g=Array.isArray(v),y=0;for(v=g?v:v[Symbol.iterator]();;){var b;if(g){if(y>=v.length)break;b=v[y++]}else{if((y=v.next()).done)break;b=y.value}b.activeInHierarchy&&m++}var E=this._cellSize.width;this._N$layoutType!==Qz.GRID&&this._resizeMode===Jz.CHILDREN&&(E=(e-(this._paddingLeft+this._paddingRight)-(m-1)*this._spacingX)/m);var T=a,S=Array.isArray(T),x=0;for(T=S?T:T[Symbol.iterator]();;){var A;if(S){if(x>=T.length)break;A=T[x++]}else{if((x=T.next()).done)break;A=x.value}var w=A;if(w.activeInHierarchy){w.getScale(wU);var C=this._getUsedScaleValue(wU.x),R=this._getUsedScaleValue(wU.y);this._resizeMode===Jz.CHILDREN&&(w.width=E/C,this._N$layoutType===Qz.GRID&&(w.height=this._cellSize.height/R));var k=w.anchorX,O=w.width*C,I=w.height*R;f>h&&(h=f),I>=h&&(f=h,h=I,p=w.getAnchorPoint().y),this._horizontalDirection===tU.RIGHT_TO_LEFT&&(k=1-w.anchorX),u=u+s*k*O+s*this._spacingX;var M=s*(1-k)*O;if(t){var L=u+M+s*(s>0?this._paddingRight:this._paddingLeft),P=!1;this._horizontalDirection===tU.LEFT_TO_RIGHT&&L>(1-r.x)*e&&(P=!0);var B=!1;this._horizontalDirection===tU.RIGHT_TO_LEFT&&L<-r.x*e&&(B=!0),(P||B)&&(I>=h?(0===f&&(f=h),c+=f,f=h):(c+=h,f=I,h=0),u=l+s*(o+k*O),_++)}var D=i(w,c,_);e>=O+this._paddingLeft+this._paddingRight&&n&&(w.getPosition(AU),w.setPosition(u,D,AU.z));var F=1,N=void 0,z=0===h?I:h;this._verticalDirection===eU.TOP_TO_BOTTOM?(d=d||this.node.getContentSize().height,(N=D+(F=-1)*(z*p+this._paddingBottom))<d&&(d=N)):(d=d||-this.node.getContentSize().height,(N=D+F*(z*p+this._paddingTop))>d&&(d=N)),u+=M}}return d}},{key:"_doLayoutVertically",value:function(e,t,i,n){var r=this.node.getAnchorPoint(),a=this.node.children,s=1,o=this._paddingBottom,l=-r.y*e;this._verticalDirection===eU.TOP_TO_BOTTOM&&(s=-1,l=(1-r.y)*e,o=this._paddingTop);var u=l+s*o-s*this._spacingY,c=0,h=0,f=0,_=0,d=0,p=0,m=0,v=a,g=Array.isArray(v),y=0;for(v=g?v:v[Symbol.iterator]();;){var b;if(g){if(y>=v.length)break;b=v[y++]}else{if((y=v.next()).done)break;b=y.value}b.activeInHierarchy&&m++}var E=this._cellSize.height;this._N$layoutType!==Qz.GRID&&this._resizeMode===Jz.CHILDREN&&(E=(e-(this._paddingTop+this._paddingBottom)-(m-1)*this._spacingY)/m);var T=a,S=Array.isArray(T),x=0;for(T=S?T:T[Symbol.iterator]();;){var A;if(S){if(x>=T.length)break;A=T[x++]}else{if((x=T.next()).done)break;A=x.value}var w=A;if(w){var C=w.getScale(),R=this._getUsedScaleValue(C.x),k=this._getUsedScaleValue(C.y);if(w.activeInHierarchy){this._resizeMode===Jz.CHILDREN&&(w.height=E/k,this._N$layoutType===Qz.GRID&&(w.width=this._cellSize.width/R));var O=w.anchorY,I=w.width*R,M=w.height*k;f>h&&(h=f),I>=h&&(f=h,h=I,p=w.getAnchorPoint().x),this._verticalDirection===eU.TOP_TO_BOTTOM&&(O=1-w.anchorY),u=u+s*O*M+s*this._spacingY;var L=s*(1-O)*M;if(t){var P=u+L+s*(s>0?this._paddingTop:this._paddingBottom),B=!1;this._verticalDirection===eU.BOTTOM_TO_TOP&&P>(1-r.y)*e&&(B=!0);var D=!1;this._verticalDirection===eU.TOP_TO_BOTTOM&&P<-r.y*e&&(D=!0),(B||D)&&(I>=h?(0===f&&(f=h),c+=f,f=h):(c+=h,f=I,h=0),u=l+s*(o+O*M),_++)}var F=i(w,c,_);e>=M+(this._paddingTop+this._paddingBottom)&&n&&(w.getPosition(AU),w.setPosition(F,u,AU.z));var N=1,z=void 0,U=0===h?I:h;this._horizontalDirection===tU.RIGHT_TO_LEFT?(N=-1,d=d||this.node.getContentSize().width,(z=F+N*(U*p+this._paddingLeft))<d&&(d=z)):(d=d||-this.node.getContentSize().width,(z=F+N*(U*p+this._paddingRight))>d&&(d=z)),u+=L}}}return d}},{key:"_doLayoutBasic",value:function(){var e=null,t=this.node.children,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r,s=a.getComponent(Lf);s&&(a.activeInHierarchy&&(e?Jn.union(e,e,s.getBoundingBoxToWorld()):e=s.getBoundingBoxToWorld()))}if(e){var o=this.node.parent.getComponent(Lf);if(!o)return;zi.set(AU,e.x,e.y,0);var l=new zi;o.convertToNodeSpaceAR(AU,l),zi.set(l,l.x-this._paddingLeft,l.y-this._paddingBottom,l.z),zi.set(AU,e.x+e.width,e.y+e.height,0);var u=new zi;o.convertToNodeSpaceAR(AU,u),zi.set(u,u.x+this._paddingRight,u.y+this._paddingTop,u.z);var c=cc.size(parseFloat((u.x-l.x).toFixed(2)),parseFloat((u.y-l.y).toFixed(2)));if(this.node.getPosition(AU),0!==c.width){var h=(AU.x-l.x)/c.width;this.node.anchorX=parseFloat(h.toFixed(2))}if(0!==c.height){var f=(AU.y-l.y)/c.height;this.node.anchorY=parseFloat(f.toFixed(2))}this.node.setContentSize(c)}}},{key:"_doLayoutGridAxisHorizontal",value:function(e,t){var i=this,n=t.width,r=1,a=-e.y*t.height,s=this._paddingBottom;this._verticalDirection===eU.TOP_TO_BOTTOM&&(r=-1,a=(1-e.y)*t.height,s=this._paddingTop);var o=this,l=function(e,t,n){return a+r*(t+e.anchorY*e.height*o._getUsedScaleValue(e.getScale().y)+s+n*i._spacingY)},u=0;if(this._resizeMode===Jz.CONTAINER){var c=this._doLayoutHorizontally(n,!0,l,!1);(u=a-c)<0&&(u*=-1),a=-e.y*u,this._verticalDirection===eU.TOP_TO_BOTTOM&&(r=-1,a=(1-e.y)*u)}this._doLayoutHorizontally(n,!0,l,!0),this._resizeMode===Jz.CONTAINER&&this.node.setContentSize(n,u)}},{key:"_doLayoutGridAxisVertical",value:function(e,t){var i=this,n=t.height,r=1,a=-e.x*t.width,s=this._paddingLeft;this._horizontalDirection===tU.RIGHT_TO_LEFT&&(r=-1,a=(1-e.x)*t.width,s=this._paddingRight);var o=this,l=function(e,t,n){return a+r*(t+e.anchorX*e.width*o._getUsedScaleValue(e.getScale().x)+s+n*i._spacingX)},u=0;if(this._resizeMode===Jz.CONTAINER){var c=this._doLayoutVertically(n,!0,l,!1);(u=a-c)<0&&(u*=-1),a=-e.x*u,this._horizontalDirection===tU.RIGHT_TO_LEFT&&(r=-1,a=(1-e.x)*u)}this._doLayoutVertically(n,!0,l,!0),this._resizeMode===Jz.CONTAINER&&this.node.setContentSize(u,n)}},{key:"_doLayoutGrid",value:function(){var e=this.node.getAnchorPoint(),t=this.node.getContentSize();this.startAxis===$z.HORIZONTAL?this._doLayoutGridAxisHorizontal(e,t):this.startAxis===$z.VERTICAL&&this._doLayoutGridAxisVertical(e,t)}},{key:"_getHorizontalBaseWidth",value:function(e){var t=0,i=0;if(this._resizeMode===Jz.CONTAINER){var n=e,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s;o.getScale(wU),o.activeInHierarchy&&(i++,t+=o.width*this._getUsedScaleValue(wU.x))}t+=(i-1)*this._spacingX+this._paddingLeft+this._paddingRight}else t=this.node.getContentSize().width;return t}},{key:"_getVerticalBaseHeight",value:function(e){var t=0,i=0;if(this._resizeMode===Jz.CONTAINER){var n=e,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s;o.getScale(wU),o.activeInHierarchy&&(i++,t+=o.height*this._getUsedScaleValue(wU.y))}t+=(i-1)*this._spacingY+this._paddingBottom+this._paddingTop}else t=this.node.getContentSize().height;return t}},{key:"_doLayout",value:function(){var e=this;if(this._N$layoutType===Qz.HORIZONTAL){var t=this._getHorizontalBaseWidth(this.node.children);this._doLayoutHorizontally(t,!1,(function(t){return(e._isAlign?zi.ZERO:t.position).y}),!0),this._isAlign=!1,this.node.width=t}else if(this._N$layoutType===Qz.VERTICAL){var i=this._getVerticalBaseHeight(this.node.children);this._doLayoutVertically(i,!1,(function(t){return(e._isAlign?zi.ZERO:t.position).x}),!0),this._isAlign=!1,this.node.height=i}else this._N$layoutType===Qz.NONE?this._resizeMode===Jz.CONTAINER&&this._doLayoutBasic():this._N$layoutType===Qz.GRID&&this._doLayoutGrid()}},{key:"_getUsedScaleValue",value:function(e){return this._affectedByScale?Math.abs(e):1}},{key:"_transformDirty",value:function(e){e&Nu.POSITION&&this._doLayoutDirty()}},{key:"_doLayoutDirty",value:function(){this._layoutDirty=!0}},{key:"_doScaleDirty",value:function(e){e&Nu.SCALE&&(this._layoutDirty=this._layoutDirty||this._affectedByScale)}},{key:"type",get:function(){return this._N$layoutType},set:function(e){this._N$layoutType=e,this._isAlign=!0,this._doLayoutDirty()}},{key:"resizeMode",get:function(){return this._resizeMode},set:function(e){this._N$layoutType===Qz.NONE&&e===Jz.CHILDREN||(this._resizeMode=e,this._doLayoutDirty())}},{key:"cellSize",get:function(){return this._cellSize},set:function(e){this._cellSize!==e&&(this._cellSize.set(e),this._doLayoutDirty())}},{key:"startAxis",get:function(){return this._startAxis},set:function(e){this._startAxis!==e&&(this._startAxis=e,this._doLayoutDirty())}},{key:"paddingLeft",get:function(){return this._paddingLeft},set:function(e){this._paddingLeft!==e&&(this._paddingLeft=e,this._doLayoutDirty())}},{key:"paddingRight",get:function(){return this._paddingRight},set:function(e){this._paddingRight!==e&&(this._paddingRight=e,this._doLayoutDirty())}},{key:"paddingTop",get:function(){return this._paddingTop},set:function(e){this._paddingTop!==e&&(this._paddingTop=e,this._doLayoutDirty())}},{key:"paddingBottom",get:function(){return this._paddingBottom},set:function(e){this._paddingBottom!==e&&(this._paddingBottom=e,this._doLayoutDirty())}},{key:"spacingX",get:function(){return this._spacingX},set:function(e){this._spacingX!==e&&(this._spacingX=e,this._doLayoutDirty())}},{key:"spacingY",get:function(){return this._spacingY},set:function(e){this._spacingY!==e&&(this._spacingY=e,this._doLayoutDirty())}},{key:"verticalDirection",get:function(){return this._verticalDirection},set:function(e){this._verticalDirection!==e&&(this._verticalDirection=e,this._doLayoutDirty())}},{key:"horizontalDirection",get:function(){return this._horizontalDirection},set:function(e){this._horizontalDirection!==e&&(this._horizontalDirection=e,this._doLayoutDirty())}},{key:"padding",get:function(){return this._paddingLeft},set:function(e){this._N$padding=e,this._migratePaddingData(),this._doLayoutDirty()}},{key:"affectedByScale",get:function(){return this._affectedByScale},set:function(e){this._affectedByScale=e,this._doLayoutDirty()}}]),t}(Ph),Yz.Type=Qz,Yz.VerticalDirection=eU,Yz.HorizontalDirection=tU,Yz.ResizeMode=Jz,Yz.AxisDirection=$z,v((Lz=Kz).prototype,"type",[gz],Object.getOwnPropertyDescriptor(Lz.prototype,"type"),Lz.prototype),v(Lz.prototype,"resizeMode",[yz],Object.getOwnPropertyDescriptor(Lz.prototype,"resizeMode"),Lz.prototype),v(Lz.prototype,"cellSize",[bz],Object.getOwnPropertyDescriptor(Lz.prototype,"cellSize"),Lz.prototype),v(Lz.prototype,"startAxis",[Ez],Object.getOwnPropertyDescriptor(Lz.prototype,"startAxis"),Lz.prototype),v(Lz.prototype,"paddingLeft",[Tz],Object.getOwnPropertyDescriptor(Lz.prototype,"paddingLeft"),Lz.prototype),v(Lz.prototype,"paddingRight",[Sz],Object.getOwnPropertyDescriptor(Lz.prototype,"paddingRight"),Lz.prototype),v(Lz.prototype,"paddingTop",[xz],Object.getOwnPropertyDescriptor(Lz.prototype,"paddingTop"),Lz.prototype),v(Lz.prototype,"paddingBottom",[Az],Object.getOwnPropertyDescriptor(Lz.prototype,"paddingBottom"),Lz.prototype),v(Lz.prototype,"spacingX",[wz],Object.getOwnPropertyDescriptor(Lz.prototype,"spacingX"),Lz.prototype),v(Lz.prototype,"spacingY",[Cz],Object.getOwnPropertyDescriptor(Lz.prototype,"spacingY"),Lz.prototype),v(Lz.prototype,"verticalDirection",[Rz],Object.getOwnPropertyDescriptor(Lz.prototype,"verticalDirection"),Lz.prototype),v(Lz.prototype,"horizontalDirection",[kz],Object.getOwnPropertyDescriptor(Lz.prototype,"horizontalDirection"),Lz.prototype),v(Lz.prototype,"padding",[Oz],Object.getOwnPropertyDescriptor(Lz.prototype,"padding"),Lz.prototype),v(Lz.prototype,"affectedByScale",[Iz],Object.getOwnPropertyDescriptor(Lz.prototype,"affectedByScale"),Lz.prototype),Pz=v(Lz.prototype,"_resizeMode",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Jz.NONE}}),Bz=v(Lz.prototype,"_N$layoutType",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Qz.NONE}}),Dz=v(Lz.prototype,"_N$padding",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Fz=v(Lz.prototype,"_cellSize",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Xn(40,40)}}),Nz=v(Lz.prototype,"_startAxis",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return $z.HORIZONTAL}}),zz=v(Lz.prototype,"_paddingLeft",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Uz=v(Lz.prototype,"_paddingRight",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Gz=v(Lz.prototype,"_paddingTop",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Vz=v(Lz.prototype,"_paddingBottom",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Hz=v(Lz.prototype,"_spacingX",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Wz=v(Lz.prototype,"_spacingY",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),jz=v(Lz.prototype,"_verticalDirection",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return eU.TOP_TO_BOTTOM}}),Xz=v(Lz.prototype,"_horizontalDirection",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return tU.LEFT_TO_RIGHT}}),qz=v(Lz.prototype,"_affectedByScale",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Mz=Lz))||Mz)||Mz)||Mz)||Mz)||Mz));cc.LayoutComponent=CU,function(e){e[e.BUTT=0]="BUTT",e[e.ROUND=1]="ROUND",e[e.SQUARE=2]="SQUARE"}(nU||(nU={})),pt(nU),function(e){e[e.BEVEL=0]="BEVEL",e[e.ROUND=1]="ROUND",e[e.MITER=2]="MITER"}(rU||(rU={})),pt(rU),function(e){e[e.PT_CORNER=1]="PT_CORNER",e[e.PT_LEFT=2]="PT_LEFT",e[e.PT_BEVEL=4]="PT_BEVEL",e[e.PT_INNERBEVEL=8]="PT_INNERBEVEL"}(aU||(aU={})),pt(aU);var RU,kU,OU,IU,MU,LU,PU,BU,DU,FU,NU,zU,UU,GU,VU,HU={parent:null,owner:null,subModelIdx:0},WU=e("GraphicsComponent",(sU=Es("cc.GraphicsComponent"),oU=Rs(110),lU=Cs("UI/Render/Graphics"),uU=Ts({type:rU,tooltip:""}),cU=Ts({type:nU,tooltip:""}),hU=Ts({tooltip:""}),fU=Ts({tooltip:""}),_U=Ts({tooltip:""}),dU=Ts({override:!0,visible:!1}),sU(pU=oU(pU=lU((xU=SU=function(e){function t(){var e;return i(this,t),(e=c(this,o(t).call(this))).impl=null,e.model=null,m(e,"_lineWidth",vU,u(e)),m(e,"_strokeColor",gU,u(e)),m(e,"_lineJoin",yU,u(e)),m(e,"_lineCap",bU,u(e)),m(e,"_fillColor",EU,u(e)),m(e,"_miterLimit",TU,u(e)),e._instanceMaterialType=Qw.ADDCOLOR,e}return s(t,e),r(t,[{key:"lineWidth",get:function(){return this._lineWidth},set:function(e){this._lineWidth=e,this.impl&&(this.impl.lineWidth=e)}},{key:"lineJoin",get:function(){return this._lineJoin},set:function(e){this._lineJoin=e,this.impl&&(this.impl.lineJoin=e)}},{key:"lineCap",get:function(){return this._lineCap},set:function(e){this._lineCap=e,this.impl&&(this.impl.lineCap=e)}},{key:"strokeColor",get:function(){return this._strokeColor},set:function(e){this.impl&&(this._strokeColor.set(e),this.impl.strokeColor=this._strokeColor)}},{key:"fillColor",get:function(){return this._fillColor},set:function(e){this.impl&&(this._fillColor.set(e),this.impl.fillColor=this._fillColor)}},{key:"miterLimit",get:function(){return this._miterLimit},set:function(e){this._miterLimit=e}},{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this._updateColor(),this.markForUpdateRenderData())}}]),r(t,[{key:"onRestore",value:function(){this.impl||this._flushAssembler()}},{key:"__preload",value:function(){f(o(t.prototype),"__preload",this)&&f(o(t.prototype),"__preload",this).call(this),this.impl=this._assembler&&this._assembler.createImpl(this)}},{key:"onLoad",value:function(){this._sceneGetter=vR.root.ui.getRenderSceneGetter(),this.model||(this.model=vR.root.createModel(Zu))}},{key:"onEnable",value:function(){f(o(t.prototype),"onEnable",this).call(this),this._attachToScene(),this._activateMaterial()}},{key:"onDisable",value:function(){this._detachFromScene()}},{key:"onDestroy",value:function(){f(o(t.prototype),"onDestroy",this).call(this),this._sceneGetter=null,this.model&&(this.model.destroy(),vR.root.destroyModel(this.model),this.model=null),this.impl&&(this.impl.clear(),this.impl=null)}},{key:"_activateMaterial",value:function(){this._material&&this._updateMaterial(this._material)}},{key:"moveTo",value:function(e,t){this.impl&&this.impl.moveTo(e,t)}},{key:"lineTo",value:function(e,t){this.impl&&this.impl.lineTo(e,t)}},{key:"bezierCurveTo",value:function(e,t,i,n,r,a){this.impl&&this.impl.bezierCurveTo(e,t,i,n,r,a)}},{key:"quadraticCurveTo",value:function(e,t,i,n){this.impl&&this.impl.quadraticCurveTo(e,t,i,n)}},{key:"arc",value:function(e,t,i,n,r,a){this.impl&&this.impl.arc(e,t,i,n,r,a)}},{key:"ellipse",value:function(e,t,i,n){this.impl&&this.impl.ellipse(e,t,i,n)}},{key:"circle",value:function(e,t,i){this.impl&&this.impl.circle(e,t,i)}},{key:"rect",value:function(e,t,i,n){this.impl&&this.impl.rect(e,t,i,n)}},{key:"roundRect",value:function(e,t,i,n,r){this.impl&&this.impl.roundRect(e,t,i,n,r)}},{key:"fillRect",value:function(e,t,i,n){this.rect(e,t,i,n),this.fill()}},{key:"clear",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.impl&&(this.impl.clear(e),this.model&&this.model.destroy(),this.markForUpdateRenderData())}},{key:"close",value:function(){this.impl&&this.impl.close()}},{key:"stroke",value:function(){this._assembler.stroke(this)}},{key:"fill",value:function(){this._assembler.fill(this)}},{key:"helpInstanceMaterial",value:function(){var e=null;HU.owner=new wp,this._sharedMaterial?(HU.parent=this._sharedMaterial,e=new xp(HU)):(HU.parent=P_.get("ui-base-material"),(e=new xp(HU)).recompileShaders({USE_LOCAL:!0})),this._updateMaterial(e),this.impl||(this._flushAssembler(),this.impl=this._assembler&&this._assembler.createImpl(this))}},{key:"_render",value:function(e){e.commitModel(this,this.model,this._material)}},{key:"_instanceMaterial",value:function(){this.helpInstanceMaterial()}},{key:"_flushAssembler",value:function(){var e=t.Assembler.getAssembler(this);this._assembler!==e&&(this._assembler=e)}},{key:"_canRender",value:function(){return!!f(o(t.prototype),"_canRender",this).call(this)&&(!!this.model&&this.model.inited)}},{key:"_attachToScene",value:function(){var e=vR.root.ui.renderScene;this.model&&(null!=this.model.scene&&this._detachFromScene(),e.addModel(this.model))}},{key:"_detachFromScene",value:function(){this.model&&this.model.scene&&this.model.scene.removeModel(this.model)}}]),t}(OC),SU.LineJoin=rU,SU.LineCap=nU,v((mU=xU).prototype,"lineJoin",[uU],Object.getOwnPropertyDescriptor(mU.prototype,"lineJoin"),mU.prototype),v(mU.prototype,"lineCap",[cU],Object.getOwnPropertyDescriptor(mU.prototype,"lineCap"),mU.prototype),v(mU.prototype,"strokeColor",[hU],Object.getOwnPropertyDescriptor(mU.prototype,"strokeColor"),mU.prototype),v(mU.prototype,"fillColor",[fU],Object.getOwnPropertyDescriptor(mU.prototype,"fillColor"),mU.prototype),v(mU.prototype,"miterLimit",[_U],Object.getOwnPropertyDescriptor(mU.prototype,"miterLimit"),mU.prototype),v(mU.prototype,"color",[dU],Object.getOwnPropertyDescriptor(mU.prototype,"color"),mU.prototype),vU=v(mU.prototype,"_lineWidth",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),gU=v(mU.prototype,"_strokeColor",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return rr.BLACK.clone()}}),yU=v(mU.prototype,"_lineJoin",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return rU.MITER}}),bU=v(mU.prototype,"_lineCap",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return nU.BUTT}}),EU=v(mU.prototype,"_fillColor",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return rr.WHITE.clone()}}),TU=v(mU.prototype,"_miterLimit",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),pU=mU))||pU)||pU)||pU));cc.GraphicsComponent=WU;var jU,XU=new Bn,qU=new Mi,YU=new Bn,KU=[];!function(e){e[e.RECT=0]="RECT",e[e.ELLIPSE=1]="ELLIPSE",e[e.GRAPHICS_STENCIL=2]="GRAPHICS_STENCIL"}(jU||(jU={})),pt(jU);var ZU,QU,JU,$U,eG,tG,iG,nG,rG,aG,sG,oG,lG,uG,cG,hG,fG,_G,dG=e("MaskComponent",(RU=Es("cc.MaskComponent"),kU=Rs(110),OU=Cs("UI/Render/Mask"),IU=Ts({type:jU,displayOrder:4,tooltip:""}),MU=Ts({tooltip:""}),LU=Ts({visible:!1,override:!0}),PU=Ts({visible:!1,override:!0}),BU=Ts({visible:!1,override:!0}),RU(DU=kU(DU=OU((VU=GU=function(e){function t(){var e;return i(this,t),m(e=c(this,o(t).call(this)),"_type",NU,u(e)),m(e,"_inverted",zU,u(e)),m(e,"_segments",UU,u(e)),e._graphics=null,e._clearGraphics=null,e._instanceMaterialType=Qw.ADDCOLOR,e}return s(t,e),r(t,[{key:"type",get:function(){return this._type},set:function(e){this._type!==e&&(this._type=e,this._updateGraphics(),this._renderData&&(this.destroyRenderData(),this._renderData=null))}},{key:"inverted",get:function(){return this._inverted},set:function(e){cc.game.renderType!==Nx.RENDER_TYPE_CANVAS?this._inverted=e:cc.warnID(4202)}},{key:"segments",get:function(){return this._segments},set:function(e){this._segments!==e&&(this._segments=_i(e,3,1e4),this._updateGraphics())}},{key:"graphics",get:function(){return this._graphics}},{key:"clearGraphics",get:function(){return this._clearGraphics}},{key:"dstBlendFactor",get:function(){return this._dstBlendFactor},set:function(e){this._dstBlendFactor!==e&&(this._dstBlendFactor=e,this._updateBlendFunc())}},{key:"srcBlendFactor",get:function(){return this._srcBlendFactor},set:function(e){this._srcBlendFactor!==e&&(this._srcBlendFactor=e,this._updateBlendFunc())}},{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this.markForUpdateRenderData())}}]),r(t,[{key:"onLoad",value:function(){this._createGraphics(),this._clearGraphics&&this._clearGraphics.onLoad(),this._graphics&&this._graphics.onLoad()}},{key:"onRestore",value:function(){this._createGraphics(),this._updateGraphics()}},{key:"onEnable",value:function(){f(o(t.prototype),"onEnable",this).call(this),this._enableGraphics(),qx.on("design-resolution-changed",this._updateClearGraphics,this)}},{key:"onDisable",value:function(){f(o(t.prototype),"onDisable",this).call(this),this._disableGraphics(),qx.off("design-resolution-changed",this._updateClearGraphics)}},{key:"onDestroy",value:function(){f(o(t.prototype),"onDestroy",this).call(this),this._removeGraphics()}},{key:"isHit",value:function(e){var t=this.node,i=t.getContentSize(),n=i.width,r=i.height,a=qU;this.node.getWorldMatrix(XU),Bn.invert(YU,XU),Mi.transformMat4(a,e,YU);var s=t.getAnchorPoint();a.x+=s.x*n,a.y+=s.y*r;var o=!1;if(this.type===jU.RECT)o=a.x>=0&&a.y>=0&&a.x<=n&&a.y<=r;else if(this.type===jU.ELLIPSE){var l=n/2,u=r/2,c=a.x-.5*n,h=a.y-.5*r;o=c*c/(l*l)+h*h/(u*u)<1}return this._inverted&&(o=!o),o}},{key:"_render",value:function(e){e.commitComp(this,null,this._assembler)}},{key:"_postRender",value:function(e){this._postAssembler&&e.commitComp(this,null,this._postAssembler)}},{key:"_nodeStateChange",value:function(e){f(o(t.prototype),"_nodeStateChange",this).call(this,e),this._updateGraphics()}},{key:"_resolutionChanged",value:function(){this._updateClearGraphics()}},{key:"_canRender",value:function(){return!!f(o(t.prototype),"_canRender",this).call(this)&&(null!==this._clearGraphics&&null!==this._graphics)}},{key:"_flushAssembler",value:function(){var e=t.Assembler.getAssembler(this),i=t.PostAssembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._postAssembler!==i&&(this._postAssembler=i),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.sharedMaterial,this.markForUpdateRenderData())}},{key:"_createGraphics",value:function(){if(!this._clearGraphics){var e=new o_("clear-graphics"),t=this._clearGraphics=e.addComponent(WU);t.delegateSrc=this.node,t.helpInstanceMaterial(),t.lineWidth=0;var i=rr.WHITE.clone();i.a=0,t.fillColor=i}if(!this._graphics){var n=this._graphics=new WU;n.node=this.node,n.node.getWorldMatrix(),n.helpInstanceMaterial(),n.lineWidth=0;var r=rr.WHITE.clone();r.a=0,n.fillColor=r}}},{key:"_updateClearGraphics",value:function(){if(this._clearGraphics){var e=qS;this._clearGraphics.node.setWorldPosition(e.width/2,e.height/2,0),this._clearGraphics.clear(),this._clearGraphics.rect(-e.width/2,-e.height/2,e.width,e.height),this._clearGraphics.fill()}}},{key:"_updateGraphics",value:function(){if(this._graphics){var e=this.node,t=this._graphics;t.clear();var i=e.getContentSize(),n=i.width,r=i.height,a=e.getAnchorPoint(),s=-n*a.x,o=-r*a.y;if(this._type===jU.RECT)t.rect(s,o,n,r);else if(this._type===jU.ELLIPSE){for(var l=function(e,t,i){KU.length=0;for(var n=2*Math.PI/i,r=0;r<i;++r)KU.push(new zi(t.x*Math.cos(n*r)+e.x,t.y*Math.sin(n*r)+e.y,0));return KU}(new zi(s+n/2,o+r/2,0),new zi(n/2,r/2,0),this._segments),u=0;u<l.length;++u){var c=l[u];0===u?t.moveTo(c.x,c.y):t.lineTo(c.x,c.y)}t.close()}t.fill()}}},{key:"_enableGraphics",value:function(){this._clearGraphics&&(this._clearGraphics.onEnable(),this._updateClearGraphics()),this._graphics&&(this._graphics.onEnable(),this._updateGraphics())}},{key:"_disableGraphics",value:function(){this._graphics&&this._graphics.onDisable(),this._clearGraphics&&this._clearGraphics.onDisable()}},{key:"_removeGraphics",value:function(){this._graphics&&this._graphics.destroy(),this._clearGraphics&&this._clearGraphics.destroy()}}]),t}(OC),GU.Type=jU,v((FU=VU).prototype,"type",[IU],Object.getOwnPropertyDescriptor(FU.prototype,"type"),FU.prototype),v(FU.prototype,"inverted",[MU],Object.getOwnPropertyDescriptor(FU.prototype,"inverted"),FU.prototype),v(FU.prototype,"segments",[Ts],Object.getOwnPropertyDescriptor(FU.prototype,"segments"),FU.prototype),v(FU.prototype,"dstBlendFactor",[LU],Object.getOwnPropertyDescriptor(FU.prototype,"dstBlendFactor"),FU.prototype),v(FU.prototype,"srcBlendFactor",[PU],Object.getOwnPropertyDescriptor(FU.prototype,"srcBlendFactor"),FU.prototype),v(FU.prototype,"color",[BU],Object.getOwnPropertyDescriptor(FU.prototype,"color"),FU.prototype),NU=v(FU.prototype,"_type",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return jU.RECT}}),zU=v(FU.prototype,"_inverted",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),UU=v(FU.prototype,"_segments",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),DU=FU))||DU)||DU)||DU));cc.MaskComponent=dG,function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL",e[e.FILLED=2]="FILLED"}(_G||(_G={})),dt(_G);var pG,mG,vG,gG,yG,bG,EG,TG,SG,xG=e("ProgressBarComponent",(ZU=Es("cc.ProgressBarComponent"),QU=Rs(110),JU=Cs("UI/ProgressBar"),$U=Ts({type:zC,tooltip:" Sprite "}),eG=Ts({type:_G,tooltip:""}),tG=Ts({tooltip:" progress  1 "}),iG=Ts({range:[0,1,.1],slide:!0,tooltip:" 0  1"}),nG=Ts({tooltip:""}),ZU(rG=QU(rG=JU((fG=hG=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),s=0;s<r;s++)a[s]=arguments[s];return m(n=c(this,(e=o(t)).call.apply(e,[this].concat(a))),"_barSprite",sG,u(n)),m(n,"_mode",oG,u(n)),m(n,"_totalLength",lG,u(n)),m(n,"_progress",uG,u(n)),m(n,"_reverse",cG,u(n)),n}return s(t,e),r(t,[{key:"_initBarSprite",value:function(){if(this._barSprite){var e=this._barSprite.node;if(!e)return;var t=this.node.getContentSize(),i=this.node.getAnchorPoint(),n=e.getContentSize();if(this._barSprite.fillType===zC.FillType.RADIAL&&(this._mode=_G.FILLED),this._mode===_G.HORIZONTAL?this.totalLength=n.width:this._mode===_G.VERTICAL?this.totalLength=n.height:this.totalLength=this._barSprite.fillRange,e.parent===this.node){var r=-t.width*i.x;e.setPosition(r,0,0)}}}},{key:"_updateBarStatus",value:function(){if(this._barSprite){var e=this._barSprite.node;if(!e)return;var t=e.getAnchorPoint(),i=e.getContentSize(),n=e.getPosition(),r=new Mi(0,.5),a=di(this._progress),s=this._totalLength*a,o=i,l=0,u=0;switch(this._mode){case _G.HORIZONTAL:this._reverse&&(r=new Mi(1,.5)),o=new Xn(s,i.height),l=this._totalLength,u=i.height;break;case _G.VERTICAL:r=this._reverse?new Mi(.5,1):new Mi(.5,0),o=new Xn(i.width,s),l=i.width,u=this._totalLength}if(this._mode===_G.FILLED)this._barSprite.type!==zC.Type.FILLED?k("ProgressBar FILLED mode only works when barSprite's Type is FILLED!"):(this._reverse&&(s*=-1),this._barSprite.fillRange=s);else if(this._barSprite.type!==zC.Type.FILLED){var c=r.x-t.x,h=r.y-t.y,f=new zi(l*c,u*h,0);e.setPosition(n.x+f.x,n.y+f.y,n.z),e.setAnchorPoint(r),e.setContentSize(o)}else k("ProgressBar non-FILLED mode only works when barSprite's Type is non-FILLED!")}}},{key:"barSprite",get:function(){return this._barSprite},set:function(e){this._barSprite!==e&&(this._barSprite=e,this._initBarSprite())}},{key:"mode",get:function(){return this._mode},set:function(e){if(this._mode!==e&&(this._mode=e,this._barSprite)){var t=this._barSprite.node;if(!t)return;var i=t.getContentSize();this._mode===_G.HORIZONTAL?this.totalLength=i.width:this._mode===_G.VERTICAL?this.totalLength=i.height:this._mode===_G.FILLED&&(this.totalLength=this._barSprite.fillRange)}}},{key:"totalLength",get:function(){return this._totalLength},set:function(e){this._mode===_G.FILLED&&(e=di(e)),this._totalLength=e,this._updateBarStatus()}},{key:"progress",get:function(){return this._progress},set:function(e){this._progress!==e&&(this._progress=e,this._updateBarStatus())}},{key:"reverse",get:function(){return this._reverse},set:function(e){this._reverse!==e&&(this._reverse=e,this._barSprite&&(this._barSprite.fillStart=1-this._barSprite.fillStart),this._updateBarStatus())}}]),t}(Ph),hG.Mode=_G,v((aG=fG).prototype,"barSprite",[$U],Object.getOwnPropertyDescriptor(aG.prototype,"barSprite"),aG.prototype),v(aG.prototype,"mode",[eG],Object.getOwnPropertyDescriptor(aG.prototype,"mode"),aG.prototype),v(aG.prototype,"totalLength",[tG],Object.getOwnPropertyDescriptor(aG.prototype,"totalLength"),aG.prototype),v(aG.prototype,"progress",[iG],Object.getOwnPropertyDescriptor(aG.prototype,"progress"),aG.prototype),v(aG.prototype,"reverse",[nG],Object.getOwnPropertyDescriptor(aG.prototype,"reverse"),aG.prototype),sG=v(aG.prototype,"_barSprite",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),oG=v(aG.prototype,"_mode",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _G.HORIZONTAL}}),lG=v(aG.prototype,"_totalLength",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),uG=v(aG.prototype,"_progress",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),cG=v(aG.prototype,"_reverse",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),rG=aG))||rG)||rG)||rG));cc.ProgressBarComponent=xG;var AG,wG,CG,RG,kG,OG,IG,MG,LG,PG,BG,DG,FG,NG,zG,UG,GG,VG,HG,WG,jG,XG,qG,YG=e("LabelOutlineComponent",(pG=Es("cc.LabelOutlineComponent"),mG=Rs(110),vG=Cs("UI/LabelOutline"),gG=Ts({tooltip:""}),yG=Ts({tooltip:""}),pG(bG=mG(bG=vG((TG=v((EG=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),s=0;s<r;s++)a[s]=arguments[s];return m(n=c(this,(e=o(t)).call.apply(e,[this].concat(a))),"_color",TG,u(n)),m(n,"_width",SG,u(n)),n}return s(t,e),r(t,[{key:"_updateRenderData",value:function(){var e=this.node.getComponent(hN);e&&e.updateRenderData(!0)}},{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this._updateRenderData())}},{key:"width",get:function(){return this._width},set:function(e){this._width!==e&&(this._width=e,this._updateRenderData())}}]),t}(Ph)).prototype,"_color",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rr(255,255,255,255)}}),SG=v(EG.prototype,"_width",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),v(EG.prototype,"color",[gG],Object.getOwnPropertyDescriptor(EG.prototype,"color"),EG.prototype),v(EG.prototype,"width",[yG],Object.getOwnPropertyDescriptor(EG.prototype,"width"),EG.prototype),bG=EG))||bG)||bG)||bG));cc.LabelOutlineComponent=YG;var KG=new cs;var ZG=new Ze((function(e){return!!cc.isValid(e.node)&&!e.node.getComponent(YG)}),20);ZG.get=function(e,t){var i=this._get();i||(i={node:new eE("RICHTEXT_CHILD"),comp:null,lineCount:0,styleIndex:0,clickHandler:""});var n=i.node;n||(n=new eE("RICHTEXT_CHILD"));var r=n.getComponent(hN);return r||(r=n.addComponent(hN)),r=r,n.setPosition(0,0,0),n.setAnchorPoint(.5,.5),n.setContentSize(128,128),"string"!=typeof e&&(e=""+e),t.font instanceof yg?r.font=t.font:r.fontFamily="Arial",r.string=e,r.horizontalAlign=sN.LEFT,r.verticalAlign=oN.TOP,r.fontSize=t.fontSize||40,r.overflow=0,r.enableWrapText=!0,r.lineHeight=40,r.isBold=!1,r.isItalic=!1,r.isUnderline=!1,{node:n,comp:r,lineCount:0,clickHandler:"",styleIndex:0}};var QG,JG,$G,eV,tV,iV,nV,rV,aV,sV,oV,lV,uV,cV,hV,fV,_V=e("RichTextComponent",(AG=Es("cc.RichTextComponent"),wG=Rs(110),CG=Cs("UI/Render/RichText"),RG=Ts({multiline:!0,tooltip:""}),kG=Ts({type:sN,tooltip:""}),OG=Ts({tooltip:""}),IG=Ts({type:Rg,tooltip:""}),MG=Ts({tooltip:""}),LG=Ts({tooltip:""}),PG=Ts({type:rv,tooltip:" img  src  imageAtlas  spriteFrame img tag "}),BG=Ts({tooltip:"RichText "}),AG(DG=wG(DG=CG(DG=As((qG=XG=function(e){function t(){var e;return i(this,t),m(e=c(this,o(t).call(this)),"_lineHeight",NG,u(e)),m(e,"_string",zG,u(e)),m(e,"_horizontalAlign",UG,u(e)),m(e,"_fontSize",GG,u(e)),m(e,"_maxWidth",VG,u(e)),m(e,"_font",HG,u(e)),m(e,"_imageAtlas",WG,u(e)),m(e,"_handleTouchEvent",jG,u(e)),e._textArray=[],e._labelSegments=[],e._labelSegmentsCache=[],e._linesWidth=[],e._lineCount=1,e._labelWidth=0,e._labelHeight=0,e._layoutDirty=!0,e._lineOffsetX=0,e._updateRichTextStatus=e._updateRichText,e}return s(t,e),r(t,[{key:"string",get:function(){return this._string},set:function(e){this._string!==e&&(this._string=e,this._updateRichTextStatus())}},{key:"horizontalAlign",get:function(){return this._horizontalAlign},set:function(e){this.horizontalAlign!==e&&(this._horizontalAlign=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"fontSize",get:function(){return this._fontSize},set:function(e){this._fontSize!==e&&(this._fontSize=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"font",get:function(){return this._font},set:function(e){this._font!==e&&(this._font=e,this._layoutDirty=!0,this._font&&this._onTTFLoaded(),this._updateRichTextStatus())}},{key:"maxWidth",get:function(){return this._maxWidth},set:function(e){this._maxWidth!==e&&(this._maxWidth=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"lineHeight",get:function(){return this._lineHeight},set:function(e){this._lineHeight!==e&&(this._lineHeight=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"imageAtlas",get:function(){return this._imageAtlas},set:function(e){this._imageAtlas!==e&&(this._imageAtlas=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"handleTouchEvent",get:function(){return this._handleTouchEvent},set:function(e){this._handleTouchEvent!==e&&(this._handleTouchEvent=e,this.enabledInHierarchy&&(this.handleTouchEvent?this._addEventListeners():this._removeEventListeners()))}}]),r(t,[{key:"onEnable",value:function(){this.handleTouchEvent&&this._addEventListeners(),this._updateRichText(),this._activateChildren(!0)}},{key:"onDisable",value:function(){this.handleTouchEvent&&this._removeEventListeners(),this._activateChildren(!1)}},{key:"start",value:function(){this._onTTFLoaded(),this.node.on(o_.EventType.ANCHOR_CHANGED,this._anchorChanged,this)}},{key:"onRestore",value:function(){}},{key:"onDestroy",value:function(){var e=this._labelSegments,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n;r.node.removeFromParent(),ZG.put(r)}this.node.off(o_.EventType.ANCHOR_CHANGED,this._anchorChanged)}},{key:"_addEventListeners",value:function(){this.node.on(o_.EventType.TOUCH_END,this._onTouchEnded,this)}},{key:"_removeEventListeners",value:function(){this.node.off(o_.EventType.TOUCH_END,this._onTouchEnded,this)}},{key:"_updateLabelSegmentTextAttributes",value:function(){var e=this;this._labelSegments.forEach((function(t){e._applyTextAttribute(t)}))}},{key:"_createFontLabel",value:function(e){return ZG.get(e,this)}},{key:"_onTTFLoaded",value:function(){if(this._font instanceof Rg)if(this._font._nativeAsset)this._layoutDirty=!0,this._updateRichText();else{var e=this;Oy.load(this._font.nativeUrl,(function(t,i){e._layoutDirty=!0,e._updateRichText()}))}else this._layoutDirty=!0,this._updateRichText()}},{key:"_measureText",value:function(e,t){var i=this,n=function(t){var n;return 0===i._labelSegmentsCache.length?(n=i._createFontLabel(t),i._labelSegmentsCache.push(n)):(n=i._labelSegmentsCache[0]).node.getComponent(hN).string=t,n.styleIndex=e,i._applyTextAttribute(n),n.node.getContentSize().width};return t?n(t):n}},{key:"_onTouchEnded",value:function(e){var t=this,i=this.node.getComponents(Jw),n=this,r=function(){if(s){if(o>=a.length)return"break";l=a[o++]}else{if((o=a.next()).done)return"break";l=o.value}var r=l,u=r.clickHandler;u&&t._containsTouchLocation(r,e.touch.getUILocation())&&(i.forEach((function(t){var i=t[u];t.enabledInHierarchy&&i&&i.call(n,e)})),e.propagationStopped=!0)},a=this._labelSegments,s=Array.isArray(a),o=0;for(a=s?a:a[Symbol.iterator]();;){var l;if("break"===r())break}}},{key:"_containsTouchLocation",value:function(e,t){var i=e.node.getComponent(Lf);return!!i&&i.getBoundingBoxToWorld().contains(t)}},{key:"_resetState",value:function(){for(var e=this,t=this.node.children,i=function(i){var n=t[i];if(("RICHTEXT_CHILD"===n.name||"RICHTEXT_Image_CHILD"===n.name)&&(n.parent===e.node?n.parent=null:t.splice(i,1),"RICHTEXT_CHILD"===n.name)){var r=e._labelSegments.findIndex((function(e){return e.node===n}));-1!==r&&ZG.put(e._labelSegments[r])}},n=t.length-1;n>=0;n--)i(n);this._labelSegments.length=0,this._labelSegmentsCache.length=0,this._linesWidth.length=0,this._lineOffsetX=0,this._lineCount=1,this._labelWidth=0,this._labelHeight=0,this._layoutDirty=!0}},{key:"_activateChildren",value:function(e){for(var t=this.node.children.length-1;t>=0;t--){var i=this.node.children[t];"RICHTEXT_CHILD"!==i.name&&"RICHTEXT_Image_CHILD"!==i.name||(i.active=e)}}},{key:"_addLabelSegment",value:function(e,t){var i;if(0===this._labelSegmentsCache.length)i=this._createFontLabel(e);else{var n=(i=this._labelSegmentsCache.pop()).node.getComponent(hN);n&&(n.string=e)}return i.styleIndex=t,i.lineCount=this._lineCount,i.node.setAnchorPoint(0,0),this._applyTextAttribute(i),this.node.addChild(i.node),this._labelSegments.push(i),i}},{key:"_updateRichTextWithMaxWidth",value:function(e,t,i){var n=t;if(this._lineOffsetX>0&&n+this._lineOffsetX>this.maxWidth)for(var r=0;this._lineOffsetX<=this.maxWidth;){var a=this._getFirstWordLen(e,r,e.length),s=e.substr(r,a),o=this._measureText(i,s);if(!(this._lineOffsetX+o<=this.maxWidth)){if(r>0){var l=e.substr(0,r);this._addLabelSegment(l,i),e=e.substr(r,e.length),n=this._measureText(i,e)}this._updateLineInfo();break}this._lineOffsetX+=o,r+=a}if(n>this.maxWidth)for(var u=os(e,n,this.maxWidth,this._measureText(i)),c=0;c<u.length;++c){var h=u[c],f=this._addLabelSegment(h,i).node.getContentSize();this._lineOffsetX+=f.width,u.length>1&&c<u.length-1&&this._updateLineInfo()}else this._lineOffsetX+=n,this._addLabelSegment(e,i)}},{key:"_isLastComponentCR",value:function(e){return e.length-1===e.lastIndexOf("\n")}},{key:"_updateLineInfo",value:function(){this._linesWidth.push(this._lineOffsetX),this._lineOffsetX=0,this._lineCount++}},{key:"_needsUpdateTextLayout",value:function(e){if(this._layoutDirty||!this._textArray||!e)return!0;if(this._textArray.length!==e.length)return!0;for(var t=0;t<this._textArray.length;t++){var i=this._textArray[t],n=e[t];if(i.text!==n.text)return!0;if(i.style){if(n.style){if(!!n.style.outline!=!!i.style.outline)return!0;if(i.style.size!==n.style.size||i.style.italic!==n.style.italic||i.style.isImage!==n.style.isImage)return!0;if(i.style.isImage===n.style.isImage&&i.style.src!==n.style.src)return!0}else if(i.style.size||i.style.italic||i.style.isImage||i.style.outline)return!0}else if(n.style&&(n.style.size||n.style.italic||n.style.isImage||n.style.outline))return!0}return!1}},{key:"_addRichTextImageElement",value:function(e){if(e.style){var t=e.style.src,i=this._imageAtlas&&t&&this._imageAtlas.getSpriteFrame(t);if(i){var n=new eE("RICHTEXT_Image_CHILD"),r=n.addComponent(zC);n.setAnchorPoint(0,0),r.type=zC.Type.SLICED,r.sizeMode=zC.SizeMode.CUSTOM,this.node.addChild(n);var a={node:n,comp:r,lineCount:0,clickHandler:"",styleIndex:0};this._labelSegments.push(a);var s=i.getRect(),o=1,l=s.width,u=s.height,c=e.style.imageWidth,h=e.style.imageHeight;if(void 0!==h&&h>0&&h<this.lineHeight?(l*=o=h/u,u*=o):(l*=o=this.lineHeight/u,u*=o),void 0!==c&&c>0&&(l=c),this.maxWidth>0?(this._lineOffsetX+l>this.maxWidth&&this._updateLineInfo(),this._lineOffsetX+=l):(this._lineOffsetX+=l,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX)),r.spriteFrame=i,n.setContentSize(l,u),a.lineCount=this._lineCount,e.style.event){var f="click";e.style.event[f]&&(a.clickHandler=e.style.event[f])}}else N(4400)}}},{key:"_updateRichText",value:function(){if(this.enabled){var e=KG.parse(this._string);if(!this._needsUpdateTextLayout(e))return this._textArray=e.slice(),void this._updateLabelSegmentTextAttributes();this._textArray=e.slice(),this._resetState();for(var t,i=!1,n=0;n<this._textArray.length;++n){var r=this._textArray[n],a=r.text;if(void 0!==a){if(""===a){if(r.style&&r.style.isNewLine){this._updateLineInfo();continue}if(r.style&&r.style.isImage&&this.imageAtlas){this._addRichTextImageElement(r);continue}}for(var s=a.split("\n"),o=0;o<s.length;++o){var l=s[o];if(""!==l)if(i=!1,this.maxWidth>0){var u=this._measureText(n,l);this._updateRichTextWithMaxWidth(l,u,n),s.length>1&&o<s.length-1&&this._updateLineInfo()}else t=this._addLabelSegment(l,n).node.getContentSize(),this._lineOffsetX+=t.width,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX),s.length>1&&o<s.length-1&&this._updateLineInfo();else{if(this._isLastComponentCR(a)&&o===s.length-1)continue;this._updateLineInfo(),i=!0}}}}i||this._linesWidth.push(this._lineOffsetX),this.maxWidth>0&&(this._labelWidth=this.maxWidth),this._labelHeight=this._lineCount*this.lineHeight,this.node.setContentSize(this._labelWidth,this._labelHeight),this._updateRichTextPosition(),this._layoutDirty=!1}}},{key:"_getFirstWordLen",value:function(e,t,i){var n=e.charAt(t);if(rs(n)||as(n))return 1;for(var r=1,a=t+1;a<i&&(!as(n=e.charAt(a))&&!rs(n));++a)r++;return r}},{key:"_updateRichTextPosition",value:function(){var e=0,t=1,i=this._lineCount,n=this._labelSegments,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s,l=o.lineCount;l>t&&(e=0,t=l);var u=this.node.anchorX,c=this._labelWidth*(.5*this.horizontalAlign-u);switch(this.horizontalAlign){case sN.LEFT:break;case sN.CENTER:c-=this._linesWidth[l-1]/2;break;case sN.RIGHT:c-=this._linesWidth[l-1]}var h=o.node.position,f=this.node.anchorY;o.node.setPosition(e+c,this.lineHeight*(i-l)-this._labelHeight*f,h.z),l===t&&(e+=o.node.width)}}},{key:"_convertLiteralColorValue",value:function(e){var t=e.toUpperCase();return rr[t]?rr[t]:(new rr).fromHEX(e)}},{key:"_applyTextAttribute",value:function(e){var t=e.node.getComponent(hN);if(t){var i,n=e.styleIndex;t.lineHeight=this.lineHeight,t.horizontalAlign=sN.LEFT,t.verticalAlign=oN.CENTER,this._textArray[n]&&(i=this._textArray[n].style);var r=e.node.getComponent(hN);if(r&&(i&&i.color?r.color=this._convertLiteralColorValue(i.color):r.color=this._convertLiteralColorValue("white")),t.isBold=!(!i||!i.bold),t.isItalic=!(!i||!i.italic),t.isUnderline=!(!i||!i.underline),i&&i.outline){var a=e.node.getComponent(YG);a||(a=e.node.addComponent(YG)),a.color=this._convertLiteralColorValue(i.outline.color),a.width=i.outline.width}if(i&&i.size?t.fontSize=i.size:t.fontSize=this._fontSize,t.updateRenderData(!0),i&&i.event){var s="click";i.event[s]&&(e.clickHandler=i.event[s])}}}},{key:"_anchorChanged",value:function(){this._updateRichTextPosition()}}]),t}(Jw),XG.HorizontalAlign=sN,XG.VerticalAlign=oN,v((FG=qG).prototype,"string",[RG],Object.getOwnPropertyDescriptor(FG.prototype,"string"),FG.prototype),v(FG.prototype,"horizontalAlign",[kG],Object.getOwnPropertyDescriptor(FG.prototype,"horizontalAlign"),FG.prototype),v(FG.prototype,"fontSize",[OG],Object.getOwnPropertyDescriptor(FG.prototype,"fontSize"),FG.prototype),v(FG.prototype,"font",[IG],Object.getOwnPropertyDescriptor(FG.prototype,"font"),FG.prototype),v(FG.prototype,"maxWidth",[MG],Object.getOwnPropertyDescriptor(FG.prototype,"maxWidth"),FG.prototype),v(FG.prototype,"lineHeight",[LG],Object.getOwnPropertyDescriptor(FG.prototype,"lineHeight"),FG.prototype),v(FG.prototype,"imageAtlas",[PG],Object.getOwnPropertyDescriptor(FG.prototype,"imageAtlas"),FG.prototype),v(FG.prototype,"handleTouchEvent",[BG],Object.getOwnPropertyDescriptor(FG.prototype,"handleTouchEvent"),FG.prototype),NG=v(FG.prototype,"_lineHeight",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),zG=v(FG.prototype,"_string",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"<color=#00ff00>Rich</c><color=#0fffff>Text</color>"}}),UG=v(FG.prototype,"_horizontalAlign",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return sN.LEFT}}),GG=v(FG.prototype,"_fontSize",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),VG=v(FG.prototype,"_maxWidth",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),HG=v(FG.prototype,"_font",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),WG=v(FG.prototype,"_imageAtlas",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),jG=v(FG.prototype,"_handleTouchEvent",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),DG=FG))||DG)||DG)||DG)||DG));cc.RichTextComponent=_V;var dV,pV=new zi,mV=new zi,vV=new zi,gV=(new Xn,new Mi,new Mi),yV=new rr;!function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL"}(dV||(dV={})),pt(dV);var bV,EV=e("ScrollBarComponent",(QG=Es("cc.ScrollBarComponent"),JG=Rs(110),$G=Cs("UI/ScrollBar"),eV=Ts({type:zC,tooltip:" Sprite"}),tV=Ts({type:dV,tooltip:"ScrollBar "}),iV=Ts({tooltip:" ScrollBar"}),nV=Ts({tooltip:"\n enableAutoHide  true "}),QG(rV=JG(rV=$G((fV=hV=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),s=0;s<r;s++)a[s]=arguments[s];return m(n=c(this,(e=o(t)).call.apply(e,[this].concat(a))),"_scrollView",sV,u(n)),m(n,"_handle",oV,u(n)),m(n,"_direction",lV,u(n)),m(n,"_enableAutoHide",uV,u(n)),m(n,"_autoHideTime",cV,u(n)),n._touching=!1,n._opacity=255,n._autoHideRemainingTime=0,n}return s(t,e),r(t,[{key:"hide",value:function(){this._autoHideRemainingTime=0,this._setOpacity(0)}},{key:"show",value:function(){this._autoHideRemainingTime=this._autoHideTime,this._setOpacity(this._opacity)}},{key:"onScroll",value:function(e){if(this._scrollView){var t=this._scrollView.content;if(t){var i=t.getContentSize(),n=this._scrollView.node.getContentSize(),r=this.node.getContentSize();if(!this._conditionalDisableScrollBar(i,n)){this._enableAutoHide&&(this._autoHideRemainingTime=this._autoHideTime,this._setOpacity(this._opacity));var a=0,s=0,o=0,l=0,u=0;this._direction===dV.HORIZONTAL?(a=i.width,s=n.width,u=r.width,o=e.x,l=-this._convertToScrollViewSpace(t).x):this._direction===dV.VERTICAL&&(a=i.height,s=n.height,u=r.height,o=e.y,l=-this._convertToScrollViewSpace(t).y);var c=this._calculateLength(a,s,u,o),h=this._calculatePosition(a,s,u,l,o,c);this._updateLength(c),this._updateHandlerPosition(h)}}}}},{key:"setScrollView",value:function(e){this._scrollView=e}},{key:"onTouchBegan",value:function(){this._enableAutoHide&&(this._touching=!0)}},{key:"onTouchEnded",value:function(){if(this._enableAutoHide&&(this._touching=!1,!(this._autoHideTime<=0))){if(this._scrollView){var e=this._scrollView.content;if(e){var t=e.getContentSize(),i=this._scrollView.node.getContentSize();if(this._conditionalDisableScrollBar(t,i))return}}this._autoHideRemainingTime=this._autoHideTime}}},{key:"onEnable",value:function(){var e=this.node.getComponent(zC);e&&(this._opacity=e.color.a)}},{key:"start",value:function(){this._enableAutoHide&&this._setOpacity(0)}},{key:"update",value:function(e){this._processAutoHide(e)}},{key:"_convertToScrollViewSpace",value:function(e){if(!this._scrollView)return pV;var t=this._scrollView.node._uiProps.uiTransformComp,i=e._uiProps.uiTransformComp;if(!t||!i)return pV;mV.set(-e.anchorX*e.width,-e.anchorY*e.height,0),i.convertToWorldSpaceAR(mV,vV);var n=t.convertToNodeSpaceAR(vV);return n.x+=t.anchorX*t.width,n.y+=t.anchorY*t.height,n}},{key:"_setOpacity",value:function(e){if(this._handle){var t=this.node.getComponent(zC);t&&(yV.set(t.color),yV.a=e,t.color=yV),(t=this._handle.getComponent(zC))&&(yV.set(t.color),yV.a=e,t.color=yV)}}},{key:"_updateHandlerPosition",value:function(e){if(this._handle){var t=this._fixupHandlerPosition();this._handle.node.setPosition(e.x+t.x,e.y+t.y,t.z)}}},{key:"_fixupHandlerPosition",value:function(){var e=this.node.getContentSize(),t=this.node.getAnchorPoint(),i=this.handle.node.getContentSize(),n=this.handle.node.parent;zi.set(mV,-e.width*t.x,-e.height*t.y,0);var r=this.node._uiProps.uiTransformComp.convertToWorldSpaceAR(mV,vV),a=new zi;return n._uiProps.uiTransformComp.convertToNodeSpaceAR(r,a),this.direction===dV.HORIZONTAL?a=new zi(a.x,a.y+(e.height-i.height)/2,0):this.direction===dV.VERTICAL&&(a=new zi(a.x+(e.width-i.width)/2,a.y,0)),this.handle.node.setPosition(a),a}},{key:"_conditionalDisableScrollBar",value:function(e,t){return e.width<=t.width&&this._direction===dV.HORIZONTAL||e.height<=t.height&&this._direction===dV.VERTICAL}},{key:"_calculateLength",value:function(e,t,i,n){var r=e;return n&&(r+=20*(n>0?n:-n)),i*(t/r)}},{key:"_calculatePosition",value:function(e,t,i,n,r,a){var s=e-t;r&&(s+=Math.abs(r));var o=0;s&&(o=di(o=n/s));var l=(i-a)*o;return this._direction===dV.VERTICAL?new zi(0,l,0):new zi(l,0,0)}},{key:"_updateLength",value:function(e){if(this._handle){var t=this._handle.node,i=t.getContentSize(),n=t.getAnchorPoint();n.x===gV.x&&n.y===gV.y||t.setAnchorPoint(gV),this._direction===dV.HORIZONTAL?t.setContentSize(e,i.height):t.setContentSize(i.width,e)}}},{key:"_processAutoHide",value:function(e){if(this._enableAutoHide&&!(this._autoHideRemainingTime<=0)&&!this._touching&&(this._autoHideRemainingTime-=e,this._autoHideRemainingTime<=this._autoHideTime)){this._autoHideRemainingTime=Math.max(0,this._autoHideRemainingTime);var t=this._opacity*(this._autoHideRemainingTime/this._autoHideTime);this._setOpacity(t)}}},{key:"handle",get:function(){return this._handle},set:function(e){this._handle!==e&&(this._handle=e,this.onScroll(new zi(0,0,0)))}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e,this.onScroll(new zi))}},{key:"enableAutoHide",get:function(){return this._enableAutoHide},set:function(e){this._enableAutoHide!==e&&(this._enableAutoHide=e,this._enableAutoHide&&this._setOpacity(0))}},{key:"autoHideTime",get:function(){return this._autoHideTime},set:function(e){this._autoHideTime!==e&&(this._autoHideTime=e)}}]),t}(Ph),hV.Direction=dV,v((aV=fV).prototype,"handle",[eV],Object.getOwnPropertyDescriptor(aV.prototype,"handle"),aV.prototype),v(aV.prototype,"direction",[tV],Object.getOwnPropertyDescriptor(aV.prototype,"direction"),aV.prototype),v(aV.prototype,"enableAutoHide",[iV],Object.getOwnPropertyDescriptor(aV.prototype,"enableAutoHide"),aV.prototype),v(aV.prototype,"autoHideTime",[nV],Object.getOwnPropertyDescriptor(aV.prototype,"autoHideTime"),aV.prototype),sV=v(aV.prototype,"_scrollView",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),oV=v(aV.prototype,"_handle",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lV=v(aV.prototype,"_direction",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return dV.HORIZONTAL}}),uV=v(aV.prototype,"_enableAutoHide",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),cV=v(aV.prototype,"_autoHideTime",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),rV=aV))||rV)||rV)||rV));cc.ScrollBarComponent=EV;var TV,SV,xV,AV,wV,CV,RV,kV,OV,IV,MV,LV,PV,BV,DV,FV,NV,zV,UV,GV,VV,HV,WV,jV,XV,qV,YV,KV,ZV,QV=e("ViewGroupComponent",Es("cc.ViewGroupComponent")(bV=Rs(110)(bV=function(e){function t(){return i(this,t),c(this,o(t).apply(this,arguments))}return s(t,e),t}(Ph))||bV)||bV);cc.ViewGroupComponent=QV;var JV,$V=new zi,eH=new zi,tH=new zi,iH=new Mi,nH=new Mi,rH=function(){return(new Date).getMilliseconds()},aH={"scroll-to-top":0,"scroll-to-bottom":1,"scroll-to-left":2,"scroll-to-right":3,scrolling:4,"bounce-bottom":6,"bounce-left":7,"bounce-right":8,"bounce-top":5,"scroll-ended":9,"touch-up":10,"scroll-ended-with-threshold":11,"scroll-began":12};!function(e){e.SCROLL_TO_TOP="scroll-to-top",e.SCROLL_TO_BOTTOM="scroll-to-bottom",e.SCROLL_TO_LEFT="scroll-to-left",e.SCROLL_TO_RIGHT="scroll-to-right",e.SCROLL_BEGAN="scroll-began",e.SCROLL_ENDED="scroll-ended",e.BOUNCE_TOP="bounce-top",e.BOUNCE_BOTTOM="bounce-bottom",e.BOUNCE_LEFT="bounce-left",e.BOUNCE_RIGHT="bounce-right",e.SCROLLING="scrolling",e.SCROLL_ENG_WITH_THRESHOLD="scroll-ended-with-threshold",e.TOUCH_UP="touch-up"}(JV||(JV={}));var sH,oH,lH,uH,cH,hH,fH,_H,dH,pH,mH,vH,gH,yH,bH,EH=e("ScrollViewComponent",(TV=Es("cc.ScrollViewComponent"),SV=Rs(110),xV=Cs("UI/ScrollView"),AV=Ts({type:o_,tooltip:""}),wV=Ts({type:EV,tooltip:" ScrollBar"}),CV=Ts({type:EV,tooltip:" ScrollBar"}),RV=Ts({tooltip:""}),kV=Ts({tooltip:""}),OV=Ts({tooltip:""}),IV=Ts({range:[0,1,.1],tooltip:"0 1 "}),MV=Ts({tooltip:""}),LV=Ts({range:[0,10],tooltip:"0 "}),PV=Ts({type:[gR],tooltip:""}),BV=Ts({tooltip:""}),TV(DV=SV(DV=xV((ZV=KV=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),s=0;s<r;s++)a[s]=arguments[s];return m(n=c(this,(e=o(t)).call.apply(e,[this].concat(a))),"horizontal",NV,u(n)),m(n,"vertical",zV,u(n)),m(n,"inertia",UV,u(n)),m(n,"brake",GV,u(n)),m(n,"elastic",VV,u(n)),m(n,"bounceDuration",HV,u(n)),m(n,"scrollEvents",WV,u(n)),m(n,"cancelInnerEvents",jV,u(n)),n._autoScrolling=!1,n._scrolling=!1,m(n,"_content",XV,u(n)),m(n,"_horizontalScrollBar",qV,u(n)),m(n,"_verticalScrollBar",YV,u(n)),n._topBoundary=0,n._bottomBoundary=0,n._leftBoundary=0,n._rightBoundary=0,n._touchMoveDisplacements=[],n._touchMoveTimeDeltas=[],n._touchMovePreviousTimestamp=0,n._touchMoved=!1,n._autoScrollAttenuate=!1,n._autoScrollStartPosition=new zi,n._autoScrollTargetDelta=new zi,n._autoScrollTotalTime=0,n._autoScrollAccumulatedTime=0,n._autoScrollCurrentlyOutOfBoundary=!1,n._autoScrollBraking=!1,n._autoScrollBrakingStartPosition=new zi,n._outOfBoundaryAmount=new zi,n._outOfBoundaryAmountDirty=!0,n._stopMouseWheel=!1,n._mouseWheelEventElapsedTime=0,n._isScrollEndedWithThresholdEventFired=!1,n._scrollEventEmitMask=0,n._isBouncing=!1,n._contentPos=new zi,n._deltaPos=new zi,n}return s(t,e),r(t,[{key:"scrollToBottom",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=this._calculateMovePercentDelta({anchor:new Mi(0,0),applyToHorizontal:!1,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i,!0)}},{key:"scrollToTop",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=this._calculateMovePercentDelta({anchor:new Mi(0,1),applyToHorizontal:!1,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToLeft",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=this._calculateMovePercentDelta({anchor:new Mi(0,0),applyToHorizontal:!0,applyToVertical:!1});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToRight",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=this._calculateMovePercentDelta({anchor:new Mi(1,0),applyToHorizontal:!0,applyToVertical:!1});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToTopLeft",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=this._calculateMovePercentDelta({anchor:new Mi(0,1),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToTopRight",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=this._calculateMovePercentDelta({anchor:new Mi(1,1),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToBottomLeft",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=this._calculateMovePercentDelta({anchor:new Mi(0,0),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToBottomRight",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=this._calculateMovePercentDelta({anchor:new Mi(1,0),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToOffset",value:function(e,t){var i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],n=this.getMaxScrollOffset(),r=new Mi(0,0);0===n.x?r.x=0:r.x=e.x/n.x,0===n.y?r.y=1:r.y=(n.y-e.y)/n.y,this.scrollTo(r,t,i)}},{key:"getScrollOffset",value:function(){var e=this._getContentTopBoundary()-this._topBoundary,t=this._getContentLeftBoundary()-this._leftBoundary;return new zi(t,e,0)}},{key:"getMaxScrollOffset",value:function(){var e=this.node._uiProps.uiTransformComp.contentSize,t=this._content._uiProps.uiTransformComp.contentSize,i=t.width-e.width,n=t.height-e.height;return new zi(i=i>=0?i:0,n=n>=0?n:0,0)}},{key:"scrollToPercentHorizontal",value:function(e,t,i){var n=this._calculateMovePercentDelta({anchor:new Mi(e,0),applyToHorizontal:!0,applyToVertical:!1});t?this._startAutoScroll(n,t,!1!==i):this._moveContent(n)}},{key:"scrollTo",value:function(e,t,i){var n=this._calculateMovePercentDelta({anchor:new Mi(e),applyToHorizontal:!0,applyToVertical:!0});t?this._startAutoScroll(n,t,i):this._moveContent(n)}},{key:"scrollToPercentVertical",value:function(e,t,i){var n=this._calculateMovePercentDelta({anchor:new Mi(0,e),applyToHorizontal:!1,applyToVertical:!0});t?this._startAutoScroll(n,t,i):this._moveContent(n)}},{key:"stopAutoScroll",value:function(){this._autoScrolling=!1,this._autoScrollAccumulatedTime=this._autoScrollTotalTime}},{key:"setContentPosition",value:function(e){var t=this.getContentPosition();Math.abs(e.x-t.x)<1e-4&&Math.abs(e.y-t.y)<1e-4||(this._content.setPosition(e),this._outOfBoundaryAmountDirty=!0)}},{key:"getContentPosition",value:function(){return this._content?(this._contentPos.set(this._content.position),this._contentPos):$V}},{key:"isScrolling",value:function(){return this._scrolling}},{key:"isAutoScrolling",value:function(){return this._autoScrolling}},{key:"getScrollEndedEventTiming",value:function(){return 1e-4}},{key:"start",value:function(){this._calculateBoundary(),this._content&&vR.once(sR.EVENT_BEFORE_DRAW,this._adjustContentOutOfBoundary,this)}},{key:"onEnable",value:function(){this._registerEvent(),this.content&&(this.content.on(o_.EventType.SIZE_CHANGED,this._calculateBoundary,this),this.content.on(o_.EventType.TRANSFORM_CHANGED,this._scaleChanged,this),this.view&&(this.view.on(o_.EventType.TRANSFORM_CHANGED,this._scaleChanged,this),this.view.on(o_.EventType.SIZE_CHANGED,this._calculateBoundary,this))),this._calculateBoundary(),this._showScrollBar()}},{key:"update",value:function(e){this._autoScrolling&&this._processAutoScrolling(e)}},{key:"onDisable",value:function(){this._unregisterEvent(),this.content&&(this.content.off(o_.EventType.SIZE_CHANGED,this._calculateBoundary,this),this.content.off(o_.EventType.TRANSFORM_CHANGED,this._scaleChanged,this),this.view&&(this.view.off(o_.EventType.TRANSFORM_CHANGED,this._scaleChanged,this),this.view.off(o_.EventType.SIZE_CHANGED,this._calculateBoundary,this))),this._hideScrollBar(),this.stopAutoScroll()}},{key:"_registerEvent",value:function(){this.node.on(o_.EventType.TOUCH_START,this._onTouchBegan,this,!0),this.node.on(o_.EventType.TOUCH_MOVE,this._onTouchMoved,this,!0),this.node.on(o_.EventType.TOUCH_END,this._onTouchEnded,this,!0),this.node.on(o_.EventType.TOUCH_CANCEL,this._onTouchCancelled,this,!0),this.node.on(o_.EventType.MOUSE_WHEEL,this._onMouseWheel,this,!0)}},{key:"_unregisterEvent",value:function(){this.node.off(o_.EventType.TOUCH_START,this._onTouchBegan,this,!0),this.node.off(o_.EventType.TOUCH_MOVE,this._onTouchMoved,this,!0),this.node.off(o_.EventType.TOUCH_END,this._onTouchEnded,this,!0),this.node.off(o_.EventType.TOUCH_CANCEL,this._onTouchCancelled,this,!0),this.node.off(o_.EventType.MOUSE_WHEEL,this._onMouseWheel,this,!0)}},{key:"_onMouseWheel",value:function(e,t){if(this.enabledInHierarchy&&!this._hasNestedViewGroup(e,t)){var i=new zi,n=e.getScrollY();this.vertical?i.set(0,-.1*n,0):this.horizontal&&i.set(-.1*n,0,0),this._mouseWheelEventElapsedTime=0,this._processDeltaMove(i),this._stopMouseWheel||(this._handlePressLogic(),this.schedule(this._checkMouseWheel,1/60,NaN,0),this._stopMouseWheel=!0),this._stopPropagationIfTargetIsMe(e)}}},{key:"_onTouchBegan",value:function(e,t){this.enabledInHierarchy&&this._content&&(this._hasNestedViewGroup(e,t)||(this._content&&this._handlePressLogic(),this._touchMoved=!1,this._stopPropagationIfTargetIsMe(e)))}},{key:"_onTouchMoved",value:function(e,t){if(this.enabledInHierarchy&&this._content&&!this._hasNestedViewGroup(e,t)){var i=e.touch;if(this._content&&this._handleMoveLogic(i),this.cancelInnerEvents){var n=i.getUILocation(iH);if(n.subtract(i.getUIStartLocation(nH)),n.length()>7&&!this._touchMoved&&e.target!==this.node){var r=new eh(e.getTouches(),e.bubbles);r.type=o_.EventType.TOUCH_CANCEL,r.touch=e.touch,r.simulate=!0,e.target.dispatchEvent(r),this._touchMoved=!0}this._stopPropagationIfTargetIsMe(e)}}}},{key:"_onTouchEnded",value:function(e,t){if(this.enabledInHierarchy&&this._content&&e&&!this._hasNestedViewGroup(e,t)){this._dispatchEvent(JV.TOUCH_UP);var i=e.touch;this._content&&this._handleReleaseLogic(i),this._touchMoved?e.propagationStopped=!0:this._stopPropagationIfTargetIsMe(e)}}},{key:"_onTouchCancelled",value:function(e,t){if(this.enabledInHierarchy&&this._content&&!this._hasNestedViewGroup(e,t)){if(e&&!e.simulate){var i=e.touch;this._content&&this._handleReleaseLogic(i)}this._stopPropagationIfTargetIsMe(e)}}},{key:"_calculateBoundary",value:function(){if(this.content){var e=this.content.getComponent(CU);e&&e.enabledInHierarchy&&e.updateLayout();var t=this.view._uiProps.uiTransformComp.contentSize,i=t.width*this.view.anchorX,n=t.height*this.view.anchorY;this._leftBoundary=-i,this._bottomBoundary=-n,this._rightBoundary=this._leftBoundary+t.width,this._topBoundary=this._bottomBoundary+t.height,this._moveContentToTopLeft(t)}}},{key:"_hasNestedViewGroup",value:function(e,t){if(e&&e.eventPhase===Jc.CAPTURING_PHASE){if(t){var i=t,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;if(this.node===s)return!(!e.target||!e.target.getComponent(QV));if(s.getComponent(QV))return!0}}return!1}}},{key:"_startInertiaScroll",value:function(e){var t=new zi(e);t.multiplyScalar(.7),this._startAttenuatingAutoScroll(t,e)}},{key:"_calculateAttenuatedFactor",value:function(e){return this.brake<=0?1-this.brake:(1-this.brake)*(1/(1+14e-6*e+e*e*8e-9))}},{key:"_startAttenuatingAutoScroll",value:function(e,t){var i=this._calculateAutoScrollTimeByInitialSpeed(t.length()),n=new zi(e);n.normalize();var r=this._content._uiProps.uiTransformComp.contentSize,a=this.node._uiProps.uiTransformComp.contentSize,s=r.width-a.width,o=r.height-a.height,l=this._calculateAttenuatedFactor(s),u=this._calculateAttenuatedFactor(o);n.x=n.x*s*(1-this.brake)*l,n.y=n.y*o*u*(1-this.brake),n.z=0;var c=e.length(),h=n.length()/c;if(n.add(e),this.brake>0&&h>7){h=Math.sqrt(h);var f=new zi(e);f.multiplyScalar(h),n.set(f),n.add(e)}this.brake>0&&h>3&&(i*=h=3),0===this.brake&&h>1&&(i*=h),this._startAutoScroll(n,i,!0)}},{key:"_calculateAutoScrollTimeByInitialSpeed",value:function(e){return Math.sqrt(Math.sqrt(e/5))}},{key:"_startAutoScroll",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=this._flattenVectorByDirection(e);this._autoScrolling=!0,this._autoScrollTargetDelta=n,this._autoScrollAttenuate=i,zi.copy(this._autoScrollStartPosition,this.getContentPosition()),this._autoScrollTotalTime=t,this._autoScrollAccumulatedTime=0,this._autoScrollBraking=!1,this._isScrollEndedWithThresholdEventFired=!1,this._autoScrollBrakingStartPosition=new zi;var r=this._getHowMuchOutOfBoundary();r.equals($V,1e-4)||(this._autoScrollCurrentlyOutOfBoundary=!0)}},{key:"_calculateTouchMoveVelocity",value:function(){var e=0;if((e=this._touchMoveTimeDeltas.reduce((function(e,t){return e+t}),e))<=0||e>=.5)return new zi;var t=new zi;return t=this._touchMoveDisplacements.reduce((function(e,t){return e.add(t),e}),t),new zi(t.x*(1-this.brake)/e,t.y*(1-this.brake)/e,0)}},{key:"_flattenVectorByDirection",value:function(e){var t=e;return t.x=this.horizontal?t.x:0,t.y=this.vertical?t.y:0,t}},{key:"_moveContent",value:function(e,t){var i=this._flattenVectorByDirection(e);eH.set(this.getContentPosition()),eH.add(i),eH.set(1e-4*Math.floor(1e4*eH.x),1e-4*Math.floor(1e4*eH.y),eH.z),this.setContentPosition(eH);var n=this._getHowMuchOutOfBoundary();this._updateScrollBar(n),this.elastic&&t&&this._startBounceBackIfNeeded()}},{key:"_getContentLeftBoundary",value:function(){return this.getContentPosition().x-this._content.anchorX*this._content.width}},{key:"_getContentRightBoundary",value:function(){return this._getContentLeftBoundary()+this._content.width}},{key:"_getContentTopBoundary",value:function(){return this._getContentBottomBoundary()+this._content.height}},{key:"_getContentBottomBoundary",value:function(){return this.getContentPosition().y-this._content.anchorY*this._content.height}},{key:"_getHowMuchOutOfBoundary",value:function(e){if((e=e||new zi).equals($V,1e-4)&&!this._outOfBoundaryAmountDirty)return this._outOfBoundaryAmount;var t=new zi;return this._getContentLeftBoundary()+e.x>this._leftBoundary?t.x=this._leftBoundary-(this._getContentLeftBoundary()+e.x):this._getContentRightBoundary()+e.x<this._rightBoundary&&(t.x=this._rightBoundary-(this._getContentRightBoundary()+e.x)),this._getContentTopBoundary()+e.y<this._topBoundary?t.y=this._topBoundary-(this._getContentTopBoundary()+e.y):this._getContentBottomBoundary()+e.y>this._bottomBoundary&&(t.y=this._bottomBoundary-(this._getContentBottomBoundary()+e.y)),e.equals($V,1e-4)&&(this._outOfBoundaryAmount=t,this._outOfBoundaryAmountDirty=!1),t=this._clampDelta(t)}},{key:"_updateScrollBar",value:function(e){this._horizontalScrollBar&&this._horizontalScrollBar.onScroll(e),this.verticalScrollBar&&this.verticalScrollBar.onScroll(e)}},{key:"_onScrollBarTouchBegan",value:function(){this._horizontalScrollBar&&this._horizontalScrollBar.onTouchBegan(),this.verticalScrollBar&&this.verticalScrollBar.onTouchBegan()}},{key:"_onScrollBarTouchEnded",value:function(){this._horizontalScrollBar&&this._horizontalScrollBar.onTouchEnded(),this.verticalScrollBar&&this.verticalScrollBar.onTouchEnded()}},{key:"_dispatchEvent",value:function(e){if(e===JV.SCROLL_ENDED)this._scrollEventEmitMask=0;else if(e===JV.SCROLL_TO_TOP||e===JV.SCROLL_TO_BOTTOM||e===JV.SCROLL_TO_LEFT||e===JV.SCROLL_TO_RIGHT){var t=1<<aH[e];if(this._scrollEventEmitMask&t)return;this._scrollEventEmitMask|=t}gR.emitEvents(this.scrollEvents,this,aH[e]),this.node.emit(e,this)}},{key:"_adjustContentOutOfBoundary",value:function(){if(this._content&&(this._outOfBoundaryAmountDirty=!0,this._isOutOfBoundary())){var e=this._getHowMuchOutOfBoundary();eH.set(this.getContentPosition()),eH.add(e),this._content&&(this._content.setPosition(eH),this._updateScrollBar($V))}}},{key:"_hideScrollBar",value:function(){this._horizontalScrollBar&&this._horizontalScrollBar.hide(),this._verticalScrollBar&&this._verticalScrollBar.hide()}},{key:"_showScrollBar",value:function(){this._horizontalScrollBar&&this._horizontalScrollBar.show(),this._verticalScrollBar&&this._verticalScrollBar.show()}},{key:"_stopPropagationIfTargetIsMe",value:function(e){e.eventPhase===Jc.AT_TARGET&&e.target===this.node&&(e.propagationStopped=!0)}},{key:"_processDeltaMove",value:function(e){this._scrollChildren(e),this._gatherTouchMove(e)}},{key:"_handleMoveLogic",value:function(e){this._deltaPos.set(this._getLocalAxisAlignDelta(e)),this._processDeltaMove(this._deltaPos)}},{key:"_handleReleaseLogic",value:function(e){this._deltaPos.set(this._getLocalAxisAlignDelta(e)),this._gatherTouchMove(this._deltaPos),this._processInertiaScroll(),this._scrolling&&(this._scrolling=!1,this._autoScrolling||this._dispatchEvent(JV.SCROLL_ENDED))}},{key:"_getLocalAxisAlignDelta",value:function(e){var t=this.node._uiProps.uiTransformComp,i=new zi;return t&&(e.getUILocation(iH),e.getUIPreviousLocation(nH),eH.set(iH.x,iH.y,0),tH.set(nH.x,nH.y,0),t.convertToNodeSpaceAR(eH,eH),t.convertToNodeSpaceAR(tH,tH),zi.subtract(i,eH,tH)),i}},{key:"_scrollChildren",value:function(e){var t,i,n=e=this._clampDelta(e);this.elastic&&(t=this._getHowMuchOutOfBoundary(),n.x*=0===t.x?1:.5,n.y*=0===t.y?1:.5),this.elastic||(t=this._getHowMuchOutOfBoundary(n),n.add(t));var r=this._content.position;if(n.y>0)r.y-this._content.anchorY*this._content.height+n.y>=this._bottomBoundary&&(i=JV.SCROLL_TO_BOTTOM);else if(n.y<0){r.y-this._content.anchorY*this._content.height+this._content.height+n.y<=this._topBoundary&&(i=JV.SCROLL_TO_TOP)}else if(n.x<0){r.x-this._content.anchorX*this._content.width+this._content.width+n.x<=this._rightBoundary&&(i=JV.SCROLL_TO_RIGHT)}else if(n.x>0){r.x-this._content.anchorX*this._content.width+n.x>=this._leftBoundary&&(i=JV.SCROLL_TO_LEFT)}this._moveContent(n,!1),0===n.x&&0===n.y||(this._scrolling||(this._scrolling=!0,this._dispatchEvent(JV.SCROLL_BEGAN)),this._dispatchEvent(JV.SCROLLING)),i&&i.length>0&&this._dispatchEvent(i)}},{key:"_handlePressLogic",value:function(){this._autoScrolling&&this._dispatchEvent(JV.SCROLL_ENDED),this._autoScrolling=!1,this._isBouncing=!1,this._touchMovePreviousTimestamp=rH(),this._touchMoveDisplacements.length=0,this._touchMoveTimeDeltas.length=0,this._onScrollBarTouchBegan()}},{key:"_clampDelta",value:function(e){var t=this._content._uiProps.uiTransformComp.contentSize,i=this.node._uiProps.uiTransformComp.contentSize;return t.width<i.width&&(e.x=0),t.height<i.height&&(e.y=0),e}},{key:"_gatherTouchMove",value:function(e){var t=e.clone();for(this._clampDelta(t);this._touchMoveDisplacements.length>=5;)this._touchMoveDisplacements.shift(),this._touchMoveTimeDeltas.shift();this._touchMoveDisplacements.push(t);var i=rH();this._touchMoveTimeDeltas.push((i-this._touchMovePreviousTimestamp)/1e3),this._touchMovePreviousTimestamp=i}},{key:"_startBounceBackIfNeeded",value:function(){if(!this.elastic)return!1;var e=this._getHowMuchOutOfBoundary();if((e=this._clampDelta(e)).equals($V,1e-4))return!1;var t=Math.max(this.bounceDuration,0);return this._startAutoScroll(e,t,!0),this._isBouncing||(e.y>0&&this._dispatchEvent(JV.BOUNCE_TOP),e.y<0&&this._dispatchEvent(JV.BOUNCE_BOTTOM),e.x>0&&this._dispatchEvent(JV.BOUNCE_RIGHT),e.x<0&&this._dispatchEvent(JV.BOUNCE_LEFT),this._isBouncing=!0),!0}},{key:"_processInertiaScroll",value:function(){if(!this._startBounceBackIfNeeded()&&this.inertia){var e=this._calculateTouchMoveVelocity();!e.equals(eH,1e-4)&&this.brake<1&&this._startInertiaScroll(e)}this._onScrollBarTouchEnded()}},{key:"_isOutOfBoundary",value:function(){return!this._getHowMuchOutOfBoundary().equals($V,1e-4)}},{key:"_isNecessaryAutoScrollBrake",value:function(){if(this._autoScrollBraking)return!0;if(this._isOutOfBoundary()){if(!this._autoScrollCurrentlyOutOfBoundary)return this._autoScrollCurrentlyOutOfBoundary=!0,this._autoScrollBraking=!0,this._autoScrollBrakingStartPosition=this.getContentPosition(),!0}else this._autoScrollCurrentlyOutOfBoundary=!1;return!1}},{key:"_processAutoScrolling",value:function(e){var t=this._isNecessaryAutoScrollBrake(),i=t?.05:1;this._autoScrollAccumulatedTime+=e*(1/i);var n,r=Math.min(1,this._autoScrollAccumulatedTime/this._autoScrollTotalTime);this._autoScrollAttenuate&&(n=r,r=(n-=1)*n*n*n*n+1);var a=new zi(this._autoScrollTargetDelta);a.multiplyScalar(r);var s=new zi(this._autoScrollStartPosition);s.add(a);var o=Math.abs(r-1)<=1e-4;if(Math.abs(r-1)<=this.getScrollEndedEventTiming()&&!this._isScrollEndedWithThresholdEventFired&&(this._dispatchEvent(JV.SCROLL_ENG_WITH_THRESHOLD),this._isScrollEndedWithThresholdEventFired=!0),this.elastic){var l=new zi(s);l.subtract(this._autoScrollBrakingStartPosition),t&&l.multiplyScalar(i),s.set(this._autoScrollBrakingStartPosition),s.add(l)}else{var u=new zi(s);u.subtract(this.getContentPosition());var c=this._getHowMuchOutOfBoundary(u);c.equals($V,1e-4)||(s.add(c),o=!0)}o&&(this._autoScrolling=!1);var h=new zi(s);h.subtract(this.getContentPosition()),this._moveContent(this._clampDelta(h),o),this._dispatchEvent(JV.SCROLLING),this._autoScrolling||(this._isBouncing=!1,this._scrolling=!1,this._dispatchEvent(JV.SCROLL_ENDED))}},{key:"_checkMouseWheel",value:function(e){if(!this._getHowMuchOutOfBoundary().equals($V,1e-4))return this._processInertiaScroll(),this.unschedule(this._checkMouseWheel),void(this._stopMouseWheel=!1);this._mouseWheelEventElapsedTime+=e,this._mouseWheelEventElapsedTime>.1&&(this._onScrollBarTouchEnded(),this.unschedule(this._checkMouseWheel),this._stopMouseWheel=!1)}},{key:"_calculateMovePercentDelta",value:function(e){var t=e.anchor,i=e.applyToHorizontal,n=e.applyToVertical;this._calculateBoundary(),t.clampf(new Mi(0,0),new Mi(1,1));var r=this.node._uiProps.uiTransformComp.contentSize,a=this._content._uiProps.uiTransformComp.contentSize,s=this._getContentBottomBoundary()-this._bottomBoundary;s=-s;var o=this._getContentLeftBoundary()-this._leftBoundary;o=-o;var l=new zi,u=0;return i&&(u=a.width-r.width,l.x=o-u*t.x),n&&(u=a.height-r.height,l.y=s-u*t.y),l}},{key:"_moveContentToTopLeft",value:function(e){var t=this._content._uiProps.uiTransformComp.contentSize,i=this._getContentBottomBoundary()-this._bottomBoundary;i=-i;var n=new zi,r=0,a=this._getContentLeftBoundary()-this._leftBoundary;a=-a,t.height<e.height?(r=t.height-e.height,n.y=i-r,this.verticalScrollBar&&this.verticalScrollBar.hide()):this.verticalScrollBar&&this.verticalScrollBar.show(),t.width<e.width?(r=t.width-e.width,n.x=a,this._horizontalScrollBar&&this._horizontalScrollBar.hide()):this._horizontalScrollBar&&this._horizontalScrollBar.show(),this._moveContent(n),this._adjustContentOutOfBoundary()}},{key:"_scaleChanged",value:function(e){e===Nu.SCALE&&this._calculateBoundary()}},{key:"content",get:function(){return this._content},set:function(e){this._content!==e&&(this._content=e,this._calculateBoundary())}},{key:"horizontalScrollBar",get:function(){return this._horizontalScrollBar},set:function(e){this._horizontalScrollBar!==e&&(this._horizontalScrollBar=e,this._horizontalScrollBar&&(this._horizontalScrollBar.setScrollView(this),this._updateScrollBar($V)))}},{key:"verticalScrollBar",get:function(){return this._verticalScrollBar},set:function(e){this._verticalScrollBar!==e&&(this._verticalScrollBar=e,this._verticalScrollBar&&(this._verticalScrollBar.setScrollView(this),this._updateScrollBar($V)))}},{key:"view",get:function(){return this._content?this._content.parent:null}}]),t}(QV),KV.EventType=JV,v((FV=ZV).prototype,"content",[AV],Object.getOwnPropertyDescriptor(FV.prototype,"content"),FV.prototype),v(FV.prototype,"horizontalScrollBar",[wV],Object.getOwnPropertyDescriptor(FV.prototype,"horizontalScrollBar"),FV.prototype),v(FV.prototype,"verticalScrollBar",[CV],Object.getOwnPropertyDescriptor(FV.prototype,"verticalScrollBar"),FV.prototype),NV=v(FV.prototype,"horizontal",[RV],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),zV=v(FV.prototype,"vertical",[kV],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),UV=v(FV.prototype,"inertia",[OV],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),GV=v(FV.prototype,"brake",[IV],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),VV=v(FV.prototype,"elastic",[MV],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),HV=v(FV.prototype,"bounceDuration",[LV],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),WV=v(FV.prototype,"scrollEvents",[PV],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),jV=v(FV.prototype,"cancelInnerEvents",[BV],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),XV=v(FV.prototype,"_content",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),qV=v(FV.prototype,"_horizontalScrollBar",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),YV=v(FV.prototype,"_verticalScrollBar",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),DV=FV))||DV)||DV)||DV));cc.ScrollViewComponent=EH;var TH,SH=new zi;!function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical"}(TH||(TH={})),pt(TH);var xH,AH,wH,CH,RH,kH,OH,IH,MH,LH=e("SliderComponent",(sH=Es("cc.SliderComponent"),oH=Rs(110),lH=Cs("UI/Slider"),uH=Ts({type:zC,tooltip:""}),cH=Ts({type:TH,tooltip:""}),hH=Ts({slide:!0,range:[0,1,.01],tooltip:" 0 - 1 "}),fH=Ts({type:gR,tooltip:""}),sH(_H=oH(_H=lH((bH=yH=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),s=0;s<r;s++)a[s]=arguments[s];return m(n=c(this,(e=o(t)).call.apply(e,[this].concat(a))),"slideEvents",pH,u(n)),m(n,"_handle",mH,u(n)),m(n,"_direction",vH,u(n)),m(n,"_progress",gH,u(n)),n._offset=new zi,n._dragging=!1,n._touchHandle=!1,n._handlelocalPos=new zi,n._touchPos=new zi,n}return s(t,e),r(t,[{key:"__preload",value:function(){this._updateHandlePosition()}},{key:"onEnable",value:function(){this._updateHandlePosition(),this.node.on(Kc.TOUCH_START,this._onTouchBegan,this),this.node.on(Kc.TOUCH_MOVE,this._onTouchMoved,this),this.node.on(Kc.TOUCH_END,this._onTouchEnded,this),this.node.on(Kc.TOUCH_CANCEL,this._onTouchCancelled,this),this._handle&&this._handle.isValid&&(this._handle.node.on(Kc.TOUCH_START,this._onHandleDragStart,this),this._handle.node.on(Kc.TOUCH_MOVE,this._onTouchMoved,this),this._handle.node.on(Kc.TOUCH_END,this._onTouchEnded,this))}},{key:"onDisable",value:function(){this.node.off(Kc.TOUCH_START,this._onTouchBegan,this),this.node.off(Kc.TOUCH_MOVE,this._onTouchMoved,this),this.node.off(Kc.TOUCH_END,this._onTouchEnded,this),this.node.off(Kc.TOUCH_CANCEL,this._onTouchCancelled,this),this._handle&&this._handle.isValid&&(this._handle.node.off(Kc.TOUCH_START,this._onHandleDragStart,this),this._handle.node.off(Kc.TOUCH_MOVE,this._onTouchMoved,this),this._handle.node.off(Kc.TOUCH_END,this._onTouchEnded,this))}},{key:"_onHandleDragStart",value:function(e){if(e&&this._handle&&this._handle.node._uiProps.uiTransformComp){this._dragging=!0,this._touchHandle=!0;var t=e.touch.getUILocation();zi.set(this._touchPos,t.x,t.y,0),this._handle.node._uiProps.uiTransformComp.convertToNodeSpaceAR(this._touchPos,this._offset),e.propagationStopped=!0}}},{key:"_onTouchBegan",value:function(e){this._handle&&e&&(this._dragging=!0,this._touchHandle||this._handleSliderLogic(e.touch),e.propagationStopped=!0)}},{key:"_onTouchMoved",value:function(e){this._dragging&&e&&(this._handleSliderLogic(e.touch),e.propagationStopped=!0)}},{key:"_onTouchEnded",value:function(e){this._dragging=!1,this._touchHandle=!1,this._offset=new zi,e&&(e.propagationStopped=!0)}},{key:"_onTouchCancelled",value:function(e){this._dragging=!1,e&&(e.propagationStopped=!0)}},{key:"_handleSliderLogic",value:function(e){this._updateProgress(e),this._emitSlideEvent()}},{key:"_emitSlideEvent",value:function(){gR.emitEvents(this.slideEvents,this),this.node.emit("slide",this)}},{key:"_updateProgress",value:function(e){if(this._handle&&e){var t=e.getUILocation();zi.set(this._touchPos,t.x,t.y,0);var i=this.node._uiProps.uiTransformComp.convertToNodeSpaceAR(this._touchPos,SH);this.direction===TH.Horizontal?this.progress=di(.5+(i.x-this._offset.x)/this.node.width):this.progress=di(.5+(i.y-this._offset.y)/this.node.height)}}},{key:"_updateHandlePosition",value:function(){this._handle&&(this._handlelocalPos.set(this._handle.node.getPosition()),this._direction===TH.Horizontal?this._handlelocalPos.x=-this.node.width*this.node.anchorX+this.progress*this.node.width:this._handlelocalPos.y=-this.node.height*this.node.anchorY+this.progress*this.node.height,this._handle.node.setPosition(this._handlelocalPos))}},{key:"_changeLayout",value:function(){var e=this.node.getContentSize();if(this.node.setContentSize(e.height,e.width),this._handle){var t=this._handle.node.position;this._direction===TH.Horizontal?this._handle.node.setPosition(t.x,0,t.z):this._handle.node.setPosition(0,t.y,t.z),this._updateHandlePosition()}}},{key:"handle",get:function(){return this._handle},set:function(e){this._handle!==e&&(this._handle=e)}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e,this._changeLayout())}},{key:"progress",get:function(){return this._progress},set:function(e){this._progress!==e&&(this._progress=e,this._updateHandlePosition())}}]),t}(Ph),yH.Direction=TH,v((dH=bH).prototype,"handle",[uH],Object.getOwnPropertyDescriptor(dH.prototype,"handle"),dH.prototype),v(dH.prototype,"direction",[cH],Object.getOwnPropertyDescriptor(dH.prototype,"direction"),dH.prototype),v(dH.prototype,"progress",[hH],Object.getOwnPropertyDescriptor(dH.prototype,"progress"),dH.prototype),pH=v(dH.prototype,"slideEvents",[fH],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),mH=v(dH.prototype,"_handle",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),vH=v(dH.prototype,"_direction",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return TH.Horizontal}}),gH=v(dH.prototype,"_progress",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),_H=dH))||_H)||_H)||_H));cc.SliderComponent=LH;var PH,BH,DH,FH,NH,zH,UH,GH,VH,HH,WH,jH,XH,qH,YH,KH,ZH,QH=e("ToggleContainerComponent",(xH=Es("cc.ToggleContainerComponent"),AH=Rs(110),wH=Cs("UI/ToggleContainer"),CH=Ts({type:[gR],tooltip:""}),RH=Ts({tooltip:" true  toggle "}),xH(kH=AH(kH=wH(kH=As((IH=v((OH=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),s=0;s<r;s++)a[s]=arguments[s];return m(n=c(this,(e=o(t)).call.apply(e,[this].concat(a))),"checkEvents",IH,u(n)),m(n,"_allowSwitchOff",MH,u(n)),n._toggleItems=[],n}return s(t,e),r(t,[{key:"start",value:function(){this._makeAtLeastOneToggleChecked()}},{key:"updateToggles",value:function(e){this.enabledInHierarchy&&e.isChecked&&(this.toggleItems.forEach((function(t){t!==e&&t.isChecked&&t.enabled&&(t.isChecked=!1)})),this.checkEvents&&gR.emitEvents(this.checkEvents,e))}},{key:"addToggle",value:function(e){-1===this._toggleItems.indexOf(e)&&this._toggleItems.push(e),this._allowOnlyOneToggleChecked()}},{key:"removeToggle",value:function(e){var t=this._toggleItems.indexOf(e);t>-1&&this._toggleItems.splice(t,1),this._makeAtLeastOneToggleChecked()}},{key:"_allowOnlyOneToggleChecked",value:function(){var e=!1;return this._toggleItems.forEach((function(t){e&&t.enabled&&(t.isChecked=!1),t.isChecked&&t.enabled&&(e=!0)})),e}},{key:"_makeAtLeastOneToggleChecked",value:function(){this._allowOnlyOneToggleChecked()||this._allowSwitchOff||this._toggleItems.length>0&&(this._toggleItems[0].isChecked=!0)}},{key:"allowSwitchOff",get:function(){return this._allowSwitchOff},set:function(e){this._allowSwitchOff=e}},{key:"toggleItems",get:function(){return this._toggleItems}}]),t}(Ph)).prototype,"checkEvents",[CH],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),MH=v(OH.prototype,"_allowSwitchOff",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),v(OH.prototype,"allowSwitchOff",[RH],Object.getOwnPropertyDescriptor(OH.prototype,"allowSwitchOff"),OH.prototype),kH=OH))||kH)||kH)||kH)||kH));function JH(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return Object.assign.apply(Object,[{}].concat(t))}cc.ToggleContainerComponent=QH,function(e){e.TOGGLE="toggle"}(ZH||(ZH={}));var $H,eW=e("ToggleComponent",(PH=Es("cc.ToggleComponent"),BH=Rs(110),DH=Cs("UI/Toggle"),FH=ws(Lf),NH=Ts({tooltip:" true check mark  enabled  disabled "}),zH=Ts({type:QH,tooltip:"Toggle  ToggleGroup null Toggle  CheckBoxToggle  RadioButton"}),UH=Ts({type:zC,tooltip:"Toggle "}),GH=Ts({type:[gR],tooltip:""}),PH(VH=BH(VH=DH(VH=FH((KH=YH=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),s=0;s<r;s++)a[s]=arguments[s];return m(n=c(this,(e=o(t)).call.apply(e,[this].concat(a))),"checkEvents",WH,u(n)),m(n,"_isChecked",jH,u(n)),m(n,"_toggleGroup",XH,u(n)),m(n,"_checkMark",qH,u(n)),n}return s(t,e),r(t,[{key:"onEnable",value:function(){f(o(t.prototype),"onEnable",this).call(this),this._registerToggleEvent(),this._toggleGroup&&this._toggleGroup.enabled&&this._toggleGroup.addToggle(this)}},{key:"onDisable",value:function(){f(o(t.prototype),"onDisable",this).call(this),this._unregisterToggleEvent(),this._toggleGroup&&this._toggleGroup.enabled&&this._toggleGroup.removeToggle(this)}},{key:"toggle",value:function(){var e=this.toggleGroup||this._toggleContainer;e&&e.enabled&&this.isChecked&&!e.allowSwitchOff||(this.isChecked=!this.isChecked,e&&e.enabled&&e.updateToggles(this),this._emitToggleEvents())}},{key:"check",value:function(){var e=this.toggleGroup||this._toggleContainer;e&&e.enabled&&this.isChecked&&!e.allowSwitchOff||(this.isChecked=!0,e&&e.enabled&&e.updateToggles(this),this._emitToggleEvents())}},{key:"uncheck",value:function(){var e=this.toggleGroup||this._toggleContainer;e&&e.enabled&&this.isChecked&&!e.allowSwitchOff||(this.isChecked=!1,this._emitToggleEvents())}},{key:"_updateCheckMark",value:function(){this._checkMark&&(this._checkMark.node.active=!!this.isChecked)}},{key:"_registerToggleEvent",value:function(){this.node.on(t.EventType.CLICK,this.toggle,this)}},{key:"_unregisterToggleEvent",value:function(){this.node.off(t.EventType.CLICK,this.toggle,this)}},{key:"_emitToggleEvents",value:function(){this.node.emit(t.EventType.TOGGLE,this),this.checkEvents&&gR.emitEvents(this.checkEvents,this)}},{key:"isChecked",get:function(){return this._isChecked},set:function(e){this._isChecked!==e&&(this._isChecked=e,this._updateCheckMark())}},{key:"toggleGroup",get:function(){return this._toggleGroup},set:function(e){this._toggleGroup!==e&&(this._toggleGroup&&this._toggleGroup.removeToggle(this),this._toggleGroup=e,this._toggleGroup&&this._toggleGroup.enabled&&this._toggleGroup.addToggle(this))}},{key:"checkMark",get:function(){return this._checkMark},set:function(e){this._checkMark!==e&&(this._checkMark=e)}},{key:"_resizeToTarget",set:function(e){e&&this._resizeNodeToTargetNode()}},{key:"_toggleContainer",get:function(){this.node.parent;return null}}]),t}(EF),YH.EventType=JH(ZH,vF),v((HH=KH).prototype,"isChecked",[NH],Object.getOwnPropertyDescriptor(HH.prototype,"isChecked"),HH.prototype),v(HH.prototype,"toggleGroup",[zH],Object.getOwnPropertyDescriptor(HH.prototype,"toggleGroup"),HH.prototype),v(HH.prototype,"checkMark",[UH],Object.getOwnPropertyDescriptor(HH.prototype,"checkMark"),HH.prototype),WH=v(HH.prototype,"checkEvents",[GH],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),jH=v(HH.prototype,"_isChecked",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),XH=v(HH.prototype,"_toggleGroup",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),qH=v(HH.prototype,"_checkMark",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),VH=HH))||VH)||VH)||VH)||VH));cc.ToggleComponent=eW;var tW,iW,nW,rW=e("UIModelComponent",Es("cc.UIModelComponent")($H=Rs(110)($H=Cs("UI/Model")($H=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),s=0;s<r;s++)a[s]=arguments[s];return(n=c(this,(e=o(t)).call.apply(e,[this].concat(a))))._models=null,n._modelComponent=null,n}return s(t,e),r(t,[{key:"onLoad",value:function(){this.node._uiProps.uiTransformComp||this.node.addComponent("cc.UITransformComponent"),this._modelComponent=this.getComponent("cc.RenderableComponent"),this._modelComponent?(this._modelComponent._sceneGetter=vR.root.ui.getRenderSceneGetter(),this._models=this._modelComponent._collectModels()):console.warn("node '".concat(this.node&&this.node.name,"' doesn't have any renderable component"))}},{key:"onEnable",value:function(){f(o(t.prototype),"onEnable",this).call(this),this._modelComponent&&this._modelComponent._attachToScene()}},{key:"onDisable",value:function(){f(o(t.prototype),"onDisable",this).call(this),this._modelComponent&&this._modelComponent._detachFromScene()}},{key:"onDestroy",value:function(){f(o(t.prototype),"onDestroy",this).call(this),this._modelComponent=this.getComponent("cc.RenderableComponent"),this._modelComponent&&(this._modelComponent._sceneGetter=null,cc.isValid(this._modelComponent,!0)&&this._modelComponent._attachToScene(),this._models=null)}},{key:"updateAssembler",value:function(e){if(this._models){var t=this._models,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r;e.commitModel.call(e,this,a,this._modelComponent.material)}return!0}return!1}},{key:"update",value:function(){this._fitUIRenderQueue()}},{key:"_fitUIRenderQueue",value:function(){if(this._modelComponent){for(var e=this._modelComponent.sharedMaterials.length,t=0;t<e;t++){var i=this._modelComponent.getMaterialInstance(t);if(null!=i)for(var n=i.passes,r=i.effectAsset,a=i.technique,s=n.length,o=0;o<s;o++){if(!n[o].blendState.targets[0].blend)n[o].blendState.targets[0].blend=!0,n[o].overridePipelineStates(r.techniques[a].passes[o],{blendState:n[o].blendState})}}for(var l=0;l<e;l++){var u=this._modelComponent.getMaterialInstance(l);if(null!=u){var c=u.passes,h=Array.isArray(c),f=0;for(c=h?c:c[Symbol.iterator]();;){var _;if(h){if(f>=c.length)break;_=c[f++]}else{if((f=c.next()).done)break;_=f.value}_._priority=mu.MAX-11}}}}}},{key:"modelComponent",get:function(){return this._modelComponent}}]),t}(Jw))||$H)||$H)||$H);cc.UIModelComponent=rW;var aW,sW=new Bn;!function(e){e[e.LOADING=0]="LOADING",e[e.LOADED=1]="LOADED",e[e.ERROR=2]="ERROR",e[e.JS_EVALUATED=3]="JS_EVALUATED"}(aW||(aW={}));var oW={devicePixelRatio:!1,enableDiv:!1};Il.os===Il.OS_IOS&&(oW.enableDiv=!0),Il.isMobile?Il.browserType===Il.BROWSER_TYPE_FIREFOX&&(oW.enableBG=!0):Il.browserType===Il.BROWSER_TYPE_IE&&(oW.closeHistory=!0);var lW,uW,cW,hW,fW,_W,dW,pW,mW,vW,gW,yW=Es("cc.WebviewImpl")((nW=iW=function(){function e(){i(this,e),this._EventList=new Map,this._visible=!1,this._div=null,this._iframe=null,this._forceUpdate=!0,this._m00=0,this._m01=0,this._m04=0,this._m05=0,this._m12=0,this._m13=0,this._w=0,this._h=0,this._eventListeners={load:function(){},error:function(){}}}return r(e,[{key:"createDomElementIfNeeded",value:function(e,t){this._div?this._updateSize(e,t):this._createNativeControl(e,t)}},{key:"removeDom",value:function(){var e=this._div;e&&(ot(cc.game.container,e)&&cc.game.container.removeChild(e),this._div=null);var t=this._iframe;if(t){var i=this._eventListeners;t.removeEventListener("load",i.load),t.removeEventListener("error",i.error),i.load=null,i.error=null,this._iframe=null}}},{key:"loadURL",value:function(t){var i=this._iframe;if(i){i.src=t;var n=this;i.addEventListener("load",(function e(){n._updateVisibility(),i.removeEventListener("load",e)})),this._dispatchEvent(e.EventType.LOADING)}}},{key:"stopLoading",value:function(){D(7800)}},{key:"reload",value:function(){var e=this._iframe;if(e){var t=e.contentWindow;t&&t.location&&t.location.reload()}}},{key:"canGoBack",value:function(){return D(7801),!0}},{key:"canGoForward",value:function(){return D(7802),!0}},{key:"goBack",value:function(){try{if(e.Polyfill.closeHistory)return D(7803);var t=this._iframe;if(t){var i=t.contentWindow;i&&i.location&&i.history.back.call(i)}}catch(e){R(e)}}},{key:"goForward",value:function(){try{if(e.Polyfill.closeHistory)return D(7804);var t=this._iframe;if(t){var i=t.contentWindow;i&&i.location&&i.history.forward.call(i)}}catch(e){R(e)}}},{key:"evaluateJS",value:function(e){var t=this._iframe;if(t)t.contentWindow}},{key:"setScalesPageToFit",value:function(){D(7805)}},{key:"setEventListener",value:function(e,t){this._EventList[e]=t}},{key:"removeEventListener",value:function(e){this._EventList[e]=null}},{key:"_dispatchEvent",value:function(e){var t=this._EventList[e];t&&this._iframe&&t.call(this,this,this._iframe.src)}},{key:"destroy",value:function(){this.removeDom()}},{key:"setVisible",value:function(e){this._visible!==e&&(this._visible=!!e,this._updateVisibility())}},{key:"updateMatrix",value:function(e){if(this._div&&this._visible){e.getWorldMatrix(sW);var t=e.getContentSize();if(this._forceUpdate||this._m00!==sW.m00||this._m01!==sW.m01||this._m04!==sW.m04||this._m05!==sW.m05||this._m12!==sW.m12||this._m13!==sW.m13||this._w!==t.width||this._h!==t.height){this._m00=sW.m00,this._m01=sW.m01,this._m04=sW.m04,this._m05=sW.m05,this._m12=sW.m12,this._m13=sW.m13,this._w=t.width,this._h=t.height;var i=qx.getScaleX(),n=qx.getScaleY(),r=qx.getDevicePixelRatio();i/=r,n/=r;var a=cc.game.container,s=sW.m00*i,o=sW.m01,l=sW.m04,u=sW.m05*n,c=a&&a.style.paddingLeft?parseInt(a.style.paddingLeft):0,h=a&&a.style.paddingBottom?parseInt(a.style.paddingBottom):0;this._updateSize(this._w,this._h);var f=this._div.clientWidth*i,_=this._div.clientHeight*n,d=e.getAnchorPoint(),p=f*sW.m00*d.x,m=_*sW.m05*d.y,v="matrix("+s+","+-o+","+-l+","+u+","+(sW.m12*i-p+c)+","+-(sW.m13*n-m+h)+")";this._div.style.transform=v,this._div.style["-webkit-transform"]=v,this._div.style["transform-origin"]="0px 100% 0px",this._div.style["-webkit-transform-origin"]="0px 100% 0px";var g=e.getComponent(OC);g&&this._setOpacity(g.color.a)}}}},{key:"setOnJSCallback",value:function(e){}},{key:"setJavascriptInterfaceScheme",value:function(e){}},{key:"loadData",value:function(e,t,i,n){}},{key:"loadHTMLString",value:function(e,t){}},{key:"_updateVisibility",value:function(){if(this._div){var e=this._div;this._visible?e.style.visibility="visible":e.style.visibility="hidden",this._forceUpdate=!0}}},{key:"_updateSize",value:function(e,t){var i=this._div;i&&(i.style.width=e+"px",i.style.height=t+"px")}},{key:"_initEvent",value:function(){var t=this._iframe;if(t){var i=this._eventListeners,n=this;i.load=function(){n._dispatchEvent(e.EventType.LOADED)},i.error=function(){n._dispatchEvent(e.EventType.ERROR)},t.addEventListener("load",i.load),t.addEventListener("error",i.error)}}},{key:"_initStyle",value:function(){if(this._div){var e=this._div;e.style.position="absolute",e.style.bottom="0px",e.style.left="0px"}}},{key:"_setOpacity",value:function(e){var t=this._iframe;t&&t.style&&(t.style.opacity=(e/255).toString())}},{key:"_createDom",value:function(t,i){e.Polyfill.enableDiv?(this._div=document.createElement("div"),this._div.style["-webkit-overflow"]="auto",this._div.style["-webkit-overflow-scrolling"]="touch",this._iframe=document.createElement("iframe"),this._div.appendChild(this._iframe),this._iframe.style.width="100%",this._iframe.style.height="100%"):this._div=this._iframe=document.createElement("iframe"),e.Polyfill.enableBG&&(this._div.style.background="#FFF"),this._div.style.background="#FFF",this._div.style.height=i+"px",this._div.style.width=t+"px",this._div.style.overflow="scroll",this._iframe.style.border="none",cc.game.container.appendChild(this._div),this._updateVisibility()}},{key:"_createNativeControl",value:function(e,t){this._createDom(e,t),this._initStyle(),this._initEvent()}}]),e}(),iW.Polyfill=oW,iW.EventType=aW,tW=nW))||tW,bW=aW;function EW(){}var TW,SW,xW,AW,wW,CW,RW,kW,OW,IW,MW,LW,PW,BW,DW,FW,NW,zW,UW,GW,VW,HW,WW,jW,XW,qW,YW,KW,ZW,QW,JW,$W,ej,tj,ij,nj=e("WebviewComponent",(lW=Es("cc.WebviewComponent"),uW=Cs("UI/WebView"),cW=Rs(100),hW=Ts({tooltip:" WebView  http  https "}),fW=Ts({type:gR,tooltip:"WebView "}),lW(_W=uW(_W=cW((gW=vW=function(e){function t(){var e;return i(this,t),m(e=c(this,o(t).call(this)),"webviewEvents",pW,u(e)),m(e,"_url",mW,u(e)),e._impl=null,e._impl=new yW,e}return s(t,e),r(t,[{key:"url",get:function(){return this._url},set:function(e){this._url=e;var t=this._impl;t&&t.loadURL(e)}}]),r(t,[{key:"onRestore",value:function(){this._impl||(this._impl=new yW)}},{key:"onEnable",value:function(){if(this._impl){var e=this._impl;e.createDomElementIfNeeded(this.node.width,this.node.height),e.loadURL(this._url),e.setVisible(!0),e.setEventListener(bW.LOADED,this._onWebViewLoaded.bind(this)),e.setEventListener(bW.LOADING,this._onWebViewLoading.bind(this)),e.setEventListener(bW.ERROR,this._onWebViewLoadError.bind(this))}}},{key:"onDisable",value:function(){if(this._impl){var e=this._impl;e.setVisible(!1),e.setEventListener(bW.LOADED,EW),e.setEventListener(bW.LOADING,EW),e.setEventListener(bW.ERROR,EW)}}},{key:"onDestroy",value:function(){this._impl&&(this._impl.destroy(),this._impl=null)}},{key:"update",value:function(e){this._impl&&this._impl.updateMatrix(this.node)}},{key:"setJavascriptInterfaceScheme",value:function(e){this._impl&&this._impl.setJavascriptInterfaceScheme(e)}},{key:"setOnJSCallback",value:function(e){this._impl&&this._impl.setOnJSCallback(e)}},{key:"evaluateJS",value:function(e){this._impl&&this._impl.evaluateJS(e)}},{key:"_onWebViewLoaded",value:function(){gR.emitEvents(this.webviewEvents,this,bW.LOADED),this.node.emit("loaded",this)}},{key:"_onWebViewLoading",value:function(){return gR.emitEvents(this.webviewEvents,this,bW.LOADING),this.node.emit("loading",this),!0}},{key:"_onWebViewLoadError",value:function(){gR.emitEvents(this.webviewEvents,this,bW.ERROR),this.node.emit("error",this)}}]),t}(Jw),vW.EventType=bW,v((dW=gW).prototype,"url",[hW],Object.getOwnPropertyDescriptor(dW.prototype,"url"),dW.prototype),pW=v(dW.prototype,"webviewEvents",[fW],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),mW=v(dW.prototype,"_url",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),_W=dW))||_W)||_W)||_W));cc.WebviewComponent=nj;var rj,aj,sj=new zi;function oj(e){return e instanceof Qb?qS:e.getContentSize()}function lj(e,t,i,n){for(var r=e.parent?e.parent.getScale():sj,a=r.x,s=r.y,o=0,l=0,u=e.parent;;){if(!u)return i.x=i.y=0,void(n.x=n.y=1);var c=u.getPosition();if(o+=c.x,l+=c.y,(u=u.parent)===t)break;var h=(r=u?u.getScale():sj).x,f=r.y;o*=h,l*=f,a*=h,s*=f}n.x=0!==a?1/a:1,n.y=0!==s?1/s:1,i.x=-o,i.y=-l}!function(e){e[e.ONCE=0]="ONCE",e[e.ALWAYS=1]="ALWAYS"}(rj||(rj={})),pt(rj),function(e){e[e.TOP=1]="TOP",e[e.MID=2]="MID",e[e.BOT=4]="BOT",e[e.LEFT=8]="LEFT",e[e.CENTER=16]="CENTER",e[e.RIGHT=32]="RIGHT",e[e.HORIZONTAL=56]="HORIZONTAL",e[e.VERTICAL=7]="VERTICAL"}(aj||(aj={}));var uj,cj=aj.TOP|aj.BOT,hj=aj.LEFT|aj.RIGHT,fj=e("WidgetComponent",(TW=Es("cc.WidgetComponent"),SW=Rs(110),xW=Cs("UI/Widget"),AW=ws(Lf),wW=Ts({type:o_,tooltip:""}),CW=Ts({tooltip:""}),RW=Ts({tooltip:""}),kW=Ts({tooltip:""}),OW=Ts({tooltip:""}),IW=Ts({tooltip:""}),MW=Ts({tooltip:""}),LW=Ts({visible:!1}),PW=Ts({visible:!1}),BW=Ts({type:rj,tooltip:" widget  widget "}),TW(DW=SW(DW=xW(DW=AW(DW=As((ij=tj=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),s=0;s<r;s++)a[s]=arguments[s];return(n=c(this,(e=o(t)).call.apply(e,[this].concat(a))))._lastPos=new zi,n._lastSize=new Xn,n._dirty=!0,m(n,"_alignFlags",NW,u(n)),m(n,"_target",zW,u(n)),m(n,"_left",UW,u(n)),m(n,"_right",GW,u(n)),m(n,"_top",VW,u(n)),m(n,"_bottom",HW,u(n)),m(n,"_horizontalCenter",WW,u(n)),m(n,"_verticalCenter",jW,u(n)),m(n,"_isAbsLeft",XW,u(n)),m(n,"_isAbsRight",qW,u(n)),m(n,"_isAbsTop",YW,u(n)),m(n,"_isAbsBottom",KW,u(n)),m(n,"_isAbsHorizontalCenter",ZW,u(n)),m(n,"_isAbsVerticalCenter",QW,u(n)),m(n,"_originalWidth",JW,u(n)),m(n,"_originalHeight",$W,u(n)),m(n,"_alignMode",ej,u(n)),n}return s(t,e),r(t,[{key:"updateAlignment",value:function(){cc._widgetManager.updateAlignment(this.node)}},{key:"_validateTargetInDEV",value:function(){}},{key:"setDirty",value:function(){this._recursiveDirty()}},{key:"onEnable",value:function(){this.node.getPosition(this._lastPos),this.node.getContentSize(this._lastSize),cc._widgetManager.add(this),this._registerEvent(),this._registerTargetEvents()}},{key:"onDisable",value:function(){cc._widgetManager.remove(this),this._unregisterEvent(),this._unregisterTargetEvents()}},{key:"onDestroy",value:function(){this._removeParentEvent()}},{key:"_adjustWidgetToAllowMovingInEditor",value:function(e){if(e&Nu.POSITION&&!cc._widgetManager.isAligning){var t=this.node.getPosition(),i=this._lastPos,n=new zi(t);n.subtract(i);var r=this.node.parent,a=new zi(1,1,1);if(this.target&&(r=this.target,lj(this.node,r,new zi,a)),r){var s=oj(r),o=new zi;0!==s.width&&0!==s.height&&zi.set(o,n.x/s.width,n.y/s.height,o.z),this.isAlignTop&&(this._top-=(this._isAbsTop?n.y:o.y)*a.y),this.isAlignBottom&&(this._bottom+=(this._isAbsBottom?n.y:o.y)*a.y),this.isAlignLeft&&(this._left+=(this._isAbsLeft?n.x:o.x)*a.x),this.isAlignRight&&(this._right-=(this._isAbsRight?n.x:o.x)*a.x),this.isAlignHorizontalCenter&&(this._horizontalCenter+=(this._isAbsHorizontalCenter?n.x:o.x)*a.x),this.isAlignVerticalCenter&&(this._verticalCenter+=(this._isAbsVerticalCenter?n.y:o.y)*a.y),this._recursiveDirty()}}}},{key:"_adjustWidgetToAllowResizingInEditor",value:function(){if(!cc._widgetManager.isAligning){this.setDirty();var e=this.node.getContentSize(),t=this._lastSize,i=new zi(e.width-t.width,e.height-t.height,0),n=this.node.parent,r=new zi(1,1,1);if(this.target&&(n=this.target,lj(this.node,n,new zi,r)),n){var a=oj(n),s=new zi;0!==a.width&&0!==a.height&&zi.set(s,i.x/a.width,i.y/a.height,s.z);var o=this.node.getAnchorPoint();this.isAlignTop&&(this._top-=(this._isAbsTop?i.y:s.y)*(1-o.y)*r.y),this.isAlignBottom&&(this._bottom-=(this._isAbsBottom?i.y:s.y)*o.y*r.y),this.isAlignLeft&&(this._left-=(this._isAbsLeft?i.x:s.x)*o.x*r.x),this.isAlignRight&&(this._right-=(this._isAbsRight?i.x:s.x)*(1-o.x)*r.x),this._recursiveDirty()}}}},{key:"_adjustWidgetToAnchorChanged",value:function(){this.setDirty()}},{key:"_adjustTargetToParentChanged",value:function(e){e&&this._unregisterOldParentEvents(e),this.node.getParent()&&this._registerTargetEvents()}},{key:"_registerEvent",value:function(){this.node.on(Kc.TRANSFORM_CHANGED,this._adjustWidgetToAllowMovingInEditor,this),this.node.on(Kc.SIZE_CHANGED,this._adjustWidgetToAllowResizingInEditor,this),this.node.on(Kc.ANCHOR_CHANGED,this._adjustWidgetToAnchorChanged,this),this.node.on(Kc.PARENT_CHANGED,this._adjustTargetToParentChanged,this)}},{key:"_unregisterEvent",value:function(){this.node.off(Kc.TRANSFORM_CHANGED,this._adjustWidgetToAllowMovingInEditor,this),this.node.off(Kc.SIZE_CHANGED,this._adjustWidgetToAllowResizingInEditor,this),this.node.off(Kc.ANCHOR_CHANGED,this._adjustWidgetToAnchorChanged,this)}},{key:"_removeParentEvent",value:function(){this.node.off(Kc.PARENT_CHANGED,this._adjustTargetToParentChanged,this)}},{key:"_autoChangedValue",value:function(e,t){if((this._alignFlags&e)>0&&this.node.parent&&this.node.parent._uiProps.uiTransformComp){var i=this.node.parent.getContentSize();this.isAlignLeft&&e===aj.LEFT?this._left=t?this._left*i.width:this._left/i.width:this.isAlignRight&&e===aj.RIGHT?this._right=t?this._right*i.width:this._right/i.width:this.isAlignHorizontalCenter&&e===aj.CENTER?this._horizontalCenter=t?this._horizontalCenter*i.width:this._horizontalCenter/i.width:this.isAlignTop&&e===aj.TOP?this._top=t?this._top*i.height:this._top/i.height:this.isAlignBottom&&e===aj.BOT?this._bottom=t?this._bottom*i.height:this._bottom/i.height:this.isAbsoluteVerticalCenter&&e===aj.MID&&(this._verticalCenter=this._verticalCenter/i.height),this._recursiveDirty()}}},{key:"_registerTargetEvents",value:function(){var e=this._target||this.node.parent;e&&(e.getComponent(Lf)?(e.on(Kc.TRANSFORM_CHANGED,this._targetChangedOperation,this),e.on(Kc.SIZE_CHANGED,this._targetChangedOperation,this)):cc.warnID(6501,this.node.name))}},{key:"_unregisterTargetEvents",value:function(){var e=this._target||this.node.parent;e&&(e.off(Kc.TRANSFORM_CHANGED,this._targetChangedOperation,this),e.off(Kc.SIZE_CHANGED,this._targetChangedOperation,this))}},{key:"_unregisterOldParentEvents",value:function(e){var t=this._target||e;t&&(t.off(Kc.TRANSFORM_CHANGED,this._targetChangedOperation,this),t.off(Kc.SIZE_CHANGED,this._targetChangedOperation,this))}},{key:"_targetChangedOperation",value:function(){this._recursiveDirty()}},{key:"_setAlign",value:function(e,t){if(t!==(this._alignFlags&e)>0){var i=(e&hj)>0;t?(this._alignFlags|=e,i?(this.isAlignHorizontalCenter=!1,this.isStretchWidth&&(this._originalWidth=this.node.width)):(this.isAlignVerticalCenter=!1,this.isStretchHeight&&(this._originalHeight=this.node.height))):(i?this.isStretchWidth&&(this.node.width=this._originalWidth):this.isStretchHeight&&(this.node.height=this._originalHeight),this._alignFlags&=~e)}}},{key:"_recursiveDirty",value:function(){this._dirty||(this._dirty=!0)}},{key:"target",get:function(){return this._target},set:function(e){this._target!==e&&(this._unregisterTargetEvents(),this._target=e,this._registerTargetEvents(),this._validateTargetInDEV(),this._recursiveDirty())}},{key:"isAlignTop",get:function(){return(this._alignFlags&aj.TOP)>0},set:function(e){this._setAlign(aj.TOP,e),this._recursiveDirty()}},{key:"isAlignBottom",get:function(){return(this._alignFlags&aj.BOT)>0},set:function(e){this._setAlign(aj.BOT,e),this._recursiveDirty()}},{key:"isAlignLeft",get:function(){return(this._alignFlags&aj.LEFT)>0},set:function(e){this._setAlign(aj.LEFT,e),this._recursiveDirty()}},{key:"isAlignRight",get:function(){return(this._alignFlags&aj.RIGHT)>0},set:function(e){this._setAlign(aj.RIGHT,e),this._recursiveDirty()}},{key:"isAlignVerticalCenter",get:function(){return(this._alignFlags&aj.MID)>0},set:function(e){e?(this.isAlignTop=!1,this.isAlignBottom=!1,this._alignFlags|=aj.MID):this._alignFlags&=~aj.MID,this._recursiveDirty()}},{key:"isAlignHorizontalCenter",get:function(){return(this._alignFlags&aj.CENTER)>0},set:function(e){e?(this.isAlignLeft=!1,this.isAlignRight=!1,this._alignFlags|=aj.CENTER):this._alignFlags&=~aj.CENTER,this._recursiveDirty()}},{key:"isStretchWidth",get:function(){return(this._alignFlags&hj)===hj}},{key:"isStretchHeight",get:function(){return(this._alignFlags&cj)===cj}},{key:"top",get:function(){return this._top},set:function(e){this._top=e,this._recursiveDirty()}},{key:"editorTop",get:function(){return this._isAbsTop?this._top:100*this._top},set:function(e){this._top=this._isAbsTop?e:e/100,this._recursiveDirty()}},{key:"bottom",get:function(){return this._bottom},set:function(e){this._bottom=e,this._recursiveDirty()}},{key:"editorBottom",get:function(){return this._isAbsBottom?this._bottom:100*this._bottom},set:function(e){this._bottom=this._isAbsBottom?e:e/100,this._recursiveDirty()}},{key:"left",get:function(){return this._left},set:function(e){this._left=e,this._recursiveDirty()}},{key:"editorLeft",get:function(){return this._isAbsLeft?this._left:100*this._left},set:function(e){this._left=this._isAbsLeft?e:e/100,this._recursiveDirty()}},{key:"right",get:function(){return this._right},set:function(e){this._right=e,this._recursiveDirty()}},{key:"editorRight",get:function(){return this._isAbsRight?this._right:100*this._right},set:function(e){this._right=this._isAbsRight?e:e/100,this._recursiveDirty()}},{key:"horizontalCenter",get:function(){return this._horizontalCenter},set:function(e){this._horizontalCenter=e,this._recursiveDirty()}},{key:"editorHorizontalCenter",get:function(){return this._isAbsHorizontalCenter?this._horizontalCenter:100*this._horizontalCenter},set:function(e){this._horizontalCenter=this._isAbsHorizontalCenter?e:e/100,this._recursiveDirty()}},{key:"verticalCenter",get:function(){return this._verticalCenter},set:function(e){this._verticalCenter=e,this._recursiveDirty()}},{key:"editorVerticalCenter",get:function(){return this._isAbsVerticalCenter?this._verticalCenter:100*this._verticalCenter},set:function(e){this._verticalCenter=this._isAbsVerticalCenter?e:e/100,this._recursiveDirty()}},{key:"isAbsoluteTop",get:function(){return this._isAbsTop},set:function(e){this._isAbsTop!==e&&(this._isAbsTop=e,this._autoChangedValue(aj.TOP,this._isAbsTop))}},{key:"isAbsoluteBottom",get:function(){return this._isAbsBottom},set:function(e){this._isAbsBottom!==e&&(this._isAbsBottom=e,this._autoChangedValue(aj.BOT,this._isAbsBottom))}},{key:"isAbsoluteLeft",get:function(){return this._isAbsLeft},set:function(e){this._isAbsLeft!==e&&(this._isAbsLeft=e,this._autoChangedValue(aj.LEFT,this._isAbsLeft))}},{key:"isAbsoluteRight",get:function(){return this._isAbsRight},set:function(e){this._isAbsRight!==e&&(this._isAbsRight=e,this._autoChangedValue(aj.RIGHT,this._isAbsRight))}},{key:"alignMode",get:function(){return this._alignMode},set:function(e){this._alignMode=e,this._recursiveDirty()}},{key:"isAbsoluteHorizontalCenter",get:function(){return this._isAbsHorizontalCenter},set:function(e){this._isAbsHorizontalCenter!==e&&(this._isAbsHorizontalCenter=e,this._autoChangedValue(aj.CENTER,this._isAbsHorizontalCenter))}},{key:"isAbsoluteVerticalCenter",get:function(){return this._isAbsVerticalCenter},set:function(e){this._isAbsVerticalCenter!==e&&(this._isAbsVerticalCenter=e,this._autoChangedValue(aj.MID,this._isAbsVerticalCenter))}},{key:"alignFlags",get:function(){return this._alignFlags},set:function(e){this._alignFlags!==e&&(this._alignFlags=e,this._recursiveDirty())}}]),t}(Ph),tj.AlignMode=rj,v((FW=ij).prototype,"target",[wW],Object.getOwnPropertyDescriptor(FW.prototype,"target"),FW.prototype),v(FW.prototype,"isAlignTop",[CW],Object.getOwnPropertyDescriptor(FW.prototype,"isAlignTop"),FW.prototype),v(FW.prototype,"isAlignBottom",[RW],Object.getOwnPropertyDescriptor(FW.prototype,"isAlignBottom"),FW.prototype),v(FW.prototype,"isAlignLeft",[kW],Object.getOwnPropertyDescriptor(FW.prototype,"isAlignLeft"),FW.prototype),v(FW.prototype,"isAlignRight",[OW],Object.getOwnPropertyDescriptor(FW.prototype,"isAlignRight"),FW.prototype),v(FW.prototype,"isAlignVerticalCenter",[IW],Object.getOwnPropertyDescriptor(FW.prototype,"isAlignVerticalCenter"),FW.prototype),v(FW.prototype,"isAlignHorizontalCenter",[MW],Object.getOwnPropertyDescriptor(FW.prototype,"isAlignHorizontalCenter"),FW.prototype),v(FW.prototype,"isStretchWidth",[LW],Object.getOwnPropertyDescriptor(FW.prototype,"isStretchWidth"),FW.prototype),v(FW.prototype,"isStretchHeight",[PW],Object.getOwnPropertyDescriptor(FW.prototype,"isStretchHeight"),FW.prototype),v(FW.prototype,"editorTop",[Ts],Object.getOwnPropertyDescriptor(FW.prototype,"editorTop"),FW.prototype),v(FW.prototype,"editorBottom",[Ts],Object.getOwnPropertyDescriptor(FW.prototype,"editorBottom"),FW.prototype),v(FW.prototype,"editorLeft",[Ts],Object.getOwnPropertyDescriptor(FW.prototype,"editorLeft"),FW.prototype),v(FW.prototype,"editorRight",[Ts],Object.getOwnPropertyDescriptor(FW.prototype,"editorRight"),FW.prototype),v(FW.prototype,"editorHorizontalCenter",[Ts],Object.getOwnPropertyDescriptor(FW.prototype,"editorHorizontalCenter"),FW.prototype),v(FW.prototype,"editorVerticalCenter",[Ts],Object.getOwnPropertyDescriptor(FW.prototype,"editorVerticalCenter"),FW.prototype),v(FW.prototype,"isAbsoluteTop",[Ts],Object.getOwnPropertyDescriptor(FW.prototype,"isAbsoluteTop"),FW.prototype),v(FW.prototype,"isAbsoluteBottom",[Ts],Object.getOwnPropertyDescriptor(FW.prototype,"isAbsoluteBottom"),FW.prototype),v(FW.prototype,"isAbsoluteLeft",[Ts],Object.getOwnPropertyDescriptor(FW.prototype,"isAbsoluteLeft"),FW.prototype),v(FW.prototype,"isAbsoluteRight",[Ts],Object.getOwnPropertyDescriptor(FW.prototype,"isAbsoluteRight"),FW.prototype),v(FW.prototype,"alignMode",[BW],Object.getOwnPropertyDescriptor(FW.prototype,"alignMode"),FW.prototype),v(FW.prototype,"isAbsoluteHorizontalCenter",[Ts],Object.getOwnPropertyDescriptor(FW.prototype,"isAbsoluteHorizontalCenter"),FW.prototype),v(FW.prototype,"isAbsoluteVerticalCenter",[Ts],Object.getOwnPropertyDescriptor(FW.prototype,"isAbsoluteVerticalCenter"),FW.prototype),v(FW.prototype,"alignFlags",[Ts],Object.getOwnPropertyDescriptor(FW.prototype,"alignFlags"),FW.prototype),NW=v(FW.prototype,"_alignFlags",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),zW=v(FW.prototype,"_target",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),UW=v(FW.prototype,"_left",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),GW=v(FW.prototype,"_right",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),VW=v(FW.prototype,"_top",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),HW=v(FW.prototype,"_bottom",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),WW=v(FW.prototype,"_horizontalCenter",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),jW=v(FW.prototype,"_verticalCenter",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),XW=v(FW.prototype,"_isAbsLeft",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),qW=v(FW.prototype,"_isAbsRight",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),YW=v(FW.prototype,"_isAbsTop",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),KW=v(FW.prototype,"_isAbsBottom",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),ZW=v(FW.prototype,"_isAbsHorizontalCenter",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),QW=v(FW.prototype,"_isAbsVerticalCenter",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),JW=v(FW.prototype,"_originalWidth",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),$W=v(FW.prototype,"_originalHeight",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ej=v(FW.prototype,"_alignMode",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return rj.ALWAYS}}),DW=FW))||DW)||DW)||DW)||DW)||DW));cc.WidgetComponent=fj;var _j,dj,pj,mj,vj,gj,yj,bj,Ej,Tj,Sj,xj,Aj,wj,Cj,Rj=e("UIReorderComponent",Es("cc.UIReorderComponent")(uj=Cs("UI/Reorder")(uj=Rs(110)(uj=ks(uj=As(uj=function(e){function t(){return i(this,t),c(this,o(t).apply(this,arguments))}return s(t,e),t}(Jw))||uj)||uj)||uj)||uj)||uj);cc.UIReorderComponent=Rj;var kj,Oj=new rr;!function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL"}(kj||(kj={})),pt(kj);var Ij,Mj,Lj,Pj,Bj,Dj,Fj,Nj,zj,Uj,Gj,Vj,Hj,Wj,jj,Xj,qj,Yj,Kj,Zj,Qj,Jj,$j,eX,tX,iX,nX,rX,aX,sX,oX,lX,uX=e("PageViewIndicatorComponent",(_j=Es("cc.PageViewIndicatorComponent"),dj=Rs(110),pj=Cs("UI/PageViewIndicator"),mj=Ts({type:Yc,tooltip:""}),vj=Ts({type:kj,tooltip:""}),gj=Ts({type:Xn,tooltip:""}),yj=Ts({tooltip:""}),_j(bj=dj(bj=pj((Cj=wj=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),s=0;s<r;s++)a[s]=arguments[s];return m(n=c(this,(e=o(t)).call.apply(e,[this].concat(a))),"spacing",Tj,u(n)),m(n,"_spriteFrame",Sj,u(n)),m(n,"_direction",xj,u(n)),m(n,"_cellSize",Aj,u(n)),n._layout=null,n._pageView=null,n._indicators=[],n}return s(t,e),r(t,[{key:"onLoad",value:function(){this._updateLayout()}},{key:"setPageView",value:function(e){this._pageView=e,this._refresh()}},{key:"_updateLayout",value:function(){this._layout=this.getComponent(CU),this._layout||(this._layout=this.addComponent(CU));var e=this._layout;this.direction===kj.HORIZONTAL?(e.type=CU.Type.HORIZONTAL,e.spacingX=this.spacing):this.direction===kj.VERTICAL&&(e.type=CU.Type.VERTICAL,e.spacingY=this.spacing),e.resizeMode=CU.ResizeMode.CONTAINER}},{key:"_createIndicator",value:function(){var e=new o_;return e.addComponent(zC).spriteFrame=this.spriteFrame,e.parent=this.node,e.width=this.cellSize.width,e.height=this.cellSize.height,e}},{key:"_changedState",value:function(){var e=this._indicators;if(0!==e.length&&this._pageView){var t=this._pageView.curPageIdx;if(!(t>=e.length)){for(var i=0;i<e.length;++i){var n=e[i];if(n._uiProps.uiComp){var r=n._uiProps.uiComp;Oj.set(r.color),Oj.a=127.5,r.color=Oj}}if(e[t]._uiProps.uiComp){var a=e[t]._uiProps.uiComp;Oj.set(a.color),Oj.a=255,a.color=Oj}}}}},{key:"_refresh",value:function(){if(this._pageView){var e=this._indicators,t=this._pageView.getPages();if(t.length!==e.length){var i=0;if(t.length>e.length)for(i=0;i<t.length;++i)e[i]||(e[i]=this._createIndicator());else for(i=e.length-t.length;i>0;--i){var n=e[i-1];this.node.removeChild(n),e.splice(i-1,1)}this._layout&&this._layout.enabledInHierarchy&&this._layout.updateLayout(),this._changedState()}}}},{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(e){this._spriteFrame!==e&&(this._spriteFrame=e)}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e)}},{key:"cellSize",get:function(){return this._cellSize},set:function(e){this._cellSize!==e&&(this._cellSize=e)}}]),t}(Ph),wj.Direction=kj,v((Ej=Cj).prototype,"spriteFrame",[mj],Object.getOwnPropertyDescriptor(Ej.prototype,"spriteFrame"),Ej.prototype),v(Ej.prototype,"direction",[vj],Object.getOwnPropertyDescriptor(Ej.prototype,"direction"),Ej.prototype),v(Ej.prototype,"cellSize",[gj],Object.getOwnPropertyDescriptor(Ej.prototype,"cellSize"),Ej.prototype),Tj=v(Ej.prototype,"spacing",[yj],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Sj=v(Ej.prototype,"_spriteFrame",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),xj=v(Ej.prototype,"_direction",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return kj.HORIZONTAL}}),Aj=v(Ej.prototype,"_cellSize",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Xn(20,20)}}),bj=Ej))||bj)||bj)||bj));cc.PageViewIndicatorComponent=uX;var cX,hX,fX,_X=new Mi;!function(e){e[e.Unified=0]="Unified",e[e.Free=1]="Free"}(cX||(cX={})),pt(cX),function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical"}(hX||(hX={})),pt(hX),function(e){e.PAGE_TURNING="page-turning"}(fX||(fX={}));var dX,pX,mX,vX,gX,yX,bX,EX,TX,SX=e("PageViewComponent",(Ij=Es("cc.PageViewComponent"),Mj=Rs(110),Lj=Cs("UI/PageView"),Pj=Ts({type:cX,tooltip:""}),Bj=Ts({type:hX,tooltip:""}),Dj=Ts({slide:!0,range:[0,1,.01],tooltip:""}),Fj=Ts({slide:!0,range:[0,1,.01],tooltip:" PageView PageTurning "}),Nj=Ts({type:uX,tooltip:""}),zj=Ts({tooltip:"\n\n"}),Uj=Ts({type:EV,visible:!1,override:!0}),Gj=Ts({type:EV,visible:!1,override:!0}),Vj=Ts({visible:!1,override:!0}),Hj=Ts({visible:!1,override:!0}),Wj=Ts({visible:!1,override:!0}),jj=Ts({visible:!1,override:!0,type:[gR]}),Xj=Ts({type:[gR],tooltip:""}),Ij(qj=Mj(qj=Lj((lX=oX=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),s=0;s<r;s++)a[s]=arguments[s];return m(n=c(this,(e=o(t)).call.apply(e,[this].concat(a))),"autoPageTurningThreshold",Kj,u(n)),m(n,"horizontal",Zj,u(n)),m(n,"vertical",Qj,u(n)),m(n,"cancelInnerEvents",Jj,u(n)),m(n,"scrollEvents",$j,u(n)),m(n,"pageTurningSpeed",eX,u(n)),m(n,"pageEvents",tX,u(n)),m(n,"_sizeMode",iX,u(n)),m(n,"_direction",nX,u(n)),m(n,"_scrollThreshold",rX,u(n)),m(n,"_pageTurningEventTiming",aX,u(n)),m(n,"_indicator",sX,u(n)),n._curPageIdx=0,n._lastPageIdx=0,n._pages=[],n._initContentPos=new zi,n._scrollCenterOffsetX=[],n._scrollCenterOffsetY=[],n._touchBeganPosition=new zi,n._touchEndPosition=new zi,n}return s(t,e),r(t,[{key:"__preload",value:function(){this.node.on(Kc.SIZE_CHANGED,this._updateAllPagesSize,this)}},{key:"onEnable",value:function(){f(o(t.prototype),"onEnable",this).call(this),this.node.on(t.EventType.SCROLL_ENG_WITH_THRESHOLD,this._dispatchPageTurningEvent,this)}},{key:"onDisable",value:function(){f(o(t.prototype),"onDisable",this).call(this),this.node.off(t.EventType.SCROLL_ENG_WITH_THRESHOLD,this._dispatchPageTurningEvent,this)}},{key:"onLoad",value:function(){this._initPages(),this.indicator&&this.indicator.setPageView(this)}},{key:"onDestroy",value:function(){this.node.off(Kc.SIZE_CHANGED,this._updateAllPagesSize,this)}},{key:"getCurrentPageIndex",value:function(){return this._curPageIdx}},{key:"setCurrentPageIndex",value:function(e){this.scrollToPage(e,1)}},{key:"getPages",value:function(){return this._pages}},{key:"addPage",value:function(e){e&&-1===this._pages.indexOf(e)&&this.content&&(this.content.addChild(e),this._pages.push(e),this._updatePageView())}},{key:"insertPage",value:function(e,t){t<0||!e||-1!==this._pages.indexOf(e)||!this.content||(t>=this._pages.length?this.addPage(e):(this._pages.splice(t,0,e),this.content.insertChild(e,t),this._updatePageView()))}},{key:"removePage",value:function(e){if(e&&this.content){var t=this._pages.indexOf(e);-1!==t?this.removePageAtIndex(t):N(4300,e.name)}}},{key:"removePageAtIndex",value:function(e){var t=this._pages;if(!(e<0||e>=t.length)){var i=t[e];i&&this.content&&(this.content.removeChild(i),t.splice(e,1),this._updatePageView())}}},{key:"removeAllPages",value:function(){if(this.content){for(var e=this._pages,t=0,i=e.length;t<i;t++)this.content.removeChild(e[t]);this._pages.length=0,this._updatePageView()}}},{key:"scrollToPage",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;e<0||e>=this._pages.length||(t=void 0!==t?t:.3,this._curPageIdx=e,this.scrollToOffset(this._moveOffsetValue(e),t,!0),this.indicator&&this.indicator._changedState())}},{key:"getScrollEndedEventTiming",value:function(){return this.pageTurningEventTiming}},{key:"_updatePageView",value:function(){var e=this.content.getComponent(CU);e&&e.enabled&&e.updateLayout();var t=this._pages.length;this._curPageIdx>=t&&(this._curPageIdx=0===t?0:t-1,this._lastPageIdx=this._curPageIdx);for(var i=this._initContentPos,n=0;n<t;++n){var r=this._pages[n].position;this.direction===hX.Horizontal?this._scrollCenterOffsetX[n]=Math.abs(i.x+r.x):this._scrollCenterOffsetY[n]=Math.abs(i.y+r.y)}this.indicator&&this.indicator._refresh()}},{key:"_updateAllPagesSize",value:function(){if(this.content&&this.view&&this._sizeMode===cX.Unified)for(var e=this._pages,t=this.view.getContentSize(),i=0,n=e.length;i<n;i++)e[i].setContentSize(t)}},{key:"_handleReleaseLogic",value:function(){this._autoScrollToPage(),this._scrolling&&(this._scrolling=!1,this._autoScrolling||this._dispatchEvent(t.EventType.SCROLL_ENDED))}},{key:"_onTouchBegan",value:function(e,i){e.touch.getUILocation(_X),zi.set(this._touchBeganPosition,_X.x,_X.y,0),f(o(t.prototype),"_onTouchBegan",this).call(this,e,i)}},{key:"_onTouchMoved",value:function(e,i){f(o(t.prototype),"_onTouchMoved",this).call(this,e,i)}},{key:"_onTouchEnded",value:function(e,i){e.touch.getUILocation(_X),zi.set(this._touchEndPosition,_X.x,_X.y,0),f(o(t.prototype),"_onTouchEnded",this).call(this,e,i)}},{key:"_onTouchCancelled",value:function(e,i){e.touch.getUILocation(_X),zi.set(this._touchEndPosition,_X.x,_X.y,0),f(o(t.prototype),"_onTouchCancelled",this).call(this,e,i)}},{key:"_onMouseWheel",value:function(){}},{key:"_syncScrollDirection",value:function(){this.horizontal=this.direction===hX.Horizontal,this.vertical=this.direction===hX.Vertical}},{key:"_syncSizeMode",value:function(){var e=this.view;if(this.content&&e){var t=this.content.getComponent(CU);if(t){if(this._sizeMode===cX.Free&&this._pages.length>0){var i=this._pages[this._pages.length-1];this.direction===hX.Horizontal?(t.paddingLeft=(e.width-this._pages[0].width)/2,t.paddingRight=(e.width-i.width)/2):this.direction===hX.Vertical&&(t.paddingTop=(e.height-this._pages[0].height)/2,t.paddingBottom=(e.height-i.height)/2)}t.updateLayout()}}}},{key:"_initPages",value:function(){if(this.content){this._initContentPos=this.content.position;for(var e=this.content.children,t=0;t<e.length;++t){var i=e[t];this._pages.indexOf(i)>=0||this._pages.push(i)}this._syncScrollDirection(),this._syncSizeMode(),this._updatePageView()}}},{key:"_dispatchPageTurningEvent",value:function(){this._lastPageIdx!==this._curPageIdx&&(this._lastPageIdx=this._curPageIdx,gR.emitEvents(this.pageEvents,this),this.node.emit(fX.PAGE_TURNING,this))}},{key:"_isQuicklyScrollable",value:function(e){if(this.direction===hX.Horizontal){if(Math.abs(e.x)>this.autoPageTurningThreshold)return!0}else if(this.direction===hX.Vertical&&Math.abs(e.y)>this.autoPageTurningThreshold)return!0;return!1}},{key:"_moveOffsetValue",value:function(e){var t=new zi;if(this._sizeMode===cX.Free)this.direction===hX.Horizontal?t.x=this._scrollCenterOffsetX[e]:this.direction===hX.Vertical&&(t.y=this._scrollCenterOffsetY[e]);else{var i=this.view;if(!i)return t;this.direction===hX.Horizontal?t.x=e*i.width:this.direction===hX.Vertical&&(t.y=e*i.height)}return t}},{key:"_getDragDirection",value:function(e){return this._direction===hX.Horizontal?0===e.x?0:e.x>0?1:-1:0===e.y?0:e.y<0?1:-1}},{key:"_isScrollable",value:function(e,t,i){if(this._sizeMode===cX.Free){var n=0,r=0;if(this.direction===hX.Horizontal)return n=this._scrollCenterOffsetX[t],r=this._scrollCenterOffsetX[i],Math.abs(e.x)>=Math.abs(n-r)*this.scrollThreshold;if(this.direction===hX.Vertical)return n=this._scrollCenterOffsetY[t],r=this._scrollCenterOffsetY[i],Math.abs(e.y)>=Math.abs(n-r)*this.scrollThreshold}else{var a=this.view;if(!a)return;if(this.direction===hX.Horizontal)return Math.abs(e.x)>=a.width*this.scrollThreshold;if(this.direction===hX.Vertical)return Math.abs(e.y)>=a.height*this.scrollThreshold}}},{key:"_autoScrollToPage",value:function(){var e=this._startBounceBackIfNeeded(),t=new zi;if(zi.subtract(t,this._touchBeganPosition,this._touchEndPosition),e){var i=this._getDragDirection(t);if(0===i)return;this._curPageIdx=i>0?this._pages.length-1:0,this.indicator&&this.indicator._changedState()}else{var n=this._curPageIdx,r=n+this._getDragDirection(t),a=this.pageTurningSpeed*Math.abs(n-r);if(r<this._pages.length){if(this._isScrollable(t,n,r))return void this.scrollToPage(r,a);var s=this._calculateTouchMoveVelocity();if(this._isQuicklyScrollable(s))return void this.scrollToPage(r,a)}this.scrollToPage(n,a)}}},{key:"sizeMode",get:function(){return this._sizeMode},set:function(e){this._sizeMode!==e&&(this._sizeMode=e,this._syncSizeMode())}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e,this._syncScrollDirection())}},{key:"scrollThreshold",get:function(){return this._scrollThreshold},set:function(e){this._scrollThreshold!==e&&(this._scrollThreshold=e)}},{key:"pageTurningEventTiming",get:function(){return this._pageTurningEventTiming},set:function(e){this._pageTurningEventTiming!==e&&(this._pageTurningEventTiming=e)}},{key:"indicator",get:function(){return this._indicator},set:function(e){this._indicator!==e&&(this._indicator=e,this.indicator&&this.indicator.setPageView(this))}},{key:"curPageIdx",get:function(){return this._curPageIdx}},{key:"verticalScrollBar",get:function(){return this._verticalScrollBar}},{key:"horizontalScrollBar",get:function(){return this._horizontalScrollBar}}]),t}(EH),oX.SizeMode=cX,oX.Direction=hX,oX.EventType=JH(fX,JV),v((Yj=lX).prototype,"sizeMode",[Pj],Object.getOwnPropertyDescriptor(Yj.prototype,"sizeMode"),Yj.prototype),v(Yj.prototype,"direction",[Bj],Object.getOwnPropertyDescriptor(Yj.prototype,"direction"),Yj.prototype),v(Yj.prototype,"scrollThreshold",[Dj],Object.getOwnPropertyDescriptor(Yj.prototype,"scrollThreshold"),Yj.prototype),v(Yj.prototype,"pageTurningEventTiming",[Fj],Object.getOwnPropertyDescriptor(Yj.prototype,"pageTurningEventTiming"),Yj.prototype),v(Yj.prototype,"indicator",[Nj],Object.getOwnPropertyDescriptor(Yj.prototype,"indicator"),Yj.prototype),Kj=v(Yj.prototype,"autoPageTurningThreshold",[zj],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),v(Yj.prototype,"verticalScrollBar",[Uj],Object.getOwnPropertyDescriptor(Yj.prototype,"verticalScrollBar"),Yj.prototype),v(Yj.prototype,"horizontalScrollBar",[Gj],Object.getOwnPropertyDescriptor(Yj.prototype,"horizontalScrollBar"),Yj.prototype),Zj=v(Yj.prototype,"horizontal",[Vj],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Qj=v(Yj.prototype,"vertical",[Hj],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Jj=v(Yj.prototype,"cancelInnerEvents",[Wj],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),$j=v(Yj.prototype,"scrollEvents",[jj],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),eX=v(Yj.prototype,"pageTurningSpeed",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),tX=v(Yj.prototype,"pageEvents",[Xj],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),iX=v(Yj.prototype,"_sizeMode",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return cX.Unified}}),nX=v(Yj.prototype,"_direction",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return hX.Horizontal}}),rX=v(Yj.prototype,"_scrollThreshold",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),aX=v(Yj.prototype,"_pageTurningEventTiming",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),sX=v(Yj.prototype,"_indicator",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),qj=Yj))||qj)||qj)||qj));cc.PageViewComponent=SX;e("UIStaticBatchComponent",(dX=Es("cc.UIStaticBatchComponent"),pX=Cs("UI/Render/UIStaticBatch"),mX=Rs(110),vX=Ts({visible:!1,override:!0}),gX=Ts({visible:!1,override:!0}),yX=Ts({visible:!1,override:!0}),bX=Ts({type:np,displayOrder:3,visible:!1,override:!0}),dX(EX=pX(EX=mX((v((TX=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),s=0;s<r;s++)a[s]=arguments[s];return(n=c(this,(e=o(t)).call.apply(e,[this].concat(a))))._init=!1,n._meshBuffer=null,n._dirty=!0,n._lastMeshBuffer=null,n._uiDrawBatchList=[],n}return s(t,e),r(t,[{key:"onLoad",value:function(){var e=this._getUI();if(e){var t=iR,i=new ZC(e);i.initialize(t,this._arrivalMaxBuffer),this._meshBuffer=i}}},{key:"onDestroy",value:function(){f(o(t.prototype),"onDestroy",this).call(this),this._clearData(),this._meshBuffer&&(this._meshBuffer.destroy(),this._meshBuffer=null)}},{key:"updateAssembler",value:function(e){this._dirty&&(e.finishMergeBatches(),this._lastMeshBuffer=e.currBufferBatch,e.currBufferBatch=this._meshBuffer,e.currStaticRoot=this),this._init&&(e.finishMergeBatches(),e.commitStaticBatch(this))}},{key:"postUpdateAssembler",value:function(e){this._dirty&&(e.finishMergeBatches(),e.currBufferBatch=this._lastMeshBuffer,e.currStaticRoot=null,this._dirty=!1,this._init=!0,this.node._static=!0,this._meshBuffer.uploadData())}},{key:"markAsDirty",value:function(){this._getUI()&&(this.node._static=!1,this._dirty=!0,this._init=!1,this._clearData())}},{key:"_requireDrawBatch",value:function(){var e=new eR;return e.isStatic=!0,this._uiDrawBatchList.push(e),e}},{key:"_clearData",value:function(){if(this._meshBuffer){this._meshBuffer.reset();for(var e=this._getUI(),t=0;t<this._uiDrawBatchList.length;t++){this._uiDrawBatchList[t].destroy(e)}}this._uiDrawBatchList.length=0,this._init=!1}},{key:"_getUI",value:function(){return vR.root&&vR.root.ui?vR.root.ui:(N(9301),null)}},{key:"_arrivalMaxBuffer",value:function(){N(9300)}},{key:"dstBlendFactor",get:function(){return this._dstBlendFactor},set:function(e){this._dstBlendFactor!==e&&(this._dstBlendFactor=e,this._updateBlendFunc())}},{key:"srcBlendFactor",get:function(){return this._srcBlendFactor},set:function(e){this._srcBlendFactor!==e&&(this._srcBlendFactor=e,this._updateBlendFunc())}},{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this._updateColor(),this.markForUpdateRenderData())}},{key:"sharedMaterial",get:function(){return this._sharedMaterial},set:function(e){this._sharedMaterial!==e&&(this._sharedMaterial=e,this._instanceMaterial&&this._instanceMaterial())}},{key:"drawBatchList",get:function(){return this._uiDrawBatchList}}]),t}(OC)).prototype,"dstBlendFactor",[vX],Object.getOwnPropertyDescriptor(TX.prototype,"dstBlendFactor"),TX.prototype),v(TX.prototype,"srcBlendFactor",[gX],Object.getOwnPropertyDescriptor(TX.prototype,"srcBlendFactor"),TX.prototype),v(TX.prototype,"color",[yX],Object.getOwnPropertyDescriptor(TX.prototype,"color"),TX.prototype),v(TX.prototype,"sharedMaterial",[bX],Object.getOwnPropertyDescriptor(TX.prototype,"sharedMaterial"),TX.prototype),EX=TX))||EX)||EX)||EX)),e("UIOpacityComponent",Es("cc.UIOpacityComponent")(xX=Rs(110)(xX=Cs("UI/UIOpacity")(xX=As((v((AX=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),s=0;s<r;s++)a[s]=arguments[s];return m(n=c(this,(e=o(t)).call.apply(e,[this].concat(a))),"_opacity",wX,u(n)),n}return s(t,e),r(t,[{key:"onEnable",value:function(){this.node._uiProps.opacity=this._opacity/255}},{key:"onDisable",value:function(){this.node._uiProps.opacity=1}},{key:"opacity",get:function(){return this._opacity},set:function(e){this._opacity!==e&&(this._opacity=e,this.node._uiProps.opacity=e/255)}}]),t}(Ph)).prototype,"opacity",[Ts],Object.getOwnPropertyDescriptor(AX.prototype,"opacity"),AX.prototype),wX=v(AX.prototype,"_opacity",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 255}}),xX=AX))||xX)||xX)||xX)||xX);var xX,AX,wX,CX=new zi,RX=new Mi,kX=new zi,OX=new zi(1,1,1);function IX(e,t){var i,n=t.target,r=kX,a=OX;if(n?lj(e,i=n,r,a):i=e.parent,i.getComponent(Lf)){var s=oj(i),o=i instanceof Qb,l=o?RX:i.getAnchorPoint(),u=o;e.getPosition(CX);var c=CX.x,h=CX.y,f=e.getAnchorPoint(),_=e.getScale();if(t.alignFlags&aj.HORIZONTAL){var d=0,p=0,m=s.width;u?(d=qS.left.x,p=qS.right.x):p=(d=-l.x*m)+m,d+=t.isAbsoluteLeft?t.left:t.left*m,p-=t.isAbsoluteRight?t.right:t.right*m,n&&(d+=r.x,d*=a.x,p+=r.x,p*=a.x);var v=0,g=f.x,y=_.x;if(y<0&&(g=1-g,y=-y),t.isStretchWidth)v=p-d,0!==y&&(e.width=v/y),c=d+g*v;else if(v=e.width*y,t.isAlignHorizontalCenter){var b=t.isAbsoluteHorizontalCenter?t.horizontalCenter:t.horizontalCenter*m,E=(.5-l.x)*s.width;n&&(b*=a.x,E+=r.x,E*=a.x),c=E+(g-.5)*v+b}else c=t.isAlignLeft?d+g*v:p+(g-1)*v;t._lastSize.width=v}if(t.alignFlags&aj.VERTICAL){var T=0,S=0,x=s.height;u?(S=qS.bottom.y,T=qS.top.y):T=(S=-l.y*x)+x,S+=t.isAbsoluteBottom?t.bottom:t.bottom*x,T-=t.isAbsoluteTop?t.top:t.top*x,n&&(S+=r.y,S*=a.y,T+=r.y,T*=a.y);var A=0,w=f.y,C=_.y;if(C<0&&(w=1-w,C=-C),t.isStretchHeight)A=T-S,0!==C&&(e.height=A/C),h=S+w*A;else if(A=e.height*C,t.isAlignVerticalCenter){var R=t.isAbsoluteVerticalCenter?t.verticalCenter:t.verticalCenter*x,k=(.5-l.y)*s.height;n&&(R*=a.y,k+=r.y,k*=a.y),h=k+(w-.5)*A+R}else h=t.isAlignBottom?S+w*A:T+(w-1)*A;t._lastSize.height=A}e.setPosition(c,h,CX.z),zi.set(t._lastPos,c,h,CX.z)}}function MX(){var e=vR.getScene();if(e){if(BX.isAligning=!0,BX._nodesOrderDirty)LX.length=0,function e(t){var i=t.getComponent(fj);if(i)if(IX(t,i),i.alignMode!==rj.ALWAYS)i.enabled=!1;else{if(!cc.isValid(t,!0))return;LX.push(i)}var n=t.children,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s;o.active&&e(o)}}(e),BX._nodesOrderDirty=!1;else{var t=null,i=BX._activeWidgetsIterator;for(i.i=0;i.i<LX.length;++i.i)(t=LX[i.i])._dirty&&(IX(t.node,t),t._dirty=!1)}BX.isAligning=!1}}var LX=[];var PX=[],BX=e("widgetManager",cc._widgetManager={isAligning:!1,_nodesOrderDirty:!1,_activeWidgetsIterator:new Qe.MutableForwardIterator(LX),animationState:null,init:function(e){e.on(sR.EVENT_AFTER_UPDATE,MX),Il.isMobile?window.addEventListener("resize",this.onResized.bind(this)):Hx.instance.on("design-resolution-changed",this.onResized,this)},add:function(e){this._nodesOrderDirty=!0;var t=vR.root.ui.getScreen(e.node._uiProps.uiTransformComp.visibility);t&&-1===PX.indexOf(t)&&(PX.push(t),t.node.on("design-resolution-changed",this.onResized,this))},remove:function(e){this._activeWidgetsIterator.remove(e)},onResized:function(){var e=vR.getScene();e&&this.refreshWidgetOnResized(e)},refreshWidgetOnResized:function(e){if(o_.isNode(e)){var t=e.getComponent(fj);if(t&&t.alignFlags===rj.ALWAYS)return}var i=e.children,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;this.refreshWidgetOnResized(s)}},updateOffsetsToStayPut:function(e,t){function i(e,t){return Math.abs(e-t)>1e-10?t:e}var n=e.node,r=n.parent;if(r){var a=new zi,s=new zi(1,1,1);if(e.target&&lj(n,r=e.target,a,s),!t)return;if(!r.getComponent(Lf))return void cc.warnID(6501,e.node.name);var o=r.getAnchorPoint(),l=oj(r),u=n.getAnchorPoint(),c=n.getPosition(),h=aj,f=n.getScale(),_=0;if(t&h.LEFT){var d=-o.x*l.width;d+=a.x,d*=s.x,_=c.x-u.x*n.width*f.x-d,e.isAbsoluteLeft||(_/=l.width),_/=s.x,e.left=i(e.left,_)}if(t&h.RIGHT){var p=(1-o.x)*l.width;p+=a.x,_=(p*=s.x)-(c.x+(1-u.x)*n.width*f.x),e.isAbsoluteRight||(_/=l.width),_/=s.x,e.right=i(e.right,_)}if(t&h.TOP){var m=(1-o.y)*l.height;m+=a.y,_=(m*=s.y)-(c.y+(1-u.y)*n.height*f.y),e.isAbsoluteTop||(_/=l.height),_/=s.y,e.top=i(e.top,_)}if(t&h.BOT){var v=-o.y*l.height;v+=a.y,v*=s.y,_=c.y-u.y*n.height*f.y-v,e.isAbsoluteBottom||(_/=l.height),_/=s.y,e.bottom=i(e.bottom,_)}}},updateAlignment:function e(t){var i=t.parent;i&&o_.isNode(i)&&e(i);var n=t.getComponent(fj);n&&i&&IX(t,n)},AlignMode:rj,AlignFlags:aj});vR.on(sR.EVENT_INIT,(function(){BX.init(vR)}));var DX=function e(t,n,r){i(this,e),this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1,this.i=t,this.x=n,this.y=r};function FX(e,t,i,n,r){var a=0,s=null;if(r===function(e,t,i,n){for(var r=0,a=t,s=i-n;a<i;a+=n)r+=(e[s]-e[a])*(e[a+1]+e[s+1]),s=a;return r}(e,t,i,n)>0)for(a=t;a<i;a+=n)s=iq(a,e[a],e[a+1],s);else for(a=i-n;a>=t;a-=n)s=iq(a,e[a],e[a+1],s);return s&&JX(s,s.next)&&(nq(s),s=s.next),s}function NX(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(!e)return e;t||(t=e);var i=e,n=!1;do{if(n=!1,i.steiner||!JX(i,i.next)&&0!==QX(i.prev,i,i.next))i=i.next;else{if(nq(i),(i=t=i.prev)===i.next)return null;n=!0}}while(n||i!==t);return t}function zX(e,t,i,n,r,a){var s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;if(e){!s&&a&&XX(e,n,r,a);for(var o=e,l=null,u=null;e.prev!==e.next;)if(l=e.prev,u=e.next,a?GX(e,n,r,a):UX(e))t.push(l.i/i),t.push(e.i/i),t.push(u.i/i),nq(e),e=u.next,o=u.next;else if((e=u)===o){s?1===s?zX(e=VX(e,t,i),t,i,n,r,a,2):2===s&&HX(e,t,i,n,r,a):zX(NX(e),t,i,n,r,a,1);break}}}function UX(e){var t=e.prev,i=e,n=e.next;if(QX(t,i,n)>=0)return!1;for(var r=e.next.next;r!==e.prev;){if(KX(t.x,t.y,i.x,i.y,n.x,n.y,r.x,r.y)&&QX(r.prev,r,r.next)>=0)return!1;r=r.next}return!0}function GX(e,t,i,n){var r=e.prev,a=e,s=e.next;if(QX(r,a,s)>=0)return!1;for(var o=r.x<a.x?r.x<s.x?r.x:s.x:a.x<s.x?a.x:s.x,l=r.y<a.y?r.y<s.y?r.y:s.y:a.y<s.y?a.y:s.y,u=r.x>a.x?r.x>s.x?r.x:s.x:a.x>s.x?a.x:s.x,c=r.y>a.y?r.y>s.y?r.y:s.y:a.y>s.y?a.y:s.y,h=qX(o,l,t,i,n),f=qX(u,c,t,i,n),_=e.nextZ;_&&_.z<=f;){if(_!==e.prev&&_!==e.next&&KX(r.x,r.y,a.x,a.y,s.x,s.y,_.x,_.y)&&QX(_.prev,_,_.next)>=0)return!1;_=_.nextZ}for(_=e.prevZ;_&&_.z>=h;){if(_!==e.prev&&_!==e.next&&KX(r.x,r.y,a.x,a.y,s.x,s.y,_.x,_.y)&&QX(_.prev,_,_.next)>=0)return!1;_=_.prevZ}return!0}function VX(e,t,i){var n=e;do{var r=n.prev,a=n.next.next;!JX(r,a)&&$X(r,n,n.next,a)&&eq(r,a)&&eq(a,r)&&(t.push(r.i/i),t.push(n.i/i),t.push(a.i/i),nq(n),nq(n.next),n=e=a),n=n.next}while(n!==e);return n}function HX(e,t,i,n,r,a){var s=e;do{for(var o=s.next.next;o!==s.prev;){if(s.i!==o.i&&ZX(s,o)){var l=tq(s,o);return s=NX(s,s.next),l=NX(l,l.next),zX(s,t,i,n,r,a),void zX(l,t,i,n,r,a)}o=o.next}s=s.next}while(s!==e)}function WX(e,t){return e.x-t.x}function jX(e,t){if(t=function(e,t){var i=t,n=e.x,r=e.y,a=-1/0,s=null;do{if(r<=i.y&&r>=i.next.y){var o=i.x+(r-i.y)*(i.next.x-i.x)/(i.next.y-i.y);if(o<=n&&o>a){if(a=o,o===n){if(r===i.y)return i;if(r===i.next.y)return i.next}s=i.x<i.next.x?i:i.next}}i=i.next}while(i!==t);if(!s)return null;if(n===a)return s.prev;var l,u=s,c=s.x,h=s.y,f=1/0;i=s.next;for(;i!==u;)n>=i.x&&i.x>=c&&KX(r<h?n:a,r,c,h,r<h?a:n,r,i.x,i.y)&&((l=Math.abs(r-i.y)/(n-i.x))<f||l===f&&i.x>s.x)&&eq(i,e)&&(s=i,f=l),i=i.next;return s}(e,t)){var i=tq(t,e);NX(i,i.next)}}function XX(e,t,i,n){var r=e;do{null===r.z&&(r.z=qX(r.x,r.y,t,i,n)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next}while(r!==e);r.prevZ.nextZ=null,r.prevZ=null,function(e){var t=0,i=null,n=null,r=null,a=null,s=0,o=0,l=0,u=1;do{for(i=e,e=null,a=null,s=0;i;){for(s++,n=i,o=0,t=0;t<u&&(o++,n=n.nextZ);t++);for(l=u;o>0||l>0&&n;)0===o?(r=n,n=n.nextZ,l--):0!==l&&n?i.z<=n.z?(r=i,i=i.nextZ,o--):(r=n,n=n.nextZ,l--):(r=i,i=i.nextZ,o--),a?a.nextZ=r:e=r,r.prevZ=a,a=r;i=n}a.nextZ=null,u*=2}while(s>1)}(r)}function qX(e,t,i,n,r){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-i)/r)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-n)/r)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function YX(e){var t=e,i=e;do{t.x<i.x&&(i=t),t=t.next}while(t!==e);return i}function KX(e,t,i,n,r,a,s,o){return(r-s)*(t-o)-(e-s)*(a-o)>=0&&(e-s)*(n-o)-(i-s)*(t-o)>=0&&(i-s)*(a-o)-(r-s)*(n-o)>=0}function ZX(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!function(e,t){var i=e;do{if(i.i!==e.i&&i.next.i!==e.i&&i.i!==t.i&&i.next.i!==t.i&&$X(i,i.next,e,t))return!0;i=i.next}while(i!==e);return!1}(e,t)&&eq(e,t)&&eq(t,e)&&function(e,t){var i=e,n=!1,r=(e.x+t.x)/2,a=(e.y+t.y)/2;do{i.y>a!=i.next.y>a&&r<(i.next.x-i.x)*(a-i.y)/(i.next.y-i.y)+i.x&&(n=!n),i=i.next}while(i!==e);return n}(e,t)}function QX(e,t,i){return(t.y-e.y)*(i.x-t.x)-(t.x-e.x)*(i.y-t.y)}function JX(e,t){return e.x===t.x&&e.y===t.y}function $X(e,t,i,n){return!!(JX(e,t)&&JX(i,n)||JX(e,n)&&JX(i,t))||QX(e,t,i)>0!=QX(e,t,n)>0&&QX(i,n,e)>0!=QX(i,n,t)>0}function eq(e,t){return QX(e.prev,e,e.next)<0?QX(e,t,e.next)>=0&&QX(e,e.prev,t)>=0:QX(e,t,e.prev)<0||QX(e,e.next,t)<0}function tq(e,t){var i=new DX(e.i,e.x,e.y),n=new DX(t.i,t.x,t.y),r=e.next,a=t.prev;return e.next=t,t.prev=e,i.next=r,r.prev=i,n.next=i,i.prev=n,a.next=n,n.prev=a,n}function iq(e,t,i,n){var r=new DX(e,t,i);return n?(r.next=n.next,r.prev=n,n.next.prev=r,n.next=r):(r.prev=r,r.next=r),r}function nq(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function rq(e,t,i){i=i||3;var n=t?t.length:0,r=n?t[0]*i:e.length,a=FX(e,0,r,i,!0),s=[];if(!a)return s;var o=0,l=0,u=0,c=0,h=0,f=0,_=0;if(n&&(a=function(e,t,i,n){var r,a=[],s=0,o=null;for(s=0,r=t.length;s<r;s++)(o=FX(e,t[s]*n,s<r-1?t[s+1]*n:e.length,n,!1))&&(o===o.next&&(o.steiner=!0),a.push(YX(o)));if(a.sort(WX),!i)return i;for(s=0;s<a.length;s++)jX(a[s],i),i=NX(i,i.next);return i}(e,t,a,i)),e.length>80*i){o=u=e[0],l=c=e[1];for(var d=i;d<r;d+=i)(h=e[d])<o&&(o=h),(f=e[d+1])<l&&(l=f),h>u&&(u=h),f>c&&(c=f);_=Math.max(u-o,c-l)}return zX(a,s,i,o,l,_),s}var aq=Math.PI,sq=Math.min,oq=Math.max,lq=Math.cos,uq=Math.sin,cq=Math.abs,hq=Math.sign,fq=.5522847493;function _q(e,t,i,n,r){e.moveTo(t-n,i),e.bezierCurveTo(t-n,i+r*fq,t-n*fq,i+r,t,i+r),e.bezierCurveTo(t+n*fq,i+r,t+n,i+r*fq,t+n,i),e.bezierCurveTo(t+n,i-r*fq,t+n*fq,i-r,t,i-r),e.bezierCurveTo(t-n*fq,i-r,t-n,i-r*fq,t-n,i),e.close()}for(var dq=function(e){function t(e,n){var r;return i(this,t),(r=c(this,o(t).call(this,e,n))).dx=0,r.dy=0,r.dmx=0,r.dmy=0,r.flags=0,r.len=0,r.reset(),r}return s(t,e),r(t,[{key:"reset",value:function(){this.dx=0,this.dy=0,this.dmx=0,this.dmy=0,this.flags=0,this.len=0}}]),t}(Mi),pq=function(){function e(){i(this,e),this.closed=!1,this.nbevel=0,this.complex=!0,this.points=[],this.reset()}return r(e,[{key:"reset",value:function(){this.closed=!1,this.nbevel=0,this.complex=!0,this.points?this.points.length=0:this.points=[]}}]),e}(),mq=function(){function e(){i(this,e),this.dataOffset=0,this.updatePathOffset=!1,this.pathLength=0,this.pathOffset=0,this.paths=[],this.tessTol=.25,this.distTol=.01,this.fillColor=rr.WHITE.clone(),this.lineCap=nU.BUTT,this.strokeColor=rr.BLACK.clone(),this.lineJoin=rU.MITER,this.lineWidth=0,this.pointsOffset=0,this._commandx=0,this._commandy=0,this._points=[],this._renderDatasPool=new Qa((function(){return new Lw}),16),this._renderDatas=[],this._curPath=null}return r(e,[{key:"moveTo",value:function(e,t){this.updatePathOffset&&(this.pathOffset=this.pathLength,this.updatePathOffset=!1),this._addPath(),this.addPoint(e,t,aU.PT_CORNER),this._commandx=e,this._commandy=t}},{key:"lineTo",value:function(e,t){this.addPoint(e,t,aU.PT_CORNER),this._commandx=e,this._commandy=t}},{key:"bezierCurveTo",value:function(e,t,i,n,r,a){var s=this._curPath,o=s.points[s.points.length-1];o&&(o.x!==e||o.y!==t||i!==r||n!==a?(!function e(t,i,n,r,a,s,o,l,u,c,h){var f,_,d,p,m,v,g,y,b,E,T,S,x,A,w,C;c>10||(m=.5*(s+l),v=.5*(o+u),g=.5*((f=.5*(i+r))+(d=.5*(r+s))),y=.5*((_=.5*(n+a))+(p=.5*(a+o))),((w=cq((r-l)*(A=u-n)-(a-u)*(x=l-i)))+(C=cq((s-l)*A-(o-u)*x)))*(w+C)<t.tessTol*(x*x+A*A)?t.addPoint(l,u,0===h?h|aU.PT_BEVEL:h):(e(t,i,n,f,_,g,y,T=.5*(g+(b=.5*(d+m))),S=.5*(y+(E=.5*(p+v))),c+1,0),e(t,T,S,b,E,m,v,l,u,c+1,h)))}(this,o.x,o.y,e,t,i,n,r,a,0,aU.PT_CORNER),this._commandx=r,this._commandy=a):this.lineTo(r,a))}},{key:"quadraticCurveTo",value:function(e,t,i,n){var r=this._commandx,a=this._commandy;this.bezierCurveTo(r+2/3*(e-r),a+2/3*(t-a),i+2/3*(e-i),n+2/3*(t-n),i,n)}},{key:"arc",value:function(e,t,i,n,r,a){!function(e,t,i,n,r,a,s){var o,l,u=0,c=0,h=0,f=0,_=0,d=0,p=0,m=0,v=0,g=0,y=0,b=0,E=0,T=0;if(c=a-r,s=s||!1)if(cq(c)>=2*aq)c=2*aq;else for(;c<0;)c+=2*aq;else if(cq(c)>=2*aq)c=2*-aq;else for(;c>0;)c-=2*aq;for(l=0|oq(1,sq(cq(c)/(.5*aq)+.5,5)),h=cq(4/3*(1-lq(o=c/l/2))/uq(o)),s||(h=-h),T=0;T<=l;T++)d=t+(f=lq(u=r+c*(T/l)))*n,p=i+(_=uq(u))*n,m=-_*n*h,v=f*n*h,0===T?e.moveTo(d,p):e.bezierCurveTo(g+b,y+E,d-m,p-v,d,p),g=d,y=p,b=m,E=v}(this,e,t,i,n,r,a)}},{key:"ellipse",value:function(e,t,i,n){_q(this,e,t,i,n),this._curPath.complex=!1}},{key:"circle",value:function(e,t,i){_q(this,e,t,i,i),this._curPath.complex=!1}},{key:"rect",value:function(e,t,i,n){this.moveTo(e,t),this.lineTo(e+i,t),this.lineTo(e+i,t+n),this.lineTo(e,t+n),this.close(),this._curPath.complex=!1}},{key:"roundRect",value:function(e,t,i,n,r){!function(e,t,i,n,r,a){if(a<.1)e.rect(t,i,n,r);else{var s=sq(a,.5*cq(n))*hq(n),o=sq(a,.5*cq(r))*hq(r);e.moveTo(t,i+o),e.lineTo(t,i+r-o),e.bezierCurveTo(t,i+r-o*(1-fq),t+s*(1-fq),i+r,t+s,i+r),e.lineTo(t+n-s,i+r),e.bezierCurveTo(t+n-s*(1-fq),i+r,t+n,i+r-o*(1-fq),t+n,i+r-o),e.lineTo(t+n,i+o),e.bezierCurveTo(t+n,i+o*(1-fq),t+n-s*(1-fq),i,t+n-s,i),e.lineTo(t+s,i),e.bezierCurveTo(t+s*(1-fq),i,t,i+o*(1-fq),t,i+o),e.close()}}(this,e,t,i,n,r),this._curPath.complex=!1}},{key:"clear",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.pathLength=0,this.pathOffset=0,this.pointsOffset=0,this.dataOffset=0,this._curPath=null,this.paths.length=0,this._points.length=0;for(var t=this._renderDatas,i=0,n=t.length;i<n;i++){var r=t[i];r&&r.reset()}this._renderDatas.length=0,e&&this._renderDatasPool.reset()}},{key:"close",value:function(){this._curPath.closed=!0}},{key:"requestRenderData",value:function(){var e=this._renderDatasPool.add();return this._renderDatas.push(e),e}},{key:"getRenderDatas",value:function(){return 0===this._renderDatas.length&&this.requestRenderData(),this._renderDatas}},{key:"addPoint",value:function(e,t,i){var n=this._curPath;if(n){var r=this._points,a=n.points,s=r[this.pointsOffset++];s?(s.x=e,s.y=t):(s=new dq(e,t),r.push(s)),s.flags=i,a.push(s)}}},{key:"_addPath",value:function(){var e=this.pathLength,t=this.paths[e];return t?t.reset():(t=new pq,this.paths.push(t)),this.pathLength++,this._curPath=t,t}}]),e}(),vq=Math.PI,gq=Math.min,yq=Math.max,bq=Math.ceil,Eq=Math.acos,Tq=Math.cos,Sq=Math.sin,xq=Math.atan2,Aq=iR,wq=[],Cq=[],Rq=[],kq=[],Oq=null,Iq=null,Mq=new rr,Lq=[],Pq=0;Pq<4;Pq++)Lq.push(new zi);function Bq(e,t,i){return e<t?t:e>i?i:e}var Dq=e("graphics",{useModel:!0,createImpl:function(e){return new mq},updateRenderData:function(e){for(var t=e.impl?e.impl.getRenderDatas():[],i=0,n=t.length;i<n;i++)t[i].material=e.material},fillBuffers:function(e,t){},renderIA:function(e,t){},getRenderData:function(e,t){if(!Iq)return null;var i=Iq.getRenderDatas(),n=i[Iq.dataOffset];if(!n)return null;var r=n,a=r?r.vertexCount+t:0;return(a>65535||3*a>131070)&&(++Iq.dataOffset,Iq.dataOffset<i.length?n=i[Iq.dataOffset]:(n=Iq.requestRenderData(),i[Iq.dataOffset]=n),n.material=e.material,r=n),r&&r.vertexCount<a&&r.request(t,3*t),n},stroke:function(e){rr.copy(Mq,e.strokeColor),e.impl&&(this._flattenPaths(e.impl),this._expandStroke(e),e.impl.updatePathOffset=!0,this.end(e))},fill:function(e){rr.copy(Mq,e.fillColor),this._expandFill(e),e.impl&&(e.impl.updatePathOffset=!0),this.end(e)},end:function(e){e.model&&e.model.destroy();var t=e.impl,i=lo.TRIANGLE_LIST,n=t&&t.getRenderDatas();if(n){var r=0;wq.length=0,Cq.length=0,Rq.length=0,kq.length=0;var a=n,s=Array.isArray(a),o=0;for(a=s?a:a[Symbol.iterator]();;){var l;if(s){if(o>=a.length)break;l=a[o++]}else{if((o=a.next()).done)break;l=o.value}var u=l,c=u.byteCount>>2,h=u.vData;for(r=0;r<c;)wq.push(h[r++]),wq.push(h[r++]),wq.push(h[r++]),Cq.push(h[r++]),Cq.push(h[r++]),Rq.push(h[r++]),Rq.push(h[r++]),Rq.push(h[r++]),Rq.push(h[r++]);c=u.indiceCount;var f=u.iData;for(r=0;r<c;)kq.push(f[r++])}var _=xA({primitiveMode:i,positions:wq,uvs:Cq,colors:Rq,attributes:Aq,indices:kq},void 0,{calculateBounds:!1});e.model.initialize(e.node),e.model.initSubModel(0,_.getSubMesh(0),e.material),e.markForUpdateRenderData()}},_expandStroke:function(e){var t=.5*e.lineWidth,i=e.lineCap,n=e.lineJoin,r=e.miterLimit;if(Iq=e.impl){var a=function(e,t,i){var n=2*Eq(e/(e+i));return yq(2,bq(t/n))}(t,vq,Iq.tessTol);this._calculateJoins(Iq,t,n,r);for(var s=Iq.paths,o=0,l=Iq.pathOffset,u=Iq.pathLength;l<u;l++){var c=s[l],h=c.points.length;n===rU.ROUND?o+=2*(h+c.nbevel*(a+2)+1):o+=2*(h+5*c.nbevel+1),c.closed||(i===nU.ROUND?o+=2*(2*a+2):o+=12)}var f=Oq=this.getRenderData(e,o);if(f){for(var _=f.vData,d=f.iData,p=Iq.pathOffset,m=Iq.pathLength;p<m;p++){var v=s[p],g=v.points,y=g.length,b=f.vertexStart,E=void 0,T=void 0,S=0,x=0,A=v.closed;if(A?(E=g[y-1],T=g[0],S=0,x=y):(E=g[0],T=g[1],S=1,x=y-1),!A){var w=new dq(T.x,T.y);w.subtract(E),w.normalize();var C=w.x,R=w.y;i===nU.BUTT?this._buttCap(E,C,R,t,0):i===nU.SQUARE?this._buttCap(E,C,R,t,t):i===nU.ROUND&&this._roundCapStart(E,C,R,t,a)}for(var k=S;k<x;++k)n===rU.ROUND?this._roundJoin(E,T,t,t,a):0!=(T.flags&(aU.PT_BEVEL|aU.PT_INNERBEVEL))?this._bevelJoin(E,T,t,t):(this._vset(T.x+T.dmx*t,T.y+T.dmy*t),this._vset(T.x-T.dmx*t,T.y-T.dmy*t)),E=T,T=g[k+1];if(A){var O=9*b,I=_.slice(O,O+9);_.set(I,9*f.vertexStart),O+=9,f.vertexStart++,I=_.slice(O,O+9),_.set(I,9*f.vertexStart),f.vertexStart++}else{var M=new dq(T.x,T.y);M.subtract(E),M.normalize();var L=M.x,P=M.y;i===nU.BUTT?this._buttCap(T,L,P,t,0):i===nU.SQUARE?this._buttCap(T,L,P,t,t):i===nU.ROUND&&this._roundCapEnd(T,L,P,t,a)}for(var B=f.indiceStart,D=b+2,F=f.vertexStart;D<F;D++)d[B++]=D-2,d[B++]=D-1,d[B++]=D;if(f.indiceStart=B,B!==f.indiceCount){var N=new Array(f.indiceCount-B);f.iData.set(N,B)}}Oq=null,Iq=null}}},_expandFill:function(e){if(Iq=e.impl){for(var t=Iq.paths,i=0,n=Iq.pathOffset,r=Iq.pathLength;n<r;n++){i+=t[n].points.length}var a=Oq=this.getRenderData(e,i);if(a){for(var s=a,o=s.vData,l=s.iData,u=Iq.pathOffset,c=Iq.pathLength;u<c;u++){var h=t[u],f=h.points,_=f.length;if(0!==_){for(var d=a.vertexStart,p=0;p<_;++p)this._vset(f[p].x,f[p].y);var m=a.indiceStart;if(h.complex){for(var v=[],g=d,y=a.vertexStart;g<y;g++){var b=9*g;v.push(o[b++]),v.push(o[b++]),v.push(o[b++])}var E=rq(v,null,3);if(!E||0===E.length)continue;for(var T=0,S=E.length;T<S;T++)l[m++]=E[T]+d}else for(var x=d,A=d+2,w=s.vertexStart;A<w;A++)l[m++]=x,l[m++]=A-1,l[m++]=A;if(s.indiceStart=m,m!==s.indiceCount){var C=new Array(s.indiceCount-m);s.iData.set(C,m)}}}Oq=null,Iq=null}}},_calculateJoins:function(e,t,i,n){var r=0;t>0&&(r=1/t);for(var a=e.paths,s=e.pathOffset,o=e.pathLength;s<o;s++){var l=a[s],u=l.points,c=u.length,h=u[c-1],f=u[0];l.nbevel=0;for(var _=0;_<c;_++){var d,p,m=h.dy,v=-h.dx,g=f.dy,y=-f.dx;if(f.dmx=.5*(m+g),f.dmy=.5*(v+y),(d=f.dmx*f.dmx+f.dmy*f.dmy)>1e-6){var b=1/d;b>600&&(b=600),f.dmx*=b,f.dmy*=b}f.dx*h.dy-h.dx*f.dy>0&&(f.flags|=aU.PT_LEFT),d*(p=yq(11,gq(h.len,f.len)*r))*p<1&&(f.flags|=aU.PT_INNERBEVEL),f.flags&aU.PT_CORNER&&(d*n*n<1||i===rU.BEVEL||i===rU.ROUND)&&(f.flags|=aU.PT_BEVEL),0!=(f.flags&(aU.PT_BEVEL|aU.PT_INNERBEVEL))&&l.nbevel++,h=f,f=u[_+1]}}},_flattenPaths:function(e){for(var t=e.paths,i=e.pathOffset,n=e.pathLength;i<n;i++){var r=t[i],a=r.points,s=a[a.length-1],o=a[0];s.equals(o)&&(r.closed=!0,a.pop(),s=a[a.length-1]);for(var l=0,u=a.length;l<u;l++){var c=new dq(o.x,o.y);c.subtract(s),s.len=c.length(),(c.x||c.y)&&c.normalize(),s.dx=c.x,s.dy=c.y,s=o,o=a[l+1]}}},_chooseBevel:function(e,t,i,n){var r=i.x,a=i.y,s=0,o=0,l=0,u=0;return 0!==e?(s=r+t.dy*n,o=a-t.dx*n,l=r+i.dy*n,u=a-i.dx*n):(s=l=r+i.dmx*n,o=u=a+i.dmy*n),[s,o,l,u]},_buttCap:function(e,t,i,n,r){var a=e.x-t*r,s=e.y-i*r,o=i,l=-t;this._vset(a+o*n,s+l*n),this._vset(a-o*n,s-l*n)},_roundCapStart:function(e,t,i,n,r){for(var a=e.x,s=e.y,o=i,l=-t,u=0;u<r;u++){var c=u/(r-1)*vq,h=Tq(c)*n,f=Sq(c)*n;this._vset(a-o*h-t*f,s-l*h-i*f),this._vset(a,s)}this._vset(a+o*n,s+l*n),this._vset(a-o*n,s-l*n)},_roundCapEnd:function(e,t,i,n,r){var a=e.x,s=e.y,o=i,l=-t;this._vset(a+o*n,s+l*n),this._vset(a-o*n,s-l*n);for(var u=0;u<r;u++){var c=u/(r-1)*vq,h=Tq(c)*n,f=Sq(c)*n;this._vset(a,s),this._vset(a-o*h+t*f,s-l*h+i*f)}},_roundJoin:function(e,t,i,n,r){var a=e.dy,s=-e.dx,o=t.dy,l=-t.dx,u=t.x,c=t.y;if(0!=(t.flags&aU.PT_LEFT)){var h=this._chooseBevel(t.flags&aU.PT_INNERBEVEL,e,t,i),f=h[0],_=h[1],d=h[2],p=h[3],m=xq(-s,-a),v=xq(-l,-o);v>m&&(v-=2*vq),this._vset(f,_),this._vset(u-a*n,t.y-s*n);for(var g=Bq(bq((m-v)/vq)*r,2,r),y=0;y<g;y++){var b=m+y/(g-1)*(v-m),E=u+Tq(b)*n,T=c+Sq(b)*n;this._vset(u,c),this._vset(E,T)}this._vset(d,p),this._vset(u-o*n,c-l*n)}else{var S=this._chooseBevel(t.flags&aU.PT_INNERBEVEL,e,t,-n),x=S[0],A=S[1],w=S[2],C=S[3],R=xq(s,a),k=xq(l,o);k<R&&(k+=2*vq),this._vset(u+a*n,c+s*n,0),this._vset(x,A,0);for(var O=Bq(bq((k-R)/vq)*r,2,r),I=0;I<O;I++){var M=R+I/(O-1)*(k-R),L=u+Tq(M)*i,P=c+Sq(M)*i;this._vset(L,P,0),this._vset(u,c,0)}this._vset(u+o*n,c+l*n),this._vset(w,C)}},_bevelJoin:function(e,t,i,n){var r=0,a=0,s=0,o=0,l=0,u=0,c=0,h=0,f=e.dy,_=-e.dx,d=t.dy,p=-t.dx;if(t.flags&aU.PT_LEFT){var m=this._chooseBevel(t.flags&aU.PT_INNERBEVEL,e,t,i);l=m[0],u=m[1],c=m[2],h=m[3],this._vset(l,u,0),this._vset(t.x-f*n,t.y-_*n,0),this._vset(c,h,0),this._vset(t.x-d*n,t.y-p*n,0)}else{var v=this._chooseBevel(t.flags&aU.PT_INNERBEVEL,e,t,-n);r=v[0],a=v[1],s=v[2],o=v[3],this._vset(t.x+f*i,t.y+_*i,0),this._vset(r,a),this._vset(t.x+d*i,t.y+p*i,0),this._vset(s,o)}},_vset:function(e,t){if(Oq){var i=Oq,n=9*i.vertexStart,r=i.vData;r[n++]=e,r[n++]=t,r[n++]=0,r[n++]=1,r[n++]=1,rr.toArray(r,Mq,n),i.vertexStart++}}}),Fq=e("graphicsAssembler",{getAssembler:function(e){return Dq}});WU.Assembler=Fq;var Nq=function e(){i(this,e),this.u=0,this.v=0,this.width=0,this.height=0,this.offsetX=0,this.offsetY=0,this.textureID=0,this.validDefinition=!1,this.xAdvance=0},zq=function(){function e(){i(this,e),this._letterDefinitions={}}return r(e,[{key:"addLetterDefinitions",value:function(e,t){this._letterDefinitions[e]=t}},{key:"cloneLetterDefinition",value:function(){for(var e={},t=0,i=Object.keys(this._letterDefinitions);t<i.length;t++){var n=i[t],r=new Nq;Fe(r,this._letterDefinitions[n]),e[n]=r}return e}},{key:"assignLetterDefinitions",value:function(e){for(var t=0,i=Object.keys(this._letterDefinitions);t<i.length;t++){var n=i[t],r=e[n];Fe(this._letterDefinitions[n],r)}}},{key:"scaleFontLetterDefinition",value:function(e){for(var t=0,i=Object.keys(this._letterDefinitions);t<i.length;t++){var n=i[t],r=this._letterDefinitions[n];r.width*=e,r.height*=e,r.offsetX*=e,r.offsetY*=e,r.xAdvance*=e}}},{key:"getLetterDefinitionForChar",value:function(e){return this._letterDefinitions[e.charCodeAt(0)]}},{key:"letterDefinitions",get:function(){return this._letterDefinitions}}]),e}();cc.FontAtlas=zq;var Uq=function e(){i(this,e),this.char="",this.valid=!0,this.positionX=0,this.positionY=0,this.lineIndex=0},Gq=new Jn,Vq=null,Hq=[],Wq=[],jq=[],Xq=[],qq=new Xn,Yq=null,Kq=null,Zq=0,Qq=0,Jq=0,$q=0,eY=0,tY=1,iY=null,nY="",rY=0,aY=0,sY=new Xn,oY=0,lY=0,uY=0,cY=0,hY=0,fY=!1,_Y=0,dY=0,pY=0,mY={updateRenderData:function(e){e.renderData&&e.renderData.vertDirty&&Vq!==e&&(Vq=e,this._updateProperties(),this._updateContent(),Vq.actualFontSize=rY,Vq.node.setContentSize(sY),Vq.renderData.vertDirty=Vq.renderData.uvDirty=!1,Vq=null,this._resetProperties())},_updateFontScale:function(){tY=rY/aY},_updateProperties:function(){if(Vq){var e=Vq.font;if(e){if(iY=e.spriteFrame,Kq=e.fntConfig,!(Yq=Vq.fontAtlas)){Yq=new zq;for(var t=Kq.fontDefDictionary,i=0,n=Object.keys(t);i<n.length;i++){var r=n[i],a=new Nq,s=t[r].rect;a.offsetX=t[r].xOffset,a.offsetY=t[r].yOffset,a.width=s.width,a.height=s.height,a.u=s.x,a.v=s.y,a.textureID=0,a.validDefinition=!0,a.xAdvance=t[r].xAdvance,Yq.addLetterDefinitions(r,a)}Vq.fontAtlas=Yq}nY=Vq.string.toString(),rY=Vq.fontSize,aY=Kq.fontSize;var o=Vq.node.getContentSize();sY.width=o.width,sY.height=o.height,oY=Vq.horizontalAlign,lY=Vq.verticalAlign,uY=Vq.spacingX,hY=Vq.overflow,cY=Vq.lineHeight,fY=hY!==lN.NONE&&(hY===lN.RESIZE_HEIGHT||Vq.enableWrapText),this._setupBMFontOverflowMetrics()}}},_resetProperties:function(){Yq=null,Kq=null,iY=null},_updateContent:function(){this._updateFontScale(),this._computeHorizontalKerningForText(),this._alignText()},_computeHorizontalKerningForText:function(){for(var e=nY,t=e.length,i=Kq.kerningDict,n=Hq,r=-1,a=0;a<t;++a){var s=e.charCodeAt(a),o=i[r<<16|65535&s]||0;n[a]=a<t-1?o:0,r=s}},_multilineTextWrap:function(e){var t=nY.length,i=0,n=0,r=0,a=0,s=0,o=0,l=0,u=null,c=new Mi;this._updateFontScale();for(var h=Yq.letterDefinitions,f=0;f<t;){var _=nY.charAt(f);if("\n"!==_){for(var d=e(nY,f,t),p=o,m=l,v=s,g=n,y=!1,b=0;b<d;++b){var E=f+b;if("\r"!==(_=nY.charAt(E)))if(u=Yq&&Yq.getLetterDefinitionForChar(_)){var T=g+u.offsetX*tY;if(fY&&pY>0&&n>0&&T+u.width*tY>pY&&!as(_)){jq.push(s),s=0,i++,n=0,r-=cY*tY+0,y=!0;break}c.x=T,c.y=r-u.offsetY*tY,this._recordLetterInfo(h,c,_,E,i),E+1<Hq.length&&E<t-1&&(g+=Hq[E+1]),g+=u.xAdvance*tY+uY,v=c.x+u.width*tY,p<c.y&&(p=c.y),m>c.y-u.height*tY&&(m=c.y-u.height*tY)}else this._recordPlaceholderInfo(E,_),console.log("Can't find letter definition in texture atlas "+Kq.atlasName+" for letter:"+_);else this._recordPlaceholderInfo(E,_)}y||(n=g,o<p&&(o=p),l>m&&(l=m),a<(s=v)&&(a=s),f+=d)}else jq.push(s),s=0,i++,n=0,r-=cY*tY+0,this._recordPlaceholderInfo(f,_),f++}return jq.push(s),Qq=(Zq=i+1)*cY*tY,Zq>1&&(Qq+=0*(Zq-1)),sY.width=_Y,sY.height=dY,_Y<=0&&(sY.width=parseFloat(a.toFixed(2))),dY<=0&&(sY.height=parseFloat(Qq.toFixed(2))),$q=sY.height,eY=0,o>0&&($q=sY.height+o),l<-Qq&&(eY=Qq+l),!0},_getFirstCharLen:function(){return 1},_getFirstWordLen:function(e,t,i){var n=e.charAt(t);if(rs(n)||"\n"===n||as(n))return 1;var r=1,a=Yq&&Yq.getLetterDefinitionForChar(n);if(!a)return r;for(var s=a.xAdvance*tY+uY,o=t+1;o<i&&(n=e.charAt(o),a=Yq&&Yq.getLetterDefinitionForChar(n));++o){if(s+a.offsetX*tY+a.width*tY>pY&&!as(n)&&pY>0)return r;if(s+=a.xAdvance*tY+uY,"\n"===n||as(n)||rs(n))break;r++}return r},_multilineTextWrapByWord:function(){return this._multilineTextWrap(this._getFirstWordLen)},_multilineTextWrapByChar:function(){return this._multilineTextWrap(this._getFirstCharLen)},_recordPlaceholderInfo:function(e,t){if(e>=Wq.length){var i=new Uq;Wq.push(i)}Wq[e].char=t,Wq[e].valid=!1},_recordLetterInfo:function(e,t,i,n,r){if(n>=Wq.length){var a=new Uq;Wq.push(a)}var s=i.charCodeAt(0);Wq[n].lineIndex=r,Wq[n].char=i,Wq[n].valid=e[s].validDefinition,Wq[n].positionX=t.x,Wq[n].positionY=t.y},_alignText:function(){Qq=0,jq.length=0,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),hY===lN.SHRINK&&rY>0&&this._isVerticalClamp()&&this._shrinkLabelToContentSize(this._isVerticalClamp),this._updateQuads()||hY===lN.SHRINK&&this._shrinkLabelToContentSize(this._isHorizontalClamp)},_scaleFontSizeDown:function(e){var t=!0;e||(e=.1,t=!1),rY=e,t&&this._updateContent()},_shrinkLabelToContentSize:function(e){for(var t=rY,i=cY,n=Yq,r=0,a=n?n.cloneLetterDefinition():{},s=!0;e();){var o=t-++r;if(s=!1,o<=0)break;var l=o/t;n&&(n.assignLetterDefinitions(a),n.scaleFontLetterDefinition(l)),cY=i*l,this._multilineTextWrapByWord(),this._computeAlignmentOffset()}cY=i,n&&n.assignLetterDefinitions(a),s||t-r>=0&&this._scaleFontSizeDown(t-r)},_isVerticalClamp:function(){return Qq>sY.height},_isHorizontalClamp:function(){if(Yq){for(var e=!1,t=0,i=nY.length;t<i;++t){var n=Wq[t];if(n.valid){var r=Yq.getLetterDefinitionForChar(n.char);if(!r)continue;var a=n.positionX+r.width/2*tY,s=n.lineIndex;if(_Y>0)if(fY){if(jq[s]>sY.width&&(a>sY.width||a<0)){e=!0;break}}else if(a>sY.width){e=!0;break}}}return e}},_isHorizontalClamped:function(e,t){var i=jq[t],n=e>sY.width||e<0;return fY?i>sY.width&&n:n},_updateQuads:function(){if(!Vq)return!1;var e=Yq?Yq.letterDefinitions:{},t=iY,i=Vq.node,n=Vq.renderData;n.dataLength=n.vertexCount=n.indiceCount=0;for(var r=i.getAnchorPoint(),a=sY,s=r.x*a.width,o=r.y*a.height,l=!0,u=0,c=nY.length;u<c;++u){var h=Wq[u];if(h.valid){var f=e[h.char.charCodeAt(0)];if(f){Gq.height=f.height,Gq.width=f.width,Gq.x=f.u,Gq.y=f.v;var _=h.positionY+Jq;if(dY>0){if(_>$q){var d=_-$q;Gq.y+=d,Gq.height-=d,_-=d}_-f.height*tY<eY&&(Gq.height=_<eY?0:_-eY)}var p=h.lineIndex,m=h.positionX+f.width/2*tY+Xq[p];if(_Y>0&&this._isHorizontalClamped(m,p))if(hY===lN.CLAMP)Gq.width=0;else if(hY===lN.SHRINK){if(sY.width>f.width){l=!1;break}Gq.width=0}if(iY&&Gq.height>0&&Gq.width>0){var v=iY.isRotated(),g=iY.getOriginalSize(),y=iY.getRect(),b=iY.getOffset(),E=b.x+(g.width-y.width)/2,T=b.y-(g.height-y.height)/2;if(v){var S=Gq.x;Gq.x=y.x+y.height-Gq.y-Gq.height-T,Gq.y=S+y.y-E,Gq.y<0&&(Gq.height=Gq.height+T)}else Gq.x+=y.x-E,Gq.y+=y.y+T;var x=h.positionX+Xq[h.lineIndex];this.appendQuad(Vq,t,Gq,v,x-s,_-o,tY)}}else console.warn("Can't find letter in this bitmap-font")}}return l},appendQuad:function(e,t,i,n,r,a,s){},_computeAlignmentOffset:function(){switch(Xq.length=0,oY){case sN.LEFT:for(var e=0;e<Zq;++e)Xq.push(0);break;case sN.CENTER:for(var t=0,i=jq.length;t<i;t++)Xq.push((sY.width-jq[t])/2);break;case sN.RIGHT:for(var n=0,r=jq.length;n<r;n++)Xq.push(sY.width-jq[n])}switch(lY){case oN.TOP:Jq=sY.height;break;case oN.CENTER:Jq=(sY.height+Qq)/2;break;case oN.BOTTOM:Jq=Qq}},_setupBMFontOverflowMetrics:function(){var e=sY.width,t=sY.height;hY===lN.RESIZE_HEIGHT&&(t=0),hY===lN.NONE&&(e=0,t=0),_Y=e,dY=t,qq.width=e,qq.height=t,pY=e}},vY=e("bmfont",{createData:function(e){return e.requestRenderData()},fillBuffers:function(e,t){bF(e.node,t,e.renderData,e.color)},appendQuad:function(e,t,i,n,r,a,s){var o=e.renderData;if(o){var l=o.dataLength;o.dataLength+=4,o.vertexCount=o.dataLength,o.indiceCount=o.dataLength/2*3;var u=o.datas,c=t.width,h=t.height,f=i.width,_=i.height,d=0,p=0,m=0,v=0;n?(d=i.x/c,v=(i.x+_)/c,p=(i.y+f)/h,m=i.y/h,u[l].u=d,u[l].v=m,u[l+1].u=d,u[l+1].v=p,u[l+2].u=v,u[l+2].v=m,u[l+3].u=v,u[l+3].v=p):(d=i.x/c,v=(i.x+f)/c,p=(i.y+_)/h,m=i.y/h,u[l].u=d,u[l].v=p,u[l+1].u=v,u[l+1].v=p,u[l+2].u=d,u[l+2].v=m,u[l+3].u=v,u[l+3].v=m),u[l].x=r,u[l].y=a-_*s,u[l+1].x=r+f*s,u[l+1].y=a-_*s,u[l+2].x=r,u[l+2].y=a,u[l+3].x=r+f*s,u[l+3].y=a}}});De(vY,mY);var gY=hN.Overflow,yY=rr.WHITE.clone(),bY=hN.HorizontalAlign,EY=hN.VerticalAlign,TY=function e(){i(this,e),this.char="",this.valid=!0,this.x=0,this.y=0,this.line=0,this.hash=""},SY=function e(){i(this,e),this.u=0,this.v=0,this.w=0,this.h=0,this.texture=null,this.offsetX=0,this.offsetY=0,this.valid=!1,this.xAdvance=0},xY=function(){function e(t,n){i(this,e),this.image=null,this.data=null,this.canvas=null,this.context=null,this.width=0,this.height=0,this.char=t,this.labelInfo=n,this.hash=t.charCodeAt(0)+n.hash}return r(e,[{key:"updateRenderData",value:function(){this._updateProperties(),this._updateTexture()}},{key:"destroy",value:function(){this.image=null}},{key:"_updateProperties",value:function(){if(this.data=hN._canvasPool.get(),this.canvas=this.data.canvas,this.context=this.data.context,this.context){this.context.font=this.labelInfo.fontDesc;var e=ss(this.context,this.char);this.width=parseFloat(e.toFixed(2)),this.height=this.labelInfo.fontSize}this.canvas.width!==this.width&&(this.canvas.width=this.width),this.canvas.height!==this.height&&(this.canvas.height=this.height),this.image||(this.image=new Ju),this.image.reset(this.canvas)}},{key:"_updateTexture",value:function(){if(this.context&&this.canvas){var e=this.context,t=this.labelInfo,i=this.canvas.width,n=this.canvas.height;e.textAlign="center",e.textBaseline="middle",e.clearRect(0,0,i,n),e.fillStyle="rgba(255, 255, 255, 0.005)",e.fillRect(0,0,i,n),e.font=t.fontDesc;var r=i/2,a=n/2,s=t.color;if(e.lineJoin="round",e.fillStyle="rgba(".concat(s.r,", ").concat(s.g,", ").concat(s.b,", ",1,")"),t.isOutlined){var o=t.out||yY;e.strokeStyle="rgba(".concat(o.r,", ").concat(o.g,", ").concat(o.b,", ").concat(o.a/255,")"),e.lineWidth=2*t.margin,e.strokeText(this.char,r,a)}e.fillText(this.char,r,a)}}}]),e}(),AY=function(e){function t(){return i(this,t),c(this,o(t).apply(this,arguments))}return s(t,e),r(t,[{key:"initWithSize",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:zu.RGBA8888;this.reset({width:e,height:t,format:i}),this.loaded=!0,this.emit("load")}},{key:"drawTextureAt",value:function(e,t,i){var n=this.getGFXTexture();if(e&&n){var r=this._getGFXDevice();if(r){var a={buffOffset:0,buffStride:0,buffTexHeight:0,texOffset:{x:t,y:i,z:0},texExtent:{width:e.width,height:e.height,depth:1},texSubres:{baseMipLevel:0,levelCount:1,baseArrayLayer:0,layerCount:1}};r.copyTexImagesToTexture([e.data],n,[a])}else console.warn("Unable to get device")}}}]),t}(Uc),wY=function(){function e(t,n){i(this,e),this._x=2,this._y=2,this._nextY=2,this._width=0,this._height=0,this._letterDefinitions=new Map,this._dirty=!1,this.texture=new AY,this.texture.initWithSize(t,n),this._width=t,this._height=n,vR.on(sR.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)}return r(e,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}}]),r(e,[{key:"insertLetterTexture",value:function(e){var t=e.image,i=vR.root.device;if(!t||!this.texture||!i)return null;var n=t.width,r=t.height;if(this._x+n+2>this._width&&(this._x=2,this._y=this._nextY),this._y+r>this._nextY&&(this._nextY=this._y+r+2),this._nextY>this._height)return null;this.texture.drawTextureAt(t,this._x,this._y),this._dirty=!0;var a=new SY;return a.u=this._x,a.v=this._y,a.texture=this.texture,a.valid=!0,a.w=e.width,a.h=e.height,a.xAdvance=e.width,this._x+=n+2,this._letterDefinitions.set(e.hash,a),a}},{key:"update",value:function(){this._dirty&&(this._dirty=!1)}},{key:"reset",value:function(){this._x=2,this._y=2,this._nextY=2,this._letterDefinitions.clear()}},{key:"destroy",value:function(){this.reset(),this.texture&&this.texture.destroy()}},{key:"beforeSceneLoad",value:function(){this.destroy();var e=new AY;e.initWithSize(this._width,this._height),this.texture=e}},{key:"getLetter",value:function(e){return this._letterDefinitions.get(e)}},{key:"addLetterDefinitions",value:function(e,t){this._letterDefinitions[e]=t}},{key:"cloneLetterDefinition",value:function(){for(var e={},t=0,i=Object.keys(this._letterDefinitions);t<i.length;t++){var n=i[t],r=new SY;Fe(r,this._letterDefinitions[n]),e[n]=r}return e}},{key:"assignLetterDefinitions",value:function(e){var t=this;e.forEach((function(e,i){Fe(t._letterDefinitions[i],e)}))}},{key:"scaleFontLetterDefinition",value:function(e){for(var t=0,i=Object.keys(this._letterDefinitions);t<i.length;t++){var n=i[t],r=this._letterDefinitions[n];r.w*=e,r.h*=e,r.offsetX*=e,r.offsetY*=e,r.xAdvance*=e}}},{key:"getLetterDefinitionForChar",value:function(e,t){var i=e.charCodeAt(0)+t.hash,n=this._letterDefinitions.get(i);if(!n){var r=new xY(e,t);r.updateRenderData(),n=this.insertLetterTexture(r),r.destroy()}return n}}]),e}(),CY=new Jn,RY=null,kY=[],OY=[],IY=[],MY=[],LY=new Xn,PY=null,BY=0,DY=0,FY=0,NY=0,zY=0,UY=1,GY="",VY=0,HY=0,WY=new Xn,jY=0,XY=0,qY=0,YY=0,KY=0,ZY=!1,QY=0,JY=0,$Y=0,eK="",tK=!1,iK={fontSize:0,lineHeight:0,hash:"",fontFamily:"",fontDesc:"Arial",hAlign:0,vAlign:0,color:yY,isOutlined:!1,out:yY,margin:0},nK={getAssemblerData:function(){return PY||(PY=new wY(1024,1024)),PY.texture},updateRenderData:function(e){e.renderData&&e.renderData.vertDirty&&RY!==e&&(RY=e,this._updateFontFamily(e),iK.fontFamily=eK,this._updateProperties(),iK.fontDesc=this._getFontDesc(),this._updateContent(),RY.actualFontSize=VY,RY.node.setContentSize(WY),RY.renderData.vertDirty=RY.renderData.uvDirty=!1,RY=null,this._resetProperties())},_updateFontScale:function(){UY=VY/HY},_updateProperties:function(){if(RY){GY=RY.string.toString(),VY=RY.fontSize,HY=VY;var e=RY.node.getContentSize();WY.width=e.width,WY.height=e.height,jY=RY.horizontalAlign,XY=RY.verticalAlign,qY=RY.spacingX,KY=RY.overflow,YY=RY.lineHeight,tK=RY.isBold,ZY=KY!==gY.NONE&&(KY===gY.RESIZE_HEIGHT||RY.enableWrapText);var t=RY.getComponent(YG);t&&t.enabled?(iK.isOutlined=!0,iK.margin=t.width,iK.out=t.color,iK.out.a=t.color.a*RY.color.a/255):(iK.isOutlined=!1,iK.margin=0),iK.lineHeight=YY,iK.fontSize=VY,iK.fontFamily=eK,iK.color=RY.color,iK.hash=this._computeHash(iK),this._setupBMFontOverflowMetrics()}},_updateFontFamily:function(e){e.useSystemFont?eK=e.fontFamily:e.font?e.font._nativeAsset?eK=e.font._nativeAsset:(eK=Oy.getRes(e.font.nativeUrl)||"")||Oy.load(e.font.nativeUrl,(function(t,i){eK=i||"Arial",e.font&&(e.font._nativeAsset=i),e.updateRenderData(!0)})):eK="Arial"},_computeHash:function(e){var t=e.color.toHEX("#rrggbb"),i="";return e.isOutlined&&(i=e.out.toHEX("#rrggbb")),""+e.fontSize+e.fontFamily+t+i},_getFontDesc:function(){var e=VY.toString()+"px ";return e+=eK,tK&&(e="bold "+e),e},_resetProperties:function(){},_updateContent:function(){this._updateFontScale(),this._alignText()},_computeHorizontalKerningForText:function(){},_multilineTextWrap:function(e){var t=GY.length,i=0,n=0,r=0,a=0,s=0,o=0,l=0,u=null,c=new Mi(0,0);this._updateFontScale();for(var h=0;h<t;){var f=GY.charAt(h);if("\n"!==f){for(var _=e(GY,h,t),d=o,p=l,m=s,v=n,g=!1,y=0;y<_;++y){var b=h+y;if("\r"!==(f=GY.charAt(b)))if(u=PY&&PY.getLetterDefinitionForChar(f,iK)){var E=v+u.offsetX*UY;if(ZY&&$Y>0&&n>0&&E+u.w*UY>$Y&&!as(f)){IY.push(s),s=0,i++,n=0,r-=YY*UY+0,g=!0;break}c.x=E,c.y=r-u.offsetY*UY,this._recordLetterInfo(c,f,b,i),b+1<kY.length&&b<t-1&&(v+=kY[b+1]),v+=u.xAdvance*UY+qY,m=c.x+u.w*UY,d<c.y&&(d=c.y),p>c.y-u.h*UY&&(p=c.y-u.h*UY)}else this._recordPlaceholderInfo(b,f);else this._recordPlaceholderInfo(b,f)}g||(n=v,o<d&&(o=d),l>p&&(l=p),a<(s=m)&&(a=s),h+=_)}else IY.push(s),s=0,i++,n=0,r-=YY*UY+0,this._recordPlaceholderInfo(h,f),h++}return IY.push(s),DY=(BY=i+1)*YY*UY,BY>1&&(DY+=0*(BY-1)),WY.width=QY,WY.height=JY,QY<=0&&(WY.width=parseFloat(a.toFixed(2))),JY<=0&&(WY.height=parseFloat(DY.toFixed(2))),NY=WY.height,zY=0,o>0&&(NY=WY.height+o),l<-DY&&(zY=DY+l),!0},_getFirstCharLen:function(){return 1},_getFirstWordLen:function(e,t,i){var n=e.charAt(t);if(rs(n)||"\n"===n||as(n))return 1;if(PY){var r=1,a=PY.getLetterDefinitionForChar(n,iK);if(!a)return r;for(var s=a.xAdvance*UY+qY,o=t+1;o<i&&(n=e.charAt(o),a=PY.getLetterDefinitionForChar(n,iK));++o){if(s+a.offsetX*UY+a.w*UY>$Y&&!as(n)&&$Y>0)return r;if(s+=a.xAdvance*UY+qY,"\n"===n||as(n)||rs(n))break;r++}return r}},_multilineTextWrapByWord:function(){return this._multilineTextWrap(this._getFirstWordLen)},_multilineTextWrapByChar:function(){return this._multilineTextWrap(this._getFirstCharLen)},_recordPlaceholderInfo:function(e,t){if(e>=OY.length){var i=new TY;OY.push(i)}OY[e].char=t,OY[e].hash=t.charCodeAt(0)+iK.hash,OY[e].valid=!1},_recordLetterInfo:function(e,t,i,n){if(i>=OY.length){var r=new TY;OY.push(r)}var a=t.charCodeAt(0)+iK.hash;OY[i].line=n,OY[i].char=t,OY[i].hash=a;var s=PY&&PY.getLetter(a);OY[i].valid=!!s&&!!s.valid,OY[i].x=e.x,OY[i].y=e.y},_alignText:function(){DY=0,IY.length=0,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),this._updateQuads()},_scaleFontSizeDown:function(e){var t=!0;e||(e=.1,t=!1),VY=e,t&&this._updateContent()},_isVerticalClamp:function(){return DY>WY.height},_isHorizontalClamp:function(){for(var e=!1,t=0,i=GY.length;t<i;++t){var n=OY[t];if(n.valid){var r=PY.getLetter(n.hash);if(!r)continue;var a=n.x+r.w*UY,s=n.line;if(QY>0)if(ZY){if(IY[s]>WY.width&&(a>WY.width||a<0)){e=!0;break}}else if(a>WY.width){e=!0;break}}}return e},_isHorizontalClamped:function(e,t){var i=IY[t],n=e>WY.width||e<0;return ZY?i>WY.width&&n:n},_updateQuads:function(){if(RY&&PY){var e=PY.texture,t=RY.node,i=RY.renderData;i.dataLength=i.vertexCount=i.indiceCount=0;for(var n=WY,r=t.getAnchorPoint(),a=r.x*n.width,s=r.y*n.height,o=!0,l=0,u=GY.length;l<u;++l){var c=OY[l];if(c.valid){var h=PY.getLetter(c.hash);if(h){CY.height=h.h,CY.width=h.w,CY.x=h.u,CY.y=h.v;var f=c.y+FY;if(JY>0){if(f>NY){var _=f-NY;CY.y+=_,CY.height-=_,f-=_}f-h.h*UY<zY&&(CY.height=f<zY?0:f-zY)}var d=c.line,p=c.x+h.w/2*UY+MY[d];if(QY>0&&this._isHorizontalClamped(p,d))if(KY===gY.CLAMP)CY.width=0;else if(KY===gY.SHRINK){if(WY.width>h.w){o=!1;break}CY.width=0}if(CY.height>0&&CY.width>0){var m=c.x+MY[c.line];this.appendQuad(RY,e,CY,!1,m-a,f-s,UY)}}}}return o}},appendQuad:function(e,t,i,n,r,a,s){},_computeAlignmentOffset:function(){switch(MY.length=0,jY){case bY.LEFT:for(var e=0;e<BY;++e)MY.push(0);break;case bY.CENTER:for(var t=0,i=IY.length;t<i;t++)MY.push((WY.width-IY[t])/2);break;case bY.RIGHT:for(var n=0,r=IY.length;n<r;n++)MY.push(WY.width-IY[n])}switch(XY){case EY.TOP:FY=WY.height;break;case EY.CENTER:FY=(WY.height+DY)/2-(YY-VY)/2;break;case EY.BOTTOM:FY=(WY.height+DY)/2-(YY-VY)}},_setupBMFontOverflowMetrics:function(){var e=WY.width,t=WY.height;KY===gY.RESIZE_HEIGHT&&(t=0),KY===gY.NONE&&(e=0,t=0),QY=e,JY=t,LY.width=e,LY.height=t,$Y=e}},rK=new rr(255,255,255,255),aK=e("letter",{createData:function(e){return e.requestRenderData()},fillBuffers:function(e,t){if(e.renderData){var i=e.node;rK.a=e.color.a,bF(i,t,e.renderData,rK)}},appendQuad:vY.appendQuad});De(aK,nK);var sK=hN.Overflow,oK=rr.WHITE.clone(),lK=Ue(YG,Ph),uK=null,cK=null,hK=null,fK="",_K="",dK=0,pK=0,mK=[],vK=new Xn,gK=0,yK=0,bK=0,EK=new rr,TK="",SK=sK.NONE,xK=!1,AK=!1,wK=new rr,CK=0,RK=0,kK=!1,OK=!1,IK=!1,MK={getAssemblerData:function(){var e=hN._canvasPool.get();return e.canvas.width=e.canvas.height=1,e},resetAssemblerData:function(e){e&&hN._canvasPool.put(e)},updateRenderData:function(e){e.renderData&&e.renderData.vertDirty&&(this._updateFontFamly(e),this._updateProperties(e),this._calculateLabelFont(),this._calculateSplitedStrings(),this._updateLabelDimensions(),this._calculateTextBaseline(),this._updateTexture(),e.actualFontSize=dK,e.node.setContentSize(vK),this.updateVerts(e),e.markForUpdateRenderData(!1),uK=null,cK=null,hK=null)},updateVerts:function(e){},_updateFontFamly:function(e){e.useSystemFont?TK=e.fontFamily:e.font?e.font._nativeAsset?TK=e.font._nativeAsset:Oy.load(e.font.nativeUrl,(function(t,i){TK=i||"Arial",e.updateRenderData(!0)})):TK="Arial"},_updateProperties:function(e){var t=e.assemblerData;if(t){uK=t.context,cK=t.canvas,hK=e.spriteFrame,_K=e.string.toString(),dK=e.fontSize,pK=dK,SK=e.overflow,vK.width=e.node.width,vK.height=e.node.height,gK=e.lineHeight,yK=e.horizontalAlign,bK=e.verticalAlign,EK=e.color,kK=e.isBold,OK=e.isItalic,IK=e.isUnderline,xK=SK!==sK.NONE&&(SK===sK.RESIZE_HEIGHT||e.enableWrapText);var i=lK&&e.getComponent(YG);i&&i.enabled?(AK=!0,RK=CK=i.width,(wK=i.color.clone()).a=wK.a*e.color.a/255):(AK=!1,RK=0)}},_calculateFillTextStartPosition:function(){var e,t,i=this._getLineHeight(),n=mK.length;return e=yK===sN.RIGHT?vK.width-RK:yK===sN.CENTER?vK.width/2:0+RK,t=bK===oN.TOP?0:bK===oN.CENTER?vK.height/2-i*(n-1)/2:vK.height-i*(n-1),new Mi(e,t)},_updateTexture:function(){if(uK&&cK){uK.clearRect(0,0,cK.width,cK.height),uK.font=fK;var e,t=this._calculateFillTextStartPosition(),i=this._getLineHeight();uK.lineJoin="round",uK.fillStyle="rgba(".concat(EK.r,", ").concat(EK.g,", ").concat(EK.b,", ").concat(EK.a/255,")");for(var n=0;n<mK.length;++n){if(AK){var r=wK||oK;uK.strokeStyle="rgba(".concat(r.r,", ").concat(r.g,", ").concat(r.b,", ").concat(r.a/255,")"),uK.lineWidth=2*CK,uK.strokeText(mK[n],t.x,t.y+n*i)}uK.fillText(mK[n],t.x,t.y+n*i),IK&&(e=this._calculateUnderlineStartPosition(),uK.save(),uK.beginPath(),uK.lineWidth=dK/8,uK.strokeStyle="rgba(".concat(EK.r,", ").concat(EK.g,", ").concat(EK.b,", ").concat(EK.a/255,")"),uK.moveTo(e.x,e.y+n*i-1),uK.lineTo(e.x+cK.width,e.y+n*i-1),uK.stroke(),uK.restore())}if(hK){var a;a=hK instanceof Yc?hK.texture:hK;var s=0===cK.width||0===cK.height;a.reset({width:cK.width,height:cK.height,mipmapLevel:s?0:1}),s||a.uploadData(cK)}}},_calculateUnderlineStartPosition:function(){var e,t,i=this._getLineHeight(),n=mK.length;return e=0+RK,t=bK===oN.TOP?dK:bK===oN.CENTER?vK.height/2-i*(n-1)/2+dK/2:vK.height-i*(n-1),new Mi(e,t)},_updateLabelDimensions:function(){if(uK){var e=_K.split("\n");if(SK===sK.RESIZE_HEIGHT)vK.height=mK.length*this._getLineHeight();else if(SK===sK.NONE){mK=e;var t=0,i=0,n=e,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=ss(uK,s);t=t>o?t:o}i=mK.length*this._getLineHeight(),vK.width=parseFloat(t.toFixed(2))+2*RK,vK.height=parseFloat(i.toFixed(2)),OK&&(vK.width+=pK*Math.tan(.20943951))}cK&&(cK.width=vK.width,cK.height=vK.height)}},_calculateTextBaseline:function(){var e,t;e=yK===sN.RIGHT?"right":yK===sN.CENTER?"center":"left",t=bK===oN.TOP?"top":bK===oN.CENTER?"middle":"bottom",uK&&(uK.textAlign=e,uK.textBaseline=t)},_calculateSplitedStrings:function(){if(uK){var e=_K.split("\n");if(xK){mK=[];var t=vK.width-2*RK,i=e,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=os(a,ss(uK,a),t,this._measureText(uK));mK=mK.concat(s)}}else mK=e}},_getFontDesc:function(){var e=dK.toString()+"px ";return e+=TK,kK&&(e="bold "+e),OK&&(e="italic "+e),e},_getLineHeight:function(){var e=gK;return 0|(e=0===e?dK:e*dK/pK)},_calculateParagraphLength:function(e,t){var i=[],n=e,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=ss(t,s);i.push(o)}return i},_measureText:function(e){return function(t){return ss(e,t)}},_calculateLabelFont:function(){if(uK&&(fK=this._getFontDesc(),uK.font=fK,SK===sK.SHRINK)){var e=_K.split("\n"),t=this._calculateParagraphLength(e,uK);mK=e;var i=0,n=0,r=0;if(xK){var a=vK.width-2*RK,s=vK.height-2*RK;if(a<0||s<0)return fK=this._getFontDesc(),void(uK.font=fK);n=s+1,r=a+1;for(var o=dK+1,l=[],u=!0,c=0|o;n>s||r>a;){if(u?o=c/2|0:c=o=c-1,o<=0){D(4003);break}for(dK=o,fK=this._getFontDesc(),uK.font=fK,mK=[],n=0,i=0;i<e.length;++i){var h=0,f=ss(uK,e[i]);for(l=os(e[i],f,a,this._measureText(uK));h<l.length;){r=ss(uK,l[h]),n+=this._getLineHeight(),++h}mK=mK.concat(l)}u&&(n>s?c=0|o:(u=!1,n=s+1))}}else{for(n=e.length*this._getLineHeight(),i=0;i<e.length;++i)r<t[i]&&(r=t[i]);var _=(vK.width-2*RK)/r,d=vK.height/n;dK=pK*Math.min(1,_,d)|0,fK=this._getFontDesc(),uK.font=fK}}}},LK=rr.WHITE.clone(),PK=e("ttf",{createData:function(e){var t=e.requestRenderData();t.dataLength=4,t.vertexCount=4,t.indiceCount=6;var i=t.vData=new Float32Array(36);i[3]=i[21]=i[22]=i[31]=0,i[4]=i[12]=i[13]=i[30]=1;for(var n=5,r=0;r<4;r++)rr.toArray(i,LK,n),n+=9;return t},fillBuffers:function(e,t){var i=e.renderData,n=i.datas,r=e.node,a=t.currBufferBatch,s=a.byteOffset>>2,o=a.indiceOffset,l=a.vertexOffset;a.request()||(a=t.currBufferBatch,o=0,l=0);var u=a.vData,c=a.iData,h=i.vData,f=n[0],_=n[3];r.updateWorldTransform();var d=r._pos,p=r._rot,m=r._scale,v=f.x*m.x,g=_.x*m.x,y=f.y*m.y,b=_.y*m.y,E=p.x,T=p.y,S=p.z,x=p.w,A=E*T,w=S*x,C=E*E-T*T,R=x*x-S*S,k=R+C,O=2*(A-w),I=R-C,M=2*(A+w),L=d.x,P=d.y;h[0]=k*v+O*y+L,h[1]=I*y+M*v+P,h[9]=k*g+O*y+L,h[10]=I*y+M*g+P,h[18]=k*v+O*b+L,h[19]=I*b+M*v+P,h[27]=k*g+O*b+L,h[28]=I*b+M*g+P,u.set(h,s),c[o++]=l,c[o++]=l+1,c[o++]=l+2,c[o++]=l+2,c[o++]=l+1,c[o++]=l+3},updateVerts:function(e){var t=e.renderData;if(t){var i=e.node,n=i.width,r=i.height,a=i.anchorX*n,s=i.anchorY*r,o=t.datas;o[0].x=-a,o[0].y=-s,o[3].x=n-a,o[3].y=r-s}}});De(PK,MK);var BK=e("labelAssembler",{getAssembler:function(e){var t=PK;return e.font instanceof Og?t=vY:e.cacheMode===hN.CacheMode.CHAR&&(Il.browserType===Il.BROWSER_TYPE_WECHAT_GAME_SUB?k("sorry, subdomain does not support CHAR mode currently!"):t=aK),t}});hN.Assembler=BK;var DK=QC.sharedManager,FK=e("mask",{createData:function(e){var t=e.requestRenderData();return t.dataLength=4,t.vertexCount=4,t.indiceCount=6,t},updateRenderData:function(e){var t=e.renderData;t&&t.vertDirty&&this.updateVerts&&this.updateVerts(e)},updateVerts:function(e){var t=e.renderData;if(t){var i,n,r,a,s=e.node,o=t.datas,l=s.width,u=s.height,c=s.anchorX*l,h=s.anchorY*u;i=-c,n=-h,r=l-c,a=u-h,o[0].x=i,o[0].y=n,o[3].x=r,o[3].y=a,t.vertDirty=!1}},fillBuffers:function(e,t){DK.pushMask(e),DK.clear(),e.clearGraphics.updateAssembler(t),DK.enterLevel(),e.graphics.updateAssembler(t),DK.enableMask()}}),NK=e("maskEnd",{fillBuffers:function(e,t){DK.exitMask()}}),zK={getAssembler:function(){return FK}},UK={getAssembler:function(){return NK}};dG.Assembler=zK,dG.PostAssembler=UK;var GK=zC.FillType,VK=new Bn,HK=e("barFilled",{useModel:!1,updateRenderData:function(e){var t=e.spriteFrame,i=e.renderData;if(i&&t){var n=i.uvDirty,r=i.vertDirty;if(!n&&!r)return;var a=e.fillStart,s=e.fillRange;s<0&&(a+=s,s=-s),s=(s=(s=a+s)>1?1:s)<0?0:s;var o=(a=(a=a>1?1:a)<0?0:a)+(s=(s-=a)<0?0:s);o=o>1?1:o,n&&this.updateUVs(e,a,o),r&&(this.updateVerts&&this.updateVerts(e,a,o),this.updateWorldVerts(e))}},updateUVs:function(e,t,i){var n=e.spriteFrame,r=e.renderData,a=r.datas,s=n.width,o=n.height,l=n.getRect(),u=0,c=0,h=0,f=0,_=0,d=0,p=0,m=0,v=0,g=0;switch(n.isRotated()?(u=l.x/s,c=(l.y+l.width)/o,h=_=u,p=v=(l.x+l.height)/s,d=g=c,f=m=l.y/o):(u=l.x/s,c=(l.y+l.height)/o,h=p=u,_=v=(l.x+l.width)/s,f=d=c,m=g=l.y/o),e.fillType){case GK.HORIZONTAL:a[0].u=h+(_-h)*t,a[0].v=f+(d-f)*t,a[1].u=h+(_-h)*i,a[1].v=f+(d-f)*i,a[2].u=p+(v-p)*t,a[2].v=m+(g-m)*t,a[3].u=p+(v-p)*i,a[3].v=m+(g-m)*i;break;case GK.VERTICAL:a[0].u=h+(p-h)*t,a[0].v=f+(m-f)*t,a[1].u=_+(v-_)*t,a[1].v=d+(g-d)*t,a[2].u=h+(p-h)*i,a[2].v=f+(m-f)*i,a[3].u=_+(v-_)*i,a[3].v=d+(g-d)*i;break;default:U(2626)}r.uvDirty=!1},updateVerts:function(e,t,i){var n=e.renderData,r=n.datas,a=e.node,s=a.width,o=a.height,l=a.anchorX*s,u=a.anchorY*o,c=-l,h=-u,f=s-l,_=o-u,d=0;switch(e.fillType){case GK.HORIZONTAL:d=c+(f-c)*i,c=c+(f-c)*t,f=d;break;case GK.VERTICAL:d=h+(_-h)*i,h=h+(_-h)*t,_=d;break;default:U(2626)}r[4].x=c,r[4].y=h,r[5].x=f,r[5].y=h,r[6].x=c,r[6].y=_,r[7].x=f,r[7].y=_,n.vertDirty=!1},createData:function(e){var t=e.requestRenderData();t.dataLength=8,t.vertexCount=4,t.indiceCount=6;var i=t.datas,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}a.z=0}return t},updateWorldVerts:function(e){var t=e.node,i=e.renderData.datas;t.getWorldMatrix(VK);for(var n=0;n<4;n++){var r=i[n+4],a=i[n];zi.transformMat4(a,r,VK)}},fillBuffers:function(e,t){e.node.hasChangedFlags&&this.updateWorldVerts(e);e.node;!function(e,t,i,n){var r=i.datas,a=t.currBufferBatch,s=a.byteOffset>>2,o=i.vertexCount,l=a.indiceOffset,u=a.vertexOffset;a.request(o,i.indiceCount)||(a=t.currBufferBatch,o=0,l=0,u=0);for(var c=a.vData,h=0;h<o;h++){var f=r[h];c[s++]=f.x,c[s++]=f.y,c[s++]=f.z,c[s++]=f.u,c[s++]=f.v,rr.toArray(c,n,s),s+=4}var _=a.iData;_[l++]=u,_[l++]=u+1,_[l++]=u+2,_[l++]=u+1,_[l++]=u+3,_[l++]=u+2}(0,t,e.renderData,e.color)}}),WK=2*Math.PI,jK=[new Mi,new Mi,new Mi,new Mi],XK=new Array(4),qK=new Array(8),YK=[new Mi,new Mi,new Mi,new Mi],KK=[new Mi,new Mi,new Mi,new Mi],ZK=new Mi,QK=[new Mi,new Mi,new Mi,new Mi];function JK(e,t,i,n,r,a,s){var o=Math.sin(a);o=Math.abs(o)>1e-6?o:0;var l=Math.cos(a),u=0,c=0;if(0!==(l=Math.abs(l)>1e-6?l:0)){if(u=o/l,(e-r.x)*l>0){var h=r.y+u*(e-r.x);s[0].x=e,s[0].y=h}if((t-r.x)*l>0){var f=r.y+u*(t-r.x);s[2].x=t,s[2].y=f}}if(0!==o){if(c=l/o,(n-r.y)*o>0){var _=r.x+c*(n-r.y);s[3].x=_,s[3].y=n}if((i-r.y)*o>0){var d=r.x+c*(i-r.y);s[1].x=d,s[1].y=i}}}function $K(e,t){var i=t.x-e.x,n=t.y-e.y;if(0===i&&0===n)return 0;if(0===i)return n>0?.5*Math.PI:1.5*Math.PI;var r=Math.atan(n/i);return i<0&&(r+=Math.PI),r}function eZ(e,t,i,n,r){var a=XK,s=a[0],o=a[1],l=a[2],u=a[3];e[t].x=i.x,e[t].y=i.y,e[t+1].x=n.x,e[t+1].y=n.y,e[t+2].x=r.x,e[t+2].y=r.y;tZ((i.x-s)/(l-s),(i.y-o)/(u-o),e,t),tZ((n.x-s)/(l-s),(n.y-o)/(u-o),e,t+1),tZ((r.x-s)/(l-s),(r.y-o)/(u-o),e,t+2)}function tZ(e,t,i,n){var r=qK,a=r[0]+(r[2]-r[0])*e,s=r[4]+(r[6]-r[4])*e,o=r[1]+(r[3]-r[1])*e,l=r[5]+(r[7]-r[5])*e,u=i[n];u.u=a+(s-a)*t,u.v=o+(l-o)*t}for(var iZ=e("radialFilled",{useModel:!1,createData:function(e){return e.requestRenderData()},updateRenderData:function(e){var t=e.spriteFrame,i=e.renderData;if(i&&t&&(i.vertDirty||i.uvDirty)){var n=i.datas,r=e.fillStart,a=e.fillRange;for(a<0&&(r+=a,a=-a);r>=1;)r-=1;for(;r<0;)r+=1;var s=(r*=WK)+(a*=WK);!function(e){var t=e.node,i=t.width,n=t.height,r=t.anchorX*i,a=t.anchorY*n,s=-r,o=-a,l=i-r,u=n-a,c=XK;c[0]=s,c[1]=o,c[2]=l,c[3]=u;var h=e.fillCenter,f=ZK.x=Math.min(Math.max(0,h.x),1)*(l-s)+s,_=ZK.y=Math.min(Math.max(0,h.y),1)*(u-o)+o;jK[0].x=jK[3].x=s,jK[1].x=jK[2].x=l,jK[0].y=jK[1].y=o,jK[2].y=jK[3].y=u;var d=QK,p=Array.isArray(d),m=0;for(d=p?d:d[Symbol.iterator]();;){var v;if(p){if(m>=d.length)break;v=d[m++]}else{if((m=d.next()).done)break;v=m.value}var g=v;Mi.set(g,0,0)}f!==c[0]&&Mi.set(QK[0],3,0),f!==c[2]&&Mi.set(QK[2],1,2),_!==c[1]&&Mi.set(QK[1],0,1),_!==c[3]&&Mi.set(QK[3],2,3)}(e),function(e){var t=e.width,i=e.height,n=e.getRect(),r=0,a=0,s=0,o=0,l=qK;e.isRotated()?(r=n.x/t,a=(n.x+n.height)/t,s=n.y/i,o=(n.y+n.width)/i,l[0]=l[2]=r,l[4]=l[6]=a,l[3]=l[7]=o,l[1]=l[5]=s):(r=n.x/t,a=(n.x+n.width)/t,s=n.y/i,o=(n.y+n.height)/i,l[0]=l[4]=r,l[2]=l[6]=a,l[1]=l[3]=o,l[5]=l[7]=s)}(t),JK(XK[0],XK[2],XK[1],XK[3],ZK,r,YK),JK(XK[0],XK[2],XK[1],XK[3],ZK,r+a,KK);for(var o=0,l=0;l<4;++l){var u=QK[l];if(u)if(a>=WK)i.dataLength=o+3,eZ(n,o,ZK,jK[u.x],jK[u.y]),o+=3;else{var c=$K(ZK,jK[u.x]),h=$K(ZK,jK[u.y]);h<c&&(h+=WK),c-=WK,h-=WK;for(var f=0;f<3;++f)c>=s||(c>=r?(i.dataLength=o+3,eZ(n,o,ZK,jK[u.x],h>=s?KK[l]:jK[u.y]),o+=3):h<=r||(h<=s?(i.dataLength=o+3,eZ(n,o,ZK,YK[l],jK[u.y]),o+=3):(i.dataLength=o+3,eZ(n,o,ZK,YK[l],KK[l]),o+=3))),c+=WK,h+=WK}}i.indiceCount=i.vertexCount=o,i.vertDirty=i.uvDirty=!1}},fillBuffers:function(e,t){!function(e,t,i,n){var r=i.datas,a=t.currBufferBatch,s=a.byteOffset>>2,o=i.vertexCount,l=a.indiceOffset,u=a.vertexOffset;a.request(o,i.indiceCount)||(a=t.currBufferBatch,o=0,l=0,u=0);var c=a.vData;e.getWorldMatrix(yF);for(var h=0;h<o;h++){var f=r[h];zi.set(gF,f.x,f.y,0),zi.transformMat4(gF,gF,yF),c[s++]=gF.x,c[s++]=gF.y,c[s++]=gF.z,c[s++]=f.u,c[s++]=f.v,rr.toArray(c,n,s),s+=4}for(var _=a.iData,d=0;d<i.dataLength;d++)_[l+d]=u+d}(e.node,t,e.renderData,e.color)}}),nZ=[],rZ=0;rZ<4;rZ++)nZ.push(new zi);for(var aZ=e("simple",{createData:function(e){var t=e.requestRenderData();return t.dataLength=4,t.vertexCount=4,t.indiceCount=6,t.vData=new Float32Array(36),t},updateRenderData:function(e){var t=e.spriteFrame,i=e.renderData;i&&t&&(i.vertDirty&&this.updateVerts(e),i.uvDirty&&this.updateUvs(e))},fillBuffers:function(e,t){if(null!==e){var i=e.renderData.datas,n=e.node,r=t.currBufferBatch,a=r.byteOffset>>2,s=r.indiceOffset,o=r.vertexOffset;r.request()||(r=t.currBufferBatch,a=0,s=0,o=0);var l=r.vData,u=r.iData,c=e.renderData.vData,h=i[0],f=i[3],_=n.worldMatrix,d=_.m00,p=_.m01,m=_.m04,v=_.m05,g=_.m12,y=_.m13,b=h.x,E=f.x,T=h.y,S=f.y,x=d*b,A=d*E,w=p*b,C=p*E,R=m*T,k=m*S,O=v*T,I=v*S;c[0]=x+R+g,c[1]=w+O+y,c[9]=A+R+g,c[10]=C+O+y,c[18]=x+k+g,c[19]=w+I+y,c[27]=A+k+g,c[28]=C+I+y,l.set(c,a),u[s++]=o,u[s++]=o+1,u[s++]=o+2,u[s++]=o+2,u[s++]=o+1,u[s++]=o+3}},updateVerts:function(e){var t=e.renderData;if(t){var i=e.node,n=t.datas,r=i.width,a=i.height,s=i.anchorX*r,o=i.anchorY*a,l=0,u=0,c=0,h=0;if(e.trim)l=-s,u=-o,c=r-s,h=a-o;else{var f=e.spriteFrame,_=f.getOriginalSize(),d=f.getRect(),p=_.width,m=_.height,v=d.width,g=d.height,y=f.getOffset(),b=r/p,E=a/m,T=y.x+(p-v)/2,S=y.x-(p-v)/2;l=T*b-s,u=(y.y+(m-g)/2)*E-o,c=r+S*b-s,h=a+(y.y-(m-g)/2)*E-o}n[0].x=l,n[0].y=u,n[0].z=0,n[3].x=c,n[3].y=h,n[3].z=0,t.vertDirty=!1}},updateUvs:function(e){var t=e.renderData,i=t.vData,n=e.spriteFrame.uv;i[3]=n[0],i[4]=n[1],i[12]=n[2],i[13]=n[3],i[21]=n[4],i[22]=n[5],i[30]=n[6],i[31]=n[7],t.uvDirty=!1},updateColor:function(e){for(var t=e.renderData.vData,i=5,n=e.color,r=n.r/255,a=n.g/255,s=n.b/255,o=n.a/255,l=0;l<4;l++)t[i]=r,t[i+1]=a,t[i+2]=s,t[i+3]=o,i+=9}}),sZ=new zi,oZ=new Bn,lZ=e("sliced",{useModel:!1,createData:function(e){var t=e.requestRenderData();return t.dataLength=20,t.vertexCount=16,t.indiceCount=54,t},updateRenderData:function(e){var t=e.spriteFrame,i=e.renderData;i&&t&&(i.vertDirty&&(this.updateVerts(e),this.updateWorldVerts(e)))},updateVerts:function(e){var t=e.renderData,i=t.datas,n=e.node,r=n.width,a=n.height,s=n.anchorX*r,o=n.anchorY*a,l=e.spriteFrame,u=l.insetLeft,c=l.insetRight,h=l.insetTop,f=l.insetBottom,_=r-u-c,d=a-h-f,p=r/(u+c),m=a/(h+f);p=isNaN(p)||p>1?1:p,m=isNaN(m)||m>1?1:m,_=_<0?0:_,d=d<0?0:d,i[0].x=-s,i[0].y=-o,i[1].x=u*p-s,i[1].y=f*m-o,i[2].x=i[1].x+_,i[2].y=i[1].y+d,i[3].x=r-s,i[3].y=a-o,t.vertDirty=!1},fillBuffers:function(e,t){e.node.hasChangedFlags&&this.updateWorldVerts(e);var i=t.currBufferBatch,n=e.renderData,r=n.datas,a=i.byteOffset>>2,s=n.vertexCount,o=i.indiceOffset,l=i.vertexOffset,u=e.spriteFrame.uvSliced;i.request(s,n.indiceCount)||(i=t.currBufferBatch,a=0,o=0,l=0);for(var c=i.vData,h=i.iData,f=4;f<20;++f){var _=r[f],d=u[f-4];c[a++]=_.x,c[a++]=_.y,c[a++]=_.z,c[a++]=d.u,c[a++]=d.v,rr.toArray(c,e.color,a),a+=4}for(var p=0;p<3;++p)for(var m=0;m<3;++m){var v=l+4*p+m;h[o++]=v,h[o++]=v+1,h[o++]=v+4,h[o++]=v+1,h[o++]=v+5,h[o++]=v+4}},updateWorldVerts:function(e){var t=e.node,i=e.renderData.datas;t.getWorldMatrix(oZ);for(var n=0;n<4;++n)for(var r=i[n],a=0;a<4;++a){var s=i[a],o=i[4+4*n+a];zi.set(sZ,s.x,r.y,0),zi.transformMat4(o,sZ,oZ)}}}),uZ=[],cZ=0;cZ<4;cZ++)uZ.push(new zi);var hZ,fZ,_Z,dZ,pZ,mZ,vZ,gZ,yZ,bZ,EZ,TZ,SZ,xZ={useModel:!1,createData:function(e){return e.requestRenderData()},updateRenderData:function(e){var t=e.renderData,i=e.spriteFrame;if(i&&t&&(t.uvDirty||t.vertDirty)){var n=e.node,r=Math.abs(n.width),a=Math.abs(n.height),s=n.anchorX*r,o=n.anchorY*a,l=i.getRect(),u=l.width,c=l.height,h=r/u,f=a/c,_=Math.ceil(f),d=Math.ceil(h),p=t.datas;t.dataLength=Math.max(8,_+1,d+1);for(var m=0;m<=d;++m)p[m].x=Math.min(u*m,r)-s;for(var v=0;v<=_;++v)p[v].y=Math.min(c*v,a)-o;t.vertexCount=_*d*4,t.indiceCount=_*d*6,t.uvDirty=!1,t.vertDirty=!1}},fillBuffers:function(e,t){var i=e.node,n=e.renderData,r=t.currBufferBatch,a=r.indiceOffset,s=r.byteOffset>>2,o=r.vertexOffset,l=n.vertexCount,u=n.indiceCount,c=r.vData,h=r.iData;r.request(l,u)||(r=t.currBufferBatch,s=0,a=0,o=0);var f=e.spriteFrame,_=f.isRotated(),d=f.uv,p=f.getRect(),m=Math.abs(i.width),v=Math.abs(i.height),g=m/p.width,y=v/p.height,b=Math.ceil(y),E=Math.ceil(g),T=i.worldMatrix;this.fillVertices(c,s,T,b,E,n.datas);for(var S=0,x=0,A=0,w=b;A<w;++A){x=Math.min(1,y-A);for(var C=0,R=E;C<R;++C){S=Math.min(1,g-C);var k=s+3,O=k+1;_?(c[k]=d[0],c[O]=d[1],c[k+9]=d[0],c[O+9]=d[1]+(d[7]-d[1])*S,c[k+18]=d[0]+(d[6]-d[0])*x,c[O+18]=d[1],c[k+27]=c[k+18],c[O+27]=c[O+9]):(c[k]=d[0],c[O]=d[1],c[k+9]=d[0]+(d[6]-d[0])*S,c[O+9]=d[1],c[k+18]=d[0],c[O+18]=d[1]+(d[7]-d[1])*x,c[k+27]=c[k+9],c[O+27]=c[O+18]),rr.toArray(c,e.color,O+1),rr.toArray(c,e.color,O+9+1),rr.toArray(c,e.color,O+18+1),rr.toArray(c,e.color,O+27+1),s+=36}}for(var I=0;I<u;I+=6)h[a++]=o,h[a++]=o+1,h[a++]=o+2,h[a++]=o+1,h[a++]=o+3,h[a++]=o+2,o+=4},fillVertices:function(e,t,i,n,r,a){for(var s=0,o=0,l=0,u=0,c=0,h=n;c<h;++c){l=a[c].y,u=a[c+1].y;for(var f=0,_=r;f<_;++f){s=a[f].x,o=a[f+1].x,zi.set(uZ[0],s,l,0),zi.set(uZ[1],o,l,0),zi.set(uZ[2],s,u,0),zi.set(uZ[3],o,u,0);for(var d=0;d<4;d++){var p=uZ[d];zi.transformMat4(p,p,i);var m=9*d;e[t+m]=p.x,e[t+m+1]=p.y,e[t+m+2]=p.z}t+=36}}}},AZ=zC.Type,wZ=zC.FillType,CZ=e("spriteAssembler",{getAssembler:function(e){var t=aZ,i=e;switch(i.type){case AZ.SLICED:t=lZ;break;case AZ.TILED:t=xZ;break;case AZ.FILLED:t=i.fillType===wZ.RADIAL?iZ:HK}return t}});zC.Assembler=CZ,cc.UI={MeshBuffer:ZC,UIVertexFormat:nR,barFilled:HK,radialFilled:iZ,simple:aZ,sliced:lZ,ttf:PK,bmfont:vY,letter:aK,mask:FK,maskEnd:NK,graphics:Dq,spriteAssembler:CZ,graphicsAssembler:Fq,labelAssembler:BK};var RZ,kZ,OZ,IZ,MZ,LZ,PZ,BZ,DZ,FZ,NZ,zZ,UZ,GZ,VZ,HZ,WZ,jZ,XZ,qZ,YZ,KZ,ZZ,QZ,JZ,$Z,eQ,tQ,iQ,nQ,rQ,aQ,sQ,oQ,lQ,uQ,cQ,hQ,fQ,_Q,dQ,pQ,mQ,vQ,gQ,yQ,bQ,EQ,TQ,SQ,xQ,AQ,wQ,CQ,RQ,kQ,OQ,IQ,MQ,LQ,PQ,BQ,DQ,FQ,NQ,zQ,UQ,GQ,VQ,HQ,WQ,jQ,XQ,qQ,YQ,KQ,ZQ,QQ,JQ,$Q,eJ,tJ,iJ,nJ,rJ,aJ,sJ,oJ,lJ,uJ,cJ,hJ=e("BillboardComponent",(hZ=Es("cc.BillboardComponent"),fZ=Cs("Components/Billboard"),_Z=Ts({type:Uc}),dZ=Ts({type:Uc,tooltip:"billboard"}),pZ=Ts({tooltip:"billboard"}),mZ=Ts({tooltip:"billboard"}),vZ=Ts({tooltip:"billboard"}),hZ(gZ=fZ(gZ=As((bZ=v((yZ=function(e){function t(){var e;return i(this,t),m(e=c(this,o(t).call(this)),"_texture",bZ,u(e)),m(e,"_height",EZ,u(e)),m(e,"_width",TZ,u(e)),m(e,"_rotation",SZ,u(e)),e._model=null,e._mesh=null,e._material=null,e._uniform=new qi(1,1,0,0),e}return s(t,e),r(t,[{key:"texture",get:function(){return this._texture},set:function(e){this._texture=e,this._material&&this._material.setProperty("mainTexture",e)}},{key:"height",get:function(){return this._height},set:function(e){this._height=e,this._material&&(this._uniform.y=e,this._material.setProperty("cc_size_rotation",this._uniform))}},{key:"width",get:function(){return this._width},set:function(e){this._width=e,this._material&&(this._uniform.x=e,this._material.setProperty("cc_size_rotation",this._uniform))}},{key:"rotation",get:function(){return Math.round(100*vi(this._rotation))/100},set:function(e){this._rotation=mi(e),this._material&&(this._uniform.z=this._rotation,this._material.setProperty("cc_size_rotation",this._uniform))}}]),r(t,[{key:"onLoad",value:function(){this.createModel()}},{key:"onEnable",value:function(){this.attachToScene(),this._model.enabled=!0,this.width=this._width,this.height=this._height,this.rotation=this.rotation,this.texture=this.texture}},{key:"onDisable",value:function(){this.detachFromScene()}},{key:"attachToScene",value:function(){this._model&&this.node&&this.node.scene&&(this._model.scene&&this.detachFromScene(),this._getRenderScene().addModel(this._model))}},{key:"detachFromScene",value:function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)}},{key:"createModel",value:function(){this._mesh=xA({primitiveMode:lo.TRIANGLE_LIST,positions:[0,0,0,0,0,0,0,0,0,0,0,0],uvs:[0,0,1,0,0,1,1,1],colors:[rr.WHITE.r,rr.WHITE.g,rr.WHITE.b,rr.WHITE.a,rr.WHITE.r,rr.WHITE.g,rr.WHITE.b,rr.WHITE.a,rr.WHITE.r,rr.WHITE.g,rr.WHITE.b,rr.WHITE.a,rr.WHITE.r,rr.WHITE.g,rr.WHITE.b,rr.WHITE.a],attributes:[{name:to.ATTR_POSITION,format:no.RGB32F},{name:to.ATTR_TEX_COORD,format:no.RG32F},{name:to.ATTR_COLOR,format:no.RGBA8UI,isNormalized:!0}],indices:[0,1,2,1,2,3]},void 0,{calculateBounds:!1}),this._model=cc.director.root.createModel(Zu,this.node),this._model.initialize(this.node),null==this._material&&(this._material=new np,this._material.copy(P_.get("default-billboard-material"))),this._model.initSubModel(0,this._mesh.getSubMesh(0),this._material)}}]),t}(Ph)).prototype,"_texture",[_Z],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),v(yZ.prototype,"texture",[dZ],Object.getOwnPropertyDescriptor(yZ.prototype,"texture"),yZ.prototype),EZ=v(yZ.prototype,"_height",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),v(yZ.prototype,"height",[pZ],Object.getOwnPropertyDescriptor(yZ.prototype,"height"),yZ.prototype),TZ=v(yZ.prototype,"_width",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),v(yZ.prototype,"width",[mZ],Object.getOwnPropertyDescriptor(yZ.prototype,"width"),yZ.prototype),SZ=v(yZ.prototype,"_rotation",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),v(yZ.prototype,"rotation",[vZ],Object.getOwnPropertyDescriptor(yZ.prototype,"rotation"),yZ.prototype),gZ=yZ))||gZ)||gZ)||gZ)),fJ=[{name:to.ATTR_POSITION,format:no.RGB32F},{name:to.ATTR_TEX_COORD,format:no.RGBA32F},{name:to.ATTR_TEX_COORD1,format:no.RGB32F},{name:to.ATTR_COLOR,format:no.RGBA8,isNormalized:!0}],_J=new zi,dJ=new zi,pJ=function(e){function t(){var e;return i(this,t),(e=c(this,o(t).call(this)))._vertSize=0,e._vBuffer=null,e._vertAttrsFloatCount=0,e._vdataF32=null,e._vdataUint32=null,e._subMeshData=null,e._vertCount=0,e._indexCount=0,e._capacity=100,e._iaInfo={drawInfos:[{vertexCount:0,firstVertex:0,indexCount:0,firstIndex:0,vertexOffset:0,instanceCount:0,firstInstance:0}]},e._iaInfoBuffer=e._device.createBuffer({usage:ro.INDIRECT,memUsage:ao.HOST|ao.DEVICE,size:V_,stride:1}),e}return s(t,e),r(t,[{key:"setCapacity",value:function(e){this._capacity=e,this.createBuffer()}},{key:"createBuffer",value:function(){this._vertSize=0;var e=fJ,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n;r.offset=this._vertSize,this._vertSize+=Go[r.format].size}this._vertAttrsFloatCount=this._vertSize/4,this._vBuffer=this._createSubMeshData(),this._vdataF32=new Float32Array(this._vBuffer),this._vdataUint32=new Uint32Array(this._vBuffer)}},{key:"_createSubMeshData",value:function(){this._subMeshData&&this.destroySubMeshData(),this._vertCount=2,this._indexCount=6;var e=this._device.createBuffer({usage:ro.VERTEX|ro.TRANSFER_DST,memUsage:ao.HOST|ao.DEVICE,size:this._vertSize*this._capacity*this._vertCount,stride:this._vertSize}),t=new ArrayBuffer(this._vertSize*this._capacity*this._vertCount);e.update(t);for(var i=new Uint16Array((this._capacity-1)*this._indexCount),n=0,r=0;r<this._capacity-1;++r){var a=2*r;i[n++]=a,i[n++]=a+1,i[n++]=a+2,i[n++]=a+3,i[n++]=a+2,i[n++]=a+1}var s=this._device.createBuffer({usage:ro.INDEX|ro.TRANSFER_DST,memUsage:ao.HOST|ao.DEVICE,size:(this._capacity-1)*this._indexCount*Uint16Array.BYTES_PER_ELEMENT,stride:Uint16Array.BYTES_PER_ELEMENT});return s.update(i),this._iaInfo.drawInfos[0].vertexCount=this._capacity*this._vertCount,this._iaInfo.drawInfos[0].indexCount=(this._capacity-1)*this._indexCount,this._iaInfoBuffer.update(this._iaInfo),this._subMeshData={vertexBuffers:[e],indexBuffer:s,indirectBuffer:this._iaInfoBuffer,attributes:fJ,primitiveMode:lo.TRIANGLE_LIST,flatBuffers:[]},this.setSubModelMesh(0,this._subMeshData),t}},{key:"addLineVertexData",value:function(e,t,i){if(e.length>1){var n=0;zi.subtract(_J,e[1],e[0]),this._vdataF32[n++]=e[0].x,this._vdataF32[n++]=e[0].y,this._vdataF32[n++]=e[0].z,this._vdataF32[n++]=0,this._vdataF32[n++]=t.evaluate(0,1),this._vdataF32[n++]=0,this._vdataF32[n++]=0,this._vdataF32[n++]=_J.x,this._vdataF32[n++]=_J.y,this._vdataF32[n++]=_J.z,this._vdataUint32[n++]=i.evaluate(0,1)._val,this._vdataF32[n++]=e[0].x,this._vdataF32[n++]=e[0].y,this._vdataF32[n++]=e[0].z,this._vdataF32[n++]=1,this._vdataF32[n++]=t.evaluate(0,1),this._vdataF32[n++]=0,this._vdataF32[n++]=1,this._vdataF32[n++]=_J.x,this._vdataF32[n++]=_J.y,this._vdataF32[n++]=_J.z,this._vdataUint32[n++]=i.evaluate(0,1)._val;for(var r=1;r<e.length-1;r++){zi.subtract(_J,e[r-1],e[r]),zi.subtract(dJ,e[r+1],e[r]),zi.subtract(dJ,dJ,_J);var a=r/e.length;this._vdataF32[n++]=e[r].x,this._vdataF32[n++]=e[r].y,this._vdataF32[n++]=e[r].z,this._vdataF32[n++]=0,this._vdataF32[n++]=t.evaluate(a,1),this._vdataF32[n++]=a,this._vdataF32[n++]=0,this._vdataF32[n++]=dJ.x,this._vdataF32[n++]=dJ.y,this._vdataF32[n++]=dJ.z,this._vdataUint32[n++]=i.evaluate(a,1)._val,this._vdataF32[n++]=e[r].x,this._vdataF32[n++]=e[r].y,this._vdataF32[n++]=e[r].z,this._vdataF32[n++]=1,this._vdataF32[n++]=t.evaluate(a,1),this._vdataF32[n++]=a,this._vdataF32[n++]=1,this._vdataF32[n++]=dJ.x,this._vdataF32[n++]=dJ.y,this._vdataF32[n++]=dJ.z,this._vdataUint32[n++]=i.evaluate(a,1)._val}zi.subtract(_J,e[e.length-1],e[e.length-2]),this._vdataF32[n++]=e[e.length-1].x,this._vdataF32[n++]=e[e.length-1].y,this._vdataF32[n++]=e[e.length-1].z,this._vdataF32[n++]=0,this._vdataF32[n++]=t.evaluate(1,1),this._vdataF32[n++]=1,this._vdataF32[n++]=0,this._vdataF32[n++]=_J.x,this._vdataF32[n++]=_J.y,this._vdataF32[n++]=_J.z,this._vdataUint32[n++]=i.evaluate(1,1)._val,this._vdataF32[n++]=e[e.length-1].x,this._vdataF32[n++]=e[e.length-1].y,this._vdataF32[n++]=e[e.length-1].z,this._vdataF32[n++]=1,this._vdataF32[n++]=t.evaluate(1,1),this._vdataF32[n++]=1,this._vdataF32[n++]=1,this._vdataF32[n++]=_J.x,this._vdataF32[n++]=_J.y,this._vdataF32[n++]=_J.z,this._vdataUint32[n++]=i.evaluate(1,1)._val}this.updateIA(Math.max(0,e.length-1))}},{key:"updateIA",value:function(e){this.getSubModel(0).inputAssembler.vertexBuffers[0].update(this._vdataF32),this.getSubModel(0).inputAssembler.indexCount=this._indexCount*e,this.getSubModel(0).inputAssembler.extractDrawInfo(this._iaInfo.drawInfos[0]),this._iaInfoBuffer.update(this._iaInfo)}},{key:"destroySubMeshData",value:function(){var e=this._subMeshData.vertexBuffers,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.destroy()}this._subMeshData.indexBuffer.destroy()}}]),t}(Zu),mJ=dt({Constant:0,Curve:1,TwoCurves:2,TwoConstants:3}),vJ=(RZ=Es("cc.CurveRange"),kZ=Ts({type:mJ}),OZ=Ts({type:Ya}),IZ=Ts({type:Ya}),MZ=Ts({type:Ya}),RZ((WZ=HZ=function(){function e(){i(this,e),m(this,"mode",BZ,this),m(this,"curve",DZ,this),m(this,"curveMin",FZ,this),m(this,"curveMax",NZ,this),m(this,"constant",zZ,this),m(this,"constantMin",UZ,this),m(this,"constantMax",GZ,this),m(this,"multiplier",VZ,this)}return r(e,[{key:"evaluate",value:function(e,t){switch(this.mode){case mJ.Constant:return this.constant;case mJ.Curve:return this.curve.evaluate(e)*this.multiplier;case mJ.TwoCurves:return pi(this.curveMin.evaluate(e),this.curveMax.evaluate(e),t)*this.multiplier;case mJ.TwoConstants:return pi(this.constantMin,this.constantMax,t)}}},{key:"getMax",value:function(){switch(this.mode){case mJ.Constant:return this.constant;case mJ.Curve:return this.multiplier;case mJ.TwoConstants:return this.constantMax;case mJ.TwoCurves:return this.multiplier}return 0}}]),e}(),HZ.Mode=mJ,BZ=v((PZ=WZ).prototype,"mode",[kZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return mJ.Constant}}),DZ=v(PZ.prototype,"curve",[OZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ya}}),FZ=v(PZ.prototype,"curveMin",[IZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ya}}),NZ=v(PZ.prototype,"curveMax",[MZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ya}}),zZ=v(PZ.prototype,"constant",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),UZ=v(PZ.prototype,"constantMin",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),GZ=v(PZ.prototype,"constantMax",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),VZ=v(PZ.prototype,"multiplier",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),LZ=PZ))||LZ),gJ=dt({Blend:0,Fixed:1}),yJ=(Es("cc.ColorKey")((qZ=v((XZ=function e(){i(this,e),m(this,"color",qZ,this),m(this,"time",YZ,this)}).prototype,"color",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return rr.WHITE.clone()}}),YZ=v(XZ.prototype,"time",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),jZ=XZ)),Es("cc.AlphaKey")((QZ=v((ZZ=function e(){i(this,e),m(this,"alpha",QZ,this),m(this,"time",JZ,this)}).prototype,"alpha",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),JZ=v(ZZ.prototype,"time",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),KZ=ZZ)),Es("cc.Gradient")((aQ=rQ=function(){function e(){i(this,e),m(this,"colorKeys",tQ,this),m(this,"alphaKeys",iQ,this),m(this,"mode",nQ,this),this._color=rr.WHITE.clone()}return r(e,[{key:"setKeys",value:function(e,t){this.colorKeys=e,this.alphaKeys=t}},{key:"sortKeys",value:function(){this.colorKeys.length>1&&this.colorKeys.sort((function(e,t){return e.time-t.time})),this.alphaKeys.length>1&&this.alphaKeys.sort((function(e,t){return e.time-t.time}))}},{key:"evaluate",value:function(e){return this.getRGB(e),this._color._set_a_unsafe(this.getAlpha(e)),this._color}},{key:"randomColor",value:function(){var e=this.colorKeys[Math.trunc(Math.random()*this.colorKeys.length)],t=this.alphaKeys[Math.trunc(Math.random()*this.alphaKeys.length)];return this._color.set(e.color),this._color._set_a_unsafe(t.alpha),this._color}},{key:"getRGB",value:function(e){if(!(this.colorKeys.length>1))return 1===this.colorKeys.length?(this._color.set(this.colorKeys[0].color),this._color):(this._color.set(rr.WHITE),this._color);e=Ai(e,1);for(var t=1;t<this.colorKeys.length;++t){var i=this.colorKeys[t-1].time,n=this.colorKeys[t].time;if(e>=i&&e<n){if(this.mode===gJ.Fixed)return this.colorKeys[t].color;var r=(e-i)/(n-i);return rr.lerp(this._color,this.colorKeys[t-1].color,this.colorKeys[t].color,r),this._color}}var a=this.colorKeys.length-1;e<this.colorKeys[0].time?rr.lerp(this._color,rr.BLACK,this.colorKeys[0].color,e/this.colorKeys[0].time):e>this.colorKeys[a].time&&rr.lerp(this._color,this.colorKeys[a].color,rr.BLACK,(e-this.colorKeys[a].time)/(1-this.colorKeys[a].time))}},{key:"getAlpha",value:function(e){if(!(this.alphaKeys.length>1))return 1===this.alphaKeys.length?this.alphaKeys[0].alpha:255;e=Ai(e,1);for(var t=1;t<this.alphaKeys.length;++t){var i=this.alphaKeys[t-1].time,n=this.alphaKeys[t].time;if(e>=i&&e<n){if(this.mode===gJ.Fixed)return this.alphaKeys[t].alpha;var r=(e-i)/(n-i);return pi(this.alphaKeys[t-1].alpha,this.alphaKeys[t].alpha,r)}}var a=this.alphaKeys.length-1;return e<this.alphaKeys[0].time?pi(255,this.alphaKeys[0].alpha,e/this.alphaKeys[0].time):e>this.alphaKeys[a].time?pi(this.alphaKeys[a].alpha,255,(e-this.alphaKeys[a].time)/(1-this.alphaKeys[a].time)):void 0}}]),e}(),rQ.Mode=gJ,tQ=v((eQ=aQ).prototype,"colorKeys",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Array}}),iQ=v(eQ.prototype,"alphaKeys",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Array}}),nQ=v(eQ.prototype,"mode",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return gJ.Blend}}),$Z=eQ))||$Z),bJ=dt({Color:0,Gradient:1,TwoColors:2,TwoGradients:3,RandomColor:4}),EJ=(sQ=Es("cc.GradientRange"),oQ=Ts({type:bJ}),lQ=Ts({type:yJ}),uQ=Ts({type:yJ}),cQ=Ts({type:yJ}),hQ=Ts({type:bJ}),sQ((TQ=EQ=function(){function e(){i(this,e),m(this,"color",dQ,this),m(this,"colorMin",pQ,this),m(this,"colorMax",mQ,this),m(this,"gradient",vQ,this),m(this,"gradientMin",gQ,this),m(this,"gradientMax",yQ,this),m(this,"_mode",bQ,this),this._color=rr.WHITE.clone()}return r(e,[{key:"evaluate",value:function(e,t){switch(this.mode){case bJ.Color:return this.color;case bJ.TwoColors:return rr.lerp(this._color,this.colorMin,this.colorMax,t),this._color;case bJ.RandomColor:return this.gradient.randomColor();case bJ.Gradient:return this.gradient.evaluate(e);case bJ.TwoGradients:return rr.lerp(this._color,this.gradientMin.evaluate(e),this.gradientMax.evaluate(e),t),this._color;default:return this.color}}},{key:"mode",get:function(){return this._mode},set:function(e){this._mode=e}}]),e}(),EQ.Mode=bJ,v((_Q=TQ).prototype,"mode",[oQ],Object.getOwnPropertyDescriptor(_Q.prototype,"mode"),_Q.prototype),dQ=v(_Q.prototype,"color",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return rr.WHITE.clone()}}),pQ=v(_Q.prototype,"colorMin",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return rr.WHITE.clone()}}),mQ=v(_Q.prototype,"colorMax",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return rr.WHITE.clone()}}),vQ=v(_Q.prototype,"gradient",[lQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new yJ}}),gQ=v(_Q.prototype,"gradientMin",[uQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new yJ}}),yQ=v(_Q.prototype,"gradientMax",[cQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new yJ}}),bQ=v(_Q.prototype,"_mode",[hQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return bJ.Color}}),fQ=_Q))||fQ),TJ={CC_USE_WORLD_SPACE:!1},SJ=e("LineComponent",(SQ=Es("cc.LineComponent"),xQ=Cs("Components/Line"),AQ=Ts({type:Uc}),wQ=Ts({type:Uc,displayOrder:0,tooltip:""}),CQ=Ts({displayOrder:1,tooltip:""}),RQ=Ts({type:[zi]}),kQ=Ts({type:[zi],displayOrder:2,tooltip:""}),OQ=Ts({type:vJ}),IQ=Ts({type:vJ,displayOrder:3,tooltip:""}),MQ=Ts({type:Mi,displayOrder:4,tooltip:""}),LQ=Ts({type:Mi,displayOrder:5,tooltip:""}),PQ=Ts({type:EJ}),BQ=Ts({type:EJ,displayOrder:6,tooltip:""}),SQ(DQ=xQ(DQ=As((NQ=v((FQ=function(e){function t(){var e;return i(this,t),m(e=c(this,o(t).call(this)),"_texture",NQ,u(e)),e._material=null,m(e,"_worldSpace",zQ,u(e)),m(e,"_positions",UQ,u(e)),m(e,"_width",GQ,u(e)),m(e,"_tile",VQ,u(e)),m(e,"_offset",HQ,u(e)),m(e,"_color",WQ,u(e)),e._model=null,e._tile_offset=new qi,e}return s(t,e),r(t,[{key:"texture",get:function(){return this._texture},set:function(e){this._texture=e,this._material&&this._material.setProperty("mainTexture",e)}},{key:"worldSpace",get:function(){return this._worldSpace},set:function(e){this._worldSpace=e,this._material&&(TJ.CC_USE_WORLD_SPACE=this.worldSpace,this._material.recompileShaders(TJ),this._model&&this._model.setSubModelMaterial(0,this._material))}},{key:"positions",get:function(){return this._positions},set:function(e){this._positions=e,this._model&&this._model.addLineVertexData(this._positions,this._width,this._color)}},{key:"width",get:function(){return this._width},set:function(e){this._width=e,this._model&&this._model.addLineVertexData(this._positions,this._width,this._color)}},{key:"tile",get:function(){return this._tile},set:function(e){this._tile.set(e),this._material&&(this._tile_offset.x=this._tile.x,this._tile_offset.y=this._tile.y,this._material.setProperty("mainTiling_Offset",this._tile_offset))}},{key:"offset",get:function(){return this._offset},set:function(e){this._offset.set(e),this._material&&(this._tile_offset.z=this._offset.x,this._tile_offset.w=this._offset.y,this._material.setProperty("mainTiling_Offset",this._tile_offset))}},{key:"color",get:function(){return this._color},set:function(e){this._color=e,this._model&&this._model.addLineVertexData(this._positions,this._width,this._color)}}]),r(t,[{key:"onLoad",value:function(){this._model=cc.director.root.createModel(pJ),this._model.initialize(this.node),this._model.setCapacity(100),null==this._material&&(this._material=new np,this._material.copy(P_.get("default-trail-material")),TJ.CC_USE_WORLD_SPACE=this.worldSpace,this._material.recompileShaders(TJ)),this._model.setSubModelMaterial(0,this._material)}},{key:"onEnable",value:function(){this._model&&(this.attachToScene(),this.texture=this.texture,this.tile=this._tile,this.offset=this._offset,this._model.addLineVertexData(this._positions,this._width,this._color))}},{key:"onDisable",value:function(){this._model&&this.detachFromScene()}},{key:"attachToScene",value:function(){this._model&&this.node&&this.node.scene&&(this._model.scene&&this.detachFromScene(),this._getRenderScene().addModel(this._model))}},{key:"detachFromScene",value:function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)}}]),t}(Ph)).prototype,"_texture",[AQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),v(FQ.prototype,"texture",[wQ],Object.getOwnPropertyDescriptor(FQ.prototype,"texture"),FQ.prototype),zQ=v(FQ.prototype,"_worldSpace",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),v(FQ.prototype,"worldSpace",[CQ],Object.getOwnPropertyDescriptor(FQ.prototype,"worldSpace"),FQ.prototype),UQ=v(FQ.prototype,"_positions",[RQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),v(FQ.prototype,"positions",[kQ],Object.getOwnPropertyDescriptor(FQ.prototype,"positions"),FQ.prototype),GQ=v(FQ.prototype,"_width",[OQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vJ}}),v(FQ.prototype,"width",[IQ],Object.getOwnPropertyDescriptor(FQ.prototype,"width"),FQ.prototype),VQ=v(FQ.prototype,"_tile",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Mi(1,1)}}),v(FQ.prototype,"tile",[MQ],Object.getOwnPropertyDescriptor(FQ.prototype,"tile"),FQ.prototype),HQ=v(FQ.prototype,"_offset",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Mi(0,0)}}),v(FQ.prototype,"offset",[LQ],Object.getOwnPropertyDescriptor(FQ.prototype,"offset"),FQ.prototype),WQ=v(FQ.prototype,"_color",[PQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new EJ}}),v(FQ.prototype,"color",[BQ],Object.getOwnPropertyDescriptor(FQ.prototype,"color"),FQ.prototype),DQ=FQ))||DQ)||DQ)||DQ)),xJ=(jQ=Es("cc.ColorOvertimeModule"),XQ=Ts({displayOrder:0}),qQ=Ts({type:EJ,displayOrder:1}),jQ((ZQ=v((KQ=function(){function e(){i(this,e),m(this,"enable",ZQ,this),m(this,"color",QQ,this)}return r(e,[{key:"animate",value:function(e){this.enable&&(e.color.set(e.startColor),e.color.multiply(this.color.evaluate(1-e.remainingLifetime/e.startLifetime,Ei(e.randomSeed+91041))))}}]),e}()).prototype,"enable",[XQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),QQ=v(KQ.prototype,"color",[qQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new EJ}}),YQ=KQ))||YQ),AJ=dt({World:0,Local:1,Custom:2}),wJ=dt({Billboard:0,StrecthedBillboard:1,HorizontalBillboard:2,VerticalBillboard:3,Mesh:4}),CJ=dt({Box:0,Circle:1,Cone:2,Sphere:3,Hemisphere:4}),RJ=dt({Base:0,Edge:1,Shell:2,Volume:3}),kJ=dt({Random:0,Loop:1,PingPong:2}),OJ=dt({Particles:0,Ribbon:1}),IJ=dt({Stretch:0,Repeat:1}),MJ=new zi(0,0,-1);function LJ(e,t,i,n){return t!==e?(e===AJ.World?Bn.getRotation(n,i):(Bn.invert(i,i),Bn.getRotation(n,i)),!0):(fn.set(n,0,0,0,1),!1)}function PJ(e,t){Mi.set(e,Math.cos(t),Math.sin(t))}function BJ(e){var t=yi(-1,1),i=yi(0,2*Math.PI),n=Math.sqrt(1-t*t),r=n*Math.cos(i),a=n*Math.sin(i);zi.set(e,r,a,t)}function DJ(e,t,i){BJ(e),zi.multiplyScalar(e,e,t+(i-t)*gi())}function FJ(e,t,i,n){PJ(e,n),e.z=0,zi.multiplyScalar(e,e,t+(i-t)*gi())}function NJ(e){for(var t=0;t<e.length;t++){var i=t+bi(0,e.length-t),n=e[i];e[i]=e[t],e[t]=n}}function zJ(){var e=yi(-1,1);return 0===e&&e++,le(e)}var UJ,GJ,VJ,HJ,WJ,jJ,XJ,qJ,YJ,KJ,ZJ,QJ,JJ,$J,e$,t$,i$,n$,r$,a$,s$,o$,l$,u$,c$,h$,f$,_$,d$,p$,m$,v$,g$=new zi,y$=(JQ=Es("cc.ForceOvertimeModule"),$Q=Ts({displayOrder:0}),eJ=Ts({type:vJ,range:[-1,1],displayOrder:2,tooltip:"X "}),tJ=Ts({type:vJ,range:[-1,1],displayOrder:3,tooltip:"Y "}),iJ=Ts({type:vJ,range:[-1,1],displayOrder:4,tooltip:"Z "}),nJ=Ts({type:AJ,displayOrder:1,tooltip:""}),JQ((sJ=v((aJ=function(){function e(){i(this,e),m(this,"enable",sJ,this),m(this,"x",oJ,this),m(this,"y",lJ,this),m(this,"z",uJ,this),m(this,"space",cJ,this),this.randomized=!1,this.rotation=new fn,this.needTransform=!1}return r(e,[{key:"update",value:function(e,t){this.needTransform=LJ(e,this.space,t,this.rotation)}},{key:"animate",value:function(e,t){var i=1-e.remainingLifetime/e.startLifetime,n=zi.set(g$,this.x.evaluate(i,Ei(e.randomSeed+212165)),this.y.evaluate(i,Ei(e.randomSeed+212165)),this.z.evaluate(i,Ei(e.randomSeed+212165)));this.needTransform&&zi.transformQuat(n,n,this.rotation),zi.scaleAndAdd(e.velocity,e.velocity,n,t)}}]),e}()).prototype,"enable",[$Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),oJ=v(aJ.prototype,"x",[eJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vJ}}),lJ=v(aJ.prototype,"y",[tJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vJ}}),uJ=v(aJ.prototype,"z",[iJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vJ}}),cJ=v(aJ.prototype,"space",[nJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return AJ.Local}}),rJ=aJ))||rJ),b$=new zi,E$=new zi,T$=(UJ=Es("cc.LimitVelocityOvertimeModule"),GJ=Ts({displayOrder:0}),VJ=Ts({type:vJ,range:[-1,1],displayOrder:4,tooltip:"X "}),HJ=Ts({type:vJ,range:[-1,1],displayOrder:5,tooltip:"Y "}),WJ=Ts({type:vJ,range:[-1,1],displayOrder:6,tooltip:"Z "}),jJ=Ts({type:vJ,range:[-1,1],displayOrder:3,tooltip:""}),XJ=Ts({displayOrder:7,tooltip:""}),qJ=Ts({displayOrder:2,tooltip:""}),YJ=Ts({type:AJ,displayOrder:1,tooltip:""}),UJ((QJ=v((ZJ=function(){function e(){i(this,e),m(this,"enable",QJ,this),m(this,"limitX",JJ,this),m(this,"limitY",$J,this),m(this,"limitZ",e$,this),m(this,"limit",t$,this),m(this,"dampen",i$,this),m(this,"separateAxes",n$,this),m(this,"space",r$,this),this.drag=null,this.multiplyDragByParticleSize=!1,this.multiplyDragByParticleVelocity=!1,this.rotation=new fn,this.needTransform=!1}return r(e,[{key:"update",value:function(e,t){this.needTransform=LJ(e,this.space,t,this.rotation)}},{key:"animate",value:function(e){var t=1-e.remainingLifetime/e.startLifetime,i=b$;this.separateAxes?(zi.set(E$,this.limitX.evaluate(t,Ei(e.randomSeed+23541)),this.limitY.evaluate(t,Ei(e.randomSeed+23541)),this.limitZ.evaluate(t,Ei(e.randomSeed+23541))),this.needTransform&&zi.transformQuat(E$,E$,this.rotation),zi.set(i,S$(e.ultimateVelocity.x,E$.x,this.dampen),S$(e.ultimateVelocity.y,E$.y,this.dampen),S$(e.ultimateVelocity.z,E$.z,this.dampen))):(zi.normalize(i,e.ultimateVelocity),zi.multiplyScalar(i,i,S$(e.ultimateVelocity.length(),this.limit.evaluate(t,Ei(e.randomSeed+23541)),this.dampen))),zi.copy(e.ultimateVelocity,i)}}]),e}()).prototype,"enable",[GJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),JJ=v(ZJ.prototype,"limitX",[VJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vJ}}),$J=v(ZJ.prototype,"limitY",[HJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vJ}}),e$=v(ZJ.prototype,"limitZ",[WJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vJ}}),t$=v(ZJ.prototype,"limit",[jJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vJ}}),i$=v(ZJ.prototype,"dampen",[XJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 3}}),n$=v(ZJ.prototype,"separateAxes",[qJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),r$=v(ZJ.prototype,"space",[YJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return AJ.Local}}),KJ=ZJ))||KJ);function S$(e,t,i){var n=Math.sign(e),r=Math.abs(e);return r>t&&(r=pi(r,t,i)),r*n}var x$,A$,w$,C$,R$,k$,O$,I$,M$,L$,P$,B$,D$,F$,N$,z$,U$,G$,V$,H$,W$,j$,X$,q$,Y$,K$,Z$,Q$,J$,$$,e0,t0,i0,n0,r0,a0,s0,o0,l0,u0,c0,h0,f0,_0,d0,p0,m0,v0,g0,y0,b0,E0,T0,S0,x0,A0,w0,C0,R0,k0,O0,I0,M0,L0,P0,B0,D0,F0,N0,z0,U0,G0,V0,H0,W0,j0,X0,q0,Y0,K0,Z0,Q0,J0,$0,e1,t1,i1,n1,r1,a1,s1,o1,l1,u1,c1,h1,f1,_1,d1,p1,m1,v1,g1,y1,b1,E1,T1,S1,x1,A1,w1,C1=(a$=Es("cc.RotationOvertimeModule"),s$=Ts({displayOrder:0}),o$=Ts({displayOrder:1,tooltip:""}),l$=Ts({type:vJ,range:[-1,1],radian:!0,displayOrder:2,tooltip:" X "}),u$=Ts({type:vJ,range:[-1,1],radian:!0,displayOrder:3,tooltip:" Y "}),c$=Ts({type:vJ,range:[-1,1],radian:!0,displayOrder:4,tooltip:" Z "}),a$((_$=v((f$=function(){function e(){i(this,e),m(this,"enable",_$,this),m(this,"_separateAxes",d$,this),m(this,"x",p$,this),m(this,"y",m$,this),m(this,"z",v$,this)}return r(e,[{key:"separateAxes",get:function(){return this._separateAxes},set:function(e){this._separateAxes=e}}]),r(e,[{key:"animate",value:function(e,t){var i=1-e.remainingLifetime/e.startLifetime;if(this._separateAxes){var n=Ei(e.randomSeed+125292);e.rotation.x+=this.x.evaluate(i,n)*t,e.rotation.y+=this.y.evaluate(i,n)*t,e.rotation.z+=this.z.evaluate(i,n)*t}else e.rotation.z+=this.z.evaluate(i,Ei(e.randomSeed+125292))*t}}]),e}()).prototype,"enable",[s$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),d$=v(f$.prototype,"_separateAxes",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),v(f$.prototype,"separateAxes",[o$],Object.getOwnPropertyDescriptor(f$.prototype,"separateAxes"),f$.prototype),p$=v(f$.prototype,"x",[l$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vJ}}),m$=v(f$.prototype,"y",[u$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vJ}}),v$=v(f$.prototype,"z",[c$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vJ}}),h$=f$))||h$),R1=(x$=Es("cc.SizeOvertimeModule"),A$=Ts({displayOrder:0}),w$=Ts({displayOrder:1,tooltip:""}),C$=Ts({type:vJ,displayOrder:2,tooltip:""}),R$=Ts({type:vJ,displayOrder:3,tooltip:" X "}),k$=Ts({type:vJ,displayOrder:4,tooltip:" Y "}),O$=Ts({type:vJ,displayOrder:5,tooltip:" Z "}),x$((L$=v((M$=function(){function e(){i(this,e),m(this,"enable",L$,this),m(this,"separateAxes",P$,this),m(this,"size",B$,this),m(this,"x",D$,this),m(this,"y",F$,this),m(this,"z",N$,this)}return r(e,[{key:"animate",value:function(e){if(this.separateAxes){var t=1-e.remainingLifetime/e.startLifetime,i=Ei(e.randomSeed+39825);e.size.x=e.startSize.x*this.x.evaluate(t,i),e.size.y=e.startSize.y*this.y.evaluate(t,i),e.size.z=e.startSize.z*this.z.evaluate(t,i)}else zi.multiplyScalar(e.size,e.startSize,this.size.evaluate(1-e.remainingLifetime/e.startLifetime,Ei(e.randomSeed+39825)))}}]),e}()).prototype,"enable",[A$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),P$=v(M$.prototype,"separateAxes",[w$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),B$=v(M$.prototype,"size",[C$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vJ}}),D$=v(M$.prototype,"x",[R$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vJ}}),F$=v(M$.prototype,"y",[k$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vJ}}),N$=v(M$.prototype,"z",[O$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vJ}}),I$=M$))||I$),k1=dt({Grid:0}),O1=dt({WholeSheet:0,SingleRow:1}),I1=(z$=Es("cc.TextureAnimationModule"),U$=Ts({formerlySerializedAs:"numTilesX"}),G$=Ts({formerlySerializedAs:"numTilesY"}),V$=Ts({displayOrder:0}),H$=Ts({type:k1}),W$=Ts({type:k1,displayOrder:1,tooltip:" Grid "}),j$=Ts({displayOrder:2,tooltip:"X "}),X$=Ts({displayOrder:3,tooltip:"Y "}),q$=Ts({type:O1,displayOrder:4,tooltip:""}),Y$=Ts({type:vJ,displayOrder:7,tooltip:""}),K$=Ts({type:vJ,displayOrder:8,tooltip:""}),Z$=Ts({displayOrder:9,tooltip:""}),Q$=Ts({displayOrder:5,tooltip:"\n SingleRow "}),J$=Ts({displayOrder:6,tooltip:"\n SingleRow  randomRow "}),z$((t0=v((e0=function(){function e(){i(this,e),m(this,"_enable",t0,this),m(this,"_numTilesX",i0,this),m(this,"_numTilesY",n0,this),m(this,"_mode",r0,this),m(this,"animation",a0,this),m(this,"frameOverTime",s0,this),m(this,"startFrame",o0,this),m(this,"cycleCount",l0,this),m(this,"_flipU",u0,this),m(this,"_flipV",c0,this),m(this,"_uvChannelMask",h0,this),m(this,"randomRow",f0,this),m(this,"rowIndex",_0,this),this.ps=null}return r(e,[{key:"onInit",value:function(e){this.ps=e}},{key:"init",value:function(e){e.startRow=Math.floor(Math.random()*this.numTilesY)}},{key:"animate",value:function(e){var t=1-e.remainingLifetime/e.startLifetime,i=this.startFrame.evaluate(t,Ei(e.randomSeed+90794))/(this.numTilesX*this.numTilesY);if(this.animation===O1.WholeSheet)e.frameIndex=Ai(this.cycleCount*(this.frameOverTime.evaluate(t,Ei(e.randomSeed+90794))+i),1);else if(this.animation===O1.SingleRow){var n=1/this.numTilesY;if(this.randomRow){var r=Ai(this.cycleCount*(this.frameOverTime.evaluate(t,Ei(e.randomSeed+90794))+i),1),a=e.startRow*n,s=a+n;e.frameIndex=pi(a,s,r)}else{var o=this.rowIndex*n,l=o+n;e.frameIndex=pi(o,l,Ai(this.cycleCount*(this.frameOverTime.evaluate(t,Ei(e.randomSeed+90794))+i),1))}}}},{key:"enable",get:function(){return this._enable},set:function(e){this._enable=e,this.ps&&this.ps.renderer._updateMaterialParams()}},{key:"mode",get:function(){return this._mode},set:function(e){e===k1.Grid||console.error("particle texture animation's sprites is not supported!")}},{key:"numTilesX",get:function(){return this._numTilesX},set:function(e){this._numTilesX!==e&&(this._numTilesX=e,this.ps&&this.ps.renderer._updateMaterialParams())}},{key:"numTilesY",get:function(){return this._numTilesY},set:function(e){this._numTilesY!==e&&(this._numTilesY=e,this.ps&&this.ps.renderer._updateMaterialParams())}},{key:"flipU",get:function(){return this._flipU},set:function(e){console.error("particle texture animation's flipU is not supported!")}},{key:"flipV",get:function(){return this._flipV},set:function(e){console.error("particle texture animation's flipV is not supported!")}},{key:"uvChannelMask",get:function(){return this._uvChannelMask},set:function(e){console.error("particle texture animation's uvChannelMask is not supported!")}}]),e}()).prototype,"_enable",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),i0=v(e0.prototype,"_numTilesX",[U$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),n0=v(e0.prototype,"_numTilesY",[G$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),v(e0.prototype,"enable",[V$],Object.getOwnPropertyDescriptor(e0.prototype,"enable"),e0.prototype),r0=v(e0.prototype,"_mode",[H$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return k1.Grid}}),v(e0.prototype,"mode",[W$],Object.getOwnPropertyDescriptor(e0.prototype,"mode"),e0.prototype),v(e0.prototype,"numTilesX",[j$],Object.getOwnPropertyDescriptor(e0.prototype,"numTilesX"),e0.prototype),v(e0.prototype,"numTilesY",[X$],Object.getOwnPropertyDescriptor(e0.prototype,"numTilesY"),e0.prototype),a0=v(e0.prototype,"animation",[q$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return O1.WholeSheet}}),s0=v(e0.prototype,"frameOverTime",[Y$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vJ}}),o0=v(e0.prototype,"startFrame",[K$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vJ}}),l0=v(e0.prototype,"cycleCount",[Z$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),u0=v(e0.prototype,"_flipU",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),c0=v(e0.prototype,"_flipV",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),h0=v(e0.prototype,"_uvChannelMask",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),f0=v(e0.prototype,"randomRow",[Q$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_0=v(e0.prototype,"rowIndex",[J$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),$$=e0))||$$),M1=new zi,L1=(d0=Es("cc.VelocityOvertimeModule"),p0=Ts({displayOrder:0}),m0=Ts({type:vJ,range:[-1,1],displayOrder:2,tooltip:"X "}),v0=Ts({type:vJ,range:[-1,1],displayOrder:3,tooltip:"Y "}),g0=Ts({type:vJ,range:[-1,1],displayOrder:4,tooltip:"Z "}),y0=Ts({type:vJ,range:[-1,1],displayOrder:5,tooltip:" CPU "}),b0=Ts({type:AJ,displayOrder:1,tooltip:""}),d0((S0=v((T0=function(){function e(){i(this,e),m(this,"enable",S0,this),m(this,"x",x0,this),m(this,"y",A0,this),m(this,"z",w0,this),m(this,"speedModifier",C0,this),m(this,"space",R0,this),this.rotation=new fn,this.speedModifier.constant=1,this.needTransform=!1}return r(e,[{key:"update",value:function(e,t){this.needTransform=LJ(e,this.space,t,this.rotation)}},{key:"animate",value:function(e){var t=1-e.remainingLifetime/e.startLifetime,i=zi.set(M1,this.x.evaluate(t,Ei(197866^e.randomSeed)),this.y.evaluate(t,Ei(156497^e.randomSeed)),this.z.evaluate(t,Ei(984136^e.randomSeed)));this.needTransform&&zi.transformQuat(i,i,this.rotation),zi.add(e.animatedVelocity,e.animatedVelocity,i),zi.add(e.ultimateVelocity,e.velocity,e.animatedVelocity),zi.multiplyScalar(e.ultimateVelocity,e.ultimateVelocity,this.speedModifier.evaluate(1-e.remainingLifetime/e.startLifetime,Ei(e.randomSeed+197866)))}}]),e}()).prototype,"enable",[p0],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),x0=v(T0.prototype,"x",[m0],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vJ}}),A0=v(T0.prototype,"y",[v0],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vJ}}),w0=v(T0.prototype,"z",[g0],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vJ}}),C0=v(T0.prototype,"speedModifier",[y0],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vJ}}),R0=v(T0.prototype,"space",[b0],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return AJ.Local}}),E0=T0))||E0),P1=(k0=Es("cc.Burst"),O0=Ts({type:vJ}),k0((L0=v((M0=function(){function e(){i(this,e),m(this,"_time",L0,this),m(this,"minCount",P0,this),m(this,"maxCount",B0,this),m(this,"_repeatCount",D0,this),m(this,"repeatInterval",F0,this),m(this,"count",N0,this),this._remainingCount=1,this._curTime=0}return r(e,[{key:"time",get:function(){return this._time},set:function(e){this._time=e,this._curTime=e}},{key:"repeatCount",get:function(){return this._repeatCount},set:function(e){this._repeatCount=e,this._remainingCount=e}}]),r(e,[{key:"update",value:function(e,t){if(0===this._remainingCount&&(this._remainingCount=this._repeatCount,this._curTime=this._time),this._remainingCount>0){var i=Ai(e._time-e.startDelay.evaluate(0,1),e.duration)-t;i=i>0?i:0;var n=Ai(e.time-e.startDelay.evaluate(0,1),e.duration);this._curTime>=i&&this._curTime<n&&(e.emit(this.count.evaluate(this._curTime/e.duration,1),t-(n-this._curTime)),this._curTime+=this.repeatInterval,--this._remainingCount)}}},{key:"getMaxCount",value:function(e){return this.count.getMax()*Math.min(Math.ceil(e.duration/this.repeatInterval),this.repeatCount)}}]),e}()).prototype,"_time",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),v(M0.prototype,"time",[Ts],Object.getOwnPropertyDescriptor(M0.prototype,"time"),M0.prototype),P0=v(M0.prototype,"minCount",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 30}}),B0=v(M0.prototype,"maxCount",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 30}}),D0=v(M0.prototype,"_repeatCount",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),v(M0.prototype,"repeatCount",[Ts],Object.getOwnPropertyDescriptor(M0.prototype,"repeatCount"),M0.prototype),F0=v(M0.prototype,"repeatInterval",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),N0=v(M0.prototype,"count",[O0],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vJ}}),I0=M0))||I0),B1=new zi(0,0,0),D1=new Array,F1=new zi(.5,.5,.5),N1=(z0=Es("cc.ShapeModule"),U0=Ts({displayOrder:13,tooltip:""}),G0=Ts({displayOrder:14,tooltip:""}),V0=Ts({displayOrder:15,tooltip:""}),H0=Ts({displayOrder:6,tooltip:""}),W0=Ts({displayOrder:5,tooltip:"\n"}),j0=Ts({displayOrder:0}),X0=Ts({type:CJ,displayOrder:1,formerlySerializedAs:"shapeType"}),q0=Ts({type:CJ,tooltip:""}),Y0=Ts({type:RJ,displayOrder:2,tooltip:""}),K0=Ts({displayOrder:16,tooltip:""}),Z0=Ts({displayOrder:17,tooltip:""}),Q0=Ts({displayOrder:18,tooltip:""}),J0=Ts({displayOrder:19,tooltip:" 0 "}),$0=Ts({displayOrder:3,tooltip:""}),e1=Ts({displayOrder:4,tooltip:" Box :\n - 0 \n - 1 \n - 0 ~ 1 "}),t1=Ts({type:kJ,displayOrder:7,tooltip:""}),i1=Ts({displayOrder:9,tooltip:""}),n1=Ts({type:vJ,displayOrder:10,tooltip:""}),r1=Ts({displayOrder:11,tooltip:"\n"}),a1=Ts({displayOrder:12,tooltip:" Box "}),z0((v((o1=function(){function e(){i(this,e),m(this,"enable",l1,this),m(this,"_shapeType",u1,this),m(this,"emitFrom",c1,this),m(this,"alignToDirection",h1,this),m(this,"randomDirectionAmount",f1,this),m(this,"sphericalDirectionAmount",_1,this),m(this,"randomPositionAmount",d1,this),m(this,"radius",p1,this),m(this,"radiusThickness",m1,this),m(this,"arcMode",v1,this),m(this,"arcSpread",g1,this),m(this,"arcSpeed",y1,this),m(this,"length",b1,this),m(this,"boxThickness",E1,this),m(this,"_position",T1,this),m(this,"_rotation",S1,this),m(this,"_scale",x1,this),m(this,"_arc",A1,this),m(this,"_angle",w1,this),this.mat=new Bn,this.quat=new fn,this.particleSystem=null,this.lastTime=0,this.totalAngle=0}return r(e,[{key:"position",get:function(){return this._position},set:function(e){this._position=e,this.constructMat()}},{key:"rotation",get:function(){return this._rotation},set:function(e){this._rotation=e,this.constructMat()}},{key:"scale",get:function(){return this._scale},set:function(e){this._scale=e,this.constructMat()}},{key:"arc",get:function(){return vi(this._arc)},set:function(e){this._arc=mi(e)}},{key:"angle",get:function(){return Math.round(100*vi(this._angle))/100},set:function(e){this._angle=mi(e)}},{key:"shapeType",get:function(){return this._shapeType},set:function(e){switch(this._shapeType=e,this._shapeType){case CJ.Box:this.emitFrom===RJ.Base&&(this.emitFrom=RJ.Volume);break;case CJ.Cone:this.emitFrom===RJ.Edge&&(this.emitFrom=RJ.Base);break;case CJ.Sphere:case CJ.Hemisphere:this.emitFrom!==RJ.Base&&this.emitFrom!==RJ.Edge||(this.emitFrom=RJ.Volume)}}}]),r(e,[{key:"onInit",value:function(e){this.particleSystem=e,this.constructMat(),this.lastTime=this.particleSystem._time}},{key:"emit",value:function(e){switch(this.shapeType){case CJ.Box:!function(e,t,i,n){switch(e){case RJ.Volume:r=i,a=F1,zi.set(r,yi(-a.x,a.x),yi(-a.y,a.y),yi(-a.z,a.z));break;case RJ.Shell:D1.splice(0,D1.length),D1.push(yi(-.5,.5)),D1.push(yi(-.5,.5)),D1.push(.5*zJ()),NJ(D1),z1(D1,t),zi.set(i,D1[0],D1[1],D1[2]);break;case RJ.Edge:D1.splice(0,D1.length),D1.push(yi(-.5,.5)),D1.push(.5*zJ()),D1.push(.5*zJ()),NJ(D1),z1(D1,t),zi.set(i,D1[0],D1[1],D1[2]);break;default:console.warn(e+" is not supported for box emitter.")}var r,a;zi.copy(n,MJ)}(this.emitFrom,this.boxThickness,e.position,e.velocity);break;case CJ.Circle:!function(e,t,i,n,r){FJ(n,e*(1-t),e,i),zi.normalize(r,n)}(this.radius,this.radiusThickness,this.generateArcAngle(),e.position,e.velocity);break;case CJ.Cone:!function(e,t,i,n,r,a,s,o){switch(e){case RJ.Base:FJ(s,t*(1-i),t,n),Mi.multiplyScalar(o,s,Math.sin(r)),o.z=-Math.cos(r)*t,zi.normalize(o,o),s.z=0;break;case RJ.Shell:PJ(s,n),Mi.multiplyScalar(o,s,Math.sin(r)),o.z=-Math.cos(r),zi.normalize(o,o),Mi.multiplyScalar(s,s,t),s.z=0;break;case RJ.Volume:FJ(s,t*(1-i),t,n),Mi.multiplyScalar(o,s,Math.sin(r)),o.z=-Math.cos(r)*t,zi.normalize(o,o),s.z=0,zi.add(s,s,zi.multiplyScalar(B1,o,a*gi()/-o.z));break;default:console.warn(e+" is not supported for cone emitter.")}}(this.emitFrom,this.radius,this.radiusThickness,this.generateArcAngle(),this._angle,this.length,e.position,e.velocity);break;case CJ.Sphere:!function(e,t,i,n,r){switch(e){case RJ.Volume:DJ(n,t*(1-i),t),zi.copy(r,n),zi.normalize(r,r);break;case RJ.Shell:BJ(n),zi.multiplyScalar(n,n,t),zi.copy(r,n);break;default:console.warn(e+" is not supported for sphere emitter.")}}(this.emitFrom,this.radius,this.radiusThickness,e.position,e.velocity);break;case CJ.Hemisphere:!function(e,t,i,n,r){switch(e){case RJ.Volume:DJ(n,t*(1-i),t),n.z>0&&(n.z*=-1),zi.copy(r,n),zi.normalize(r,r);break;case RJ.Shell:BJ(n),zi.multiplyScalar(n,n,t),n.z>0&&(n.z*=-1),zi.copy(r,n);break;default:console.warn(e+" is not supported for hemisphere emitter.")}}(this.emitFrom,this.radius,this.radiusThickness,e.position,e.velocity);break;default:console.warn(this.shapeType+" shapeType is not supported by ShapeModule.")}if(this.randomPositionAmount>0&&(e.position.x+=yi(-this.randomPositionAmount,this.randomPositionAmount),e.position.y+=yi(-this.randomPositionAmount,this.randomPositionAmount),e.position.z+=yi(-this.randomPositionAmount,this.randomPositionAmount)),zi.transformQuat(e.velocity,e.velocity,this.quat),zi.transformMat4(e.position,e.position,this.mat),this.sphericalDirectionAmount>0){var t=zi.normalize(B1,e.position);zi.lerp(e.velocity,e.velocity,t,this.sphericalDirectionAmount)}this.lastTime=this.particleSystem._time}},{key:"constructMat",value:function(){fn.fromEuler(this.quat,this._rotation.x,this._rotation.y,this._rotation.z),Bn.fromRTS(this.mat,this.quat,this._position,this._scale)}},{key:"generateArcAngle",value:function(){if(this.arcMode===kJ.Random)return yi(0,this._arc);var e=this.totalAngle+2*Math.PI*this.arcSpeed.evaluate(this.particleSystem._time,1)*(this.particleSystem._time-this.lastTime);switch(this.totalAngle=e,0!==this.arcSpread&&(e=Math.floor(e/(this._arc*this.arcSpread))*this._arc*this.arcSpread),this.arcMode){case kJ.Loop:return Ai(e,this._arc);case kJ.PingPong:return wi(e,this._arc)}}}]),e}()).prototype,"position",[U0],Object.getOwnPropertyDescriptor(o1.prototype,"position"),o1.prototype),v(o1.prototype,"rotation",[G0],Object.getOwnPropertyDescriptor(o1.prototype,"rotation"),o1.prototype),v(o1.prototype,"scale",[V0],Object.getOwnPropertyDescriptor(o1.prototype,"scale"),o1.prototype),v(o1.prototype,"arc",[H0],Object.getOwnPropertyDescriptor(o1.prototype,"arc"),o1.prototype),v(o1.prototype,"angle",[W0],Object.getOwnPropertyDescriptor(o1.prototype,"angle"),o1.prototype),l1=v(o1.prototype,"enable",[j0],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),u1=v(o1.prototype,"_shapeType",[X0],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return CJ.Cone}}),v(o1.prototype,"shapeType",[q0],Object.getOwnPropertyDescriptor(o1.prototype,"shapeType"),o1.prototype),c1=v(o1.prototype,"emitFrom",[Y0],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return RJ.Volume}}),h1=v(o1.prototype,"alignToDirection",[K0],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),f1=v(o1.prototype,"randomDirectionAmount",[Z0],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_1=v(o1.prototype,"sphericalDirectionAmount",[Q0],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),d1=v(o1.prototype,"randomPositionAmount",[J0],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),p1=v(o1.prototype,"radius",[$0],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),m1=v(o1.prototype,"radiusThickness",[e1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),v1=v(o1.prototype,"arcMode",[t1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return kJ.Random}}),g1=v(o1.prototype,"arcSpread",[i1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),y1=v(o1.prototype,"arcSpeed",[n1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vJ}}),b1=v(o1.prototype,"length",[r1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),E1=v(o1.prototype,"boxThickness",[a1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new zi(0,0,0)}}),T1=v(o1.prototype,"_position",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new zi(0,0,0)}}),S1=v(o1.prototype,"_rotation",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new zi(0,0,0)}}),x1=v(o1.prototype,"_scale",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new zi(1,1,1)}}),A1=v(o1.prototype,"_arc",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return mi(360)}}),w1=v(o1.prototype,"_angle",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return mi(25)}}),s1=o1))||s1);function z1(e,t){t.x>0&&(e[0]+=.5*yi(-t.x,t.x),e[0]=_i(e[0],-.5,.5)),t.y>0&&(e[1]+=.5*yi(-t.y,t.y),e[1]=_i(e[1],-.5,.5)),t.z>0&&(e[2]+=.5*yi(-t.z,t.z),e[2]=_i(e[2],-.5,.5))}var U1,G1,V1,H1,W1,j1,X1,q1,Y1,K1,Z1,Q1,J1,$1,e2,t2,i2,n2,r2,a2,s2,o2,l2,u2,c2,h2,f2,_2,d2,p2,m2,v2,g2,y2,b2,E2,T2,S2,x2,A2,w2,C2,R2,k2,O2,I2,M2,L2=function(e){function t(){var e;return i(this,t),(e=c(this,o(t).call(this)))._vertCount=0,e._indexCount=0,e._type="particle-batch",e._capacity=0,e._vertAttrs=null,e._vertSize=0,e._vBuffer=null,e._vertAttrsFloatCount=0,e._vdataF32=null,e._vdataUint32=null,e._iaInfo={drawInfos:[{vertexCount:0,firstVertex:0,indexCount:0,firstIndex:0,vertexOffset:0,instanceCount:0,firstInstance:0}]},e._iaInfoBuffer=e._device.createBuffer({usage:ro.INDIRECT,memUsage:ao.HOST|ao.DEVICE,size:V_,stride:1}),e._subMeshData=null,e._mesh=null,e}return s(t,e),r(t,[{key:"setCapacity",value:function(e){var t=this._capacity!==e;this._capacity=e,this._inited&&t&&this._recreateBuffer()}},{key:"setVertexAttributes",value:function(e,t){if(this._mesh!==e||this._vertAttrs!==t){this._mesh=e,this._vertAttrs=t,this._vertSize=0;var i=this._vertAttrs,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;s.offset=this._vertSize,this._vertSize+=Go[s.format].size}this._vertAttrsFloatCount=this._vertSize/4,this._vBuffer=this._createSubMeshData(),this._vdataF32=new Float32Array(this._vBuffer),this._vdataUint32=new Uint32Array(this._vBuffer),this._inited=!0}}},{key:"_createSubMeshData",value:function(){this._subMeshData&&this.destroySubMeshData(),this._vertCount=4,this._indexCount=6,this._mesh&&(this._vertCount=this._mesh.struct.vertexBundles[this._mesh.struct.primitives[0].vertexBundelIndices[0]].view.count,this._indexCount=this._mesh.struct.primitives[0].indexView.count);var e=this._device.createBuffer({usage:ro.VERTEX|ro.TRANSFER_DST,memUsage:ao.HOST|ao.DEVICE,size:this._vertSize*this._capacity*this._vertCount,stride:this._vertSize}),t=new ArrayBuffer(this._vertSize*this._capacity*this._vertCount);if(this._mesh){var i=this._vertAttrs.findIndex((function(e){return e.name===to.ATTR_TEX_COORD3})),n=this._vertAttrs[i++].offset;if(this._mesh.copyAttribute(0,to.ATTR_POSITION,t,this._vertSize,n),n=this._vertAttrs[i++].offset,this._mesh.copyAttribute(0,to.ATTR_NORMAL,t,this._vertSize,n),n=this._vertAttrs[this._vertAttrs.findIndex((function(e){return e.name===to.ATTR_TEX_COORD}))].offset,this._mesh.copyAttribute(0,to.ATTR_TEX_COORD,t,this._vertSize,n),n=this._vertAttrs[i++].offset,!this._mesh.copyAttribute(0,to.ATTR_COLOR,t,this._vertSize,n))for(var r=new Uint32Array(t),a=0;a<this._vertCount;++a)r[a*this._vertAttrsFloatCount+n/4]=rr.WHITE._val;for(var s=new Float32Array(t),o=1;o<this._capacity;o++)s.copyWithin(o*this._vertSize*this._vertCount/4,0,this._vertSize*this._vertCount/4)}e.update(t);var l=new Uint16Array(this._capacity*this._indexCount);if(this._mesh){this._mesh.copyIndices(0,l);for(var u=1;u<this._capacity;u++)for(var c=0;c<this._indexCount;c++)l[u*this._indexCount+c]=l[c]+u*this._vertCount}else for(var h=0,f=0;f<this._capacity;++f){var _=4*f;l[h++]=_,l[h++]=_+1,l[h++]=_+2,l[h++]=_+3,l[h++]=_+2,l[h++]=_+1}var d=this._device.createBuffer({usage:ro.INDEX|ro.TRANSFER_DST,memUsage:ao.HOST|ao.DEVICE,size:this._capacity*this._indexCount*Uint16Array.BYTES_PER_ELEMENT,stride:Uint16Array.BYTES_PER_ELEMENT});return d.update(l),this._iaInfo.drawInfos[0].vertexCount=this._capacity*this._vertCount,this._iaInfo.drawInfos[0].indexCount=this._capacity*this._indexCount,this._iaInfoBuffer.status===Ks.UNREADY&&this._iaInfoBuffer.initialize({usage:ro.INDIRECT,memUsage:ao.HOST|ao.DEVICE,size:V_,stride:1}),this._iaInfoBuffer.update(this._iaInfo),this._subMeshData={vertexBuffers:[e],indexBuffer:d,indirectBuffer:this._iaInfoBuffer,attributes:this._vertAttrs,primitiveMode:lo.TRIANGLE_LIST,flatBuffers:[]},this.setSubModelMesh(0,this._subMeshData),t}},{key:"setSubModelMaterial",value:function(e,i){this.initLocalBindings(i),f(o(t.prototype),"setSubModelMaterial",this).call(this,e,i)}},{key:"addParticleVertexData",value:function(e,t){if(this._mesh)for(var i=0;i<this._vertCount;i++){var n=(e*this._vertCount+i)*this._vertAttrsFloatCount;this._vdataF32[n++]=t[0].x,this._vdataF32[n++]=t[0].y,this._vdataF32[n++]=t[0].z,n+=2,this._vdataF32[n++]=t[1].z,this._vdataF32[n++]=t[2].x,this._vdataF32[n++]=t[2].y,this._vdataF32[n++]=t[2].z,this._vdataF32[n++]=t[3].x,this._vdataF32[n++]=t[3].y,this._vdataF32[n++]=t[3].z,this._vdataUint32[n++]=t[4]}else{var r=e*this._vertAttrsFloatCount;this._vdataF32[r++]=t[0].x,this._vdataF32[r++]=t[0].y,this._vdataF32[r++]=t[0].z,this._vdataF32[r++]=t[1].x,this._vdataF32[r++]=t[1].y,this._vdataF32[r++]=t[1].z,this._vdataF32[r++]=t[2].x,this._vdataF32[r++]=t[2].y,this._vdataF32[r++]=t[2].z,this._vdataF32[r++]=t[3].x,this._vdataF32[r++]=t[3].y,this._vdataF32[r++]=t[3].z,this._vdataUint32[r++]=t[4],t[5]&&(this._vdataF32[r++]=t[5].x,this._vdataF32[r++]=t[5].y,this._vdataF32[r++]=t[5].z)}}},{key:"updateIA",value:function(e){this.getSubModel(0).inputAssembler.vertexBuffers[0].update(this._vdataF32),this.getSubModel(0).inputAssembler.indexCount=this._indexCount*e,this.getSubModel(0).inputAssembler.extractDrawInfo(this._iaInfo.drawInfos[0]),this._iaInfoBuffer.update(this._iaInfo)}},{key:"clear",value:function(){this.getSubModel(0).inputAssembler.indexCount=0}},{key:"destroy",value:function(){f(o(t.prototype),"destroy",this).call(this),this._vBuffer=null,this._vdataF32=null,this._subMeshData&&this.destroySubMeshData(),this._iaInfoBuffer.destroy(),this._subMeshData=null}},{key:"_recreateBuffer",value:function(){this._vBuffer=this._createSubMeshData(),this.getSubModel(0).updateCommandBuffer(),this._vdataF32=new Float32Array(this._vBuffer),this._vdataUint32=new Uint32Array(this._vBuffer)}},{key:"destroySubMeshData",value:function(){var e=this._subMeshData.vertexBuffers,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.destroy()}this._subMeshData.indexBuffer.destroy()}}]),t}(Zu),P2=function e(t){i(this,e),this.particleSystem=t,this.position=new zi(0,0,0),this.velocity=new zi(0,0,0),this.animatedVelocity=new zi(0,0,0),this.ultimateVelocity=new zi(0,0,0),this.angularVelocity=new zi(0,0,0),this.axisOfRotation=new zi(0,0,0),this.rotation=new zi(0,0,0),this.startSize=new zi(0,0,0),this.size=new zi(0,0,0),this.startColor=rr.WHITE.clone(),this.color=rr.WHITE.clone(),this.randomSeed=0,this.remainingLifetime=0,this.startLifetime=0,this.emitAccumulator0=0,this.emitAccumulator1=0,this.frameIndex=0,this.startRow=0},B2=new zi,D2=(new Mi,new Bn),F2=[0,0,1,0,0,1,1,1],N2=[{name:to.ATTR_POSITION,format:no.RGB32F},{name:to.ATTR_TEX_COORD,format:no.RGB32F},{name:to.ATTR_TEX_COORD1,format:no.RGB32F},{name:to.ATTR_TEX_COORD2,format:no.RGB32F},{name:to.ATTR_COLOR,format:no.RGBA8,isNormalized:!0}],z2=[{name:to.ATTR_POSITION,format:no.RGB32F},{name:to.ATTR_TEX_COORD,format:no.RGB32F},{name:to.ATTR_TEX_COORD1,format:no.RGB32F},{name:to.ATTR_TEX_COORD2,format:no.RGB32F},{name:to.ATTR_COLOR,format:no.RGBA8,isNormalized:!0},{name:to.ATTR_COLOR1,format:no.RGB32F}],U2=[{name:to.ATTR_POSITION,format:no.RGB32F},{name:to.ATTR_TEX_COORD,format:no.RGB32F},{name:to.ATTR_TEX_COORD1,format:no.RGB32F},{name:to.ATTR_TEX_COORD2,format:no.RGB32F},{name:to.ATTR_COLOR,format:no.RGBA8,isNormalized:!0},{name:to.ATTR_TEX_COORD3,format:no.RGB32F},{name:to.ATTR_NORMAL,format:no.RGB32F},{name:to.ATTR_COLOR1,format:no.RGBA8,isNormalized:!0}],G2={parent:null,owner:null,subModelIdx:0},V2=(U1=Es("cc.ParticleSystemRenderer"),G1=Ts({type:wJ,displayOrder:0,tooltip:""}),V1=Ts({displayOrder:1,tooltip:" StrecthedBillboard ,"}),H1=Ts({displayOrder:2,tooltip:" StrecthedBillboard ,"}),W1=Ts({type:wJ,displayOrder:3}),j1=Ts({displayOrder:4}),X1=Ts({displayOrder:5}),q1=Ts({displayOrder:6}),Y1=Ts({type:su,displayOrder:7,tooltip:""}),K1=Ts({type:np,displayOrder:8,tooltip:""}),Z1=Ts({type:np,displayOrder:9,tooltip:""}),U1((v((J1=function(){function e(){i(this,e),m(this,"_renderMode",$1,this),m(this,"_velocityScale",e2,this),m(this,"_lengthScale",t2,this),m(this,"_mesh",i2,this),m(this,"_particleSystem",n2,this),this._vertAttrs=[],this._particles=null,this._defaultMat=null,this._defaultTrailMat=null,this._model=null,this.frameTile_velLenScale=new qi(1,1,0,0),this._node_scale=new qi,this.attrs=new Array(5),this._defines={CC_USE_WORLD_SPACE:!0,CC_USE_BILLBOARD:!0,CC_USE_STRETCHED_BILLBOARD:!1,CC_USE_HORIZONTAL_BILLBOARD:!1,CC_USE_VERTICAL_BILLBOARD:!1},this._trailDefines={CC_USE_WORLD_SPACE:!0}}return r(e,[{key:"renderMode",get:function(){return this._renderMode},set:function(e){this._renderMode!==e&&(this._renderMode=e,this._setVertexAttrib(),this._updateModel(),this._updateMaterialParams())}},{key:"velocityScale",get:function(){return this._velocityScale},set:function(e){this._velocityScale=e,this._updateMaterialParams()}},{key:"lengthScale",get:function(){return this._lengthScale},set:function(e){this._lengthScale=e,this._updateMaterialParams()}},{key:"mesh",get:function(){return this._mesh},set:function(e){this._mesh=e,this._model&&this._model.setVertexAttributes(this._renderMode===wJ.Mesh?this._mesh:null,this._vertAttrs)}},{key:"particleMaterial",get:function(){return this._particleSystem?this._particleSystem.getMaterial(0):null},set:function(e){this._particleSystem.setMaterial(e,0)}},{key:"trailMaterial",get:function(){return this._particleSystem?this._particleSystem.getMaterial(1):null},set:function(e){this._particleSystem.setMaterial(e,1)}}]),r(e,[{key:"onInit",value:function(e){var t=this;this._particleSystem=e,this._particles=new Qa((function(){return new P2(t)}),16),this._setVertexAttrib(),this._updateModel(),this._updateMaterialParams(),this._updateTrailMaterial()}},{key:"onEnable",value:function(){this._particleSystem&&(this._attachToScene(),this._model.initialize(this._particleSystem.node),this._model.enabled=this._particleSystem.enabledInHierarchy)}},{key:"onDisable",value:function(){this._detachFromScene()}},{key:"onDestroy",value:function(){this._model&&(cc.director.root.destroyModel(this._model),this._model=null)}},{key:"_attachToScene",value:function(){this._model&&(this._model.scene&&this._detachFromScene(),this._particleSystem._getRenderScene().addModel(this._model))}},{key:"_detachFromScene",value:function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)}},{key:"clear",value:function(){this._particles.reset(),this._updateRenderData()}},{key:"_getFreeParticle",value:function(){return this._particles.length>=this._particleSystem.capacity?null:this._particles.add()}},{key:"_setNewParticle",value:function(e){}},{key:"_updateParticles",value:function(e){switch(this._particleSystem.node.getWorldMatrix(D2),this._particleSystem.scaleSpace){case AJ.Local:this._particleSystem.node.getScale(this._node_scale);break;case AJ.World:this._particleSystem.node.getWorldScale(this._node_scale)}(this._particleSystem.getMaterialInstance(0)||this._defaultMat).setProperty("scale",this._node_scale),this._particleSystem.velocityOvertimeModule.enable&&this._particleSystem.velocityOvertimeModule.update(this._particleSystem._simulationSpace,D2),this._particleSystem.limitVelocityOvertimeModule.enable&&this._particleSystem.limitVelocityOvertimeModule.update(this._particleSystem._simulationSpace,D2),this._particleSystem.forceOvertimeModule.enable&&this._particleSystem.forceOvertimeModule.update(this._particleSystem._simulationSpace,D2),this._particleSystem.trailModule.enable&&this._particleSystem.trailModule.update();for(var t=0;t<this._particles.length;++t){var i=this._particles.data[t];i.remainingLifetime-=e,zi.set(i.animatedVelocity,0,0,0),i.remainingLifetime<0?(this._particleSystem.trailModule.enable&&this._particleSystem.trailModule.removeParticle(i),this._particles.removeAt(t),--t):(i.velocity.y-=9.8*this._particleSystem.gravityModifier.evaluate(1-i.remainingLifetime/i.startLifetime,i.randomSeed)*e,this._particleSystem.sizeOvertimeModule.enable&&this._particleSystem.sizeOvertimeModule.animate(i),this._particleSystem.colorOverLifetimeModule.enable&&this._particleSystem.colorOverLifetimeModule.animate(i),this._particleSystem.forceOvertimeModule.enable&&this._particleSystem.forceOvertimeModule.animate(i,e),this._particleSystem.velocityOvertimeModule.enable?this._particleSystem.velocityOvertimeModule.animate(i):zi.copy(i.ultimateVelocity,i.velocity),this._particleSystem.limitVelocityOvertimeModule.enable&&this._particleSystem.limitVelocityOvertimeModule.animate(i),this._particleSystem.rotationOvertimeModule.enable&&this._particleSystem.rotationOvertimeModule.animate(i,e),this._particleSystem.textureAnimationModule.enable&&this._particleSystem.textureAnimationModule.animate(i),zi.scaleAndAdd(i.position,i.position,i.ultimateVelocity,e),this._particleSystem.trailModule.enable&&this._particleSystem.trailModule.animate(i,e))}return this._particles.length}},{key:"_updateRenderData",value:function(){for(var e=0,t=this._renderMode===wJ.StrecthedBillboard,i=0;i<this._particles.length;++i){var n=this._particles.data[i],r=0;this._particleSystem.textureAnimationModule.enable&&(r=n.frameIndex),e=4*i;var a=0;if(this._renderMode!==wJ.Mesh)for(var s=0;s<4;++s)a=0,this.attrs[a++]=n.position,B2.x=F2[2*s],B2.y=F2[2*s+1],B2.z=r,this.attrs[a++]=B2,this.attrs[a++]=n.size,this.attrs[a++]=n.rotation,this.attrs[a++]=n.color._val,this.attrs[a++]=t?n.ultimateVelocity:null,this._model.addParticleVertexData(e++,this.attrs);else a=0,this.attrs[a++]=n.position,B2.z=r,this.attrs[a++]=B2,this.attrs[a++]=n.size,this.attrs[a++]=n.rotation,this.attrs[a++]=n.color._val,this._model.addParticleVertexData(i,this.attrs)}this._model.updateIA(this._particles.length)}},{key:"updateShaderUniform",value:function(){}},{key:"getParticleCount",value:function(){return this._particles.length}},{key:"_onMaterialModified",value:function(e,t){0===e?(this._updateModel(),this._updateMaterialParams()):this._updateTrailMaterial()}},{key:"_onRebuildPSO",value:function(e,t){this._model&&0===e&&this._model.setSubModelMaterial(0,t),this._particleSystem.trailModule._trailModel&&1===e&&this._particleSystem.trailModule._trailModel.setSubModelMaterial(0,t)}},{key:"_setVertexAttrib",value:function(){switch(this._renderMode){case wJ.StrecthedBillboard:this._vertAttrs=z2.slice();break;case wJ.Mesh:this._vertAttrs=U2.slice();break;default:this._vertAttrs=N2.slice()}}},{key:"_updateMaterialParams",value:function(){if(this._particleSystem){null!=this._particleSystem.sharedMaterial&&-1===this._particleSystem.sharedMaterial._effectAsset._name.indexOf("particle")&&this._particleSystem.setMaterial(null,0),null==this._particleSystem.sharedMaterial&&null==this._defaultMat&&(G2.parent=P_.get("default-particle-material"),G2.owner=this._particleSystem,G2.subModelIdx=0,this._defaultMat=new xp(G2));var e=this._particleSystem.getMaterialInstance(0)||this._defaultMat;this._particleSystem._simulationSpace===AJ.World?this._defines.CC_USE_WORLD_SPACE=!0:this._defines.CC_USE_WORLD_SPACE=!1,this._renderMode===wJ.Billboard?this._defines.CC_RENDER_MODE=0:this._renderMode===wJ.StrecthedBillboard?(this._defines.CC_RENDER_MODE=1,this.frameTile_velLenScale.z=this._velocityScale,this.frameTile_velLenScale.w=this._lengthScale):this._renderMode===wJ.HorizontalBillboard?this._defines.CC_RENDER_MODE=2:this._renderMode===wJ.VerticalBillboard?this._defines.CC_RENDER_MODE=3:this._renderMode===wJ.Mesh?this._defines.CC_RENDER_MODE=4:console.warn("particle system renderMode ".concat(this._renderMode," not support.")),this._particleSystem.textureAnimationModule.enable?(Mi.set(this.frameTile_velLenScale,this._particleSystem.textureAnimationModule.numTilesX,this._particleSystem.textureAnimationModule.numTilesY),e.setProperty("frameTile_velLenScale",this.frameTile_velLenScale)):e.setProperty("frameTile_velLenScale",this.frameTile_velLenScale),e.recompileShaders(this._defines),this._model&&this._model.setSubModelMaterial(0,e)}}},{key:"_updateTrailMaterial",value:function(){if(this._particleSystem.trailModule.enable){this._particleSystem._simulationSpace===AJ.World||this._particleSystem.trailModule.space===AJ.World?this._trailDefines.CC_USE_WORLD_SPACE=!0:this._trailDefines.CC_USE_WORLD_SPACE=!1;var e=this._particleSystem.getMaterialInstance(1);null===e&&null===this._defaultTrailMat&&(G2.parent=P_.get("default-trail-material"),G2.owner=this._particleSystem,G2.subModelIdx=1,this._defaultTrailMat=new xp(G2)),null===e&&(e=this._defaultTrailMat),e.recompileShaders(this._trailDefines),this._particleSystem.trailModule._updateMaterial()}}},{key:"_updateModel",value:function(){this._model||(this._model=cc.director.root.createModel(L2),this._model.setCapacity(this._particleSystem.capacity),this._model.visFlags=this._particleSystem.visibility),this._model.setVertexAttributes(this._renderMode===wJ.Mesh?this._mesh:null,this._vertAttrs)}}]),e}()).prototype,"renderMode",[G1],Object.getOwnPropertyDescriptor(J1.prototype,"renderMode"),J1.prototype),v(J1.prototype,"velocityScale",[V1],Object.getOwnPropertyDescriptor(J1.prototype,"velocityScale"),J1.prototype),v(J1.prototype,"lengthScale",[H1],Object.getOwnPropertyDescriptor(J1.prototype,"lengthScale"),J1.prototype),$1=v(J1.prototype,"_renderMode",[W1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return wJ.Billboard}}),e2=v(J1.prototype,"_velocityScale",[j1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),t2=v(J1.prototype,"_lengthScale",[X1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),i2=v(J1.prototype,"_mesh",[q1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),n2=v(J1.prototype,"_particleSystem",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),v(J1.prototype,"mesh",[Y1],Object.getOwnPropertyDescriptor(J1.prototype,"mesh"),J1.prototype),v(J1.prototype,"particleMaterial",[K1],Object.getOwnPropertyDescriptor(J1.prototype,"particleMaterial"),J1.prototype),v(J1.prototype,"trailMaterial",[Z1],Object.getOwnPropertyDescriptor(J1.prototype,"trailMaterial"),J1.prototype),Q1=J1))||Q1);Object.assign(V2,{uv:F2});var H2,W2,j2,X2,q2,Y2,K2,Z2,Q2,J2,$2,e3,t3,i3,n3,r3,a3,s3,o3,l3,u3,c3,h3,f3,_3,d3,p3,m3,v3,g3,y3,b3,E3,T3,S3,x3,A3,w3,C3,R3,k3,O3,I3,M3,L3,P3,B3,D3,F3,N3,z3,U3,G3,V3,H3,W3,j3,X3,q3,Y3,K3,Z3,Q3,J3,$3,e4,t4,i4,n4,r4,a4,s4,o4,l4,u4=Math.cos(mi(100)),c4={position:new zi,velocity:new zi},h4=new fn,f4=new Bn,_4=new zi,d4=new zi,p4=new rr,m4=function(){function e(t){for(i(this,e),this.start=-1,this.end=-1,this.trailElements=[];t--;)this.trailElements.push({position:new zi,lifetime:0,width:0,velocity:new zi,direction:0,color:new rr})}return r(e,[{key:"getElement",value:function(e){return-1===this.start?null:(e<0&&(e=(e+this.trailElements.length)%this.trailElements.length),e>=this.trailElements.length&&(e%=this.trailElements.length),this.trailElements[e])}},{key:"addElement",value:function(){if(0===this.trailElements.length)return null;if(-1===this.start)return this.start=0,this.end=1,this.trailElements[0];this.start===this.end&&(this.trailElements.splice(this.end,0,{position:new zi,lifetime:0,width:0,velocity:new zi,direction:0,color:new rr}),this.start++,this.start%=this.trailElements.length);var e=this.end++;return this.end%=this.trailElements.length,this.trailElements[e]}},{key:"iterateElement",value:function(e,t,i,n){for(var r=this.start>=this.end?this.end+this.trailElements.length:this.end,a=this.start;a<r;a++)t(e,this.trailElements[a%this.trailElements.length],i,n)&&(this.start++,this.start%=this.trailElements.length);this.start===r&&(this.start=-1,this.end=-1)}},{key:"count",value:function(){return this.start<this.end?this.end-this.start:this.trailElements.length+this.end-this.start}},{key:"clear",value:function(){this.start=-1,this.end=-1}}]),e}(),v4=(r2=Es("cc.TrailModule"),a2=Ts({displayOrder:0}),s2=Ts({type:OJ,displayOrder:1,tooltip:"Particle"}),o2=Ts({type:vJ,displayOrder:3,tooltip:""}),l2=Ts({displayOrder:5,tooltip:""}),u2=Ts({type:AJ,displayOrder:6,tooltip:"WorldLocal"}),c2=Ts({displayOrder:7,tooltip:""}),h2=Ts({type:IJ,displayOrder:8,tooltip:"StretchRepeat"}),f2=Ts({displayOrder:9,tooltip:""}),_2=Ts({type:vJ,displayOrder:10,tooltip:""}),d2=Ts({displayOrder:11,tooltip:""}),p2=Ts({type:EJ,displayOrder:12,tooltip:""}),m2=Ts({type:EJ,displayOrder:13,tooltip:""}),v2=Ts({type:AJ}),r2((v((y2=function(){function e(){i(this,e),m(this,"_enable",b2,this),m(this,"mode",E2,this),m(this,"lifeTime",T2,this),m(this,"_minParticleDistance",S2,this),m(this,"existWithParticles",x2,this),m(this,"textureMode",A2,this),m(this,"widthFromParticle",w2,this),m(this,"widthRatio",C2,this),m(this,"colorFromParticle",R2,this),m(this,"colorOverTrail",k2,this),m(this,"colorOvertime",O2,this),m(this,"_space",I2,this),m(this,"_particleSystem",M2,this),this._minSquaredDistance=0,this._trailNum=0,this._trailLifetime=0,this.vbOffset=0,this.ibOffset=0,this._trailSegments=null,this._trailModel=null,this._iaInfoBuffer=null,this._subMeshData=null,this._vbF32=null,this._vbUint32=null,this._iBuffer=null,this._needTransform=!1,this._defaultMat=null,this._iaInfo={drawInfos:[{vertexCount:0,firstVertex:0,indexCount:0,firstIndex:0,vertexOffset:0,instanceCount:0,firstInstance:0}]},this._vertAttrs=[{name:to.ATTR_POSITION,format:no.RGB32F},{name:to.ATTR_TEX_COORD,format:no.RGBA32F},{name:to.ATTR_TEX_COORD1,format:no.RGB32F},{name:to.ATTR_COLOR,format:no.RGBA8,isNormalized:!0}],this._vertSize=0;var t=this._vertAttrs,n=Array.isArray(t),r=0;for(t=n?t:t[Symbol.iterator]();;){var a;if(n){if(r>=t.length)break;a=t[r++]}else{if((r=t.next()).done)break;a=r.value}var s=a;this._vertSize+=Go[s.format].size}this._particleTrail=new Map}return r(e,[{key:"enable",get:function(){return this._enable},set:function(e){e&&!this._trailModel&&this._createModel(),e&&!this._enable&&(this._enable=e,this._particleSystem.renderer._updateTrailMaterial()),this._enable=e,this._trailModel&&(this._trailModel.enabled=e)}},{key:"minParticleDistance",get:function(){return this._minParticleDistance},set:function(e){this._minParticleDistance=e,this._minSquaredDistance=e*e}},{key:"space",get:function(){return this._space},set:function(e){this._space=e,this._particleSystem&&this._particleSystem.renderer._updateTrailMaterial()}}]),r(e,[{key:"onInit",value:function(e){this._particleSystem=e,this.minParticleDistance=this._minParticleDistance;var t=0,i=this._particleSystem.bursts,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}t+=a.getMaxCount(this._particleSystem)}this._trailNum=Math.ceil(this._particleSystem.startLifetime.getMax()*this.lifeTime.getMax()*60*(this._particleSystem.rateOverTime.getMax()*this._particleSystem.duration+t)),this._trailSegments=new Za((function(){return new m4(10)}),Math.ceil(this._particleSystem.rateOverTime.getMax()*this._particleSystem.duration)),this._enable&&(this.enable=this._enable,this._updateMaterial())}},{key:"onEnable",value:function(){this._attachToScene()}},{key:"onDisable",value:function(){this._detachFromScene()}},{key:"_attachToScene",value:function(){this._trailModel&&(this._trailModel.scene&&this._detachFromScene(),this._particleSystem._getRenderScene().addModel(this._trailModel))}},{key:"_detachFromScene",value:function(){this._trailModel&&this._trailModel.scene&&this._trailModel.scene.removeModel(this._trailModel)}},{key:"destroy",value:function(){this._trailModel&&(cc.director.root.destroyModel(this._trailModel),this._trailModel=null),this._trailSegments&&(this._trailSegments.clear((function(e){e.trailElements.length=0})),this._trailSegments=null)}},{key:"clear",value:function(){if(this.enable){for(var e=this._particleTrail.values(),t=e.next();!t.done;)t.value.clear(),t=e.next();this._particleTrail.clear(),this.updateRenderData()}}},{key:"_updateMaterial",value:function(){if(this._particleSystem&&this._trailModel){var e=this._particleSystem.getMaterialInstance(1);e?this._trailModel.setSubModelMaterial(0,e):this._trailModel.setSubModelMaterial(0,this._particleSystem.renderer._defaultTrailMat)}}},{key:"update",value:function(){this._trailLifetime=this.lifeTime.evaluate(this._particleSystem._time,1),this.space===AJ.World&&this._particleSystem._simulationSpace===AJ.Local?(this._needTransform=!0,this._particleSystem.node.getWorldMatrix(f4),this._particleSystem.node.getWorldRotation(h4)):this._needTransform=!1}},{key:"animate",value:function(e,t){if(this._trailSegments){var i=this._particleTrail.get(e);if(!i)return i=this._trailSegments.alloc(),void this._particleTrail.set(e,i);var n=i.getElement(i.end-1);if(this._needTransform?zi.transformMat4(_4,e.position,f4):zi.copy(_4,e.position),!(n&&(i.iterateElement(this,this._updateTrailElement,e,t),zi.squaredDistance(n.position,_4)<this._minSquaredDistance))&&(n=i.addElement())){zi.copy(n.position,_4),n.lifetime=0,this.widthFromParticle?n.width=e.size.x*this.widthRatio.evaluate(0,1):n.width=this.widthRatio.evaluate(0,1);var r=i.count();if(2===r){var a=i.getElement(i.end-2);zi.subtract(a.velocity,n.position,a.position)}else if(r>2){var s=i.getElement(i.end-2),o=i.getElement(i.end-3);zi.subtract(_4,o.position,s.position),zi.subtract(d4,n.position,s.position),zi.subtract(s.velocity,d4,_4),zi.equals(zi.ZERO,s.velocity)&&zi.copy(s.velocity,_4),zi.normalize(s.velocity,s.velocity),this._checkDirectionReverse(s,o)}this.colorFromParticle?n.color.set(e.color):n.color.set(this.colorOvertime.evaluate(0,1))}}}},{key:"removeParticle",value:function(e){var t=this._particleTrail.get(e);t&&this._trailSegments&&(t.clear(),this._trailSegments.free(t),this._particleTrail.delete(e))}},{key:"updateRenderData",value:function(){this.vbOffset=0,this.ibOffset=0;var e=this._particleTrail.keys(),t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n,a=this._particleTrail.get(r);if(-1!==a.start){var s=4*this.vbOffset/this._vertSize,o=a.start>=a.end?a.end+a.trailElements.length:a.end,l=o-a.start,u=1/l,c=a.trailElements[a.start];this._fillVertexBuffer(c,this.colorOverTrail.evaluate(1,1),s,1,0,4);for(var h=a.start+1;h<o;h++){var f=a.trailElements[h%a.trailElements.length],_=h-a.start;this._fillVertexBuffer(f,this.colorOverTrail.evaluate(1-_/l,1),s,1-_*u,_,5)}if(this._needTransform?zi.transformMat4(c4.position,r.position,f4):zi.copy(c4.position,r.position),1===l||2===l){var d=a.getElement(a.end-1);zi.subtract(d.velocity,c4.position,d.position),this._vbF32[this.vbOffset-this._vertSize/4-4]=d.velocity.x,this._vbF32[this.vbOffset-this._vertSize/4-3]=d.velocity.y,this._vbF32[this.vbOffset-this._vertSize/4-2]=d.velocity.z,this._vbF32[this.vbOffset-4]=d.velocity.x,this._vbF32[this.vbOffset-3]=d.velocity.y,this._vbF32[this.vbOffset-2]=d.velocity.z,zi.subtract(c4.velocity,c4.position,d.position),this._checkDirectionReverse(c4,d)}else if(l>2){var p=a.getElement(a.end-1),m=a.getElement(a.end-2);zi.subtract(_4,m.position,p.position),zi.subtract(d4,c4.position,p.position),zi.normalize(_4,_4),zi.normalize(d4,d4),zi.subtract(p.velocity,d4,_4),zi.normalize(p.velocity,p.velocity),this._checkDirectionReverse(p,m),this.vbOffset-=this._vertSize/4*2,this.ibOffset-=6,this._fillVertexBuffer(p,this.colorOverTrail.evaluate(u,1),s,u,l-1,5),zi.subtract(c4.velocity,c4.position,p.position),zi.normalize(c4.velocity,c4.velocity),this._checkDirectionReverse(c4,p)}this.widthFromParticle?c4.width=r.size.x*this.widthRatio.evaluate(0,1):c4.width=this.widthRatio.evaluate(0,1),c4.color=r.color,zi.equals(c4.velocity,zi.ZERO)?this.ibOffset-=3:this._fillVertexBuffer(c4,this.colorOverTrail.evaluate(0,1),s,0,l,1)}}this.updateIA(this.ibOffset)}},{key:"updateIA",value:function(e){if(this._trailModel&&this._trailModel.subModelNum>0){var t=this._trailModel.getSubModel(0);t.inputAssembler.vertexBuffers[0].update(this._vbF32),t.inputAssembler.indexBuffer.update(this._iBuffer),t.inputAssembler.indexCount=e,t.inputAssembler.extractDrawInfo(this._iaInfo.drawInfos[0]),this._iaInfoBuffer.update(this._iaInfo)}}},{key:"_createModel",value:function(){if(!this._trailModel){var e=vR.root.device,t=e.createBuffer({usage:ro.VERTEX|ro.TRANSFER_DST,memUsage:ao.HOST|ao.DEVICE,size:this._vertSize*(this._trailNum+1)*2,stride:this._vertSize}),i=new ArrayBuffer(this._vertSize*(this._trailNum+1)*2);this._vbF32=new Float32Array(i),this._vbUint32=new Uint32Array(i),t.update(i);var n=e.createBuffer({usage:ro.INDEX|ro.TRANSFER_DST,memUsage:ao.HOST|ao.DEVICE,size:6*this._trailNum*Uint16Array.BYTES_PER_ELEMENT,stride:Uint16Array.BYTES_PER_ELEMENT});this._iBuffer=new Uint16Array(6*this._trailNum),n.update(this._iBuffer),this._iaInfoBuffer=e.createBuffer({usage:ro.INDIRECT,memUsage:ao.HOST|ao.DEVICE,size:V_,stride:1}),this._iaInfo.drawInfos[0].vertexCount=2*(this._trailNum+1),this._iaInfo.drawInfos[0].indexCount=6*this._trailNum,this._iaInfoBuffer.update(this._iaInfo),this._subMeshData={vertexBuffers:[t],indexBuffer:n,indirectBuffer:this._iaInfoBuffer,attributes:this._vertAttrs,primitiveMode:lo.TRIANGLE_LIST,flatBuffers:[]},this._trailModel=cc.director.root.createModel(Zu),this._trailModel.initialize(this._particleSystem.node),this._trailModel.visFlags=this._particleSystem.visibility,this._trailModel.setSubModelMesh(0,this._subMeshData),this._trailModel.enabled=!0}}},{key:"_updateTrailElement",value:function(e,t,i,n){return t.lifetime+=n,e.colorFromParticle?(t.color.set(i.color),t.color.multiply(e.colorOvertime.evaluate(1-i.remainingLifetime/i.startLifetime,1))):t.color.set(e.colorOvertime.evaluate(1-i.remainingLifetime/i.startLifetime,1)),e.widthFromParticle?t.width=i.size.x*e.widthRatio.evaluate(t.lifetime/e._trailLifetime,1):t.width=e.widthRatio.evaluate(t.lifetime/e._trailLifetime,1),t.lifetime>e._trailLifetime}},{key:"_fillVertexBuffer",value:function(e,t,i,n,r,a){this._vbF32[this.vbOffset++]=e.position.x,this._vbF32[this.vbOffset++]=e.position.y,this._vbF32[this.vbOffset++]=e.position.z,this._vbF32[this.vbOffset++]=e.direction,this._vbF32[this.vbOffset++]=e.width,this._vbF32[this.vbOffset++]=n,this._vbF32[this.vbOffset++]=0,this._vbF32[this.vbOffset++]=e.velocity.x,this._vbF32[this.vbOffset++]=e.velocity.y,this._vbF32[this.vbOffset++]=e.velocity.z,p4.set(e.color),p4.multiply(t),this._vbUint32[this.vbOffset++]=p4._val,this._vbF32[this.vbOffset++]=e.position.x,this._vbF32[this.vbOffset++]=e.position.y,this._vbF32[this.vbOffset++]=e.position.z,this._vbF32[this.vbOffset++]=1-e.direction,this._vbF32[this.vbOffset++]=e.width,this._vbF32[this.vbOffset++]=n,this._vbF32[this.vbOffset++]=1,this._vbF32[this.vbOffset++]=e.velocity.x,this._vbF32[this.vbOffset++]=e.velocity.y,this._vbF32[this.vbOffset++]=e.velocity.z,this._vbUint32[this.vbOffset++]=p4._val,1&a&&(this._iBuffer[this.ibOffset++]=i+2*r,this._iBuffer[this.ibOffset++]=i+2*r-1,this._iBuffer[this.ibOffset++]=i+2*r+1),4&a&&(this._iBuffer[this.ibOffset++]=i+2*r,this._iBuffer[this.ibOffset++]=i+2*r+1,this._iBuffer[this.ibOffset++]=i+2*r+2)}},{key:"_checkDirectionReverse",value:function(e,t){zi.dot(e.velocity,t.velocity)<u4?e.direction=1-t.direction:e.direction=t.direction}}]),e}()).prototype,"enable",[a2],Object.getOwnPropertyDescriptor(y2.prototype,"enable"),y2.prototype),b2=v(y2.prototype,"_enable",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),E2=v(y2.prototype,"mode",[s2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return OJ.Particles}}),T2=v(y2.prototype,"lifeTime",[o2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vJ}}),S2=v(y2.prototype,"_minParticleDistance",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),v(y2.prototype,"minParticleDistance",[l2],Object.getOwnPropertyDescriptor(y2.prototype,"minParticleDistance"),y2.prototype),v(y2.prototype,"space",[u2],Object.getOwnPropertyDescriptor(y2.prototype,"space"),y2.prototype),x2=v(y2.prototype,"existWithParticles",[c2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),A2=v(y2.prototype,"textureMode",[h2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return IJ.Stretch}}),w2=v(y2.prototype,"widthFromParticle",[f2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),C2=v(y2.prototype,"widthRatio",[_2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vJ}}),R2=v(y2.prototype,"colorFromParticle",[d2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),k2=v(y2.prototype,"colorOverTrail",[p2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new EJ}}),O2=v(y2.prototype,"colorOvertime",[m2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new EJ}}),I2=v(y2.prototype,"_space",[v2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return AJ.World}}),M2=v(y2.prototype,"_particleSystem",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),g2=y2))||g2),g4=new Bn,y4=e("ParticleSystemComponent",(H2=Es("cc.ParticleSystemComponent"),W2=Cs("Components/ParticleSystem"),j2=Rs(99),X2=Ts({displayOrder:1,tooltip:""}),q2=Ts({type:EJ,displayOrder:8,tooltip:""}),Y2=Ts({type:AJ,displayOrder:9,tooltip:""}),K2=Ts({displayOrder:10,tooltip:""}),Z2=Ts({type:vJ,displayOrder:10,formerlySerializedAs:"startSize",tooltip:""}),Q2=Ts({type:vJ,displayOrder:10,tooltip:""}),J2=Ts({type:vJ,displayOrder:10,tooltip:""}),$2=Ts({type:vJ,range:[-1,1],displayOrder:11,tooltip:""}),e3=Ts({displayOrder:12,tooltip:""}),t3=Ts({type:vJ,range:[-1,1],radian:!0,displayOrder:12,tooltip:""}),i3=Ts({type:vJ,range:[-1,1],radian:!0,displayOrder:12,tooltip:""}),n3=Ts({type:vJ,range:[-1,1],radian:!0,displayOrder:12,formerlySerializedAs:"startRotation",tooltip:""}),r3=Ts({type:vJ,displayOrder:6,tooltip:""}),a3=Ts({type:vJ,displayOrder:7,tooltip:""}),s3=Ts({displayOrder:0,tooltip:""}),o3=Ts({displayOrder:2,tooltip:""}),l3=Ts({displayOrder:3,tooltip:""}),u3=Ts({type:AJ,displayOrder:4,tooltip:""}),c3=Ts({displayOrder:5,tooltip:""}),h3=Ts({displayOrder:2,tooltip:""}),f3=Ts({type:vJ,range:[-1,1],displayOrder:13,tooltip:""}),_3=Ts({type:vJ,displayOrder:14,tooltip:""}),d3=Ts({type:vJ,displayOrder:15,tooltip:""}),p3=Ts({type:[P1],displayOrder:16,tooltip:""}),m3=Ts({type:np,displayName:"Materials",visible:!1,override:!0}),v3=Ts({type:xJ,displayOrder:23,tooltip:""}),g3=Ts({type:N1,displayOrder:17,tooltip:""}),y3=Ts({type:R1,displayOrder:21,tooltip:""}),b3=Ts({type:L1,displayOrder:18,tooltip:""}),E3=Ts({type:y$,displayOrder:19,tooltip:""}),T3=Ts({type:T$,displayOrder:20,tooltip:""}),S3=Ts({type:C1,displayOrder:22,tooltip:""}),x3=Ts({type:I1,displayOrder:24,tooltip:""}),A3=Ts({type:v4,displayOrder:25,tooltip:""}),w3=Ts({type:V2,displayOrder:26,tooltip:""}),H2(C3=W2(C3=j2(C3=As((v((R3=function(e){function t(){var e;return i(this,t),m(e=c(this,o(t).call(this)),"startColor",k3,u(e)),m(e,"scaleSpace",O3,u(e)),m(e,"startSize3D",I3,u(e)),m(e,"startSizeX",M3,u(e)),m(e,"startSizeY",L3,u(e)),m(e,"startSizeZ",P3,u(e)),m(e,"startSpeed",B3,u(e)),m(e,"startRotation3D",D3,u(e)),m(e,"startRotationX",F3,u(e)),m(e,"startRotationY",N3,u(e)),m(e,"startRotationZ",z3,u(e)),m(e,"startDelay",U3,u(e)),m(e,"startLifetime",G3,u(e)),m(e,"duration",V3,u(e)),m(e,"loop",H3,u(e)),m(e,"simulationSpeed",W3,u(e)),m(e,"playOnAwake",j3,u(e)),m(e,"gravityModifier",X3,u(e)),m(e,"rateOverTime",q3,u(e)),m(e,"rateOverDistance",Y3,u(e)),m(e,"bursts",K3,u(e)),m(e,"colorOverLifetimeModule",Z3,u(e)),m(e,"shapeModule",Q3,u(e)),m(e,"sizeOvertimeModule",J3,u(e)),m(e,"velocityOvertimeModule",$3,u(e)),m(e,"forceOvertimeModule",e4,u(e)),m(e,"limitVelocityOvertimeModule",t4,u(e)),m(e,"rotationOvertimeModule",i4,u(e)),m(e,"textureAnimationModule",n4,u(e)),m(e,"trailModule",r4,u(e)),m(e,"renderer",a4,u(e)),m(e,"_prewarm",s4,u(e)),m(e,"_capacity",o4,u(e)),m(e,"_simulationSpace",l4,u(e)),e.rateOverTime.constant=10,e.startLifetime.constant=5,e.startSizeX.constant=1,e.startSpeed.constant=5,e._isPlaying=!1,e._isPaused=!1,e._isStopped=!0,e._isEmitting=!1,e._time=0,e._emitRateTimeCounter=0,e._emitRateDistanceCounter=0,e._oldWPos=new zi,e._curWPos=new zi,e._customData1=new Mi,e._customData2=new Mi,e._subEmitters=[],e}return s(t,e),r(t,[{key:"capacity",get:function(){return this._capacity},set:function(e){this._capacity=e,this.renderer&&this.renderer._model&&this.renderer._model.setCapacity(this._capacity)}},{key:"prewarm",get:function(){return this._prewarm},set:function(e){!0===e&&this.loop,this._prewarm=e}},{key:"simulationSpace",get:function(){return this._simulationSpace},set:function(e){e!==this._simulationSpace&&(this._simulationSpace=e,this.renderer._updateMaterialParams(),this.renderer._updateTrailMaterial())}},{key:"sharedMaterials",get:function(){return f(o(t.prototype),"sharedMaterials",this)},set:function(e){d(o(t.prototype),"sharedMaterials",e,this,!0)}}]),r(t,[{key:"onLoad",value:function(){this.renderer.onInit(this),this.shapeModule.onInit(this),this.trailModule.onInit(this),this.textureAnimationModule.onInit(this),this._resetPosition()}},{key:"_onMaterialModified",value:function(e,t){this.renderer._onMaterialModified(e,t)}},{key:"_onRebuildPSO",value:function(e,t){this.renderer._onRebuildPSO(e,t)}},{key:"_collectModels",value:function(){return this._models.length=0,this._models.push(this.renderer._model),this.trailModule.enable&&this.trailModule._trailModel&&this._models.push(this.trailModule._trailModel),this._models}},{key:"_attachToScene",value:function(){this.renderer._attachToScene(),this.trailModule.enable&&this.trailModule._attachToScene()}},{key:"_detachFromScene",value:function(){this.renderer._detachFromScene(),this.trailModule.enable&&this.trailModule._detachFromScene()}},{key:"play",value:function(){this._isPaused&&(this._isPaused=!1),this._isStopped&&(this._isStopped=!1),this._isPlaying=!0,this._isEmitting=!0,this._resetPosition(),this._prewarm&&this._prewarmSystem()}},{key:"pause",value:function(){this._isStopped?console.warn("pause(): particle system is already stopped."):(this._isPlaying&&(this._isPlaying=!1),this._isPaused=!0)}},{key:"stop",value:function(){(this._isPlaying||this._isPaused)&&this.clear(),this._isPlaying&&(this._isPlaying=!1),this._isPaused&&(this._isPaused=!1),this._time=0,this._emitRateTimeCounter=0,this._emitRateDistanceCounter=0,this._isStopped=!0}},{key:"clear",value:function(){this.enabledInHierarchy&&(this.renderer.clear(),this.trailModule.clear())}},{key:"getParticleCount",value:function(){return this.renderer.getParticleCount()}},{key:"setCustomData1",value:function(e,t){Mi.set(this._customData1,e,t)}},{key:"setCustomData2",value:function(e,t){Mi.set(this._customData2,e,t)}},{key:"onDestroy",value:function(){this.renderer.onDestroy(),this.trailModule.destroy()}},{key:"onEnable",value:function(){this.playOnAwake&&this.play(),this.renderer.onEnable(),this.trailModule.onEnable()}},{key:"onDisable",value:function(){this.renderer.onDisable(),this.trailModule.onDisable()}},{key:"update",value:function(e){var t=e*this.simulationSpeed;this._isPlaying&&(this._time+=t,this._emit(t),0!==this.renderer._updateParticles(t)||this._isEmitting||this.stop(),this.renderer._updateRenderData(),this.trailModule.enable&&this.trailModule.updateRenderData())}},{key:"_onVisiblityChange",value:function(e){this.renderer._model&&(this.renderer._model.visFlags=e)}},{key:"emit",value:function(e,t){for(var i=0;i<e;++i){var n=this.renderer._getFreeParticle();if(null===n)return;var r=Ei(bi(0,2147483647));switch(this.shapeModule.enable?this.shapeModule.emit(n):(zi.set(n.position,0,0,0),zi.copy(n.velocity,MJ)),this.textureAnimationModule.enable&&this.textureAnimationModule.init(n),zi.multiplyScalar(n.velocity,n.velocity,this.startSpeed.evaluate(this._time/this.duration,r)),this._simulationSpace){case AJ.Local:break;case AJ.World:this.node.getWorldMatrix(g4),zi.transformMat4(n.position,n.position,g4);var a=new fn;this.node.getWorldRotation(a),zi.transformQuat(n.velocity,n.velocity,a);break;case AJ.Custom:}zi.copy(n.ultimateVelocity,n.velocity),this.startRotation3D?zi.set(n.rotation,this.startRotationX.evaluate(this._time/this.duration,r),this.startRotationY.evaluate(this._time/this.duration,r),this.startRotationZ.evaluate(this._time/this.duration,r)):zi.set(n.rotation,0,0,this.startRotationZ.evaluate(this._time/this.duration,r)),this.startSize3D?zi.set(n.startSize,this.startSizeX.evaluate(this._time/this.duration,r),this.startSizeY.evaluate(this._time/this.duration,r),this.startSizeZ.evaluate(this._time/this.duration,r)):(zi.set(n.startSize,this.startSizeX.evaluate(this._time/this.duration,r),1,1),n.startSize.y=n.startSize.x),zi.copy(n.size,n.startSize),n.startColor.set(this.startColor.evaluate(this._time/this.duration,r)),n.color.set(n.startColor),n.startLifetime=this.startLifetime.evaluate(this._time/this.duration,r)+t,n.remainingLifetime=n.startLifetime,n.randomSeed=bi(0,233280),this.renderer._setNewParticle(n)}}},{key:"_prewarmSystem",value:function(){this.startDelay.mode=mJ.Constant,this.startDelay.constant=0;for(var e=this.duration/1,t=0;t<e;++t)this._time+=1,this._emit(1),this.renderer._updateParticles(1)}},{key:"_emit",value:function(e){var t=this.startDelay.evaluate(0,1);if(this._time>t){if(this._time>this.duration+t&&!this.loop)return void(this._isEmitting=!1);if(this._emitRateTimeCounter+=this.rateOverTime.evaluate(this._time/this.duration,1)*e,this._emitRateTimeCounter>1&&this._isEmitting){var i=Math.floor(this._emitRateTimeCounter);this._emitRateTimeCounter-=i,this.emit(i,e)}this.node.getWorldPosition(this._curWPos);var n=zi.distance(this._curWPos,this._oldWPos);if(zi.copy(this._oldWPos,this._curWPos),this._emitRateDistanceCounter+=n*this.rateOverDistance.evaluate(this._time/this.duration,1),this._emitRateDistanceCounter>1&&this._isEmitting){var r=Math.floor(this._emitRateDistanceCounter);this._emitRateDistanceCounter-=r,this.emit(r,e)}var a=this.bursts,s=Array.isArray(a),o=0;for(a=s?a:a[Symbol.iterator]();;){var l;if(s){if(o>=a.length)break;l=a[o++]}else{if((o=a.next()).done)break;l=o.value}l.update(this,e)}}}},{key:"_resetPosition",value:function(){this.node.getWorldPosition(this._oldWPos),zi.copy(this._curWPos,this._oldWPos)}},{key:"addSubEmitter",value:function(e){this._subEmitters.push(e)}},{key:"removeSubEmitter",value:function(e){this._subEmitters.splice(this._subEmitters.indexOf(e),1)}},{key:"addBurst",value:function(e){this.bursts.push(e)}},{key:"removeBurst",value:function(e){this.bursts.splice(this.bursts.indexOf(e),1)}},{key:"isPlaying",get:function(){return this._isPlaying}},{key:"isPaused",get:function(){return this._isPaused}},{key:"isStopped",get:function(){return this._isStopped}},{key:"isEmitting",get:function(){return this._isEmitting}},{key:"time",get:function(){return this._time}}]),t}(wp)).prototype,"capacity",[X2],Object.getOwnPropertyDescriptor(R3.prototype,"capacity"),R3.prototype),k3=v(R3.prototype,"startColor",[q2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new EJ}}),O3=v(R3.prototype,"scaleSpace",[Y2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return AJ.Local}}),I3=v(R3.prototype,"startSize3D",[K2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),M3=v(R3.prototype,"startSizeX",[Z2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vJ}}),L3=v(R3.prototype,"startSizeY",[Q2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vJ}}),P3=v(R3.prototype,"startSizeZ",[J2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vJ}}),B3=v(R3.prototype,"startSpeed",[$2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vJ}}),D3=v(R3.prototype,"startRotation3D",[e3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),F3=v(R3.prototype,"startRotationX",[t3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vJ}}),N3=v(R3.prototype,"startRotationY",[i3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vJ}}),z3=v(R3.prototype,"startRotationZ",[n3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vJ}}),U3=v(R3.prototype,"startDelay",[r3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vJ}}),G3=v(R3.prototype,"startLifetime",[a3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vJ}}),V3=v(R3.prototype,"duration",[s3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),H3=v(R3.prototype,"loop",[o3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),v(R3.prototype,"prewarm",[l3],Object.getOwnPropertyDescriptor(R3.prototype,"prewarm"),R3.prototype),v(R3.prototype,"simulationSpace",[u3],Object.getOwnPropertyDescriptor(R3.prototype,"simulationSpace"),R3.prototype),W3=v(R3.prototype,"simulationSpeed",[c3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),j3=v(R3.prototype,"playOnAwake",[h3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),X3=v(R3.prototype,"gravityModifier",[f3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vJ}}),q3=v(R3.prototype,"rateOverTime",[_3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vJ}}),Y3=v(R3.prototype,"rateOverDistance",[d3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vJ}}),K3=v(R3.prototype,"bursts",[p3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Array}}),v(R3.prototype,"sharedMaterials",[m3],Object.getOwnPropertyDescriptor(R3.prototype,"sharedMaterials"),R3.prototype),Z3=v(R3.prototype,"colorOverLifetimeModule",[v3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new xJ}}),Q3=v(R3.prototype,"shapeModule",[g3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new N1}}),J3=v(R3.prototype,"sizeOvertimeModule",[y3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new R1}}),$3=v(R3.prototype,"velocityOvertimeModule",[b3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new L1}}),e4=v(R3.prototype,"forceOvertimeModule",[E3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new y$}}),t4=v(R3.prototype,"limitVelocityOvertimeModule",[T3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new T$}}),i4=v(R3.prototype,"rotationOvertimeModule",[S3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new C1}}),n4=v(R3.prototype,"textureAnimationModule",[x3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new I1}}),r4=v(R3.prototype,"trailModule",[A3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new v4}}),a4=v(R3.prototype,"renderer",[w3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new V2}}),s4=v(R3.prototype,"_prewarm",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),o4=v(R3.prototype,"_capacity",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),l4=v(R3.prototype,"_simulationSpace",[Ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return AJ.Local}}),C3=R3))||C3)||C3)||C3)||C3)),b4=e("ParticleUtils",function(){function e(){i(this,e)}return r(e,null,[{key:"instantiate",value:function(e){return this.registeredSceneEvent||(vR.on(sR.EVENT_BEFORE_SCENE_LAUNCH,this.onSceneUnload,this),this.registeredSceneEvent=!0),this.particleSystemPool.has(e._uuid)||this.particleSystemPool.set(e._uuid,new Za((function(){return pm(e)}),1)),this.particleSystemPool.get(e._uuid).alloc()}},{key:"destroy",value:function(e){this.particleSystemPool.has(e._prefab.asset._uuid)&&(this.stop(e),this.particleSystemPool.get(e._prefab.asset._uuid).free(e))}},{key:"play",value:function(e){var t=e.getComponentsInChildren(y4),i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.play()}}},{key:"stop",value:function(e){var t=e.getComponentsInChildren(y4),i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.stop()}}},{key:"onSceneUnload",value:function(){this.particleSystemPool.forEach((function(e){e.clear((function(e){e.destroy()}))})),this.particleSystemPool.clear()}}]),e}());b4.particleSystemPool=new Map,b4.registeredSceneEvent=!1,cc.ParticleSystemComponent=y4,cc.BillboardComponent=hJ,cc.LineComponent=SJ,cc.ParticleUtils=b4}}}));
